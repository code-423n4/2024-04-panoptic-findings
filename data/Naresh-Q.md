## Low Risk Issues


| |Issue|Instances|
|-|:-|:-:|
| [L-01](#L-01) | Burning is missing access control | 2 |
| [L-02](#L-02) | Some `ERC20` can revert on a zero value `transfer`(Not captured by 4nalyzer) | 5 |
| [L-03](#L-03) | Approve `type(uint256).max` may not work with some tokens | 4 |
| [L-04](#L-04) | Consider bounding input array length | 8 |
| [L-05](#L-05) | Privileged functions can create points of failure | 7 |
| [L-06](#L-06) | Code does not follow the best practice of check-effects-interaction | 2 |
| [L-07](#L-07) | Possible reentrancy with callback on transfer tokens | 2 |
| [L-08](#L-08) | Events may be emitted out of order due to reentrancy | 10 |
| [L-09](#L-09) | `forceApprove` should be used instead of `approve` | 4 |
| [L-10](#L-10) | Functions calling contracts/addresses with transfer hooks are missing reentrancy guards | 14 |
| [L-11](#L-11) | Input array lengths may differ | 10 |
| [L-12](#L-12) | Missing zero address check in constructor | 3 |
| [L-13](#L-13) | Missing contract-existence checks before low-level calls | 1 |
| [L-14](#L-14) | Named return variable used before assignment | 1 |
| [L-15](#L-15) | Sending tokens in a loop | 1 |
| [L-16](#L-16) | File allows a version of solidity that is susceptible to `.selector` related optimizer bug | 3 |
| [L-17](#L-17) | State variables not capped at reasonable values | 7 |
| [L-18](#L-18) | Consider implementing two-step procedure for updating protocol addresses | 1 |
| [L-19](#L-19) | Using zero as a parameter | 6 |


## Non Critical Issues


| |Issue|Instances|
|-|:-|:-:|
| [NC-01](#NC-01) | Consider adding validation of user inputs | 65 |
| [NC-02](#NC-02) | `address` shouldn't be hard-coded | 20 |
| [NC-03](#NC-03) | Assembly blocks should have extensive comments | 21 |
| [NC-04](#NC-04) | Avoid double casting | 67 |
| [NC-05](#NC-05) | Contracts should have all `public`/`external` functions exposed by `interface`s | 16 |
| [NC-06](#NC-06) | Contracts should have full test coverage | 20 |
| [NC-07](#NC-07) | Control structures do not follow the Solidity Style Guide | 149 |
| [NC-08](#NC-08) | Use `string.concat()` or `bytes.concat()` instead of `abi.encodePacked` | 12 |
| [NC-09](#NC-09) | Consider making contracts Upgradeable | 7 |
| [NC-10](#NC-10) | Constants in comparisons should appear on the left side | 155 |
| [NC-11](#NC-11) | Variable names that consist of all capital letters should be reserved for `constant` variables | 9 |
| [NC-12](#NC-12) | Default Visibility for `constant`/`immutable` variables | 8 |
| [NC-13](#NC-13) | Consider using delete rather than assigning zero/false to clear values | 3 |
| [NC-14](#NC-14) | Division by zero not prevented | 18 |
| [NC-15](#NC-15) | Use scientific notation (e.g. `1e18`) rather than exponentiation (e.g. `10**18`) | 61 |
| [NC-16](#NC-16) | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function | 3 |
| [NC-17](#NC-17) | Consider moving duplicated strings to constants | 4 |
| [NC-18](#NC-18) | else block is not required | 31 |
| [NC-19](#NC-19) | Consider adding emergency-stop functionality | 20 |
| [NC-20](#NC-20) | Consider emitting an event at the end of the constructor | 4 |
| [NC-21](#NC-21) | Unused `error` definition | 33 |
| [NC-22](#NC-22) | Events are missing sender information | 9 |
| [NC-23](#NC-23) | Events that mark critical parameter changes should contain both the old and the new value | 2 |
| [NC-24](#NC-24) | Floating pragma should be avoided | 20 |
| [NC-25](#NC-25) | For loops in public or external functions should be avoided due to high gas costs and possible DOS | 17 |
| [NC-26](#NC-26) | Consider adding formal verification proofs | 20 |
| [NC-27](#NC-27) | No equate comparison checks between to and from address parameters | 9 |
| [NC-28](#NC-28) | Functions with array parameters should have length checks in place | 27 |
| [NC-29](#NC-29) | function names should be lowerCamelCase | 97 |
| [NC-30](#NC-30) | Functions within contracts are not ordered according to the solidity style guide | 9 |
| [NC-31](#NC-31) | Add inline comments for unnamed parameters | 2 |
| [NC-32](#NC-32) | Functions should not be longer than 50 lines | 118 |
| [NC-33](#NC-33) | Governance operations should be behind a timelock | 7 |
| [NC-34](#NC-34) | High cyclomatic complexity | 2 |
| [NC-35](#NC-35) | Use a ternary statement instead of `if`/`else` when appropriate | 234 |
| [NC-36](#NC-36) | Expressions for `constant` values should use `immutable` rather than `constant` | 18 |
| [NC-37](#NC-37) | Inconsistent comment spacing | 20 |
| [NC-38](#NC-38) | Interface imports should be declared first | 15 |
| [NC-39](#NC-39) | Lack Of Brace Spacing | 88 |
| [NC-40](#NC-40) | Consider using the `using`-`for` syntax | 190 |
| [NC-41](#NC-41) | It is best practice to use linear inheritance | 4 |
| [NC-42](#NC-42) | Lines are too long | 1 |
| [NC-43](#NC-43) | Ensure `block.timestamp` is only used in long time intervals | 3 |
| [NC-44](#NC-44) | Use transfer libraries instead of low level calls | 1 |
| [NC-45](#NC-45) | `constant`s should be defined rather than using magic numbers | 280 |
| [NC-46](#NC-46) | `type(uint<n>).max` should be used instead of `uint<n>(-1)` | 34 |
| [NC-47](#NC-47) | Consider checking that transfer to `address(this)` is disabled | 10 |
| [NC-48](#NC-48) | Missing checks for `uint`/`int` state variable assignments | 28 |
| [NC-49](#NC-49) | Empty `bytes` check is missing | 12 |
| [NC-50](#NC-50) | Custom errors has no error details | 34 |
| [NC-51](#NC-51) | Missing events in initializers | 1 |
| [NC-52](#NC-52) | Missing checks for `uint`/`int` state variable constructor assignments | 28 |
| [NC-53](#NC-53) | Consider moving `msg.sender` checks to `modifier`s | 7 |
| [NC-54](#NC-54) | Use a struct to encapsulate multiple function parameters | 64 |
| [NC-55](#NC-55) | Consider using named mappings | 6 |
| [NC-56](#NC-56) | Missing `@inheritdoc` on override functions | 4 |
| [NC-57](#NC-57) | Natspec `@notice` is missing from abstract contract | 2 |
| [NC-58](#NC-58) | NatSpec: Contract declarations should have `@dev` tags | 2 |
| [NC-59](#NC-59) | NatSpec: Interface declarations should have `@author` tags | 1 |
| [NC-60](#NC-60) | NatSpec: Interface declarations should have `@dev` tags | 1 |
| [NC-61](#NC-61) | NatSpec: Interface declarations should have `@notice` tags | 2 |
| [NC-62](#NC-62) | NatSpec: Interface declarations should have `@title` tags | 1 |
| [NC-63](#NC-63) | NatSpec: Library declarations should have `@dev` tags | 8 |
| [NC-64](#NC-64) | NatSpec: Library declarations should have `@notice` tags | 1 |
| [NC-65](#NC-65) | NatSpec: Library declarations should have `@title` tags | 1 |
| [NC-66](#NC-66) | NatSpec: Constructor missing NatSpec `@dev` tag | 4 |
| [NC-67](#NC-67) | NatSpec: Constructor missing NatSpec `@notice` tag | 1 |
| [NC-68](#NC-68) | NatSpec: Constructor missing NatSpec `@param` tag | 1 |
| [NC-69](#NC-69) | NatSpec: Error missing NatSpec `@dev` tag | 33 |
| [NC-70](#NC-70) | NatSpec: Event missing NatSpec `@dev` tag | 11 |
| [NC-71](#NC-71) | NatSpec: Functions missing NatSpec `@dev` tag | 140 |
| [NC-72](#NC-72) | NatSpec: Functions missing NatSpec `@notice` tag | 2 |
| [NC-73](#NC-73) | NatSpec: Functions missing NatSpec `@param` tag | 5 |
| [NC-74](#NC-74) | NatSpec: Functions missing NatSpec `@return` tag | 8 |
| [NC-75](#NC-75) | Incomplete NatSpec: `@param` from function declarations | 1 |
| [NC-76](#NC-76) | NatSpec: Modifier missing NatSpec `@dev` tag | 1 |
| [NC-77](#NC-77) | Immutable and constant state variables should not be casted | 2 |
| [NC-78](#NC-78) | Use recent version of solidity | 20 |
| [NC-79](#NC-79) | Use of `override` is unnecessary | 4 |
| [NC-80](#NC-80) | Possible rounding issue | 6 |
| [NC-81](#NC-81) | Functions which are either `private` or `internal` should have a preceding _ in their name | 104 |
| [NC-82](#NC-82) | Consider making `private` state variables `internal` to increase flexibility | 1 |
| [NC-83](#NC-83) | Public variable declarations should have NatSpec descriptions | 5 |
| [NC-84](#NC-84) | Adding a `return` statement when the function defines a named return variable, is redundant | 37 |
| [NC-85](#NC-85) | Say Goodbye to Unchecked Loop Increments: Solidity `0.8.22` Enhances For Loop Safety | 21 |
| [NC-86](#NC-86) | `require()`/`revert()` statements should have descriptive reason strings | 9 |
| [NC-87](#NC-87) | Default `address(0)` can be returned | 2 |
| [NC-88](#NC-88) | Revert statements within external and public functions can be used to perform DOS attacks | 26 |
| [NC-89](#NC-89) | Take advantage of Custom Error's return value property | 60 |
| [NC-90](#NC-90) | Setters should prevent re-setting the same value | 4 |
| [NC-91](#NC-91) | Use a single file for system wide constants | 49 |
| [NC-92](#NC-92) | Prefer skip over revert model in iteration | 12 |
| [NC-93](#NC-93) | Consider using SMTChecker | 20 |
| [NC-94](#NC-94) | Strings should use double quotes rather than single quotes | 2 |
| [NC-95](#NC-95) | Contract does not follow the Solidity style guide's suggested layout ordering | 8 |
| [NC-96](#NC-96) | Set time variables to `uint32` | 7 |
| [NC-97](#NC-97) | Addition/multiplication in `unchecked` block is unsafe | 213 |
| [NC-98](#NC-98) | `unchecked` blocks with subtractions may underflow | 119 |
| [NC-99](#NC-99) | Use Underscores for Number Literals (add an underscore every 3 digits) | 10 |
| [NC-100](#NC-100) | Contracts with only unimplemented functions can be labeled as abstract | 13 |
| [NC-101](#NC-101) | Event is missing `indexed` fields | 12 |
| [NC-102](#NC-102) | Unused function parameter | 14 |
| [NC-103](#NC-103) | Use the Modern Upgradeable Contract Paradigm | 20 |
| [NC-104](#NC-104) | Upgrade openzeppelin to the Latest Version - 5.0.0 | 5 |
| [NC-105](#NC-105) | `internal` functions not called by the contract should be removed | 82 |
| [NC-106](#NC-106) | Consider using named returns | 113 |
| [NC-107](#NC-107) | Consider using a format prettier or forge fmt | 20 |
| [NC-108](#NC-108) | Variable initialization with default value | 5 |
| [NC-109](#NC-109) | Avoid declaring variables/parameters with the names of defined functions within the project | 20 |
| [NC-110](#NC-110) | Variable/Parameters names don't follow the Solidity naming convention | 633 |
| [NC-111](#NC-111) | Visibility should be set explicitly rather than defaulting to `internal` | 8 |
| [NC-112](#NC-112) | Incorrect withdraw declaration | 3 |
| [NC-113](#NC-113) | Invalid NatSpec comment style | 6 |



## Low Risk Issues

### <a name="L-01"></a>[L-01] Burning is missing access control
The function allows any user to arbitrarily burn tokens from a passed in address. If someone approves the contract (e.g. for `type(uint256).max`), any other user can trigger a burn

*There are 2 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

569:     function burnOptions(
             TokenId tokenId,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

586:     function burnOptions(
             TokenId[] calldata positionIdList,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

```
([569](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L569-L574),[586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L586-L591))

### <a name="L-02"></a>[L-02] Some `ERC20` can revert on a zero value `transfer`(Not captured by 4nalyzer)
In spite of the fact that [EIP-20](https://github.com/ethereum/EIPs/blob/46b9b698815abbfa628cd1097311deee77dd45c5/EIPS/eip-20.md?plain=1#L116) states that zero-valued transfers must be accepted, some tokens, such as `LEND` will revert if this is attempted, which may cause transactions that involve other tokens (such as batch operations) to fully revert. Consider skipping the transfer if the amount is zero, which will also save gas.

*There are 5 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

424:         SafeTransferLib.safeTransferFrom(
                 s_underlyingToken,
                 msg.sender,
                 address(s_panopticPool),
                 assets
             );

484:         SafeTransferLib.safeTransferFrom(
                 s_underlyingToken,
                 msg.sender,
                 address(s_panopticPool),
                 assets
             );

556:         SafeTransferLib.safeTransferFrom(
                 s_underlyingToken,
                 address(s_panopticPool),
                 receiver,
                 assets
             );

616:         SafeTransferLib.safeTransferFrom(
                 s_underlyingToken,
                 address(s_panopticPool),
                 receiver,
                 assets
             );

```
([424](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L424-L429),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L484-L489),[556](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L556-L561),[616](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L616-L621))
```solidity
File: contracts/SemiFungiblePositionManager.sol

456:         SafeTransferLib.safeTransferFrom(token, decoded.payer, msg.sender, amountToPay);

```
([456](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L456-L456))



### <a name="L-03"></a>[L-03] Approve `type(uint256).max` may not work with some tokens
The `approve` function in ERC-20 tokens allows a user to permit another user or contract to spend tokens on their behalf. Setting the approval to `type(uint256).max` is often used as a way to grant an indefinite approval, as this value is the maximum possible value of a `uint256` variable in Solidity

However, some tokens may not function as expected when `type(uint256).max` is used. These tokens may have an atypical implementation of the `transferFrom` function, which is used in combination with `approve`. This function might behave differently when confronted with such a high allowance, possibly due to custom logic in the contract that wasn't designed to handle these edge cases.

Moreover, tokens that have a built-in burning or fees mechanism could behave unpredictably when the maximum allowance is set. This can lead to potential vulnerabilities or misinterpretations of contract behavior.

Resolution: It's advisable to be conservative with the `approve` function and only approve the specific amount of tokens that need to be spent for the specific operation you're performing. If you need to provide an extensive allowance, ensure you've thoroughly analyzed the token contract to understand how it behaves with high allowances. Alternatively, consider implementing a mechanism in your contract to handle token allowances in a more dynamic way, adjusting them as needed for each operation, rather than relying on a single indefinite approval.

*There are 4 Instances of this issue* :
```solidity
File: contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);

```
([32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L32-L32),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L33-L33),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L36-L36),[37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L37-L37))

### <a name="L-04"></a>[L-04] Consider bounding input array length
Unbounded array inputs in functions can lead to unintentional excessive gas consumption, potentially causing a transaction to revert after expending substantial gas. To enhance user experience and prevent such scenarios, consider implementing a `require()` statement that limits the array length to a defined maximum. This constraint ensures that transactions won't proceed if they're likely to hit gas limits due to array size, saving users from unnecessary gas costs and offering a more predictable interaction with the contract.

*There are 8 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

//@audit positionIdList.length not bounded 
802:         for (uint256 i = 0; i < positionIdList.length; ) {

```
([802](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L802-L802))
```solidity
File: contracts/SemiFungiblePositionManager.sol

//@audit ids.length not bounded 
575:         for (uint256 i = 0; i < ids.length; ) {

```
([575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L575-L575))
```solidity
File: contracts/libraries/FeesCalc.sol

//@audit positionIdList.length not bounded 
51:         for (uint256 k = 0; k < positionIdList.length; ) {

```
([51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L51-L51))
```solidity
File: contracts/libraries/PanopticMath.sol

//@audit positionIdList.length not bounded 
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {

//@audit positionIdList.length not bounded 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {

```
([781](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L781-L781),[860](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L860-L860))
```solidity
File: contracts/multicall/Multicall.sol

//@audit data.length not bounded 
14:         for (uint256 i = 0; i < data.length; ) {

```
([14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L14-L14))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

//@audit ids.length not bounded 
143:         for (uint256 i = 0; i < ids.length; ) {

//@audit owners.length not bounded 
187:             for (uint256 i = 0; i < owners.length; ++i) {

```
([143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L143-L143),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L187-L187))

### <a name="L-05"></a>[L-05] Privileged functions can create points of failure
Ensure such accounts are protected and consider implementing multi sig to prevent a single point of failure

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

864:     function delegate(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

911:     function revoke(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

995:     function takeCommissionAddData(
             address optionOwner,
             int128 longAmount,
             int128 shortAmount,
             int128 swappedAmount
         ) external onlyPanopticPool returns (int256 utilization) {

1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

```
([864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L864-L868),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[911](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L911-L915),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[995](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L995-L1000),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049))

### <a name="L-06"></a>[L-06] Code does not follow the best practice of check-effects-interaction
Code should follow the best-practice of [CEI](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/), where state variables are updated before any external calls are made. Doing so prevents a large class of reentrancy bugs

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit SafeTransferLib.safeTransferFrom() called on line 424 
436:             s_poolAssets += uint128(assets);

// @audit SafeTransferLib.safeTransferFrom() called on line 484 
496:             s_poolAssets += uint128(assets);


```
([436](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L436-L436),[496](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L496-L496))

### <a name="L-07"></a>[L-07] Possible reentrancy with callback on transfer tokens
The following functions don't apply the [CEI](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/) pattern. It's possible to reenter after the transfer if the token has some kind of callback functionality (e.g. ERC777/ERC1155).

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit state update on line 436
424:         SafeTransferLib.safeTransferFrom(

// @audit state update on line 496
484:         SafeTransferLib.safeTransferFrom(

```
([424](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L424-L424),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L484-L484))

### <a name="L-08"></a>[L-08] Events may be emitted out of order due to reentrancy
If a reentrancy occurs, some events may be emitted in an unexpected order, and this may be a problem if a third party expects a specific order for these events. Ensure that events are emitted before external calls and follow the best practice of CEI.

*There are 10 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

439:         emit Deposit(msg.sender, receiver, assets, shares);

499:         emit Deposit(msg.sender, receiver, assets, shares);

563:         emit Withdraw(msg.sender, receiver, owner, assets, shares);

623:         emit Withdraw(msg.sender, receiver, owner, assets, shares);

```
([439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L439-L439),[499](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L499-L499),[563](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L563-L563),[623](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L623-L623))
```solidity
File: contracts/PanopticFactory.sol

268:         emit PoolDeployed(
                 newPoolContract,
                 v3Pool,
                 collateralTracker0,
                 collateralTracker1,
                 amount0,
                 amount1
             );


```
([268](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L268-L275))
```solidity
File: contracts/PanopticPool.sol

853:         emit OptionBurnt(owner, positionSize, tokenId, premiaOwed);

1170:         emit AccountLiquidated(msg.sender, liquidatee, bonusAmounts);

1277:         emit ForcedExercised(msg.sender, account, touchedId[0], exerciseFees);

1654:             emit PremiumSettled(owner, tokenId, realizedPremia);



```
([853](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L853-L853),[1170](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1170-L1170),[1277](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1277-L1277),[1654](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1654-L1654))
```solidity
File: contracts/SemiFungiblePositionManager.sol

390:         emit PoolInitialized(univ3pool, poolId);


```
([390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L390-L390))


### <a name="L-09"></a>[L-09] `forceApprove` should be used instead of `approve`
In order to prevent front running, `forceApprove` should be used in place of `approve` where possible

*There are 4 Instances of this issue* :
```solidity
File: contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);

```
([32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L32-L32),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L33-L33),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L36-L36),[37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L37-L37))

### <a name="L-10"></a>[L-10] Functions calling contracts/addresses with transfer hooks are missing reentrancy guards
Even if the function follows the best practice of check-effects-interaction, not using a reentrancy guard when there may be transfer hooks will open the users of this protocol up to [read-only reentrancies](https://chainsecurity.com/curve-lp-oracle-manipulation-post-mortem/) with no way to protect against it, except by block-listing the whole protocol.

*There are 14 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit function 'transfer()' is missing Reentrancy guard
333:         return ERC20Minimal.transfer(recipient, amount);

// @audit function 'transferFrom()' is missing Reentrancy guard
352:         return ERC20Minimal.transferFrom(from, to, amount);

// @audit function 'deposit()' is missing Reentrancy guard
424:         SafeTransferLib.safeTransferFrom(

// @audit function 'mint()' is missing Reentrancy guard
484:         SafeTransferLib.safeTransferFrom(



// @audit function 'redeem()' is missing Reentrancy guard
616:         SafeTransferLib.safeTransferFrom(

// @audit function 'delegate()' is missing Reentrancy guard
886:         _transferFrom(delegator, delegatee, shares);

// @audit function 'revoke()' is missing Reentrancy guard
939:             _transferFrom(delegatee, delegator, delegateeBalance);

// @audit function 'refund()' is missing Reentrancy guard
977:             _transferFrom(refunder, refundee, convertToShares(uint256(assets)));

```
([333](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L333-L333),[352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L352-L352),[424](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L424-L424),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L484-L484),[616](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L616-L616),[886](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L886-L886),[939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L939-L939),[977](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L977-L977))
```solidity
File: contracts/PanopticFactory.sol

// @audit function 'uniswapV3MintCallback()' is missing Reentrancy guard
182:             SafeTransferLib.safeTransferFrom(

```
([182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L182-L182))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit function 'uniswapV3MintCallback()' is missing Reentrancy guard
413:             SafeTransferLib.safeTransferFrom(

// @audit function 'uniswapV3SwapCallback()' is missing Reentrancy guard
456:         SafeTransferLib.safeTransferFrom(token, decoded.payer, msg.sender, amountToPay);

// @audit function 'safeTransferFrom()' is missing Reentrancy guard
552:         registerTokenTransfer(from, to, TokenId.wrap(id), amount);

// @audit function 'safeBatchTransferFrom()' is missing Reentrancy guard
577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

// @audit function 'registerTokenTransfer()' is missing Reentrancy guard
634:             ) revert Errors.TransferFailed();

```
([413](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L413-L413),[456](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L456-L456),[552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L552-L552),[577](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L577-L577),[634](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L634-L634))


### <a name="L-11"></a>[L-11] Input array lengths may differ
If the caller makes a copy-paste error, the lengths may be mismatched and an operation believed to have been completed may not in fact have been completed (e.g. if the array being iterated over is shorter than the one being indexed into).

*There are 10 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit positionBalanceArray[]
1210:             TokenId tokenId = TokenId.wrap(positionBalanceArray[i][0]);

// @audit positionBalanceArray[]
1213:             uint128 positionSize = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).rightSlot();

// @audit positionBalanceArray[]
1216:             uint128 poolUtilization = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).leftSlot();

```
([1210](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1210-L1210),[1213](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1213-L1213),[1216](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1216-L1216))
```solidity
File: contracts/PanopticPool.sol

// @audit positionIdList[]
442:             TokenId tokenId = positionIdList[k];

// @audit collectedByLeg[]
1677:             s_settledTokens[chunkKey] = s_settledTokens[chunkKey].add(collectedByLeg[leg]);

// @audit collectedByLeg[]
1860:             LeftRightUnsigned settledTokens = s_settledTokens[chunkKey].add(collectedByLeg[leg]);

```
([442](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L442-L442),[1677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1677-L1677),[1860](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1860-L1860))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit amounts[]
577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

```
([577](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L577-L577))
```solidity
File: contracts/libraries/PanopticMath.sol

// @audit premiasByLeg[]
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);

```
([786](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L786-L786))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit amounts[]
145:             amount = amounts[i];

// @audit ids[]
188:                 balances[i] = balanceOf[owners[i]][ids[i]];

```
([145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L145-L145),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L188-L188))

### <a name="L-12"></a>[L-12] Missing zero address check in constructor
Constructors often take address parameters to initialize important components of a contract, such as owner or linked contracts. However, without a checking, there's a risk that an address parameter could be mistakenly set to the zero address `(0x0)`. This could be due to an error or oversight during contract deployment. A zero address in a crucial role can cause serious issues, as it cannot perform actions like a normal address, and any funds sent to it will be irretrievable. It's therefore crucial to include a zero address check in constructors to prevent such potential problems. If a zero address is detected, the constructor should revert the transaction.

*There are 3 Instances of this issue* :
```solidity
File: contracts/PanopticFactory.sol

// @audit missing checks for -->  _WETH9, _SFPM, _univ3Factory, _donorNFT, _poolReference, _collateralReference
115:     constructor(
             address _WETH9,
             SemiFungiblePositionManager _SFPM,
             IUniswapV3Factory _univ3Factory,
             IDonorNFT _donorNFT,
             address _poolReference,
             address _collateralReference
         ) {

```
([115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L115-L122))
```solidity
File: contracts/PanopticPool.sol

// @audit missing checks for -->  _sfpm
280:     constructor(SemiFungiblePositionManager _sfpm) {

```
([280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L280-L280))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit missing checks for -->  _factory
341:     constructor(IUniswapV3Factory _factory) {

```
([341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L341-L341))

Explore the imperative need for meticulous checks in smart contract development, specifically addressing the absence of validations for address(0x0) during state variable updates. This concise overview sheds light on the potential risks associated with this omission and offers practical insights into rectifying the vulnerability. Stay vigilant, stay secure.

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

254:         s_univ3token0 = token0;

255:         s_univ3token1 = token1;

```
([254](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L254-L254),[255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L255-L255))
```solidity
File: contracts/PanopticFactory.sol

123:         WETH = _WETH9;

128:         POOL_REFERENCE = _poolReference;

129:         COLLATERAL_REFERENCE = _collateralReference;

136:             s_owner = _owner;

152:         s_owner = newOwner;

```
([123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L123-L123),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L128-L128),[129](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L129-L129),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L136-L136),[152](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L152-L152))

### <a name="L-13"></a>[L-13] Missing contract-existence checks before low-level calls
Low-level calls return success if there is no code present at the specified address.

*There are 1 Instance of this issue* :
```solidity
File: contracts/multicall/Multicall.sol

15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L15-L15))

### <a name="L-14"></a>[L-14] Named return variable used before assignment
As no value is written to the variable, the default value is always read. This is usually due to a bug in the code logic that causes an invalid value to be used.

*There are 1 Instance of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit tokenRequired
1235:         return tokenRequired;

```
([1235](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1235-L1235))

### <a name="L-15"></a>[L-15] Sending tokens in a loop
Performing token transfers in a loop in a Solidity contract is generally not recommended due to various reasons. One of these reasons is the 'Fail-Silently' issue.

In a Solidity loop, if one transfer operation fails, it causes the entire transaction to fail. This issue can be particularly troublesome when you're dealing with multiple transfers in one transaction. For instance, if you're looping through an array of recipients to distribute dividends or rewards, a single failed transfer will prevent all the subsequent recipients from receiving their transfers. This could be due to the recipient contract throwing an exception or due to other issues like a gas limit being exceeded.

Moreover, such a design could also inadvertently lead to a situation where a malicious contract intentionally causes a failure when receiving Ether to prevent other participants from getting their rightful transfers. This could open up avenues for griefing attacks in the system.

Resolution: To mitigate this problem, it's typically recommended to follow the 'withdraw pattern' in your contracts instead of pushing payments. In this model, each recipient would be responsible for triggering their own payment. This separates each transfer operation, so a failure in one doesn't impact the others. Additionally, it greatly reduces the chance of malicious interference as the control over fund withdrawal lies with the intended recipient and not with an external loop operation.

*There are 1 Instance of this issue* :
```solidity
File: contracts/SemiFungiblePositionManager.sol

577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

```
([577](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L577-L577))

### <a name="L-16"></a>[L-16] File allows a version of solidity that is susceptible to `.selector` related optimizer bug
In solidity versions prior to `0.8.21`, there is a legacy code generation [bug](https://soliditylang.org/blog/2023/07/19/missing-side-effects-on-selector-access-bug/) where if `foo().selector` is called, `foo()` doesn't actually get evaluated. It is listed as low-severity, because projects usually use the contract name rather than a function call to look up the selector.

*There are 3 Instances of this issue* :
```solidity
File: contracts/tokens/ERC1155Minimal.sol

115:                 ERC1155Holder.onERC1155Received.selector

166:                 ERC1155Holder.onERC1155BatchReceived.selector

225:                 ERC1155Holder.onERC1155Received.selector

```
([115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L115-L115),[166](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L166-L166),[225](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L225-L225))


### <a name="L-17"></a>[L-17] State variables not capped at reasonable values
Consider adding minimum/maximum value checks to ensure that the state variables below can never be used to excessively harm users, including via griefing

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit _commissionFee
187:         COMMISSION_FEE = _commissionFee;

// @audit _sellerCollateralRatio
188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

// @audit _buyerCollateralRatio
189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

// @audit _forceExerciseCost
190:         FORCE_EXERCISE_COST = _forceExerciseCost;

// @audit _targetPoolUtilization
191:         TARGET_POOL_UTIL = _targetPoolUtilization;

// @audit _saturatedPoolUtilization
192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

// @audit _ITMSpreadMultiplier
193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;

```
([187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L192-L192),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L193-L193))

### <a name="L-18"></a>[L-18] Consider implementing two-step procedure for updating protocol addresses
A copy-paste error or a typo may end up bricking protocol functionality, or sending tokens to an address with no known private key. Consider implementing a two-step procedure for updating protocol addresses, where the recipient is set as pending, and must 'accept' the assignment by making an affirmative call. A straight forward way of doing this would be to have the target contracts implement [EIP-165](https://eips.ethereum.org/EIPS/eip-165), and to have the 'set' functions ensure that the recipient is of the right interface type.

*There are 1 Instance of this issue* :
```solidity
File: contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81))

### <a name="L-19"></a>[L-19] Using zero as a parameter
Passing `0` or `0x0` as a function argument can sometimes result in a security issue(e.g. passing zero as the slippage parameter). A historical example is the infamous 0x0 address bug where numerous tokens were lost. This happens because `0` can be interpreted as an uninitialized address, leading to transfers to the `0x0` address, effectively burning tokens. Moreover, `0` as a denominator in division operations would cause a runtime exception. It's also often indicative of a logical error in the caller's code.

Consider using a constant variable with a descriptive name, so it's clear that the argument is intentionally being used, and for the right reasons.

*There are 6 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

893:         _validatePositionList(user, positionIdList, 0);

1023:         _validatePositionList(liquidatee, positionIdList, 0);

1153:         _validatePositionList(msg.sender, positionIdListLiquidator, 0);

1191:         _validatePositionList(msg.sender, positionIdListExercisor, 0);

1227:         _burnAllOptionsFrom(account, 0, 0, COMMIT_LONG_SETTLED, touchedId);

1592:         _validatePositionList(owner, positionIdList, 0);

```
([893](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L893-L893),[1023](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1023-L1023),[1153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1153-L1153),[1191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1191-L1191),[1227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1227-L1227),[1592](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1592-L1592))



## Non Critical Issues

### <a name="NC-01"></a>[NC-01] Consider adding validation of user inputs
There are no validations done on the arguments below. Consider that the Solidity [documentation](https://docs.soliditylang.org/en/latest/control-structures.html#panic-via-assert-and-error-via-require) states that `Properly functioning code should never create a Panic, not even on invalid external input. If this happens, then there is a bug in your contract which you should fix`. This means that there should be explicit checks for expected ranges of inputs. Underflows/overflows result in panics should not be used as range checks, and allowing funds to be sent to `0x0`, which is the default value of address variables and has many gotchas, should be avoided.

*There are 65 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit missing checks for -->  token0, token1, panopticPool
221:     function startToken(
             bool underlyingIsToken0,
             address token0,
             address token1,
             uint24 fee,
             PanopticPool panopticPool
         ) external {

// @audit missing checks for -->  recipient
323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

// @audit missing checks for -->  from, to
341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

// @audit missing checks for -->  receiver
417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

// @audit missing checks for -->  receiver
477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

// @audit missing checks for -->  owner
507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

// @audit missing checks for -->  receiver, owner
531:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) external returns (uint256 shares) {

// @audit missing checks for -->  owner
572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

// @audit missing checks for -->  receiver, owner
591:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) external returns (uint256 assets) {

// @audit missing checks for -->  positionId, longAmounts
650:     function exerciseCost(
             int24 currentTick,
             int24 oracleTick,
             TokenId positionId,
             uint128 positionBalance,
             LeftRightSigned longAmounts
         ) external view returns (LeftRightSigned exerciseFees) {

// @audit missing checks for -->  delegator, delegatee
864:     function delegate(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

// @audit missing checks for -->  delegatee
894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

// @audit missing checks for -->  delegatee
903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

// @audit missing checks for -->  delegator, delegatee
911:     function revoke(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

// @audit missing checks for -->  refunder, refundee
975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

// @audit missing checks for -->  optionOwner
995:     function takeCommissionAddData(
             address optionOwner,
             int128 longAmount,
             int128 shortAmount,
             int128 swappedAmount
         ) external onlyPanopticPool returns (int256 utilization) {

// @audit missing checks for -->  optionOwner
1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

// @audit missing checks for -->  user
1141:     function getAccountMarginDetails(
              address user,
              int24 currentTick,
              uint256[2][] memory positionBalanceArray,
              int128 premiumAllPositions
          ) public view returns (LeftRightUnsigned tokenData) {

```
([221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L221-L227),[323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345),[417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L417-L417),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L477-L477),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L507-L507),[531](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L531-L535),[572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L572-L572),[591](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L591-L595),[650](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L650-L656),[864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L864-L868),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[911](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L911-L915),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[995](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L995-L1000),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049),[1141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1141-L1146))
```solidity
File: contracts/PanopticFactory.sol

// @audit missing checks for -->  _owner
134:     function initialize(address _owner) public {

// @audit missing checks for -->  newOwner
147:     function transferOwnership(address newOwner) external {

// @audit missing checks for -->  token0, token1
210:     function deployNewPool(
             address token0,
             address token1,
             uint24 fee,
             bytes32 salt
         ) external returns (PanopticPool newPoolContract) {

// @audit missing checks for -->  univ3pool
420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L134-L134),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L147-L147),[210](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L210-L215),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

// @audit missing checks for -->  _univ3pool, token0, token1, collateralTracker0, collateralTracker1
291:     function startPool(
             IUniswapV3Pool _univ3pool,
             address token0,
             address token1,
             CollateralTracker collateralTracker0,
             CollateralTracker collateralTracker1
         ) external {

// @audit missing checks for -->  user, tokenId
352:     function optionPositionBalance(
             address user,
             TokenId tokenId
         ) external view returns (uint128 balance, uint64 poolUtilization0, uint64 poolUtilization1) {

// @audit missing checks for -->  user, positionIdList
381:     function calculateAccumulatedFeesBatch(
             address user,
             bool includePendingPremium,
             TokenId[] calldata positionIdList
         ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

// @audit missing checks for -->  user, positionIdList
410:     function calculatePortfolioValue(
             address user,
             int24 atTick,
             TokenId[] calldata positionIdList
         ) external view returns (int256 value0, int256 value1) {

// @audit missing checks for -->  positionIdList
547:     function mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit missing checks for -->  tokenId, newPositionIdList
569:     function burnOptions(
             TokenId tokenId,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit missing checks for -->  positionIdList, newPositionIdList
586:     function burnOptions(
             TokenId[] calldata positionIdList,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit missing checks for -->  positionIdListLiquidator, liquidatee, delegations, positionIdList
1017:     function liquidate(
              TokenId[] calldata positionIdListLiquidator,
              address liquidatee,
              LeftRightUnsigned delegations,
              TokenId[] calldata positionIdList
          ) external {

// @audit missing checks for -->  account, touchedId, positionIdListExercisee, positionIdListExercisor
1179:     function forceExercise(
              address account,
              TokenId[] calldata touchedId,
              TokenId[] calldata positionIdListExercisee,
              TokenId[] calldata positionIdListExercisor
          ) external {

// @audit missing checks for -->  user
1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {

// @audit missing checks for -->  positionIdList, owner
1587:     function settleLongPremium(
              TokenId[] calldata positionIdList,
              address owner,
              uint256 legIndex
          ) external {

```
([291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L291-L297),[352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L352-L355),[381](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L381-L385),[410](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L410-L414),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L547-L553),[569](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L569-L574),[586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L586-L591),[1017](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1017-L1022),[1179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1179-L1184),[1444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1444-L1444),[1587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1587-L1591))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit missing checks for -->  token0, token1
350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {

// @audit missing checks for -->  tokenId
471:     function burnTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

// @audit missing checks for -->  tokenId
504:     function mintTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

// @audit missing checks for -->  from, to
540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

// @audit missing checks for -->  from, to
566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

// @audit missing checks for -->  univ3pool, owner
1421:     function getAccountLiquidity(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper
          ) external view returns (LeftRightUnsigned accountLiquidities) {

// @audit missing checks for -->  univ3pool, owner
1449:     function getAccountPremium(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper,
              int24 atTick,
              uint256 isLong
          ) external view returns (uint128, uint128) {

// @audit missing checks for -->  univ3pool, owner
1535:     function getAccountFeesBase(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper
          ) external view returns (int128 feesBase0, int128 feesBase1) {

// @audit missing checks for -->  univ3pool
1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {

```
([350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L350-L350),[471](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L471-L480),[504](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L504-L513),[540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572),[1421](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1421-L1427),[1449](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1449-L1457),[1535](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1535-L1541),[1566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1566-L1566))
```solidity
File: contracts/libraries/FeesCalc.sol

// @audit missing checks for -->  positionIdList
46:     function getPortfolioValue(
            int24 atTick,
            mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
            TokenId[] calldata positionIdList
        ) external view returns (int256 value0, int256 value1) {

// @audit missing checks for -->  univ3pool
97:     function calculateAMMSwapFees(
            IUniswapV3Pool univ3pool,
            int24 currentTick,
            int24 tickLower,
            int24 tickUpper,
            uint128 liquidity
        ) public view returns (LeftRightSigned) {

```
([46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L46-L50),[97](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L97-L103))
```solidity
File: contracts/libraries/InteractionHelper.sol

// @audit missing checks for -->  sfpm, ct0, ct1, token0, token1
24:     function doApprovals(
            SemiFungiblePositionManager sfpm,
            CollateralTracker ct0,
            CollateralTracker ct1,
            address token0,
            address token1
        ) external {

// @audit missing checks for -->  token0, token1
48:     function computeName(
            address token0,
            address token1,
            bool isToken0,
            uint24 fee,
            string memory prefix
        ) external view returns (string memory) {

// @audit missing checks for -->  token
91:     function computeSymbol(
            address token,
            string memory prefix
        ) external view returns (string memory) {

// @audit missing checks for -->  token
107:     function computeDecimals(address token) external view returns (uint8) {

```
([24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L24-L30),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L48-L54),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L91-L94),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L107-L107))
```solidity
File: contracts/libraries/PanopticMath.sol

// @audit missing checks for -->  univ3pool
125:     function computeMedianObservedPrice(
             IUniswapV3Pool univ3pool,
             uint256 observationIndex,
             uint256 observationCardinality,
             uint256 cardinality,
             uint256 period
         ) external view returns (int24) {

// @audit missing checks for -->  univ3pool
168:     function computeInternalMedian(
             uint256 observationIndex,
             uint256 observationCardinality,
             uint256 period,
             uint256 medianData,
             IUniswapV3Pool univ3pool
         ) external view returns (int24 medianTick, uint256 updatedMedianData) {

// @audit missing checks for -->  univ3pool
241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

// @audit missing checks for -->  tokenData0, tokenData1, netExchanged, premia
651:     function getLiquidationBonus(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint160 sqrtPriceX96Twap,
             uint160 sqrtPriceX96Final,
             LeftRightSigned netExchanged,
             LeftRightSigned premia
         ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

// @audit missing checks for -->  liquidatee, positionIdList, collateralRemaining, collateral0, collateral1
768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

// @audit missing checks for -->  refunder, refundValues, collateral0, collateral1
917:     function getRefundAmounts(
             address refunder,
             LeftRightSigned refundValues,
             int24 atTick,
             CollateralTracker collateral0,
             CollateralTracker collateral1
         ) external view returns (LeftRightSigned) {

```
([125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L125-L131),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L168-L174),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L241-L241),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L651-L658),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777),[917](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L917-L923))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit missing checks for -->  operator
81:     function setApprovalForAll(address operator, bool approved) public {

// @audit missing checks for -->  from, to
94:     function safeTransferFrom(
            address from,
            address to,
            uint256 id,
            uint256 amount,
            bytes calldata data
        ) public virtual {

// @audit missing checks for -->  from, to
130:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public virtual {

// @audit missing checks for -->  owners
178:     function balanceOfBatch(
             address[] calldata owners,
             uint256[] calldata ids
         ) public view returns (uint256[] memory balances) {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81),[94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L94-L100),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L130-L136),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L178-L181))
```solidity
File: contracts/tokens/ERC20Minimal.sol

// @audit missing checks for -->  spender
49:     function approve(address spender, uint256 amount) public returns (bool) {

// @audit missing checks for -->  to
61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

// @audit missing checks for -->  from, to
81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L81-L81))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

// @audit missing checks for -->  deployer, newPoolContract, token0, token1
13:     function issueNFT(
            address deployer,
            PanopticPool newPoolContract,
            address token0,
            address token1,
            uint24 fee
        ) external;

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L13-L19))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

// @audit missing checks for -->  account
16:     function balanceOf(address account) external view returns (uint256);

// @audit missing checks for -->  spender
22:     function approve(address spender, uint256 amount) external;

// @audit missing checks for -->  to
27:     function transfer(address to, uint256 amount) external;

```
([16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L16-L16),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L22-L22),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L27-L27))
### <a name="NC-02"></a>[NC-02] `address` shouldn't be hard-coded
It is often better to declare `address` as `immutable`, and assign them via constructor arguments. This allows the code to remain the same across deployments on different networks, and avoids recompilation when addresses need to change.

*There are 20 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

308:             s_miniMedian =
                     (uint256(block.timestamp) << 216) +
                     // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
                     // see comment on s_miniMedian initialization for format of this magic number
                     (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
                     (uint256(uint24(currentTick)) << 24) + // add to slot 4
                     (uint256(uint24(currentTick))); // add to slot 3

```
([308](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L308-L314))
```solidity
File: contracts/libraries/Math.sol

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

```
([137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173))
### <a name="NC-03"></a>[NC-03] Assembly blocks should have extensive comments
Assembly blocks take a lot more time to audit than normal Solidity code, and often have gotchas and side-effects that the Solidity versions of the same code do not. Consider adding more comments explaining what is being done in every step of the assembly code, and describe why assembly is being used instead of Solidity.

*There are 21 Instances of this issue* :
```solidity
File: contracts/libraries/Math.sol

353:             assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }

362:                 assembly ("memory-safe") {
                         result := div(prod0, denominator)
                     }

379:             assembly ("memory-safe") {
                     remainder := mulmod(a, b, denominator)
                 }

383:             assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }

393:             assembly ("memory-safe") {
                     denominator := div(denominator, twos)
                 }

398:             assembly ("memory-safe") {
                     prod0 := div(prod0, twos)
                 }

404:             assembly ("memory-safe") {
                     twos := add(div(sub(0, twos), twos), 1)
                 }

467:             assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }

493:             assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x10000000000000000)
                 }

497:             assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }

530:             assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }

556:             assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x1000000000000000000000000)
                 }

560:             assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }

607:             assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }

633:             assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x100000000000000000000000000000000)
                 }

637:             assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }

684:             assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }

710:             assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x1000000000000000000000000000000000000000000000000)
                 }

714:             assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }

739:         assembly ("memory-safe") {
                 result := add(div(a, b), gt(mod(a, b), 0))
             }

```
([353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L353-L357),[362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L362-L364),[379](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L379-L381),[383](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L383-L386),[393](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L393-L395),[398](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L398-L400),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L404-L406),[467](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L467-L471),[493](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L493-L495),[497](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L497-L500),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L530-L534),[556](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L556-L558),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L560-L563),[607](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L607-L611),[633](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L633-L635),[637](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L637-L640),[684](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L684-L688),[710](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L710-L712),[714](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L714-L717),[739](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L739-L741))
```solidity
File: contracts/multicall/Multicall.sol

25:                 assembly ("memory-safe") {
                        revert(add(result, 32), mload(result))
                    }

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L25-L27))
### <a name="NC-04"></a>[NC-04] Avoid double casting
Consider refactoring the following code,  as double casting may introduce unexpected truncations and/or rounding issues. Furthermore, double type casting can make the code less readable and harder to maintain, increasing the likelihood of errors and misunderstandings during development and debugging.

*There are 67 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

667:                     int24 range = int24(
                             int256(
                                 Math.unsafeDivRoundingUp(
                                     uint24(positionId.width(leg) * positionId.tickSpacing()),
                                     2
                                 )
                             )
                         );

715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

1003:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1028:             s_poolAssets = uint128(uint256(updatedAssets));

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));

1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

1121:                     uint256(uint128(shortAmount + longAmount)) * COMMISSION_FEE,

1184:                 netBalance += uint256(uint128(premiumAllPositions));

1329:             ? int64(uint64(poolUtilization))

1330:             : int64(uint64(poolUtilization >> 64));

1585:                     ? int64(uint64(poolUtilization))

1586:                     : int64(uint64(poolUtilization >> 64))

1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +

1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

```
([667](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L667-L674),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L715-L715),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L715-L715),[718](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L718-L718),[718](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L718-L718),[1003](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1003-L1003),[1028](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1028-L1028),[1029](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1029-L1029),[1029](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1029-L1029),[1052](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1052-L1052),[1084](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1084-L1084),[1085](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1085-L1085),[1085](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1085-L1085),[1121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1121-L1121),[1184](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1184-L1184),[1329](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1329-L1329),[1330](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1330-L1330),[1585](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1585-L1585),[1586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1586-L1586),[1637](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1637-L1637),[1638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1638-L1638))
```solidity
File: contracts/PanopticPool.sol

313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

314:                 (uint256(uint24(currentTick))); // add to slot 3

1144:             uint256(int256(uint256(_delegations.rightSlot())) + liquidationBonus0)

1149:             uint256(int256(uint256(_delegations.leftSlot())) + liquidationBonus1)

1548:                             int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )

1557:                             int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

```
([313](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L313-L313),[314](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L314-L314),[1144](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1144-L1144),[1149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1149-L1149),[1548](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1548-L1554),[1557](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1557-L1563),[1635](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1635-L1635),[1636](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1636-L1636))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1169:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside0LastX128, liquidity)))

1172:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside1LastX128, liquidity)))

1176:                 .toRightSlot(int128(int256(Math.mulDiv128(feeGrowthInside0LastX128, liquidity))))

1177:                 .toLeftSlot(int128(int256(Math.mulDiv128(feeGrowthInside1LastX128, liquidity))));

1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

1215:             int128(int256(amount1))

1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(

1242:                 -int128(int256(amount1))

```
([1169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1169-L1169),[1172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1172-L1172),[1176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1176-L1176),[1177](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1177-L1177),[1214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1214-L1214),[1215](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1215-L1215),[1241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1241-L1241),[1242](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1242-L1242))
```solidity
File: contracts/libraries/FeesCalc.sol

117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))

118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));

```
([117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L117-L117),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L118-L118))
```solidity
File: contracts/libraries/Math.sol

130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();

```
([130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L130-L130),[131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L131-L131))
```solidity
File: contracts/libraries/PanopticMath.sol

51:             poolId += uint64(uint24(tickSpacing)) << 48;

103:                 (uint248(uint256(keccak256(abi.encode(tokenId)))));

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

217:                     entry = int24(uint24(medianData >> (rank * 24)));

229:                     uint256(uint192(medianData << 24)) +

230:                     uint256(uint24(lastObservedTick));

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

693:             int256 balance0 = int256(uint256(tokenData0.rightSlot())) -

695:             int256 balance1 = int256(uint256(tokenData1.rightSlot())) -

```
([51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L51-L51),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L103-L103),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L178),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L183-L183),[217](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L217-L217),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L229-L229),[230](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L230-L230),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L258-L258),[377](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L377-L377),[693](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L693-L693),[695](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L695-L695))
```solidity
File: contracts/types/LeftRight.sol

27:         int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

27:         int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();

201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L27-L27),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L27-L27),[196](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L196-L196),[201](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L201-L201))
```solidity
File: contracts/types/LiquidityChunk.sol

78:                     (uint256(uint24(_tickLower)) << 232) +

79:                         (uint256(uint24(_tickUpper)) << 208) +

109:                     LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)

126:                     LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)

173:             return int24(int256(LiquidityChunk.unwrap(self) >> 232));

182:             return int24(int256(LiquidityChunk.unwrap(self) >> 208));

```
([78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L78-L78),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L79-L79),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L109-L109),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L126-L126),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L173-L173),[182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L182-L182))
```solidity
File: contracts/types/TokenId.sol

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

195:             return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));

```
([98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L98-L98),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L160-L160),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[195](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L195-L195))
### <a name="NC-05"></a>[NC-05] Contracts should have all `public`/`external` functions exposed by `interface`s
The `contract`s should expose an `interface` so that other projects can more easily integrate with it, without having to develop their own non-standard variants.

*There are 16 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit  startToken(), getPoolData(), name(), symbol(), decimals(), transfer(), transferFrom(), asset(), totalAssets(), convertToShares(), convertToAssets(), maxDeposit(), previewDeposit(), deposit(), maxMint(), previewMint(), mint(), maxWithdraw(), previewWithdraw(), withdraw(), maxRedeem(), previewRedeem(), redeem(), exerciseCost(), delegate(), delegate(), refund(), revoke(), refund(), takeCommissionAddData(), exercise(), getAccountMarginDetails()
36: contract CollateralTracker is ERC20Minimal, Multicall {

// @audit  startToken(), getPoolData(), name(), symbol(), decimals(), transfer(), transferFrom(), asset(), totalAssets(), convertToShares(), convertToAssets(), maxDeposit(), previewDeposit(), deposit(), maxMint(), previewMint(), mint(), maxWithdraw(), previewWithdraw(), withdraw(), maxRedeem(), previewRedeem(), redeem(), exerciseCost(), delegate(), delegate(), refund(), revoke(), refund(), takeCommissionAddData(), exercise(), getAccountMarginDetails()
36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

// @audit  initialize(), transferOwnership(), owner(), uniswapV3MintCallback(), deployNewPool(), minePoolAddress(), getPanopticPool()
26: contract PanopticFactory is Multicall {

// @audit  initialize(), transferOwnership(), owner(), uniswapV3MintCallback(), deployNewPool(), minePoolAddress(), getPanopticPool()
26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

// @audit  startPool(), assertPriceWithinBounds(), optionPositionBalance(), calculateAccumulatedFeesBatch(), calculatePortfolioValue(), pokeMedian(), mintOptions(), burnOptions(), burnOptions(), liquidate(), forceExercise(), univ3pool(), collateralToken0(), collateralToken1(), numberOfPositions(), settleLongPremium()
27: contract PanopticPool is ERC1155Holder, Multicall {

// @audit  startPool(), assertPriceWithinBounds(), optionPositionBalance(), calculateAccumulatedFeesBatch(), calculatePortfolioValue(), pokeMedian(), mintOptions(), burnOptions(), burnOptions(), liquidate(), forceExercise(), univ3pool(), collateralToken0(), collateralToken1(), numberOfPositions(), settleLongPremium()
27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit  initializeAMMPool(), uniswapV3MintCallback(), uniswapV3SwapCallback(), burnTokenizedPosition(), mintTokenizedPosition(), safeTransferFrom(), safeBatchTransferFrom(), getAccountLiquidity(), getAccountPremium(), getAccountFeesBase(), getUniswapV3PoolFromId(), getPoolId()
72: contract SemiFungiblePositionManager is ERC1155, Multicall {

// @audit  initializeAMMPool(), uniswapV3MintCallback(), uniswapV3SwapCallback(), burnTokenizedPosition(), mintTokenizedPosition(), safeTransferFrom(), safeBatchTransferFrom(), getAccountLiquidity(), getAccountPremium(), getAccountFeesBase(), getUniswapV3PoolFromId(), getPoolId()
72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72),[72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/libraries/FeesCalc.sol

// @audit  getPortfolioValue(), calculateAMMSwapFees()
39: library FeesCalc {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L39))
```solidity
File: contracts/libraries/InteractionHelper.sol

// @audit  doApprovals(), computeName(), computeSymbol(), computeDecimals()
17: library InteractionHelper {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L17))
```solidity
File: contracts/libraries/PanopticMath.sol

// @audit  numberOfLeadingHexZeros(), computeMedianObservedPrice(), computeInternalMedian(), twapFilter(), getLiquidationBonus(), haircutPremia(), getRefundAmounts()
18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/multicall/Multicall.sol

// @audit  multicall()
8: abstract contract Multicall {

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L8))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit  setApprovalForAll(), safeTransferFrom(), safeBatchTransferFrom(), balanceOfBatch(), supportsInterface()
11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

// @audit  approve(), transfer(), transferFrom()
9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

// @audit  issueNFT()
6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

// @audit  balanceOf(), approve(), transfer()
11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
### <a name="NC-06"></a>[NC-06] Contracts should have full test coverage
While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L12))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L7))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

39: library FeesCalc {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L39))
```solidity
File: contracts/libraries/InteractionHelper.sol

17: library InteractionHelper {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L17))
```solidity
File: contracts/libraries/Math.sol

13: library Math {

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L13))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L11))
```solidity
File: contracts/multicall/Multicall.sol

8: abstract contract Multicall {

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L8))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L17))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L52))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L60))
### <a name="NC-07"></a>[NC-07] Control structures do not follow the Solidity Style Guide
See the [control structures](https://docs.soliditylang.org/en/latest/style-guide.html#control-structures) section of the Solidity Style Guide

*There are 149 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

170:         if (msg.sender != address(s_panopticPool)) revert Errors.NotPanopticPool();

229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

519:         uint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.

536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();

544:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();

602:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

664:                 if (positionId.isLong(leg) == 0) continue;

707:                 if (

856:           LIFECYCLE OF A COLLATERAL TOKEN AND DELEGATE/REVOKE LOGIC

1257:                 if (tokenId.tokenType(index) != (underlyingIsToken0 ? 0 : 1)) continue;

1345:                 if (

1373:                     if (

```
([170](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L170-L170),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L229-L229),[331](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L331-L331),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L350-L350),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L418-L418),[480](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L480-L480),[519](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L519-L519),[536](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L536-L536),[544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L544-L544),[596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L596-L596),[602](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L602-L602),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L664-L664),[707](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L707-L707),[856](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L856-L856),[1257](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1257-L1257),[1345](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1345-L1345),[1373](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1373-L1373))
```solidity
File: contracts/PanopticFactory.sol

7: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

7: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

66:     SemiFungiblePositionManager internal immutable SFPM;

117:         SemiFungiblePositionManager _SFPM,

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

181:         if (amount0Owed > 0)

188:         if (amount1Owed > 0)

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

227:         if (address(v3Pool) == address(0)) revert Errors.UniswapPoolNotInitialized();

229:         if (address(s_getPanopticPool[v3Pool]) != address(0))

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L7-L7),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L7-L7),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L66-L66),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L117-L117),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L150-L150),[181](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L181-L181),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L188-L188),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L220-L220),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L224-L224),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L227-L227),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L229-L229))
```solidity
File: contracts/PanopticPool.sol

6: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

6: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

179:     SemiFungiblePositionManager internal immutable SFPM;

299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();

533:         if (medianData != 0) s_miniMedian = medianData;

633:         if (tokenId.poolId() != SFPM.getPoolId(address(s_univ3pool)))

638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)

664:         if (medianData != 0) s_miniMedian = medianData;

940:         if (!solventAtFast) revert Errors.NotEnoughCollateral();

943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

944:             if (!_checkSolvencyAtTick(user, positionIdList, currentTick, slowOracleTick, buffer))

1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)

1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();

1155:         if (

1188:         if (touchedId.length != 1) revert Errors.InputListFail();

1274:         if (positionIdListExercisor.length > 0)

1394:         if (fingerprintIncomingList != currentHash) revert Errors.InputListFail();

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1483:         if (netLiquidity == 0) return;

1492:         if (effectiveLiquidityFactorX32 > uint256(effectiveLiquidityLimitX32))

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

1865:                     if (commitLongSettled)

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L6-L6),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L6-L6),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L179-L179),[299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L299-L299),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L533-L533),[633](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L633-L633),[638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L638-L638),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L664-L664),[940](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L940-L940),[943](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L943-L943),[944](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L944-L944),[1035](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1035-L1035),[1066](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1066-L1066),[1155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1155-L1155),[1188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1188-L1188),[1274](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1274-L1274),[1394](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1394-L1394),[1415](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1415-L1415),[1483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1483-L1483),[1492](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1492-L1492),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596),[1865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1865-L1865))
```solidity
File: contracts/SemiFungiblePositionManager.sol

153:         We're tracking the amount of net and removed liquidity for the specific region:

182:         time, we call this the gross premia. If that liquidity has been removed, we also need to

205:         In addition to tracking, we also want to track those fees plus a small spread. Specifically,

282:         specific risk management profile of every smart contract. And simply setting the ν parameter

322:         if (s_poolContext[poolId].locked) revert Errors.ReentrantCall();

355:         if (univ3pool == address(0)) revert Errors.UniswapPoolNotInitialized();

362:         if (s_AddrToPoolIdData[univ3pool] != 0) return;

412:         if (amount0Owed > 0)

419:         if (amount1Owed > 0)

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

631:             if (

638:             if (LeftRightUnsigned.unwrap(fromLiq) != liquidityChunk.liquidity())

688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();

727:         if ((currentTick >= tickLimitHigh) || (currentTick <= tickLimitLow))

833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

939:         if (amount0 > uint128(type(int128).max) || amount1 > uint128(type(int128).max))

```
([153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L153-L153),[182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L182-L182),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L205-L205),[282](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L282-L282),[322](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L322-L322),[355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L355-L355),[362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L362-L362),[412](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L412-L412),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L419-L419),[549](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L549-L549),[576](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L576-L576),[631](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L631-L631),[638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L638-L638),[688](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L688-L688),[702](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L702-L702),[727](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L727-L727),[833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L833-L833),[939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L939-L939))
```solidity
File: contracts/libraries/CallbackLib.sol

36:         if (factory.getPool(features.token0, features.token1, features.fee) != sender)

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L36-L36))
```solidity
File: contracts/libraries/InteractionHelper.sol

8: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

8: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

25:         SemiFungiblePositionManager sfpm,

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L8-L8),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L8-L8),[25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L25-L25))
```solidity
File: contracts/libraries/Math.sol

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

351:             uint256 prod0; // Least significant 256 bits of the product

352:             uint256 prod1; // Most significant 256 bits of the product

465:             uint256 prod0; // Least significant 256 bits of the product

466:             uint256 prod1; // Most significant 256 bits of the product

528:             uint256 prod0; // Least significant 256 bits of the product

529:             uint256 prod1; // Most significant 256 bits of the product

605:             uint256 prod0; // Least significant 256 bits of the product

606:             uint256 prod1; // Most significant 256 bits of the product

682:             uint256 prod0; // Least significant 256 bits of the product

683:             uint256 prod1; // Most significant 256 bits of the product

757:             if (i == j) return;

768:             if (left < j) quickSort(arr, left, j);

769:             if (i < right) quickSort(arr, i, right);

```
([131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L131-L131),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173),[176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L176-L176),[297](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L297-L297),[312](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L312-L312),[319](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L319-L319),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L326-L326),[351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L351-L351),[352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L352-L352),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L465-L465),[466](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L466-L466),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L528-L528),[529](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L529-L529),[605](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L605-L605),[606](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L606-L606),[682](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L682-L682),[683](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L683-L683),[757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L757-L757),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L768-L768),[769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L769-L769))
```solidity
File: contracts/libraries/PanopticMath.sol

77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

203:                 uint24 shift = 1;

212:                         shift -= 1;

219:                         shift += 1;

223:                     newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));

356:             if (

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

797:             if (

821:             } else if (

856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));

857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));

```
([77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L77-L77),[203](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L203-L203),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L212-L212),[219](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L219-L219),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L223-L223),[356](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L356-L356),[479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L479-L479),[797](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L797-L797),[821](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L821-L821),[856](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L856-L856),[857](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L857-L857))
```solidity
File: contracts/libraries/SafeTransferLib.sol

45:         if (!success) revert Errors.TransferFailed();

75:         if (!success) revert Errors.TransferFailed();

```
([45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L45-L45),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L75-L75))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

113:             if (

137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

164:             if (

223:             if (

```
([101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L101-L101),[113](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L113-L113),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L137-L137),[164](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L164-L164),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L223-L223))
```solidity
File: contracts/tokens/ERC20Minimal.sol

84:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;

```
([84](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L84-L84))
```solidity
File: contracts/types/LeftRight.sol

160:             if (

183:             if (

199:             if (left128 != left) revert Errors.UnderOverFlow();

204:             if (right128 != right) revert Errors.UnderOverFlow();

222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

240:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

262:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

```
([160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L160-L160),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L183-L183),[199](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L199-L199),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L204-L204),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L222-L222),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L240-L240),[262](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L262-L262))
```solidity
File: contracts/types/TokenId.sol

465:         if (i == 0)

471:         if (i == 1)

477:         if (i == 2)

483:         if (i == 3)

501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

530:                 if (

541:                     if (self.riskPartner(riskPartnerIndex) != i)

545:                     if (

560:                     if ((_isLong == isLongP) && (_tokenType == tokenTypeP))

566:                     if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))

592:                     if (self.isLong(i) == 1) return; // validated

```
([465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L465-L465),[471](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L471-L471),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L477-L477),[483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L483-L483),[501](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L501-L501),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L512-L512),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L528-L528),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L530-L530),[541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L541-L541),[545](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L545-L545),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L560-L560),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L566-L566),[592](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L592-L592))
### <a name="NC-08"></a>[NC-08] Use `string.concat()` or `bytes.concat()` instead of `abi.encodePacked`
Solidity version 0.8.4 introduces `bytes.concat()` (vs `abi.encodePacked(<bytes>,<bytes>)`)

Solidity version 0.8.12 introduces `string.concat()` (vs `abi.encodePacked(<str>,<str>), which catches concatenation errors (in the event of a `bytes` data mixed in the concatenation)`)

*There are 12 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

462:                         abi.encodePacked(
                                 tokenId.strike(leg),
                                 tokenId.width(leg),
                                 tokenId.tokenType(leg)
                             )

1643:                 abi.encodePacked(
                          tokenId.strike(legIndex),
                          tokenId.width(legIndex),
                          tokenId.tokenType(legIndex)
                      )

1674:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))

1856:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))

```
([462](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L462-L466),[1643](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1643-L1647),[1674](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1674-L1674),[1856](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1856-L1856))
```solidity
File: contracts/SemiFungiblePositionManager.sol

612:                 abi.encodePacked(
                         address(univ3pool),
                         from,
                         id.tokenType(leg),
                         liquidityChunk.tickLower(),
                         liquidityChunk.tickUpper()
                     )

621:                 abi.encodePacked(
                         address(univ3pool),
                         to,
                         id.tokenType(leg),
                         liquidityChunk.tickLower(),
                         liquidityChunk.tickUpper()
                     )

975:             abi.encodePacked(
                     address(univ3pool),
                     msg.sender,
                     tokenType,
                     liquidityChunk.tickLower(),
                     liquidityChunk.tickUpper()
                 )

1151:                     abi.encodePacked(
                              address(this),
                              liquidityChunk.tickLower(),
                              liquidityChunk.tickUpper()
                          )

1431:             keccak256(abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper))

1459:             abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper)

1544:             keccak256(abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper))

```
([612](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L612-L618),[621](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L621-L627),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L975-L981),[1151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1151-L1155),[1431](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1431-L1431),[1459](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1459-L1459),[1544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1544-L1544))
```solidity
File: contracts/libraries/PanopticMath.sol

879:                             abi.encodePacked(
                                     tokenId.strike(0),
                                     tokenId.width(0),
                                     tokenId.tokenType(0)
                                 )

```
([879](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L879-L883))
### <a name="NC-09"></a>[NC-09] Consider making contracts Upgradeable
This allows for bugs to be fixed in production, at the expense of significantly increasing centralization.

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72),[72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
### <a name="NC-10"></a>[NC-10] Constants in comparisons should appear on the left side
Doing so will prevent [typo bugs](https://www.moserware.com/2008/01/constants-on-left-are-better-but-this.html) where the first `!`, `>`, `<`, or `=` at the beginning of the operator is missing.

*There are 155 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

262:             s_ITMSpreadFee = uint128((ITM_SPREAD_MULTIPLIER * _poolFee) / DECIMALS);

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

405:                 totalAssets() * DECIMALS

446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);

463:                 shares * DECIMALS,

512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

664:                 if (positionId.isLong(leg) == 0) continue;

708:                     (tokenType == 0 && currentValue1 < oracleValue1) ||

731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))

732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

743:             return int256((s_inAMM * DECIMALS) / totalAssets());

776:         if (utilization < 0) {

976:         if (assets > 0) {

1010:             if (tokenToPay > 0) {

1018:             } else if (tokenToPay < 0) {

1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

1067:             if (tokenToPay > 0) {

1075:             } else if (tokenToPay < 0) {

1107:             if (intrinsicValue != 0) {

1168:         if (positionBalanceArray.length > 0) {

1173:             if (premiumAllPositions < 0) {

1182:         if (premiumAllPositions > 0) {

1325:         uint128 amountMoved = tokenType == 0 ? amountsMoved.rightSlot() : amountsMoved.leftSlot();

1328:         int64 utilization = tokenType == 0

1339:             if (isLong == 0) {

1347:                     ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0

1375:                         ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0

1479:         if (isLong == 0) {

1544:                 if (tokenType == 0) {

1582:                 tokenType == 0 ? movedRight : movedLeft,

1584:                 tokenType == 0

1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +

1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

```
([262](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L262-L262),[331](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L331-L331),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L350-L350),[405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L405-L405),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L446-L446),[463](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L463-L463),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L512-L512),[575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L575-L575),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L664-L664),[708](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L708-L708),[731](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L731-L731),[732](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L732-L732),[743](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L743-L743),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L776-L776),[976](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L976-L976),[1010](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1010-L1010),[1018](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1018-L1018),[1060](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1060-L1060),[1060](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1060-L1060),[1060](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1060-L1060),[1067](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1067-L1067),[1075](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1075-L1075),[1107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1107-L1107),[1168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1168-L1168),[1173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1173-L1173),[1182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1182-L1182),[1325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1325-L1325),[1328](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1328-L1328),[1339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1339-L1339),[1347](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1347-L1347),[1375](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1375-L1375),[1479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1479-L1479),[1544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1544-L1544),[1582](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1582-L1582),[1584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1584-L1584),[1637](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1637-L1637),[1638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1638-L1638))
```solidity
File: contracts/PanopticFactory.sol

181:         if (amount0Owed > 0)

188:         if (amount1Owed > 0)

```
([181](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L181-L181),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L188-L188))
```solidity
File: contracts/PanopticPool.sol

460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {

533:         if (medianData != 0) s_miniMedian = medianData;

638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)

664:         if (medianData != 0) s_miniMedian = medianData;

865:             if (tokenId.isLong(leg) == 0) {

943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)

1274:         if (positionIdListExercisor.length > 0)

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1483:         if (netLiquidity == 0) return;

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

1679:             if (tokenId.isLong(leg) == 0) {

1780:                                     (accumulated0 == 0 ? type(uint256).max : accumulated0),

1789:                                     (accumulated1 == 0 ? type(uint256).max : accumulated1),

1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {

1928:                         s_grossPremiumLast[chunkKey] = totalLiquidity != 0

```
([460](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L460-L460),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L533-L533),[638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L638-L638),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L664-L664),[865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L865-L865),[943](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L943-L943),[1035](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1035-L1035),[1274](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1274-L1274),[1415](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1415-L1415),[1483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1483-L1483),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596),[1679](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1679-L1679),[1780](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1780-L1780),[1789](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1789-L1789),[1862](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1862-L1862),[1928](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1928-L1928))
```solidity
File: contracts/SemiFungiblePositionManager.sol

362:         if (s_AddrToPoolIdData[univ3pool] != 0) return;

412:         if (amount0Owed > 0)

419:         if (amount1Owed > 0)

446:         address token = amount0Delta > 0

453:         uint256 amountToPay = amount0Delta > 0 ? uint256(amount0Delta) : uint256(amount1Delta);

632:                 (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||

633:                 (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)

688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {

787:             if ((itm0 != 0) && (itm1 != 0)) {

787:             if ((itm0 != 0) && (itm1 != 0)) {

819:                 zeroForOne = net0 < 0;

823:             } else if (itm0 != 0) {

824:                 zeroForOne = itm0 < 0;

827:                 zeroForOne = itm1 > 0;

833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

999:             if (isLong == 0) {

1066:             moved = isLong == 0

1078:             if (tokenType == 0) {

1085:         if (currentLiquidity.rightSlot() > 0) {

1279:         if (LeftRightSigned.unwrap(amountToCollect) != 0) {

1296:                 collected0 = movedInLeg.rightSlot() < 0

1299:                 collected1 = movedInLeg.leftSlot() < 0

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1469:             if (netLiquidity != 0) {

```
([362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L362-L362),[412](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L412-L412),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L419-L419),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L446-L446),[453](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L453-L453),[632](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L632-L632),[633](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L633-L633),[688](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L688-L688),[717](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L717-L717),[787](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L787-L787),[787](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L787-L787),[819](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L819-L819),[823](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L823-L823),[824](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L824-L824),[827](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L827-L827),[833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L833-L833),[999](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L999-L999),[1066](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1066-L1066),[1078](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1078-L1078),[1085](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1085-L1085),[1279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1279-L1279),[1296](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1296-L1296),[1299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1299-L1299),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1367-L1367),[1469](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1469-L1469))
```solidity
File: contracts/libraries/FeesCalc.sol

67:                 if (tokenId.isLong(leg) == 0) {

```
([67](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L67-L67))
```solidity
File: contracts/libraries/Math.sol

74:         return x > 0 ? x : -x;

83:             return x > 0 ? uint256(x) : uint256(-x);

130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

133:             uint256 sqrtR = absTick & 0x1 != 0

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

360:             if (prod1 == 0) {

361:                 require(denominator > 0);

447:             if (mulmod(a, b, denominator) > 0) {

474:             if (prod1 == 0) {

537:             if (prod1 == 0) {

587:             if (mulmod(a, b, 2 ** 96) > 0) {

614:             if (prod1 == 0) {

664:             if (mulmod(a, b, 2 ** 128) > 0) {

691:             if (prod1 == 0) {

```
([74](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L74-L74),[83](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L83-L83),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L130-L130),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L133-L133),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173),[176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L176-L176),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L179-L179),[312](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L312-L312),[360](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L360-L360),[361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L361-L361),[447](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L447-L447),[474](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L474-L474),[537](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L537-L537),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L587-L587),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L614-L614),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L664-L664),[691](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L691-L691))
```solidity
File: contracts/libraries/PanopticMath.sol

62:             return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);

325:         if (tokenId.asset(legIndex) == 0) {

357:                 tickLower % tickSpacing != 0 ||

358:                 tickUpper % tickSpacing != 0 ||

425:         if (tokenType == 0) {

475:             uint256 notional = asset == 0

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

532:                 return amount < 0 ? -absResult : absResult;

537:                 return amount < 0 ? -absResult : absResult;

555:                 return amount < 0 ? -absResult : absResult;

564:                 return amount < 0 ? -absResult : absResult;

584:         if (tokenId.asset(legIndex) == 0) {

615:         bool isShort = tokenId.isLong(legIndex) == 0;

618:         if (tokenId.tokenType(legIndex) == 0) {

850:                 collateralDelta0 = 0;

851:                 collateralDelta1 = 0;

856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));

857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));

931:             if (balanceShortage > 0) {

949:             if (balanceShortage > 0) {

```
([62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L62-L62),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L325-L325),[357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L357-L357),[358](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L358-L358),[425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L425-L425),[475](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L475-L475),[479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L479-L479),[532](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L532-L532),[537](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L537-L537),[555](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L555-L555),[564](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L564-L564),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L584-L584),[615](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L615-L615),[618](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L618-L618),[850](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L850-L850),[851](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L851-L851),[856](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L856-L856),[857](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L857-L857),[931](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L931-L931),[949](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L949-L949))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

112:         if (to.code.length != 0) {

163:         if (to.code.length != 0) {

222:         if (to.code.length != 0) {

```
([112](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L112-L112),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L163-L163),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L222-L222))
```solidity
File: contracts/types/LeftRight.sol

68:                     (LeftRightUnsigned.unwrap(self) & LEFT_HALF_BIT_MASK) +

88:                     (LeftRightSigned.unwrap(self) & LEFT_HALF_BIT_MASK_INT) +

89:                         (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)

```
([68](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L68-L68),[88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L88-L88),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L89-L89))
```solidity
File: contracts/types/LiquidityChunk.sol

141:                 LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TL_MASK).addTickLower(

158:                 LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TU_MASK).addTickUpper(

```
([141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L141-L141),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L158-L158))
```solidity
File: contracts/types/TokenId.sol

300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

371:             uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;

377:                 optionRatios = 0;

395:                         ((LONG_MASK >> (48 * (4 - optionRatios))) & CLEAR_POOLID_MASK)

434:         uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;

465:         if (i == 0)

501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);

506:             uint256 chunkData = (TokenId.unwrap(self) & CHUNK_MASK) >> 64;

508:                 if (self.optionRatio(i) == 0) {

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

```
([300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L300-L300),[371](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L371-L371),[377](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L377-L377),[395](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L395-L395),[434](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L434-L434),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L465-L465),[501](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L501-L501),[506](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L506-L506),[508](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L508-L508),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L512-L512),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L528-L528))
### <a name="NC-11"></a>[NC-11] Variable names that consist of all capital letters should be reserved for `constant` variables
If the variable needs to be different based on which class it comes from, a `view`/`pure` *function* should be used instead (e.g. like [this](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/76eee35971c2541585e05cbf258510dda7b2fbc6/contracts/token/ERC20/extensions/draft-IERC20Permit.sol#L59)).

*There are 9 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

81:     int128 internal constant DECIMALS_128 = 10_000;

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L81-L81))
```solidity
File: contracts/libraries/Constants.sol

9:     uint256 internal constant FP96 = 0x1000000000000000000000000;

12:     int24 internal constant MIN_V3POOL_TICK = -887272;

15:     int24 internal constant MAX_V3POOL_TICK = 887272;

18:     uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;

21:     uint160 internal constant MAX_V3POOL_SQRT_RATIO =
            1461446703485210103287273052203988822378723970342;

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L9-L9),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L12-L12),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L15-L15),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L18-L18),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L21-L22))
```solidity
File: contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15))
```solidity
File: contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23))
```solidity
File: contracts/types/TokenId.sol

78:     int256 internal constant BITMASK_INT24 = 0xFFFFFF;

```
([78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L78-L78))
### <a name="NC-12"></a>[NC-12] Default Visibility for `constant`/`immutable` variables
Some constants/immutables are using the default visibility. For readability, consider explicitly declaring them as `internal`.

*There are 8 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

131:     uint256 immutable TICK_DEVIATION;

136:     uint256 immutable COMMISSION_FEE;

141:     uint256 immutable SELLER_COLLATERAL_RATIO;

145:     uint256 immutable BUYER_COLLATERAL_RATIO;

149:     int256 immutable FORCE_EXERCISE_COST;

154:     uint256 immutable TARGET_POOL_UTIL;

158:     uint256 immutable SATURATED_POOL_UTIL;

162:     uint256 immutable ITM_SPREAD_MULTIPLIER;

```
([131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L131-L131),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L136-L136),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L141-L141),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L145-L145),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L149-L149),[154](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L154-L154),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L158-L158),[162](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L162-L162))
### <a name="NC-13"></a>[NC-13] Consider using delete rather than assigning zero/false to clear values
The `delete` keyword more closely matches the semantics of what is being done, and draws more attention to the changing of state, which may lead to a more thorough audit of its associated logic

*There are 3 Instances of this issue* :
```solidity
File: contracts/libraries/PanopticMath.sol

850:                 collateralDelta0 = 0;

851:                 collateralDelta1 = 0;

```
([850](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L850-L850),[851](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L851-L851))
```solidity
File: contracts/types/TokenId.sol

377:                 optionRatios = 0;

```
([377](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L377-L377))
### <a name="NC-14"></a>[NC-14] Division by zero not prevented
The divisions below take an input parameter which does not have any zero-value checks, which may lead to the functions reverting when zero is passed.

*There are 18 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);

677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)

743:             return int256((s_inAMM * DECIMALS) / totalAssets());

```
([446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L446-L446),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L677-L677),[743](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L743-L743))
```solidity
File: contracts/PanopticFactory.sol

392:             tickLower = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

```
([392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L392-L392))
```solidity
File: contracts/PanopticPool.sol

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1732:                                     totalLiquidityBefore) / (totalLiquidity)

1740:                                     totalLiquidityBefore) / (totalLiquidity)

1945:                                         ) / totalLiquidity

1962:                                         ) / totalLiquidity

```
([1487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1487-L1487),[1732](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1732-L1732),[1740](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1740-L1740),[1945](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1945-L1945),[1962](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1962-L1962))
```solidity
File: contracts/SemiFungiblePositionManager.sol

228:               s_accountPremiumOwed += feeGrowthX128 * R * (1 + ν*R/N) / R

271:                                 = ∆feeGrowthX128 * t * (T - R + ν*R^2/T) / N 

272:                                 = ∆feeGrowthX128 * t * (N + ν*R^2/T) / N

```
([228](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L228-L228),[271](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L271-L271),[272](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L272-L272))
```solidity
File: contracts/libraries/Math.sol

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

200:                 ) / lowPriceX96;

```
([176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L176-L176),[200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L200-L200))
```solidity
File: contracts/libraries/PanopticMath.sol

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

346:             int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

347:             int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;

669:                 uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);

```
([258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L258-L258),[346](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L346-L346),[347](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L347-L347),[669](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L669-L669))
### <a name="NC-15"></a>[NC-15] Use scientific notation (e.g. `1e18`) rather than exponentiation (e.g. `10**18`)
While the compiler knows to optimize away the exponentiation, it's still better coding practice to use idioms that do not require compiler optimization, if they exist

*There are 61 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

205:                     (7812 * ratioTick ** 2) /

206:                     10_000 ** 2 +

207:                     (6510 * ratioTick ** 3) /

208:                     10_000 ** 3

234:         totalSupply = 10 ** 6;

```
([205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L205-L205),[206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L206-L206),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L207-L207),[208](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L208-L208),[234](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L234-L234))
```solidity
File: contracts/PanopticPool.sol

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1769:                 totalLiquidity) / 2 ** 64;

1771:                 totalLiquidity) / 2 ** 64;

1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

```
([165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L165-L165),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L165-L165),[1348](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1348-L1348),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1353-L1353),[1487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1487-L1487),[1552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1552-L1552),[1561](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1561-L1561),[1635](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1635-L1635),[1636](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1636-L1636),[1769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1769-L1769),[1771](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1771-L1771),[1942](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1942-L1942),[1959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1959-L1959))
```solidity
File: contracts/SemiFungiblePositionManager.sol

388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

1352:                     totalLiquidity * 2 ** 64,

1353:                     netLiquidity ** 2

1357:                     totalLiquidity * 2 ** 64,

1358:                     netLiquidity ** 2

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1388:                     uint256 numerator = totalLiquidity ** 2 -

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

1394:                         .mulDiv(premium0X64_base, numerator, totalLiquidity ** 2)

1397:                         .mulDiv(premium1X64_base, numerator, totalLiquidity ** 2)

```
([388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L388-L388),[1352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1352-L1352),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1353-L1353),[1357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1357-L1357),[1358](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1358-L1358),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1367-L1367),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1388-L1388),[1391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1391-L1391),[1391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1391-L1391),[1394](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1394-L1394),[1397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1397-L1397))
```solidity
File: contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

484:             require(2 ** 64 > prod1);

511:             prod0 |= prod1 * 2 ** 192;

547:             require(2 ** 96 > prod1);

574:             prod0 |= prod1 * 2 ** 160;

587:             if (mulmod(a, b, 2 ** 96) > 0) {

624:             require(2 ** 128 > prod1);

651:             prod0 |= prod1 * 2 ** 128;

664:             if (mulmod(a, b, 2 ** 128) > 0) {

701:             require(2 ** 192 > prod1);

728:             prod0 |= prod1 * 2 ** 64;

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L484-L484),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L511-L511),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L547-L547),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L574-L574),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L587-L587),[624](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L624-L624),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L651-L651),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L664-L664),[701](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L701-L701),[728](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L728-L728))
```solidity
File: contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

530:                     .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

560:                         2 ** 128,

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23),[23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23),[495](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L495-L495),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[514](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L514-L514),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L530-L530),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L560-L560),[685](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L685-L685))
```solidity
File: contracts/types/TokenId.sol

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

376:             if (optionRatios < 2 ** 64) {

378:             } else if (optionRatios < 2 ** 112) {

380:             } else if (optionRatios < 2 ** 160) {

382:             } else if (optionRatios < 2 ** 208) {

439:         if (optionRatios < 2 ** 64) {

441:         } else if (optionRatios < 2 ** 112) {

443:         } else if (optionRatios < 2 ** 160) {

445:         } else if (optionRatios < 2 ** 208) {

```
([98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L98-L98),[376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L376-L376),[378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L378-L378),[380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L380-L380),[382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L382-L382),[439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L439-L439),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L441-L441),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L443-L443),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L445-L445))
### <a name="NC-16"></a>[NC-16] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function

*There are 3 Instances of this issue* :
```solidity
File: contracts/libraries/Math.sol

448:                 require(result < type(uint256).max);

588:                 require(result < type(uint256).max);

665:                 require(result < type(uint256).max);

```
([448](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L448-L448),[588](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L588-L588),[665](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L665-L665))
### <a name="NC-17"></a>[NC-17] Consider moving duplicated strings to constants

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit 'po' duplicated on line 70
70:     string internal constant TICKER_PREFIX = "po";

// @audit 'POPT-V1' duplicated on line 73
73:     string internal constant NAME_PREFIX = "POPT-V1";

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L73-L73))
```solidity
File: contracts/libraries/InteractionHelper.sol

// @audit '???' duplicated on line 63,100
68:             symbol1 = "???";

// @audit ' ' duplicated on line 74
80:                     " ",

```
([68](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L68-L68),[80](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L80-L80))
### <a name="NC-18"></a>[NC-18] else block is not required
Consider moving the logic outside the else block, and then removing it (it's not required, as the function is returning a value). There will be one less level of nesting, which will improve the quality of the codebase.

*There are 31 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

964:         else {
                 _transferFrom(delegatee, delegator, shares);
             }

978:         } else {
                 unchecked {
                     _transferFrom(refundee, refunder, convertToShares(uint256(-assets)));
                 }
             }

1351:                 } else {
                          int24 strike = tokenId.strike(index);
                          // if position is ITM or ATM, then the collateral requirement depends on price:
      
                          // compute the ratio of strike to price for calls (or price to strike for puts)
                          // (- and * 2 in tick space are / and ^ 2 in price space so sqrtRatioAtTick(2 *(a - b)) = a/b (*2^96)
                          // both of these ratios decrease as the position becomes deeper ITM, and it is possible
                          // for the ratio of the prices to go under the minimum price
                          // (which is the limit of what getSqrtRatioAtTick supports)
                          // so instead we cap it at the minimum price, which is acceptable because
                          // a higher ratio will result in an increased slope for the collateral requirement
                          uint160 ratio = tokenType == 1 // tokenType
                              ? Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)
                              ) // puts ->  price/strike
                              : Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)
                              ); // calls -> strike/price
      
                          // compute the collateral requirement depending on whether the position is ITM & out-of-range or ITM and in-range:
      
                          /// ITM and out-of-range
                          if (
                              ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
                              ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
                          ) {
                              /**
                                          Short put BPR = 100% - (price/strike) + SCR
      
                                 BUYING
                                 POWER
                                 REQUIREMENT
                               
                                               ^               .         .
                                               |        <- ITM . <-ATM-> . OTM ->
                                 100% + SCR% - |--__           .    .    .
                                        100% - | . .¯¯--__     .    .    .
                                               |    .     ¯¯--__    .    .
                                         SCR - |    .          .¯¯--__________
                                               |    .          .    .    .
                                               +----+----------+----+----+--->   current
                                               0   Liqui-     Pa  strike Pb       price
                                                   dation
                                                   price = SCR*strike                                         
                               */
      
                              uint256 c2 = Constants.FP96 - ratio;
      
                              // compute the tokens required
                              // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
                              required += Math.mulDiv96RoundingUp(amountMoved, c2);
                          } else {
                              // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
                              // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
                              // the collateral requirement when in-range, which always over-estimates the amount of token required
                              // Specifically:
                              //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
                              uint160 scaleFactor = Math.getSqrtRatioAtTick(
                                  (tickUpper - strike) + (strike - tickLower)
                              );
                              uint256 c3 = Math.mulDivRoundingUp(
                                  amountMoved,
                                  scaleFactor - ratio,
                                  scaleFactor + Constants.FP96
                              );
                              // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
                              required += c3;
                          }
                      }

1402:                     } else {
                              // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
                              // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
                              // the collateral requirement when in-range, which always over-estimates the amount of token required
                              // Specifically:
                              //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
                              uint160 scaleFactor = Math.getSqrtRatioAtTick(
                                  (tickUpper - strike) + (strike - tickLower)
                              );
                              uint256 c3 = Math.mulDivRoundingUp(
                                  amountMoved,
                                  scaleFactor - ratio,
                                  scaleFactor + Constants.FP96
                              );
                              // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
                              required += c3;
                          }

1461:         } else {
                  required = _computeStrangle(tokenId, index, positionSize, atTick, poolUtilization);
              }

1548:                 } else {
                          spreadRequirement = movedLeft < movedPartnerLeft
                              ? movedPartnerLeft - movedLeft
                              : movedLeft - movedPartnerLeft;
                      }

1554:         } else {
                  unchecked {
                      uint256 notional;
                      uint256 notionalP;
                      uint128 contracts;
                      if (tokenType == 1) {
                          notional = movedRight;
                          notionalP = movedPartnerRight;
                          contracts = movedLeft;
                      } else {
                          notional = movedLeft;
                          notionalP = movedPartnerLeft;
                          contracts = movedRight;
                      }
                      // the required amount is the amount of contracts multiplied by (notional1 - notional2)/min(notional1, notional2)
                      // can use unsafe because denominator is always nonzero
                      spreadRequirement = (notional < notionalP)
                          ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)
                          : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);
                  }
              }

1563:                 } else {
                          notional = movedLeft;
                          notionalP = movedPartnerLeft;
                          contracts = movedRight;
                      }

```
([964](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L964-L966),[978](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L978-L982),[1351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1351-L1419),[1402](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1402-L1418),[1461](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1461-L1463),[1548](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1548-L1552),[1554](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1554-L1574),[1563](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1563-L1567))
```solidity
File: contracts/PanopticFactory.sol

363:             } else {
                     // Find the resulting liquidity for providing 1e6 of both tokens
                     uint128 liquidity0 = uint128(
                         Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN, currentSqrtPriceX96)
                     );
                     uint128 liquidity1 = uint128(
                         Math.mulDivRoundingUp(
                             FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN,
                             Constants.FP96,
                             currentSqrtPriceX96
                         )
                     );
     
                     // Pick the greater of the liquidities - i.e the more "expensive" option
                     // This ensures that the liquidity added is sufficiently large
                     fullRangeLiquidity = liquidity0 > liquidity1 ? liquidity0 : liquidity1;
                 }

```
([363](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L363-L379))
```solidity
File: contracts/PanopticPool.sol

479:                 } else {
                         portfolioPremium = portfolioPremium.add(premiaByLeg[leg]);
                     }

922:         } else {
                 (slowOracleTick, medianData) = PanopticMath.computeInternalMedian(
                     observationIndex,
                     observationCardinality,
                     MEDIAN_PERIOD,
                     s_miniMedian,
                     _univ3pool
                 );
             }

1876:                 } else {
                          uint256 positionLiquidity = PanopticMath
                              .getLiquidityChunk(tokenId, leg, positionSize)
                              .liquidity();
      
                          // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (T - R)
                          uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
                          // T (totalLiquidity is (T - R) after burning)
                          uint256 totalLiquidityBefore = totalLiquidity + positionLiquidity;
      
                          LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
      
                          LeftRightUnsigned availablePremium = _getAvailablePremium(
                              totalLiquidity + positionLiquidity,
                              settledTokens,
                              grossPremiumLast,
                              LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
                              premiumAccumulatorsByLeg[leg]
                          );
      
                          // subtract settled tokens sent to seller
                          settledTokens = settledTokens.sub(availablePremium);
      
                          // add available premium to amount that should be settled
                          realizedPremia = realizedPremia.add(
                              LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
                          );
      
                          // We need to adjust the grossPremiumLast value such that the result of
                          // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostBurn/2**64 is equal to
                          // (grossPremium - grossPremiumLast)*totalLiquidityBeforeBurn/2**64 - premiumOwedToPosition
                          // G: total gross premium (- premiumOwedToPosition)
                          // T: totalLiquidityBeforeMint
                          // R: positionLiquidity
                          // C: current grossPremium value
                          // L: current grossPremiumLast value
                          // Ln: updated grossPremiumLast value
                          // T * (C - L) = G
                          // (T - R) * (C - Ln) = G - P
                          //
                          // T * (C - L) = (T - R) * (C - Ln) + P
                          // (TC - TL - P) / (T - R) = C - Ln
                          // Ln = C - (TC - TL - P) / (T - R)
                          // Ln = (TC - CR - TC + LT + P) / (T-R)
                          // Ln = (LT - CR + P) / (T-R)
      
                          unchecked {
                              uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;
                              uint256 _leg = leg;
      
                              // if there's still liquidity, compute the new grossPremiumLast
                              // otherwise, we just reset grossPremiumLast to the current grossPremium
                              s_grossPremiumLast[chunkKey] = totalLiquidity != 0
                                  ? LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.rightSlot() * 2 ** 64),
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                      .toLeftSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.leftSlot()) * 2 ** 64,
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                  : LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
                                      .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));
                          }
                      }

```
([479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L479-L481),[922](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L922-L930),[1876](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1876-L1970))
```solidity
File: contracts/SemiFungiblePositionManager.sol

826:             } else {
                     zeroForOne = itm1 > 0;
                     swapAmount = -itm1;
                 }

1009:             } else {
                      // the _leg is long (buying: moving *from* uniswap to msg.sender)
                      // so we seek to move the incoming liquidity chunk *out* of uniswap - but was there sufficient liquidity sitting in uniswap
                      // in the first place?
                      if (startingLiquidity < chunkLiquidity) {
                          // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
                          // what the account that owns the liquidity in uniswap has (startingLiquidity)
                          // we must ensure that an account can only move its own liquidity out of uniswap
                          // so we revert in this case
                          revert Errors.NotEnoughLiquidity();
                      } else {
                          // startingLiquidity is >= chunkLiquidity, so no possible underflow
                          unchecked {
                              // we want to move less than what already sits in uniswap, no problem:
                              updatedLiquidity = startingLiquidity - chunkLiquidity;
                          }
                      }
      
                      /// @dev If the isLong flag is 1=long and the position is minted, then this is opening a long position
                      /// @dev so the amount of removed liquidity should increase.
                      if (!isBurn) {
                          // we can't remove more liquidity than we add in the first place, so this can't overflow
                          unchecked {
                              removedLiquidity += chunkLiquidity;
                          }
                      }
                  }

1019:                 } else {
                          // startingLiquidity is >= chunkLiquidity, so no possible underflow
                          unchecked {
                              // we want to move less than what already sits in uniswap, no problem:
                              updatedLiquidity = startingLiquidity - chunkLiquidity;
                          }
                      }

1516:         } else {
                  // Extract the account liquidity for a given uniswap pool, owner, token type, and ticks
                  acctPremia = isLong == 1
                      ? s_accountPremiumOwed[positionKey]
                      : s_accountPremiumGross[positionKey];
              }

```
([826](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L826-L829),[1009](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1009-L1035),[1019](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1019-L1025),[1516](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1516-L1521))
```solidity
File: contracts/libraries/FeesCalc.sol

72:                 } else {
                        unchecked {
                            value0 -= int256(amount0);
                            value1 -= int256(amount1);
                        }
                    }

185:             } else {
                     /**
                       current AMM tick is within the option position range (within the chunk)
     
                          liquidity
                             ▲        feeGrowthGlobal0X128 = global fee growth
                             │                             = (all fees collected for the entire price range for token 0)
                             │
                             │                        
                             │     lowerOut0  ┌──────────────┐ upperOut0
                             │◄─^v───────────►│              │◄─────^v───►
                             │                │     chunk    │
                             │                │              │
                             └────────────────┴───────▲──────┴─────► price tick
                                              L       │      U
                                                      │
                                                   current
                                                    tick
                     */
                     feeGrowthInside0X128 = univ3pool.feeGrowthGlobal0X128() - lowerOut0 - upperOut0;
                     feeGrowthInside1X128 = univ3pool.feeGrowthGlobal1X128() - lowerOut1 - upperOut1;
                 }

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L72-L77),[185](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L185-L206))
```solidity
File: contracts/libraries/Math.sol

229:         } else {
                 amount0 = getAmount0ForLiquidity(liquidityChunk.updateTickLower(currentTick));
                 amount1 = getAmount1ForLiquidity(liquidityChunk.updateTickUpper(currentTick));
             }

```
([229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L229-L232))
```solidity
File: contracts/libraries/PanopticMath.sol

327:         } else {
                 return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);
             }

430:         } else {
                 return (
                     tokenData1.rightSlot() + convert0to1(tokenData0.rightSlot(), sqrtPriceX96),
                     tokenData1.leftSlot() + convert0to1(tokenData0.leftSlot(), sqrtPriceX96)
                 );
             }

496:             } else {
                     return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                 }

513:             } else {
                     return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                 }

533:             } else {
                     int256 absResult = Math
                         .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 }

556:             } else {
                     int256 absResult = Math
                         .mulDiv(
                             Math.absUint(amount),
                             2 ** 128,
                             Math.mulDiv64(sqrtPriceX96, sqrtPriceX96)
                         )
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 }

590:         } else {
                 amount1 = positionSize * uint128(tokenId.optionRatio(legIndex));
     
                 amount0 = Math
                     .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))
                     .toUint128();
             }

622:             } else {
                     // is option is long, increment longs by contracts
                     longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                 }

626:         } else {
                 if (isShort) {
                     // if option is short, increment shorts by notional
                     shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 } else {
                     // if option is long, increment longs by notional
                     longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 }
             }

630:             } else {
                     // if option is long, increment longs by notional
                     longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 }

845:             } else {
                     // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
                     haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
                     haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
     
                     collateralDelta0 = 0;
                     collateralDelta1 = 0;
                 }

```
([327](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L327-L329),[430](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L430-L435),[496](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L496-L498),[513](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L513-L515),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L533-L538),[556](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L556-L565),[590](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L590-L596),[622](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L622-L625),[626](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L626-L634),[630](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L630-L633),[845](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L845-L852))
```solidity
File: contracts/types/TokenId.sol

384:             } else {
                     optionRatios = 4;
                 }

```
([384](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L384-L386))
### <a name="NC-19"></a>[NC-19] Consider adding emergency-stop functionality
Adding a way to quickly halt protocol functionality in an emergency, rather than having to pause individual contracts one-by-one, will make in-progress hack mitigation faster and much less stressful.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L12))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L7))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

39: library FeesCalc {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L39))
```solidity
File: contracts/libraries/InteractionHelper.sol

17: library InteractionHelper {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L17))
```solidity
File: contracts/libraries/Math.sol

13: library Math {

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L13))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L11))
```solidity
File: contracts/multicall/Multicall.sol

8: abstract contract Multicall {

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L8))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L17))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L52))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L60))
### <a name="NC-20"></a>[NC-20] Consider emitting an event at the end of the constructor
This will allow users to easily exactly pinpoint when and by whom a contract was constructed

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

178:     constructor(
             uint256 _commissionFee,
             uint256 _sellerCollateralRatio,
             uint256 _buyerCollateralRatio,
             int256 _forceExerciseCost,
             uint256 _targetPoolUtilization,
             uint256 _saturatedPoolUtilization,
             uint256 _ITMSpreadMultiplier
         ) {
             COMMISSION_FEE = _commissionFee;
             SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;
             BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;
             FORCE_EXERCISE_COST = _forceExerciseCost;
             TARGET_POOL_UTIL = _targetPoolUtilization;
             SATURATED_POOL_UTIL = _saturatedPoolUtilization;
             ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;
     
             // calculate amount of ticks required for upwards and downwards moves, used to check if current and mini-median tick
             // are out of sync (then apply a 100% collateral requirement)
             unchecked {
                 // taylor expand log(1-sellCollateralRatio)/log(1.0001) around sellCollateralRatio=2000 up to 3rd order
                 /// since we're dropping the higher order terms, which are all negative, this will underestimate the number of ticks for a 20% move
                 int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);
                 TICK_DEVIATION = uint256(
                     2230 +
                         (12500 * ratioTick) /
                         10_000 +
                         (7812 * ratioTick ** 2) /
                         10_000 ** 2 +
                         (6510 * ratioTick ** 3) /
                         10_000 ** 3
                 );
             }
         }

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L178-L211))
```solidity
File: contracts/PanopticFactory.sol

115:     constructor(
             address _WETH9,
             SemiFungiblePositionManager _SFPM,
             IUniswapV3Factory _univ3Factory,
             IDonorNFT _donorNFT,
             address _poolReference,
             address _collateralReference
         ) {
             WETH = _WETH9;
             SFPM = _SFPM;
             DONOR_NFT = _donorNFT;
             // We store the Uniswap Factory contract - later we can use this to verify uniswap pools
             UNIV3_FACTORY = _univ3Factory;
             POOL_REFERENCE = _poolReference;
             COLLATERAL_REFERENCE = _collateralReference;
         }

```
([115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L115-L130))
```solidity
File: contracts/PanopticPool.sol

280:     constructor(SemiFungiblePositionManager _sfpm) {
             SFPM = _sfpm;
         }

```
([280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L280-L282))
```solidity
File: contracts/SemiFungiblePositionManager.sol

341:     constructor(IUniswapV3Factory _factory) {
             FACTORY = _factory;
         }

```
([341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L341-L343))
### <a name="NC-21"></a>[NC-21] Unused `error` definition
Note that there may be cases where an error superficially appears to be used, but this is only because there are multiple definitions of the error in different files. In such cases, the error definition should be moved into a separate file. The instances below are the unused definitions.

*There are 33 Instances of this issue* :
```solidity
File: contracts/libraries/Errors.sol

10:     error CastingError();

13:     error CollateralTokenAlreadyInitialized();

16:     error DepositTooLarge();

20:     error EffectiveLiquidityAboveThreshold();

23:     error ExceedsMaximumRedemption();

26:     error ExerciseeNotSolvent();

29:     error InputListFail();

32:     error InvalidSalt();

35:     error InvalidTick();

38:     error InvalidNotionalValue();

42:     error InvalidTokenIdParameter(uint256 parameterType);

45:     error InvalidUniswapCallback();

48:     error LeftRightInputError();

51:     error NoLegsExercisable();

54:     error NotEnoughCollateral();

57:     error PositionTooLarge();

60:     error NotALongLeg();

63:     error NotEnoughLiquidity();

66:     error NotMarginCalled();

70:     error NotOwner();

73:     error NotPanopticPool();

76:     error OptionsBalanceZero();

79:     error PoolAlreadyInitialized();

82:     error PositionAlreadyMinted();

85:     error PositionCountNotZero();

88:     error PriceBoundFail();

91:     error ReentrantCall();

95:     error StaleTWAP();

98:     error TooManyPositionsOpen();

101:     error TransferFailed();

105:     error TicksNotInitializable();

108:     error UnderOverFlow();

111:     error UniswapPoolNotInitialized();

```
([10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L10-L10),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L13-L13),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L16-L16),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L20-L20),[23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L23-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L26-L26),[29](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L29-L29),[32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L32-L32),[35](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L35-L35),[38](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L38-L38),[42](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L42-L42),[45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L45-L45),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L48-L48),[51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L51-L51),[54](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L54-L54),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L57-L57),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L60-L60),[63](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L63-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L66-L66),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L73-L73),[76](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L76-L76),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L79-L79),[82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L82-L82),[85](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L85-L85),[88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L88-L88),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L91-L91),[95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L95-L95),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L98-L98),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L101-L101),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L105-L105),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L108-L108),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L111-L111))
### <a name="NC-22"></a>[NC-22] Events are missing sender information
When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the `msg.sender` the events of these types of action will make events much more useful to end users, especially when `msg.sender` is not `tx.origin`.

*There are 9 Instances of this issue* :
```solidity
File: contracts/PanopticFactory.sol

154:         emit OwnershipTransferred(currentOwner, newOwner);

268:         emit PoolDeployed(
                 newPoolContract,
                 v3Pool,
                 collateralTracker0,
                 collateralTracker1,
                 amount0,
                 amount1
             );

```
([154](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L154-L154),[268](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L268-L275))
```solidity
File: contracts/PanopticPool.sol

853:         emit OptionBurnt(owner, positionSize, tokenId, premiaOwed);

1654:             emit PremiumSettled(owner, tokenId, realizedPremia);

```
([853](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L853-L853),[1654](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1654-L1654))
```solidity
File: contracts/SemiFungiblePositionManager.sol

390:         emit PoolInitialized(univ3pool, poolId);

```
([390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L390-L390))
```solidity
File: contracts/tokens/ERC20Minimal.sol

94:         emit Transfer(from, to, amount);

112:         emit Transfer(from, to, amount);

130:         emit Transfer(address(0), to, amount);

145:         emit Transfer(from, address(0), amount);

```
([94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L94-L94),[112](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L112-L112),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L130-L130),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L145-L145))
### <a name="NC-23"></a>[NC-23] Events that mark critical parameter changes should contain both the old and the new value
This should especially be done if the new value is not required to be different from the old value

*There are 2 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

1587:     function settleLongPremium(
              TokenId[] calldata positionIdList,
              address owner,
              uint256 legIndex
          ) external {
              _validatePositionList(owner, positionIdList, 0);
      
              TokenId tokenId = positionIdList[positionIdList.length - 1];
      
              if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();
      
              (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
      
              LeftRightUnsigned accumulatedPremium;
              {
                  (int24 tickLower, int24 tickUpper) = tokenId.asTicks(legIndex);
      
                  uint256 tokenType = tokenId.tokenType(legIndex);
                  (uint128 premiumAccumulator0, uint128 premiumAccumulator1) = SFPM.getAccountPremium(
                      address(s_univ3pool),
                      address(this),
                      tokenType,
                      tickLower,
                      tickUpper,
                      currentTick,
                      1
                  );
                  accumulatedPremium = LeftRightUnsigned
                      .wrap(0)
                      .toRightSlot(premiumAccumulator0)
                      .toLeftSlot(premiumAccumulator1);
      
                  // update the premium accumulator for the long position to the latest value
                  // (the entire premia delta will be settled)
                  LeftRightUnsigned premiumAccumulatorsLast = s_options[owner][tokenId][legIndex];
                  s_options[owner][tokenId][legIndex] = accumulatedPremium;
      
                  accumulatedPremium = accumulatedPremium.sub(premiumAccumulatorsLast);
              }
      
              uint256 liquidity = PanopticMath
                  .getLiquidityChunk(tokenId, legIndex, s_positionBalance[owner][tokenId].rightSlot())
                  .liquidity();
      
              unchecked {
                  // update the realized premia
                  LeftRightSigned realizedPremia = LeftRightSigned
                      .wrap(0)
                      .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))
                      .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));
      
                  // deduct the paid premium tokens from the owner's balance and add them to the cumulative settled token delta
                  s_collateralToken0.exercise(owner, 0, 0, 0, realizedPremia.rightSlot());
                  s_collateralToken1.exercise(owner, 0, 0, 0, realizedPremia.leftSlot());
      
                  bytes32 chunkKey = keccak256(
                      abi.encodePacked(
                          tokenId.strike(legIndex),
                          tokenId.width(legIndex),
                          tokenId.tokenType(legIndex)
                      )
                  );
                  // commit the delta in settled tokens (all of the premium paid by long chunks in the tokenIds list) to storage
                  s_settledTokens[chunkKey] = s_settledTokens[chunkKey].add(
                      LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(realizedPremia)))
                  );
      
                  emit PremiumSettled(owner, tokenId, realizedPremia);
              }
      
              // ensure the owner is solvent (insolvent accounts are not permitted to pay premium unless they are being liquidated)
              _validateSolvency(owner, positionIdList, NO_BUFFER);
          }

```
([1587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1587-L1659))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {
            isApprovedForAll[msg.sender][operator] = approved;
    
            emit ApprovalForAll(msg.sender, operator, approved);
        }

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L85))
### <a name="NC-24"></a>[NC-24] Floating pragma should be avoided
Locking the pragma helps avoid accidental deploys with an outdated compiler version that may introduce bugs and unexpected vulnerabilities.Floating pragma is meant to be used for libraries and contracts that have external users and need backward compatibility.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L2-L2))
```solidity
File: contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L2-L2))
```solidity
File: contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L2-L2))
```solidity
File: contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L2-L2))
```solidity
File: contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L2-L2))
```solidity
File: contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L2-L2))
```solidity
File: contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L2-L2))
```solidity
File: contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L2-L2))
```solidity
File: contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L2-L2))
```solidity
File: contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L2-L2))
```solidity
File: contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L2-L2))
```solidity
File: contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L2-L2))
```solidity
File: contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L2-L2))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L2-L2))
```solidity
File: contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L2-L2))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L2-L2))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L2-L2))
```solidity
File: contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L2-L2))
```solidity
File: contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L2-L2))
```solidity
File: contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L2-L2))
### <a name="NC-25"></a>[NC-25] For loops in public or external functions should be avoided due to high gas costs and possible DOS
For loops can potentially cause Denial of Service (DoS) attacks if not handled carefully. DoS attacks can occur when an attacker intentionally exploits the gas cost of a function, causing it to run out of gas or making it too expensive for other users to call. Below are some scenarios where for loops can lead to DoS attacks: Nested for loops can become exceptionally gas expensive and should be used sparingly

*There are 17 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

662:             for (uint256 leg = 0; leg < positionId.countLegs(); ++leg) {
                     // short legs are not counted - exercise is intended to be based on long legs
                     if (positionId.isLong(leg) == 0) continue;
     
                     {
                         int24 range = int24(
                             int256(
                                 Math.unsafeDivRoundingUp(
                                     uint24(positionId.width(leg) * positionId.tickSpacing()),
                                     2
                                 )
                             )
                         );
                         maxNumRangesFromStrike = Math.max(
                             maxNumRangesFromStrike,
                             uint256(Math.abs(currentTick - positionId.strike(leg)) / range)
                         );
                     }
     
                     uint256 currentValue0;
                     uint256 currentValue1;
                     uint256 oracleValue0;
                     uint256 oracleValue1;
     
                     {
                         LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                             positionId,
                             leg,
                             positionBalance
                         );
     
                         (currentValue0, currentValue1) = Math.getAmountsForLiquidity(
                             currentTick,
                             liquidityChunk
                         );
     
                         (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(
                             oracleTick,
                             liquidityChunk
                         );
                     }
     
                     uint256 tokenType = positionId.tokenType(leg);
                     // compensate user for loss in value if chunk has lost money between current and median tick
                     // note: the delta for one token will be positive and the other will be negative. This cancels out any moves in their positions
                     if (
                         (tokenType == 0 && currentValue1 < oracleValue1) ||
                         (tokenType == 1 && currentValue0 < oracleValue0)
                     )
                         exerciseFees = exerciseFees.sub(
                             LeftRightSigned
                                 .wrap(0)
                                 .toRightSlot(
                                     int128(uint128(oracleValue0)) - int128(uint128(currentValue0))
                                 )
                                 .toLeftSlot(
                                     int128(uint128(oracleValue1)) - int128(uint128(currentValue1))
                                 )
                         );
                 }

```
([662](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L662-L721))
```solidity
File: contracts/PanopticFactory.sol

303:         for (; uint256(salt) < maxSalt; ) {
                 uint256 rarity = PanopticMath.numberOfLeadingHexZeros(
                     POOL_REFERENCE.predictDeterministicAddress(salt)
                 );
     
                 if (rarity > highestRarity) {
                     // found a more rare address at this nonce
                     highestRarity = rarity;
                     bestSalt = salt;
                 }
     
                 if (rarity >= minTargetRarity) {
                     // desired target met
                     highestRarity = rarity;
                     bestSalt = salt;
                     break;
                 }
     
                 unchecked {
                     // increment the nonce of `currentSalt` (lower 96 bits)
                     salt = bytes32(uint256(salt) + 1);
                 }
             }

```
([303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L303-L325))
```solidity
File: contracts/SemiFungiblePositionManager.sol

575:         for (uint256 i = 0; i < ids.length; ) {
                 if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();
                 registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);
                 unchecked {
                     ++i;
                 }
             }

```
([575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L575-L581))
```solidity
File: contracts/libraries/FeesCalc.sol

51:         for (uint256 k = 0; k < positionIdList.length; ) {
                TokenId tokenId = positionIdList[k];
                uint128 positionSize = userBalance[tokenId].rightSlot();
                uint256 numLegs = tokenId.countLegs();
                for (uint256 leg = 0; leg < numLegs; ) {
                    LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                        tokenId,
                        leg,
                        positionSize
                    );
    
                    (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(
                        atTick,
                        liquidityChunk
                    );
    
                    if (tokenId.isLong(leg) == 0) {
                        unchecked {
                            value0 += int256(amount0);
                            value1 += int256(amount1);
                        }
                    } else {
                        unchecked {
                            value0 -= int256(amount0);
                            value1 -= int256(amount1);
                        }
                    }
    
                    unchecked {
                        ++leg;
                    }
                }
                unchecked {
                    ++k;
                }
            }

55:             for (uint256 leg = 0; leg < numLegs; ) {
                    LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                        tokenId,
                        leg,
                        positionSize
                    );
    
                    (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(
                        atTick,
                        liquidityChunk
                    );
    
                    if (tokenId.isLong(leg) == 0) {
                        unchecked {
                            value0 += int256(amount0);
                            value1 += int256(amount1);
                        }
                    } else {
                        unchecked {
                            value0 -= int256(amount0);
                            value1 -= int256(amount1);
                        }
                    }
    
                    unchecked {
                        ++leg;
                    }
                }

```
([51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L51-L86),[55](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L55-L82))
```solidity
File: contracts/libraries/PanopticMath.sol

137:             for (uint256 i = 0; i < cardinality + 1; ++i) {
                     (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
                         uint256(
                             (int256(observationIndex) - int256(i * period)) +
                                 int256(observationCardinality)
                         ) % observationCardinality
                     );
                 }

148:             for (uint256 i = 0; i < cardinality; ++i) {
                     ticks[i] =
                         (tickCumulatives[i] - tickCumulatives[i + 1]) /
                         int256(timestamps[i] - timestamps[i + 1]);
                 }

207:                 for (uint8 i; i < 8; ++i) {
                         // read the rank from the existing ordering
                         rank = (orderMap >> (3 * i)) % 8;
     
                         if (rank == 7) {
                             shift -= 1;
                             continue;
                         }
     
                         // read the corresponding entry
                         entry = int24(uint24(medianData >> (rank * 24)));
                         if ((below) && (lastObservedTick > entry)) {
                             shift += 1;
                             below = false;
                         }
     
                         newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));
                     }

248:             for (uint256 i = 0; i < 20; ++i) {
                     secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);
                 }

256:             for (uint256 i = 0; i < 19; ++i) {
                     twapMeasurement[i] = int24(
                         (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))
                     );
                 }

781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
                     TokenId tokenId = positionIdList[i];
                     uint256 numLegs = tokenId.countLegs();
                     for (uint256 leg = 0; leg < numLegs; ++leg) {
                         if (tokenId.isLong(leg) == 1) {
                             longPremium = longPremium.sub(premiasByLeg[i][leg]);
                         }
                     }
                 }

784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
                         if (tokenId.isLong(leg) == 1) {
                             longPremium = longPremium.sub(premiasByLeg[i][leg]);
                         }
                     }

860:             for (uint256 i = 0; i < positionIdList.length; i++) {
                     TokenId tokenId = positionIdList[i];
                     LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
                     for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
                         if (tokenId.isLong(leg) == 1) {
                             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
                                 storage _settledTokens = settledTokens;
     
                             // calculate amounts to revoke from settled and subtract from haircut req
                             uint256 settled0 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
                                 uint128(longPremium.rightSlot())
                             );
                             uint256 settled1 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
                                 uint128(longPremium.leftSlot())
                             );
     
                             bytes32 chunkKey = keccak256(
                                 abi.encodePacked(
                                     tokenId.strike(0),
                                     tokenId.width(0),
                                     tokenId.tokenType(0)
                                 )
                             );
     
                             // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
                             // for the haircut directly to the accumulator
                             settled0 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
                             );
                             settled1 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
                             );
     
                             _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
                                 LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
                                     uint128(settled1)
                                 )
                             );
                         }
                     }
                 }

863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
                         if (tokenId.isLong(leg) == 1) {
                             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
                                 storage _settledTokens = settledTokens;
     
                             // calculate amounts to revoke from settled and subtract from haircut req
                             uint256 settled0 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
                                 uint128(longPremium.rightSlot())
                             );
                             uint256 settled1 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
                                 uint128(longPremium.leftSlot())
                             );
     
                             bytes32 chunkKey = keccak256(
                                 abi.encodePacked(
                                     tokenId.strike(0),
                                     tokenId.width(0),
                                     tokenId.tokenType(0)
                                 )
                             );
     
                             // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
                             // for the haircut directly to the accumulator
                             settled0 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
                             );
                             settled1 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
                             );
     
                             _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
                                 LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
                                     uint128(settled1)
                                 )
                             );
                         }
                     }

```
([137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L137-L144),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L148-L152),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L207-L224),[248](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L248-L250),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L256-L260),[781](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L781-L789),[784](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L784-L788),[860](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L860-L904),[863](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L863-L903))
```solidity
File: contracts/multicall/Multicall.sol

14:         for (uint256 i = 0; i < data.length; ) {
                (bool success, bytes memory result) = address(this).delegatecall(data[i]);
    
                if (!success) {
                    // Bubble up the revert reason
                    // The bytes type is ABI encoded as a length-prefixed byte array
                    // So we simply need to add 32 to the pointer to get the start of the data
                    // And then revert with the size loaded from the first 32 bytes
                    // Other solutions will do work to differentiate the revert reasons and provide paranthetical information
                    // However, we have chosen to simply replicate the the normal behavior of the call
                    // NOTE: memory-safe because it reads from memory already allocated by solidity (the bytes memory result)
                    assembly ("memory-safe") {
                        revert(add(result, 32), mload(result))
                    }
                }
    
                results[i] = result;
    
                unchecked {
                    ++i;
                }
            }

```
([14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L14-L35))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

143:         for (uint256 i = 0; i < ids.length; ) {
                 id = ids[i];
                 amount = amounts[i];
     
                 balanceOf[from][id] -= amount;
     
                 // balance will never overflow
                 unchecked {
                     balanceOf[to][id] += amount;
                 }
     
                 // An array can't have a total length
                 // larger than the max uint256 value.
                 unchecked {
                     ++i;
                 }
             }

187:             for (uint256 i = 0; i < owners.length; ++i) {
                     balances[i] = balanceOf[owners[i]][ids[i]];
                 }

```
([143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L143-L159),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L187-L189))
### <a name="NC-26"></a>[NC-26] Consider adding formal verification proofs
Consider using formal verification to mathematically prove that your code does what is intended, and does not have any edge cases with unexpected behavior. The solidity compiler itself has this functionality [built in](https://docs.soliditylang.org/en/latest/smtchecker.html#smtchecker-and-formal-verification)

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {
        /// @notice Defining characteristics of a Uni V3 pool
        struct PoolFeatures {
            address token0;
            address token1;
            uint24 fee;
        }
    
        /// @notice Data sent by pool in mint/swap callbacks used to validate the pool and send back requisite tokens
        struct CallbackData {
            PoolFeatures poolFeatures;
            address payer;
        }
    
        /// @notice Verifies that a callback came from the canonical Uniswap pool with a claimed set of features.
        /// @param sender The address initiating the callback and claiming to be a Uniswap pool
        /// @param factory The address of the canonical Uniswap V3 factory
        /// @param features The features `sender` claims to contain (tokens and fee)
        function validateCallback(
            address sender,
            IUniswapV3Factory factory,
            PoolFeatures memory features
        ) internal view {
            // Call getPool on the factory to verify that the sender corresponds to the canonical pool with the claimed features
            if (factory.getPool(features.token0, features.token1, features.fee) != sender)
                revert Errors.InvalidUniswapCallback();
        }
    }

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L39))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {
       /// @notice Fixed point multiplier: 2**96
       uint256 internal constant FP96 = 0x1000000000000000000000000;
   
       /// @notice Minimum possible price tick in a Uniswap V3 pool
       int24 internal constant MIN_V3POOL_TICK = -887272;
   
       /// @notice Maximum possible price tick in a Uniswap V3 pool
       int24 internal constant MAX_V3POOL_TICK = 887272;
   
       /// @notice Minimum possible sqrtPriceX96 in a Uniswap V3 pool
       uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;
   
       /// @notice Maximum possible sqrtPriceX96 in a Uniswap V3 pool
       uint160 internal constant MAX_V3POOL_SQRT_RATIO =
           1461446703485210103287273052203988822378723970342;
   }

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L23))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {
       /// @notice Casting error
       /// @dev e.g. uint128(uint256(a)) fails
       error CastingError();
   
       /// @notice CollateralTracker: collateral token has already been initialized
       error CollateralTokenAlreadyInitialized();
   
       /// @notice CollateralTracker: the amount of shares (or assets) deposited is larger than the maximum permitted
       error DepositTooLarge();
   
       /// @notice PanopticPool: the effective liquidity (X32) is greater than min(`MAX_SPREAD`, `USER_PROVIDED_THRESHOLD`) during a long mint or short burn
       /// Effective liquidity measures how much new liquidity is minted relative to how much is already in the pool
       error EffectiveLiquidityAboveThreshold();
   
       /// @notice CollateralTracker: attempted to withdraw/redeem more than available liquidity, owned shares, or open positions would allow for
       error ExceedsMaximumRedemption();
   
       /// @notice PanopticPool: force exercisee is insolvent - liquidatable accounts are not permitted to open or close positions outside of a liquidation
       error ExerciseeNotSolvent();
   
       /// @notice PanopticPool: the provided list of option positions is incorrect or invalid
       error InputListFail();
   
       /// @notice PanopticFactory: irst 20 bytes of provided salt does not match caller address
       error InvalidSalt();
   
       /// @notice Tick is not between `MIN_TICK` and `MAX_TICK`
       error InvalidTick();
   
       /// @notice The result of a notional value conversion is too small (=0) or too large (>2^128-1)
       error InvalidNotionalValue();
   
       /// @notice Invalid TokenId parameter detected
       /// @param parameterType poolId=0, ratio=1, tokenType=2, risk_partner=3 , strike=4, width=5, two identical strike/width/tokenType chunks=6
       error InvalidTokenIdParameter(uint256 parameterType);
   
       /// @notice A mint or swap callback was attempted from an address that did not match the canonical Uniswap V3 pool with the claimed features
       error InvalidUniswapCallback();
   
       /// @notice Invalid input in LeftRight library.
       error LeftRightInputError();
   
       /// @notice PanopticPool: one of the legs in a position are force-exercisable (they are all either short or ITM long)
       error NoLegsExercisable();
   
       /// @notice PanopticPool: the account is not solvent enough to perform the desired action
       error NotEnoughCollateral();
   
       /// @notice SFPM: maximum token amounts for a position exceed 128 bits
       error PositionTooLarge();
   
       /// @notice PanopticPool: the leg is not long, so the premium cannot be settled through `settleLongPremium`
       error NotALongLeg();
   
       /// @notice PanopticPool: there is not enough avaiable liquidity to buy an option
       error NotEnoughLiquidity();
   
       /// @notice PanopticPool: position is still solvent and cannot be liquidated
       error NotMarginCalled();
   
       /// @notice Caller needs to be the owner
       /// @dev unauthorized access attempted
       error NotOwner();
   
       /// @notice CollateralTracker: the caller for a permissioned function is not the Panoptic Pool
       error NotPanopticPool();
   
       /// @notice Minting and burning in the SFPM must operate on >0 contracts
       error OptionsBalanceZero();
   
       /// @notice Uniswap pool has already been initialized in the SFPM or created in the factory
       error PoolAlreadyInitialized();
   
       /// @notice PanopticPool: Option position already minted
       error PositionAlreadyMinted();
   
       /// @notice CollateralTracker: The user has open/active option positions, so they cannot transfer collateral shares
       error PositionCountNotZero();
   
       /// @notice The current tick in the pool falls outside a user-defined open interval slippage range
       error PriceBoundFail();
   
       /// @notice SFPM: function has been called while reentrancy lock is active
       error ReentrantCall();
   
       /// @notice An oracle price is too far away from another oracle price or the current tick
       /// This is a safeguard against price manipulation during option mints, burns, and liquidations
       error StaleTWAP();
   
       /// @notice PanopticPool: too many positions open (above limit per account)
       error TooManyPositionsOpen();
   
       /// @notice ERC20 or SFPM token transfer did not complete successfully
       error TransferFailed();
   
       /// @notice The tick range given by the strike price and width is invalid
       /// because the upper and lower ticks are not multiples of `tickSpacing`
       error TicksNotInitializable();
   
       /// @notice An operation in a library has failed due to an underflow or overflow
       error UnderOverFlow();
   
       /// @notice The Uniswap Pool has not been created, so it cannot be used in the SFPM or factory
       error UniswapPoolNotInitialized();
   }

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L112))
```solidity
File: contracts/libraries/FeesCalc.sol

39: library FeesCalc {
        /// @notice Calculate NAV of user's option portfolio at a given tick.
        /// @param atTick The tick to calculate the value at
        /// @param userBalance The position balance array for the user (left=tokenId, right=positionSize)
        /// @param positionIdList A list of all positions the user holds on that pool
        /// @return value0 The amount of token0 owned by portfolio
        /// @return value1 The amount of token1 owned by portfolio
        function getPortfolioValue(
            int24 atTick,
            mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
            TokenId[] calldata positionIdList
        ) external view returns (int256 value0, int256 value1) {
            for (uint256 k = 0; k < positionIdList.length; ) {
                TokenId tokenId = positionIdList[k];
                uint128 positionSize = userBalance[tokenId].rightSlot();
                uint256 numLegs = tokenId.countLegs();
                for (uint256 leg = 0; leg < numLegs; ) {
                    LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                        tokenId,
                        leg,
                        positionSize
                    );
    
                    (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(
                        atTick,
                        liquidityChunk
                    );
    
                    if (tokenId.isLong(leg) == 0) {
                        unchecked {
                            value0 += int256(amount0);
                            value1 += int256(amount1);
                        }
                    } else {
                        unchecked {
                            value0 -= int256(amount0);
                            value1 -= int256(amount1);
                        }
                    }
    
                    unchecked {
                        ++leg;
                    }
                }
                unchecked {
                    ++k;
                }
            }
        }
    
        /// @notice Calculate the AMM Swap/trading fees for a `liquidityChunk` of each token.
        /// @dev Read from the uniswap pool and compute the accumulated fees from swapping activity.
        /// @param univ3pool The AMM/Uniswap pool where fees are collected from
        /// @param currentTick The current price tick
        /// @param tickLower The lower tick of the chunk to calculate fees for
        /// @param tickUpper The upper tick of the chunk to calculate fees for
        /// @param liquidity The liquidity amount of the chunk to calculate fees for
        /// @return The fees collected from the AMM for each token (LeftRight-packed) with token0 in the right slot and token1 in the left slot
        function calculateAMMSwapFees(
            IUniswapV3Pool univ3pool,
            int24 currentTick,
            int24 tickLower,
            int24 tickUpper,
            uint128 liquidity
        ) public view returns (LeftRightSigned) {
            // extract the amount of AMM fees collected within the liquidity chunk`
            // note: the fee variables are *per unit of liquidity*; so more "rate" variables
            (
                uint256 ammFeesPerLiqToken0X128,
                uint256 ammFeesPerLiqToken1X128
            ) = _getAMMSwapFeesPerLiquidityCollected(univ3pool, currentTick, tickLower, tickUpper);
    
            // Use the fee growth (rate) variable to compute the absolute fees accumulated within the chunk:
            //   ammFeesToken0X128 * liquidity / (2**128)
            // to store the (absolute) fees as int128:
            return
                LeftRightSigned
                    .wrap(0)
                    .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))
                    .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));
        }
    
        /// @notice Calculates the fee growth that has occurred (per unit of liquidity) in the AMM/Uniswap for an
        /// option position's tick range.
        /// @dev Extracts the feeGrowth from the uniswap v3 pool.
        /// @param univ3pool The AMM pool where the leg is deployed
        /// @param currentTick The current price tick in the AMM
        /// @param tickLower The lower tick of the option position leg (a liquidity chunk)
        /// @param tickUpper The upper tick of the option position leg (a liquidity chunk)
        /// @return feeGrowthInside0X128 the fee growth in the AMM of token0
        /// @return feeGrowthInside1X128 the fee growth in the AMM of token1
        function _getAMMSwapFeesPerLiquidityCollected(
            IUniswapV3Pool univ3pool,
            int24 currentTick,
            int24 tickLower,
            int24 tickUpper
        ) internal view returns (uint256 feeGrowthInside0X128, uint256 feeGrowthInside1X128) {
            // Get feesGrowths from the option position's lower+upper ticks
            // lowerOut0: For token0: fee growth per unit of liquidity on the _other_ side of tickLower (relative to currentTick)
            // only has relative meaning, not absolute — the value depends on when the tick is initialized
            // (...)
            // upperOut1: For token1: fee growth on the _other_ side of tickUpper (again: relative to currentTick)
            // the point is: the range covered by lowerOut0 changes depending on where currentTick is.
            (, , uint256 lowerOut0, uint256 lowerOut1, , , , ) = univ3pool.ticks(tickLower);
            (, , uint256 upperOut0, uint256 upperOut1, , , , ) = univ3pool.ticks(tickUpper);
    
            // compute the effective feeGrowth, depending on whether price is above/below/within range
            unchecked {
                if (currentTick < tickLower) {
                    /**
                      Diagrams shown for token0, and applies for token1 the same
                      L = lowerTick, U = upperTick
    
                        liquidity         lowerOut0 (all fees collected in this price tick range for token0)
                            ▲            ◄──────────────^v───► (to MAX_TICK)
                            │
                            │                      upperOut0
                            │                     ◄─────^v───►
                            │           ┌────────┐
                            │           │ chunk  │
                            │           │        │
                            └─────▲─────┴────────┴────────► price tick
                                  │     L        U
                                  │
                               current
                                tick
                    */
                    feeGrowthInside0X128 = lowerOut0 - upperOut0; // fee growth inside the chunk
                    feeGrowthInside1X128 = lowerOut1 - upperOut1;
                } else if (currentTick >= tickUpper) {
                    /**
                        liquidity
                            ▲           upperOut0
                            │◄─^v─────────────────────►
                            │     
                            │     lowerOut0  ┌────────┐
                            │◄─^v───────────►│ chunk  │
                            │                │        │
                            └────────────────┴────────┴─▲─────► price tick
                                             L        U │
                                                        │
                                                     current
                                                      tick
                     */
                    feeGrowthInside0X128 = upperOut0 - lowerOut0;
                    feeGrowthInside1X128 = upperOut1 - lowerOut1;
                } else {
                    /**
                      current AMM tick is within the option position range (within the chunk)
    
                         liquidity
                            ▲        feeGrowthGlobal0X128 = global fee growth
                            │                             = (all fees collected for the entire price range for token 0)
                            │
                            │                        
                            │     lowerOut0  ┌──────────────┐ upperOut0
                            │◄─^v───────────►│              │◄─────^v───►
                            │                │     chunk    │
                            │                │              │
                            └────────────────┴───────▲──────┴─────► price tick
                                             L       │      U
                                                     │
                                                  current
                                                   tick
                    */
                    feeGrowthInside0X128 = univ3pool.feeGrowthGlobal0X128() - lowerOut0 - upperOut0;
                    feeGrowthInside1X128 = univ3pool.feeGrowthGlobal1X128() - lowerOut1 - upperOut1;
                }
            }
        }
    }

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L209))
```solidity
File: contracts/libraries/InteractionHelper.sol

17: library InteractionHelper {
        /// @notice Function that performs approvals on behalf of the PanopticPool for CollateralTracker and SemiFungiblePositionManager.
        /// @param sfpm The SemiFungiblePositionManager being approved for both token0 and token1
        /// @param ct0 The CollateralTracker (token0) being approved for token0
        /// @param ct1 The CollateralTracker (token1) being approved for token1
        /// @param token0 The token0 (in Uniswap) being approved for
        /// @param token1 The token1 (in Uniswap) being approved for
        function doApprovals(
            SemiFungiblePositionManager sfpm,
            CollateralTracker ct0,
            CollateralTracker ct1,
            address token0,
            address token1
        ) external {
            // Approve transfers of Panoptic Pool funds by SFPM
            IERC20Partial(token0).approve(address(sfpm), type(uint256).max);
            IERC20Partial(token1).approve(address(sfpm), type(uint256).max);
    
            // Approve transfers of Panoptic Pool funds by Collateral token
            IERC20Partial(token0).approve(address(ct0), type(uint256).max);
            IERC20Partial(token1).approve(address(ct1), type(uint256).max);
        }
    
        /// @notice Computes the name of a CollateralTracker based on the token composition and fee of the underlying Uniswap Pool.
        /// @dev Some tokens do not have proper symbols so error handling is required - this logic takes up significant bytecode size, which is why it is in a library.
        /// @param token0 The token0 in the Uniswap Pool
        /// @param token1 The token1 in the Uniswap Pool
        /// @param isToken0 Whether the collateral token computing the name is for token0 or token1
        /// @param fee The fee of the Uniswap pool in basis points
        /// @param prefix A constant string appended to the start of the token name
        /// @return The complete name of the collateral token calling this function
        function computeName(
            address token0,
            address token1,
            bool isToken0,
            uint24 fee,
            string memory prefix
        ) external view returns (string memory) {
            // get the underlying token symbols
            // it's not guaranteed that they support the metadata extension
            // so we need to let them fail and return placeholder if not
            string memory symbol0;
            string memory symbol1;
            try IERC20Metadata(token0).symbol() returns (string memory _symbol) {
                symbol0 = _symbol;
            } catch {
                symbol0 = "???";
            }
            try IERC20Metadata(token1).symbol() returns (string memory _symbol) {
                symbol1 = _symbol;
            } catch {
                symbol1 = "???";
            }
            unchecked {
                return
                    string.concat(
                        prefix,
                        " ",
                        isToken0 ? symbol0 : symbol1,
                        " LP on ",
                        symbol0,
                        "/",
                        symbol1,
                        " ",
                        Strings.toString(fee),
                        "bps"
                    );
            }
        }
    
        /// @notice Returns symbol as prefixed symbol of underlying token.
        /// @param token The address of the underlying token used to compute the symbol
        /// @param prefix A constant string appended to the symbol of the underlying token to create the final symbol
        /// @return The symbol of the token
        function computeSymbol(
            address token,
            string memory prefix
        ) external view returns (string memory) {
            // not guaranteed that token supports metadada extension
            // so we need to let call fail and return placeholder if not
            try IERC20Metadata(token).symbol() returns (string memory tokenSymbol) {
                return string.concat(prefix, tokenSymbol);
            } catch {
                return string.concat(prefix, "???");
            }
        }
    
        /// @notice Returns decimals of underlying token (0 if not present).
        /// @param token The address of the underlying token used to compute the decimals
        /// @return The decimals of the token
        function computeDecimals(address token) external view returns (uint8) {
            // not guaranteed that token supports metadada extension
            // so we need to let call fail and return placeholder if not
            try IERC20Metadata(token).decimals() returns (uint8 _decimals) {
                return _decimals;
            } catch {
                return 0;
            }
        }
    }

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L116))
```solidity
File: contracts/libraries/Math.sol

13: library Math {
        /// @notice This is equivalent to type(uint256).max — used in assembly blocks as a replacement.
        uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;
    
        /*//////////////////////////////////////////////////////////////
                              GENERAL MATH HELPERS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Compute the min of the incoming int24s `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1
        function min24(int24 a, int24 b) internal pure returns (int24) {
            return a < b ? a : b;
        }
    
        /// @notice Compute the max of the incoming int24s `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4
        function max24(int24 a, int24 b) internal pure returns (int24) {
            return a > b ? a : b;
        }
    
        /// @notice Compute the min of the incoming `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1
        function min(uint256 a, uint256 b) internal pure returns (uint256) {
            return a < b ? a : b;
        }
    
        /// @notice Compute the min of the incoming `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1
        function min(int256 a, int256 b) internal pure returns (int256) {
            return a < b ? a : b;
        }
    
        /// @notice Compute the max of the incoming `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4
        function max(uint256 a, uint256 b) internal pure returns (uint256) {
            return a > b ? a : b;
        }
    
        /// @notice Compute the max of the incoming `a` and `b`.
        /// @param a The first number
        /// @param b The second number
        /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4
        function max(int256 a, int256 b) internal pure returns (int256) {
            return a > b ? a : b;
        }
    
        /// @notice Compute the absolute value of an integer (int256).
        /// @param x The incoming *signed* integer to take the absolute value of
        /// @dev Does not support `type(int256).min` and will revert (type(int256).max is one less).
        /// @return The absolute value of `x`, e.g. abs(-4) = 4
        function abs(int256 x) internal pure returns (int256) {
            return x > 0 ? x : -x;
        }
    
        /// @notice Compute the absolute value of an integer (int256).
        /// @param x The incoming *signed* integer to take the absolute value of
        /// @dev Supports `type(int256).min` because the corresponding value can fit in a uint (unlike `type(int256).max`).
        /// @return The absolute value of `x`, e.g. abs(-4) = 4
        function absUint(int256 x) internal pure returns (uint256) {
            unchecked {
                return x > 0 ? uint256(x) : uint256(-x);
            }
        }
    
        /// @notice Returns the index of the most significant nibble of the 160-bit number,
        /// where the least significant nibble is at index 0 and the most significant nibble is at index 40.
        /// @param x The value for which to compute the most significant nibble
        /// @return r The index of the most significant nibble (default: 0)
        function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {
            unchecked {
                if (x >= 0x100000000000000000000000000000000) {
                    x >>= 128;
                    r += 32;
                }
                if (x >= 0x10000000000000000) {
                    x >>= 64;
                    r += 16;
                }
                if (x >= 0x100000000) {
                    x >>= 32;
                    r += 8;
                }
                if (x >= 0x10000) {
                    x >>= 16;
                    r += 4;
                }
                if (x >= 0x100) {
                    x >>= 8;
                    r += 2;
                }
                if (x >= 0x10) {
                    r += 1;
                }
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                   TICK MATH
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Calculates 1.0001^(tick/2) as an X96 number.
        /// @dev Implemented using Uniswap's "incorrect" constants. Supplying commented-out real values for an accurate calculation.
        /// @dev Will revert if |tick| > max tick.
        /// @param tick Value of the tick for which sqrt(1.0001^tick) is calculated
        /// @return A Q64.96 number representing the sqrt price at the provided tick
        function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {
            unchecked {
                uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));
                if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();
    
                uint256 sqrtR = absTick & 0x1 != 0
                    ? 0xfffcb933bd6fad37aa2d162d1a594001
                    : 0x100000000000000000000000000000000;
                // RealV: 0xfffcb933bd6fad37aa2d162d1a594001
                if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;
                // RealV: 0xfff97272373d413259a46990580e2139
                if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;
                // RealV: 0xfff2e50f5f656932ef12357cf3c7fdca
                if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;
                // RealV: 0xffe5caca7e10e4e61c3624eaa0941ccd
                if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;
                // RealV: 0xffcb9843d60f6159c9db58835c92663e
                if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;
                // RealV: 0xff973b41fa98c081472e6896dfb254b6
                if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;
                // RealV: 0xff2ea16466c96a3843ec78b326b5284f
                if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;
                // RealV: 0xfe5dee046a99a2a811c461f1969c3032
                if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;
                // RealV: 0xfcbe86c7900a88aedcffc83b479aa363
                if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;
                // RealV: 0xf987a7253ac413176f2b074cf7815dd0
                if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;
                // RealV: 0xf3392b0822b70005940c7a398e4b6ff1
                if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;
                // RealV: 0xe7159475a2c29b7443b29c7fa6e887f2
                if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;
                // RealV: 0xd097f3bdfd2022b8845ad8f792aa548c
                if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;
                // RealV: 0xa9f746462d870fdf8a65dc1f90e05b52
                if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;
                // RealV: 0x70d869a156d2a1b890bb3df62baf27ff
                if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;
                // RealV: 0x31be135f97d08fd981231505542fbfe8
                if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;
                // RealV: 0x9aa508b5b7a84e1c677de54f3e988fe
                if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;
                // RealV: 0x5d6af8dedb81196699c329225ed28d
                if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;
                // RealV: 0x2216e584f5fa1ea926041bedeaf4
                if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;
                // RealV: 0x48a170391f7dc42444e7be7
    
                if (tick > 0) sqrtR = type(uint256).max / sqrtR;
    
                // Downcast + rounding up to keep is consistent with Uniswap's
                return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                        LIQUIDITY AMOUNTS (STRIKE+WIDTH)
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Calculates the amount of token0 received for a given LiquidityChunk.
        /// @dev Had to use a less optimal calculation to match Uniswap's implementation.
        /// @param liquidityChunk Variable that efficiently packs the liquidity, tickLower, and tickUpper.
        /// @return The amount of token0
        function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {
            uint160 lowPriceX96 = getSqrtRatioAtTick(liquidityChunk.tickLower());
            uint160 highPriceX96 = getSqrtRatioAtTick(liquidityChunk.tickUpper());
            unchecked {
                return
                    mulDiv(
                        uint256(liquidityChunk.liquidity()) << 96,
                        highPriceX96 - lowPriceX96,
                        highPriceX96
                    ) / lowPriceX96;
            }
        }
    
        /// @notice Calculates the amount of token1 received for a given LiquidityChunk.
        /// @param liquidityChunk Variable that efficiently packs the liquidity, tickLower, and tickUpper
        /// @return The amount of token1
        function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {
            uint160 lowPriceX96 = getSqrtRatioAtTick(liquidityChunk.tickLower());
            uint160 highPriceX96 = getSqrtRatioAtTick(liquidityChunk.tickUpper());
    
            unchecked {
                return mulDiv96(liquidityChunk.liquidity(), highPriceX96 - lowPriceX96);
            }
        }
    
        /// @notice Calculates the amount of token0 and token1 received for a given LiquidityChunk at the provided currentTick.
        /// @param currentTick The current tick to be evaluated
        /// @param liquidityChunk Variable that efficiently packs the liquidity, tickLower, and tickUpper
        /// @return amount0 The amount of token0
        /// @return amount1 The amount of token1
        function getAmountsForLiquidity(
            int24 currentTick,
            LiquidityChunk liquidityChunk
        ) internal pure returns (uint256 amount0, uint256 amount1) {
            if (currentTick <= liquidityChunk.tickLower()) {
                amount0 = getAmount0ForLiquidity(liquidityChunk);
            } else if (currentTick >= liquidityChunk.tickUpper()) {
                amount1 = getAmount1ForLiquidity(liquidityChunk);
            } else {
                amount0 = getAmount0ForLiquidity(liquidityChunk.updateTickLower(currentTick));
                amount1 = getAmount1ForLiquidity(liquidityChunk.updateTickUpper(currentTick));
            }
        }
    
        /// @notice Returns a LiquidityChunk with `liquidity` corresponding to `amount0` at the provided ticks.
        /// @dev Had to use a less optimal calculation to match Uniswap's implementation.
        /// @param tickLower The lower tick of the chunk
        /// @param tickUpper The upper tick of the chunk
        /// @param amount0 The amount of token0
        /// @return A LiquidityChunk with `tickLower`, `tickUpper`, and the calculated amount of liquidity
        function getLiquidityForAmount0(
            int24 tickLower,
            int24 tickUpper,
            uint256 amount0
        ) internal pure returns (LiquidityChunk) {
            uint160 lowPriceX96 = getSqrtRatioAtTick(tickLower);
            uint160 highPriceX96 = getSqrtRatioAtTick(tickUpper);
    
            unchecked {
                return
                    LiquidityChunkLibrary.createChunk(
                        tickLower,
                        tickUpper,
                        toUint128(
                            mulDiv(
                                amount0,
                                mulDiv96(highPriceX96, lowPriceX96),
                                highPriceX96 - lowPriceX96
                            )
                        )
                    );
            }
        }
    
        /// @notice Returns a LiquidityChunk with `liquidity` corresponding to `amount1` at the provided ticks.
        /// @dev Had to use a less optimal calculation to match Uniswap's implementation.
        /// @param tickLower The lower tick of the chunk
        /// @param tickUpper The upper tick of the chunk
        /// @param amount1 The amount of token1
        /// @return A LiquidityChunk with `tickLower`, `tickUpper`, and the calculated amount of liquidity
        function getLiquidityForAmount1(
            int24 tickLower,
            int24 tickUpper,
            uint256 amount1
        ) internal pure returns (LiquidityChunk) {
            uint160 lowPriceX96 = getSqrtRatioAtTick(tickLower);
            uint160 highPriceX96 = getSqrtRatioAtTick(tickUpper);
    
            unchecked {
                return
                    LiquidityChunkLibrary.createChunk(
                        tickLower,
                        tickUpper,
                        toUint128(mulDiv(amount1, Constants.FP96, highPriceX96 - lowPriceX96))
                    );
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                    CASTING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Downcast uint256 to uint128. Revert on overflow or underflow.
        /// @param toDowncast The uint256 to be downcasted
        /// @return downcastedInt The downcasted uint (uint128 now)
        function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {
            if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();
        }
    
        /// @notice Downcast uint256 to uint128, but cap at type(uint128).max on overflow.
        /// @return downcastedInt The downcasted uint (uint128 now)
        function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {
            if ((downcastedInt = uint128(toDowncast)) != toDowncast) {
                downcastedInt = type(uint128).max;
            }
        }
    
        /// @notice Recast uint128 to int128.
        /// @param toCast The uint256 to be downcasted
        /// @return downcastedInt The downcasted int (int128 now)
        function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {
            if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();
        }
    
        /// @notice Cast an int256 to an int128, revert on overflow or underflow.
        /// @param toCast the int256 to be downcasted to int128
        /// @return downcastedInt the downcasted integer, now of type int128
        function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {
            if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();
        }
    
        /// @notice Cast a uint256 to an int256, revert on overflow.
        /// @param toCast The value to be downcasted to uint128
        /// @return The incoming uint256 but now of type int256
        function toInt256(uint256 toCast) internal pure returns (int256) {
            if (toCast > uint256(type(int256).max)) revert Errors.CastingError();
            return int256(toCast);
        }
    
        /*//////////////////////////////////////////////////////////////
                               MULDIV ALGORITHMS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Calculates floor(a×b÷denominator) with full precision. Throws if result overflows a uint256 or denominator == 0.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @param denominator The divisor
        /// @return result The 256-bit result
        /// @dev Credit to Remco Bloemen under MIT license https://xn--2-umb.com/21/muldiv
        function mulDiv(
            uint256 a,
            uint256 b,
            uint256 denominator
        ) internal pure returns (uint256 result) {
            unchecked {
                // 512-bit multiply [prod1 prod0] = a * b
                // Compute the product mod 2**256 and mod 2**256 - 1
                // then use the Chinese Remainder Theorem to reconstruct
                // the 512 bit result. The result is stored in two 256
                // variables such that product = prod1 * 2**256 + prod0
                uint256 prod0; // Least significant 256 bits of the product
                uint256 prod1; // Most significant 256 bits of the product
                assembly ("memory-safe") {
                    let mm := mulmod(a, b, not(0))
                    prod0 := mul(a, b)
                    prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                }
    
                // Handle non-overflow cases, 256 by 256 division
                if (prod1 == 0) {
                    require(denominator > 0);
                    assembly ("memory-safe") {
                        result := div(prod0, denominator)
                    }
                    return result;
                }
    
                // Make sure the result is less than 2**256.
                // Also prevents denominator == 0
                require(denominator > prod1);
    
                ///////////////////////////////////////////////
                // 512 by 256 division.
                ///////////////////////////////////////////////
    
                // Make division exact by subtracting the remainder from [prod1 prod0]
                // Compute remainder using mulmod
                uint256 remainder;
                assembly ("memory-safe") {
                    remainder := mulmod(a, b, denominator)
                }
                // Subtract 256 bit number from 512 bit number
                assembly ("memory-safe") {
                    prod1 := sub(prod1, gt(remainder, prod0))
                    prod0 := sub(prod0, remainder)
                }
    
                // Factor powers of two out of denominator
                // Compute largest power of two divisor of denominator.
                // Always >= 1.
                uint256 twos = (0 - denominator) & denominator;
                // Divide denominator by power of two
                assembly ("memory-safe") {
                    denominator := div(denominator, twos)
                }
    
                // Divide [prod1 prod0] by the factors of two
                assembly ("memory-safe") {
                    prod0 := div(prod0, twos)
                }
                // Shift in bits from prod1 into prod0. For this we need
                // to flip `twos` such that it is 2**256 / twos.
                // If twos is zero, then it becomes one
                assembly ("memory-safe") {
                    twos := add(div(sub(0, twos), twos), 1)
                }
                prod0 |= prod1 * twos;
    
                // Invert denominator mod 2**256
                // Now that denominator is an odd number, it has an inverse
                // modulo 2**256 such that denominator * inv = 1 mod 2**256.
                // Compute the inverse by starting with a seed that is correct
                // correct for four bits. That is, denominator * inv = 1 mod 2**4
                uint256 inv = (3 * denominator) ^ 2;
                // Now use Newton-Raphson iteration to improve the precision.
                // Thanks to Hensel's lifting lemma, this also works in modular
                // arithmetic, doubling the correct bits in each step.
                inv *= 2 - denominator * inv; // inverse mod 2**8
                inv *= 2 - denominator * inv; // inverse mod 2**16
                inv *= 2 - denominator * inv; // inverse mod 2**32
                inv *= 2 - denominator * inv; // inverse mod 2**64
                inv *= 2 - denominator * inv; // inverse mod 2**128
                inv *= 2 - denominator * inv; // inverse mod 2**256
    
                // Because the division is now exact we can divide by multiplying
                // with the modular inverse of denominator. This will give us the
                // correct result modulo 2**256. Since the preconditions guarantee
                // that the outcome is less than 2**256, this is the final result.
                // We don't need to compute the high bits of the result and prod1
                // is no longer required.
                result = prod0 * inv;
            }
        }
    
        /// @notice Calculates ceil(a×b÷denominator) with full precision. Throws if result overflows a uint256 or denominator == 0.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @param denominator The divisor
        /// @return result The 256-bit result
        function mulDivRoundingUp(
            uint256 a,
            uint256 b,
            uint256 denominator
        ) internal pure returns (uint256 result) {
            unchecked {
                result = mulDiv(a, b, denominator);
                if (mulmod(a, b, denominator) > 0) {
                    require(result < type(uint256).max);
                    result++;
                }
            }
        }
    
        /// @notice Calculates floor(a×b÷2^64) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return The 256-bit result
        function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {
            unchecked {
                // 512-bit multiply [prod1 prod0] = a * b
                // Compute the product mod 2**256 and mod 2**256 - 1
                // then use the Chinese Remainder Theorem to reconstruct
                // the 512 bit result. The result is stored in two 256
                // variables such that product = prod1 * 2**256 + prod0
                uint256 prod0; // Least significant 256 bits of the product
                uint256 prod1; // Most significant 256 bits of the product
                assembly ("memory-safe") {
                    let mm := mulmod(a, b, not(0))
                    prod0 := mul(a, b)
                    prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                }
    
                // Handle non-overflow cases, 256 by 256 division
                if (prod1 == 0) {
                    uint256 res;
                    assembly ("memory-safe") {
                        // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                        res := shr(64, prod0)
                    }
                    return res;
                }
    
                // Make sure the result is less than 2**256.
                require(2 ** 64 > prod1);
    
                ///////////////////////////////////////////////
                // 512 by 256 division.
                ///////////////////////////////////////////////
    
                // Make division exact by subtracting the remainder from [prod1 prod0]
                // Compute remainder using mulmod
                uint256 remainder;
                assembly ("memory-safe") {
                    remainder := mulmod(a, b, 0x10000000000000000)
                }
                // Subtract 256 bit number from 512 bit number
                assembly ("memory-safe") {
                    prod1 := sub(prod1, gt(remainder, prod0))
                    prod0 := sub(prod0, remainder)
                }
    
                // Divide [prod1 prod0] by the factors of two (note that this is just 2**96 since the denominator is a power of 2 itself)
                assembly ("memory-safe") {
                    // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                    prod0 := shr(64, prod0)
                }
                // Shift in bits from prod1 into prod0. For this we need
                // to flip `twos` such that it is 2**256 / twos.
                // If twos is zero, then it becomes one
                // Note that this is just 2**192 since 2**256 over the fixed denominator (2**64) equals 2**192
                prod0 |= prod1 * 2 ** 192;
    
                return prod0;
            }
        }
    
        /// @notice Calculates floor(a×b÷2^96) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return The 256-bit result
        function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {
            unchecked {
                // 512-bit multiply [prod1 prod0] = a * b
                // Compute the product mod 2**256 and mod 2**256 - 1
                // then use the Chinese Remainder Theorem to reconstruct
                // the 512 bit result. The result is stored in two 256
                // variables such that product = prod1 * 2**256 + prod0
                uint256 prod0; // Least significant 256 bits of the product
                uint256 prod1; // Most significant 256 bits of the product
                assembly ("memory-safe") {
                    let mm := mulmod(a, b, not(0))
                    prod0 := mul(a, b)
                    prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                }
    
                // Handle non-overflow cases, 256 by 256 division
                if (prod1 == 0) {
                    uint256 res;
                    assembly ("memory-safe") {
                        // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                        res := shr(96, prod0)
                    }
                    return res;
                }
    
                // Make sure the result is less than 2**256.
                require(2 ** 96 > prod1);
    
                ///////////////////////////////////////////////
                // 512 by 256 division.
                ///////////////////////////////////////////////
    
                // Make division exact by subtracting the remainder from [prod1 prod0]
                // Compute remainder using mulmod
                uint256 remainder;
                assembly ("memory-safe") {
                    remainder := mulmod(a, b, 0x1000000000000000000000000)
                }
                // Subtract 256 bit number from 512 bit number
                assembly ("memory-safe") {
                    prod1 := sub(prod1, gt(remainder, prod0))
                    prod0 := sub(prod0, remainder)
                }
    
                // Divide [prod1 prod0] by the factors of two (note that this is just 2**96 since the denominator is a power of 2 itself)
                assembly ("memory-safe") {
                    // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                    prod0 := shr(96, prod0)
                }
                // Shift in bits from prod1 into prod0. For this we need
                // to flip `twos` such that it is 2**256 / twos.
                // If twos is zero, then it becomes one
                // Note that this is just 2**160 since 2**256 over the fixed denominator (2**96) equals 2**160
                prod0 |= prod1 * 2 ** 160;
    
                return prod0;
            }
        }
    
        /// @notice Calculates ceil(a×b÷2^96) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return result The 256-bit result
        function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
            unchecked {
                result = mulDiv96(a, b);
                if (mulmod(a, b, 2 ** 96) > 0) {
                    require(result < type(uint256).max);
                    result++;
                }
            }
        }
    
        /// @notice Calculates floor(a×b÷2^128) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return The 256-bit result
        function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {
            unchecked {
                // 512-bit multiply [prod1 prod0] = a * b
                // Compute the product mod 2**256 and mod 2**256 - 1
                // then use the Chinese Remainder Theorem to reconstruct
                // the 512 bit result. The result is stored in two 256
                // variables such that product = prod1 * 2**256 + prod0
                uint256 prod0; // Least significant 256 bits of the product
                uint256 prod1; // Most significant 256 bits of the product
                assembly ("memory-safe") {
                    let mm := mulmod(a, b, not(0))
                    prod0 := mul(a, b)
                    prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                }
    
                // Handle non-overflow cases, 256 by 256 division
                if (prod1 == 0) {
                    uint256 res;
                    assembly ("memory-safe") {
                        // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                        res := shr(128, prod0)
                    }
                    return res;
                }
    
                // Make sure the result is less than 2**256.
                require(2 ** 128 > prod1);
    
                ///////////////////////////////////////////////
                // 512 by 256 division.
                ///////////////////////////////////////////////
    
                // Make division exact by subtracting the remainder from [prod1 prod0]
                // Compute remainder using mulmod
                uint256 remainder;
                assembly ("memory-safe") {
                    remainder := mulmod(a, b, 0x100000000000000000000000000000000)
                }
                // Subtract 256 bit number from 512 bit number
                assembly ("memory-safe") {
                    prod1 := sub(prod1, gt(remainder, prod0))
                    prod0 := sub(prod0, remainder)
                }
    
                // Divide [prod1 prod0] by the factors of two (note that this is just 2**128 since the denominator is a power of 2 itself)
                assembly ("memory-safe") {
                    // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                    prod0 := shr(128, prod0)
                }
                // Shift in bits from prod1 into prod0. For this we need
                // to flip `twos` such that it is 2**256 / twos.
                // If twos is zero, then it becomes one
                // Note that this is just 2**160 since 2**256 over the fixed denominator (2**128) equals 2**128
                prod0 |= prod1 * 2 ** 128;
    
                return prod0;
            }
        }
    
        /// @notice Calculates ceil(a×b÷2^128) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return result The 256-bit result
        function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
            unchecked {
                result = mulDiv128(a, b);
                if (mulmod(a, b, 2 ** 128) > 0) {
                    require(result < type(uint256).max);
                    result++;
                }
            }
        }
    
        /// @notice Calculates floor(a×b÷2^192) with full precision. Throws if result overflows a uint256.
        /// @param a The multiplicand
        /// @param b The multiplier
        /// @return The 256-bit result
        function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {
            unchecked {
                // 512-bit multiply [prod1 prod0] = a * b
                // Compute the product mod 2**256 and mod 2**256 - 1
                // then use the Chinese Remainder Theorem to reconstruct
                // the 512 bit result. The result is stored in two 256
                // variables such that product = prod1 * 2**256 + prod0
                uint256 prod0; // Least significant 256 bits of the product
                uint256 prod1; // Most significant 256 bits of the product
                assembly ("memory-safe") {
                    let mm := mulmod(a, b, not(0))
                    prod0 := mul(a, b)
                    prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                }
    
                // Handle non-overflow cases, 256 by 256 division
                if (prod1 == 0) {
                    uint256 res;
                    assembly ("memory-safe") {
                        // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                        res := shr(192, prod0)
                    }
                    return res;
                }
    
                // Make sure the result is less than 2**256.
                require(2 ** 192 > prod1);
    
                ///////////////////////////////////////////////
                // 512 by 256 division.
                ///////////////////////////////////////////////
    
                // Make division exact by subtracting the remainder from [prod1 prod0]
                // Compute remainder using mulmod
                uint256 remainder;
                assembly ("memory-safe") {
                    remainder := mulmod(a, b, 0x1000000000000000000000000000000000000000000000000)
                }
                // Subtract 256 bit number from 512 bit number
                assembly ("memory-safe") {
                    prod1 := sub(prod1, gt(remainder, prod0))
                    prod0 := sub(prod0, remainder)
                }
    
                // Divide [prod1 prod0] by the factors of two (note that this is just 2**96 since the denominator is a power of 2 itself)
                assembly ("memory-safe") {
                    // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                    prod0 := shr(192, prod0)
                }
                // Shift in bits from prod1 into prod0. For this we need
                // to flip `twos` such that it is 2**256 / twos.
                // If twos is zero, then it becomes one
                // Note that this is just 2**64 since 2**256 over the fixed denominator (2**192) equals 2**64
                prod0 |= prod1 * 2 ** 64;
    
                return prod0;
            }
        }
    
        /// @notice Calculates ceil(a÷b), returning 0 if b == 0.
        /// @param a The numerator
        /// @param b The denominator
        /// @return result The 256-bit result
        function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
            assembly ("memory-safe") {
                result := add(div(a, b), gt(mod(a, b), 0))
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                    SORTING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice QuickSort is a sorting algorithm that employs the Divide and Conquer strategy. It selects a pivot element and arranges the given array around
        /// this pivot by correctly positioning it within the sorted array.
        /// @param arr The elements that must be sorted
        /// @param left The starting index
        /// @param right The ending index
        function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {
            unchecked {
                int256 i = left;
                int256 j = right;
                if (i == j) return;
                int256 pivot = arr[uint256(left + (right - left) / 2)];
                while (i < j) {
                    while (arr[uint256(i)] < pivot) i++;
                    while (pivot < arr[uint256(j)]) j--;
                    if (i <= j) {
                        (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);
                        i++;
                        j--;
                    }
                }
                if (left < j) quickSort(arr, left, j);
                if (i < right) quickSort(arr, i, right);
            }
        }
    
        /// @notice Calls `quickSort` with default starting index of 0 and ending index of the last element in the array.
        /// @param data The elements that must be sorted
        /// @return The sorted array
        function sort(int256[] memory data) internal pure returns (int256[] memory) {
            unchecked {
                quickSort(data, int256(0), int256(data.length - 1));
            }
            return data;
        }
    }

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L782))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {
        // Used for safecasting
        using Math for uint256;
    
        /// @notice This is equivalent to type(uint256).max — used in assembly blocks as a replacement.
        uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;
    
        /// @notice masks 16-bit tickSpacing out of 64-bit [16-bit tickspacing][48-bit poolPattern] format poolId
        uint64 internal constant TICKSPACING_MASK = 0xFFFF000000000000;
    
        /*//////////////////////////////////////////////////////////////
                                  MATH HELPERS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Given an address to a Uniswap v3 pool, return its 64-bit ID as used in the `TokenId` of Panoptic.
        /// @dev Example:
        ///      the 64 bits are the 48 *last* (most significant) bits - and thus corresponds to the *first* 12 hex characters (reading left to right)
        ///      of the Uniswap v3 pool address, with the tickSpacing written in the highest 16 bits (i.e, max tickSpacing is 32768)
        ///      e.g.:
        ///        univ3pool   = 0x8ad599c3A0ff1De082011EFDDc58f1908eb6e6D8
        ///        tickSpacing = 60
        ///      the returned id is then:
        ///        poolPattern = 0x00008ad599c3A0ff
        ///        tickSpacing = 0x003c000000000000    +
        ///        --------------------------------------------
        ///        poolId      = 0x003c8ad599c3A0ff
        ///
        /// @param univ3pool The address of the Uniswap v3 pool to get the ID of
        /// @return A uint64 representing a fingerprint of the uniswap v3 pool address
        function getPoolId(address univ3pool) internal view returns (uint64) {
            unchecked {
                int24 tickSpacing = IUniswapV3Pool(univ3pool).tickSpacing();
                uint64 poolId = uint64(uint160(univ3pool) >> 112);
                poolId += uint64(uint24(tickSpacing)) << 48;
                return poolId;
            }
        }
    
        /// @notice Increments the pool pattern (first 48 bits) of a poolId by 1.
        /// @param poolId The 64-bit pool ID
        /// @return The provided `poolId` with its pool pattern slot incremented by 1
        function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {
            unchecked {
                // increment
                return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);
            }
        }
    
        /// @notice Get the number of leading hex characters in an address.
        ///     0x0000bababaab...     0xababababab...
        ///          ▲                 ▲
        ///          │                 │
        ///     4 leading hex      0 leading hex
        ///    character zeros    character zeros
        ///
        /// @param addr The address to get the number of leading zero hex characters for
        /// @return The number of leading zero hex characters in the address
        function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {
            unchecked {
                return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                              ORACLE CALCULATIONS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Update an existing account's "positions hash" with a new single position `tokenId`.
        /// @notice The positions hash contains a single fingerprint of all positions created by an account/user as well as a tally of the positions.
        /// @dev The combined hash is the XOR of all individual position hashes.
        /// @param existingHash The existing position hash containing all historical N positions created and the count of the positions
        /// @param tokenId The new position to add to the existing hash: existingHash = uint248(existingHash) ^ hashOf(tokenId)
        /// @param addFlag Whether to mint (add) the tokenId to the count of positions or burn (subtract) it from the count (existingHash >> 248) +/- 1
        /// @return newHash The new positionHash with the updated hash
        function updatePositionsHash(
            uint256 existingHash,
            TokenId tokenId,
            bool addFlag
        ) internal pure returns (uint256) {
            // add the XOR`ed hash of the single option position `tokenId` to the `existingHash`
            // @dev 0 ^ x = x
    
            unchecked {
                // update hash by taking the XOR of the new tokenId
                uint248 updatedHash = uint248(existingHash) ^
                    (uint248(uint256(keccak256(abi.encode(tokenId)))));
                // increment the top 8 bit if addflag=true, decrement otherwise
                return
                    addFlag
                        ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)
                        : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);
            }
        }
    
        /// @notice Returns the median of the last `cardinality` average prices over `period` observations from `univ3pool`.
        /// @dev Used when we need a manipulation-resistant TWAP price.
        /// @dev Uniswap observations snapshot the closing price of the last block before the first interaction of a given block.
        /// @dev The maximum frequency of observations is 1 per block, but there is no guarantee that the pool will be observed at every block.
        /// @dev Each period has a minimum length of blocktime * period, but may be longer if the Uniswap pool is relatively inactive.
        /// @dev The final price used in the array (of length `cardinality`) is the average of all observations comprising `period` (which is itself a number of observations).
        /// @dev Thus, the minimum total time window is `cardinality` * `period` * `blocktime`.
        /// @param univ3pool The Uniswap pool to get the median observation from
        /// @param observationIndex The index of the last observation in the pool
        /// @param observationCardinality The number of observations in the pool
        /// @param cardinality The number of `periods` to in the median price array, should be odd.
        /// @param period The number of observations to average to compute one entry in the median price array
        /// @return The median of `cardinality` observations spaced by `period` in the Uniswap pool
        function computeMedianObservedPrice(
            IUniswapV3Pool univ3pool,
            uint256 observationIndex,
            uint256 observationCardinality,
            uint256 cardinality,
            uint256 period
        ) external view returns (int24) {
            unchecked {
                int256[] memory tickCumulatives = new int256[](cardinality + 1);
    
                uint256[] memory timestamps = new uint256[](cardinality + 1);
                // get the last 4 timestamps/tickCumulatives (if observationIndex < cardinality, the index will wrap back from observationCardinality)
                for (uint256 i = 0; i < cardinality + 1; ++i) {
                    (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
                        uint256(
                            (int256(observationIndex) - int256(i * period)) +
                                int256(observationCardinality)
                        ) % observationCardinality
                    );
                }
    
                int256[] memory ticks = new int256[](cardinality);
                // use cardinality periods given by cardinality + 1 accumulator observations to compute the last cardinality observed ticks spaced by period
                for (uint256 i = 0; i < cardinality; ++i) {
                    ticks[i] =
                        (tickCumulatives[i] - tickCumulatives[i + 1]) /
                        int256(timestamps[i] - timestamps[i + 1]);
                }
    
                // get the median of the 3 calculated ticks
                return int24(Math.sort(ticks)[cardinality / 2]);
            }
        }
    
        /// @notice Takes a packed structure representing a sorted 7-slot ring buffer of ticks and returns the median of those values.
        /// @dev Also inserts the latest Uniswap observation into the buffer, resorts, and returns if the last entry is at least `period` seconds old.
        /// @param observationIndex The index of the last observation in the Uniswap pool
        /// @param observationCardinality The number of observations in the Uniswap pool
        /// @param period The minimum time in seconds that must have passed since the last observation was inserted into the buffer
        /// @param medianData The packed structure representing the sorted 7-slot ring buffer of ticks
        /// @param univ3pool The Uniswap pool to retrieve observations from
        /// @return medianTick The median of the provided 7-slot ring buffer of ticks in `medianData`
        /// @return updatedMedianData The updated 7-slot ring buffer of ticks with the latest observation inserted if the last entry is at least `period` seconds old (returns 0 otherwise)
        function computeInternalMedian(
            uint256 observationIndex,
            uint256 observationCardinality,
            uint256 period,
            uint256 medianData,
            IUniswapV3Pool univ3pool
        ) external view returns (int24 medianTick, uint256 updatedMedianData) {
            unchecked {
                // return the average of the rank 3 and 4 values
                medianTick =
                    (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +
                        int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /
                    2;
    
                // only proceed if last entry is at least MEDIAN_PERIOD seconds old
                if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {
                    int24 lastObservedTick;
                    {
                        (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
                            uint256(
                                int256(observationIndex) - int256(1) + int256(observationCardinality)
                            ) % observationCardinality
                        );
    
                        (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
                            .observations(observationIndex);
                        lastObservedTick = int24(
                            (tickCumulative_last - tickCumulative_old) /
                                int256(timestamp_last - timestamp_old)
                        );
                    }
    
                    uint24 orderMap = uint24(medianData >> 192);
    
                    uint24 newOrderMap;
                    uint24 shift = 1;
                    bool below = true;
                    uint24 rank;
                    int24 entry;
                    for (uint8 i; i < 8; ++i) {
                        // read the rank from the existing ordering
                        rank = (orderMap >> (3 * i)) % 8;
    
                        if (rank == 7) {
                            shift -= 1;
                            continue;
                        }
    
                        // read the corresponding entry
                        entry = int24(uint24(medianData >> (rank * 24)));
                        if ((below) && (lastObservedTick > entry)) {
                            shift += 1;
                            below = false;
                        }
    
                        newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));
                    }
    
                    updatedMedianData =
                        (block.timestamp << 216) +
                        (uint256(newOrderMap) << 192) +
                        uint256(uint192(medianData << 24)) +
                        uint256(uint24(lastObservedTick));
                }
            }
        }
    
        /// @notice Computes the twap of a Uniswap V3 pool using data from its oracle.
        /// @dev Note that our definition of TWAP differs from a typical mean of prices over a time window.
        /// @dev We instead observe the average price over a series of time intervals, and define the TWAP as the median of those averages.
        /// @param univ3pool The Uniswap pool from which to compute the TWAP.
        /// @param twapWindow The time window to compute the TWAP over.
        /// @return twapTick The final calculated TWAP tick.
        function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {
            uint32[] memory secondsAgos = new uint32[](20);
    
            int256[] memory twapMeasurement = new int256[](19);
    
            unchecked {
                // construct the time stots
                for (uint256 i = 0; i < 20; ++i) {
                    secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);
                }
    
                // observe the tickCumulative at the 20 pre-defined time slots
                (int56[] memory tickCumulatives, ) = univ3pool.observe(secondsAgos);
    
                // compute the average tick per 30s window
                for (uint256 i = 0; i < 19; ++i) {
                    twapMeasurement[i] = int24(
                        (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))
                    );
                }
    
                // sort the tick measurements
                int256[] memory sortedTicks = Math.sort(twapMeasurement);
    
                // Get the median value
                return int24(sortedTicks[10]);
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                             LIQUIDITY CALCULATION
        //////////////////////////////////////////////////////////////*/
    
        /// @notice For a given option position (`tokenId`), leg index within that position (`legIndex`), and `positionSize` get the tick range spanned and its
        /// liquidity (share ownership) in the Univ3 pool; this is a liquidity chunk.
        ///          Liquidity chunk  (defined by tick upper, tick lower, and its size/amount: the liquidity)
        ///   liquidity    │
        ///         ▲      │
        ///         │     ┌▼┐
        ///         │  ┌──┴─┴──┐
        ///         │  │       │
        ///         │  │       │
        ///         └──┴───────┴────► price
        ///         Uniswap v3 Pool
        /// @param tokenId The option position id
        /// @param legIndex The leg index of the option position, can be {0,1,2,3}
        /// @param positionSize The number of contracts held by this leg
        /// @return A LiquidityChunk with `tickLower`, `tickUpper`, and `liquidity`
        function getLiquidityChunk(
            TokenId tokenId,
            uint256 legIndex,
            uint128 positionSize
        ) internal pure returns (LiquidityChunk) {
            // get the tick range for this leg
            (int24 tickLower, int24 tickUpper) = tokenId.asTicks(legIndex);
    
            // Get the amount of liquidity owned by this leg in the univ3 pool in the above tick range
            // Background:
            //
            //  In Uniswap v3, the amount of liquidity received for a given amount of token0 when the price is
            //  not in range is given by:
            //     Liquidity = amount0 * (sqrt(upper) * sqrt(lower)) / (sqrt(upper) - sqrt(lower))
            //  For token1, it is given by:
            //     Liquidity = amount1 / (sqrt(upper) - sqrt(lower))
            //
            //  However, in Panoptic, each position has a asset parameter. The asset is the "basis" of the position.
            //  In TradFi, the asset is always cash and selling a $1000 put requires the user to lock $1000, and selling
            //  a call requires the user to lock 1 unit of asset.
            //
            //  Because Uni v3 chooses token0 and token1 from the alphanumeric order, there is no consistency as to whether token0 is
            //  stablecoin, ETH, or an ERC20. Some pools may want ETH to be the asset (e.g. ETH-DAI) and some may wish the stablecoin to
            //  be the asset (e.g. DAI-ETH) so that K asset is moved for puts and 1 asset is moved for calls.
            //  But since the convention is to force the order always we have no say in this.
            //
            //  To solve this, we encode the asset value in tokenId. This parameter specifies which of token0 or token1 is the
            //  asset, such that:
            //     when asset=0, then amount0 moved at strike K =1.0001**currentTick is 1, amount1 moved to strike K is 1/K
            //     when asset=1, then amount1 moved at strike K =1.0001**currentTick is K, amount0 moved to strike K is 1
            //
            //  The following function takes this into account when computing the liquidity of the leg and switches between
            //  the definition for getLiquidityForAmount0 or getLiquidityForAmount1 when relevant.
            //
            //
            uint256 amount = uint256(positionSize) * tokenId.optionRatio(legIndex);
            if (tokenId.asset(legIndex) == 0) {
                return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);
            } else {
                return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);
            }
        }
    
        /// @notice Extract the tick range specified by `strike` and `width` for the given `tickSpacing`, if valid.
        /// @param strike The strike price of the option
        /// @param width The width of the option
        /// @param tickSpacing The tick spacing of the underlying Uniswap v3 pool
        /// @return tickLower The lower tick of the liquidity chunk
        /// @return tickUpper The upper tick of the liquidity chunk
        function getTicks(
            int24 strike,
            int24 width,
            int24 tickSpacing
        ) internal pure returns (int24 tickLower, int24 tickUpper) {
            unchecked {
                // The max/min ticks that can be initialized are the closest multiple of tickSpacing to the actual max/min tick abs()=887272
                // Dividing and multiplying by tickSpacing rounds down and forces the tick to be a multiple of tickSpacing
                int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;
                int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;
    
                (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(width, tickSpacing);
    
                (tickLower, tickUpper) = (strike - rangeDown, strike + rangeUp);
    
                // Revert if the upper/lower ticks are not multiples of tickSpacing
                // Revert if the tick range extends from the strike outside of the valid tick range
                // These are invalid states, and would revert silently later in `univ3Pool.mint`
                if (
                    tickLower % tickSpacing != 0 ||
                    tickUpper % tickSpacing != 0 ||
                    tickLower < minTick ||
                    tickUpper > maxTick
                ) revert Errors.TicksNotInitializable();
            }
        }
    
        /// @notice Returns the distances of the upper and lower ticks from the strike for a position with the given width and tickSpacing.
        /// @dev Given `r = (width * tickSpacing) / 2`, `tickLower = strike - floor(r)` and `tickUpper = strike + ceil(r)`.
        /// @param width The width of the leg.
        /// @param tickSpacing The tick spacing of the underlying pool.
        /// @return The lower tick of the range
        /// @return The upper tick of the range
        function getRangesFromStrike(
            int24 width,
            int24 tickSpacing
        ) internal pure returns (int24, int24) {
            return (
                (width * tickSpacing) / 2,
                int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))
            );
        }
    
        /*//////////////////////////////////////////////////////////////
                             TOKEN CONVERSION LOGIC
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Compute the amount of funds that are underlying this option position. This is useful when exercising a position.
        /// @param tokenId The option position id
        /// @param positionSize The number of contracts of this option
        /// @return longAmounts Left-right packed word where the right contains the total contract size and the left total notional
        /// @return shortAmounts Left-right packed word where the right contains the total contract size and the left total notional
        function computeExercisedAmounts(
            TokenId tokenId,
            uint128 positionSize
        ) internal pure returns (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) {
            uint256 numLegs = tokenId.countLegs();
            for (uint256 leg = 0; leg < numLegs; ) {
                // Compute the amount of funds that have been removed from the Panoptic Pool
                (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(
                    tokenId,
                    positionSize,
                    leg
                );
    
                longAmounts = longAmounts.add(longs);
                shortAmounts = shortAmounts.add(shorts);
    
                unchecked {
                    ++leg;
                }
            }
        }
    
        /// @notice Adds required collateral and collateral balance from collateralTracker0 and collateralTracker1 and converts to single values in terms of `tokenType`.
        /// @param tokenData0 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token0)
        /// @param tokenData1 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token1)
        /// @param tokenType The type of token (token0 or token1) to express collateralBalance and requiredCollateral in
        /// @param sqrtPriceX96 The sqrt price at which to convert between token0/token1
        /// @return The total combined balance of token0 and token1 for a user in terms of tokenType
        /// @return The combined collateral requirement for a user in terms of tokenType
        function convertCollateralData(
            LeftRightUnsigned tokenData0,
            LeftRightUnsigned tokenData1,
            uint256 tokenType,
            uint160 sqrtPriceX96
        ) internal pure returns (uint256, uint256) {
            if (tokenType == 0) {
                return (
                    tokenData0.rightSlot() + convert1to0(tokenData1.rightSlot(), sqrtPriceX96),
                    tokenData0.leftSlot() + convert1to0(tokenData1.leftSlot(), sqrtPriceX96)
                );
            } else {
                return (
                    tokenData1.rightSlot() + convert0to1(tokenData0.rightSlot(), sqrtPriceX96),
                    tokenData1.leftSlot() + convert0to1(tokenData0.leftSlot(), sqrtPriceX96)
                );
            }
        }
    
        /// @notice Adds required collateral and collateral balance from collateralTracker0 and collateralTracker1 and converts to single values in terms of `tokenType`.
        /// @param tokenData0 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token0)
        /// @param tokenData1 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token1)
        /// @param tokenType The type of token (token0 or token1) to express collateralBalance and requiredCollateral in
        /// @param tick The tick at which to convert between token0/token1
        /// @return The total combined balance of token0 and token1 for a user in terms of tokenType
        /// @return The combined collateral requirement for a user in terms of tokenType
        function convertCollateralData(
            LeftRightUnsigned tokenData0,
            LeftRightUnsigned tokenData1,
            uint256 tokenType,
            int24 tick
        ) internal pure returns (uint256, uint256) {
            return
                convertCollateralData(tokenData0, tokenData1, tokenType, Math.getSqrtRatioAtTick(tick));
        }
    
        /// @notice Compute the notional amount given an incoming total number of `contracts` deployed between `tickLower` and `tickUpper`.
        /// @dev The notional value of an option is the value of the crypto assets that are controlled (rather than the cost of the transaction).
        /// @dev Example: Notional value in an option refers to the value that the option controls.
        /// @dev For example, token ABC is trading for $20 with a particular ABC call option costing $1.50.
        /// @dev One option controls 100 underlying tokens. A trader purchases the option for $1.50 x 100 = $150.
        /// @dev The notional value of the option is $20 x 100 = $2,000 --> (underlying price) * (contract/position size).
        /// @dev Thus, `contracts` refer to "100" in this example. The $20 is the strike price. We get the strike price from `tickLower` and `tickUpper`.
        /// @dev From TradFi: [https://www.investopedia.com/terms/n/notionalvalue.asp](https://www.investopedia.com/terms/n/notionalvalue.asp).
        /// @param contractSize The total number of contracts (position size) between `tickLower` and `tickUpper
        /// @param tickLower The lower price tick of the position. The strike price can be recovered from this + `tickUpper`
        /// @param tickUpper The upper price tick of the position. The strike price can be recovered from this + `tickLower`
        /// @param asset The asset for that leg (token0=0, token1=1)
        /// @return The notional value of the option position
        function convertNotional(
            uint128 contractSize,
            int24 tickLower,
            int24 tickUpper,
            uint256 asset
        ) internal pure returns (uint128) {
            unchecked {
                uint256 notional = asset == 0
                    ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))
                    : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));
    
                if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();
    
                return uint128(notional);
            }
        }
    
        /// @notice Convert an amount of token0 into an amount of token1 given the sqrtPriceX96 in a Uniswap pool defined as sqrt(1/0)*2^96.
        /// @dev Uses reduced precision after tick 443636 in order to accomodate the full range of tick.s
        /// @param amount The amount of token0 to convert into token1
        /// @param sqrtPriceX96 The square root of the price at which to convert `amount` of token0 into token1
        /// @return The converted `amount` of token0 represented in terms of token1
        function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {
            unchecked {
                // the tick 443636 is the maximum price where (price) * 2**192 fits into a uint256 (< 2**256-1)
                // above that tick, we are forced to reduce the amount of decimals in the final price by 2**64 to 2**128
                if (sqrtPriceX96 < type(uint128).max) {
                    return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);
                } else {
                    return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                }
            }
        }
    
        /// @notice Convert an amount of token1 into an amount of token0 given the sqrtPriceX96 in a Uniswap pool defined as sqrt(1/0)*2^96.
        /// @dev Uses reduced precision after tick 443636 in order to accomodate the full range of ticks.
        /// @param amount The amount of token1 to convert into token0
        /// @param sqrtPriceX96 The square root of the price at which to convert `amount` of token1 into token0
        /// @return The converted `amount` of token1 represented in terms of token0
        function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {
            unchecked {
                // the tick 443636 is the maximum price where (price) * 2**192 fits into a uint256 (< 2**256-1)
                // above that tick, we are forced to reduce the amount of decimals in the final price by 2**64 to 2**128
                if (sqrtPriceX96 < type(uint128).max) {
                    return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);
                } else {
                    return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                }
            }
        }
    
        /// @notice Convert an amount of token0 into an amount of token1 given the sqrtPriceX96 in a Uniswap pool defined as sqrt(1/0)*2^96.
        /// @dev Uses reduced precision after tick 443636 in order to accomodate the full range of ticks.
        /// @param amount The amount of token0 to convert into token1
        /// @param sqrtPriceX96 The square root of the price at which to convert `amount` of token0 into token1
        /// @return The converted `amount` of token0 represented in terms of token1
        function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {
            unchecked {
                // the tick 443636 is the maximum price where (price) * 2**192 fits into a uint256 (< 2**256-1)
                // above that tick, we are forced to reduce the amount of decimals in the final price by 2**64 to 2**128
                if (sqrtPriceX96 < type(uint128).max) {
                    int256 absResult = Math
                        .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)
                        .toInt256();
                    return amount < 0 ? -absResult : absResult;
                } else {
                    int256 absResult = Math
                        .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))
                        .toInt256();
                    return amount < 0 ? -absResult : absResult;
                }
            }
        }
    
        /// @notice Convert an amount of token0 into an amount of token1 given the sqrtPriceX96 in a Uniswap pool defined as sqrt(1/0)*2^96.
        /// @dev Uses reduced precision after tick 443636 in order to accomodate the full range of ticks.
        /// @param amount The amount of token0 to convert into token1
        /// @param sqrtPriceX96 The square root of the price at which to convert `amount` of token0 into token1
        /// @return The converted `amount` of token0 represented in terms of token1
        function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {
            unchecked {
                // the tick 443636 is the maximum price where (price) * 2**192 fits into a uint256 (< 2**256-1)
                // above that tick, we are forced to reduce the amount of decimals in the final price by 2**64 to 2**128
                if (sqrtPriceX96 < type(uint128).max) {
                    int256 absResult = Math
                        .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)
                        .toInt256();
                    return amount < 0 ? -absResult : absResult;
                } else {
                    int256 absResult = Math
                        .mulDiv(
                            Math.absUint(amount),
                            2 ** 128,
                            Math.mulDiv64(sqrtPriceX96, sqrtPriceX96)
                        )
                        .toInt256();
                    return amount < 0 ? -absResult : absResult;
                }
            }
        }
    
        /// @notice Compute the amount of token0 and token1 moved. Given an option position `tokenId`, leg index `legIndex`, and how many contracts are in the leg `positionSize`.
        /// @param tokenId The option position identifier
        /// @param positionSize The number of option contracts held in this position (each contract can control multiple tokens)
        /// @param legIndex The leg index of the option contract, can be {0,1,2,3}
        /// @return A LeftRight encoded variable containing the amount0 and the amount1 value controlled by this option position's leg
        function getAmountsMoved(
            TokenId tokenId,
            uint128 positionSize,
            uint256 legIndex
        ) internal pure returns (LeftRightUnsigned) {
            // get the tick range for this leg in order to get the strike price (the underlying price)
            (int24 tickLower, int24 tickUpper) = tokenId.asTicks(legIndex);
    
            uint128 amount0;
            uint128 amount1;
            if (tokenId.asset(legIndex) == 0) {
                amount0 = positionSize * uint128(tokenId.optionRatio(legIndex));
    
                amount1 = Math
                    .getAmount1ForLiquidity(Math.getLiquidityForAmount0(tickLower, tickUpper, amount0))
                    .toUint128();
            } else {
                amount1 = positionSize * uint128(tokenId.optionRatio(legIndex));
    
                amount0 = Math
                    .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))
                    .toUint128();
            }
    
            return LeftRightUnsigned.wrap(0).toRightSlot(amount0).toLeftSlot(amount1);
        }
    
        /// @notice Compute the amount of funds that are moved to and removed from the Panoptic Pool.
        /// @param tokenId The option position identifier
        /// @param positionSize The number of positions minted
        /// @param legIndex The leg index minted in this position, can be {0,1,2,3}
        /// @return longs A LeftRight-packed word containing the total amount of long positions
        /// @return shorts A LeftRight-packed word containing the amount of short positions
        function _calculateIOAmounts(
            TokenId tokenId,
            uint128 positionSize,
            uint256 legIndex
        ) internal pure returns (LeftRightSigned longs, LeftRightSigned shorts) {
            // compute amounts moved
            LeftRightUnsigned amountsMoved = getAmountsMoved(tokenId, positionSize, legIndex);
    
            bool isShort = tokenId.isLong(legIndex) == 0;
    
            // if token0
            if (tokenId.tokenType(legIndex) == 0) {
                if (isShort) {
                    // if option is short, increment shorts by contracts
                    shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                } else {
                    // is option is long, increment longs by contracts
                    longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                }
            } else {
                if (isShort) {
                    // if option is short, increment shorts by notional
                    shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                } else {
                    // if option is long, increment longs by notional
                    longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                }
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                           REVOKE/REFUND COMPUTATIONS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Check that the account is liquidatable, get the split of bonus0 and bonus1 amounts.
        /// @param tokenData0 Leftright encoded word with balance of token0 in the right slot, and required balance in left slot
        /// @param tokenData1 Leftright encoded word with balance of token1 in the right slot, and required balance in left slot
        /// @param sqrtPriceX96Twap The sqrt(price) of the TWAP tick before liquidation used to evaluate solvency
        /// @param sqrtPriceX96Final The current sqrt(price) of the AMM after liquidating a user
        /// @param netExchanged The net exchanged value of the closed portfolio
        /// @param premia Premium across all positions being liquidated present in tokenData
        /// @return bonus0 Bonus amount for token0
        /// @return bonus1 Bonus amount for token1
        /// @return The LeftRight-packed protocol loss for both tokens, i.e., the delta between the user's balance and expended tokens
        function getLiquidationBonus(
            LeftRightUnsigned tokenData0,
            LeftRightUnsigned tokenData1,
            uint160 sqrtPriceX96Twap,
            uint160 sqrtPriceX96Final,
            LeftRightSigned netExchanged,
            LeftRightSigned premia
        ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {
            unchecked {
                // compute bonus as min(collateralBalance/2, required-collateralBalance)
                {
                    // compute the ratio of token0 to total collateral requirements
                    // evaluate at TWAP price to keep consistentcy with solvency calculations
                    uint256 required0 = PanopticMath.convert0to1(
                        tokenData0.leftSlot(),
                        sqrtPriceX96Twap
                    );
                    uint256 required1 = tokenData1.leftSlot();
                    uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);
    
                    (uint256 balanceCross, uint256 thresholdCross) = PanopticMath.convertCollateralData(
                        tokenData0,
                        tokenData1,
                        0,
                        sqrtPriceX96Twap
                    );
    
                    uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);
    
                    // convert that bonus to tokens 0 and 1
                    bonus0 = int256(Math.mulDiv128(bonusCross, requiredRatioX128));
    
                    bonus1 = int256(
                        PanopticMath.convert0to1(
                            Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),
                            sqrtPriceX96Final
                        )
                    );
                }
    
                // negative premium (owed to the liquidatee) is credited to the collateral balance
                // this is already present in the netExchanged amount, so to avoid double-counting we remove it from the balance
                int256 balance0 = int256(uint256(tokenData0.rightSlot())) -
                    Math.max(premia.rightSlot(), 0);
                int256 balance1 = int256(uint256(tokenData1.rightSlot())) -
                    Math.max(premia.leftSlot(), 0);
    
                int256 paid0 = bonus0 + int256(netExchanged.rightSlot());
                int256 paid1 = bonus1 + int256(netExchanged.leftSlot());
    
                // note that "balance0" and "balance1" are the liquidatee's original balances before token delegation by a liquidator
                // their actual balances at the time of computation may be higher, but these are a buffer representing the amount of tokens we
                // have to work with before cutting into the liquidator's funds
                if (!(paid0 > balance0 && paid1 > balance1)) {
                    // liquidatee cannot pay back the liquidator fully in either token, so no protocol loss can be avoided
                    if ((paid0 > balance0)) {
                        // liquidatee has insufficient token0 but some token1 left over, so we use what they have left to mitigate token0 losses
                        // we do this by substituting an equivalent value of token1 in our refund to the liquidator, plus a bonus, for the token0 we convert
                        // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                        // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token1 balance: balance1 - paid1
                        // and paid0 - balance0 is the amount of token0 that the liquidatee is missing, i.e the protocol loss
                        // if the protocol loss is lower than the excess token1 balance, then we can fully mitigate the loss and we should only convert the loss amount
                        // if the protocol loss is higher than the excess token1 balance, we can only mitigate part of the loss, so we should convert only the excess token1 balance
                        // thus, the value converted should be min(balance1 - paid1, paid0 - balance0)
                        bonus1 += Math.min(
                            balance1 - paid1,
                            PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)
                        );
                        bonus0 -= Math.min(
                            PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),
                            paid0 - balance0
                        );
                    }
                    if ((paid1 > balance1)) {
                        // liquidatee has insufficient token1 but some token0 left over, so we use what they have left to mitigate token1 losses
                        // we do this by substituting an equivalent value of token0 in our refund to the liquidator, plus a bonus, for the token1 we convert
                        // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                        // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token0 balance: balance0 - paid0
                        // and paid1 - balance1 is the amount of token1 that the liquidatee is missing, i.e the protocol loss
                        // if the protocol loss is lower than the excess token0 balance, then we can fully mitigate the loss and we should only convert the loss amount
                        // if the protocol loss is higher than the excess token0 balance, we can only mitigate part of the loss, so we should convert only the excess token0 balance
                        // thus, the value converted should be min(balance0 - paid0, paid1 - balance1)
                        bonus0 += Math.min(
                            balance0 - paid0,
                            PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)
                        );
                        bonus1 -= Math.min(
                            PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),
                            paid1 - balance1
                        );
                    }
                }
    
                paid0 = bonus0 + int256(netExchanged.rightSlot());
                paid1 = bonus1 + int256(netExchanged.leftSlot());
                return (
                    bonus0,
                    bonus1,
                    LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(
                        int128(balance1 - paid1)
                    )
                );
            }
        }
    
        /// @notice Haircut/clawback any premium paid by `liquidatee` on `positionIdList` over the protocol loss threshold during a liquidation.
        /// @dev Note that the storage mapping provided as the `settledTokens` parameter WILL be modified on the caller by this function.
        /// @param liquidatee The address of the user being liquidated
        /// @param positionIdList The list of position ids being liquidated
        /// @param premiasByLeg The premium paid (or received) by the liquidatee for each leg of each position
        /// @param collateralRemaining The remaining collateral after the liquidation (negative if protocol loss)
        /// @param sqrtPriceX96Final The sqrt price at which to convert between token0/token1 when awarding the bonus
        /// @param collateral0 The collateral tracker for token0
        /// @param collateral1 The collateral tracker for token1
        /// @param settledTokens The per-chunk accumulator of settled tokens in storage from which to subtract the haircut premium
        /// @return The delta in bonus0 for the liquidator post-haircut
        /// @return The delta in bonus1 for the liquidator post-haircut
        function haircutPremia(
            address liquidatee,
            TokenId[] memory positionIdList,
            LeftRightSigned[4][] memory premiasByLeg,
            LeftRightSigned collateralRemaining,
            CollateralTracker collateral0,
            CollateralTracker collateral1,
            uint160 sqrtPriceX96Final,
            mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
        ) external returns (int256, int256) {
            unchecked {
                // get the amount of premium paid by the liquidatee
                LeftRightSigned longPremium;
                for (uint256 i = 0; i < positionIdList.length; ++i) {
                    TokenId tokenId = positionIdList[i];
                    uint256 numLegs = tokenId.countLegs();
                    for (uint256 leg = 0; leg < numLegs; ++leg) {
                        if (tokenId.isLong(leg) == 1) {
                            longPremium = longPremium.sub(premiasByLeg[i][leg]);
                        }
                    }
                }
                // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
                int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
                int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
                int256 haircut0;
                int256 haircut1;
                // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
                // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
                if (
                    longPremium.rightSlot() < collateralDelta0 &&
                    longPremium.leftSlot() > collateralDelta1
                ) {
                    int256 protocolLoss1 = collateralDelta1;
                    (collateralDelta0, collateralDelta1) = (
                        -Math.min(
                            collateralDelta0 - longPremium.rightSlot(),
                            PanopticMath.convert1to0(
                                longPremium.leftSlot() - collateralDelta1,
                                sqrtPriceX96Final
                            )
                        ),
                        Math.min(
                            longPremium.leftSlot() - collateralDelta1,
                            PanopticMath.convert0to1(
                                collateralDelta0 - longPremium.rightSlot(),
                                sqrtPriceX96Final
                            )
                        )
                    );
    
                    haircut0 = longPremium.rightSlot();
                    haircut1 = protocolLoss1 + collateralDelta1;
                } else if (
                    longPremium.leftSlot() < collateralDelta1 &&
                    longPremium.rightSlot() > collateralDelta0
                ) {
                    int256 protocolLoss0 = collateralDelta0;
                    (collateralDelta0, collateralDelta1) = (
                        Math.min(
                            longPremium.rightSlot() - collateralDelta0,
                            PanopticMath.convert1to0(
                                collateralDelta1 - longPremium.leftSlot(),
                                sqrtPriceX96Final
                            )
                        ),
                        -Math.min(
                            collateralDelta1 - longPremium.leftSlot(),
                            PanopticMath.convert0to1(
                                longPremium.rightSlot() - collateralDelta0,
                                sqrtPriceX96Final
                            )
                        )
                    );
    
                    haircut0 = collateralDelta0 + protocolLoss0;
                    haircut1 = longPremium.leftSlot();
                } else {
                    // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
                    haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
                    haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
    
                    collateralDelta0 = 0;
                    collateralDelta1 = 0;
                }
    
                {
                    address _liquidatee = liquidatee;
                    if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
                    if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
                }
    
                for (uint256 i = 0; i < positionIdList.length; i++) {
                    TokenId tokenId = positionIdList[i];
                    LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
                    for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
                        if (tokenId.isLong(leg) == 1) {
                            mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
                                storage _settledTokens = settledTokens;
    
                            // calculate amounts to revoke from settled and subtract from haircut req
                            uint256 settled0 = Math.unsafeDivRoundingUp(
                                uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
                                uint128(longPremium.rightSlot())
                            );
                            uint256 settled1 = Math.unsafeDivRoundingUp(
                                uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
                                uint128(longPremium.leftSlot())
                            );
    
                            bytes32 chunkKey = keccak256(
                                abi.encodePacked(
                                    tokenId.strike(0),
                                    tokenId.width(0),
                                    tokenId.tokenType(0)
                                )
                            );
    
                            // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
                            // for the haircut directly to the accumulator
                            settled0 = Math.max(
                                0,
                                uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
                            );
                            settled1 = Math.max(
                                0,
                                uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
                            );
    
                            _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
                                LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
                                    uint128(settled1)
                                )
                            );
                        }
                    }
                }
    
                return (collateralDelta0, collateralDelta1);
            }
        }
    
        /// @notice Returns the original delegated value to a user at a certain tick based on the available collateral from the exercised user.
        /// @param refunder Address of the user the refund is coming from (the force exercisee)
        /// @param refundValues Token values to refund at the given tick(atTick) rightSlot = token0 left = token1
        /// @param atTick Tick to convert values at. This can be the current tick or some TWAP/median tick
        /// @param collateral0 CollateralTracker for token0
        /// @param collateral1 CollateralTracker for token1
        /// @return The LeftRight-packed amount of token0/token1 to refund to the user.
        function getRefundAmounts(
            address refunder,
            LeftRightSigned refundValues,
            int24 atTick,
            CollateralTracker collateral0,
            CollateralTracker collateral1
        ) external view returns (LeftRightSigned) {
            uint160 sqrtPriceX96 = Math.getSqrtRatioAtTick(atTick);
            unchecked {
                // if the refunder lacks sufficient token0 to pay back the refundee, have them pay back the equivalent value in token1
                // note: it is possible for refunds to be negative when the exercise fee is higher than the delegated amounts. This is expected behavior
                int256 balanceShortage = refundValues.rightSlot() -
                    int256(collateral0.convertToAssets(collateral0.balanceOf(refunder)));
    
                if (balanceShortage > 0) {
                    return
                        LeftRightSigned
                            .wrap(0)
                            .toRightSlot(int128(refundValues.rightSlot() - balanceShortage))
                            .toLeftSlot(
                                int128(
                                    int256(
                                        PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)
                                    ) + refundValues.leftSlot()
                                )
                            );
                }
    
                balanceShortage =
                    refundValues.leftSlot() -
                    int256(collateral1.convertToAssets(collateral1.balanceOf(refunder)));
    
                if (balanceShortage > 0) {
                    return
                        LeftRightSigned
                            .wrap(0)
                            .toLeftSlot(int128(refundValues.leftSlot() - balanceShortage))
                            .toRightSlot(
                                int128(
                                    int256(
                                        PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)
                                    ) + refundValues.rightSlot()
                                )
                            );
                }
            }
    
            // otherwise, we can just refund the original amounts requested with no problems
            return refundValues;
        }
    }

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L967))
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {
        /*//////////////////////////////////////////////////////////////
                                ERC20 OPERATIONS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Safely transfers ERC20 tokens from one address to another.
        /// @param token The address of the ERC20 token
        /// @param from The address to transfer tokens from
        /// @param to The address to transfer tokens to
        /// @param amount The amount of tokens to transfer
        function safeTransferFrom(address token, address from, address to, uint256 amount) internal {
            bool success;
    
            assembly ("memory-safe") {
                // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
                let p := mload(0x40)
    
                // Write the abi-encoded calldata into memory, beginning with the function selector.
                mstore(p, 0x23b872dd00000000000000000000000000000000000000000000000000000000)
                mstore(add(4, p), from) // Append the "from" argument.
                mstore(add(36, p), to) // Append the "to" argument.
                mstore(add(68, p), amount) // Append the "amount" argument.
    
                success := and(
                    // Set success to whether the call reverted, if not we check it either
                    // returned exactly 1 (can't just be non-zero data), or had no return data.
                    or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
                    // We use 100 because that's the total length of our calldata (4 + 32 * 3)
                    // Counterintuitively, this call() must be positioned after the or() in the
                    // surrounding and() because and() evaluates its arguments from right to left.
                    call(gas(), token, 0, p, 100, 0, 32)
                )
            }
    
            if (!success) revert Errors.TransferFailed();
        }
    
        /// @notice Safely transfers ERC20 tokens to a specified address.
        /// @param token The address of the ERC20 token
        /// @param to The address to transfer tokens to
        /// @param amount The amount of tokens to transfer
        function safeTransfer(address token, address to, uint256 amount) internal {
            bool success;
    
            assembly ("memory-safe") {
                // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
                let p := mload(0x40)
    
                // Write the abi-encoded calldata into memory, beginning with the function selector.
                mstore(p, 0xa9059cbb00000000000000000000000000000000000000000000000000000000)
                mstore(add(4, p), to) // Append the "to" argument.
                mstore(add(36, p), amount) // Append the "amount" argument.
    
                success := and(
                    // Set success to whether the call reverted, if not we check it either
                    // returned exactly 1 (can't just be non-zero data), or had no return data.
                    or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
                    // We use 68 because that's the total length of our calldata (4 + 32 * 2)
                    // Counterintuitively, this call() must be positioned after the or() in the
                    // surrounding and() because and() evaluates its arguments from right to left.
                    call(gas(), token, 0, p, 68, 0, 32)
                )
            }
    
            if (!success) revert Errors.TransferFailed();
        }
    }

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L77))
```solidity
File: contracts/multicall/Multicall.sol

8: abstract contract Multicall {
       /// @notice Performs multiple calls on the inheritor in a single transaction, and returns the data from each call.
       /// @param data The calldata for each call
       /// @return results The data returned by each call
       function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {
           results = new bytes[](data.length);
           for (uint256 i = 0; i < data.length; ) {
               (bool success, bytes memory result) = address(this).delegatecall(data[i]);
   
               if (!success) {
                   // Bubble up the revert reason
                   // The bytes type is ABI encoded as a length-prefixed byte array
                   // So we simply need to add 32 to the pointer to get the start of the data
                   // And then revert with the size loaded from the first 32 bytes
                   // Other solutions will do work to differentiate the revert reasons and provide paranthetical information
                   // However, we have chosen to simply replicate the the normal behavior of the call
                   // NOTE: memory-safe because it reads from memory already allocated by solidity (the bytes memory result)
                   assembly ("memory-safe") {
                       revert(add(result, 32), mload(result))
                   }
               }
   
               results[i] = result;
   
               unchecked {
                   ++i;
               }
           }
       }
   }

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L37))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {
        /*//////////////////////////////////////////////////////////////
                                     EVENTS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Emitted when only a single token is transferred.
        /// @param operator The user who initiated the transfer
        /// @param from The user who sent the tokens
        /// @param to The user who received the tokens
        /// @param id The ERC1155 token id
        /// @param amount The amount of tokens transferred
        event TransferSingle(
            address indexed operator,
            address indexed from,
            address indexed to,
            uint256 id,
            uint256 amount
        );
    
        /// @notice Emitted when multiple tokens are transferred from one user to another.
        /// @param operator The user who initiated the transfer
        /// @param from The user who sent the tokens
        /// @param to The user who received the tokens
        /// @param ids The ERC1155 token ids
        /// @param amounts The amounts of tokens transferred
        event TransferBatch(
            address indexed operator,
            address indexed from,
            address indexed to,
            uint256[] ids,
            uint256[] amounts
        );
    
        /// @notice Emitted when the approval status of an operator to transfer all tokens on behalf of a user is modified.
        /// @param owner The user who approved or disapproved `operator` to transfer their tokens
        /// @param operator The user who was approved or disapproved to transfer all tokens on behalf of `owner`
        /// @param approved Whether `operator` is approved or disapproved to transfer all tokens on behalf of `owner`
        event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
    
        /*//////////////////////////////////////////////////////////////
                                     ERRORS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Emitted when a user attempts to transfer tokens they do not own nor are approved to transfer.
        error NotAuthorized();
    
        /// @notice Emitted when an attempt is made to initiate a transfer to a contract recipient that fails to signal support for ERC1155.
        error UnsafeRecipient();
    
        /*//////////////////////////////////////////////////////////////
                                 ERC1155 STORAGE
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Token balances for each user.
        /// @dev Indexed by user, then by token id.
        mapping(address account => mapping(uint256 tokenId => uint256 balance)) public balanceOf;
    
        /// @notice Approved addresses for each user.
        /// @dev Indexed by user, then by operator.
        /// @dev Operator is approved to transfer all tokens on behalf of user.
        mapping(address owner => mapping(address operator => bool approvedForAll))
            public isApprovedForAll;
    
        /*//////////////////////////////////////////////////////////////
                                  ERC1155 LOGIC
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Approve or revoke approval for `operator` to transfer all tokens on behalf of the caller.
        /// @param operator The address to approve or revoke approval for
        /// @param approved True to approve, false to revoke approval
        function setApprovalForAll(address operator, bool approved) public {
            isApprovedForAll[msg.sender][operator] = approved;
    
            emit ApprovalForAll(msg.sender, operator, approved);
        }
    
        /// @notice Transfer a single token from one user to another.
        /// @dev Supports approved token transfers.
        /// @param from The user to transfer tokens from
        /// @param to The user to transfer tokens to
        /// @param id The ERC1155 token id to transfer
        /// @param amount The amount of tokens to transfer
        /// @param data Optional data to include in the `onERC1155Received` hook
        function safeTransferFrom(
            address from,
            address to,
            uint256 id,
            uint256 amount,
            bytes calldata data
        ) public virtual {
            if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
    
            balanceOf[from][id] -= amount;
    
            // balance will never overflow
            unchecked {
                balanceOf[to][id] += amount;
            }
    
            emit TransferSingle(msg.sender, from, to, id, amount);
    
            if (to.code.length != 0) {
                if (
                    ERC1155Holder(to).onERC1155Received(msg.sender, from, id, amount, data) !=
                    ERC1155Holder.onERC1155Received.selector
                ) {
                    revert UnsafeRecipient();
                }
            }
        }
    
        /// @notice Transfer multiple tokens from one user to another.
        /// @dev Supports approved token transfers.
        /// @dev `ids` and `amounts` must be of equal length.
        /// @param from The user to transfer tokens from
        /// @param to The user to transfer tokens to
        /// @param ids The ERC1155 token ids to transfer
        /// @param amounts The amounts of tokens to transfer
        /// @param data Optional data to include in the `onERC1155Received` hook
        function safeBatchTransferFrom(
            address from,
            address to,
            uint256[] calldata ids,
            uint256[] calldata amounts,
            bytes calldata data
        ) public virtual {
            if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
    
            // Storing these outside the loop saves ~15 gas per iteration.
            uint256 id;
            uint256 amount;
    
            for (uint256 i = 0; i < ids.length; ) {
                id = ids[i];
                amount = amounts[i];
    
                balanceOf[from][id] -= amount;
    
                // balance will never overflow
                unchecked {
                    balanceOf[to][id] += amount;
                }
    
                // An array can't have a total length
                // larger than the max uint256 value.
                unchecked {
                    ++i;
                }
            }
    
            emit TransferBatch(msg.sender, from, to, ids, amounts);
    
            if (to.code.length != 0) {
                if (
                    ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
                    ERC1155Holder.onERC1155BatchReceived.selector
                ) {
                    revert UnsafeRecipient();
                }
            }
        }
    
        /// @notice Query balances for multiple users and tokens at once.
        /// @dev `owners` and `ids` should be of equal length
        /// @param owners The list of users to query balances for
        /// @param ids The list of ERC1155 token ids to query
        /// @return balances The balances for each owner-id pair in the same order as the input arrays
        function balanceOfBatch(
            address[] calldata owners,
            uint256[] calldata ids
        ) public view returns (uint256[] memory balances) {
            balances = new uint256[](owners.length);
    
            // Unchecked because the only math done is incrementing
            // the array index counter which cannot possibly overflow.
            unchecked {
                for (uint256 i = 0; i < owners.length; ++i) {
                    balances[i] = balanceOf[owners[i]][ids[i]];
                }
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                  ERC165 LOGIC
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Signal support for ERC165 and ERC1155.
        /// @param interfaceId The interface to check for support
        /// @return Whether the interface is supported
        function supportsInterface(bytes4 interfaceId) public pure returns (bool) {
            return
                interfaceId == 0x01ffc9a7 || // ERC165 Interface ID for ERC165
                interfaceId == 0xd9b67a26; // ERC165 Interface ID for ERC1155
        }
    
        /*//////////////////////////////////////////////////////////////
                            INTERNAL MINT/BURN LOGIC
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Internal utility to mint tokens to a user's account.
        /// @param to The user to mint tokens to
        /// @param id The ERC1155 token id to mint
        /// @param amount The amount of tokens to mint
        function _mint(address to, uint256 id, uint256 amount) internal {
            // balance will never overflow
            unchecked {
                balanceOf[to][id] += amount;
            }
    
            emit TransferSingle(msg.sender, address(0), to, id, amount);
    
            if (to.code.length != 0) {
                if (
                    ERC1155Holder(to).onERC1155Received(msg.sender, address(0), id, amount, "") !=
                    ERC1155Holder.onERC1155Received.selector
                ) {
                    revert UnsafeRecipient();
                }
            }
        }
    
        /// @notice Internal utility to burn tokens from a user's account.
        /// @param from The user to burn tokens from
        /// @param id The ERC1155 token id to mint
        /// @param amount The amount of tokens to burn
        function _burn(address from, uint256 id, uint256 amount) internal {
            balanceOf[from][id] -= amount;
    
            emit TransferSingle(msg.sender, from, address(0), id, amount);
        }
    }

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L241))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {
       /*//////////////////////////////////////////////////////////////
                                    EVENTS
       //////////////////////////////////////////////////////////////*/
   
       /// @notice Emitted when tokens are transferred
       /// @param from The sender of the tokens
       /// @param to The recipient of the tokens
       /// @param amount The amount of tokens transferred
       event Transfer(address indexed from, address indexed to, uint256 amount);
   
       /// @notice Emitted when a user approves another user to spend tokens on their behalf
       /// @param owner The user who approved the spender
       /// @param spender The user who was approved to spend tokens
       /// @param amount The amount of tokens approved to spend
       event Approval(address indexed owner, address indexed spender, uint256 amount);
   
       /*//////////////////////////////////////////////////////////////
                                 ERC20 STORAGE
       //////////////////////////////////////////////////////////////*/
   
       /// @notice The total supply of tokens.
       /// @dev This cannot exceed the max uint256 value.
       uint256 public totalSupply;
   
       /// @notice Token balances for each user
       mapping(address account => uint256 balance) public balanceOf;
   
       /// @notice Stored allowances for each user.
       /// @dev Indexed by owner, then by spender.
       mapping(address owner => mapping(address spender => uint256 allowance)) public allowance;
   
       /*//////////////////////////////////////////////////////////////
                                  ERC20 LOGIC
       //////////////////////////////////////////////////////////////*/
   
       /// @notice Approves a user to spend tokens on the caller's behalf.
       /// @param spender The user to approve
       /// @param amount The amount of tokens to approve
       /// @return Whether the approval succeeded
       function approve(address spender, uint256 amount) public returns (bool) {
           allowance[msg.sender][spender] = amount;
   
           emit Approval(msg.sender, spender, amount);
   
           return true;
       }
   
       /// @notice Transfers tokens from the caller to another user.
       /// @param to The user to transfer tokens to
       /// @param amount The amount of tokens to transfer
       /// @return Whether the transfer succeeded
       function transfer(address to, uint256 amount) public virtual returns (bool) {
           balanceOf[msg.sender] -= amount;
   
           // Cannot overflow because the sum of all user
           // balances can't exceed the max uint256 value.
           unchecked {
               balanceOf[to] += amount;
           }
   
           emit Transfer(msg.sender, to, amount);
   
           return true;
       }
   
       /// @notice Transfers tokens from one user to another.
       /// @dev Supports token approvals.
       /// @param from The user to transfer tokens from
       /// @param to The user to transfer tokens to
       /// @param amount The amount of tokens to transfer
       /// @return Whether the transfer succeeded
       function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {
           uint256 allowed = allowance[from][msg.sender]; // Saves gas for limited approvals.
   
           if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;
   
           balanceOf[from] -= amount;
   
           // Cannot overflow because the sum of all user
           // balances can't exceed the max uint256 value.
           unchecked {
               balanceOf[to] += amount;
           }
   
           emit Transfer(from, to, amount);
   
           return true;
       }
   
       /// @notice Internal utility to transfer tokens from one user to another.
       /// @param from The user to transfer tokens from
       /// @param to The user to transfer tokens to
       /// @param amount The amount of tokens to transfer
       function _transferFrom(address from, address to, uint256 amount) internal {
           balanceOf[from] -= amount;
   
           // Cannot overflow because the sum of all user
           // balances can't exceed the max uint256 value.
           unchecked {
               balanceOf[to] += amount;
           }
   
           emit Transfer(from, to, amount);
       }
   
       /*//////////////////////////////////////////////////////////////
                           INTERNAL MINT/BURN LOGIC
       //////////////////////////////////////////////////////////////*/
   
       /// @notice Internal utility to mint tokens to a user's account.
       /// @param to The user to mint tokens to
       /// @param amount The amount of tokens to mint
       function _mint(address to, uint256 amount) internal {
           // Cannot overflow because the sum of all user
           // balances can't exceed the max uint256 value.
           unchecked {
               balanceOf[to] += amount;
           }
           totalSupply += amount;
   
           emit Transfer(address(0), to, amount);
       }
   
       /// @notice Internal utility to burn tokens from a user's account.
       /// @param from The user to burn tokens from
       /// @param amount The amount of tokens to burn
       function _burn(address from, uint256 amount) internal {
           balanceOf[from] -= amount;
   
           // Cannot underflow because a user's balance
           // will never be larger than the total supply.
           unchecked {
               totalSupply -= amount;
           }
   
           emit Transfer(from, address(0), amount);
       }
   }

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L147))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {
       /// @notice Called to issue reward NFT to the deployer of a new `PanopticPool` through `PanopticFactory`.
       /// @param deployer The address that deployed `newPoolContract` and donated funds for full-range liquidity
       /// @param newPoolContract The address of the `PanopticPool` that was deployed
       /// @param token0 Token0 of the Uniswap pool `newPoolContract` was deployed on
       /// @param token1 Token1 of the Uniswap pool `newPoolContract` was deployed on
       /// @param fee The fee tier, in hundredths of bips, of the Uniswap pool `newPoolContract` was deployed on
       function issueNFT(
           address deployer,
           PanopticPool newPoolContract,
           address token0,
           address token1,
           uint24 fee
       ) external;
   }

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L20))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {
        /// @notice Returns the amount of tokens owned by `account`.
        /// @dev This function is unchanged from the EIP
        /// @param account The address to query the balance of
        /// @return The amount of tokens owned by `account`
        function balanceOf(address account) external view returns (uint256);
    
        /// @notice Sets `amount` as the allowance of `spender` over the caller's tokens.
        /// @dev While this function is specified to return a boolean value in the EIP, this interface does not expect one
        /// @param spender The address which will spend the funds
        /// @param amount The amount of tokens allowed to be spent
        function approve(address spender, uint256 amount) external;
    
        /// @notice Transfers tokens from the caller to another user.
        /// @param to The user to transfer tokens to
        /// @param amount The amount of tokens to transfer
        function transfer(address to, uint256 amount) external;
    }

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L28))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {
        // Used for safecasting
        using Math for uint256;
    
        /// @notice AND bitmask to isolate the right half of a uint256
        uint256 internal constant LEFT_HALF_BIT_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000;
    
        /// @notice AND bitmask to isolate the left half of an int256
        int256 internal constant LEFT_HALF_BIT_MASK_INT =
            int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));
    
        /// @notice AND bitmask to isolate the left half of an int256
        int256 internal constant RIGHT_HALF_BIT_MASK = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
    
        /*//////////////////////////////////////////////////////////////
                                   RIGHT SLOT
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Get the "right" slot from a bit pattern.
        /// @param self The 256 bit value to extract the right half from
        /// @return The right half of `self`
        function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {
            return uint128(LeftRightUnsigned.unwrap(self));
        }
    
        /// @notice Get the "right" slot from a bit pattern.
        /// @param self The 256 bit value to extract the right half from
        /// @return The right half of `self`
        function rightSlot(LeftRightSigned self) internal pure returns (int128) {
            return int128(LeftRightSigned.unwrap(self));
        }
    
        // All toRightSlot functions add bits to the right slot without clearing it first
        // Typically, the slot is already clear when writing to it, but if it is not, the bits will be added to the existing bits
        // Therefore, the assumption must not be made that the bits will be cleared while using these helpers
        // Note that the values *within* the slots are allowed to overflow, but overflows are contained and will not leak into the other slot
    
        /// @notice Add to the "right" slot in a 256-bit pattern.
        /// @param self The 256-bit pattern to be written to
        /// @param right The value to be added to the right slot
        /// @return `self` with `right` added (not overwritten, but added) to the value in its right 128 bits
        function toRightSlot(
            LeftRightUnsigned self,
            uint128 right
        ) internal pure returns (LeftRightUnsigned) {
            unchecked {
                // prevent the right slot from leaking into the left one in the case of an overflow
                // ff + 1 = (1)00, but we want just ff + 1 = 00
                return
                    LeftRightUnsigned.wrap(
                        (LeftRightUnsigned.unwrap(self) & LEFT_HALF_BIT_MASK) +
                            uint256(uint128(LeftRightUnsigned.unwrap(self)) + right)
                    );
            }
        }
    
        /// @notice Add to the "right" slot in a 256-bit pattern.
        /// @param self The 256-bit pattern to be written to
        /// @param right The value to be added to the right slot
        /// @return `self` with `right` added (not overwritten, but added) to the value in its right 128 bits
        function toRightSlot(
            LeftRightSigned self,
            int128 right
        ) internal pure returns (LeftRightSigned) {
            // bit mask needed in case rightHalfBitPattern < 0 due to 2's complement
            unchecked {
                // prevent the right slot from leaking into the left one in the case of a positive sign change
                // ff + 1 = (1)00, but we want just ff + 1 = 00
                return
                    LeftRightSigned.wrap(
                        (LeftRightSigned.unwrap(self) & LEFT_HALF_BIT_MASK_INT) +
                            (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)
                    );
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                   LEFT SLOT
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Get the "left" slot from a bit pattern.
        /// @param self The 256 bit value to extract the left half from
        /// @return The left half of `self`
        function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {
            return uint128(LeftRightUnsigned.unwrap(self) >> 128);
        }
    
        /// @notice Get the "left" slot from a bit pattern.
        /// @param self The 256 bit value to extract the left half from
        /// @return The left half of `self`
        function leftSlot(LeftRightSigned self) internal pure returns (int128) {
            return int128(LeftRightSigned.unwrap(self) >> 128);
        }
    
        /// All toLeftSlot functions add bits to the left slot without clearing it first
        // Typically, the slot is already clear when writing to it, but if it is not, the bits will be added to the existing bits
        // Therefore, the assumption must not be made that the bits will be cleared while using these helpers
        // Note that the values *within* the slots are allowed to overflow, but overflows are contained and will not leak into the other slot
    
        /// @notice Add to the "left" slot in a 256-bit pattern.
        /// @param self The 256-bit pattern to be written to
        /// @param left The value to be added to the left slot
        /// @return `self` with `left` added (not overwritten, but added) to the value in its left 128 bits
        function toLeftSlot(
            LeftRightUnsigned self,
            uint128 left
        ) internal pure returns (LeftRightUnsigned) {
            unchecked {
                return LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(self) + (uint256(left) << 128));
            }
        }
    
        /// @notice Add to the "left" slot in a 256-bit pattern.
        /// @param self The 256-bit pattern to be written to
        /// @param left The value to be added to the left slot
        /// @return `self` with `left` added (not overwritten, but added) to the value in its left 128 bits
        function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {
            unchecked {
                return LeftRightSigned.wrap(LeftRightSigned.unwrap(self) + (int256(left) << 128));
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                  MATH HELPERS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
        /// @param x The augend
        /// @param y The addend
        /// @return z The sum `x + y`
        function add(
            LeftRightUnsigned x,
            LeftRightUnsigned y
        ) internal pure returns (LeftRightUnsigned z) {
            unchecked {
                // adding leftRight packed uint128's is same as just adding the values explictily
                // given that we check for overflows of the left and right values
                z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) + LeftRightUnsigned.unwrap(y));
    
                // on overflow z will be less than either x or y
                // type cast z to uint128 to isolate the right slot and if it's lower than a value it's comprised of (x)
                // then an overflow has occured
                if (
                    LeftRightUnsigned.unwrap(z) < LeftRightUnsigned.unwrap(x) ||
                    (uint128(LeftRightUnsigned.unwrap(z)) < uint128(LeftRightUnsigned.unwrap(x)))
                ) revert Errors.UnderOverFlow();
            }
        }
    
        /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
        /// @param x The minuend
        /// @param y The subtrahend
        /// @return z The difference `x - y`
        function sub(
            LeftRightUnsigned x,
            LeftRightUnsigned y
        ) internal pure returns (LeftRightUnsigned z) {
            unchecked {
                // subtracting leftRight packed uint128's is same as just subtracting the values explictily
                // given that we check for underflows of the left and right values
                z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) - LeftRightUnsigned.unwrap(y));
    
                // on underflow z will be greater than either x or y
                // type cast z to uint128 to isolate the right slot and if it's higher than a value that was subtracted from (x)
                // then an underflow has occured
                if (
                    LeftRightUnsigned.unwrap(z) > LeftRightUnsigned.unwrap(x) ||
                    (uint128(LeftRightUnsigned.unwrap(z)) > uint128(LeftRightUnsigned.unwrap(x)))
                ) revert Errors.UnderOverFlow();
            }
        }
    
        /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
        /// @param x The augend
        /// @param y The addend
        /// @return z The sum `x + y`
        function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
            unchecked {
                int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();
                int128 left128 = int128(left);
    
                if (left128 != left) revert Errors.UnderOverFlow();
    
                int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();
                int128 right128 = int128(right);
    
                if (right128 != right) revert Errors.UnderOverFlow();
    
                return z.toRightSlot(right128).toLeftSlot(left128);
            }
        }
    
        /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
        /// @param x The augend
        /// @param y The addend
        /// @return z The sum `x + y`
        function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
            unchecked {
                int256 left256 = int256(x.leftSlot()) + y.leftSlot();
                int128 left128 = int128(left256);
    
                int256 right256 = int256(x.rightSlot()) + y.rightSlot();
                int128 right128 = int128(right256);
    
                if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
    
                return z.toRightSlot(right128).toLeftSlot(left128);
            }
        }
    
        /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
        /// @param x The minuend
        /// @param y The subtrahend
        /// @return z The difference `x - y`
        function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
            unchecked {
                int256 left256 = int256(x.leftSlot()) - y.leftSlot();
                int128 left128 = int128(left256);
    
                int256 right256 = int256(x.rightSlot()) - y.rightSlot();
                int128 right128 = int128(right256);
    
                if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
    
                return z.toRightSlot(right128).toLeftSlot(left128);
            }
        }
    
        /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
        /// @notice FOr each slot, rectify difference `x - y` to 0 if negative.
        /// @param x The minuend
        /// @param y The subtrahend
        /// @return z The difference `x - y`
        function subRect(
            LeftRightSigned x,
            LeftRightSigned y
        ) internal pure returns (LeftRightSigned z) {
            unchecked {
                int256 left256 = int256(x.leftSlot()) - y.leftSlot();
                int128 left128 = int128(left256);
    
                int256 right256 = int256(x.rightSlot()) - y.rightSlot();
                int128 right128 = int128(right256);
    
                if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
    
                return
                    z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(
                        int128(Math.max(left128, 0))
                    );
            }
        }
    
        /// @notice Adds two sets of LeftRight-encoded words, freezing both right slots if either overflows, and vice versa.
        /// @dev Used for linked accumulators, so if the accumulator for one side overflows for a token, both cease to accumulate.
        /// @param x The first augend
        /// @param dx The addend for `x`
        /// @param y The second augend
        /// @param dy The addend for `y`
        /// @return The sum `x + dx`
        /// @return The sum `y + dy`
        function addCapped(
            LeftRightUnsigned x,
            LeftRightUnsigned dx,
            LeftRightUnsigned y,
            LeftRightUnsigned dy
        ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {
            uint128 z_xR = (uint256(x.rightSlot()) + dx.rightSlot()).toUint128Capped();
            uint128 z_xL = (uint256(x.leftSlot()) + dx.leftSlot()).toUint128Capped();
            uint128 z_yR = (uint256(y.rightSlot()) + dy.rightSlot()).toUint128Capped();
            uint128 z_yL = (uint256(y.leftSlot()) + dy.leftSlot()).toUint128Capped();
    
            bool r_Enabled = !(z_xR == type(uint128).max || z_yR == type(uint128).max);
            bool l_Enabled = !(z_xL == type(uint128).max || z_yL == type(uint128).max);
    
            return (
                LeftRightUnsigned.wrap(0).toRightSlot(r_Enabled ? z_xR : x.rightSlot()).toLeftSlot(
                    l_Enabled ? z_xL : x.leftSlot()
                ),
                LeftRightUnsigned.wrap(0).toRightSlot(r_Enabled ? z_yR : y.rightSlot()).toLeftSlot(
                    l_Enabled ? z_yL : y.leftSlot()
                )
            );
        }
    }

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L302))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {
        /// @notice AND mask to strip the `tickLower` value from a packed LiquidityChunk
        uint256 internal constant CLEAR_TL_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
    
        /// @notice AND mask to strip the `tickUpper` value from a packed LiquidityChunk
        uint256 internal constant CLEAR_TU_MASK =
            0xFFFFFF000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;
    
        /*//////////////////////////////////////////////////////////////
                                    ENCODING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Create a new `LiquidityChunk` given by its bounding ticks and its liquidity.
        /// @param _tickLower The lower tick of the chunk
        /// @param _tickUpper The upper tick of the chunk
        /// @param amount The amount of liquidity to add to the chunk
        /// @return The new chunk with the given liquidity and tick range
        function createChunk(
            int24 _tickLower,
            int24 _tickUpper,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return
                    LiquidityChunk.wrap(
                        (uint256(uint24(_tickLower)) << 232) +
                            (uint256(uint24(_tickUpper)) << 208) +
                            uint256(amount)
                    );
            }
        }
    
        /// @notice Add liquidity to `self`.
        /// @param self The LiquidityChunk to add liquidity to
        /// @param amount The amount of liquidity to add to `self`
        /// @return `self` with added liquidity `amount`
        function addLiquidity(
            LiquidityChunk self,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return LiquidityChunk.wrap(LiquidityChunk.unwrap(self) + amount);
            }
        }
    
        /// @notice Add the lower tick to `self`.
        /// @param self The LiquidityChunk to add the lower tick to
        /// @param _tickLower The lower tick to add to `self`
        /// @return `self` with added lower tick `_tickLower`
        function addTickLower(
            LiquidityChunk self,
            int24 _tickLower
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return
                    LiquidityChunk.wrap(
                        LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)
                    );
            }
        }
    
        /// @notice Add the upper tick to `self`.
        /// @param self The LiquidityChunk to add the upper tick to
        /// @param _tickUpper The upper tick to add to `self`
        /// @return `self` with added upper tick `_tickUpper`
        function addTickUpper(
            LiquidityChunk self,
            int24 _tickUpper
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                // convert tick upper to uint24 as explicit conversion from int24 to uint256 is not allowed
                return
                    LiquidityChunk.wrap(
                        LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)
                    );
            }
        }
    
        /// @notice Overwrites the lower tick on `self`.
        /// @param self The LiquidityChunk to overwrite the lower tick on
        /// @param _tickLower The lower tick to overwrite `self` with
        /// @return `self` with `_tickLower` as the new lower tick
        function updateTickLower(
            LiquidityChunk self,
            int24 _tickLower
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return
                    LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TL_MASK).addTickLower(
                        _tickLower
                    );
            }
        }
    
        /// @notice Overwrites the upper tick on `self`.
        /// @param self The LiquidityChunk to overwrite the upper tick on
        /// @param _tickUpper The upper tick to overwrite `self` with
        /// @return `self` with `_tickUpper` as the new upper tick
        function updateTickUpper(
            LiquidityChunk self,
            int24 _tickUpper
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                // convert tick upper to uint24 as explicit conversion from int24 to uint256 is not allowed
                return
                    LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TU_MASK).addTickUpper(
                        _tickUpper
                    );
            }
        }
    
        /*//////////////////////////////////////////////////////////////
                                    DECODING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Get the lower tick of `self`.
        /// @param self The LiquidityChunk to get the lower tick from
        /// @return The lower tick of `self`
        function tickLower(LiquidityChunk self) internal pure returns (int24) {
            unchecked {
                return int24(int256(LiquidityChunk.unwrap(self) >> 232));
            }
        }
    
        /// @notice Get the upper tick of `self`.
        /// @param self The LiquidityChunk to get the upper tick from
        /// @return The upper tick of `self`
        function tickUpper(LiquidityChunk self) internal pure returns (int24) {
            unchecked {
                return int24(int256(LiquidityChunk.unwrap(self) >> 208));
            }
        }
    
        /// @notice Get the amount of liquidity/size of `self`.
        /// @param self The LiquidityChunk to get the liquidity from
        /// @return The liquidity of `self`
        function liquidity(LiquidityChunk self) internal pure returns (uint128) {
            unchecked {
                return uint128(LiquidityChunk.unwrap(self));
            }
        }
    }

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L194))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {
        /// @notice AND mask to extract all `isLong` bits for each leg from a TokenId
        uint256 internal constant LONG_MASK =
            0x100_000000000100_000000000100_000000000100_0000000000000000;
    
        /// @notice AND mask to clear `poolId` from a TokenId
        uint256 internal constant CLEAR_POOLID_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF_0000000000000000;
    
        /// @notice AND mask to clear all bits except for the option ratios of the legs
        uint256 internal constant OPTION_RATIO_MASK =
            0x0000000000FE_0000000000FE_0000000000FE_0000000000FE_0000000000000000;
    
        /// @notice AND mask to clear all bits except for the components of the chunk key (strike, width, tokenType) for each leg
        uint256 internal constant CHUNK_MASK =
            0xFFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_0000000000000000;
    
        /// @notice AND mask to cut a sign-extended int256 back to an int24
        int256 internal constant BITMASK_INT24 = 0xFFFFFF;
    
        /*//////////////////////////////////////////////////////////////
                                    DECODING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice The full poolId (Uniswap pool identifier + pool pattern) of this option position.
        /// @param self The TokenId to extract `poolId` from
        /// @return The `poolId` (Panoptic's pool fingerprint, contains the whole 64 bit sequence with the tickSpacing) of the Uniswap V3 pool
        function poolId(TokenId self) internal pure returns (uint64) {
            unchecked {
                return uint64(TokenId.unwrap(self));
            }
        }
    
        /// @notice The tickSpacing of this option position.
        /// @param self The TokenId to extract `tickSpacing` from
        /// @return The `tickSpacing` of the Uniswap v3 pool
        function tickSpacing(TokenId self) internal pure returns (int24) {
            unchecked {
                return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));
            }
        }
    
        /// @notice Get the asset basis for this TokenId.
        /// @dev Which token is the asset - can be token0 (return 0) or token1 (return 1).
        /// @param self The TokenId to extract `asset` from
        /// @param legIndex The leg index of this position (in {0,1,2,3}) to extract `asset` from
        /// @dev Occupies the leftmost bit of the optionRatio 4 bits slot.
        /// @return 0 if asset is token0, 1 if asset is token1
        function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {
            unchecked {
                return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48)) % 2);
            }
        }
    
        /// @notice Get the number of contracts multiplier for leg `legIndex`.
        /// @param self The TokenId to extract `optionRatio` at `legIndex` from
        /// @param legIndex The leg index of this position (in {0,1,2,3})
        /// @return The number of contracts multiplier for leg `legIndex`
        function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {
            unchecked {
                return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 1)) % 128);
            }
        }
    
        /// @notice Return 1 if the nth leg (leg index `legIndex`) is a long position.
        /// @param self The TokenId to extract `isLong` at `legIndex` from
        /// @param legIndex The leg index of this position (in {0,1,2,3})
        /// @return 1 if long; 0 if not long
        function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {
            unchecked {
                return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);
            }
        }
    
        /// @notice Get the type of token moved for a given leg (implies a call or put). Either Token0 or Token1.
        /// @param self The TokenId to extract `tokenType` at `legIndex` from
        /// @param legIndex The leg index of this position (in {0,1,2,3})
        /// @return 1 if the token moved is token1 or 0 if the token moved is token0
        function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {
            unchecked {
                return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);
            }
        }
    
        /// @notice Get the associated risk partner of the leg index (generally another leg index in the position if enabled or the same leg index if no partner).
        /// @param self The TokenId to extract `riskPartner` at `legIndex` from
        /// @param legIndex The leg index of this position (in {0,1,2,3})
        /// @return The leg index of `legIndex`'s risk partner
        function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {
            unchecked {
                return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);
            }
        }
    
        /// @notice Get the strike price tick of the nth leg (with index `legIndex`).
        /// @param self The TokenId to extract `strike` at `legIndex` from
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return The strike price (the underlying price of the leg)
        function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {
            unchecked {
                return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));
            }
        }
    
        /// @notice Get the width of the nth leg (index `legIndex`). This is half the tick-range covered by the leg (tickUpper - tickLower)/2.
        /// @dev Return as int24 to be compatible with the strike tick format (they naturally go together).
        /// @param self The TokenId to extract `width` at `legIndex` from
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return The width of the position
        function width(TokenId self, uint256 legIndex) internal pure returns (int24) {
            unchecked {
                return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));
            } // "% 4096" = take last (2 ** 12 = 4096) 12 bits
        }
    
        /*//////////////////////////////////////////////////////////////
                                    ENCODING
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Add the Uniswap V3 Pool pointed to by this option position (contains the entropy and tickSpacing).
        /// @param self The TokenId to add `_poolId` to
        /// @param _poolId The PoolID to add to `self`
        /// @return `self` with `_poolId` added to the PoolID slot
        function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {
            unchecked {
                return TokenId.wrap(TokenId.unwrap(self) + _poolId);
            }
        }
    
        /// @notice Add the `tickSpacing` to the PoolID for `self`.
        /// @param self The TokenId to add `_tickSpacing` to
        /// @param _tickSpacing The tickSpacing to add to `self`
        /// @return `self` with `_tickSpacing` added to the TickSpacing slot in the PoolID.
        function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {
            unchecked {
                return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));
            }
        }
    
        /// @notice Add the asset basis for this position.
        /// @param self The TokenId to add `_asset` to
        /// @param _asset The asset to add to the Asset slot in `self` for `legIndex`
        /// @param legIndex The leg index of this position (in {0,1,2,3})
        /// @dev Occupies the leftmost bit of the optionRatio 4 bits slot
        /// @return `self` with `_asset` added to the Asset slot
        function addAsset(
            TokenId self,
            uint256 _asset,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return
                    TokenId.wrap(TokenId.unwrap(self) + (uint256(_asset % 2) << (64 + legIndex * 48)));
            }
        }
    
        /// @notice Add the number of contracts multiplier to leg index `legIndex`.
        /// @param self The TokenId to add `_optionRatio` to
        /// @param _optionRatio The number of contracts multiplier to add to the OptionRatio slot in `self` for LegIndex
        /// @param legIndex The leg index of the position (in {0,1,2,3})
        /// @return `self` with `_optionRatio` added to the OptionRatio slot for `legIndex`
        function addOptionRatio(
            TokenId self,
            uint256 _optionRatio,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) + (uint256(_optionRatio % 128) << (64 + legIndex * 48 + 1))
                    );
            }
        }
    
        /// @notice Add "isLong" parameter indicating whether a leg is long (isLong=1) or short (isLong=0).
        /// @notice returns 1 if the nth leg (leg index n-1) is a long position.
        /// @param self The TokenId to add `_isLong` to
        /// @param _isLong The isLong parameter to add to the IsLong slot in `self` for `legIndex`
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return `self` with `_isLong` added to the IsLong slot for `legIndex`
        function addIsLong(
            TokenId self,
            uint256 _isLong,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return TokenId.wrap(TokenId.unwrap(self) + ((_isLong % 2) << (64 + legIndex * 48 + 8)));
            }
        }
    
        /// @notice Add the type of token moved for a given leg (implies a call or put). Either Token0 or Token1.
        /// @param self The TokenId to add `_tokenType` to
        /// @param _tokenType The tokenType to add to the TokenType slot in `self` for `legIndex`
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return `self` with `_tokenType` added to the TokenType slot for `legIndex`
        function addTokenType(
            TokenId self,
            uint256 _tokenType,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) + (uint256(_tokenType % 2) << (64 + legIndex * 48 + 9))
                    );
            }
        }
    
        /// @notice Add the associated risk partner of the leg index (generally another leg in the overall position).
        /// @param self The TokenId to add `_riskPartner` to
        /// @param _riskPartner The riskPartner to add to the RiskPartner slot in `self` for `legIndex`
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return `self` with `_riskPartner` added to the RiskPartner slot for `legIndex`
        function addRiskPartner(
            TokenId self,
            uint256 _riskPartner,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) + (uint256(_riskPartner % 4) << (64 + legIndex * 48 + 10))
                    );
            }
        }
    
        /// @notice Add the strike price tick of the nth leg (index `legIndex`).
        /// @param self The TokenId to add `_strike` to
        /// @param _strike The strike price tick to add to the Strike slot in `self` for `legIndex`
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return `self` with `_strike` added to the Strike slot for `legIndex`
        function addStrike(
            TokenId self,
            int24 _strike,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            unchecked {
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) +
                            uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))
                    );
            }
        }
    
        /// @notice Add the width of the nth leg (index `legIndex`).
        /// @param self The TokenId to add `_width` to
        /// @param _width The width to add to the Width slot in `self` for `legIndex`
        /// @param legIndex the leg index of this position (in {0,1,2,3})
        /// @return `self` with `_width` added to the Width slot for `legIndex`
        function addWidth(
            TokenId self,
            int24 _width,
            uint256 legIndex
        ) internal pure returns (TokenId) {
            // % 4096 -> take 12 bits from the incoming 24 bits (there's no uint12)
            unchecked {
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) +
                            (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))
                    );
            }
        }
    
        /// @notice Add a leg to a TokenId.
        /// @param self The tokenId in the SFPM representing an option position.
        /// @param legIndex The leg index of this position (in {0,1,2,3}) to add
        /// @param _optionRatio The relative size of the leg
        /// @param _asset The asset of the leg
        /// @param _isLong Whether the leg is long
        /// @param _tokenType The type of token moved for the leg
        /// @param _riskPartner The associated risk partner of the leg
        /// @param _strike The strike price tick of the leg
        /// @param _width The width of the leg
        /// @return tokenId The tokenId with the leg added
        function addLeg(
            TokenId self,
            uint256 legIndex,
            uint256 _optionRatio,
            uint256 _asset,
            uint256 _isLong,
            uint256 _tokenType,
            uint256 _riskPartner,
            int24 _strike,
            int24 _width
        ) internal pure returns (TokenId tokenId) {
            tokenId = addOptionRatio(self, _optionRatio, legIndex);
            tokenId = addAsset(tokenId, _asset, legIndex);
            tokenId = addIsLong(tokenId, _isLong, legIndex);
            tokenId = addTokenType(tokenId, _tokenType, legIndex);
            tokenId = addRiskPartner(tokenId, _riskPartner, legIndex);
            tokenId = addStrike(tokenId, _strike, legIndex);
            tokenId = addWidth(tokenId, _width, legIndex);
        }
    
        /*//////////////////////////////////////////////////////////////
                                    HELPERS
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Flip all the `isLong` positions in the legs in the `tokenId` option position.
        /// @dev Uses XOR on existing isLong bits.
        /// @dev Useful when we need to take an existing tokenId but now burn it.
        /// @dev The way to do this is to simply flip it to a short instead.
        /// @param self The TokenId to flip isLong for on all active legs
        /// @return tokenId with all `isLong` bits flipped
        function flipToBurnToken(TokenId self) internal pure returns (TokenId) {
            unchecked {
                // NOTE: This is a hack to avoid blowing up the contract size.
                // We copy the logic from the countLegs function, using it here adds 5K to the contract size with IR for some reason
                // Strip all bits except for the option ratios
                uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;
    
                // The legs are filled in from least to most significant
                // Each comparison here is to the start of the next leg's option ratio
                // Since only the option ratios remain, we can be sure that no bits above the start of the inactive legs will be 1
                if (optionRatios < 2 ** 64) {
                    optionRatios = 0;
                } else if (optionRatios < 2 ** 112) {
                    optionRatios = 1;
                } else if (optionRatios < 2 ** 160) {
                    optionRatios = 2;
                } else if (optionRatios < 2 ** 208) {
                    optionRatios = 3;
                } else {
                    optionRatios = 4;
                }
    
                // We need to ensure that only active legs are flipped
                // In order to achieve this, we shift our long bit mask to the right by (4-# active legs)
                // i.e the whole mask is used to flip all legs with 4 legs, but only the first leg is flipped with 1 leg so we shift by 3 legs
                // We also clear the poolId area of the mask to ensure the bits that are shifted right into the area don't flip and cause issues
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) ^
                            ((LONG_MASK >> (48 * (4 - optionRatios))) & CLEAR_POOLID_MASK)
                    );
            }
        }
    
        /// @notice Get the number of longs in this option position.
        /// @notice Count the number of legs (out of a maximum of 4) that are long positions.
        /// @param self The TokenId to count longs for
        /// @return The number of long positions in `self` (in the range {0,...,4}).
        function countLongs(TokenId self) internal pure returns (uint256) {
            unchecked {
                return self.isLong(0) + self.isLong(1) + self.isLong(2) + self.isLong(3);
            }
        }
    
        /// @notice Get the option position's nth leg's (index `legIndex`) tick ranges (lower, upper).
        /// @dev NOTE: Does not extract liquidity which is the third piece of information in a LiquidityChunk.
        /// @param self The TokenId to extract the tick range from
        /// @param legIndex The leg index of the position (in {0,1,2,3})
        /// @return legLowerTick The lower tick of the leg/liquidity chunk
        /// @return legUpperTick The upper tick of the leg/liquidity chunk
        function asTicks(
            TokenId self,
            uint256 legIndex
        ) internal pure returns (int24 legLowerTick, int24 legUpperTick) {
            (legLowerTick, legUpperTick) = PanopticMath.getTicks(
                self.strike(legIndex),
                self.width(legIndex),
                self.tickSpacing()
            );
        }
    
        /// @notice Return the number of active legs in the option position.
        /// @param self The TokenId to count active legs for
        /// @dev ASSUMPTION: There is at least 1 leg in this option position.
        /// @dev ASSUMPTION: For any leg, the option ratio is always > 0 (the leg always has a number of contracts associated with it).
        /// @return The number of active legs in `self` (in the range {0,...,4})
        function countLegs(TokenId self) internal pure returns (uint256) {
            // Strip all bits except for the option ratios
            uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;
    
            // The legs are filled in from least to most significant
            // Each comparison here is to the start of the next leg's option ratio section
            // Since only the option ratios remain, we can be sure that no bits above the start of the inactive legs will be 1
            if (optionRatios < 2 ** 64) {
                return 0;
            } else if (optionRatios < 2 ** 112) {
                return 1;
            } else if (optionRatios < 2 ** 160) {
                return 2;
            } else if (optionRatios < 2 ** 208) {
                return 3;
            }
            return 4;
        }
    
        /// @notice Clear a leg in an option position with index `i`.
        /// @dev set bits of the leg to zero. Also sets the optionRatio and asset to zero of that leg.
        /// @dev NOTE it's important that the caller fills in the leg details after.
        //  - optionRatio is zeroed
        //  - asset is zeroed
        //  - width is zeroed
        // - strike is zeroed
        //  - tokenType is zeroed
        //  - isLong is zeroed
        //  - riskPartner is zeroed
        /// @param self The TokenId to clear the leg from
        /// @param i The leg index to reset, in {0,1,2,3}
        /// @return `self` with the `i`th leg zeroed including optionRatio and asset
        function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {
            if (i == 0)
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) &
                            0xFFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFFFFFF
                    );
            if (i == 1)
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) &
                            0xFFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                    );
            if (i == 2)
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) &
                            0xFFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                    );
            if (i == 3)
                return
                    TokenId.wrap(
                        TokenId.unwrap(self) &
                            0x000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                    );
    
            return self;
        }
    
        /*//////////////////////////////////////////////////////////////
                                   VALIDATION
        //////////////////////////////////////////////////////////////*/
    
        /// @notice Validate an option position and all its active legs; return the underlying AMM address.
        /// @dev Used to validate a position tokenId and its legs.
        /// @param self The TokenId to validate
        function validate(TokenId self) internal pure {
            if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);
    
            // loop through the 4 (possible) legs in the tokenId `self`
            unchecked {
                // extract strike, width, and tokenType
                uint256 chunkData = (TokenId.unwrap(self) & CHUNK_MASK) >> 64;
                for (uint256 i = 0; i < 4; ++i) {
                    if (self.optionRatio(i) == 0) {
                        // final leg in this position identified;
                        // make sure any leg above this are zero as well
                        // (we don't allow gaps eg having legs 1 and 4 active without 2 and 3 is not allowed)
                        if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)
                            revert Errors.InvalidTokenIdParameter(1);
    
                        break; // we are done iterating over potential legs
                    }
    
                    // prevent legs touching the same chunks - all chunks in the position must be discrete
                    uint256 numLegs = self.countLegs();
                    for (uint256 j = i + 1; j < numLegs; ++j) {
                        if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {
                            revert Errors.InvalidTokenIdParameter(6);
                        }
                    }
                    // now validate this ith leg in the position:
    
                    // The width cannot be 0; the minimum is 1
                    if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);
                    // Strike cannot be MIN_TICK or MAX_TICK
                    if (
                        (self.strike(i) == Constants.MIN_V3POOL_TICK) ||
                        (self.strike(i) == Constants.MAX_V3POOL_TICK)
                    ) revert Errors.InvalidTokenIdParameter(4);
    
                    // In the following, we check whether the risk partner of this leg is itself
                    // or another leg in this position.
                    // Handles case where riskPartner(i) != i ==> leg i has a risk partner that is another leg
                    uint256 riskPartnerIndex = self.riskPartner(i);
                    if (riskPartnerIndex != i) {
                        // Ensures that risk partners are mutual
                        if (self.riskPartner(riskPartnerIndex) != i)
                            revert Errors.InvalidTokenIdParameter(3);
    
                        // Ensures that risk partners have 1) the same asset, and 2) the same ratio
                        if (
                            (self.asset(riskPartnerIndex) != self.asset(i)) ||
                            (self.optionRatio(riskPartnerIndex) != self.optionRatio(i))
                        ) revert Errors.InvalidTokenIdParameter(3);
    
                        // long/short status of associated legs
                        uint256 _isLong = self.isLong(i);
                        uint256 isLongP = self.isLong(riskPartnerIndex);
    
                        // token type status of associated legs (call/put)
                        uint256 _tokenType = self.tokenType(i);
                        uint256 tokenTypeP = self.tokenType(riskPartnerIndex);
    
                        // if the position is the same i.e both long calls, short put's etc.
                        // then this is a regular position, not a defined risk position
                        if ((_isLong == isLongP) && (_tokenType == tokenTypeP))
                            revert Errors.InvalidTokenIdParameter(4);
    
                        // if the two token long-types and the tokenTypes are both different (one is a short call, the other a long put, e.g.), this is a synthetic position
                        // A synthetic long or short is more capital efficient than each leg separated because the long+short premia accumulate proportionally
                        // unlike short stranlges, long strangles also cannot be partnered, because there is no reduction in risk (both legs can earn premia simultaneously)
                        if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))
                            revert Errors.InvalidTokenIdParameter(5);
                    }
                } // end for loop over legs
            }
        }
    
        /// @notice Validate that a position `self` and its legs/chunks are exercisable.
        /// @dev At least one long leg must be far-out-of-the-money (i.e. price is outside its range).
        /// @dev Reverts if the position is not exercisable.
        /// @param self The TokenId to validate for exercisability
        /// @param currentTick The current tick corresponding to the current price in the Univ3 pool
        function validateIsExercisable(TokenId self, int24 currentTick) internal pure {
            unchecked {
                uint256 numLegs = self.countLegs();
                for (uint256 i = 0; i < numLegs; ++i) {
                    (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(
                        self.width(i),
                        self.tickSpacing()
                    );
    
                    int24 _strike = self.strike(i);
                    // check if the price is outside this chunk
                    if ((currentTick >= _strike + rangeUp) || (currentTick < _strike - rangeDown)) {
                        // if this leg is long and the price beyond the leg's range:
                        // this exercised ID, `self`, appears valid
                        if (self.isLong(i) == 1) return; // validated
                    }
                }
            }
    
            // Fail if position has no legs that is far-out-of-the-money
            revert Errors.NoLegsExercisable();
        }
    }

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L600))
### <a name="NC-27"></a>[NC-27] No equate comparison checks between to and from address parameters
The function lacks a standard check: it does not validate if the 'to' and 'from' addresses are identical. This omission can lead to unintended outcomes if the same address is used in both parameters. To rectify this, we recommend implementing a comparison check at the beginning of the function. In the context of Solidity, the command `require(to != from, 'To and From addresses can't be the same');` could be utilized. This addition will generate an error if the 'to' and 'from' addresses are the same, thereby fortifying the function's robustness and security.

*There are 9 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit missing checks for -> from != to
341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

```
([341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit missing checks for -> from != to
540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

// @audit missing checks for -> from != to
566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

// @audit missing checks for -> from != to
593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

```
([540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L593-L593))
```solidity
File: contracts/libraries/SafeTransferLib.sol

// @audit missing checks for -> from != to
21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit missing checks for -> from != to
94:     function safeTransferFrom(
            address from,
            address to,
            uint256 id,
            uint256 amount,
            bytes calldata data
        ) public virtual {

// @audit missing checks for -> from != to
130:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public virtual {

```
([94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L94-L100),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L130-L136))
```solidity
File: contracts/tokens/ERC20Minimal.sol

// @audit missing checks for -> from != to
81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

// @audit missing checks for -> from != to
103:     function _transferFrom(address from, address to, uint256 amount) internal {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L81-L81),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L103))
### <a name="NC-28"></a>[NC-28] Functions with array parameters should have length checks in place
Functions in Solidity that accept array parameters should incorporate length checks as a security measure. This is to prevent potential overflow errors, unwanted gas consumption, and manipulation attempts. Without length checks, an attacker could pass excessively large arrays as input, causing excessive computation and potentially causing the function to exceed the block gas limit, leading to a denial-of-service. Additionally, unexpected array sizes could lead to logic errors within the function. As a resolution, always validate array length at the start of functions handling array inputs, ensuring it aligns with the expectations of the function logic. This makes the code more robust and predictable.

*There are 27 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit positionBalanceArray
1141:     function getAccountMarginDetails(
              address user,
              int24 currentTick,
              uint256[2][] memory positionBalanceArray,
              int128 premiumAllPositions
          ) public view returns (LeftRightUnsigned tokenData) {

// @audit positionBalanceArray
1200:     function _getTotalRequiredCollateral(
              int24 atTick,
              uint256[2][] memory positionBalanceArray
          ) internal view returns (uint256 tokenRequired) {

```
([1141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1141-L1146),[1200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1200-L1203))
```solidity
File: contracts/PanopticPool.sol

// @audit positionIdList
381:     function calculateAccumulatedFeesBatch(
             address user,
             bool includePendingPremium,
             TokenId[] calldata positionIdList
         ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

// @audit positionIdList
410:     function calculatePortfolioValue(
             address user,
             int24 atTick,
             TokenId[] calldata positionIdList
         ) external view returns (int256 value0, int256 value1) {

// @audit positionIdList
429:     function _calculateAccumulatedPremia(
             address user,
             TokenId[] calldata positionIdList,
             bool computeAllPremia,
             bool includePendingPremium,
             int24 atTick
         ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

// @audit positionIdList
547:     function mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit newPositionIdList
569:     function burnOptions(
             TokenId tokenId,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit positionIdList, newPositionIdList
586:     function burnOptions(
             TokenId[] calldata positionIdList,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit positionIdList
614:     function _mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal {

// @audit positionIdList
794:     function _burnAllOptionsFrom(
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool commitLongSettled,
             TokenId[] calldata positionIdList
         ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {

// @audit positionIdList
887:     function _validateSolvency(
             address user,
             TokenId[] calldata positionIdList,
             uint256 buffer
         ) internal view returns (uint256 medianData) {

// @audit positionIdListLiquidator, positionIdList
1017:     function liquidate(
              TokenId[] calldata positionIdListLiquidator,
              address liquidatee,
              LeftRightUnsigned delegations,
              TokenId[] calldata positionIdList
          ) external {

// @audit positionIdListExercisee
1179:     function forceExercise(
              address account,
              TokenId[] calldata touchedId,
              TokenId[] calldata positionIdListExercisee,
              TokenId[] calldata positionIdListExercisor
          ) external {

// @audit positionIdList
1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

// @audit positionIdList
1367:     function _validatePositionList(
              address account,
              TokenId[] calldata positionIdList,
              uint256 offset
          ) internal view {

// @audit positionIdList
1587:     function settleLongPremium(
              TokenId[] calldata positionIdList,
              address owner,
              uint256 legIndex
          ) external {

// @audit collectedByLeg
1666:     function _updateSettlementPostMint(
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize
          ) internal {

// @audit premiumAccumulators
1757:     function _getAvailablePremium(
              uint256 totalLiquidity,
              LeftRightUnsigned settledTokens,
              LeftRightUnsigned grossPremiumLast,
              LeftRightUnsigned premiumOwed,
              uint256[2] memory premiumAccumulators
          ) internal pure returns (LeftRightUnsigned) {

// @audit collectedByLeg
1833:     function _updateSettlementPostBurn(
              address owner,
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize,
              bool commitLongSettled
          ) internal returns (LeftRightSigned realizedPremia, LeftRightSigned[4] memory premiaByLeg) {

```
([381](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L381-L385),[410](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L410-L414),[429](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L429-L435),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L547-L553),[569](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L569-L574),[586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L586-L591),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L614-L620),[794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L794-L800),[887](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L887-L891),[1017](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1017-L1022),[1179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1179-L1184),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1367-L1371),[1587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1587-L1591),[1666](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1666-L1670),[1757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1757-L1763),[1833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1833-L1839))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit ids, amounts
566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

```
([566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572))
```solidity
File: contracts/libraries/FeesCalc.sol

// @audit positionIdList
46:     function getPortfolioValue(
            int24 atTick,
            mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
            TokenId[] calldata positionIdList
        ) external view returns (int256 value0, int256 value1) {

```
([46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L46-L50))
```solidity
File: contracts/libraries/Math.sol

// @audit arr
753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

// @audit data
776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([753](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L753-L753),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

// @audit positionIdList, premiasByLeg
768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

```
([768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777))
```solidity
File: contracts/multicall/Multicall.sol

// @audit data
12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L12-L12))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit ids, amounts
130:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public virtual {

// @audit owners, ids
178:     function balanceOfBatch(
             address[] calldata owners,
             uint256[] calldata ids
         ) public view returns (uint256[] memory balances) {

```
([130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L130-L136),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L178-L181))
### <a name="NC-29"></a>[NC-29] function names should be lowerCamelCase

*There are 97 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

289:     function name() external view returns (string memory) {

303:     function symbol() external view returns (string memory) {

310:     function decimals() external view returns (uint8) {

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

361:     function asset() external view returns (address assetTokenAddress) {

417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

531:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) external returns (uint256 shares) {

591:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) external returns (uint256 assets) {

741:     function _poolUtilization() internal view returns (int256 poolUtilization) {

751:     function _sellCollateralRatio(
             int256 utilization
         ) internal view returns (uint256 sellCollateralRatio) {

806:     function _buyCollateralRatio(
             uint256 utilization
         ) internal view returns (uint256 buyCollateralRatio) {

864:     function delegate(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

911:     function revoke(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

1096:     function _getExchangedAmount(
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount
          ) internal view returns (int256 exchangedAmount) {

1159:     function _getAccountMargin(
              address user,
              int24 atTick,
              uint256[2][] memory positionBalanceArray,
              int128 premiumAllPositions
          ) internal view returns (LeftRightUnsigned tokenData) {

1200:     function _getTotalRequiredCollateral(
              int24 atTick,
              uint256[2][] memory positionBalanceArray
          ) internal view returns (uint256 tokenRequired) {

1245:     function _getRequiredCollateralAtTickSinglePosition(
              TokenId tokenId,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 tokenRequired) {

1278:     function _getRequiredCollateralSingleLeg(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1311:     function _getRequiredCollateralSingleLegNoPartner(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1439:     function _getRequiredCollateralSingleLegPartner(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1473:     function _getRequiredCollateralAtUtilization(
              uint128 amount,
              uint256 isLong,
              int256 utilization
          ) internal view returns (uint256 required) {

1510:     function _computeSpread(
              TokenId tokenId,
              uint128 positionSize,
              uint256 index,
              uint256 partnerIndex,
              uint128 poolUtilization
          ) internal view returns (uint256 spreadRequirement) {

1600:     function _computeStrangle(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 strangleRequired) {

```
([289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L289-L289),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L303-L303),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L310-L310),[323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L361-L361),[417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L417-L417),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L477-L477),[531](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L531-L535),[591](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L591-L595),[741](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L741-L741),[751](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L751-L753),[806](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L806-L808),[864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L864-L868),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[911](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L911-L915),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049),[1096](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1096-L1100),[1159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1159-L1164),[1200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1200-L1203),[1245](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1245-L1250),[1278](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1278-L1284),[1311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1311-L1317),[1439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1439-L1445),[1473](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1473-L1477),[1510](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1510-L1516),[1600](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1600-L1606))
```solidity
File: contracts/PanopticFactory.sol

134:     function initialize(address _owner) public {

159:     function owner() external view returns (address) {

335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

```
([134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L134-L134),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L159-L159),[335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340))
```solidity
File: contracts/PanopticPool.sol

429:     function _calculateAccumulatedPremia(
             address user,
             TokenId[] calldata positionIdList,
             bool computeAllPremia,
             bool includePendingPremium,
             int24 atTick
         ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

499:     function _getSlippageLimits(
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal pure returns (int24, int24) {

614:     function _mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal {

677:     function _mintInSFPMAndUpdateCollateral(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (uint128) {

706:     function _payCommissionAndWriteData(
             TokenId tokenId,
             uint128 positionSize,
             LeftRightSigned totalSwapped
         ) internal returns (uint128) {

739:     function _addUserOption(TokenId tokenId, uint64 effectiveLiquidityLimitX32) internal {

794:     function _burnAllOptionsFrom(
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool commitLongSettled,
             TokenId[] calldata positionIdList
         ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {

826:     function _burnOptions(
             bool commitLongSettled,
             TokenId tokenId,
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (LeftRightSigned paidAmounts, LeftRightSigned[4] memory premiaByLeg) {

859:     function _updatePositionDataBurn(address owner, TokenId tokenId) internal {

887:     function _validateSolvency(
             address user,
             TokenId[] calldata positionIdList,
             uint256 buffer
         ) internal view returns (uint256 medianData) {

955:     function _burnAndHandleExercise(
             bool commitLongSettled,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             TokenId tokenId,
             uint128 positionSize,
             address owner
         )
             internal
             returns (
                 LeftRightSigned realizedPremia,
                 LeftRightSigned[4] memory premiaByLeg,
                 LeftRightSigned paidAmounts
             )
         {

1017:     function liquidate(
              TokenId[] calldata positionIdListLiquidator,
              address liquidatee,
              LeftRightUnsigned delegations,
              TokenId[] calldata positionIdList
          ) external {

1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

1339:     function _getSolvencyBalances(
              LeftRightUnsigned tokenData0,
              LeftRightUnsigned tokenData1,
              uint160 sqrtPriceX96
          ) internal pure returns (uint256 balanceCross, uint256 thresholdCross) {

1367:     function _validatePositionList(
              address account,
              TokenId[] calldata positionIdList,
              uint256 offset
          ) internal view {

1405:     function _updatePositionsHash(address account, TokenId tokenId, bool addFlag) internal {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1465:     function _checkLiquiditySpread(
              TokenId tokenId,
              uint256 leg,
              int24 tickLower,
              int24 tickUpper,
              uint64 effectiveLiquidityLimitX32
          ) internal view {

1503:     function _getPremia(
              TokenId tokenId,
              uint128 positionSize,
              address owner,
              bool computeAllPremia,
              int24 atTick
          )
              internal
              view
              returns (
                  LeftRightSigned[4] memory premiaByLeg,
                  uint256[2][4] memory premiumAccumulatorsByLeg
              )
          {

1666:     function _updateSettlementPostMint(
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize
          ) internal {

1757:     function _getAvailablePremium(
              uint256 totalLiquidity,
              LeftRightUnsigned settledTokens,
              LeftRightUnsigned grossPremiumLast,
              LeftRightUnsigned premiumOwed,
              uint256[2] memory premiumAccumulators
          ) internal pure returns (LeftRightUnsigned) {

1802:     function _getTotalLiquidity(
              TokenId tokenId,
              uint256 leg
          ) internal view returns (uint256 totalLiquidity) {

1833:     function _updateSettlementPostBurn(
              address owner,
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize,
              bool commitLongSettled
          ) internal returns (LeftRightSigned realizedPremia, LeftRightSigned[4] memory premiaByLeg) {

```
([429](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L429-L435),[499](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L499-L502),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L614-L620),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L677-L682),[706](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L706-L710),[739](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L739-L739),[794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L794-L800),[826](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L826-L832),[859](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L859-L859),[887](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L887-L891),[955](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L955-L969),[1017](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1017-L1022),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1339-L1343),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1367-L1371),[1405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1405-L1405),[1425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1425-L1425),[1465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1465-L1471),[1503](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1503-L1516),[1666](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1666-L1670),[1757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1757-L1763),[1802](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1802-L1805),[1833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1833-L1839))
```solidity
File: contracts/SemiFungiblePositionManager.sol

680:     function _validateAndForwardToAMM(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool isBurn
         ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {

863:     function _createPositionInAMM(
             IUniswapV3Pool univ3pool,
             TokenId tokenId,
             uint128 positionSize,
             bool isBurn
         )
             internal
             returns (
                 LeftRightSigned totalMoved,
                 LeftRightUnsigned[4] memory collectedByLeg,
                 LeftRightSigned itmAmounts
             )
         {

958:     function _createLegInAMM(
             IUniswapV3Pool univ3pool,
             TokenId tokenId,
             uint256 leg,
             LiquidityChunk liquidityChunk,
             bool isBurn
         )
             internal
             returns (
                 LeftRightSigned moved,
                 LeftRightSigned itmAmounts,
                 LeftRightUnsigned collectedSingleLeg
             )
         {

1110:     function _updateStoredPremia(
              bytes32 positionKey,
              LeftRightUnsigned currentLiquidity,
              LeftRightUnsigned collectedAmounts
          ) private {

1138:     function _getFeesBase(
              IUniswapV3Pool univ3pool,
              uint128 liquidity,
              LiquidityChunk liquidityChunk,
              bool roundUp
          ) private view returns (LeftRightSigned feesBase) {

1185:     function _mintLiquidity(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool
          ) internal returns (LeftRightSigned movedAmounts) {

1224:     function _burnLiquidity(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool
          ) internal returns (LeftRightSigned movedAmounts) {

1255:     function _collectAndWritePositionData(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool,
              LeftRightUnsigned currentLiquidity,
              bytes32 positionKey,
              LeftRightSigned movedInLeg,
              uint256 isLong
          ) internal returns (LeftRightUnsigned collectedChunk) {

1321:     function _getPremiaDeltas(
              LeftRightUnsigned currentLiquidity,
              LeftRightUnsigned collectedAmounts
          )
              private
              pure
              returns (LeftRightUnsigned deltaPremiumOwed, LeftRightUnsigned deltaPremiumGross)
          {

```
([680](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L680-L686),[863](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L863-L875),[958](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L958-L971),[1110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1110-L1114),[1138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1138-L1143),[1185](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1185-L1188),[1224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1224-L1227),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1255-L1262),[1321](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1321-L1328))
```solidity
File: contracts/libraries/FeesCalc.sol

130:     function _getAMMSwapFeesPerLiquidityCollected(
             IUniswapV3Pool univ3pool,
             int24 currentTick,
             int24 tickLower,
             int24 tickUpper
         ) internal view returns (uint256 feeGrowthInside0X128, uint256 feeGrowthInside1X128) {

```
([130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L130-L135))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L73),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

607:     function _calculateIOAmounts(
             TokenId tokenId,
             uint128 positionSize,
             uint256 legIndex
         ) internal pure returns (LeftRightSigned longs, LeftRightSigned shorts) {

```
([490](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L490-L490),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L507-L507),[524](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L524-L524),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L547-L547),[607](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L607-L611))
```solidity
File: contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L12-L12))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

214:     function _mint(address to, uint256 id, uint256 amount) internal {

236:     function _burn(address from, uint256 id, uint256 amount) internal {

```
([214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L214),[236](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L236-L236))
```solidity
File: contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

103:     function _transferFrom(address from, address to, uint256 amount) internal {

122:     function _mint(address to, uint256 amount) internal {

136:     function _burn(address from, uint256 amount) internal {

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L103),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L122),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L136-L136))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

22:     function approve(address spender, uint256 amount) external;

27:     function transfer(address to, uint256 amount) external;

```
([22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L22-L22),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L27-L27))
```solidity
File: contracts/types/LeftRight.sol

148:     function add(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

171:     function sub(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

```
([148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L148-L151),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L171-L174),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L194),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L214),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L232))
```solidity
File: contracts/types/LiquidityChunk.sol

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

500:     function validate(TokenId self) internal pure {

```
([108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L108),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L169),[500](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L500-L500))
### <a name="NC-30"></a>[NC-30] Functions within contracts are not ordered according to the solidity style guide
Order of Functions; ordering helps readers identify which functions they can call and to find the constructor and fallback definitions easier. But there are contracts in the project that do not comply with this.

<https://docs.soliditylang.org/en/v0.8.17/style-guide.html>

Functions should be grouped according to their visibility and ordered:

- constructor
- receive function (if exists)
- fallback function (if exists)
- external
- public
- internal
- private
- within a grouping, place the view and pure functions last

*There are 9 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/multicall/Multicall.sol

8: abstract contract Multicall {

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L8))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
### <a name="NC-31"></a>[NC-31] Add inline comments for unnamed parameters
`function func(address a, address)` -> `function func(address a, address /* b */)`

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

444:     function maxMint(address) external view returns (uint256 maxShares) {

```
([392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444))
### <a name="NC-32"></a>[NC-32] Functions should not be longer than 50 lines
Overly complex code can make understanding functionality more difficult, try to further modularize your code to ensure readability 

*There are 118 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

289:     function name() external view returns (string memory) {

303:     function symbol() external view returns (string memory) {

310:     function decimals() external view returns (uint8) {

361:     function asset() external view returns (address assetTokenAddress) {

370:     function totalAssets() public view returns (uint256 totalManagedAssets) {

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {

417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

444:     function maxMint(address) external view returns (uint256 maxShares) {

453:     function previewMint(uint256 shares) public view returns (uint256 assets) {

477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {

741:     function _poolUtilization() internal view returns (int256 poolUtilization) {

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

1245:     function _getRequiredCollateralAtTickSinglePosition(

1311:     function _getRequiredCollateralSingleLegNoPartner(

```
([289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L289-L289),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L303-L303),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L310-L310),[361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L361-L361),[370](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L370-L370),[379](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L379-L379),[386](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L386-L386),[392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[399](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L399-L399),[417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L417-L417),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444),[453](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L453-L453),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L477-L477),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L507-L507),[518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L518-L518),[572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L572-L572),[581](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L581-L581),[741](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L741-L741),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[1245](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1245-L1245),[1311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1311-L1311))
```solidity
File: contracts/PanopticFactory.sol

147:     function transferOwnership(address newOwner) external {

159:     function owner() external view returns (address) {

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L147-L147),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L159-L159),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

338:     function assertPriceWithinBounds(uint160 sqrtLowerBound, uint160 sqrtUpperBound) external view {

739:     function _addUserOption(TokenId tokenId, uint64 effectiveLiquidityLimitX32) internal {

859:     function _updatePositionDataBurn(address owner, TokenId tokenId) internal {

1405:     function _updatePositionsHash(address account, TokenId tokenId, bool addFlag) internal {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {

1437:     function collateralToken1() external view returns (CollateralTracker) {

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {

1450:     function getUniV3TWAP() internal view returns (int24 twapTick) {

```
([338](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L338-L338),[739](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L739-L739),[859](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L859-L859),[1405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1405-L1405),[1425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1425-L1425),[1431](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1431-L1431),[1437](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1437-L1437),[1444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1444-L1444),[1450](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1450-L1450))
```solidity
File: contracts/SemiFungiblePositionManager.sol

320:     function beginReentrancyLock(uint64 poolId) internal {

330:     function endReentrancyLock(uint64 poolId) internal {

350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {

593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {

```
([320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L320-L320),[330](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L330-L330),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L350-L350),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L593-L593),[1566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1566-L1566))
```solidity
File: contracts/libraries/InteractionHelper.sol

107:     function computeDecimals(address token) external view returns (uint8) {

```
([107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L107-L107))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {

318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L73),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L81-L81),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L91-L91),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L128-L128),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L191-L191),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L207-L207),[296](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L296-L296),[302](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L302-L302),[311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L311-L311),[318](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L318-L318),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L325-L325),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L584-L584),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[661](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L661-L661),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L738),[753](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L753-L753),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

75:     function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

```
([47](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L47-L47),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L59-L59),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L75-L75),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L241-L241),[490](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L490-L490),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L507-L507),[524](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L524-L524),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L547-L547))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

52:     function safeTransfer(address token, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L52))
```solidity
File: contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L12-L12))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {

214:     function _mint(address to, uint256 id, uint256 amount) internal {

236:     function _burn(address from, uint256 id, uint256 amount) internal {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81),[200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L200-L200),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L214),[236](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L236-L236))
```solidity
File: contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

103:     function _transferFrom(address from, address to, uint256 amount) internal {

122:     function _mint(address to, uint256 amount) internal {

136:     function _burn(address from, uint256 amount) internal {

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L81-L81),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L103),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L122),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L136-L136))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

16:     function balanceOf(address account) external view returns (uint256);

22:     function approve(address spender, uint256 amount) external;

27:     function transfer(address to, uint256 amount) external;

```
([16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L16-L16),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L22-L22),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L27-L27))
```solidity
File: contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L39),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L46),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L101),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L108),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L134),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L194),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L214),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L232))
```solidity
File: contracts/types/LiquidityChunk.sol

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L171),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L180),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {

```
([87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L87),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L96),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L108),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L118),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L128),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L148),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L169),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L183),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L193),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L366-L366),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L404),[432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L432-L432),[464](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L464-L464),[578](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L578-L578))
### <a name="NC-33"></a>[NC-33] Governance operations should be behind a timelock
All critical and governance operations should be protected by a timelock. For example from the point of view of a user, the changing of the owner of a contract is a high risk operation that may have outcomes ranging from an attacker gaining control over the protocol, to the function no longer functioning due to a typo in the destination address. To give users plenty of warning so that they can validate any ownership changes, changes of ownership should be behind a timelock.

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

864:     function delegate(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

911:     function revoke(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

995:     function takeCommissionAddData(
             address optionOwner,
             int128 longAmount,
             int128 shortAmount,
             int128 swappedAmount
         ) external onlyPanopticPool returns (int256 utilization) {

1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

```
([864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L864-L868),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[911](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L911-L915),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[995](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L995-L1000),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049))
### <a name="NC-34"></a>[NC-34] High cyclomatic complexity
Consider breaking down these blocks into more manageable units, by splitting things into utility functions, by reducing nesting, and by using early returns.

*There are 2 Instances of this issue* :
```solidity
File: contracts/SemiFungiblePositionManager.sol

958:     function _createLegInAMM(
             IUniswapV3Pool univ3pool,
             TokenId tokenId,
             uint256 leg,
             LiquidityChunk liquidityChunk,
             bool isBurn
         )
             internal
             returns (
                 LeftRightSigned moved,
                 LeftRightSigned itmAmounts,
                 LeftRightUnsigned collectedSingleLeg
             )
         {

```
([958](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L958-L971))
```solidity
File: contracts/libraries/PanopticMath.sol

768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

```
([768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777))
### <a name="NC-35"></a>[NC-35] Use a ternary statement instead of `if`/`else` when appropriate
The `if`/`else` statement can be written in a shorthand way using the ternary operator, as it increases readability and reduces the number of lines of code.

*There are 234 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

170:         if (msg.sender != address(s_panopticPool)) revert Errors.NotPanopticPool();

229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();

541:         if (msg.sender != owner) {
                 uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.
     
                 if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;
             }

544:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();

599:         if (msg.sender != owner) {
                 uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.
     
                 if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;
             }

602:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

664:                 if (positionId.isLong(leg) == 0) continue;

707:                 if (
                         (tokenType == 0 && currentValue1 < oracleValue1) ||
                         (tokenType == 1 && currentValue0 < oracleValue0)
                     )
                         exerciseFees = exerciseFees.sub(
                             LeftRightSigned
                                 .wrap(0)
                                 .toRightSlot(
                                     int128(uint128(oracleValue0)) - int128(uint128(currentValue0))
                                 )
                                 .toLeftSlot(
                                     int128(uint128(oracleValue1)) - int128(uint128(currentValue1))
                                 )
                         );

776:         if (utilization < 0) {
                 unchecked {
                     min_sell_ratio /= 2;
                     utilization = -utilization;
                 }
             }

784:         if (uint256(utilization) < TARGET_POOL_UTIL) {
                 return min_sell_ratio;
             }

790:         if (uint256(utilization) > SATURATED_POOL_UTIL) {
                 return DECIMALS;
             }

835:         if (utilization < TARGET_POOL_UTIL) {
                 return BUYER_COLLATERAL_RATIO;
             }

841:         if (utilization > SATURATED_POOL_UTIL) {
                 unchecked {
                     return BUYER_COLLATERAL_RATIO / 2;
                 }
             }

937:         if (shares > delegateeBalance) {
                 // transfer delegatee balance to delegator
                 _transferFrom(delegatee, delegator, delegateeBalance);
     
                 // this is paying out protocol loss, so correct for that in the amount of shares to be minted
                 // X: total assets in vault
                 // Y: total supply of shares
                 // Z: desired value (assets) of shares to be minted
                 // N: total shares corresponding to Z
                 // T: transferred shares from liquidatee which are a component of N but do not contribute toward protocol loss
                 // Z = N * X / (Y + N - T)
                 // Z * (Y + N - T) = N * X
                 // ZY + ZN - ZT = NX
                 // ZY - ZT = N(X - Z)
                 // N = (ZY - ZT) / (X - Z)
                 // N = Z(Y - T) / (X - Z)
                 // subtract delegatee balance from N since it was already transferred to the delegator
                 _mint(
                     delegator,
                     Math.mulDiv(
                         assets,
                         totalSupply - delegateeBalance,
                         uint256(Math.max(1, int256(totalAssets()) - int256(assets)))
                     ) - delegateeBalance
                 );
             }
             // if requested amount < delegatee balance, then just transfer shares back
             else {
                 _transferFrom(delegatee, delegator, shares);
             }

976:         if (assets > 0) {
                 _transferFrom(refunder, refundee, convertToShares(uint256(assets)));
             } else {
                 unchecked {
                     _transferFrom(refundee, refunder, convertToShares(uint256(-assets)));
                 }
             }

1010:             if (tokenToPay > 0) {
                      // if user must pay tokens, burn them from user balance
                      uint256 sharesToBurn = Math.mulDivRoundingUp(
                          uint256(tokenToPay),
                          totalSupply,
                          totalAssets()
                      );
                      _burn(optionOwner, sharesToBurn);
                  } else if (tokenToPay < 0) {
                      // if user must receive tokens, mint them
                      uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
                      _mint(optionOwner, sharesToMint);
                  }

1018:             } else if (tokenToPay < 0) {
                      // if user must receive tokens, mint them
                      uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
                      _mint(optionOwner, sharesToMint);
                  }

1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {
                      // intrinsic value is the amount that need to be exchanged due to burning in-the-money
      
                      // add the intrinsic value to the tokenToPay
                      tokenToPay += intrinsicValue;
                  }

1067:             if (tokenToPay > 0) {
                      // if user must pay tokens, burn them from user balance (revert if balance too small)
                      uint256 sharesToBurn = Math.mulDivRoundingUp(
                          uint256(tokenToPay),
                          totalSupply,
                          totalAssets()
                      );
                      _burn(optionOwner, sharesToBurn);
                  } else if (tokenToPay < 0) {
                      // if user must receive tokens, mint them
                      uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
                      _mint(optionOwner, sharesToMint);
                  }

1075:             } else if (tokenToPay < 0) {
                      // if user must receive tokens, mint them
                      uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
                      _mint(optionOwner, sharesToMint);
                  }

1107:             if (intrinsicValue != 0) {
                      // the swap commission is paid on the intrinsic value, and it is always positive
                      uint256 swapCommission = Math.unsafeDivRoundingUp(
                          s_ITMSpreadFee * uint256(Math.abs(intrinsicValue)),
                          DECIMALS
                      );
      
                      // set the exchanged amount to the sum of the intrinsic value and swapCommission
                      exchangedAmount = intrinsicValue + int256(swapCommission);
                  }

1168:         if (positionBalanceArray.length > 0) {
                  // get all collateral required for the incoming list of positions
                  tokenRequired = _getTotalRequiredCollateral(atTick, positionBalanceArray);
      
                  // If premium is negative (ie. user has to pay for their purchased options), add this long premium to the token requirement
                  if (premiumAllPositions < 0) {
                      unchecked {
                          tokenRequired += uint128(-premiumAllPositions);
                      }
                  }
              }

1173:             if (premiumAllPositions < 0) {
                      unchecked {
                          tokenRequired += uint128(-premiumAllPositions);
                      }
                  }

1182:         if (premiumAllPositions > 0) {
                  unchecked {
                      netBalance += uint256(uint128(premiumAllPositions));
                  }
              }

1257:                 if (tokenId.tokenType(index) != (underlyingIsToken0 ? 0 : 1)) continue;

1339:             if (isLong == 0) {
                      // if position is short, check whether the position is out-the-money
      
                      (int24 tickLower, int24 tickUpper) = tokenId.asTicks(index);
      
                      // compute the collateral requirement as a fixed amount that doesn't depend on price
                      if (
                          ((atTick >= tickUpper) && (tokenType == 1)) || // strike OTM when price >= upperTick for tokenType=1
                          ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0
                      ) {
                          // position is out-the-money, collateral requirement = SCR * amountMoved
                          required;
                      } else {
                          int24 strike = tokenId.strike(index);
                          // if position is ITM or ATM, then the collateral requirement depends on price:
      
                          // compute the ratio of strike to price for calls (or price to strike for puts)
                          // (- and * 2 in tick space are / and ^ 2 in price space so sqrtRatioAtTick(2 *(a - b)) = a/b (*2^96)
                          // both of these ratios decrease as the position becomes deeper ITM, and it is possible
                          // for the ratio of the prices to go under the minimum price
                          // (which is the limit of what getSqrtRatioAtTick supports)
                          // so instead we cap it at the minimum price, which is acceptable because
                          // a higher ratio will result in an increased slope for the collateral requirement
                          uint160 ratio = tokenType == 1 // tokenType
                              ? Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)
                              ) // puts ->  price/strike
                              : Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)
                              ); // calls -> strike/price
      
                          // compute the collateral requirement depending on whether the position is ITM & out-of-range or ITM and in-range:
      
                          /// ITM and out-of-range
                          if (
                              ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
                              ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
                          ) {
                              /**
                                          Short put BPR = 100% - (price/strike) + SCR
      
                                 BUYING
                                 POWER
                                 REQUIREMENT
                               
                                               ^               .         .
                                               |        <- ITM . <-ATM-> . OTM ->
                                 100% + SCR% - |--__           .    .    .
                                        100% - | . .¯¯--__     .    .    .
                                               |    .     ¯¯--__    .    .
                                         SCR - |    .          .¯¯--__________
                                               |    .          .    .    .
                                               +----+----------+----+----+--->   current
                                               0   Liqui-     Pa  strike Pb       price
                                                   dation
                                                   price = SCR*strike                                         
                               */
      
                              uint256 c2 = Constants.FP96 - ratio;
      
                              // compute the tokens required
                              // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
                              required += Math.mulDiv96RoundingUp(amountMoved, c2);
                          } else {
                              // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
                              // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
                              // the collateral requirement when in-range, which always over-estimates the amount of token required
                              // Specifically:
                              //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
                              uint160 scaleFactor = Math.getSqrtRatioAtTick(
                                  (tickUpper - strike) + (strike - tickLower)
                              );
                              uint256 c3 = Math.mulDivRoundingUp(
                                  amountMoved,
                                  scaleFactor - ratio,
                                  scaleFactor + Constants.FP96
                              );
                              // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
                              required += c3;
                          }
                      }
                  }

1345:                 if (
                          ((atTick >= tickUpper) && (tokenType == 1)) || // strike OTM when price >= upperTick for tokenType=1
                          ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0
                      ) {
                          // position is out-the-money, collateral requirement = SCR * amountMoved
                          required;
                      } else {
                          int24 strike = tokenId.strike(index);
                          // if position is ITM or ATM, then the collateral requirement depends on price:
      
                          // compute the ratio of strike to price for calls (or price to strike for puts)
                          // (- and * 2 in tick space are / and ^ 2 in price space so sqrtRatioAtTick(2 *(a - b)) = a/b (*2^96)
                          // both of these ratios decrease as the position becomes deeper ITM, and it is possible
                          // for the ratio of the prices to go under the minimum price
                          // (which is the limit of what getSqrtRatioAtTick supports)
                          // so instead we cap it at the minimum price, which is acceptable because
                          // a higher ratio will result in an increased slope for the collateral requirement
                          uint160 ratio = tokenType == 1 // tokenType
                              ? Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)
                              ) // puts ->  price/strike
                              : Math.getSqrtRatioAtTick(
                                  Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)
                              ); // calls -> strike/price
      
                          // compute the collateral requirement depending on whether the position is ITM & out-of-range or ITM and in-range:
      
                          /// ITM and out-of-range
                          if (
                              ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
                              ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
                          ) {
                              /**
                                          Short put BPR = 100% - (price/strike) + SCR
      
                                 BUYING
                                 POWER
                                 REQUIREMENT
                               
                                               ^               .         .
                                               |        <- ITM . <-ATM-> . OTM ->
                                 100% + SCR% - |--__           .    .    .
                                        100% - | . .¯¯--__     .    .    .
                                               |    .     ¯¯--__    .    .
                                         SCR - |    .          .¯¯--__________
                                               |    .          .    .    .
                                               +----+----------+----+----+--->   current
                                               0   Liqui-     Pa  strike Pb       price
                                                   dation
                                                   price = SCR*strike                                         
                               */
      
                              uint256 c2 = Constants.FP96 - ratio;
      
                              // compute the tokens required
                              // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
                              required += Math.mulDiv96RoundingUp(amountMoved, c2);
                          } else {
                              // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
                              // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
                              // the collateral requirement when in-range, which always over-estimates the amount of token required
                              // Specifically:
                              //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
                              uint160 scaleFactor = Math.getSqrtRatioAtTick(
                                  (tickUpper - strike) + (strike - tickLower)
                              );
                              uint256 c3 = Math.mulDivRoundingUp(
                                  amountMoved,
                                  scaleFactor - ratio,
                                  scaleFactor + Constants.FP96
                              );
                              // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
                              required += c3;
                          }
                      }

1373:                     if (
                              ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
                              ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
                          ) {
                              /**
                                          Short put BPR = 100% - (price/strike) + SCR
      
                                 BUYING
                                 POWER
                                 REQUIREMENT
                               
                                               ^               .         .
                                               |        <- ITM . <-ATM-> . OTM ->
                                 100% + SCR% - |--__           .    .    .
                                        100% - | . .¯¯--__     .    .    .
                                               |    .     ¯¯--__    .    .
                                         SCR - |    .          .¯¯--__________
                                               |    .          .    .    .
                                               +----+----------+----+----+--->   current
                                               0   Liqui-     Pa  strike Pb       price
                                                   dation
                                                   price = SCR*strike                                         
                               */
      
                              uint256 c2 = Constants.FP96 - ratio;
      
                              // compute the tokens required
                              // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
                              required += Math.mulDiv96RoundingUp(amountMoved, c2);
                          } else {
                              // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
                              // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
                              // the collateral requirement when in-range, which always over-estimates the amount of token required
                              // Specifically:
                              //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
                              uint160 scaleFactor = Math.getSqrtRatioAtTick(
                                  (tickUpper - strike) + (strike - tickLower)
                              );
                              uint256 c3 = Math.mulDivRoundingUp(
                                  amountMoved,
                                  scaleFactor - ratio,
                                  scaleFactor + Constants.FP96
                              );
                              // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
                              required += c3;
                          }

1450:         if (isLong != tokenId.isLong(partnerIndex)) {
                  if (isLong == 1) {
                      // compute the total amount of funds moved for that position
                      required = _computeSpread(
                          tokenId,
                          positionSize,
                          index,
                          partnerIndex,
                          poolUtilization
                      );
                  }
              } else {
                  required = _computeStrangle(tokenId, index, positionSize, atTick, poolUtilization);
              }

1451:             if (isLong == 1) {
                      // compute the total amount of funds moved for that position
                      required = _computeSpread(
                          tokenId,
                          positionSize,
                          index,
                          partnerIndex,
                          poolUtilization
                      );
                  }

1479:         if (isLong == 0) {
                  // compute the sell collateral ratio, which depends on the pool utilization
                  uint256 sellCollateral = _sellCollateralRatio(utilization);
      
                  // compute required as amount*collateralRatio
                  // can use unsafe because denominator is always nonzero
                  unchecked {
                      required = Math.unsafeDivRoundingUp(amount * sellCollateral, DECIMALS);
                  }
              } else if (isLong == 1) {
                  // if options is long, use buy collateral ratio
                  // compute the buy collateral ratio, which depends on the pool utilization
                  uint256 buyCollateral = _buyCollateralRatio(uint256(utilization));
      
                  // compute required as amount*collateralRatio
                  // can use unsafe because denominator is always nonzero
                  unchecked {
                      required = Math.unsafeDivRoundingUp(amount * buyCollateral, DECIMALS);
                  }
              }

1488:         } else if (isLong == 1) {
                  // if options is long, use buy collateral ratio
                  // compute the buy collateral ratio, which depends on the pool utilization
                  uint256 buyCollateral = _buyCollateralRatio(uint256(utilization));
      
                  // compute required as amount*collateralRatio
                  // can use unsafe because denominator is always nonzero
                  unchecked {
                      required = Math.unsafeDivRoundingUp(amount * buyCollateral, DECIMALS);
                  }
              }

1541:         if (tokenId.asset(index) != tokenType) {
                  unchecked {
                      // always take the absolute values of the difference of amounts moved
                      if (tokenType == 0) {
                          spreadRequirement = movedRight < movedPartnerRight
                              ? movedPartnerRight - movedRight
                              : movedRight - movedPartnerRight;
                      } else {
                          spreadRequirement = movedLeft < movedPartnerLeft
                              ? movedPartnerLeft - movedLeft
                              : movedLeft - movedPartnerLeft;
                      }
                  }
              } else {
                  unchecked {
                      uint256 notional;
                      uint256 notionalP;
                      uint128 contracts;
                      if (tokenType == 1) {
                          notional = movedRight;
                          notionalP = movedPartnerRight;
                          contracts = movedLeft;
                      } else {
                          notional = movedLeft;
                          notionalP = movedPartnerLeft;
                          contracts = movedRight;
                      }
                      // the required amount is the amount of contracts multiplied by (notional1 - notional2)/min(notional1, notional2)
                      // can use unsafe because denominator is always nonzero
                      spreadRequirement = (notional < notionalP)
                          ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)
                          : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);
                  }
              }

1544:                 if (tokenType == 0) {
                          spreadRequirement = movedRight < movedPartnerRight
                              ? movedPartnerRight - movedRight
                              : movedRight - movedPartnerRight;
                      } else {
                          spreadRequirement = movedLeft < movedPartnerLeft
                              ? movedPartnerLeft - movedLeft
                              : movedLeft - movedPartnerLeft;
                      }

1559:                 if (tokenType == 1) {
                          notional = movedRight;
                          notionalP = movedPartnerRight;
                          contracts = movedLeft;
                      } else {
                          notional = movedLeft;
                          notionalP = movedPartnerLeft;
                          contracts = movedRight;
                      }

```
([170](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L170-L170),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L229-L229),[331](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L331-L331),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L350-L350),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L418-L418),[480](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L480-L480),[536](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L536-L536),[541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L541-L545),[544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L544-L544),[596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L596-L596),[599](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L599-L603),[602](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L602-L602),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L664-L664),[707](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L707-L720),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L776-L781),[784](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L784-L786),[790](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L790-L792),[835](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L835-L837),[841](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L841-L845),[937](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L937-L966),[976](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L976-L982),[1010](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1010-L1022),[1018](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1018-L1022),[1060](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1060-L1065),[1067](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1067-L1079),[1075](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1075-L1079),[1107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1107-L1116),[1168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1168-L1178),[1173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1173-L1177),[1182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1182-L1186),[1257](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1257-L1257),[1339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1339-L1420),[1345](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1345-L1419),[1373](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1373-L1418),[1450](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1450-L1463),[1451](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1451-L1460),[1479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1479-L1498),[1488](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1488-L1498),[1541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1541-L1574),[1544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1544-L1552),[1559](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1559-L1567))
```solidity
File: contracts/PanopticFactory.sol

135:         if (!s_initialized) {
                 s_owner = _owner;
                 s_initialized = true;
             }

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

181:         if (amount0Owed > 0)
                 SafeTransferLib.safeTransferFrom(
                     decoded.poolFeatures.token0,
                     decoded.payer,
                     msg.sender,
                     amount0Owed
                 );

188:         if (amount1Owed > 0)
                 SafeTransferLib.safeTransferFrom(
                     decoded.poolFeatures.token1,
                     decoded.payer,
                     msg.sender,
                     amount1Owed
                 );

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

227:         if (address(v3Pool) == address(0)) revert Errors.UniswapPoolNotInitialized();

229:         if (address(s_getPanopticPool[v3Pool]) != address(0))
                 revert Errors.PoolAlreadyInitialized();

308:             if (rarity > highestRarity) {
                     // found a more rare address at this nonce
                     highestRarity = rarity;
                     bestSalt = salt;
                 }

314:             if (rarity >= minTargetRarity) {
                     // desired target met
                     highestRarity = rarity;
                     bestSalt = salt;
                     break;
                 }

351:             if (token0 == WETH) {
                     fullRangeLiquidity = uint128(
                         Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_WETH, currentSqrtPriceX96)
                     );
                 } else if (token1 == WETH) {
                     fullRangeLiquidity = uint128(
                         Math.mulDivRoundingUp(
                             FULL_RANGE_LIQUIDITY_AMOUNT_WETH,
                             Constants.FP96,
                             currentSqrtPriceX96
                         )
                     );
                 } else {
                     // Find the resulting liquidity for providing 1e6 of both tokens
                     uint128 liquidity0 = uint128(
                         Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN, currentSqrtPriceX96)
                     );
                     uint128 liquidity1 = uint128(
                         Math.mulDivRoundingUp(
                             FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN,
                             Constants.FP96,
                             currentSqrtPriceX96
                         )
                     );
     
                     // Pick the greater of the liquidities - i.e the more "expensive" option
                     // This ensures that the liquidity added is sufficiently large
                     fullRangeLiquidity = liquidity0 > liquidity1 ? liquidity0 : liquidity1;
                 }

355:             } else if (token1 == WETH) {
                     fullRangeLiquidity = uint128(
                         Math.mulDivRoundingUp(
                             FULL_RANGE_LIQUIDITY_AMOUNT_WETH,
                             Constants.FP96,
                             currentSqrtPriceX96
                         )
                     );
                 } else {
                     // Find the resulting liquidity for providing 1e6 of both tokens
                     uint128 liquidity0 = uint128(
                         Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN, currentSqrtPriceX96)
                     );
                     uint128 liquidity1 = uint128(
                         Math.mulDivRoundingUp(
                             FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN,
                             Constants.FP96,
                             currentSqrtPriceX96
                         )
                     );
     
                     // Pick the greater of the liquidities - i.e the more "expensive" option
                     // This ensures that the liquidity added is sufficiently large
                     fullRangeLiquidity = liquidity0 > liquidity1 ? liquidity0 : liquidity1;
                 }

```
([135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L135-L138),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L150-L150),[181](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L181-L187),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L188-L194),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L220-L220),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L224-L224),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L227-L227),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L229-L230),[308](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L308-L312),[314](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L314-L319),[351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L351-L379),[355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L355-L379))
```solidity
File: contracts/PanopticPool.sol

299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();

341:         if (currentSqrtPriceX96 <= sqrtLowerBound || currentSqrtPriceX96 >= sqrtUpperBound) {
                 revert Errors.PriceBoundFail();
             }

460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {
                         bytes32 chunkKey = keccak256(
                             abi.encodePacked(
                                 tokenId.strike(leg),
                                 tokenId.width(leg),
                                 tokenId.tokenType(leg)
                             )
                         );
     
                         LeftRightUnsigned availablePremium = _getAvailablePremium(
                             _getTotalLiquidity(tokenId, leg),
                             s_settledTokens[chunkKey],
                             s_grossPremiumLast[chunkKey],
                             LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),
                             premiumAccumulatorsByLeg[leg]
                         );
                         portfolioPremium = portfolioPremium.add(
                             LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
                         );
                     } else {
                         portfolioPremium = portfolioPremium.add(premiaByLeg[leg]);
                     }

504:         if (tickLimitLow == tickLimitHigh) {
                 // note the reversed order of the ticks
                 return (MAX_SWAP_TICK, MIN_SWAP_TICK);
             }

510:         if (tickLimitLow < tickLimitHigh) {
                 return (tickLimitHigh, tickLimitLow);
             }

533:         if (medianData != 0) s_miniMedian = medianData;

633:         if (tokenId.poolId() != SFPM.getPoolId(address(s_univ3pool)))
                 revert Errors.InvalidTokenIdParameter(0);

638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)
                 revert Errors.PositionAlreadyMinted();

664:         if (medianData != 0) s_miniMedian = medianData;

768:             if (isLong == 1) {
                     // Move this into a new function
                     _checkLiquiditySpread(
                         tokenId,
                         leg,
                         tickLower,
                         tickUpper,
                         uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))
                     );
                 }

865:             if (tokenId.isLong(leg) == 0) {
                     // Check the liquidity spread, make sure that closing the option does not exceed the MAX_SPREAD allowed
                     (int24 tickLower, int24 tickUpper) = tokenId.asTicks(leg);
                     _checkLiquiditySpread(tokenId, leg, tickLower, tickUpper, MAX_SPREAD);
                 }

914:         if (SLOW_ORACLE_UNISWAP_MODE) {
                 slowOracleTick = PanopticMath.computeMedianObservedPrice(
                     _univ3pool,
                     observationIndex,
                     observationCardinality,
                     SLOW_ORACLE_CARDINALITY,
                     SLOW_ORACLE_PERIOD
                 );
             } else {
                 (slowOracleTick, medianData) = PanopticMath.computeInternalMedian(
                     observationIndex,
                     observationCardinality,
                     MEDIAN_PERIOD,
                     s_miniMedian,
                     _univ3pool
                 );
             }

940:         if (!solventAtFast) revert Errors.NotEnoughCollateral();

943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)
                 if (!_checkSolvencyAtTick(user, positionIdList, currentTick, slowOracleTick, buffer))
                     revert Errors.NotEnoughCollateral();

944:             if (!_checkSolvencyAtTick(user, positionIdList, currentTick, slowOracleTick, buffer))
                     revert Errors.NotEnoughCollateral();

1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)
                      revert Errors.StaleTWAP();

1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();

1155:         if (
                  !_checkSolvencyAtTick(
                      msg.sender,
                      positionIdListLiquidator,
                      finalTick,
                      finalTick,
                      BP_DECREASE_BUFFER
                  )
              ) revert Errors.NotEnoughCollateral();

1188:         if (touchedId.length != 1) revert Errors.InputListFail();

1274:         if (positionIdListExercisor.length > 0)
                  _validateSolvency(msg.sender, positionIdListExercisor, BP_DECREASE_BUFFER);

1394:         if (fingerprintIncomingList != currentHash) revert Errors.InputListFail();

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1483:         if (netLiquidity == 0) return;

1492:         if (effectiveLiquidityFactorX32 > uint256(effectiveLiquidityLimitX32))
                  revert Errors.EffectiveLiquidityAboveThreshold();

1520:             if ((isLong == 1) || computeAllPremia) {
                      LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                          tokenId,
                          leg,
                          positionSize
                      );
                      uint256 tokenType = tokenId.tokenType(leg);
      
                      (premiumAccumulatorsByLeg[leg][0], premiumAccumulatorsByLeg[leg][1]) = SFPM
                          .getAccountPremium(
                              address(s_univ3pool),
                              address(this),
                              tokenType,
                              liquidityChunk.tickLower(),
                              liquidityChunk.tickUpper(),
                              atTick,
                              isLong
                          );
      
                      unchecked {
                          LeftRightUnsigned premiumAccumulatorLast = s_options[owner][tokenId][leg];
      
                          // if the premium accumulatorLast is higher than current, it means the premium accumulator has overflowed and rolled over at least once
                          // we can account for one rollover by doing (acc_cur + (acc_max - acc_last))
                          // if there are multiple rollovers or the rollover goes past the last accumulator, rolled over fees will just remain unclaimed
                          premiaByLeg[leg] = LeftRightSigned
                              .wrap(0)
                              .toRightSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              )
                              .toLeftSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              );
      
                          if (isLong == 1) {
                              premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
                          }
                      }
                  }

1566:                     if (isLong == 1) {
                              premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
                          }

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

1679:             if (tokenId.isLong(leg) == 0) {
                      LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
                          tokenId,
                          leg,
                          positionSize
                      );
      
                      // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (R + N)
                      uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
      
                      // We need to adjust the grossPremiumLast value such that the result of
                      // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostMint/2**64 is equal to (grossPremium - grossPremiumLast)*totalLiquidityBeforeMint/2**64
                      // G: total gross premium
                      // T: totalLiquidityBeforeMint
                      // R: positionLiquidity
                      // C: current grossPremium value
                      // L: current grossPremiumLast value
                      // Ln: updated grossPremiumLast value
                      // T * (C - L) = G
                      // (T + R) * (C - Ln) = G
                      //
                      // T * (C - L) = (T + R) * (C - Ln)
                      // (TC - TL) / (T + R) = C - Ln
                      // Ln = C - (TC - TL)/(T + R)
                      // Ln = (CT + CR - TC + TL)/(T+R)
                      // Ln = (CR + TL)/(T+R)
      
                      uint256[2] memory grossCurrent;
                      (grossCurrent[0], grossCurrent[1]) = SFPM.getAccountPremium(
                          address(s_univ3pool),
                          address(this),
                          tokenId.tokenType(leg),
                          liquidityChunk.tickLower(),
                          liquidityChunk.tickUpper(),
                          type(int24).max,
                          0
                      );
      
                      unchecked {
                          // L
                          LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
                          // R
                          uint256 positionLiquidity = liquidityChunk.liquidity();
                          // T (totalLiquidity is (T + R) after minting)
                          uint256 totalLiquidityBefore = totalLiquidity - positionLiquidity;
      
                          s_grossPremiumLast[chunkKey] = LeftRightUnsigned
                              .wrap(0)
                              .toRightSlot(
                                  uint128(
                                      (grossCurrent[0] *
                                          positionLiquidity +
                                          grossPremiumLast.rightSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)
                                  )
                              )
                              .toLeftSlot(
                                  uint128(
                                      (grossCurrent[1] *
                                          positionLiquidity +
                                          grossPremiumLast.leftSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)
                                  )
                              );
                      }
                  }

1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {
                      // (will be) paid by long legs
                      if (tokenId.isLong(leg) == 1) {
                          if (commitLongSettled)
                              settledTokens = LeftRightUnsigned.wrap(
                                  uint256(
                                      LeftRightSigned.unwrap(
                                          LeftRightSigned
                                              .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))
                                              .sub(legPremia)
                                      )
                                  )
                              );
                          realizedPremia = realizedPremia.add(legPremia);
                      } else {
                          uint256 positionLiquidity = PanopticMath
                              .getLiquidityChunk(tokenId, leg, positionSize)
                              .liquidity();
      
                          // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (T - R)
                          uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
                          // T (totalLiquidity is (T - R) after burning)
                          uint256 totalLiquidityBefore = totalLiquidity + positionLiquidity;
      
                          LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
      
                          LeftRightUnsigned availablePremium = _getAvailablePremium(
                              totalLiquidity + positionLiquidity,
                              settledTokens,
                              grossPremiumLast,
                              LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
                              premiumAccumulatorsByLeg[leg]
                          );
      
                          // subtract settled tokens sent to seller
                          settledTokens = settledTokens.sub(availablePremium);
      
                          // add available premium to amount that should be settled
                          realizedPremia = realizedPremia.add(
                              LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
                          );
      
                          // We need to adjust the grossPremiumLast value such that the result of
                          // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostBurn/2**64 is equal to
                          // (grossPremium - grossPremiumLast)*totalLiquidityBeforeBurn/2**64 - premiumOwedToPosition
                          // G: total gross premium (- premiumOwedToPosition)
                          // T: totalLiquidityBeforeMint
                          // R: positionLiquidity
                          // C: current grossPremium value
                          // L: current grossPremiumLast value
                          // Ln: updated grossPremiumLast value
                          // T * (C - L) = G
                          // (T - R) * (C - Ln) = G - P
                          //
                          // T * (C - L) = (T - R) * (C - Ln) + P
                          // (TC - TL - P) / (T - R) = C - Ln
                          // Ln = C - (TC - TL - P) / (T - R)
                          // Ln = (TC - CR - TC + LT + P) / (T-R)
                          // Ln = (LT - CR + P) / (T-R)
      
                          unchecked {
                              uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;
                              uint256 _leg = leg;
      
                              // if there's still liquidity, compute the new grossPremiumLast
                              // otherwise, we just reset grossPremiumLast to the current grossPremium
                              s_grossPremiumLast[chunkKey] = totalLiquidity != 0
                                  ? LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.rightSlot() * 2 ** 64),
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                      .toLeftSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.leftSlot()) * 2 ** 64,
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                  : LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
                                      .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));
                          }
                      }
                  }

1864:                 if (tokenId.isLong(leg) == 1) {
                          if (commitLongSettled)
                              settledTokens = LeftRightUnsigned.wrap(
                                  uint256(
                                      LeftRightSigned.unwrap(
                                          LeftRightSigned
                                              .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))
                                              .sub(legPremia)
                                      )
                                  )
                              );
                          realizedPremia = realizedPremia.add(legPremia);
                      } else {
                          uint256 positionLiquidity = PanopticMath
                              .getLiquidityChunk(tokenId, leg, positionSize)
                              .liquidity();
      
                          // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (T - R)
                          uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
                          // T (totalLiquidity is (T - R) after burning)
                          uint256 totalLiquidityBefore = totalLiquidity + positionLiquidity;
      
                          LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
      
                          LeftRightUnsigned availablePremium = _getAvailablePremium(
                              totalLiquidity + positionLiquidity,
                              settledTokens,
                              grossPremiumLast,
                              LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
                              premiumAccumulatorsByLeg[leg]
                          );
      
                          // subtract settled tokens sent to seller
                          settledTokens = settledTokens.sub(availablePremium);
      
                          // add available premium to amount that should be settled
                          realizedPremia = realizedPremia.add(
                              LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
                          );
      
                          // We need to adjust the grossPremiumLast value such that the result of
                          // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostBurn/2**64 is equal to
                          // (grossPremium - grossPremiumLast)*totalLiquidityBeforeBurn/2**64 - premiumOwedToPosition
                          // G: total gross premium (- premiumOwedToPosition)
                          // T: totalLiquidityBeforeMint
                          // R: positionLiquidity
                          // C: current grossPremium value
                          // L: current grossPremiumLast value
                          // Ln: updated grossPremiumLast value
                          // T * (C - L) = G
                          // (T - R) * (C - Ln) = G - P
                          //
                          // T * (C - L) = (T - R) * (C - Ln) + P
                          // (TC - TL - P) / (T - R) = C - Ln
                          // Ln = C - (TC - TL - P) / (T - R)
                          // Ln = (TC - CR - TC + LT + P) / (T-R)
                          // Ln = (LT - CR + P) / (T-R)
      
                          unchecked {
                              uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;
                              uint256 _leg = leg;
      
                              // if there's still liquidity, compute the new grossPremiumLast
                              // otherwise, we just reset grossPremiumLast to the current grossPremium
                              s_grossPremiumLast[chunkKey] = totalLiquidity != 0
                                  ? LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.rightSlot() * 2 ** 64),
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                      .toLeftSlot(
                                          uint128(
                                              uint256(
                                                  Math.max(
                                                      (int256(
                                                          grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.leftSlot()) * 2 ** 64,
                                                      0
                                                  )
                                              ) / totalLiquidity
                                          )
                                      )
                                  : LeftRightUnsigned
                                      .wrap(0)
                                      .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
                                      .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));
                          }
                      }

1865:                     if (commitLongSettled)
                              settledTokens = LeftRightUnsigned.wrap(
                                  uint256(
                                      LeftRightSigned.unwrap(
                                          LeftRightSigned
                                              .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))
                                              .sub(legPremia)
                                      )
                                  )
                              );

```
([299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L299-L299),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L341-L343),[460](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L460-L481),[504](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L504-L507),[510](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L510-L512),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L533-L533),[633](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L633-L634),[638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L638-L639),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L664-L664),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L768-L777),[865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L865-L869),[914](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L914-L930),[940](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L940-L940),[943](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L943-L945),[944](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L944-L945),[1035](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1035-L1036),[1066](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1066-L1066),[1155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1155-L1163),[1188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1188-L1188),[1274](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1274-L1275),[1394](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1394-L1394),[1415](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1415-L1415),[1483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1483-L1483),[1492](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1492-L1493),[1520](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1520-L1570),[1566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1566-L1568),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596),[1679](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1679-L1744),[1862](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1862-L1971),[1864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1864-L1970),[1865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1865-L1874))
```solidity
File: contracts/SemiFungiblePositionManager.sol

322:         if (s_poolContext[poolId].locked) revert Errors.ReentrantCall();

355:         if (univ3pool == address(0)) revert Errors.UniswapPoolNotInitialized();

362:         if (s_AddrToPoolIdData[univ3pool] != 0) return;

412:         if (amount0Owed > 0)
                 SafeTransferLib.safeTransferFrom(
                     decoded.poolFeatures.token0,
                     decoded.payer,
                     msg.sender,
                     amount0Owed
                 );

419:         if (amount1Owed > 0)
                 SafeTransferLib.safeTransferFrom(
                     decoded.poolFeatures.token1,
                     decoded.payer,
                     msg.sender,
                     amount1Owed
                 );

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

631:             if (
                     (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||
                     (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)
                 ) revert Errors.TransferFailed();

638:             if (LeftRightUnsigned.unwrap(fromLiq) != liquidityChunk.liquidity())
                     revert Errors.TransferFailed();

688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

691:         if (isBurn) {
                 tokenId = tokenId.flipToBurnToken();
             }

702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();

715:         if (tickLimitLow > tickLimitHigh) {
                 // if the in-the-money amount is not zero (i.e. positions were minted ITM) and the user did provide tick limits LOW > HIGH, then swap necessary amounts
                 if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {
                     totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);
                 }
     
                 (tickLimitLow, tickLimitHigh) = (tickLimitHigh, tickLimitLow);
             }

717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {
                     totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);
                 }

727:         if ((currentTick >= tickLimitHigh) || (currentTick <= tickLimitLow))
                 revert Errors.PriceBoundFail();

787:             if ((itm0 != 0) && (itm1 != 0)) {
                     (uint160 sqrtPriceX96, , , , , , ) = _univ3pool.slot0();
     
                     // implement a single "netting" swap. Thank you @danrobinson for this puzzle/idea
                     // note: negative ITM amounts denote a surplus of tokens (burning liquidity), while positive amounts denote a shortage of tokens (minting liquidity)
                     // compute the approximate delta of token0 that should be resolved in the swap at the current tick
                     // we do this by flipping the signs on the token1 ITM amount converting+deducting it against the token0 ITM amount
                     // couple examples (price = 2 1/0):
                     //  - 100 surplus 0, 100 surplus 1 (itm0 = -100, itm1 = -100)
                     //    normal swap 0: 100 0 => 200 1
                     //    normal swap 1: 100 1 => 50 0
                     //    final swap amounts: 50 0 => 100 1
                     //    netting swap: net0 = -100 - (-100/2) = -50, ZF1 = true, 50 0 => 100 1
                     // - 100 surplus 0, 100 shortage 1 (itm0 = -100, itm1 = 100)
                     //    normal swap 0: 100 0 => 200 1
                     //    normal swap 1: 50 0 => 100 1
                     //    final swap amounts: 150 0 => 300 1
                     //    netting swap: net0 = -100 - (100/2) = -150, ZF1 = true, 150 0 => 300 1
                     // - 100 shortage 0, 100 surplus 1 (itm0 = 100, itm1 = -100)
                     //    normal swap 0: 200 1 => 100 0
                     //    normal swap 1: 100 1 => 50 0
                     //    final swap amounts: 300 1 => 150 0
                     //    netting swap: net0 = 100 - (-100/2) = 150, ZF1 = false, 300 1 => 150 0
                     // - 100 shortage 0, 100 shortage 1 (itm0 = 100, itm1 = 100)
                     //    normal swap 0: 200 1 => 100 0
                     //    normal swap 1: 50 0 => 100 1
                     //    final swap amounts: 100 1 => 50 0
                     //    netting swap: net0 = 100 - (100/2) = 50, ZF1 = false, 100 1 => 50 0
                     // - = Net surplus of token0
                     // + = Net shortage of token0
                     int256 net0 = itm0 - PanopticMath.convert1to0(itm1, sqrtPriceX96);
     
                     zeroForOne = net0 < 0;
     
                     //compute the swap amount, set as positive (exact input)
                     swapAmount = -net0;
                 } else if (itm0 != 0) {
                     zeroForOne = itm0 < 0;
                     swapAmount = -itm0;
                 } else {
                     zeroForOne = itm1 > 0;
                     swapAmount = -itm1;
                 }

823:             } else if (itm0 != 0) {
                     zeroForOne = itm0 < 0;
                     swapAmount = -itm0;
                 } else {
                     zeroForOne = itm1 > 0;
                     swapAmount = -itm1;
                 }

833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

939:         if (amount0 > uint128(type(int128).max) || amount1 > uint128(type(int128).max))
                 revert Errors.PositionTooLarge();

999:             if (isLong == 0) {
                     // selling/short: so move from msg.sender *to* uniswap
                     // we're minting more liquidity in uniswap: so add the incoming liquidity chunk to the existing liquidity chunk
                     updatedLiquidity = startingLiquidity + chunkLiquidity;
     
                     /// @dev If the isLong flag is 0=short but the position was burnt, then this is closing a long position
                     /// @dev so the amount of removed liquidity should decrease.
                     if (isBurn) {
                         removedLiquidity -= chunkLiquidity;
                     }
                 } else {
                     // the _leg is long (buying: moving *from* uniswap to msg.sender)
                     // so we seek to move the incoming liquidity chunk *out* of uniswap - but was there sufficient liquidity sitting in uniswap
                     // in the first place?
                     if (startingLiquidity < chunkLiquidity) {
                         // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
                         // what the account that owns the liquidity in uniswap has (startingLiquidity)
                         // we must ensure that an account can only move its own liquidity out of uniswap
                         // so we revert in this case
                         revert Errors.NotEnoughLiquidity();
                     } else {
                         // startingLiquidity is >= chunkLiquidity, so no possible underflow
                         unchecked {
                             // we want to move less than what already sits in uniswap, no problem:
                             updatedLiquidity = startingLiquidity - chunkLiquidity;
                         }
                     }
     
                     /// @dev If the isLong flag is 1=long and the position is minted, then this is opening a long position
                     /// @dev so the amount of removed liquidity should increase.
                     if (!isBurn) {
                         // we can't remove more liquidity than we add in the first place, so this can't overflow
                         unchecked {
                             removedLiquidity += chunkLiquidity;
                         }
                     }
                 }

1006:                 if (isBurn) {
                          removedLiquidity -= chunkLiquidity;
                      }

1013:                 if (startingLiquidity < chunkLiquidity) {
                          // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
                          // what the account that owns the liquidity in uniswap has (startingLiquidity)
                          // we must ensure that an account can only move its own liquidity out of uniswap
                          // so we revert in this case
                          revert Errors.NotEnoughLiquidity();
                      } else {
                          // startingLiquidity is >= chunkLiquidity, so no possible underflow
                          unchecked {
                              // we want to move less than what already sits in uniswap, no problem:
                              updatedLiquidity = startingLiquidity - chunkLiquidity;
                          }
                      }

1029:                 if (!isBurn) {
                          // we can't remove more liquidity than we add in the first place, so this can't overflow
                          unchecked {
                              removedLiquidity += chunkLiquidity;
                          }
                      }

1073:             if (tokenType == 1) {
                      // extract amount moved out of UniswapV3 pool
                      itmAmounts = itmAmounts.toRightSlot(moved.rightSlot());
                  }

1078:             if (tokenType == 0) {
                      // Add this in-the-money amount transacted.
                      itmAmounts = itmAmounts.toLeftSlot(moved.leftSlot());
                  }

1085:         if (currentLiquidity.rightSlot() > 0) {
                  collectedSingleLeg = _collectAndWritePositionData(
                      liquidityChunk,
                      univ3pool,
                      currentLiquidity,
                      positionKey,
                      moved,
                      isLong
                  );
              }

1275:         if (isLong == 1) {
                  amountToCollect = amountToCollect.sub(movedInLeg);
              }

1279:         if (LeftRightSigned.unwrap(amountToCollect) != 0) {
                  // first collect amounts from Uniswap corresponding to this position
                  // Collect only if there was existing startingLiquidity=liquidities.rightSlot() at that position: collect all fees
      
                  // Collects tokens owed to a liquidity chunk
                  (uint128 receivedAmount0, uint128 receivedAmount1) = univ3pool.collect(
                      msg.sender,
                      liquidityChunk.tickLower(),
                      liquidityChunk.tickUpper(),
                      uint128(amountToCollect.rightSlot()),
                      uint128(amountToCollect.leftSlot())
                  );
      
                  // moved will be negative if the leg was long (funds left the caller, don't count it in collected fees)
                  uint128 collected0;
                  uint128 collected1;
                  unchecked {
                      collected0 = movedInLeg.rightSlot() < 0
                          ? receivedAmount0 - uint128(-movedInLeg.rightSlot())
                          : receivedAmount0;
                      collected1 = movedInLeg.leftSlot() < 0
                          ? receivedAmount1 - uint128(-movedInLeg.leftSlot())
                          : receivedAmount1;
                  }
      
                  // CollectedOut is the amount of fees accumulated+collected (received - burnt)
                  // That's because receivedAmount contains the burnt tokens and whatever amount of fees collected
                  collectedChunk = LeftRightUnsigned.wrap(0).toRightSlot(collected0).toLeftSlot(
                      collected1
                  );
      
                  // record the collected amounts in the s_accountPremiumOwed and s_accountPremiumGross accumulators
                  _updateStoredPremia(positionKey, currentLiquidity, collectedChunk);
              }

1465:         if (atTick < type(int24).max) {
                  // unique key to identify the liquidity chunk in this uniswap pool
                  LeftRightUnsigned accountLiquidities = s_accountLiquidity[positionKey];
                  uint128 netLiquidity = accountLiquidities.rightSlot();
                  if (netLiquidity != 0) {
                      LeftRightUnsigned amountToCollect;
                      {
                          IUniswapV3Pool _univ3pool = IUniswapV3Pool(univ3pool);
                          int24 _tickLower = tickLower;
                          int24 _tickUpper = tickUpper;
      
                          // how much fees have been accumulated within the liquidity chunk since last time we updated this chunk?
                          // Compute (currentFeesGrowth - oldFeesGrowth), the amount to collect
                          // currentFeesGrowth (calculated from FeesCalc.calculateAMMSwapFeesLiquidityChunk) is (ammFeesCollectedPerLiquidity * liquidityChunk.liquidity())
                          // oldFeesGrowth is the last stored update of fee growth within the position range in the past (feeGrowthRange*liquidityChunk.liquidity()) (s_accountFeesBase[positionKey])
                          LeftRightSigned feesBase = FeesCalc.calculateAMMSwapFees(
                              _univ3pool,
                              atTick,
                              _tickLower,
                              _tickUpper,
                              netLiquidity
                          );
      
                          // If the current feesBase is close or identical to the stored one, the amountToCollect can be negative.
                          // This is because the stored feesBase is rounded up, and the current feesBase is rounded down.
                          // When this is the case, we want to behave as if there are 0 fees, so we just rectify the values.
                          // Guaranteed to be positive, so swap to unsigned type
                          amountToCollect = LeftRightUnsigned.wrap(
                              uint256(
                                  LeftRightSigned.unwrap(feesBase.subRect(s_accountFeesBase[positionKey]))
                              )
                          );
                      }
      
                      (LeftRightUnsigned premiumOwed, LeftRightUnsigned premiumGross) = _getPremiaDeltas(
                          accountLiquidities,
                          amountToCollect
                      );
      
                      // add deltas to accumulators and freeze both accumulators (for a token) if one of them overflows
                      // (i.e if only token0 (right slot) of the owed premium overflows, then stop accumulating  both token0 owed premium and token0 gross premium for the chunk)
                      // this prevents situations where the owed premium gets out of sync with the gross premium due to one of them overflowing
                      (premiumOwed, premiumGross) = LeftRightLibrary.addCapped(
                          s_accountPremiumOwed[positionKey],
                          premiumOwed,
                          s_accountPremiumGross[positionKey],
                          premiumGross
                      );
      
                      acctPremia = isLong == 1 ? premiumOwed : premiumGross;
                  }
              } else {
                  // Extract the account liquidity for a given uniswap pool, owner, token type, and ticks
                  acctPremia = isLong == 1
                      ? s_accountPremiumOwed[positionKey]
                      : s_accountPremiumGross[positionKey];
              }

1469:             if (netLiquidity != 0) {
                      LeftRightUnsigned amountToCollect;
                      {
                          IUniswapV3Pool _univ3pool = IUniswapV3Pool(univ3pool);
                          int24 _tickLower = tickLower;
                          int24 _tickUpper = tickUpper;
      
                          // how much fees have been accumulated within the liquidity chunk since last time we updated this chunk?
                          // Compute (currentFeesGrowth - oldFeesGrowth), the amount to collect
                          // currentFeesGrowth (calculated from FeesCalc.calculateAMMSwapFeesLiquidityChunk) is (ammFeesCollectedPerLiquidity * liquidityChunk.liquidity())
                          // oldFeesGrowth is the last stored update of fee growth within the position range in the past (feeGrowthRange*liquidityChunk.liquidity()) (s_accountFeesBase[positionKey])
                          LeftRightSigned feesBase = FeesCalc.calculateAMMSwapFees(
                              _univ3pool,
                              atTick,
                              _tickLower,
                              _tickUpper,
                              netLiquidity
                          );
      
                          // If the current feesBase is close or identical to the stored one, the amountToCollect can be negative.
                          // This is because the stored feesBase is rounded up, and the current feesBase is rounded down.
                          // When this is the case, we want to behave as if there are 0 fees, so we just rectify the values.
                          // Guaranteed to be positive, so swap to unsigned type
                          amountToCollect = LeftRightUnsigned.wrap(
                              uint256(
                                  LeftRightSigned.unwrap(feesBase.subRect(s_accountFeesBase[positionKey]))
                              )
                          );
                      }
      
                      (LeftRightUnsigned premiumOwed, LeftRightUnsigned premiumGross) = _getPremiaDeltas(
                          accountLiquidities,
                          amountToCollect
                      );
      
                      // add deltas to accumulators and freeze both accumulators (for a token) if one of them overflows
                      // (i.e if only token0 (right slot) of the owed premium overflows, then stop accumulating  both token0 owed premium and token0 gross premium for the chunk)
                      // this prevents situations where the owed premium gets out of sync with the gross premium due to one of them overflowing
                      (premiumOwed, premiumGross) = LeftRightLibrary.addCapped(
                          s_accountPremiumOwed[positionKey],
                          premiumOwed,
                          s_accountPremiumGross[positionKey],
                          premiumGross
                      );
      
                      acctPremia = isLong == 1 ? premiumOwed : premiumGross;
                  }

```
([322](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L322-L322),[355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L355-L355),[362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L362-L362),[412](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L412-L418),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L419-L425),[549](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L549-L549),[576](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L576-L576),[631](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L631-L634),[638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L638-L639),[688](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L688-L688),[691](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L691-L693),[702](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L702-L702),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L715-L722),[717](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L717-L719),[727](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L727-L728),[787](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L787-L829),[823](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L823-L829),[833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L833-L833),[939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L939-L940),[999](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L999-L1035),[1006](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1006-L1008),[1013](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1013-L1025),[1029](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1029-L1034),[1073](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1073-L1076),[1078](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1078-L1081),[1085](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1085-L1094),[1275](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1275-L1277),[1279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1279-L1312),[1465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1465-L1521),[1469](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1469-L1515))
```solidity
File: contracts/libraries/CallbackLib.sol

36:         if (factory.getPool(features.token0, features.token1, features.fee) != sender)
                revert Errors.InvalidUniswapCallback();

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L36-L37))
```solidity
File: contracts/libraries/FeesCalc.sol

67:                 if (tokenId.isLong(leg) == 0) {
                        unchecked {
                            value0 += int256(amount0);
                            value1 += int256(amount1);
                        }
                    } else {
                        unchecked {
                            value0 -= int256(amount0);
                            value1 -= int256(amount1);
                        }
                    }

147:             if (currentTick < tickLower) {
                     /**
                       Diagrams shown for token0, and applies for token1 the same
                       L = lowerTick, U = upperTick
     
                         liquidity         lowerOut0 (all fees collected in this price tick range for token0)
                             ▲            ◄──────────────^v───► (to MAX_TICK)
                             │
                             │                      upperOut0
                             │                     ◄─────^v───►
                             │           ┌────────┐
                             │           │ chunk  │
                             │           │        │
                             └─────▲─────┴────────┴────────► price tick
                                   │     L        U
                                   │
                                current
                                 tick
                     */
                     feeGrowthInside0X128 = lowerOut0 - upperOut0; // fee growth inside the chunk
                     feeGrowthInside1X128 = lowerOut1 - upperOut1;
                 } else if (currentTick >= tickUpper) {
                     /**
                         liquidity
                             ▲           upperOut0
                             │◄─^v─────────────────────►
                             │     
                             │     lowerOut0  ┌────────┐
                             │◄─^v───────────►│ chunk  │
                             │                │        │
                             └────────────────┴────────┴─▲─────► price tick
                                              L        U │
                                                         │
                                                      current
                                                       tick
                      */
                     feeGrowthInside0X128 = upperOut0 - lowerOut0;
                     feeGrowthInside1X128 = upperOut1 - lowerOut1;
                 } else {
                     /**
                       current AMM tick is within the option position range (within the chunk)
     
                          liquidity
                             ▲        feeGrowthGlobal0X128 = global fee growth
                             │                             = (all fees collected for the entire price range for token 0)
                             │
                             │                        
                             │     lowerOut0  ┌──────────────┐ upperOut0
                             │◄─^v───────────►│              │◄─────^v───►
                             │                │     chunk    │
                             │                │              │
                             └────────────────┴───────▲──────┴─────► price tick
                                              L       │      U
                                                      │
                                                   current
                                                    tick
                     */
                     feeGrowthInside0X128 = univ3pool.feeGrowthGlobal0X128() - lowerOut0 - upperOut0;
                     feeGrowthInside1X128 = univ3pool.feeGrowthGlobal1X128() - lowerOut1 - upperOut1;
                 }

168:             } else if (currentTick >= tickUpper) {
                     /**
                         liquidity
                             ▲           upperOut0
                             │◄─^v─────────────────────►
                             │     
                             │     lowerOut0  ┌────────┐
                             │◄─^v───────────►│ chunk  │
                             │                │        │
                             └────────────────┴────────┴─▲─────► price tick
                                              L        U │
                                                         │
                                                      current
                                                       tick
                      */
                     feeGrowthInside0X128 = upperOut0 - lowerOut0;
                     feeGrowthInside1X128 = upperOut1 - lowerOut1;
                 } else {
                     /**
                       current AMM tick is within the option position range (within the chunk)
     
                          liquidity
                             ▲        feeGrowthGlobal0X128 = global fee growth
                             │                             = (all fees collected for the entire price range for token 0)
                             │
                             │                        
                             │     lowerOut0  ┌──────────────┐ upperOut0
                             │◄─^v───────────►│              │◄─────^v───►
                             │                │     chunk    │
                             │                │              │
                             └────────────────┴───────▲──────┴─────► price tick
                                              L       │      U
                                                      │
                                                   current
                                                    tick
                     */
                     feeGrowthInside0X128 = univ3pool.feeGrowthGlobal0X128() - lowerOut0 - upperOut0;
                     feeGrowthInside1X128 = univ3pool.feeGrowthGlobal1X128() - lowerOut1 - upperOut1;
                 }

```
([67](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L67-L77),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L147-L206),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L168-L206))
```solidity
File: contracts/libraries/Math.sol

93:             if (x >= 0x100000000000000000000000000000000) {
                    x >>= 128;
                    r += 32;
                }

97:             if (x >= 0x10000000000000000) {
                    x >>= 64;
                    r += 16;
                }

101:             if (x >= 0x100000000) {
                     x >>= 32;
                     r += 8;
                 }

105:             if (x >= 0x10000) {
                     x >>= 16;
                     r += 4;
                 }

109:             if (x >= 0x100) {
                     x >>= 8;
                     r += 2;
                 }

113:             if (x >= 0x10) {
                     r += 1;
                 }

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

225:         if (currentTick <= liquidityChunk.tickLower()) {
                 amount0 = getAmount0ForLiquidity(liquidityChunk);
             } else if (currentTick >= liquidityChunk.tickUpper()) {
                 amount1 = getAmount1ForLiquidity(liquidityChunk);
             } else {
                 amount0 = getAmount0ForLiquidity(liquidityChunk.updateTickLower(currentTick));
                 amount1 = getAmount1ForLiquidity(liquidityChunk.updateTickUpper(currentTick));
             }

227:         } else if (currentTick >= liquidityChunk.tickUpper()) {
                 amount1 = getAmount1ForLiquidity(liquidityChunk);
             } else {
                 amount0 = getAmount0ForLiquidity(liquidityChunk.updateTickLower(currentTick));
                 amount1 = getAmount1ForLiquidity(liquidityChunk.updateTickUpper(currentTick));
             }

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

303:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) {
                 downcastedInt = type(uint128).max;
             }

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

360:             if (prod1 == 0) {
                     require(denominator > 0);
                     assembly ("memory-safe") {
                         result := div(prod0, denominator)
                     }
                     return result;
                 }

447:             if (mulmod(a, b, denominator) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }

474:             if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(64, prod0)
                     }
                     return res;
                 }

537:             if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(96, prod0)
                     }
                     return res;
                 }

587:             if (mulmod(a, b, 2 ** 96) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }

614:             if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(128, prod0)
                     }
                     return res;
                 }

664:             if (mulmod(a, b, 2 ** 128) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }

691:             if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(192, prod0)
                     }
                     return res;
                 }

757:             if (i == j) return;

762:                 if (i <= j) {
                         (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);
                         i++;
                         j--;
                     }

768:             if (left < j) quickSort(arr, left, j);

769:             if (i < right) quickSort(arr, i, right);

```
([93](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L93-L96),[97](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L97-L100),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L101-L104),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L105-L108),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L109-L112),[113](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L113-L115),[131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L131-L131),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173),[176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L176-L176),[225](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L225-L232),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L227-L232),[297](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L297-L297),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L303-L305),[312](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L312-L312),[319](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L319-L319),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L326-L326),[360](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L360-L366),[447](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L447-L450),[474](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L474-L481),[537](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L537-L544),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L587-L590),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L614-L621),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L664-L667),[691](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L691-L698),[757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L757-L757),[762](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L762-L766),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L768-L768),[769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L769-L769))
```solidity
File: contracts/libraries/PanopticMath.sol

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {
                     int24 lastObservedTick;
                     {
                         (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
                             uint256(
                                 int256(observationIndex) - int256(1) + int256(observationCardinality)
                             ) % observationCardinality
                         );
     
                         (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
                             .observations(observationIndex);
                         lastObservedTick = int24(
                             (tickCumulative_last - tickCumulative_old) /
                                 int256(timestamp_last - timestamp_old)
                         );
                     }
     
                     uint24 orderMap = uint24(medianData >> 192);
     
                     uint24 newOrderMap;
                     uint24 shift = 1;
                     bool below = true;
                     uint24 rank;
                     int24 entry;
                     for (uint8 i; i < 8; ++i) {
                         // read the rank from the existing ordering
                         rank = (orderMap >> (3 * i)) % 8;
     
                         if (rank == 7) {
                             shift -= 1;
                             continue;
                         }
     
                         // read the corresponding entry
                         entry = int24(uint24(medianData >> (rank * 24)));
                         if ((below) && (lastObservedTick > entry)) {
                             shift += 1;
                             below = false;
                         }
     
                         newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));
                     }
     
                     updatedMedianData =
                         (block.timestamp << 216) +
                         (uint256(newOrderMap) << 192) +
                         uint256(uint192(medianData << 24)) +
                         uint256(uint24(lastObservedTick));
                 }

211:                     if (rank == 7) {
                             shift -= 1;
                             continue;
                         }

218:                     if ((below) && (lastObservedTick > entry)) {
                             shift += 1;
                             below = false;
                         }

325:         if (tokenId.asset(legIndex) == 0) {
                 return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);
             } else {
                 return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);
             }

356:             if (
                     tickLower % tickSpacing != 0 ||
                     tickUpper % tickSpacing != 0 ||
                     tickLower < minTick ||
                     tickUpper > maxTick
                 ) revert Errors.TicksNotInitializable();

425:         if (tokenType == 0) {
                 return (
                     tokenData0.rightSlot() + convert1to0(tokenData1.rightSlot(), sqrtPriceX96),
                     tokenData0.leftSlot() + convert1to0(tokenData1.leftSlot(), sqrtPriceX96)
                 );
             } else {
                 return (
                     tokenData1.rightSlot() + convert0to1(tokenData0.rightSlot(), sqrtPriceX96),
                     tokenData1.leftSlot() + convert0to1(tokenData0.leftSlot(), sqrtPriceX96)
                 );
             }

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

494:             if (sqrtPriceX96 < type(uint128).max) {
                     return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);
                 } else {
                     return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                 }

511:             if (sqrtPriceX96 < type(uint128).max) {
                     return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);
                 } else {
                     return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
                 }

528:             if (sqrtPriceX96 < type(uint128).max) {
                     int256 absResult = Math
                         .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 } else {
                     int256 absResult = Math
                         .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 }

551:             if (sqrtPriceX96 < type(uint128).max) {
                     int256 absResult = Math
                         .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 } else {
                     int256 absResult = Math
                         .mulDiv(
                             Math.absUint(amount),
                             2 ** 128,
                             Math.mulDiv64(sqrtPriceX96, sqrtPriceX96)
                         )
                         .toInt256();
                     return amount < 0 ? -absResult : absResult;
                 }

584:         if (tokenId.asset(legIndex) == 0) {
                 amount0 = positionSize * uint128(tokenId.optionRatio(legIndex));
     
                 amount1 = Math
                     .getAmount1ForLiquidity(Math.getLiquidityForAmount0(tickLower, tickUpper, amount0))
                     .toUint128();
             } else {
                 amount1 = positionSize * uint128(tokenId.optionRatio(legIndex));
     
                 amount0 = Math
                     .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))
                     .toUint128();
             }

618:         if (tokenId.tokenType(legIndex) == 0) {
                 if (isShort) {
                     // if option is short, increment shorts by contracts
                     shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                 } else {
                     // is option is long, increment longs by contracts
                     longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                 }
             } else {
                 if (isShort) {
                     // if option is short, increment shorts by notional
                     shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 } else {
                     // if option is long, increment longs by notional
                     longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 }
             }

619:             if (isShort) {
                     // if option is short, increment shorts by contracts
                     shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                 } else {
                     // is option is long, increment longs by contracts
                     longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
                 }

627:             if (isShort) {
                     // if option is short, increment shorts by notional
                     shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 } else {
                     // if option is long, increment longs by notional
                     longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
                 }

704:             if (!(paid0 > balance0 && paid1 > balance1)) {
                     // liquidatee cannot pay back the liquidator fully in either token, so no protocol loss can be avoided
                     if ((paid0 > balance0)) {
                         // liquidatee has insufficient token0 but some token1 left over, so we use what they have left to mitigate token0 losses
                         // we do this by substituting an equivalent value of token1 in our refund to the liquidator, plus a bonus, for the token0 we convert
                         // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                         // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token1 balance: balance1 - paid1
                         // and paid0 - balance0 is the amount of token0 that the liquidatee is missing, i.e the protocol loss
                         // if the protocol loss is lower than the excess token1 balance, then we can fully mitigate the loss and we should only convert the loss amount
                         // if the protocol loss is higher than the excess token1 balance, we can only mitigate part of the loss, so we should convert only the excess token1 balance
                         // thus, the value converted should be min(balance1 - paid1, paid0 - balance0)
                         bonus1 += Math.min(
                             balance1 - paid1,
                             PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)
                         );
                         bonus0 -= Math.min(
                             PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),
                             paid0 - balance0
                         );
                     }
                     if ((paid1 > balance1)) {
                         // liquidatee has insufficient token1 but some token0 left over, so we use what they have left to mitigate token1 losses
                         // we do this by substituting an equivalent value of token0 in our refund to the liquidator, plus a bonus, for the token1 we convert
                         // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                         // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token0 balance: balance0 - paid0
                         // and paid1 - balance1 is the amount of token1 that the liquidatee is missing, i.e the protocol loss
                         // if the protocol loss is lower than the excess token0 balance, then we can fully mitigate the loss and we should only convert the loss amount
                         // if the protocol loss is higher than the excess token0 balance, we can only mitigate part of the loss, so we should convert only the excess token0 balance
                         // thus, the value converted should be min(balance0 - paid0, paid1 - balance1)
                         bonus0 += Math.min(
                             balance0 - paid0,
                             PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)
                         );
                         bonus1 -= Math.min(
                             PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),
                             paid1 - balance1
                         );
                     }
                 }

706:                 if ((paid0 > balance0)) {
                         // liquidatee has insufficient token0 but some token1 left over, so we use what they have left to mitigate token0 losses
                         // we do this by substituting an equivalent value of token1 in our refund to the liquidator, plus a bonus, for the token0 we convert
                         // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                         // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token1 balance: balance1 - paid1
                         // and paid0 - balance0 is the amount of token0 that the liquidatee is missing, i.e the protocol loss
                         // if the protocol loss is lower than the excess token1 balance, then we can fully mitigate the loss and we should only convert the loss amount
                         // if the protocol loss is higher than the excess token1 balance, we can only mitigate part of the loss, so we should convert only the excess token1 balance
                         // thus, the value converted should be min(balance1 - paid1, paid0 - balance0)
                         bonus1 += Math.min(
                             balance1 - paid1,
                             PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)
                         );
                         bonus0 -= Math.min(
                             PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),
                             paid0 - balance0
                         );
                     }

724:                 if ((paid1 > balance1)) {
                         // liquidatee has insufficient token1 but some token0 left over, so we use what they have left to mitigate token1 losses
                         // we do this by substituting an equivalent value of token0 in our refund to the liquidator, plus a bonus, for the token1 we convert
                         // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
                         // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token0 balance: balance0 - paid0
                         // and paid1 - balance1 is the amount of token1 that the liquidatee is missing, i.e the protocol loss
                         // if the protocol loss is lower than the excess token0 balance, then we can fully mitigate the loss and we should only convert the loss amount
                         // if the protocol loss is higher than the excess token0 balance, we can only mitigate part of the loss, so we should convert only the excess token0 balance
                         // thus, the value converted should be min(balance0 - paid0, paid1 - balance1)
                         bonus0 += Math.min(
                             balance0 - paid0,
                             PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)
                         );
                         bonus1 -= Math.min(
                             PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),
                             paid1 - balance1
                         );
                     }

785:                     if (tokenId.isLong(leg) == 1) {
                             longPremium = longPremium.sub(premiasByLeg[i][leg]);
                         }

797:             if (
                     longPremium.rightSlot() < collateralDelta0 &&
                     longPremium.leftSlot() > collateralDelta1
                 ) {
                     int256 protocolLoss1 = collateralDelta1;
                     (collateralDelta0, collateralDelta1) = (
                         -Math.min(
                             collateralDelta0 - longPremium.rightSlot(),
                             PanopticMath.convert1to0(
                                 longPremium.leftSlot() - collateralDelta1,
                                 sqrtPriceX96Final
                             )
                         ),
                         Math.min(
                             longPremium.leftSlot() - collateralDelta1,
                             PanopticMath.convert0to1(
                                 collateralDelta0 - longPremium.rightSlot(),
                                 sqrtPriceX96Final
                             )
                         )
                     );
     
                     haircut0 = longPremium.rightSlot();
                     haircut1 = protocolLoss1 + collateralDelta1;
                 } else if (
                     longPremium.leftSlot() < collateralDelta1 &&
                     longPremium.rightSlot() > collateralDelta0
                 ) {
                     int256 protocolLoss0 = collateralDelta0;
                     (collateralDelta0, collateralDelta1) = (
                         Math.min(
                             longPremium.rightSlot() - collateralDelta0,
                             PanopticMath.convert1to0(
                                 collateralDelta1 - longPremium.leftSlot(),
                                 sqrtPriceX96Final
                             )
                         ),
                         -Math.min(
                             collateralDelta1 - longPremium.leftSlot(),
                             PanopticMath.convert0to1(
                                 longPremium.rightSlot() - collateralDelta0,
                                 sqrtPriceX96Final
                             )
                         )
                     );
     
                     haircut0 = collateralDelta0 + protocolLoss0;
                     haircut1 = longPremium.leftSlot();
                 } else {
                     // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
                     haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
                     haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
     
                     collateralDelta0 = 0;
                     collateralDelta1 = 0;
                 }

821:             } else if (
                     longPremium.leftSlot() < collateralDelta1 &&
                     longPremium.rightSlot() > collateralDelta0
                 ) {
                     int256 protocolLoss0 = collateralDelta0;
                     (collateralDelta0, collateralDelta1) = (
                         Math.min(
                             longPremium.rightSlot() - collateralDelta0,
                             PanopticMath.convert1to0(
                                 collateralDelta1 - longPremium.leftSlot(),
                                 sqrtPriceX96Final
                             )
                         ),
                         -Math.min(
                             collateralDelta1 - longPremium.leftSlot(),
                             PanopticMath.convert0to1(
                                 longPremium.rightSlot() - collateralDelta0,
                                 sqrtPriceX96Final
                             )
                         )
                     );
     
                     haircut0 = collateralDelta0 + protocolLoss0;
                     haircut1 = longPremium.leftSlot();
                 } else {
                     // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
                     haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
                     haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
     
                     collateralDelta0 = 0;
                     collateralDelta1 = 0;
                 }

856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));

857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));

864:                     if (tokenId.isLong(leg) == 1) {
                             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
                                 storage _settledTokens = settledTokens;
     
                             // calculate amounts to revoke from settled and subtract from haircut req
                             uint256 settled0 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
                                 uint128(longPremium.rightSlot())
                             );
                             uint256 settled1 = Math.unsafeDivRoundingUp(
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
                                 uint128(longPremium.leftSlot())
                             );
     
                             bytes32 chunkKey = keccak256(
                                 abi.encodePacked(
                                     tokenId.strike(0),
                                     tokenId.width(0),
                                     tokenId.tokenType(0)
                                 )
                             );
     
                             // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
                             // for the haircut directly to the accumulator
                             settled0 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
                             );
                             settled1 = Math.max(
                                 0,
                                 uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
                             );
     
                             _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
                                 LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
                                     uint128(settled1)
                                 )
                             );
                         }

931:             if (balanceShortage > 0) {
                     return
                         LeftRightSigned
                             .wrap(0)
                             .toRightSlot(int128(refundValues.rightSlot() - balanceShortage))
                             .toLeftSlot(
                                 int128(
                                     int256(
                                         PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)
                                     ) + refundValues.leftSlot()
                                 )
                             );
                 }

949:             if (balanceShortage > 0) {
                     return
                         LeftRightSigned
                             .wrap(0)
                             .toLeftSlot(int128(refundValues.leftSlot() - balanceShortage))
                             .toRightSlot(
                                 int128(
                                     int256(
                                         PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)
                                     ) + refundValues.rightSlot()
                                 )
                             );
                 }

```
([183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L183-L231),[211](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L211-L214),[218](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L218-L221),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L325-L329),[356](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L356-L361),[425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L425-L435),[479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L479-L479),[494](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L494-L498),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L511-L515),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L528-L538),[551](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L551-L565),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L584-L596),[618](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L618-L634),[619](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L619-L625),[627](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L627-L633),[704](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L704-L742),[706](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L706-L723),[724](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L724-L741),[785](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L785-L787),[797](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L797-L852),[821](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L821-L852),[856](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L856-L856),[857](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L857-L857),[864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L864-L902),[931](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L931-L943),[949](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L949-L961))
```solidity
File: contracts/libraries/SafeTransferLib.sol

45:         if (!success) revert Errors.TransferFailed();

75:         if (!success) revert Errors.TransferFailed();

```
([45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L45-L45),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L75-L75))
```solidity
File: contracts/multicall/Multicall.sol

17:             if (!success) {
                    // Bubble up the revert reason
                    // The bytes type is ABI encoded as a length-prefixed byte array
                    // So we simply need to add 32 to the pointer to get the start of the data
                    // And then revert with the size loaded from the first 32 bytes
                    // Other solutions will do work to differentiate the revert reasons and provide paranthetical information
                    // However, we have chosen to simply replicate the the normal behavior of the call
                    // NOTE: memory-safe because it reads from memory already allocated by solidity (the bytes memory result)
                    assembly ("memory-safe") {
                        revert(add(result, 32), mload(result))
                    }
                }

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L17-L28))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

112:         if (to.code.length != 0) {
                 if (
                     ERC1155Holder(to).onERC1155Received(msg.sender, from, id, amount, data) !=
                     ERC1155Holder.onERC1155Received.selector
                 ) {
                     revert UnsafeRecipient();
                 }
             }

113:             if (
                     ERC1155Holder(to).onERC1155Received(msg.sender, from, id, amount, data) !=
                     ERC1155Holder.onERC1155Received.selector
                 ) {
                     revert UnsafeRecipient();
                 }

137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

163:         if (to.code.length != 0) {
                 if (
                     ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
                     ERC1155Holder.onERC1155BatchReceived.selector
                 ) {
                     revert UnsafeRecipient();
                 }
             }

164:             if (
                     ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
                     ERC1155Holder.onERC1155BatchReceived.selector
                 ) {
                     revert UnsafeRecipient();
                 }

222:         if (to.code.length != 0) {
                 if (
                     ERC1155Holder(to).onERC1155Received(msg.sender, address(0), id, amount, "") !=
                     ERC1155Holder.onERC1155Received.selector
                 ) {
                     revert UnsafeRecipient();
                 }
             }

223:             if (
                     ERC1155Holder(to).onERC1155Received(msg.sender, address(0), id, amount, "") !=
                     ERC1155Holder.onERC1155Received.selector
                 ) {
                     revert UnsafeRecipient();
                 }

```
([101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L101-L101),[112](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L112-L119),[113](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L113-L118),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L137-L137),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L163-L170),[164](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L164-L169),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L222-L229),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L223-L228))
```solidity
File: contracts/tokens/ERC20Minimal.sol

84:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;

```
([84](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L84-L84))
```solidity
File: contracts/types/LeftRight.sol

160:             if (
                     LeftRightUnsigned.unwrap(z) < LeftRightUnsigned.unwrap(x) ||
                     (uint128(LeftRightUnsigned.unwrap(z)) < uint128(LeftRightUnsigned.unwrap(x)))
                 ) revert Errors.UnderOverFlow();

183:             if (
                     LeftRightUnsigned.unwrap(z) > LeftRightUnsigned.unwrap(x) ||
                     (uint128(LeftRightUnsigned.unwrap(z)) > uint128(LeftRightUnsigned.unwrap(x)))
                 ) revert Errors.UnderOverFlow();

199:             if (left128 != left) revert Errors.UnderOverFlow();

204:             if (right128 != right) revert Errors.UnderOverFlow();

222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

240:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

262:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

```
([160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L160-L163),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L183-L186),[199](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L199-L199),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L204-L204),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L222-L222),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L240-L240),[262](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L262-L262))
```solidity
File: contracts/types/TokenId.sol

376:             if (optionRatios < 2 ** 64) {
                     optionRatios = 0;
                 } else if (optionRatios < 2 ** 112) {
                     optionRatios = 1;
                 } else if (optionRatios < 2 ** 160) {
                     optionRatios = 2;
                 } else if (optionRatios < 2 ** 208) {
                     optionRatios = 3;
                 } else {
                     optionRatios = 4;
                 }

378:             } else if (optionRatios < 2 ** 112) {
                     optionRatios = 1;
                 } else if (optionRatios < 2 ** 160) {
                     optionRatios = 2;
                 } else if (optionRatios < 2 ** 208) {
                     optionRatios = 3;
                 } else {
                     optionRatios = 4;
                 }

380:             } else if (optionRatios < 2 ** 160) {
                     optionRatios = 2;
                 } else if (optionRatios < 2 ** 208) {
                     optionRatios = 3;
                 } else {
                     optionRatios = 4;
                 }

382:             } else if (optionRatios < 2 ** 208) {
                     optionRatios = 3;
                 } else {
                     optionRatios = 4;
                 }

439:         if (optionRatios < 2 ** 64) {
                 return 0;
             } else if (optionRatios < 2 ** 112) {
                 return 1;
             } else if (optionRatios < 2 ** 160) {
                 return 2;
             } else if (optionRatios < 2 ** 208) {
                 return 3;
             }

441:         } else if (optionRatios < 2 ** 112) {
                 return 1;
             } else if (optionRatios < 2 ** 160) {
                 return 2;
             } else if (optionRatios < 2 ** 208) {
                 return 3;
             }

443:         } else if (optionRatios < 2 ** 160) {
                 return 2;
             } else if (optionRatios < 2 ** 208) {
                 return 3;
             }

445:         } else if (optionRatios < 2 ** 208) {
                 return 3;
             }

465:         if (i == 0)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFFFFFF
                     );

471:         if (i == 1)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );

477:         if (i == 2)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );

483:         if (i == 3)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0x000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );

501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);

508:                 if (self.optionRatio(i) == 0) {
                         // final leg in this position identified;
                         // make sure any leg above this are zero as well
                         // (we don't allow gaps eg having legs 1 and 4 active without 2 and 3 is not allowed)
                         if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)
                             revert Errors.InvalidTokenIdParameter(1);
     
                         break; // we are done iterating over potential legs
                     }

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)
                             revert Errors.InvalidTokenIdParameter(1);

521:                     if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {
                             revert Errors.InvalidTokenIdParameter(6);
                         }

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

530:                 if (
                         (self.strike(i) == Constants.MIN_V3POOL_TICK) ||
                         (self.strike(i) == Constants.MAX_V3POOL_TICK)
                     ) revert Errors.InvalidTokenIdParameter(4);

539:                 if (riskPartnerIndex != i) {
                         // Ensures that risk partners are mutual
                         if (self.riskPartner(riskPartnerIndex) != i)
                             revert Errors.InvalidTokenIdParameter(3);
     
                         // Ensures that risk partners have 1) the same asset, and 2) the same ratio
                         if (
                             (self.asset(riskPartnerIndex) != self.asset(i)) ||
                             (self.optionRatio(riskPartnerIndex) != self.optionRatio(i))
                         ) revert Errors.InvalidTokenIdParameter(3);
     
                         // long/short status of associated legs
                         uint256 _isLong = self.isLong(i);
                         uint256 isLongP = self.isLong(riskPartnerIndex);
     
                         // token type status of associated legs (call/put)
                         uint256 _tokenType = self.tokenType(i);
                         uint256 tokenTypeP = self.tokenType(riskPartnerIndex);
     
                         // if the position is the same i.e both long calls, short put's etc.
                         // then this is a regular position, not a defined risk position
                         if ((_isLong == isLongP) && (_tokenType == tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(4);
     
                         // if the two token long-types and the tokenTypes are both different (one is a short call, the other a long put, e.g.), this is a synthetic position
                         // A synthetic long or short is more capital efficient than each leg separated because the long+short premia accumulate proportionally
                         // unlike short stranlges, long strangles also cannot be partnered, because there is no reduction in risk (both legs can earn premia simultaneously)
                         if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(5);
                     }

541:                     if (self.riskPartner(riskPartnerIndex) != i)
                             revert Errors.InvalidTokenIdParameter(3);

545:                     if (
                             (self.asset(riskPartnerIndex) != self.asset(i)) ||
                             (self.optionRatio(riskPartnerIndex) != self.optionRatio(i))
                         ) revert Errors.InvalidTokenIdParameter(3);

560:                     if ((_isLong == isLongP) && (_tokenType == tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(4);

566:                     if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(5);

589:                 if ((currentTick >= _strike + rangeUp) || (currentTick < _strike - rangeDown)) {
                         // if this leg is long and the price beyond the leg's range:
                         // this exercised ID, `self`, appears valid
                         if (self.isLong(i) == 1) return; // validated
                     }

592:                     if (self.isLong(i) == 1) return; // validated

```
([376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L376-L386),[378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L378-L386),[380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L380-L386),[382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L382-L386),[439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L439-L447),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L441-L447),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L443-L447),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L445-L447),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L465-L470),[471](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L471-L476),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L477-L482),[483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L483-L488),[501](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L501-L501),[508](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L508-L516),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L512-L513),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L521-L523),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L528-L528),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L530-L533),[539](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L539-L568),[541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L541-L542),[545](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L545-L548),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L560-L561),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L566-L567),[589](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L589-L593),[592](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L592-L592))
### <a name="NC-36"></a>[NC-36] Expressions for `constant` values should use `immutable` rather than `constant`
While it doesn't save any gas because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constant`s should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.

*There are 18 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

70:     string internal constant TICKER_PREFIX = "po";

73:     string internal constant NAME_PREFIX = "POPT-V1";

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L73-L73))
```solidity
File: contracts/PanopticPool.sol

103:     int24 internal constant MIN_SWAP_TICK = Constants.MIN_V3POOL_TICK + 1;

105:     int24 internal constant MAX_SWAP_TICK = Constants.MAX_V3POOL_TICK - 1;

109:     bool internal constant COMPUTE_ALL_PREMIA = true;

111:     bool internal constant COMPUTE_LONG_PREMIA = false;

114:     bool internal constant ONLY_AVAILABLE_PREMIUM = false;

119:     bool internal constant COMMIT_LONG_SETTLED = true;

120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

123:     bool internal constant ADD = true;

133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

```
([103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L103-L103),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L105-L105),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L109-L109),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L111-L111),[114](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L114-L114),[119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L119-L119),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L120-L120),[123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L123-L123),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L133-L133),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L165-L165))
```solidity
File: contracts/SemiFungiblePositionManager.sol

125:     bool internal constant MINT = false;

126:     bool internal constant BURN = true;

```
([125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L125-L125),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L126-L126))
```solidity
File: contracts/libraries/Constants.sol

12:     int24 internal constant MIN_V3POOL_TICK = -887272;

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L12-L12))
```solidity
File: contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15))
```solidity
File: contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23))
```solidity
File: contracts/types/LeftRight.sol

26:     int256 internal constant LEFT_HALF_BIT_MASK_INT =
            int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L26-L27))
### <a name="NC-37"></a>[NC-37] Inconsistent comment spacing
Some comments use // X and others //X Amend comments to use only use // X or //X consistently

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1-L1))
```solidity
File: contracts/PanopticFactory.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L1-L1))
```solidity
File: contracts/PanopticPool.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1-L1))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1-L1))
```solidity
File: contracts/libraries/CallbackLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L1-L1))
```solidity
File: contracts/libraries/Constants.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L1-L1))
```solidity
File: contracts/libraries/Errors.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L1-L1))
```solidity
File: contracts/libraries/FeesCalc.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L1-L1))
```solidity
File: contracts/libraries/InteractionHelper.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L1-L1))
```solidity
File: contracts/libraries/Math.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L1-L1))
```solidity
File: contracts/libraries/PanopticMath.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L1-L1))
```solidity
File: contracts/libraries/SafeTransferLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L1-L1))
```solidity
File: contracts/multicall/Multicall.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L1-L1))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/ERC20Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L1-L1))
```solidity
File: contracts/types/LeftRight.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L1-L1))
```solidity
File: contracts/types/LiquidityChunk.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L1-L1))
```solidity
File: contracts/types/TokenId.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L1-L1))
### <a name="NC-38"></a>[NC-38] Interface imports should be declared first
Amend the ordering of imports to import interfaces first followed by other imports

*There are 15 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

5: import {PanopticPool} from "./PanopticPool.sol";
   // Inherited implementations
   import {ERC20Minimal} from "@tokens/ERC20Minimal.sol";
   import {Multicall} from "@multicall/Multicall.sol";
   // Libraries
   import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {InteractionHelper} from "@libraries/InteractionHelper.sol";
   import {Math} from "@libraries/Math.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";
   import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";
   // Custom types
   import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";
   import {LiquidityChunk} from "@types/LiquidityChunk.sol";
   import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L5-L19))
```solidity
File: contracts/PanopticFactory.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";
   import {PanopticPool} from "@contracts/PanopticPool.sol";
   import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";
   import {IDonorNFT} from "@contracts/tokens/interfaces/IDonorNFT.sol";
   import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";
   import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";
   // Inherited implementations
   import {Multicall} from "@multicall/Multicall.sol";
   // OpenZeppelin libraries
   import {Clones} from "@openzeppelin/contracts/proxy/Clones.sol";
   // Libraries
   import {CallbackLib} from "@libraries/CallbackLib.sol";
   import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {Math} from "@libraries/Math.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";
   import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L5-L21))
```solidity
File: contracts/PanopticPool.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";
   import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";
   import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";
   // Inherited implementations
   import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";
   import {Multicall} from "@multicall/Multicall.sol";
   // Libraries
   import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {FeesCalc} from "@libraries/FeesCalc.sol";
   import {InteractionHelper} from "@libraries/InteractionHelper.sol";
   import {Math} from "@libraries/Math.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";
   // Custom types
   import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";
   import {LiquidityChunk} from "@types/LiquidityChunk.sol";
   import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L5-L21))
```solidity
File: contracts/SemiFungiblePositionManager.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";
   import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";
   // Inherited implementations
   import {ERC1155} from "@tokens/ERC1155Minimal.sol";
   import {Multicall} from "@multicall/Multicall.sol";
   // Libraries
   import {CallbackLib} from "@libraries/CallbackLib.sol";
   import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {FeesCalc} from "@libraries/FeesCalc.sol";
   import {Math} from "@libraries/Math.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";
   import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";
   // Custom types
   import {LeftRightUnsigned, LeftRightSigned, LeftRightLibrary} from "@types/LeftRight.sol";
   import {LiquidityChunk} from "@types/LiquidityChunk.sol";
   import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L5-L21))
```solidity
File: contracts/libraries/CallbackLib.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";
   // Libraries
   import {Errors} from "@libraries/Errors.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L5-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

5: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";
   // Libraries
   import {Math} from "@libraries/Math.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";
   // Custom types
   import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";
   import {LiquidityChunk} from "@types/LiquidityChunk.sol";
   import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L5-L12))
```solidity
File: contracts/libraries/InteractionHelper.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";
   import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";
   import {IERC20Partial} from "@tokens/interfaces/IERC20Partial.sol";
   import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";
   // OpenZeppelin libraries
   import {Strings} from "@openzeppelin/contracts/utils/Strings.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L5-L10))
```solidity
File: contracts/libraries/Math.sol

5: import {Errors} from "@libraries/Errors.sol";
   import {Constants} from "@libraries/Constants.sol";
   // Custom types
   import {LiquidityChunk, LiquidityChunkLibrary} from "@types/LiquidityChunk.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L5-L8))
```solidity
File: contracts/libraries/PanopticMath.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";
   import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";
   // Libraries
   import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {Math} from "@libraries/Math.sol";
   // Custom types
   import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";
   import {LiquidityChunk} from "@types/LiquidityChunk.sol";
   import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L5-L14))
```solidity
File: contracts/libraries/SafeTransferLib.sol

5: import {Errors} from "@libraries/Errors.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L5-L5))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

5: import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L5-L5))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

4: import {PanopticPool} from "@contracts/PanopticPool.sol";

```
([4](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L4-L4))
```solidity
File: contracts/types/LeftRight.sol

5: import {Errors} from "@libraries/Errors.sol";
   import {Math} from "@libraries/Math.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L5-L6))
```solidity
File: contracts/types/LiquidityChunk.sol

5: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L5-L5))
```solidity
File: contracts/types/TokenId.sol

5: import {Constants} from "@libraries/Constants.sol";
   import {Errors} from "@libraries/Errors.sol";
   import {PanopticMath} from "@libraries/PanopticMath.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L5-L7))
### <a name="NC-39"></a>[NC-39] Lack Of Brace Spacing
Lack of brace spacing in coding refers to the absence of spaces around braces, which can hinder code readability. In Solidity, as in many programming languages, spacing can enhance the visual distinction between different parts of the code, making it easier to follow. A lack of spacing can lead to a dense, confusing appearance. The resolution to this issue is to follow a consistent style guide that defines rules for brace spacing. By including spaces around braces, such as `{ statement }` instead of `{statement}`, developers can ensure that the code is more legible and maintainable, especially in larger codebases.

*There are 88 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

5: import {PanopticPool} from "./PanopticPool.sol";

7: import {ERC20Minimal} from "@tokens/ERC20Minimal.sol";

8: import {Multicall} from "@multicall/Multicall.sol";

10: import {Constants} from "@libraries/Constants.sol";

11: import {Errors} from "@libraries/Errors.sol";

12: import {InteractionHelper} from "@libraries/InteractionHelper.sol";

13: import {Math} from "@libraries/Math.sol";

14: import {PanopticMath} from "@libraries/PanopticMath.sol";

15: import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";

17: import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";

18: import {LiquidityChunk} from "@types/LiquidityChunk.sol";

19: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L5-L5),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L7-L7),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L8-L8),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L10-L10),[11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L11-L11),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L12-L12),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L13-L13),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L14-L14),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L15-L15),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L17-L17),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L18-L18),[19](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L19-L19))
```solidity
File: contracts/PanopticFactory.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";

6: import {PanopticPool} from "@contracts/PanopticPool.sol";

7: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

8: import {IDonorNFT} from "@contracts/tokens/interfaces/IDonorNFT.sol";

9: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";

10: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";

12: import {Multicall} from "@multicall/Multicall.sol";

14: import {Clones} from "@openzeppelin/contracts/proxy/Clones.sol";

16: import {CallbackLib} from "@libraries/CallbackLib.sol";

17: import {Constants} from "@libraries/Constants.sol";

18: import {Errors} from "@libraries/Errors.sol";

19: import {Math} from "@libraries/Math.sol";

20: import {PanopticMath} from "@libraries/PanopticMath.sol";

21: import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";

398:                 poolFeatures: CallbackLib.PoolFeatures({token0: token0, token1: token1, fee: fee}),

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L6-L6),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L7-L7),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L8-L8),[9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L9-L9),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L10-L10),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L12-L12),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L14-L14),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L16-L16),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L17-L17),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L18-L18),[19](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L19-L19),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L20-L20),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L21-L21),[398](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L398-L398))
```solidity
File: contracts/PanopticPool.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";

6: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

7: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";

9: import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";

10: import {Multicall} from "@multicall/Multicall.sol";

12: import {Constants} from "@libraries/Constants.sol";

13: import {Errors} from "@libraries/Errors.sol";

14: import {FeesCalc} from "@libraries/FeesCalc.sol";

15: import {InteractionHelper} from "@libraries/InteractionHelper.sol";

16: import {Math} from "@libraries/Math.sol";

17: import {PanopticMath} from "@libraries/PanopticMath.sol";

19: import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";

20: import {LiquidityChunk} from "@types/LiquidityChunk.sol";

21: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L6-L6),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L7-L7),[9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L9-L9),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L10-L10),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L12-L12),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L13-L13),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L14-L14),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L15-L15),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L16-L16),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L17-L17),[19](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L19-L19),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L20-L20),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L21-L21))
```solidity
File: contracts/SemiFungiblePositionManager.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";

6: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";

8: import {ERC1155} from "@tokens/ERC1155Minimal.sol";

9: import {Multicall} from "@multicall/Multicall.sol";

11: import {CallbackLib} from "@libraries/CallbackLib.sol";

12: import {Constants} from "@libraries/Constants.sol";

13: import {Errors} from "@libraries/Errors.sol";

14: import {FeesCalc} from "@libraries/FeesCalc.sol";

15: import {Math} from "@libraries/Math.sol";

16: import {PanopticMath} from "@libraries/PanopticMath.sol";

17: import {SafeTransferLib} from "@libraries/SafeTransferLib.sol";

19: import {LeftRightUnsigned, LeftRightSigned, LeftRightLibrary} from "@types/LeftRight.sol";

20: import {LiquidityChunk} from "@types/LiquidityChunk.sol";

21: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L6-L6),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L8-L8),[9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L9-L9),[11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L11-L11),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L12-L12),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L13-L13),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L14-L14),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L15-L15),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L16-L16),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L17-L17),[19](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L19-L19),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L20-L20),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L21-L21))
```solidity
File: contracts/libraries/CallbackLib.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";

7: import {Errors} from "@libraries/Errors.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L5-L5),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L7-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

5: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";

7: import {Math} from "@libraries/Math.sol";

8: import {PanopticMath} from "@libraries/PanopticMath.sol";

10: import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";

11: import {LiquidityChunk} from "@types/LiquidityChunk.sol";

12: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L5-L5),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L7-L7),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L8-L8),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L10-L10),[11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L11-L11),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L12-L12))
```solidity
File: contracts/libraries/InteractionHelper.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";

6: import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";

7: import {IERC20Partial} from "@tokens/interfaces/IERC20Partial.sol";

8: import {SemiFungiblePositionManager} from "@contracts/SemiFungiblePositionManager.sol";

10: import {Strings} from "@openzeppelin/contracts/utils/Strings.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L6-L6),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L7-L7),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L8-L8),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L10-L10))
```solidity
File: contracts/libraries/Math.sol

5: import {Errors} from "@libraries/Errors.sol";

6: import {Constants} from "@libraries/Constants.sol";

8: import {LiquidityChunk, LiquidityChunkLibrary} from "@types/LiquidityChunk.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L6-L6),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L8-L8))
```solidity
File: contracts/libraries/PanopticMath.sol

5: import {CollateralTracker} from "@contracts/CollateralTracker.sol";

6: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";

8: import {Constants} from "@libraries/Constants.sol";

9: import {Errors} from "@libraries/Errors.sol";

10: import {Math} from "@libraries/Math.sol";

12: import {LeftRightUnsigned, LeftRightSigned} from "@types/LeftRight.sol";

13: import {LiquidityChunk} from "@types/LiquidityChunk.sol";

14: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L6-L6),[8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L8-L8),[9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L9-L9),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L10-L10),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L12-L12),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L13-L13),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L14-L14))
```solidity
File: contracts/libraries/SafeTransferLib.sol

5: import {Errors} from "@libraries/Errors.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L5-L5))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

5: import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L5-L5))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

4: import {PanopticPool} from "@contracts/PanopticPool.sol";

```
([4](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L4-L4))
```solidity
File: contracts/types/LeftRight.sol

5: import {Errors} from "@libraries/Errors.sol";

6: import {Math} from "@libraries/Math.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L6-L6))
```solidity
File: contracts/types/LiquidityChunk.sol

5: import {TokenId} from "@types/TokenId.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L5-L5))
```solidity
File: contracts/types/TokenId.sol

5: import {Constants} from "@libraries/Constants.sol";

6: import {Errors} from "@libraries/Errors.sol";

7: import {PanopticMath} from "@libraries/PanopticMath.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L5-L5),[6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L6-L6),[7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L7-L7))
### <a name="NC-40"></a>[NC-40] Consider using the `using`-`for` syntax
The `using`-`for` [syntax](https://docs.soliditylang.org/en/latest/contracts.html#using-for) is the more common way of calling library functions.

*There are 190 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit Math.mulDiv()
380:         return Math.mulDiv(assets, totalSupply, totalAssets());

// @audit Math.mulDiv()
387:         return Math.mulDiv(shares, totalAssets(), totalSupply);

// @audit Math.mulDiv()
402:             shares = Math.mulDiv(

// @audit SafeTransferLib.safeTransferFrom()
424:         SafeTransferLib.safeTransferFrom(

// @audit Math.mulDivRoundingUp()
462:             assets = Math.mulDivRoundingUp(

// @audit SafeTransferLib.safeTransferFrom()
484:         SafeTransferLib.safeTransferFrom(

// @audit Math.min()
512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

// @audit Math.mulDivRoundingUp()
521:         return Math.mulDivRoundingUp(assets, supply, totalAssets());

// @audit SafeTransferLib.safeTransferFrom()
556:         SafeTransferLib.safeTransferFrom(

// @audit Math.min()
575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

// @audit SafeTransferLib.safeTransferFrom()
616:         SafeTransferLib.safeTransferFrom(

// @audit Math.unsafeDivRoundingUp()
669:                             Math.unsafeDivRoundingUp(

// @audit Math.max()
675:                     maxNumRangesFromStrike = Math.max(

// @audit Math.abs()
677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)

// @audit PanopticMath.getLiquidityChunk()
687:                     LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit Math.getAmountsForLiquidity()
693:                     (currentValue0, currentValue1) = Math.getAmountsForLiquidity(

// @audit Math.getAmountsForLiquidity()
698:                     (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(

// @audit Math.mulDiv()
956:                 Math.mulDiv(

// @audit Math.max()
959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))

// @audit Math.mulDivRoundingUp()
1012:                 uint256 sharesToBurn = Math.mulDivRoundingUp(

// @audit Math.mulDivRoundingUp()
1069:                 uint256 sharesToBurn = Math.mulDivRoundingUp(

// @audit Math.unsafeDivRoundingUp()
1109:                 uint256 swapCommission = Math.unsafeDivRoundingUp(

// @audit Math.abs()
1110:                     s_ITMSpreadFee * uint256(Math.abs(intrinsicValue)),

// @audit Math.unsafeDivRoundingUp()
1120:                 Math.unsafeDivRoundingUp(

// @audit PanopticMath.getAmountsMoved()
1322:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);

// @audit Math.getSqrtRatioAtTick()
1363:                         ? Math.getSqrtRatioAtTick(

// @audit Math.max24()
1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)

// @audit Math.getSqrtRatioAtTick()
1366:                         : Math.getSqrtRatioAtTick(

// @audit Math.max24()
1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)

// @audit Math.mulDiv96RoundingUp()
1401:                         required += Math.mulDiv96RoundingUp(amountMoved, c2);

// @audit Math.getSqrtRatioAtTick()
1408:                         uint160 scaleFactor = Math.getSqrtRatioAtTick(

// @audit Math.mulDivRoundingUp()
1411:                         uint256 c3 = Math.mulDivRoundingUp(

// @audit Math.unsafeDivRoundingUp()
1486:                 required = Math.unsafeDivRoundingUp(amount * sellCollateral, DECIMALS);

// @audit Math.unsafeDivRoundingUp()
1496:                 required = Math.unsafeDivRoundingUp(amount * buyCollateral, DECIMALS);

// @audit PanopticMath.getAmountsMoved()
1518:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);

// @audit PanopticMath.getAmountsMoved()
1521:         LeftRightUnsigned amountsMovedPartner = PanopticMath.getAmountsMoved(

// @audit Math.unsafeDivRoundingUp()
1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)

// @audit Math.unsafeDivRoundingUp()
1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);

// @audit Math.max()
1579:         spreadRequirement = Math.max(

```
([380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L380-L380),[387](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L387-L387),[402](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L402-L402),[424](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L424-L424),[462](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L462-L462),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L484-L484),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L512-L512),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L521-L521),[556](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L556-L556),[575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L575-L575),[616](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L616-L616),[669](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L669-L669),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L675-L675),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L677-L677),[687](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L687-L687),[693](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L693-L693),[698](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L698-L698),[956](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L956-L956),[959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L959-L959),[1012](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1012-L1012),[1069](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1069-L1069),[1109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1109-L1109),[1110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1110-L1110),[1120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1120-L1120),[1322](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1322-L1322),[1363](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1363-L1363),[1364](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1364-L1364),[1366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1366-L1366),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1367-L1367),[1401](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1401-L1401),[1408](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1408-L1408),[1411](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1411-L1411),[1486](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1486-L1486),[1496](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1496-L1496),[1518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1518-L1518),[1521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1521-L1521),[1571](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1571-L1571),[1572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1572-L1572),[1579](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1579-L1579))
```solidity
File: contracts/PanopticFactory.sol

// @audit CallbackLib.CallbackData()
177:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

// @audit CallbackLib.validateCallback()
179:         CallbackLib.validateCallback(msg.sender, UNIV3_FACTORY, decoded.poolFeatures);

// @audit SafeTransferLib.safeTransferFrom()
182:             SafeTransferLib.safeTransferFrom(

// @audit SafeTransferLib.safeTransferFrom()
189:             SafeTransferLib.safeTransferFrom(

// @audit PanopticMath.numberOfLeadingHexZeros()
304:             uint256 rarity = PanopticMath.numberOfLeadingHexZeros(

// @audit Math.mulDiv96RoundingUp()
353:                     Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_WETH, currentSqrtPriceX96)

// @audit Math.mulDivRoundingUp()
357:                     Math.mulDivRoundingUp(

// @audit Math.mulDiv96RoundingUp()
366:                     Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN, currentSqrtPriceX96)

// @audit Math.mulDivRoundingUp()
369:                     Math.mulDivRoundingUp(

// @audit CallbackLib.CallbackData()
397:             CallbackLib.CallbackData({

// @audit CallbackLib.PoolFeatures()
398:                 poolFeatures: CallbackLib.PoolFeatures({token0: token0, token1: token1, fee: fee}),

```
([177](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L177-L177),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L179-L179),[182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L182-L182),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L189-L189),[304](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L304-L304),[353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L353-L353),[357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L357-L357),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L366-L366),[369](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L369-L369),[397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L397-L397),[398](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L398-L398))
```solidity
File: contracts/PanopticPool.sol

// @audit PanopticMath.computeInternalMedian()
525:         (, uint256 medianData) = PanopticMath.computeInternalMedian(

// @audit PanopticMath.computeExercisedAmounts()
712:         (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) = PanopticMath
                 .computeExercisedAmounts(tokenId, positionSize);

// @audit Math.min()
775:                     uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))

// @audit PanopticMath.computeMedianObservedPrice()
905:         int24 fastOracleTick = PanopticMath.computeMedianObservedPrice(

// @audit PanopticMath.computeMedianObservedPrice()
915:             slowOracleTick = PanopticMath.computeMedianObservedPrice(

// @audit PanopticMath.computeInternalMedian()
923:             (slowOracleTick, medianData) = PanopticMath.computeInternalMedian(

// @audit Math.abs()
943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

// @audit PanopticMath.computeExercisedAmounts()
981:         (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) = PanopticMath
                 .computeExercisedAmounts(tokenId, positionSize);

// @audit Math.abs()
1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)

// @audit Math.getSqrtRatioAtTick()
1063:                 Math.getSqrtRatioAtTick(twapTick)

// @audit PanopticMath.getLiquidationBonus()
1098:             (liquidationBonus0, liquidationBonus1, collateralRemaining) = PanopticMath
                      .getLiquidationBonus(

// @audit Math.getSqrtRatioAtTick()
1102:                     Math.getSqrtRatioAtTick(twapTick),

// @audit Math.getSqrtRatioAtTick()
1103:                     Math.getSqrtRatioAtTick(finalTick),

// @audit PanopticMath.haircutPremia()
1122:             (deltaBonus0, deltaBonus1) = PanopticMath.haircutPremia(

// @audit Math.getSqrtRatioAtTick()
1129:                 Math.getSqrtRatioAtTick(_finalTick),

// @audit PanopticMath.computeExercisedAmounts()
1197:         (LeftRightSigned longAmounts, LeftRightSigned delegatedAmounts) = PanopticMath
                  .computeExercisedAmounts(touchedId[0], positionBalance);

// @audit PanopticMath.getRefundAmounts()
1242:         refundAmounts = PanopticMath.getRefundAmounts(

// @audit Math.getSqrtRatioAtTick()
1324:             Math.getSqrtRatioAtTick(atTick)

// @audit Math.unsafeDivRoundingUp()
1329:             return balanceCross >= Math.unsafeDivRoundingUp(thresholdCross * buffer, 10_000);

// @audit Math.mulDiv()
1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

// @audit Math.mulDiv96()
1349:                 Math.mulDiv96(tokenData0.rightSlot(), sqrtPriceX96);

// @audit Math.mulDivRoundingUp()
1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

// @audit Math.mulDiv96RoundingUp()
1354:                 Math.mulDiv96RoundingUp(tokenData0.leftSlot(), sqrtPriceX96);

// @audit PanopticMath.updatePositionsHash()
1383:             fingerprintIncomingList = PanopticMath.updatePositionsHash(

// @audit PanopticMath.updatePositionsHash()
1410:         uint256 newHash = PanopticMath.updatePositionsHash(

// @audit PanopticMath.twapFilter()
1451:         twapTick = PanopticMath.twapFilter(s_univ3pool, TWAP_WINDOW);

// @audit PanopticMath.getLiquidityChunk()
1521:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit PanopticMath.getLiquidityChunk()
1627:         uint256 liquidity = PanopticMath
                  .getLiquidityChunk(tokenId, legIndex, s_positionBalance[owner][tokenId].rightSlot())

// @audit PanopticMath.getLiquidityChunk()
1680:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit Math.min()
1778:                             Math.min(

// @audit Math.min()
1787:                             Math.min(

// @audit PanopticMath.getLiquidityChunk()
1877:                     uint256 positionLiquidity = PanopticMath
                              .getLiquidityChunk(tokenId, leg, positionSize)

// @audit Math.max()
1934:                                             Math.max(

// @audit Math.max()
1951:                                             Math.max(

```
([525](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L525-L525),[712](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L712-L713),[775](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L775-L775),[905](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L905-L905),[915](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L915-L915),[923](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L923-L923),[943](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L943-L943),[981](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L981-L982),[1035](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1035-L1035),[1063](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1063-L1063),[1098](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1098-L1099),[1102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1102-L1102),[1103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1103-L1103),[1122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1122-L1122),[1129](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1129-L1129),[1197](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1197-L1198),[1242](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1242-L1242),[1324](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1324-L1324),[1329](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1329-L1329),[1348](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1348-L1348),[1349](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1349-L1349),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1353-L1353),[1354](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1354-L1354),[1383](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1383-L1383),[1410](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1410-L1410),[1451](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1451-L1451),[1521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1521-L1521),[1627](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1627-L1628),[1680](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1680-L1680),[1778](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1778-L1778),[1787](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1787-L1787),[1877](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1877-L1878),[1934](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1934-L1934),[1951](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1951-L1951))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit PanopticMath.getPoolId()
367:         uint64 poolId = PanopticMath.getPoolId(univ3pool);

// @audit PanopticMath.incrementPoolPattern()
373:             poolId = PanopticMath.incrementPoolPattern(poolId);

// @audit CallbackLib.CallbackData()
408:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

// @audit CallbackLib.validateCallback()
410:         CallbackLib.validateCallback(msg.sender, FACTORY, decoded.poolFeatures);

// @audit SafeTransferLib.safeTransferFrom()
413:             SafeTransferLib.safeTransferFrom(

// @audit SafeTransferLib.safeTransferFrom()
420:             SafeTransferLib.safeTransferFrom(

// @audit CallbackLib.CallbackData()
441:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

// @audit CallbackLib.validateCallback()
443:         CallbackLib.validateCallback(msg.sender, FACTORY, decoded.poolFeatures);

// @audit SafeTransferLib.safeTransferFrom()
456:         SafeTransferLib.safeTransferFrom(token, decoded.payer, msg.sender, amountToPay);

// @audit PanopticMath.getLiquidityChunk()
604:             LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit CallbackLib.CallbackData()
774:                 CallbackLib.CallbackData({

// @audit CallbackLib.PoolFeatures()
775:                     poolFeatures: CallbackLib.PoolFeatures({

// @audit PanopticMath.convert1to0()
817:                 int256 net0 = itm0 - PanopticMath.convert1to0(itm1, sqrtPriceX96);

// @audit PanopticMath.getLiquidityChunk()
904:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit Math.getAmount0ForLiquidity()
922:                     amount0 += Math.getAmount0ForLiquidity(liquidityChunk);

// @audit Math.getAmount1ForLiquidity()
924:                     amount1 += Math.getAmount1ForLiquidity(liquidityChunk);

// @audit LeftRightLibrary.addCapped()
1123:         (s_accountPremiumOwed[positionKey], s_accountPremiumGross[positionKey]) = LeftRightLibrary
                  .addCapped(

// @audit Math.mulDiv128RoundingUp()
1169:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside0LastX128, liquidity)))

// @audit Math.mulDiv128RoundingUp()
1172:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside1LastX128, liquidity)))

// @audit Math.mulDiv128()
1176:                 .toRightSlot(int128(int256(Math.mulDiv128(feeGrowthInside0LastX128, liquidity))))

// @audit Math.mulDiv128()
1177:                 .toLeftSlot(int128(int256(Math.mulDiv128(feeGrowthInside1LastX128, liquidity))));

// @audit CallbackLib.CallbackData()
1191:             CallbackLib.CallbackData({ // compute by reading values from univ3pool every time

// @audit CallbackLib.PoolFeatures()
1192:                     poolFeatures: CallbackLib.PoolFeatures({

// @audit Math.mulDiv()
1350:                 premium0X64_base = Math.mulDiv(

// @audit Math.mulDiv()
1355:                 premium1X64_base = Math.mulDiv(

// @audit Math.mulDiv()
1369:                     premium0X64_owed = Math
                              .mulDiv(premium0X64_base, numerator, totalLiquidity)

// @audit Math.mulDiv()
1372:                     premium1X64_owed = Math
                              .mulDiv(premium1X64_base, numerator, totalLiquidity)

// @audit Math.mulDiv()
1393:                     premium0X64_gross = Math
                              .mulDiv(premium0X64_base, numerator, totalLiquidity ** 2)

// @audit Math.mulDiv()
1396:                     premium1X64_gross = Math
                              .mulDiv(premium1X64_base, numerator, totalLiquidity ** 2)

// @audit LeftRightLibrary.addCapped()
1507:                 (premiumOwed, premiumGross) = LeftRightLibrary.addCapped(

```
([367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L367-L367),[373](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L373-L373),[408](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L408-L408),[410](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L410-L410),[413](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L413-L413),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L420-L420),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L441-L441),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L443-L443),[456](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L456-L456),[604](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L604-L604),[774](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L774-L774),[775](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L775-L775),[817](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L817-L817),[904](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L904-L904),[922](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L922-L922),[924](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L924-L924),[1123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1123-L1124),[1169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1169-L1169),[1172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1172-L1172),[1176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1176-L1176),[1177](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1177-L1177),[1191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1191-L1191),[1192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1192-L1192),[1350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1350-L1350),[1355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1355-L1355),[1369](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1369-L1370),[1372](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1372-L1373),[1393](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1393-L1394),[1396](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1396-L1397),[1507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1507-L1507))
```solidity
File: contracts/libraries/FeesCalc.sol

// @audit PanopticMath.getLiquidityChunk()
56:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

// @audit Math.getAmountsForLiquidity()
62:                 (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(

// @audit Math.mulDiv128()
117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))

// @audit Math.mulDiv128()
118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));

```
([56](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L56-L56),[62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L62-L62),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L117-L117),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L118-L118))
```solidity
File: contracts/libraries/Math.sol

// @audit LiquidityChunkLibrary.createChunk()
251:                 LiquidityChunkLibrary.createChunk(

// @audit LiquidityChunkLibrary.createChunk()
281:                 LiquidityChunkLibrary.createChunk(

```
([251](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L251-L251),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L281-L281))
```solidity
File: contracts/libraries/PanopticMath.sol

// @audit Math.mostSignificantNibble()
77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

// @audit Math.sort()
155:             return int24(Math.sort(ticks)[cardinality / 2]);

// @audit Math.sort()
263:             int256[] memory sortedTicks = Math.sort(twapMeasurement);

// @audit Math.getLiquidityForAmount0()
326:             return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);

// @audit Math.getLiquidityForAmount1()
328:             return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);

// @audit PanopticMath.getRangesFromStrike()
349:             (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(width, tickSpacing);

// @audit Math.unsafeDivRoundingUp()
377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

// @audit Math.getSqrtRatioAtTick()
452:             convertCollateralData(tokenData0, tokenData1, tokenType, Math.getSqrtRatioAtTick(tick));

// @audit Math.getSqrtRatioAtTick()
476:                 ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))

// @audit Math.getSqrtRatioAtTick()
477:                 : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));

// @audit Math.mulDiv192()
495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);

// @audit Math.mulDiv128()
497:                 return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

// @audit Math.mulDiv()
512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

// @audit Math.mulDiv()
514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

// @audit Math.mulDiv192()
529:                 int256 absResult = Math
                         .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

// @audit Math.absUint()
530:                     .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

// @audit Math.mulDiv128()
534:                 int256 absResult = Math
                         .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))

// @audit Math.absUint()
535:                     .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))

// @audit Math.mulDiv()
552:                 int256 absResult = Math
                         .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

// @audit Math.absUint()
553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

// @audit Math.mulDiv()
557:                 int256 absResult = Math
                         .mulDiv(

// @audit Math.absUint()
559:                         Math.absUint(amount),

// @audit Math.mulDiv64()
561:                         Math.mulDiv64(sqrtPriceX96, sqrtPriceX96)

// @audit Math.getAmount1ForLiquidity()
587:             amount1 = Math
                     .getAmount1ForLiquidity(Math.getLiquidityForAmount0(tickLower, tickUpper, amount0))

// @audit Math.getLiquidityForAmount0()
588:                 .getAmount1ForLiquidity(Math.getLiquidityForAmount0(tickLower, tickUpper, amount0))

// @audit Math.getAmount0ForLiquidity()
593:             amount0 = Math
                     .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))

// @audit Math.getLiquidityForAmount1()
594:                 .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))

// @audit Math.toInt128()
621:                 shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));

// @audit Math.toInt128()
624:                 longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));

// @audit Math.toInt128()
629:                 shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));

// @audit Math.toInt128()
632:                 longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));

// @audit PanopticMath.convert0to1()
664:                 uint256 required0 = PanopticMath.convert0to1(

// @audit PanopticMath.convertCollateralData()
671:                 (uint256 balanceCross, uint256 thresholdCross) = PanopticMath.convertCollateralData(

// @audit Math.min()
678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);

// @audit Math.mulDiv128()
681:                 bonus0 = int256(Math.mulDiv128(bonusCross, requiredRatioX128));

// @audit PanopticMath.convert0to1()
684:                     PanopticMath.convert0to1(

// @audit Math.mulDiv128()
685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

// @audit Math.max()
694:                 Math.max(premia.rightSlot(), 0);

// @audit Math.max()
696:                 Math.max(premia.leftSlot(), 0);

// @audit Math.min()
715:                     bonus1 += Math.min(

// @audit PanopticMath.convert0to1()
717:                         PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)

// @audit Math.min()
719:                     bonus0 -= Math.min(

// @audit PanopticMath.convert1to0()
720:                         PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),

// @audit Math.min()
733:                     bonus0 += Math.min(

// @audit PanopticMath.convert1to0()
735:                         PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)

// @audit Math.min()
737:                     bonus1 -= Math.min(

// @audit PanopticMath.convert0to1()
738:                         PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),

// @audit Math.min()
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);

// @audit Math.min()
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);

// @audit Math.min()
803:                     -Math.min(

// @audit PanopticMath.convert1to0()
805:                         PanopticMath.convert1to0(

// @audit Math.min()
810:                     Math.min(

// @audit PanopticMath.convert0to1()
812:                         PanopticMath.convert0to1(

// @audit Math.min()
827:                     Math.min(

// @audit PanopticMath.convert1to0()
829:                         PanopticMath.convert1to0(

// @audit Math.min()
834:                     -Math.min(

// @audit PanopticMath.convert0to1()
836:                         PanopticMath.convert0to1(

// @audit Math.min()
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());

// @audit Math.min()
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());

// @audit Math.unsafeDivRoundingUp()
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(

// @audit Math.unsafeDivRoundingUp()
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(

// @audit Math.max()
888:                         settled0 = Math.max(

// @audit Math.max()
892:                         settled1 = Math.max(

// @audit Math.getSqrtRatioAtTick()
924:         uint160 sqrtPriceX96 = Math.getSqrtRatioAtTick(atTick);

// @audit PanopticMath.convert0to1()
939:                                     PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)

// @audit PanopticMath.convert1to0()
957:                                     PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)

```
([77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L77-L77),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L155-L155),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L263-L263),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L326-L326),[328](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L328-L328),[349](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L349-L349),[377](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L377-L377),[452](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L452-L452),[476](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L476-L476),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L477-L477),[495](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L495-L495),[497](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L497-L497),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[514](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L514-L514),[529](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L529-L530),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L530-L530),[534](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L534-L535),[535](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L535-L535),[552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L552-L553),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[557](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L557-L558),[559](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L559-L559),[561](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L561-L561),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L587-L588),[588](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L588-L588),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L593-L594),[594](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L594-L594),[621](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L621-L621),[624](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L624-L624),[629](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L629-L629),[632](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L632-L632),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L664-L664),[671](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L671-L671),[678](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L678-L678),[681](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L681-L681),[684](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L684-L684),[685](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L685-L685),[694](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L694-L694),[696](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L696-L696),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L715-L715),[717](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L717-L717),[719](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L719-L719),[720](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L720-L720),[733](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L733-L733),[735](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L735-L735),[737](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L737-L737),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L738-L738),[791](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L791-L791),[792](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L792-L792),[803](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L803-L803),[805](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L805-L805),[810](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L810-L810),[812](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L812-L812),[827](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L827-L827),[829](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L829-L829),[834](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L834-L834),[836](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L836-L836),[847](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L847-L847),[848](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L848-L848),[869](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L869-L869),[873](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L873-L873),[888](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L888-L888),[892](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L892-L892),[924](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L924-L924),[939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L939-L939),[957](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L957-L957))
```solidity
File: contracts/types/LeftRight.sol

// @audit Math.max()
265:                 z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(

// @audit Math.max()
266:                     int128(Math.max(left128, 0))

```
([265](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L265-L265),[266](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L266-L266))
```solidity
File: contracts/types/TokenId.sol

// @audit PanopticMath.getTicks()
420:         (legLowerTick, legUpperTick) = PanopticMath.getTicks(

// @audit PanopticMath.getRangesFromStrike()
582:                 (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(

```
([420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L420-L420),[582](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L582-L582))
### <a name="NC-41"></a>[NC-41] It is best practice to use linear inheritance
In Solidity, complex inheritance structures can obfuscate code understanding, introducing potential security risks. Multiple inheritance, especially with overlapping function names or state variables, can cause unintentional overrides or ambiguous behavior. Resolution: Strive for linear and simple inheritance chains. Avoid diamond or circular inheritance patterns. Clearly document the purpose and relationships of base contracts, ensuring that overrides are intentional. Tools like Remix or Hardhat can visualize inheritance chains, assisting in verification. Keeping inheritance streamlined aids in better code readability, reduces potential errors, and ensures smoother audits and upgrades.

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
### <a name="NC-42"></a>[NC-42] Lines are too long
Usually lines in source code are limited to [80](https://softwareengineering.stackexchange.com/questions/148677/why-is-80-characters-the-standard-limit-for-code-width) characters. Today's screens are much larger so it's reasonable to stretch this in some cases. Since the files will most likely reside in GitHub, and GitHub starts using a scroll bar in all cases when the length is over [164](https://github.com/aizatto/character-length) characters, the lines below should be split when they reach that length

*There are 1 Instance of this issue* :
```solidity
File: contracts/CollateralTracker.sol

851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

```
([851](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L851-L851))
### <a name="NC-43"></a>[NC-43] Ensure `block.timestamp` is only used in long time intervals
`block.timestamp` represents the current block's timestamp and can be influenced, within limits, by miners. For short time intervals, this malleability can be exploited, potentially allowing miners to manipulate contract behavior. For instance, they might fast-forward an expiration or delay an event. When designing smart contracts, if precise time checks are needed for short intervals, alternatives like block numbers can be considered. However, for longer durations where a few seconds of deviation is inconsequential, `block.timestamp` is generally safe and efficient. Always assess the implications of time manipulations for the specific use-case before utilizing `block.timestamp`. In practice, if you're using `block.timestamp` to measure intervals that are a matter of days, weeks, or longer, the potential manipulation by miners becomes less significant. Always prioritize the security and integrity of your smart contract operations when making these decisions.

*There are 3 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

309:                 (uint256(block.timestamp) << 216) +

```
([309](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L309-L309))
```solidity
File: contracts/libraries/PanopticMath.sol

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

227:                     (block.timestamp << 216) +

```
([183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L183-L183),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L227-L227))
### <a name="NC-44"></a>[NC-44] Use transfer libraries instead of low level calls
Consider using `SafeTransferLib.safeTransferETH`or `Address.sendValue` for clearer semantic meaning instead of using a low level call.

*There are 1 Instance of this issue* :
```solidity
File: contracts/multicall/Multicall.sol

15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L15-L15))
### <a name="NC-45"></a>[NC-45] `constant`s should be defined rather than using magic numbers
Even [assembly](https://github.com/code-423n4/2022-05-opensea-seaport/blob/9d7ce4d08bf3c3010304a0476a785c70c0e90ae7/contracts/lib/TokenTransferrer.sol#L35-L39) can benefit from using readable constants instead of hex/numeric literals

*There are 280 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

202:                 2230 +

204:                     10_000 +

205:                     (7812 * ratioTick ** 2) /

206:                     10_000 ** 2 +

206:                     10_000 ** 2 +

207:                     (6510 * ratioTick ** 3) /

208:                     10_000 ** 3

208:                     10_000 ** 3

234:         totalSupply = 10 ** 6;

234:         totalSupply = 10 ** 6;

249:             _poolFee = fee / 100;

671:                                 2

763:                           |                  max ratio = 100%

764:                    100% - |                _------

767:                     20% - |---------¯

770:                                    50%    90% 100%     UTILIZATION

770:                                    50%    90% 100%     UTILIZATION

770:                                    50%    90% 100%     UTILIZATION

778:                 min_sell_ratio /= 2;

826:                  |   buy_ratio = 10%

827:            10% - |----------__       min_ratio = 5%

827:            10% - |----------__       min_ratio = 5%

828:            5%  - | . . . . .  ¯¯¯--______

831:                           50%    90% 100%      UTILIZATION

831:                           50%    90% 100%      UTILIZATION

831:                           50%    90% 100%      UTILIZATION

843:                 return BUYER_COLLATERAL_RATIO / 2;

851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

1330:             : int64(uint64(poolUtilization >> 64));

1378:                                     Short put BPR = 100% - (price/strike) + SCR

1386:                            100% + SCR% - |--__           .    .    .

1387:                                   100% - | . .¯¯--__     .    .    .

1586:                     : int64(uint64(poolUtilization >> 64))

1614:                     Put side of a short strangle, BPR = 100% - (100% - SCR/2)*(price/strike)

1620:                   100% - |--__                .

1632:             uint64 poolUtilization1 = uint64(poolUtilization >> 64);

1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

```
([200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L200-L200),[202](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L202-L202),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L204-L204),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L205-L205),[206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L206-L206),[206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L206-L206),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L207-L207),[208](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L208-L208),[208](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L208-L208),[234](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L234-L234),[234](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L234-L234),[249](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L249-L249),[671](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L671-L671),[763](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L763-L763),[764](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L764-L764),[767](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L767-L767),[770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L770-L770),[770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L770-L770),[770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L770-L770),[778](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L778-L778),[826](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L826-L826),[827](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L827-L827),[827](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L827-L827),[828](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L828-L828),[831](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L831-L831),[831](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L831-L831),[831](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L831-L831),[843](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L843-L843),[851](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L851-L851),[1330](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1330-L1330),[1378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1378-L1378),[1386](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1386-L1386),[1387](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1387-L1387),[1586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1586-L1586),[1614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1614-L1614),[1620](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1620-L1620),[1632](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1632-L1632),[1638](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1638-L1638))
```solidity
File: contracts/PanopticPool.sol

309:                 (uint256(block.timestamp) << 216) +

313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

370:         poolUtilization1 = uint64(balanceData.leftSlot() >> 64);

730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

1329:             return balanceCross >= Math.unsafeDivRoundingUp(thresholdCross * buffer, 10_000);

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1445:         _numberOfPositions = (s_positionsHash[user] >> 248);

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1769:                 totalLiquidity) / 2 ** 64;

1769:                 totalLiquidity) / 2 ** 64;

1771:                 totalLiquidity) / 2 ** 64;

1771:                 totalLiquidity) / 2 ** 64;

1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

```
([309](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L309-L309),[313](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L313-L313),[370](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L370-L370),[730](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L730-L730),[1329](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1329-L1329),[1348](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1348-L1348),[1348](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1348-L1348),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1353-L1353),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1353-L1353),[1415](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1415-L1415),[1445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1445-L1445),[1487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1487-L1487),[1487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1487-L1487),[1552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1552-L1552),[1552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1552-L1552),[1561](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1561-L1561),[1561](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1561-L1561),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596),[1635](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1635-L1635),[1635](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1635-L1635),[1636](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1636-L1636),[1636](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1636-L1636),[1769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1769-L1769),[1769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1769-L1769),[1771](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1771-L1771),[1771](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1771-L1771),[1942](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1942-L1942),[1942](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1942-L1942),[1959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1959-L1959),[1959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1959-L1959))
```solidity
File: contracts/SemiFungiblePositionManager.sol

223:                                       = feeGrowthX128 * T * (1 + ν*R^2/(N*T))                (Eqn 2)

244:              s_accountPremiumOwed += feesCollected * T/N^2 * (1 - R/T + ν*R/T)          (Eqn 3)     

260:         However, since we require that Eqn 2 holds up-- ie. the gross fees collected should be equal

264:             s_accountPremiumGross += feesCollected * T/N^2 * (1 - R/T + ν*R^2/T^2)       (Eqn 4) 

273:                                 = ∆feeGrowthX128 * t * (1  + ν*R^2/(N*T))   (same as Eqn 2)

275:         where the last expression matches Eqn 2 exactly.

388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

1352:                     totalLiquidity * 2 ** 64,

1352:                     totalLiquidity * 2 ** 64,

1353:                     netLiquidity ** 2

1357:                     totalLiquidity * 2 ** 64,

1357:                     totalLiquidity * 2 ** 64,

1358:                     netLiquidity ** 2

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1388:                     uint256 numerator = totalLiquidity ** 2 -

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

1394:                         .mulDiv(premium0X64_base, numerator, totalLiquidity ** 2)

1397:                         .mulDiv(premium1X64_base, numerator, totalLiquidity ** 2)

```
([223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L223-L223),[244](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L244-L244),[260](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L260-L260),[264](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L264-L264),[273](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L273-L273),[275](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L275-L275),[388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L388-L388),[388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L388-L388),[1352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1352-L1352),[1352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1352-L1352),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1353-L1353),[1357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1357-L1357),[1357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1357-L1357),[1358](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1358-L1358),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1367-L1367),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1388-L1388),[1391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1391-L1391),[1391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1391-L1391),[1394](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1394-L1394),[1397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1397-L1397))
```solidity
File: contracts/libraries/Constants.sol

22:         1461446703485210103287273052203988822378723970342;

```
([22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L22-L22))
```solidity
File: contracts/libraries/Math.sol

94:                 x >>= 128;

95:                 r += 32;

98:                 x >>= 64;

99:                 r += 16;

102:                 x >>= 32;

103:                 r += 8;

106:                 x >>= 16;

107:                 r += 4;

110:                 x >>= 8;

111:                 r += 2;

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));

179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));

197:                     uint256(liquidityChunk.liquidity()) << 96,

414:             uint256 inv = (3 * denominator) ^ 2;

418:             inv *= 2 - denominator * inv; // inverse mod 2**8

419:             inv *= 2 - denominator * inv; // inverse mod 2**16

420:             inv *= 2 - denominator * inv; // inverse mod 2**32

421:             inv *= 2 - denominator * inv; // inverse mod 2**64

422:             inv *= 2 - denominator * inv; // inverse mod 2**128

423:             inv *= 2 - denominator * inv; // inverse mod 2**256

484:             require(2 ** 64 > prod1);

511:             prod0 |= prod1 * 2 ** 192;

511:             prod0 |= prod1 * 2 ** 192;

547:             require(2 ** 96 > prod1);

574:             prod0 |= prod1 * 2 ** 160;

574:             prod0 |= prod1 * 2 ** 160;

587:             if (mulmod(a, b, 2 ** 96) > 0) {

587:             if (mulmod(a, b, 2 ** 96) > 0) {

624:             require(2 ** 128 > prod1);

651:             prod0 |= prod1 * 2 ** 128;

651:             prod0 |= prod1 * 2 ** 128;

664:             if (mulmod(a, b, 2 ** 128) > 0) {

664:             if (mulmod(a, b, 2 ** 128) > 0) {

701:             require(2 ** 192 > prod1);

728:             prod0 |= prod1 * 2 ** 64;

728:             prod0 |= prod1 * 2 ** 64;

758:             int256 pivot = arr[uint256(left + (right - left) / 2)];

```
([94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L94-L94),[95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L95-L95),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L98-L98),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L99-L99),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L102-L102),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L103-L103),[106](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L106-L106),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L107-L107),[110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L110-L110),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L111-L111),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L179-L179),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L179-L179),[197](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L197-L197),[414](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L414-L414),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L418-L418),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L419-L419),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L420-L420),[421](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L421-L421),[422](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L422-L422),[423](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L423-L423),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L484-L484),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L511-L511),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L511-L511),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L547-L547),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L574-L574),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L574-L574),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L587-L587),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L587-L587),[624](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L624-L624),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L651-L651),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L651-L651),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L664-L664),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L664-L664),[701](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L701-L701),[728](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L728-L728),[728](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L728-L728),[758](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L758-L758))
```solidity
File: contracts/libraries/PanopticMath.sol

50:             uint64 poolId = uint64(uint160(univ3pool) >> 112);

51:             poolId += uint64(uint24(tickSpacing)) << 48;

77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

107:                     ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)

107:                     ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)

108:                     : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);

108:                     : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);

155:             return int24(Math.sort(ticks)[cardinality / 2]);

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

180:                 2;

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

200:                 uint24 orderMap = uint24(medianData >> 192);

207:                 for (uint8 i; i < 8; ++i) {

209:                     rank = (orderMap >> (3 * i)) % 8;

211:                     if (rank == 7) {

217:                     entry = int24(uint24(medianData >> (rank * 24)));

227:                     (block.timestamp << 216) +

228:                     (uint256(newOrderMap) << 192) +

229:                     uint256(uint192(medianData << 24)) +

248:             for (uint256 i = 0; i < 20; ++i) {

249:                 secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);

256:             for (uint256 i = 0; i < 19; ++i) {

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

376:             (width * tickSpacing) / 2,

377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

476:                 ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))

477:                 : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));

495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

530:                     .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

560:                         2 ** 128,

560:                         2 ** 128,

669:                 uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);

678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

```
([50](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L50-L50),[51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L51-L51),[77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L77-L77),[77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L77-L77),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L107-L107),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L107-L107),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L108-L108),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L108-L108),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L155-L155),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L178),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L178),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L178),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L178),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L180-L180),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L183-L183),[200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L200-L200),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L207-L207),[209](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L209-L209),[211](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L211-L211),[217](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L217-L217),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L227-L227),[228](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L228-L228),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L229-L229),[248](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L248-L248),[249](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L249-L249),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L256-L256),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L258-L258),[376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L376-L376),[377](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L377-L377),[476](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L476-L476),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L477-L477),[495](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L495-L495),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L512-L512),[514](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L514-L514),[514](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L514-L514),[530](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L530-L530),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[553](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L553-L553),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L560-L560),[560](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L560-L560),[669](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L669-L669),[678](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L678-L678),[685](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L685-L685),[685](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L685-L685))
```solidity
File: contracts/libraries/SafeTransferLib.sol

37:                 or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),

41:                 call(gas(), token, 0, p, 100, 0, 32)

41:                 call(gas(), token, 0, p, 100, 0, 32)

67:                 or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),

71:                 call(gas(), token, 0, p, 68, 0, 32)

71:                 call(gas(), token, 0, p, 68, 0, 32)

```
([37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L37-L37),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L41-L41),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L41-L41),[67](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L67-L67),[71](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L71-L71),[71](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L71-L71))
```solidity
File: contracts/multicall/Multicall.sol

26:                     revert(add(result, 32), mload(result))

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L26-L26))
```solidity
File: contracts/types/LeftRight.sol

102:         return uint128(LeftRightUnsigned.unwrap(self) >> 128);

109:         return int128(LeftRightSigned.unwrap(self) >> 128);

126:             return LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(self) + (uint256(left) << 128));

136:             return LeftRightSigned.wrap(LeftRightSigned.unwrap(self) + (int256(left) << 128));

```
([102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L102-L102),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L109-L109),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L126-L126),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L136-L136))
```solidity
File: contracts/types/LiquidityChunk.sol

78:                     (uint256(uint24(_tickLower)) << 232) +

79:                         (uint256(uint24(_tickUpper)) << 208) +

109:                     LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)

126:                     LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)

173:             return int24(int256(LiquidityChunk.unwrap(self) >> 232));

182:             return int24(int256(LiquidityChunk.unwrap(self) >> 208));

```
([78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L78-L78),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L79-L79),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L109-L109),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L126-L126),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L173-L173),[182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L182-L182))
```solidity
File: contracts/types/TokenId.sol

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

110:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48)) % 2);

110:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48)) % 2);

120:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 1)) % 128);

120:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 1)) % 128);

130:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);

130:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);

130:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);

140:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);

140:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);

140:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);

150:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);

150:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);

150:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);

160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

195:             return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));

212:                 TokenId.wrap(TokenId.unwrap(self) + (uint256(_asset % 2) << (64 + legIndex * 48)));

212:                 TokenId.wrap(TokenId.unwrap(self) + (uint256(_asset % 2) << (64 + legIndex * 48)));

229:                     TokenId.unwrap(self) + (uint256(_optionRatio % 128) << (64 + legIndex * 48 + 1))

229:                     TokenId.unwrap(self) + (uint256(_optionRatio % 128) << (64 + legIndex * 48 + 1))

246:             return TokenId.wrap(TokenId.unwrap(self) + ((_isLong % 2) << (64 + legIndex * 48 + 8)));

246:             return TokenId.wrap(TokenId.unwrap(self) + ((_isLong % 2) << (64 + legIndex * 48 + 8)));

246:             return TokenId.wrap(TokenId.unwrap(self) + ((_isLong % 2) << (64 + legIndex * 48 + 8)));

263:                     TokenId.unwrap(self) + (uint256(_tokenType % 2) << (64 + legIndex * 48 + 9))

263:                     TokenId.unwrap(self) + (uint256(_tokenType % 2) << (64 + legIndex * 48 + 9))

263:                     TokenId.unwrap(self) + (uint256(_tokenType % 2) << (64 + legIndex * 48 + 9))

281:                     TokenId.unwrap(self) + (uint256(_riskPartner % 4) << (64 + legIndex * 48 + 10))

281:                     TokenId.unwrap(self) + (uint256(_riskPartner % 4) << (64 + legIndex * 48 + 10))

281:                     TokenId.unwrap(self) + (uint256(_riskPartner % 4) << (64 + legIndex * 48 + 10))

300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

376:             if (optionRatios < 2 ** 64) {

376:             if (optionRatios < 2 ** 64) {

378:             } else if (optionRatios < 2 ** 112) {

378:             } else if (optionRatios < 2 ** 112) {

380:             } else if (optionRatios < 2 ** 160) {

380:             } else if (optionRatios < 2 ** 160) {

381:                 optionRatios = 2;

382:             } else if (optionRatios < 2 ** 208) {

382:             } else if (optionRatios < 2 ** 208) {

383:                 optionRatios = 3;

385:                 optionRatios = 4;

439:         if (optionRatios < 2 ** 64) {

439:         if (optionRatios < 2 ** 64) {

441:         } else if (optionRatios < 2 ** 112) {

441:         } else if (optionRatios < 2 ** 112) {

443:         } else if (optionRatios < 2 ** 160) {

443:         } else if (optionRatios < 2 ** 160) {

444:             return 2;

445:         } else if (optionRatios < 2 ** 208) {

445:         } else if (optionRatios < 2 ** 208) {

446:             return 3;

448:         return 4;

477:         if (i == 2)

483:         if (i == 3)

506:             uint256 chunkData = (TokenId.unwrap(self) & CHUNK_MASK) >> 64;

507:             for (uint256 i = 0; i < 4; ++i) {

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)

```
([98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L98-L98),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L98-L98),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L98-L98),[110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L110-L110),[110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L110-L110),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L120-L120),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L120-L120),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L130-L130),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L130-L130),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L130-L130),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L140-L140),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L140-L140),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L140-L140),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L150-L150),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L150-L150),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L150-L150),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L160-L160),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L160-L160),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[195](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L195-L195),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L212-L212),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L212-L212),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L229-L229),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L229-L229),[246](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L246-L246),[246](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L246-L246),[246](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L246-L246),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L263-L263),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L263-L263),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L263-L263),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L281-L281),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L281-L281),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L281-L281),[300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L300-L300),[300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L300-L300),[320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L320-L320),[320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L320-L320),[320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L320-L320),[376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L376-L376),[376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L376-L376),[378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L378-L378),[378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L378-L378),[380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L380-L380),[380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L380-L380),[381](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L381-L381),[382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L382-L382),[382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L382-L382),[383](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L383-L383),[385](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L385-L385),[439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L439-L439),[439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L439-L439),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L441-L441),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L441-L441),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L443-L443),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L443-L443),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L444-L444),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L445-L445),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L445-L445),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L446-L446),[448](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L448-L448),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L477-L477),[483](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L483-L483),[506](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L506-L506),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L507-L507),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L512-L512))
### <a name="NC-46"></a>[NC-46] `type(uint<n>).max` should be used instead of `uint<n>(-1)`

*There are 34 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

393:         return type(uint104).max;

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

544:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

602:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;

```
([393](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L393-L393),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L418-L418),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L446-L446),[480](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L480-L480),[544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L544-L544),[602](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L602-L602))
```solidity
File: contracts/PanopticPool.sol

757:                     type(int24).max,

1713:                     type(int24).max,

1780:                                     (accumulated0 == 0 ? type(uint256).max : accumulated0),

1789:                                     (accumulated1 == 0 ? type(uint256).max : accumulated1),

1849:             type(int24).max

```
([757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L757-L757),[1713](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1713-L1713),[1780](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1780-L1780),[1789](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1789-L1789),[1849](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1849-L1849))
```solidity
File: contracts/SemiFungiblePositionManager.sol

939:         if (amount0 > uint128(type(int128).max) || amount1 > uint128(type(int128).max))

939:         if (amount0 > uint128(type(int128).max) || amount1 > uint128(type(int128).max))

1465:         if (atTick < type(int24).max) {

```
([939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L939-L939),[939](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L939-L939),[1465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1465-L1465))
```solidity
File: contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);

```
([32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L32-L32),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L33-L33),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L36-L36),[37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L37-L37))
```solidity
File: contracts/libraries/Math.sol

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

304:             downcastedInt = type(uint128).max;

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

0: undefined

0: undefined

0: undefined

```
([176](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L176-L176),[304](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L304-L304),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L326-L326),[0](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L0),[0](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L0),[0](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L0))
```solidity
File: contracts/libraries/PanopticMath.sol

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

494:             if (sqrtPriceX96 < type(uint128).max) {

511:             if (sqrtPriceX96 < type(uint128).max) {

528:             if (sqrtPriceX96 < type(uint128).max) {

551:             if (sqrtPriceX96 < type(uint128).max) {

```
([479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L479-L479),[494](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L494-L494),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L511-L511),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L528-L528),[551](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L551-L551))
```solidity
File: contracts/tokens/ERC20Minimal.sol

84:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;

```
([84](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L84-L84))
```solidity
File: contracts/types/LeftRight.sol

290:         bool r_Enabled = !(z_xR == type(uint128).max || z_yR == type(uint128).max);

290:         bool r_Enabled = !(z_xR == type(uint128).max || z_yR == type(uint128).max);

291:         bool l_Enabled = !(z_xL == type(uint128).max || z_yL == type(uint128).max);

291:         bool l_Enabled = !(z_xL == type(uint128).max || z_yL == type(uint128).max);

```
([290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L290-L290),[290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L290-L290),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L291-L291),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L291-L291))
### <a name="NC-47"></a>[NC-47] Consider checking that transfer to `address(this)` is disabled
Functions allowing users to specify the receiving address should check whether the referenced address is not `address(this)`. This would prevent tokens to remain lock inside the contract due to an incorrect `transfer` or `mint`.

*There are 10 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit missing checks for -->  receiver
477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

```
([477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L477-L477))
```solidity
File: contracts/PanopticFactory.sol

// @audit missing checks for -->  v3Pool, token0, token1
335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

```
([335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340))
```solidity
File: contracts/PanopticPool.sol

// @audit missing checks for -->  positionIdList
547:     function mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

// @audit missing checks for -->  positionIdList
614:     function _mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal {

// @audit missing checks for -->  tokenId
677:     function _mintInSFPMAndUpdateCollateral(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (uint128) {

// @audit missing checks for -->  tokenId, collectedByLeg
1666:     function _updateSettlementPostMint(
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize
          ) internal {

```
([547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L547-L553),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L614-L620),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L677-L682),[1666](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1666-L1670))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit missing checks for -->  tokenId
504:     function mintTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

// @audit missing checks for -->  liquidityChunk, univ3pool
1185:     function _mintLiquidity(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool
          ) internal returns (LeftRightSigned movedAmounts) {

```
([504](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L504-L513),[1185](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1185-L1188))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit missing checks for -->  to
214:     function _mint(address to, uint256 id, uint256 amount) internal {

```
([214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L214))
```solidity
File: contracts/tokens/ERC20Minimal.sol

// @audit missing checks for -->  to
122:     function _mint(address to, uint256 amount) internal {

```
([122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L122))
### <a name="NC-48"></a>[NC-48] Missing checks for `uint`/`int` state variable assignments
Consider whether reasonable bounds checks for variables would be useful

*There are 28 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;

```
([187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L192-L192),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L192-L192),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L193-L193))
### <a name="NC-49"></a>[NC-49] Empty `bytes` check is missing
To avoid mistakenly accepting empty `bytes` as a valid value, consider to check for empty `bytes`. This helps ensure that empty `bytes` are not treated as valid inputs, preventing potential issues.

*There are 12 Instances of this issue* :
```solidity
File: contracts/PanopticFactory.sol

// @audit missing checks for -->  data
172:     function uniswapV3MintCallback(
             uint256 amount0Owed,
             uint256 amount1Owed,
             bytes calldata data
         ) external {

// @audit missing checks for -->  salt
210:     function deployNewPool(
             address token0,
             address token1,
             uint24 fee,
             bytes32 salt
         ) external returns (PanopticPool newPoolContract) {

// @audit missing checks for -->  salt
290:     function minePoolAddress(
             bytes32 salt,
             uint256 loops,
             uint256 minTargetRarity
         ) external view returns (bytes32 bestSalt, uint256 highestRarity) {

```
([172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L172-L176),[210](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L210-L215),[290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L290-L294))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit missing checks for -->  data
402:     function uniswapV3MintCallback(
             uint256 amount0Owed,
             uint256 amount1Owed,
             bytes calldata data
         ) external {

// @audit missing checks for -->  data
435:     function uniswapV3SwapCallback(
             int256 amount0Delta,
             int256 amount1Delta,
             bytes calldata data
         ) external {

// @audit missing checks for -->  data
540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

// @audit missing checks for -->  data
566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

// @audit missing checks for -->  positionKey
1110:     function _updateStoredPremia(
              bytes32 positionKey,
              LeftRightUnsigned currentLiquidity,
              LeftRightUnsigned collectedAmounts
          ) private {

// @audit missing checks for -->  positionKey
1255:     function _collectAndWritePositionData(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool,
              LeftRightUnsigned currentLiquidity,
              bytes32 positionKey,
              LeftRightSigned movedInLeg,
              uint256 isLong
          ) internal returns (LeftRightUnsigned collectedChunk) {

```
([402](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L402-L406),[435](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L435-L439),[540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572),[1110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1110-L1114),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1255-L1262))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

// @audit missing checks for -->  data
94:     function safeTransferFrom(
            address from,
            address to,
            uint256 id,
            uint256 amount,
            bytes calldata data
        ) public virtual {

// @audit missing checks for -->  data
130:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public virtual {

// @audit missing checks for -->  interfaceId
200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {

```
([94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L94-L100),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L130-L136),[200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L200-L200))
### <a name="NC-50"></a>[NC-50] Custom errors has no error details
Consider adding parameters to the error to indicate which user or values caused the failure.

*There are 34 Instances of this issue* :
```solidity
File: contracts/libraries/Errors.sol

10:     error CastingError();

13:     error CollateralTokenAlreadyInitialized();

16:     error DepositTooLarge();

20:     error EffectiveLiquidityAboveThreshold();

23:     error ExceedsMaximumRedemption();

26:     error ExerciseeNotSolvent();

29:     error InputListFail();

32:     error InvalidSalt();

35:     error InvalidTick();

38:     error InvalidNotionalValue();

45:     error InvalidUniswapCallback();

48:     error LeftRightInputError();

51:     error NoLegsExercisable();

54:     error NotEnoughCollateral();

57:     error PositionTooLarge();

60:     error NotALongLeg();

63:     error NotEnoughLiquidity();

66:     error NotMarginCalled();

70:     error NotOwner();

73:     error NotPanopticPool();

76:     error OptionsBalanceZero();

79:     error PoolAlreadyInitialized();

82:     error PositionAlreadyMinted();

85:     error PositionCountNotZero();

88:     error PriceBoundFail();

91:     error ReentrantCall();

95:     error StaleTWAP();

98:     error TooManyPositionsOpen();

101:     error TransferFailed();

105:     error TicksNotInitializable();

108:     error UnderOverFlow();

111:     error UniswapPoolNotInitialized();

```
([10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L10-L10),[13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L13-L13),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L16-L16),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L20-L20),[23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L23-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L26-L26),[29](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L29-L29),[32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L32-L32),[35](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L35-L35),[38](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L38-L38),[45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L45-L45),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L48-L48),[51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L51-L51),[54](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L54-L54),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L57-L57),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L60-L60),[63](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L63-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L66-L66),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L73-L73),[76](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L76-L76),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L79-L79),[82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L82-L82),[85](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L85-L85),[88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L88-L88),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L91-L91),[95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L95-L95),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L98-L98),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L101-L101),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L105-L105),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L108-L108),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L111-L111))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

55:     error NotAuthorized();

58:     error UnsafeRecipient();

```
([55](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L55-L55),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L58-L58))
### <a name="NC-51"></a>[NC-51] Missing events in initializers
As a best practice, consider emitting an event when the contract is initialized. In this way, it's easy for the user to track the exact point in time when the contract was initialized, by filtering the emitted events.

*There are 1 Instance of this issue* :
```solidity
File: contracts/PanopticFactory.sol

134:     function initialize(address _owner) public {

```
([134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L134-L134))
### <a name="NC-52"></a>[NC-52] Missing checks for `uint`/`int` state variable constructor assignments
Consider whether reasonable bounds checks for variables would be useful

*There are 28 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

187:         COMMISSION_FEE = _commissionFee;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;

```
([187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L187-L187),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L188-L188),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L189-L189),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L190-L190),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L191-L191),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L192-L192),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L192-L192),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L193-L193))
### <a name="NC-53"></a>[NC-53] Consider moving `msg.sender` checks to `modifier`s
Modifiers in Solidity can improve code readability and modularity by encapsulating repetitive checks, such as address validity checks, into a reusable construct. For example, an `onlyOwner` modifier can be used to replace repetitive `require(msg.sender == owner)` checks across several functions, reducing code redundancy and enhancing maintainability. To implement, define a modifier with the check, then apply the modifier to relevant functions.

*There are 7 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

541:         if (msg.sender != owner) {

599:         if (msg.sender != owner) {

```
([541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L541-L541),[599](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L599-L599))
```solidity
File: contracts/PanopticFactory.sol

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

```
([150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L150-L150),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L220-L220),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L224-L224))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

```
([101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L101-L101),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L137-L137))
### <a name="NC-54"></a>[NC-54] Use a struct to encapsulate multiple function parameters
Using a struct to encapsulate multiple parameters in Solidity functions can significantly enhance code readability and maintainability. Instead of passing a long list of arguments, which can be error-prone and hard to manage, a struct allows grouping related data into a single, coherent entity. This approach simplifies function signatures and makes the code more organized. It also enhances code clarity, as developers can easily understand the relationship between the parameters. Moreover, it aids in future code modifications and expansions, as adding or modifying a parameter only requires changes in the struct definition, rather than in every function that uses these parameters.

*There are 64 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

178:     constructor(
             uint256 _commissionFee,
             uint256 _sellerCollateralRatio,
             uint256 _buyerCollateralRatio,
             int256 _forceExerciseCost,
             uint256 _targetPoolUtilization,
             uint256 _saturatedPoolUtilization,
             uint256 _ITMSpreadMultiplier
         ) {

221:     function startToken(
             bool underlyingIsToken0,
             address token0,
             address token1,
             uint24 fee,
             PanopticPool panopticPool
         ) external {

650:     function exerciseCost(
             int24 currentTick,
             int24 oracleTick,
             TokenId positionId,
             uint128 positionBalance,
             LeftRightSigned longAmounts
         ) external view returns (LeftRightSigned exerciseFees) {

995:     function takeCommissionAddData(
             address optionOwner,
             int128 longAmount,
             int128 shortAmount,
             int128 swappedAmount
         ) external onlyPanopticPool returns (int256 utilization) {

1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

1141:     function getAccountMarginDetails(
              address user,
              int24 currentTick,
              uint256[2][] memory positionBalanceArray,
              int128 premiumAllPositions
          ) public view returns (LeftRightUnsigned tokenData) {

1159:     function _getAccountMargin(
              address user,
              int24 atTick,
              uint256[2][] memory positionBalanceArray,
              int128 premiumAllPositions
          ) internal view returns (LeftRightUnsigned tokenData) {

1245:     function _getRequiredCollateralAtTickSinglePosition(
              TokenId tokenId,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 tokenRequired) {

1278:     function _getRequiredCollateralSingleLeg(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1311:     function _getRequiredCollateralSingleLegNoPartner(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1439:     function _getRequiredCollateralSingleLegPartner(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 required) {

1510:     function _computeSpread(
              TokenId tokenId,
              uint128 positionSize,
              uint256 index,
              uint256 partnerIndex,
              uint128 poolUtilization
          ) internal view returns (uint256 spreadRequirement) {

1600:     function _computeStrangle(
              TokenId tokenId,
              uint256 index,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 strangleRequired) {

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L178-L186),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L221-L227),[650](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L650-L656),[995](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L995-L1000),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049),[1141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1141-L1146),[1159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1159-L1164),[1245](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1245-L1250),[1278](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1278-L1284),[1311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1311-L1317),[1439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1439-L1445),[1510](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1510-L1516),[1600](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1600-L1606))
```solidity
File: contracts/PanopticFactory.sol

115:     constructor(
             address _WETH9,
             SemiFungiblePositionManager _SFPM,
             IUniswapV3Factory _univ3Factory,
             IDonorNFT _donorNFT,
             address _poolReference,
             address _collateralReference
         ) {

210:     function deployNewPool(
             address token0,
             address token1,
             uint24 fee,
             bytes32 salt
         ) external returns (PanopticPool newPoolContract) {

335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

```
([115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L115-L122),[210](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L210-L215),[335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340))
```solidity
File: contracts/PanopticPool.sol

291:     function startPool(
             IUniswapV3Pool _univ3pool,
             address token0,
             address token1,
             CollateralTracker collateralTracker0,
             CollateralTracker collateralTracker1
         ) external {

429:     function _calculateAccumulatedPremia(
             address user,
             TokenId[] calldata positionIdList,
             bool computeAllPremia,
             bool includePendingPremium,
             int24 atTick
         ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

547:     function mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

569:     function burnOptions(
             TokenId tokenId,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

586:     function burnOptions(
             TokenId[] calldata positionIdList,
             TokenId[] calldata newPositionIdList,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

614:     function _mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal {

677:     function _mintInSFPMAndUpdateCollateral(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (uint128) {

794:     function _burnAllOptionsFrom(
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool commitLongSettled,
             TokenId[] calldata positionIdList
         ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {

826:     function _burnOptions(
             bool commitLongSettled,
             TokenId tokenId,
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (LeftRightSigned paidAmounts, LeftRightSigned[4] memory premiaByLeg) {

955:     function _burnAndHandleExercise(
             bool commitLongSettled,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             TokenId tokenId,
             uint128 positionSize,
             address owner
         )
             internal
             returns (
                 LeftRightSigned realizedPremia,
                 LeftRightSigned[4] memory premiaByLeg,
                 LeftRightSigned paidAmounts
             )
         {

1017:     function liquidate(
              TokenId[] calldata positionIdListLiquidator,
              address liquidatee,
              LeftRightUnsigned delegations,
              TokenId[] calldata positionIdList
          ) external {

1179:     function forceExercise(
              address account,
              TokenId[] calldata touchedId,
              TokenId[] calldata positionIdListExercisee,
              TokenId[] calldata positionIdListExercisor
          ) external {

1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

1465:     function _checkLiquiditySpread(
              TokenId tokenId,
              uint256 leg,
              int24 tickLower,
              int24 tickUpper,
              uint64 effectiveLiquidityLimitX32
          ) internal view {

1503:     function _getPremia(
              TokenId tokenId,
              uint128 positionSize,
              address owner,
              bool computeAllPremia,
              int24 atTick
          )
              internal
              view
              returns (
                  LeftRightSigned[4] memory premiaByLeg,
                  uint256[2][4] memory premiumAccumulatorsByLeg
              )
          {

1757:     function _getAvailablePremium(
              uint256 totalLiquidity,
              LeftRightUnsigned settledTokens,
              LeftRightUnsigned grossPremiumLast,
              LeftRightUnsigned premiumOwed,
              uint256[2] memory premiumAccumulators
          ) internal pure returns (LeftRightUnsigned) {

1833:     function _updateSettlementPostBurn(
              address owner,
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize,
              bool commitLongSettled
          ) internal returns (LeftRightSigned realizedPremia, LeftRightSigned[4] memory premiaByLeg) {

```
([291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L291-L297),[429](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L429-L435),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L547-L553),[569](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L569-L574),[586](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L586-L591),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L614-L620),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L677-L682),[794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L794-L800),[826](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L826-L832),[955](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L955-L969),[1017](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1017-L1022),[1179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1179-L1184),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1465-L1471),[1503](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1503-L1516),[1757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1757-L1763),[1833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1833-L1839))
```solidity
File: contracts/SemiFungiblePositionManager.sol

471:     function burnTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

504:     function mintTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

680:     function _validateAndForwardToAMM(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool isBurn
         ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {

863:     function _createPositionInAMM(
             IUniswapV3Pool univ3pool,
             TokenId tokenId,
             uint128 positionSize,
             bool isBurn
         )
             internal
             returns (
                 LeftRightSigned totalMoved,
                 LeftRightUnsigned[4] memory collectedByLeg,
                 LeftRightSigned itmAmounts
             )
         {

958:     function _createLegInAMM(
             IUniswapV3Pool univ3pool,
             TokenId tokenId,
             uint256 leg,
             LiquidityChunk liquidityChunk,
             bool isBurn
         )
             internal
             returns (
                 LeftRightSigned moved,
                 LeftRightSigned itmAmounts,
                 LeftRightUnsigned collectedSingleLeg
             )
         {

1138:     function _getFeesBase(
              IUniswapV3Pool univ3pool,
              uint128 liquidity,
              LiquidityChunk liquidityChunk,
              bool roundUp
          ) private view returns (LeftRightSigned feesBase) {

1255:     function _collectAndWritePositionData(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool,
              LeftRightUnsigned currentLiquidity,
              bytes32 positionKey,
              LeftRightSigned movedInLeg,
              uint256 isLong
          ) internal returns (LeftRightUnsigned collectedChunk) {

1421:     function getAccountLiquidity(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper
          ) external view returns (LeftRightUnsigned accountLiquidities) {

1449:     function getAccountPremium(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper,
              int24 atTick,
              uint256 isLong
          ) external view returns (uint128, uint128) {

1535:     function getAccountFeesBase(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper
          ) external view returns (int128 feesBase0, int128 feesBase1) {

```
([471](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L471-L480),[504](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L504-L513),[540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L593-L593),[680](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L680-L686),[863](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L863-L875),[958](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L958-L971),[1138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1138-L1143),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1255-L1262),[1421](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1421-L1427),[1449](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1449-L1457),[1535](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1535-L1541))
```solidity
File: contracts/libraries/FeesCalc.sol

97:     function calculateAMMSwapFees(
            IUniswapV3Pool univ3pool,
            int24 currentTick,
            int24 tickLower,
            int24 tickUpper,
            uint128 liquidity
        ) public view returns (LeftRightSigned) {

130:     function _getAMMSwapFeesPerLiquidityCollected(
             IUniswapV3Pool univ3pool,
             int24 currentTick,
             int24 tickLower,
             int24 tickUpper
         ) internal view returns (uint256 feeGrowthInside0X128, uint256 feeGrowthInside1X128) {

```
([97](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L97-L103),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L130-L135))
```solidity
File: contracts/libraries/InteractionHelper.sol

24:     function doApprovals(
            SemiFungiblePositionManager sfpm,
            CollateralTracker ct0,
            CollateralTracker ct1,
            address token0,
            address token1
        ) external {

48:     function computeName(
            address token0,
            address token1,
            bool isToken0,
            uint24 fee,
            string memory prefix
        ) external view returns (string memory) {

```
([24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L24-L30),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L48-L54))
```solidity
File: contracts/libraries/PanopticMath.sol

125:     function computeMedianObservedPrice(
             IUniswapV3Pool univ3pool,
             uint256 observationIndex,
             uint256 observationCardinality,
             uint256 cardinality,
             uint256 period
         ) external view returns (int24) {

168:     function computeInternalMedian(
             uint256 observationIndex,
             uint256 observationCardinality,
             uint256 period,
             uint256 medianData,
             IUniswapV3Pool univ3pool
         ) external view returns (int24 medianTick, uint256 updatedMedianData) {

419:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             uint160 sqrtPriceX96
         ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             int24 tick
         ) internal pure returns (uint256, uint256) {

468:     function convertNotional(
             uint128 contractSize,
             int24 tickLower,
             int24 tickUpper,
             uint256 asset
         ) internal pure returns (uint128) {

651:     function getLiquidationBonus(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint160 sqrtPriceX96Twap,
             uint160 sqrtPriceX96Final,
             LeftRightSigned netExchanged,
             LeftRightSigned premia
         ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

917:     function getRefundAmounts(
             address refunder,
             LeftRightSigned refundValues,
             int24 atTick,
             CollateralTracker collateral0,
             CollateralTracker collateral1
         ) external view returns (LeftRightSigned) {

```
([125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L125-L131),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L168-L174),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L419-L424),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L445-L450),[468](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L468-L473),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L651-L658),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777),[917](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L917-L923))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

94:     function safeTransferFrom(
            address from,
            address to,
            uint256 id,
            uint256 amount,
            bytes calldata data
        ) public virtual {

130:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public virtual {

```
([94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L94-L100),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L130-L136))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

13:     function issueNFT(
            address deployer,
            PanopticPool newPoolContract,
            address token0,
            address token1,
            uint24 fee
        ) external;

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L13-L19))
```solidity
File: contracts/types/LeftRight.sol

279:     function addCapped(
             LeftRightUnsigned x,
             LeftRightUnsigned dx,
             LeftRightUnsigned y,
             LeftRightUnsigned dy
         ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {

```
([279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L279-L284))
```solidity
File: contracts/types/TokenId.sol

336:     function addLeg(
             TokenId self,
             uint256 legIndex,
             uint256 _optionRatio,
             uint256 _asset,
             uint256 _isLong,
             uint256 _tokenType,
             uint256 _riskPartner,
             int24 _strike,
             int24 _width
         ) internal pure returns (TokenId tokenId) {

```
([336](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L336-L346))
### <a name="NC-55"></a>[NC-55] Consider using named mappings
Consider using [named mappings](https://ethereum.stackexchange.com/questions/51629/how-to-name-the-arguments-in-mapping/145555#145555) to make it easier to understand the purpose of each mapping

*There are 6 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))

258:     mapping(address account => mapping(TokenId tokenId => LeftRightUnsigned balanceAndUtilizations))

```
([238](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L238-L238),[238](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L238-L238),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L258-L258))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

66:     mapping(address account => mapping(uint256 tokenId => uint256 balance)) public balanceOf;

71:     mapping(address owner => mapping(address operator => bool approvedForAll))

```
([66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L66-L66),[71](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L71-L71))
```solidity
File: contracts/tokens/ERC20Minimal.sol

39:     mapping(address owner => mapping(address spender => uint256 allowance)) public allowance;

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L39-L39))
### <a name="NC-56"></a>[NC-56] Missing `@inheritdoc` on override functions
In Solidity, using `@inheritdoc` on overridden functions is crucial for maintaining comprehensive and understandable NatSpec documentation. It ensures that when a function overrides an external interface or contract function, the original documentation is preserved. This not only helps developers understand the purpose and usage of the function but also aids in keeping documentation consistent and accurate across different versions of the codebase. Neglecting to use `@inheritdoc` can lead to incomplete or confusing documentation, making code maintenance and usage more challenging.

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

```
([323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345))
```solidity
File: contracts/SemiFungiblePositionManager.sol

540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

```
([540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572))
### <a name="NC-57"></a>[NC-57] Natspec `@notice` is missing from abstract contract

*There are 2 Instances of this issue* :
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
### <a name="NC-58"></a>[NC-58] NatSpec: Contract declarations should have `@dev` tags

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
### <a name="NC-59"></a>[NC-59] NatSpec: Interface declarations should have `@author` tags

*There are 1 Instance of this issue* :
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
### <a name="NC-60"></a>[NC-60] NatSpec: Interface declarations should have `@dev` tags

*There are 1 Instance of this issue* :
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
### <a name="NC-61"></a>[NC-61] NatSpec: Interface declarations should have `@notice` tags

*There are 2 Instances of this issue* :
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
### <a name="NC-62"></a>[NC-62] NatSpec: Interface declarations should have `@title` tags

*There are 1 Instance of this issue* :
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
### <a name="NC-63"></a>[NC-63] NatSpec: Library declarations should have `@dev` tags

*There are 8 Instances of this issue* :
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L12))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L7))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L7))
```solidity
File: contracts/libraries/Math.sol

13: library Math {

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L13))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L17))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L52))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L60))
### <a name="NC-64"></a>[NC-64] NatSpec: Library declarations should have `@notice` tags

*There are 1 Instance of this issue* :
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
### <a name="NC-65"></a>[NC-65] NatSpec: Library declarations should have `@title` tags

*There are 1 Instance of this issue* :
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L11))
### <a name="NC-66"></a>[NC-66] NatSpec: Constructor missing NatSpec `@dev` tag

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

178:     constructor(
             uint256 _commissionFee,
             uint256 _sellerCollateralRatio,
             uint256 _buyerCollateralRatio,
             int256 _forceExerciseCost,
             uint256 _targetPoolUtilization,
             uint256 _saturatedPoolUtilization,
             uint256 _ITMSpreadMultiplier
         ) {

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L178-L186))
```solidity
File: contracts/PanopticFactory.sol

115:     constructor(
             address _WETH9,
             SemiFungiblePositionManager _SFPM,
             IUniswapV3Factory _univ3Factory,
             IDonorNFT _donorNFT,
             address _poolReference,
             address _collateralReference
         ) {

```
([115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L115-L122))
```solidity
File: contracts/PanopticPool.sol

280:     constructor(SemiFungiblePositionManager _sfpm) {

```
([280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L280-L280))
```solidity
File: contracts/SemiFungiblePositionManager.sol

341:     constructor(IUniswapV3Factory _factory) {

```
([341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L341-L341))
### <a name="NC-67"></a>[NC-67] NatSpec: Constructor missing NatSpec `@notice` tag

*There are 1 Instance of this issue* :
```solidity
File: contracts/CollateralTracker.sol

178:     constructor(
             uint256 _commissionFee,
             uint256 _sellerCollateralRatio,
             uint256 _buyerCollateralRatio,
             int256 _forceExerciseCost,
             uint256 _targetPoolUtilization,
             uint256 _saturatedPoolUtilization,
             uint256 _ITMSpreadMultiplier
         ) {

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L178-L186))
### <a name="NC-68"></a>[NC-68] NatSpec: Constructor missing NatSpec `@param` tag

*There are 1 Instance of this issue* :
```solidity
File: contracts/CollateralTracker.sol

178:     constructor(
             uint256 _commissionFee,
             uint256 _sellerCollateralRatio,
             uint256 _buyerCollateralRatio,
             int256 _forceExerciseCost,
             uint256 _targetPoolUtilization,
             uint256 _saturatedPoolUtilization,
             uint256 _ITMSpreadMultiplier
         ) {

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L178-L186))
### <a name="NC-69"></a>[NC-69] NatSpec: Error missing NatSpec `@dev` tag

*There are 33 Instances of this issue* :
```solidity
File: contracts/libraries/Errors.sol

13:     error CollateralTokenAlreadyInitialized();

16:     error DepositTooLarge();

20:     error EffectiveLiquidityAboveThreshold();

23:     error ExceedsMaximumRedemption();

26:     error ExerciseeNotSolvent();

29:     error InputListFail();

32:     error InvalidSalt();

35:     error InvalidTick();

38:     error InvalidNotionalValue();

42:     error InvalidTokenIdParameter(uint256 parameterType);

45:     error InvalidUniswapCallback();

48:     error LeftRightInputError();

51:     error NoLegsExercisable();

54:     error NotEnoughCollateral();

57:     error PositionTooLarge();

60:     error NotALongLeg();

63:     error NotEnoughLiquidity();

66:     error NotMarginCalled();

73:     error NotPanopticPool();

76:     error OptionsBalanceZero();

79:     error PoolAlreadyInitialized();

82:     error PositionAlreadyMinted();

85:     error PositionCountNotZero();

88:     error PriceBoundFail();

91:     error ReentrantCall();

95:     error StaleTWAP();

98:     error TooManyPositionsOpen();

101:     error TransferFailed();

105:     error TicksNotInitializable();

108:     error UnderOverFlow();

111:     error UniswapPoolNotInitialized();

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L13-L13),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L16-L16),[20](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L20-L20),[23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L23-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L26-L26),[29](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L29-L29),[32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L32-L32),[35](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L35-L35),[38](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L38-L38),[42](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L42-L42),[45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L45-L45),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L48-L48),[51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L51-L51),[54](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L54-L54),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L57-L57),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L60-L60),[63](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L63-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L66-L66),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L73-L73),[76](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L76-L76),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L79-L79),[82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L82-L82),[85](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L85-L85),[88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L88-L88),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L91-L91),[95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L95-L95),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L98-L98),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L101-L101),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L105-L105),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L108-L108),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L111-L111))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

55:     error NotAuthorized();

58:     error UnsafeRecipient();

```
([55](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L55-L55),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L58-L58))
### <a name="NC-70"></a>[NC-70] NatSpec: Event missing NatSpec `@dev` tag

*There are 11 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

49:     event Deposit(address indexed sender, address indexed owner, uint256 assets, uint256 shares);

57:     event Withdraw(
            address indexed sender,
            address indexed receiver,
            address indexed owner,
            uint256 assets,
            uint256 shares
        );

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L57-L63))
```solidity
File: contracts/PanopticFactory.sol

34:     event OwnershipTransferred(address indexed oldOwner, address indexed newOwner);

43:     event PoolDeployed(
            PanopticPool indexed poolAddress,
            IUniswapV3Pool indexed uniswapPool,
            CollateralTracker collateralTracker0,
            CollateralTracker collateralTracker1,
            uint256 amount0,
            uint256 amount1
        );

```
([34](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L34-L34),[43](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L43-L50))
```solidity
File: contracts/PanopticPool.sol

62:     event PremiumSettled(
            address indexed user,
            TokenId indexed tokenId,
            LeftRightSigned settledAmounts
        );

```
([62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L62-L66))
```solidity
File: contracts/SemiFungiblePositionManager.sol

80:     event PoolInitialized(address indexed uniswapPool, uint64 poolId);

```
([80](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L80-L80))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

22:     event TransferSingle(
            address indexed operator,
            address indexed from,
            address indexed to,
            uint256 id,
            uint256 amount
        );

36:     event TransferBatch(
            address indexed operator,
            address indexed from,
            address indexed to,
            uint256[] ids,
            uint256[] amounts
        );

48:     event ApprovalForAll(address indexed owner, address indexed operator, bool approved);

```
([22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L22-L28),[36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L36-L42),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L48-L48))
```solidity
File: contracts/tokens/ERC20Minimal.sol

18:     event Transfer(address indexed from, address indexed to, uint256 amount);

24:     event Approval(address indexed owner, address indexed spender, uint256 amount);

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L18-L18),[24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L24-L24))
### <a name="NC-71"></a>[NC-71] NatSpec: Functions missing NatSpec `@dev` tag

*There are 140 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

289:     function name() external view returns (string memory) {

303:     function symbol() external view returns (string memory) {

310:     function decimals() external view returns (uint8) {

361:     function asset() external view returns (address assetTokenAddress) {

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {

444:     function maxMint(address) external view returns (uint256 maxShares) {

453:     function previewMint(uint256 shares) public view returns (uint256 assets) {

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {

591:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) external returns (uint256 assets) {

911:     function revoke(
             address delegator,
             address delegatee,
             uint256 assets
         ) external onlyPanopticPool {

995:     function takeCommissionAddData(
             address optionOwner,
             int128 longAmount,
             int128 shortAmount,
             int128 swappedAmount
         ) external onlyPanopticPool returns (int256 utilization) {

1096:     function _getExchangedAmount(
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount
          ) internal view returns (int256 exchangedAmount) {

1245:     function _getRequiredCollateralAtTickSinglePosition(
              TokenId tokenId,
              uint128 positionSize,
              int24 atTick,
              uint128 poolUtilization
          ) internal view returns (uint256 tokenRequired) {

```
([289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L289-L289),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L303-L303),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L310-L310),[361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L361-L361),[379](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L379-L379),[386](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L386-L386),[392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[399](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L399-L399),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444),[453](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L453-L453),[518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L518-L518),[572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L572-L572),[581](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L581-L581),[591](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L591-L595),[911](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L911-L915),[995](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L995-L1000),[1096](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1096-L1100),[1245](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1245-L1250))
```solidity
File: contracts/PanopticFactory.sol

134:     function initialize(address _owner) public {

147:     function transferOwnership(address newOwner) external {

159:     function owner() external view returns (address) {

335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L134-L134),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L147-L147),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L159-L159),[335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

352:     function optionPositionBalance(
             address user,
             TokenId tokenId
         ) external view returns (uint128 balance, uint64 poolUtilization0, uint64 poolUtilization1) {

429:     function _calculateAccumulatedPremia(
             address user,
             TokenId[] calldata positionIdList,
             bool computeAllPremia,
             bool includePendingPremium,
             int24 atTick
         ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

499:     function _getSlippageLimits(
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal pure returns (int24, int24) {

522:     function pokeMedian() external {

547:     function mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) external {

614:     function _mintOptions(
             TokenId[] calldata positionIdList,
             uint128 positionSize,
             uint64 effectiveLiquidityLimitX32,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal {

794:     function _burnAllOptionsFrom(
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool commitLongSettled,
             TokenId[] calldata positionIdList
         ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {

826:     function _burnOptions(
             bool commitLongSettled,
             TokenId tokenId,
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (LeftRightSigned paidAmounts, LeftRightSigned[4] memory premiaByLeg) {

859:     function _updatePositionDataBurn(address owner, TokenId tokenId) internal {

955:     function _burnAndHandleExercise(
             bool commitLongSettled,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             TokenId tokenId,
             uint128 positionSize,
             address owner
         )
             internal
             returns (
                 LeftRightSigned realizedPremia,
                 LeftRightSigned[4] memory premiaByLeg,
                 LeftRightSigned paidAmounts
             )
         {

1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

1339:     function _getSolvencyBalances(
              LeftRightUnsigned tokenData0,
              LeftRightUnsigned tokenData1,
              uint160 sqrtPriceX96
          ) internal pure returns (uint256 balanceCross, uint256 thresholdCross) {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {

1437:     function collateralToken1() external view returns (CollateralTracker) {

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {

1450:     function getUniV3TWAP() internal view returns (int24 twapTick) {

1465:     function _checkLiquiditySpread(
              TokenId tokenId,
              uint256 leg,
              int24 tickLower,
              int24 tickUpper,
              uint64 effectiveLiquidityLimitX32
          ) internal view {

1503:     function _getPremia(
              TokenId tokenId,
              uint128 positionSize,
              address owner,
              bool computeAllPremia,
              int24 atTick
          )
              internal
              view
              returns (
                  LeftRightSigned[4] memory premiaByLeg,
                  uint256[2][4] memory premiumAccumulatorsByLeg
              )
          {

```
([352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L352-L355),[429](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L429-L435),[499](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L499-L502),[522](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L522-L522),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L547-L553),[614](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L614-L620),[794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L794-L800),[826](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L826-L832),[859](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L859-L859),[955](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L955-L969),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1339-L1343),[1425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1425-L1425),[1431](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1431-L1431),[1437](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1437-L1437),[1444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1444-L1444),[1450](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1450-L1450),[1465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1465-L1471),[1503](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1503-L1516))
```solidity
File: contracts/SemiFungiblePositionManager.sol

330:     function endReentrancyLock(uint64 poolId) internal {

504:     function mintTokenizedPosition(
             TokenId tokenId,
             uint128 positionSize,
             int24 slippageTickLimitLow,
             int24 slippageTickLimitHigh
         )
             external
             ReentrancyLock(tokenId.poolId())
             returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
         {

680:     function _validateAndForwardToAMM(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool isBurn
         ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {

756:     function swapInAMM(
             IUniswapV3Pool univ3pool,
             LeftRightSigned itmAmounts
         ) internal returns (LeftRightSigned totalSwapped) {

1110:     function _updateStoredPremia(
              bytes32 positionKey,
              LeftRightUnsigned currentLiquidity,
              LeftRightUnsigned collectedAmounts
          ) private {

1255:     function _collectAndWritePositionData(
              LiquidityChunk liquidityChunk,
              IUniswapV3Pool univ3pool,
              LeftRightUnsigned currentLiquidity,
              bytes32 positionKey,
              LeftRightSigned movedInLeg,
              uint256 isLong
          ) internal returns (LeftRightUnsigned collectedChunk) {

```
([330](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L330-L330),[504](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L504-L513),[680](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L680-L686),[756](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L756-L759),[1110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1110-L1114),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1255-L1262))
```solidity
File: contracts/libraries/CallbackLib.sol

30:     function validateCallback(
            address sender,
            IUniswapV3Factory factory,
            PoolFeatures memory features
        ) internal view {

```
([30](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L30-L34))
```solidity
File: contracts/libraries/FeesCalc.sol

46:     function getPortfolioValue(
            int24 atTick,
            mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
            TokenId[] calldata positionIdList
        ) external view returns (int256 value0, int256 value1) {

```
([46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L46-L50))
```solidity
File: contracts/libraries/InteractionHelper.sol

24:     function doApprovals(
            SemiFungiblePositionManager sfpm,
            CollateralTracker ct0,
            CollateralTracker ct1,
            address token0,
            address token1
        ) external {

91:     function computeSymbol(
            address token,
            string memory prefix
        ) external view returns (string memory) {

107:     function computeDecimals(address token) external view returns (uint8) {

```
([24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L24-L30),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L91-L94),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L107-L107))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

221:     function getAmountsForLiquidity(
             int24 currentTick,
             LiquidityChunk liquidityChunk
         ) internal pure returns (uint256 amount0, uint256 amount1) {

296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {

318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

440:     function mulDivRoundingUp(
             uint256 a,
             uint256 b,
             uint256 denominator
         ) internal pure returns (uint256 result) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L91-L91),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L207-L207),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L221-L224),[296](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L296-L296),[302](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L302-L302),[311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L311-L311),[318](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L318-L318),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L325-L325),[440](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L440-L444),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L584-L584),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[661](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L661-L661),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L738),[753](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L753-L753),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

75:     function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {

289:     function getLiquidityChunk(
             TokenId tokenId,
             uint256 legIndex,
             uint128 positionSize
         ) internal pure returns (LiquidityChunk) {

338:     function getTicks(
             int24 strike,
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24 tickLower, int24 tickUpper) {

390:     function computeExercisedAmounts(
             TokenId tokenId,
             uint128 positionSize
         ) internal pure returns (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) {

419:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             uint160 sqrtPriceX96
         ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             int24 tick
         ) internal pure returns (uint256, uint256) {

574:     function getAmountsMoved(
             TokenId tokenId,
             uint128 positionSize,
             uint256 legIndex
         ) internal pure returns (LeftRightUnsigned) {

607:     function _calculateIOAmounts(
             TokenId tokenId,
             uint128 positionSize,
             uint256 legIndex
         ) internal pure returns (LeftRightSigned longs, LeftRightSigned shorts) {

651:     function getLiquidationBonus(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint160 sqrtPriceX96Twap,
             uint160 sqrtPriceX96Final,
             LeftRightSigned netExchanged,
             LeftRightSigned premia
         ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

917:     function getRefundAmounts(
             address refunder,
             LeftRightSigned refundValues,
             int24 atTick,
             CollateralTracker collateral0,
             CollateralTracker collateral1
         ) external view returns (LeftRightSigned) {

```
([59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L59-L59),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L75-L75),[289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L289-L293),[338](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L338-L342),[390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L390-L393),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L419-L424),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L445-L450),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L574-L578),[607](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L607-L611),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L651-L658),[917](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L917-L923))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

52:     function safeTransfer(address token, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L52))
```solidity
File: contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L12-L12))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {

214:     function _mint(address to, uint256 id, uint256 amount) internal {

236:     function _burn(address from, uint256 id, uint256 amount) internal {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81),[200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L200-L200),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L214),[236](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L236-L236))
```solidity
File: contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

103:     function _transferFrom(address from, address to, uint256 amount) internal {

122:     function _mint(address to, uint256 amount) internal {

136:     function _burn(address from, uint256 amount) internal {

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L103),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L122),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L136-L136))
```solidity
File: contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

59:     function toRightSlot(
            LeftRightUnsigned self,
            uint128 right
        ) internal pure returns (LeftRightUnsigned) {

78:     function toRightSlot(
            LeftRightSigned self,
            int128 right
        ) internal pure returns (LeftRightSigned) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

121:     function toLeftSlot(
             LeftRightUnsigned self,
             uint128 left
         ) internal pure returns (LeftRightUnsigned) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

148:     function add(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

171:     function sub(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

251:     function subRect(
             LeftRightSigned x,
             LeftRightSigned y
         ) internal pure returns (LeftRightSigned z) {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L39),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L46),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L59-L62),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L78-L81),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L101),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L108),[121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L121-L124),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L134),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L148-L151),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L171-L174),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L194),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L214),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L232),[251](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L251-L254))
```solidity
File: contracts/types/LiquidityChunk.sol

70:     function createChunk(
            int24 _tickLower,
            int24 _tickUpper,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

89:     function addLiquidity(
            LiquidityChunk self,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

102:     function addTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

118:     function addTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

135:     function updateTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

151:     function updateTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L70-L74),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L89-L92),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L102-L105),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L118-L121),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L135-L138),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L151-L154),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L171),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L180),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

221:     function addOptionRatio(
             TokenId self,
             uint256 _optionRatio,
             uint256 legIndex
         ) internal pure returns (TokenId) {

240:     function addIsLong(
             TokenId self,
             uint256 _isLong,
             uint256 legIndex
         ) internal pure returns (TokenId) {

255:     function addTokenType(
             TokenId self,
             uint256 _tokenType,
             uint256 legIndex
         ) internal pure returns (TokenId) {

273:     function addRiskPartner(
             TokenId self,
             uint256 _riskPartner,
             uint256 legIndex
         ) internal pure returns (TokenId) {

291:     function addStrike(
             TokenId self,
             int24 _strike,
             uint256 legIndex
         ) internal pure returns (TokenId) {

310:     function addWidth(
             TokenId self,
             int24 _width,
             uint256 legIndex
         ) internal pure returns (TokenId) {

336:     function addLeg(
             TokenId self,
             uint256 legIndex,
             uint256 _optionRatio,
             uint256 _asset,
             uint256 _isLong,
             uint256 _tokenType,
             uint256 _riskPartner,
             int24 _strike,
             int24 _width
         ) internal pure returns (TokenId tokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

```
([87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L87),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L96),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L118),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L128),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L148),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L183),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L193),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L221-L225),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L240-L244),[255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L255-L259),[273](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L273-L277),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L291-L295),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L310-L314),[336](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L336-L346),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L404))
### <a name="NC-72"></a>[NC-72] NatSpec: Functions missing NatSpec `@notice` tag

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

```
([323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345))
### <a name="NC-73"></a>[NC-73] NatSpec: Functions missing NatSpec `@param` tag

*There are 5 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

444:     function maxMint(address) external view returns (uint256 maxShares) {

```
([323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345),[392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444))
```solidity
File: contracts/libraries/Math.sol

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

```
([302](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L302-L302))
### <a name="NC-74"></a>[NC-74] NatSpec: Functions missing NatSpec `@return` tag

*There are 8 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

```
([323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345))
```solidity
File: contracts/PanopticPool.sol

794:     function _burnAllOptionsFrom(
             address owner,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             bool commitLongSettled,
             TokenId[] calldata positionIdList
         ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {

955:     function _burnAndHandleExercise(
             bool commitLongSettled,
             int24 tickLimitLow,
             int24 tickLimitHigh,
             TokenId tokenId,
             uint128 positionSize,
             address owner
         )
             internal
             returns (
                 LeftRightSigned realizedPremia,
                 LeftRightSigned[4] memory premiaByLeg,
                 LeftRightSigned paidAmounts
             )
         {

1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

1503:     function _getPremia(
              TokenId tokenId,
              uint128 positionSize,
              address owner,
              bool computeAllPremia,
              int24 atTick
          )
              internal
              view
              returns (
                  LeftRightSigned[4] memory premiaByLeg,
                  uint256[2][4] memory premiumAccumulatorsByLeg
              )
          {

1802:     function _getTotalLiquidity(
              TokenId tokenId,
              uint256 leg
          ) internal view returns (uint256 totalLiquidity) {

```
([794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L794-L800),[955](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L955-L969),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1503](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1503-L1516),[1802](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1802-L1805))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1138:     function _getFeesBase(
              IUniswapV3Pool univ3pool,
              uint128 liquidity,
              LiquidityChunk liquidityChunk,
              bool roundUp
          ) private view returns (LeftRightSigned feesBase) {

```
([1138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1138-L1143))
### <a name="NC-75"></a>[NC-75] Incomplete NatSpec: `@param` from function declarations
Add a `@param` notation for all parameters to describe the function and improve the code documentation.

*There are 1 Instance of this issue* :
```solidity
File: contracts/PanopticPool.sol

429:     function _calculateAccumulatedPremia(
             address user,
             TokenId[] calldata positionIdList,
             bool computeAllPremia,
             bool includePendingPremium,
             int24 atTick
         ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

```
([429](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L429-L435))
### <a name="NC-76"></a>[NC-76] NatSpec: Modifier missing NatSpec `@dev` tag

*There are 1 Instance of this issue* :
```solidity
File: contracts/CollateralTracker.sol

169:     modifier onlyPanopticPool() {
             if (msg.sender != address(s_panopticPool)) revert Errors.NotPanopticPool();
             _;
         }

```
([169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L169-L172))
### <a name="NC-77"></a>[NC-77] Immutable and constant state variables should not be casted
The definition of a constant or immutable variable is that they do not change, casting such variables can potentially push more than one 'value' to a constant, for example a uin128 constant can have its original value and that of when it's casted to uint64 (i.e it has some bytes truncated). This can create confusion and inconsistencies within the code which can inadvertently increase the attack surface of the project. It is thus advise to either change the uint byte size in the constant/immutable definition of the variable or introduce a second state variable to cover the differing casts that are expected such as having a uint128 constant and a separate uint64 constant.

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit DECIMALS_128
730:             exerciseFees = exerciseFees
                     .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))
                     .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

```
([730](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L730-L732))
```solidity
File: contracts/PanopticPool.sol

// @audit MAX_SPREAD
770:                 _checkLiquiditySpread(
                         tokenId,
                         leg,
                         tickLower,
                         tickUpper,
                         uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))
                     );

```
([770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L770-L776))
### <a name="NC-78"></a>[NC-78] Use recent version of solidity
Use a more [recent version](https://github.com/ethereum/solc-js/tags) of Solidity; it's safer to use newer versions to get the latest bugfixes and features when deploying on L2.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L2-L2))
```solidity
File: contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L2-L2))
```solidity
File: contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L2-L2))
```solidity
File: contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L2-L2))
```solidity
File: contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L2-L2))
```solidity
File: contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L2-L2))
```solidity
File: contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L2-L2))
```solidity
File: contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L2-L2))
```solidity
File: contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L2-L2))
```solidity
File: contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L2-L2))
```solidity
File: contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L2-L2))
```solidity
File: contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L2-L2))
```solidity
File: contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L2-L2))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L2-L2))
```solidity
File: contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L2-L2))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L2-L2))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L2-L2))
```solidity
File: contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L2-L2))
```solidity
File: contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L2-L2))
```solidity
File: contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;

```
([2](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L2-L2))
### <a name="NC-79"></a>[NC-79] Use of `override` is unnecessary
Starting with Solidity version [0.8.8](https://docs.soliditylang.org/en/v0.8.20/contracts.html#function-overriding), using the override keyword when the function solely overrides an interface function, and the function doesn't exist in multiple base contracts, is unnecessary.

*There are 4 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

```
([323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345))
```solidity
File: contracts/SemiFungiblePositionManager.sol

540:     function safeTransferFrom(
             address from,
             address to,
             uint256 id,
             uint256 amount,
             bytes calldata data
         ) public override {

566:     function safeBatchTransferFrom(
             address from,
             address to,
             uint256[] calldata ids,
             uint256[] calldata amounts,
             bytes calldata data
         ) public override {

```
([540](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L540-L546),[566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L566-L572))
### <a name="NC-80"></a>[NC-80] Possible rounding issue
Division by large numbers may result in the result being zero, due to solidity not supporting fractions. Consider requiring a minimum amount for the numerator to ensure that it is always larger than the denominator. Also, there is indication of multiplication and division without the use of parenthesis which could result in issues.

*There are 6 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

743:             return int256((s_inAMM * DECIMALS) / totalAssets());

```
([743](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L743-L743))
```solidity
File: contracts/PanopticPool.sol

1732:                                     totalLiquidityBefore) / (totalLiquidity)

1740:                                     totalLiquidityBefore) / (totalLiquidity)

1945:                                         ) / totalLiquidity

1962:                                         ) / totalLiquidity

```
([1732](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1732-L1732),[1740](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1740-L1740),[1945](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1945-L1945),[1962](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1962-L1962))
```solidity
File: contracts/libraries/PanopticMath.sol

678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);

```
([678](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L678-L678))
### <a name="NC-81"></a>[NC-81] Functions which are either `private` or `internal` should have a preceding _ in their name
Add a preceding underscore to the function name, take care to refactor where there functions are called

*There are 104 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

1450:     function getUniV3TWAP() internal view returns (int24 twapTick) {

```
([1450](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1450-L1450))
```solidity
File: contracts/SemiFungiblePositionManager.sol

320:     function beginReentrancyLock(uint64 poolId) internal {

330:     function endReentrancyLock(uint64 poolId) internal {

593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

756:     function swapInAMM(
             IUniswapV3Pool univ3pool,
             LeftRightSigned itmAmounts
         ) internal returns (LeftRightSigned totalSwapped) {

```
([320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L320-L320),[330](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L330-L330),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L593-L593),[756](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L756-L759))
```solidity
File: contracts/libraries/CallbackLib.sol

30:     function validateCallback(
            address sender,
            IUniswapV3Factory factory,
            PoolFeatures memory features
        ) internal view {

```
([30](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L30-L34))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

221:     function getAmountsForLiquidity(
             int24 currentTick,
             LiquidityChunk liquidityChunk
         ) internal pure returns (uint256 amount0, uint256 amount1) {

241:     function getLiquidityForAmount0(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount0
         ) internal pure returns (LiquidityChunk) {

271:     function getLiquidityForAmount1(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount1
         ) internal pure returns (LiquidityChunk) {

296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {

318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

340:     function mulDiv(
             uint256 a,
             uint256 b,
             uint256 denominator
         ) internal pure returns (uint256 result) {

440:     function mulDivRoundingUp(
             uint256 a,
             uint256 b,
             uint256 denominator
         ) internal pure returns (uint256 result) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L73),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L81-L81),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L91-L91),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L128-L128),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L191-L191),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L207-L207),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L221-L224),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L241-L245),[271](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L271-L275),[296](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L296-L296),[302](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L302-L302),[311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L311-L311),[318](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L318-L318),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L325-L325),[340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L340-L344),[440](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L440-L444),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L584-L584),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[661](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L661-L661),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L738),[753](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L753-L753),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

92:     function updatePositionsHash(
            uint256 existingHash,
            TokenId tokenId,
            bool addFlag
        ) internal pure returns (uint256) {

289:     function getLiquidityChunk(
             TokenId tokenId,
             uint256 legIndex,
             uint128 positionSize
         ) internal pure returns (LiquidityChunk) {

338:     function getTicks(
             int24 strike,
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24 tickLower, int24 tickUpper) {

371:     function getRangesFromStrike(
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24, int24) {

390:     function computeExercisedAmounts(
             TokenId tokenId,
             uint128 positionSize
         ) internal pure returns (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) {

419:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             uint160 sqrtPriceX96
         ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             int24 tick
         ) internal pure returns (uint256, uint256) {

468:     function convertNotional(
             uint128 contractSize,
             int24 tickLower,
             int24 tickUpper,
             uint256 asset
         ) internal pure returns (uint128) {

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

574:     function getAmountsMoved(
             TokenId tokenId,
             uint128 positionSize,
             uint256 legIndex
         ) internal pure returns (LeftRightUnsigned) {

```
([47](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L47-L47),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L59-L59),[92](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L92-L96),[289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L289-L293),[338](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L338-L342),[371](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L371-L374),[390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L390-L393),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L419-L424),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L445-L450),[468](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L468-L473),[490](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L490-L490),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L507-L507),[524](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L524-L524),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L547-L547),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L574-L578))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

52:     function safeTransfer(address token, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L52))
```solidity
File: contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

59:     function toRightSlot(
            LeftRightUnsigned self,
            uint128 right
        ) internal pure returns (LeftRightUnsigned) {

78:     function toRightSlot(
            LeftRightSigned self,
            int128 right
        ) internal pure returns (LeftRightSigned) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

121:     function toLeftSlot(
             LeftRightUnsigned self,
             uint128 left
         ) internal pure returns (LeftRightUnsigned) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

148:     function add(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

171:     function sub(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

251:     function subRect(
             LeftRightSigned x,
             LeftRightSigned y
         ) internal pure returns (LeftRightSigned z) {

279:     function addCapped(
             LeftRightUnsigned x,
             LeftRightUnsigned dx,
             LeftRightUnsigned y,
             LeftRightUnsigned dy
         ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L39),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L46),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L59-L62),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L78-L81),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L101),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L108),[121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L121-L124),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L134),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L148-L151),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L171-L174),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L194),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L214),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L232),[251](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L251-L254),[279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L279-L284))
```solidity
File: contracts/types/LiquidityChunk.sol

70:     function createChunk(
            int24 _tickLower,
            int24 _tickUpper,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

89:     function addLiquidity(
            LiquidityChunk self,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

102:     function addTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

118:     function addTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

135:     function updateTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

151:     function updateTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L70-L74),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L89-L92),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L102-L105),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L118-L121),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L135-L138),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L151-L154),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L171),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L180),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

205:     function addAsset(
             TokenId self,
             uint256 _asset,
             uint256 legIndex
         ) internal pure returns (TokenId) {

221:     function addOptionRatio(
             TokenId self,
             uint256 _optionRatio,
             uint256 legIndex
         ) internal pure returns (TokenId) {

240:     function addIsLong(
             TokenId self,
             uint256 _isLong,
             uint256 legIndex
         ) internal pure returns (TokenId) {

255:     function addTokenType(
             TokenId self,
             uint256 _tokenType,
             uint256 legIndex
         ) internal pure returns (TokenId) {

273:     function addRiskPartner(
             TokenId self,
             uint256 _riskPartner,
             uint256 legIndex
         ) internal pure returns (TokenId) {

291:     function addStrike(
             TokenId self,
             int24 _strike,
             uint256 legIndex
         ) internal pure returns (TokenId) {

310:     function addWidth(
             TokenId self,
             int24 _width,
             uint256 legIndex
         ) internal pure returns (TokenId) {

336:     function addLeg(
             TokenId self,
             uint256 legIndex,
             uint256 _optionRatio,
             uint256 _asset,
             uint256 _isLong,
             uint256 _tokenType,
             uint256 _riskPartner,
             int24 _strike,
             int24 _width
         ) internal pure returns (TokenId tokenId) {

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

416:     function asTicks(
             TokenId self,
             uint256 legIndex
         ) internal pure returns (int24 legLowerTick, int24 legUpperTick) {

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

500:     function validate(TokenId self) internal pure {

578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {

```
([87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L87),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L96),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L108),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L118),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L128),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L148),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L169),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L183),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L193),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L205-L209),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L221-L225),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L240-L244),[255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L255-L259),[273](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L273-L277),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L291-L295),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L310-L314),[336](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L336-L346),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L366-L366),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L404),[416](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L416-L419),[432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L432-L432),[464](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L464-L464),[500](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L500-L500),[578](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L578-L578))
### <a name="NC-82"></a>[NC-82] Consider making `private` state variables `internal` to increase flexibility
In Solidity, `private` state variables are strictly confined to the contract they are defined in and can't be accessed or modified by its derived contracts. While this offers strong encapsulation, it can limit contract extensibility and modification in inheritance chains. On the other hand, `internal` variables can be accessed and potentially overridden by child contracts, granting more flexibility in contract development and upgrades. Therefore, it's recommended to use `private` only when you explicitly want to prevent child contract access. Otherwise, prefer `internal` to maintain a balance between encapsulation and the flexibility offered by inheritance patterns in Solidity.

*There are 1 Instance of this issue* :
```solidity
File: contracts/SemiFungiblePositionManager.sol

133:     uint128 private constant VEGOID = 2;

```
([133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L133-L133))
### <a name="NC-83"></a>[NC-83] Public variable declarations should have NatSpec descriptions
Public variable declarations in smart contracts should ideally be accompanied by NatSpec comments to enhance code readability and provide clear documentation. NatSpec (Natural Language Specification) is a standard for writing comments in Ethereum smart contracts that can generate user-friendly documentation, improving the transparency of the contract's functionality. This is particularly crucial for public variables, as they are accessible externally, and understanding their role and impact is vital for both developers and users interacting with the contract

*There are 5 Instances of this issue* :
```solidity
File: contracts/tokens/ERC1155Minimal.sol

66:     mapping(address account => mapping(uint256 tokenId => uint256 balance)) public balanceOf;

71:     mapping(address owner => mapping(address operator => bool approvedForAll))
            public isApprovedForAll;

```
([66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L66-L66),[71](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L71-L72))
```solidity
File: contracts/tokens/ERC20Minimal.sol

32:     uint256 public totalSupply;

35:     mapping(address account => uint256 balance) public balanceOf;

39:     mapping(address owner => mapping(address spender => uint256 allowance)) public allowance;

```
([32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L32-L32),[35](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L35-L35),[39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L39-L39))
### <a name="NC-84"></a>[NC-84] Adding a `return` statement when the function defines a named return variable, is redundant

*There are 37 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

362:         return s_underlyingToken;

372:             return s_poolAssets + s_inAMM;

380:         return Math.mulDiv(assets, totalSupply, totalAssets());

387:         return Math.mulDiv(shares, totalAssets(), totalSupply);

393:         return type(uint104).max;

446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);

512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

521:         return Math.mulDivRoundingUp(assets, supply, totalAssets());

565:         return shares;

575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

582:         return convertToAssets(shares);

625:         return assets;

743:             return int256((s_inAMM * DECIMALS) / totalAssets());

785:             return min_sell_ratio;

791:             return DECIMALS;

795:             return
                     min_sell_ratio +
                     ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /
                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL);

836:             return BUYER_COLLATERAL_RATIO;

843:                 return BUYER_COLLATERAL_RATIO / 2;

848:             return
                     (BUYER_COLLATERAL_RATIO +
                         (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
                         (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

1192:         return tokenData;

1235:         return tokenRequired;

1285:         return
                  tokenId.riskPartner(index) == index // does this leg have a risk partner? Affects required collateral
                      ? _getRequiredCollateralSingleLegNoPartner(
                          tokenId,
                          index,
                          positionSize,
                          atTick,
                          poolUtilization
                      )
                      : _getRequiredCollateralSingleLegPartner(
                          tokenId,
                          index,
                          positionSize,
                          atTick,
                          poolUtilization
                      );

1640:             return
                      strangleRequired = _getRequiredCollateralSingleLegNoPartner(
                          tokenId,
                          index,
                          positionSize,
                          atTick,
                          poolUtilization
                      );

```
([362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L362-L362),[372](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L372-L372),[380](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L380-L380),[387](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L387-L387),[393](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L393-L393),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L446-L446),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L512-L512),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L521-L521),[565](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L565-L565),[575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L575-L575),[582](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L582-L582),[625](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L625-L625),[743](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L743-L743),[785](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L785-L785),[791](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L791-L791),[795](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L795-L798),[836](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L836-L836),[843](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L843-L843),[848](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L848-L851),[1192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1192-L1192),[1235](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1235-L1235),[1285](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1285-L1300),[1640](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1640-L1647))
```solidity
File: contracts/PanopticPool.sol

399:         return (premia.rightSlot(), premia.leftSlot(), balances);

399:         return (premia.rightSlot(), premia.leftSlot(), balances);

491:         return (portfolioPremium, balances);

491:         return (portfolioPremium, balances);

1432:         return s_collateralToken0;

```
([399](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L399-L399),[399](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L399-L399),[491](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L491-L491),[491](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L491-L491),[1432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1432-L1432))
```solidity
File: contracts/SemiFungiblePositionManager.sol

833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

1558:         return s_poolContext[poolId].pool;

```
([833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L833-L833),[1558](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1558-L1558))
```solidity
File: contracts/libraries/Math.sol

365:                 return result;

```
([365](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L365-L365))
```solidity
File: contracts/libraries/PanopticMath.sol

746:             return (
                     bonus0,
                     bonus1,
                     LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(
                         int128(balance1 - paid1)
                     )
                 );

746:             return (
                     bonus0,
                     bonus1,
                     LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(
                         int128(balance1 - paid1)
                     )
                 );

```
([746](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L746-L752),[746](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L746-L752))
```solidity
File: contracts/types/LeftRight.sol

206:             return z.toRightSlot(right128).toLeftSlot(left128);

224:             return z.toRightSlot(right128).toLeftSlot(left128);

242:             return z.toRightSlot(right128).toLeftSlot(left128);

264:             return
                     z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(
                         int128(Math.max(left128, 0))
                     );

```
([206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L206-L206),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L224-L224),[242](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L242-L242),[264](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L264-L267))
### <a name="NC-85"></a>[NC-85] Say Goodbye to Unchecked Loop Increments: Solidity `0.8.22` Enhances For Loop Safety
Solidity [0.8.22](https://soliditylang.org/blog/2023/10/25/solidity-0.8.22-release-announcement/) introduces an overflow check optimization that automatically generates an unchecked arithmetic increment of the counter of for loops. This new optimization removes the need for poor unchecked increment patterns in for loop bodies.

*There are 21 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

1230:             unchecked {
                      ++i;
                  }

```
([1230](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1230-L1232))
```solidity
File: contracts/PanopticPool.sol

482:                 unchecked {
                         ++leg;
                     }

487:             unchecked {
                     ++k;
                 }

778:             unchecked {
                     ++leg;
                 }

812:             unchecked {
                     ++i;
                 }

871:             unchecked {
                     ++leg;
                 }

1388:             unchecked {
                      ++i;
                  }

1539:                 unchecked {
                          LeftRightUnsigned premiumAccumulatorLast = s_options[owner][tokenId][leg];
      
                          // if the premium accumulatorLast is higher than current, it means the premium accumulator has overflowed and rolled over at least once
                          // we can account for one rollover by doing (acc_cur + (acc_max - acc_last))
                          // if there are multiple rollovers or the rollover goes past the last accumulator, rolled over fees will just remain unclaimed
                          premiaByLeg[leg] = LeftRightSigned
                              .wrap(0)
                              .toRightSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              )
                              .toLeftSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              );
      
                          if (isLong == 1) {
                              premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
                          }
                      }

1539:                 unchecked {
                          LeftRightUnsigned premiumAccumulatorLast = s_options[owner][tokenId][leg];
      
                          // if the premium accumulatorLast is higher than current, it means the premium accumulator has overflowed and rolled over at least once
                          // we can account for one rollover by doing (acc_cur + (acc_max - acc_last))
                          // if there are multiple rollovers or the rollover goes past the last accumulator, rolled over fees will just remain unclaimed
                          premiaByLeg[leg] = LeftRightSigned
                              .wrap(0)
                              .toRightSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              )
                              .toLeftSlot(
                                  int128(
                                      int256(
                                          ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64
                                      )
                                  )
                              );
      
                          if (isLong == 1) {
                              premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
                          }
                      }

1571:             unchecked {
                      ++leg;
                  }

1976:             unchecked {
                      ++leg;
                  }

```
([482](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L482-L484),[487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L487-L489),[778](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L778-L780),[812](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L812-L814),[871](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L871-L873),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1388-L1390),[1539](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1539-L1569),[1539](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1539-L1569),[1571](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1571-L1573),[1976](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1976-L1978))
```solidity
File: contracts/SemiFungiblePositionManager.sol

578:             unchecked {
                     ++i;
                 }

649:             unchecked {
                     ++leg;
                 }

895:                 unchecked {
                         // Reverse the order of the legs if this call is burning a position (LIFO)
                         // We loop in reverse order if burning a position so that any dependent long liquidity is returned to the pool first,
                         // allowing the corresponding short liquidity to be removed
                         _leg = _isBurn ? numLegs - leg - 1 : leg;
                     }

895:                 unchecked {
                         // Reverse the order of the legs if this call is burning a position (LIFO)
                         // We loop in reverse order if burning a position so that any dependent long liquidity is returned to the pool first,
                         // allowing the corresponding short liquidity to be removed
                         _leg = _isBurn ? numLegs - leg - 1 : leg;
                     }

931:             unchecked {
                     ++leg;
                 }

```
([578](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L578-L580),[649](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L649-L651),[895](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L895-L900),[895](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L895-L900),[931](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L931-L933))
```solidity
File: contracts/libraries/FeesCalc.sol

79:                 unchecked {
                        ++leg;
                    }

83:             unchecked {
                    ++k;
                }

```
([79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L79-L81),[83](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L83-L85))
```solidity
File: contracts/libraries/PanopticMath.sol

406:             unchecked {
                     ++leg;
                 }

```
([406](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L406-L408))
```solidity
File: contracts/multicall/Multicall.sol

32:             unchecked {
                    ++i;
                }

```
([32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L32-L34))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

156:             unchecked {
                     ++i;
                 }

```
([156](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L156-L158))
### <a name="NC-86"></a>[NC-86] `require()`/`revert()` statements should have descriptive reason strings

*There are 9 Instances of this issue* :
```solidity
File: contracts/libraries/Math.sol

361:                 require(denominator > 0);

370:             require(denominator > prod1);

448:                 require(result < type(uint256).max);

484:             require(2 ** 64 > prod1);

547:             require(2 ** 96 > prod1);

588:                 require(result < type(uint256).max);

624:             require(2 ** 128 > prod1);

665:                 require(result < type(uint256).max);

701:             require(2 ** 192 > prod1);

```
([361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L361-L361),[370](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L370-L370),[448](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L448-L448),[484](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L484-L484),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L547-L547),[588](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L588-L588),[624](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L624-L624),[665](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L665-L665),[701](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L701-L701))
### <a name="NC-87"></a>[NC-87] Default `address(0)` can be returned
Allowing a function in Solidity to return the default address (address(0)) can be problematic as it can represent uninitialized or invalid addresses. If such an address is utilized in transfer operations or other sensitive actions, it could lead to loss of funds or unpredicted behavior. It's prudent to include checks in your functions to prevent the return of the zero address, enhancing contract security.

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

362:         return s_underlyingToken;

```
([362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L362-L362))
```solidity
File: contracts/PanopticFactory.sol

160:         return s_owner;

```
([160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L160-L160))
### <a name="NC-88"></a>[NC-88] Revert statements within external and public functions can be used to perform DOS attacks
In Solidity, 'revert' statements are used to undo changes and throw an exception when certain conditions are not met. However, in public and external functions, improper use of `revert` can be exploited for Denial of Service (DoS) attacks. An attacker can intentionally trigger these 'revert' conditions, causing legitimate transactions to consistently fail. For example, if a function relies on specific conditions from user input or contract state, an attacker could manipulate these to continually force reverts, blocking the function's execution. Therefore, it's crucial to design contract logic to handle exceptions properly and avoid scenarios where `revert` can be predictably triggered by malicious actors. This includes careful input validation and considering alternative design patterns that are less susceptible to such abuses.

*There are 26 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();

596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();

```
([229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L229-L229),[331](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L331-L331),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L350-L350),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L418-L418),[480](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L480-L480),[536](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L536-L536),[596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L596-L596))
```solidity
File: contracts/PanopticFactory.sol

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

227:         if (address(v3Pool) == address(0)) revert Errors.UniswapPoolNotInitialized();

230:             revert Errors.PoolAlreadyInitialized();

```
([150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L150-L150),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L220-L220),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L224-L224),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L227-L227),[230](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L230-L230))
```solidity
File: contracts/PanopticPool.sol

299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();

342:             revert Errors.PriceBoundFail();

1036:                 revert Errors.StaleTWAP();

1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();

1163:         ) revert Errors.NotEnoughCollateral();

1188:         if (touchedId.length != 1) revert Errors.InputListFail();

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

```
([299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L299-L299),[342](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L342-L342),[1036](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1036-L1036),[1066](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1066-L1066),[1163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1163-L1163),[1188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1188-L1188),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596))
```solidity
File: contracts/SemiFungiblePositionManager.sol

355:         if (univ3pool == address(0)) revert Errors.UniswapPoolNotInitialized();

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

```
([355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L355-L355),[549](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L549-L549),[576](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L576-L576))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

117:                 revert UnsafeRecipient();

137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

168:                 revert UnsafeRecipient();

```
([101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L101-L101),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L117-L117),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L137-L137),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L168-L168))
### <a name="NC-89"></a>[NC-89] Take advantage of Custom Error's return value property
An important feature of Custom Error is that values such as address, tokenID, msg.value can be written inside the () sign, this kind of approach provides a serious advantage in debugging and examining the revert details of dapps such as tenderly.

*There are 60 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

170:         if (msg.sender != address(s_panopticPool)) revert Errors.NotPanopticPool();

229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();

596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();

```
([170](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L170-L170),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L229-L229),[331](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L331-L331),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L350-L350),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L418-L418),[480](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L480-L480),[536](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L536-L536),[596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L596-L596))
```solidity
File: contracts/PanopticFactory.sol

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

227:         if (address(v3Pool) == address(0)) revert Errors.UniswapPoolNotInitialized();

230:             revert Errors.PoolAlreadyInitialized();

```
([150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L150-L150),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L220-L220),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L224-L224),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L227-L227),[230](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L230-L230))
```solidity
File: contracts/PanopticPool.sol

299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();

342:             revert Errors.PriceBoundFail();

639:             revert Errors.PositionAlreadyMinted();

940:         if (!solventAtFast) revert Errors.NotEnoughCollateral();

945:                 revert Errors.NotEnoughCollateral();

1036:                 revert Errors.StaleTWAP();

1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();

1163:         ) revert Errors.NotEnoughCollateral();

1188:         if (touchedId.length != 1) revert Errors.InputListFail();

1394:         if (fingerprintIncomingList != currentHash) revert Errors.InputListFail();

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1493:             revert Errors.EffectiveLiquidityAboveThreshold();

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

```
([299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L299-L299),[342](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L342-L342),[639](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L639-L639),[940](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L940-L940),[945](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L945-L945),[1036](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1036-L1036),[1066](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1066-L1066),[1163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1163-L1163),[1188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1188-L1188),[1394](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1394-L1394),[1415](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1415-L1415),[1493](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1493-L1493),[1596](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1596-L1596))
```solidity
File: contracts/SemiFungiblePositionManager.sol

322:         if (s_poolContext[poolId].locked) revert Errors.ReentrantCall();

355:         if (univ3pool == address(0)) revert Errors.UniswapPoolNotInitialized();

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

634:             ) revert Errors.TransferFailed();

639:                 revert Errors.TransferFailed();

688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();

728:             revert Errors.PriceBoundFail();

940:             revert Errors.PositionTooLarge();

1018:                     revert Errors.NotEnoughLiquidity();

```
([322](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L322-L322),[355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L355-L355),[549](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L549-L549),[576](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L576-L576),[634](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L634-L634),[639](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L639-L639),[688](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L688-L688),[702](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L702-L702),[728](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L728-L728),[940](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L940-L940),[1018](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1018-L1018))
```solidity
File: contracts/libraries/CallbackLib.sol

37:             revert Errors.InvalidUniswapCallback();

```
([37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L37-L37))
```solidity
File: contracts/libraries/Math.sol

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

```
([131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L131-L131),[297](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L297-L297),[312](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L312-L312),[319](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L319-L319),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L326-L326))
```solidity
File: contracts/libraries/PanopticMath.sol

361:             ) revert Errors.TicksNotInitializable();

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

```
([361](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L361-L361),[479](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L479-L479))
```solidity
File: contracts/libraries/SafeTransferLib.sol

45:         if (!success) revert Errors.TransferFailed();

75:         if (!success) revert Errors.TransferFailed();

```
([45](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L45-L45),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L75-L75))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

117:                 revert UnsafeRecipient();

137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();

168:                 revert UnsafeRecipient();

227:                 revert UnsafeRecipient();

```
([101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L101-L101),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L117-L117),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L137-L137),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L168-L168),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L227-L227))
```solidity
File: contracts/types/LeftRight.sol

163:             ) revert Errors.UnderOverFlow();

186:             ) revert Errors.UnderOverFlow();

199:             if (left128 != left) revert Errors.UnderOverFlow();

204:             if (right128 != right) revert Errors.UnderOverFlow();

222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

240:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

262:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

```
([163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L163-L163),[186](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L186-L186),[199](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L199-L199),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L204-L204),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L222-L222),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L240-L240),[262](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L262-L262))
```solidity
File: contracts/types/TokenId.sol

598:         revert Errors.NoLegsExercisable();

```
([598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L598-L598))
### <a name="NC-90"></a>[NC-90] Setters should prevent re-setting the same value
Not only is wasteful in terms of gas, but this is especially problematic when an event is emitted and the old and new values set are the same, as listeners might not expect this kind of scenario.

*There are 4 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

1587:     function settleLongPremium(
              TokenId[] calldata positionIdList,
              address owner,
              uint256 legIndex
          ) external {

1666:     function _updateSettlementPostMint(
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize
          ) internal {

1833:     function _updateSettlementPostBurn(
              address owner,
              TokenId tokenId,
              LeftRightUnsigned[4] memory collectedByLeg,
              uint128 positionSize,
              bool commitLongSettled
          ) internal returns (LeftRightSigned realizedPremia, LeftRightSigned[4] memory premiaByLeg) {

```
([1587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1587-L1591),[1666](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1666-L1670),[1833](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1833-L1839))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

```
([81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81))
### <a name="NC-91"></a>[NC-91] Use a single file for system wide constants
Consider grouping all the system constants under a single file.

*There are 49 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

70:     string internal constant TICKER_PREFIX = "po";

73:     string internal constant NAME_PREFIX = "POPT-V1";

77:     uint256 internal constant DECIMALS = 10_000;

81:     int128 internal constant DECIMALS_128 = 10_000;

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L73-L73),[77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L77-L77),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L81-L81))
```solidity
File: contracts/PanopticFactory.sol

82:     uint256 internal constant FULL_RANGE_LIQUIDITY_AMOUNT_WETH = 0.1 ether;

86:     uint256 internal constant FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN = 1e6;

89:     uint16 internal constant CARDINALITY_INCREASE = 100;

```
([82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L82-L82),[86](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L86-L86),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L89-L89))
```solidity
File: contracts/PanopticPool.sol

103:     int24 internal constant MIN_SWAP_TICK = Constants.MIN_V3POOL_TICK + 1;

105:     int24 internal constant MAX_SWAP_TICK = Constants.MAX_V3POOL_TICK - 1;

109:     bool internal constant COMPUTE_ALL_PREMIA = true;

111:     bool internal constant COMPUTE_LONG_PREMIA = false;

114:     bool internal constant ONLY_AVAILABLE_PREMIUM = false;

119:     bool internal constant COMMIT_LONG_SETTLED = true;

120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

123:     bool internal constant ADD = true;

128:     uint32 internal constant TWAP_WINDOW = 600;

133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

136:     uint256 internal constant MEDIAN_PERIOD = 60;

139:     uint256 internal constant FAST_ORACLE_CARDINALITY = 3;

145:     uint256 internal constant FAST_ORACLE_PERIOD = 1;

148:     uint256 internal constant SLOW_ORACLE_CARDINALITY = 7;

152:     uint256 internal constant SLOW_ORACLE_PERIOD = 5;

156:     int256 internal constant MAX_TWAP_DELTA_LIQUIDATION = 513;

160:     int256 internal constant MAX_SLOW_FAST_DELTA = 1800;

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

168:     uint64 internal constant MAX_POSITIONS = 32;

171:     uint256 internal constant BP_DECREASE_BUFFER = 13_333;

174:     uint256 internal constant NO_BUFFER = 10_000;

```
([103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L103-L103),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L105-L105),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L109-L109),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L111-L111),[114](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L114-L114),[119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L119-L119),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L120-L120),[123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L123-L123),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L128-L128),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L133-L133),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L136-L136),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L139-L139),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L145-L145),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L148-L148),[152](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L152-L152),[156](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L156-L156),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L160-L160),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L165-L165),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L168-L168),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L171-L171),[174](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L174-L174))
```solidity
File: contracts/SemiFungiblePositionManager.sol

125:     bool internal constant MINT = false;

126:     bool internal constant BURN = true;

133:     uint128 private constant VEGOID = 2;

```
([125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L125-L125),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L126-L126),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L133-L133))
```solidity
File: contracts/libraries/Constants.sol

9:     uint256 internal constant FP96 = 0x1000000000000000000000000;

12:     int24 internal constant MIN_V3POOL_TICK = -887272;

15:     int24 internal constant MAX_V3POOL_TICK = 887272;

18:     uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;

21:     uint160 internal constant MAX_V3POOL_SQRT_RATIO =
            1461446703485210103287273052203988822378723970342;

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L9-L9),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L12-L12),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L15-L15),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L18-L18),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L21-L22))
```solidity
File: contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15))
```solidity
File: contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

26:     uint64 internal constant TICKSPACING_MASK = 0xFFFF000000000000;

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L26-L26))
```solidity
File: contracts/types/LeftRight.sol

22:     uint256 internal constant LEFT_HALF_BIT_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000;

26:     int256 internal constant LEFT_HALF_BIT_MASK_INT =
            int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

30:     int256 internal constant RIGHT_HALF_BIT_MASK = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
([22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L22-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L26-L27),[30](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L30-L30))
```solidity
File: contracts/types/LiquidityChunk.sol

54:     uint256 internal constant CLEAR_TL_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

58:     uint256 internal constant CLEAR_TU_MASK =
            0xFFFFFF000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
([54](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L54-L55),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L58-L59))
```solidity
File: contracts/types/TokenId.sol

62:     uint256 internal constant LONG_MASK =
            0x100_000000000100_000000000100_000000000100_0000000000000000;

66:     uint256 internal constant CLEAR_POOLID_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF_0000000000000000;

70:     uint256 internal constant OPTION_RATIO_MASK =
            0x0000000000FE_0000000000FE_0000000000FE_0000000000FE_0000000000000000;

74:     uint256 internal constant CHUNK_MASK =
            0xFFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_0000000000000000;

78:     int256 internal constant BITMASK_INT24 = 0xFFFFFF;

```
([62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L62-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L66-L67),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L70-L71),[74](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L74-L75),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L78-L78))
### <a name="NC-92"></a>[NC-92] Prefer skip over revert model in iteration
It is preferable to skip operations on an array index when a condition is not met rather than reverting the whole transaction as reverting can introduce the possiblity of malicous actors purposefully introducing array objects which fail conditional checks within for/while loops so group operations fail. As such it is recommended to simply skip such array indices over reverting unless there is a valid security or logic reason behind not doing so.

*There are 12 Instances of this issue* :
```solidity
File: contracts/SemiFungiblePositionManager.sol

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

634:             ) revert Errors.TransferFailed();

639:                 revert Errors.TransferFailed();

```
([576](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L576-L576),[634](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L634-L634),[639](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L639-L639))
```solidity
File: contracts/types/TokenId.sol

513:                         revert Errors.InvalidTokenIdParameter(1);

522:                         revert Errors.InvalidTokenIdParameter(6);

522:                         revert Errors.InvalidTokenIdParameter(6);

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

533:                 ) revert Errors.InvalidTokenIdParameter(4);

542:                         revert Errors.InvalidTokenIdParameter(3);

548:                     ) revert Errors.InvalidTokenIdParameter(3);

561:                         revert Errors.InvalidTokenIdParameter(4);

567:                         revert Errors.InvalidTokenIdParameter(5);

```
([513](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L513-L513),[522](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L522-L522),[522](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L522-L522),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L528-L528),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L533-L533),[542](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L542-L542),[548](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L548-L548),[561](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L561-L561),[567](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L567-L567))
### <a name="NC-93"></a>[NC-93] Consider using SMTChecker
The SMTChecker is a valuable tool for Solidity developers as it helps detect potential vulnerabilities and logical errors in the contract's code. By utilizing Satisfiability Modulo Theories (SMT) solvers, it can reason about the potential states a contract can be in, and therefore, identify conditions that could lead to undesirable behavior. This automatic formal verification can catch issues that might otherwise be missed in manual code reviews or standard testing, enhancing the overall contract's security and reliability.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1-L1))
```solidity
File: contracts/PanopticFactory.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L1-L1))
```solidity
File: contracts/PanopticPool.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1-L1))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1-L1))
```solidity
File: contracts/libraries/CallbackLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L1-L1))
```solidity
File: contracts/libraries/Constants.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L1-L1))
```solidity
File: contracts/libraries/Errors.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L1-L1))
```solidity
File: contracts/libraries/FeesCalc.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L1-L1))
```solidity
File: contracts/libraries/InteractionHelper.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L1-L1))
```solidity
File: contracts/libraries/Math.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L1-L1))
```solidity
File: contracts/libraries/PanopticMath.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L1-L1))
```solidity
File: contracts/libraries/SafeTransferLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L1-L1))
```solidity
File: contracts/multicall/Multicall.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L1-L1))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/ERC20Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L1-L1))
```solidity
File: contracts/types/LeftRight.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L1-L1))
```solidity
File: contracts/types/LiquidityChunk.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L1-L1))
```solidity
File: contracts/types/TokenId.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L1-L1))
### <a name="NC-94"></a>[NC-94] Strings should use double quotes rather than single quotes
See the Solidity Style Guide: https://docs.soliditylang.org/en/v0.8.20/style-guide.html#other-recommendations

*There are 2 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

874:                      │(1) convert 'assets' to shares (this ERC20 contract)

921:                      │(1) convert 'assets' to shares (this ERC20 contract)

```
([874](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L874-L874),[921](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L921-L921))
### <a name="NC-95"></a>[NC-95] Contract does not follow the Solidity style guide's suggested layout ordering
The [style guide](https://docs.soliditylang.org/en/v0.8.16/style-guide.html#order-of-layout) says that, within a contract, the ordering should be:

1) Type declarations
2) State variables
3) Events
4) Modifiers
5) Functions

However, the contract(s) below do not follow this ordering

*There are 8 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

1: 
   Current order:
   UsingForDeclaration.undefined
   EventDefinition.Deposit
   EventDefinition.Withdraw
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   ModifierDefinition.onlyPanopticPool
   FunctionDefinition.undefined
   FunctionDefinition.startToken
   FunctionDefinition.getPoolData
   FunctionDefinition.name
   FunctionDefinition.symbol
   FunctionDefinition.decimals
   FunctionDefinition.transfer
   FunctionDefinition.transferFrom
   FunctionDefinition.asset
   FunctionDefinition.totalAssets
   FunctionDefinition.convertToShares
   FunctionDefinition.convertToAssets
   FunctionDefinition.maxDeposit
   FunctionDefinition.previewDeposit
   FunctionDefinition.deposit
   FunctionDefinition.maxMint
   FunctionDefinition.previewMint
   FunctionDefinition.mint
   FunctionDefinition.maxWithdraw
   FunctionDefinition.previewWithdraw
   FunctionDefinition.withdraw
   FunctionDefinition.maxRedeem
   FunctionDefinition.previewRedeem
   FunctionDefinition.redeem
   FunctionDefinition.exerciseCost
   FunctionDefinition._poolUtilization
   FunctionDefinition._sellCollateralRatio
   FunctionDefinition._buyCollateralRatio
   FunctionDefinition.delegate
   FunctionDefinition.delegate
   FunctionDefinition.refund
   FunctionDefinition.revoke
   FunctionDefinition.refund
   FunctionDefinition.takeCommissionAddData
   FunctionDefinition.exercise
   FunctionDefinition._getExchangedAmount
   FunctionDefinition.getAccountMarginDetails
   FunctionDefinition._getAccountMargin
   FunctionDefinition._getTotalRequiredCollateral
   FunctionDefinition._getRequiredCollateralAtTickSinglePosition
   FunctionDefinition._getRequiredCollateralSingleLeg
   FunctionDefinition._getRequiredCollateralSingleLegNoPartner
   FunctionDefinition._getRequiredCollateralSingleLegPartner
   FunctionDefinition._getRequiredCollateralAtUtilization
   FunctionDefinition._computeSpread
   FunctionDefinition._computeStrangle
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   EventDefinition.Deposit
   EventDefinition.Withdraw
   ModifierDefinition.onlyPanopticPool
   FunctionDefinition.undefined
   FunctionDefinition.startToken
   FunctionDefinition.getPoolData
   FunctionDefinition.name
   FunctionDefinition.symbol
   FunctionDefinition.decimals
   FunctionDefinition.transfer
   FunctionDefinition.transferFrom
   FunctionDefinition.asset
   FunctionDefinition.totalAssets
   FunctionDefinition.convertToShares
   FunctionDefinition.convertToAssets
   FunctionDefinition.maxDeposit
   FunctionDefinition.previewDeposit
   FunctionDefinition.deposit
   FunctionDefinition.maxMint
   FunctionDefinition.previewMint
   FunctionDefinition.mint
   FunctionDefinition.maxWithdraw
   FunctionDefinition.previewWithdraw
   FunctionDefinition.withdraw
   FunctionDefinition.maxRedeem
   FunctionDefinition.previewRedeem
   FunctionDefinition.redeem
   FunctionDefinition.exerciseCost
   FunctionDefinition._poolUtilization
   FunctionDefinition._sellCollateralRatio
   FunctionDefinition._buyCollateralRatio
   FunctionDefinition.delegate
   FunctionDefinition.delegate
   FunctionDefinition.refund
   FunctionDefinition.revoke
   FunctionDefinition.refund
   FunctionDefinition.takeCommissionAddData
   FunctionDefinition.exercise
   FunctionDefinition._getExchangedAmount
   FunctionDefinition.getAccountMarginDetails
   FunctionDefinition._getAccountMargin
   FunctionDefinition._getTotalRequiredCollateral
   FunctionDefinition._getRequiredCollateralAtTickSinglePosition
   FunctionDefinition._getRequiredCollateralSingleLeg
   FunctionDefinition._getRequiredCollateralSingleLegNoPartner
   FunctionDefinition._getRequiredCollateralSingleLegPartner
   FunctionDefinition._getRequiredCollateralAtUtilization
   FunctionDefinition._computeSpread
   FunctionDefinition._computeStrangle

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1-L147))
```solidity
File: contracts/PanopticFactory.sol

1: 
   Current order:
   EventDefinition.OwnershipTransferred
   EventDefinition.PoolDeployed
   UsingForDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.undefined
   FunctionDefinition.initialize
   FunctionDefinition.transferOwnership
   FunctionDefinition.owner
   FunctionDefinition.uniswapV3MintCallback
   FunctionDefinition.deployNewPool
   FunctionDefinition.minePoolAddress
   FunctionDefinition._mintFullRange
   FunctionDefinition.getPanopticPool
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   EventDefinition.OwnershipTransferred
   EventDefinition.PoolDeployed
   FunctionDefinition.undefined
   FunctionDefinition.initialize
   FunctionDefinition.transferOwnership
   FunctionDefinition.owner
   FunctionDefinition.uniswapV3MintCallback
   FunctionDefinition.deployNewPool
   FunctionDefinition.minePoolAddress
   FunctionDefinition._mintFullRange
   FunctionDefinition.getPanopticPool

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L1-L51))
```solidity
File: contracts/PanopticPool.sol

1: 
   Current order:
   EventDefinition.AccountLiquidated
   EventDefinition.ForcedExercised
   EventDefinition.PremiumSettled
   EventDefinition.OptionBurnt
   EventDefinition.OptionMinted
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.undefined
   FunctionDefinition.startPool
   FunctionDefinition.assertPriceWithinBounds
   FunctionDefinition.optionPositionBalance
   FunctionDefinition.calculateAccumulatedFeesBatch
   FunctionDefinition.calculatePortfolioValue
   FunctionDefinition._calculateAccumulatedPremia
   FunctionDefinition._getSlippageLimits
   FunctionDefinition.pokeMedian
   FunctionDefinition.mintOptions
   FunctionDefinition.burnOptions
   FunctionDefinition.burnOptions
   FunctionDefinition._mintOptions
   FunctionDefinition._mintInSFPMAndUpdateCollateral
   FunctionDefinition._payCommissionAndWriteData
   FunctionDefinition._addUserOption
   FunctionDefinition._burnAllOptionsFrom
   FunctionDefinition._burnOptions
   FunctionDefinition._updatePositionDataBurn
   FunctionDefinition._validateSolvency
   FunctionDefinition._burnAndHandleExercise
   FunctionDefinition.liquidate
   FunctionDefinition.forceExercise
   FunctionDefinition._checkSolvencyAtTick
   FunctionDefinition._getSolvencyBalances
   FunctionDefinition._validatePositionList
   FunctionDefinition._updatePositionsHash
   FunctionDefinition.univ3pool
   FunctionDefinition.collateralToken0
   FunctionDefinition.collateralToken1
   FunctionDefinition.numberOfPositions
   FunctionDefinition.getUniV3TWAP
   FunctionDefinition._checkLiquiditySpread
   FunctionDefinition._getPremia
   FunctionDefinition.settleLongPremium
   FunctionDefinition._updateSettlementPostMint
   FunctionDefinition._getAvailablePremium
   FunctionDefinition._getTotalLiquidity
   FunctionDefinition._updateSettlementPostBurn
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   EventDefinition.AccountLiquidated
   EventDefinition.ForcedExercised
   EventDefinition.PremiumSettled
   EventDefinition.OptionBurnt
   EventDefinition.OptionMinted
   FunctionDefinition.undefined
   FunctionDefinition.startPool
   FunctionDefinition.assertPriceWithinBounds
   FunctionDefinition.optionPositionBalance
   FunctionDefinition.calculateAccumulatedFeesBatch
   FunctionDefinition.calculatePortfolioValue
   FunctionDefinition._calculateAccumulatedPremia
   FunctionDefinition._getSlippageLimits
   FunctionDefinition.pokeMedian
   FunctionDefinition.mintOptions
   FunctionDefinition.burnOptions
   FunctionDefinition.burnOptions
   FunctionDefinition._mintOptions
   FunctionDefinition._mintInSFPMAndUpdateCollateral
   FunctionDefinition._payCommissionAndWriteData
   FunctionDefinition._addUserOption
   FunctionDefinition._burnAllOptionsFrom
   FunctionDefinition._burnOptions
   FunctionDefinition._updatePositionDataBurn
   FunctionDefinition._validateSolvency
   FunctionDefinition._burnAndHandleExercise
   FunctionDefinition.liquidate
   FunctionDefinition.forceExercise
   FunctionDefinition._checkSolvencyAtTick
   FunctionDefinition._getSolvencyBalances
   FunctionDefinition._validatePositionList
   FunctionDefinition._updatePositionsHash
   FunctionDefinition.univ3pool
   FunctionDefinition.collateralToken0
   FunctionDefinition.collateralToken1
   FunctionDefinition.numberOfPositions
   FunctionDefinition.getUniV3TWAP
   FunctionDefinition._checkLiquiditySpread
   FunctionDefinition._getPremia
   FunctionDefinition.settleLongPremium
   FunctionDefinition._updateSettlementPostMint
   FunctionDefinition._getAvailablePremium
   FunctionDefinition._getTotalLiquidity
   FunctionDefinition._updateSettlementPostBurn

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1-L154))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1: 
   Current order:
   EventDefinition.PoolInitialized
   EventDefinition.TokenizedPositionBurnt
   EventDefinition.TokenizedPositionMinted
   UsingForDeclaration.undefined
   UsingForDeclaration.undefined
   StructDefinition.PoolAddressAndLock
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   ModifierDefinition.ReentrancyLock
   FunctionDefinition.beginReentrancyLock
   FunctionDefinition.endReentrancyLock
   FunctionDefinition.undefined
   FunctionDefinition.initializeAMMPool
   FunctionDefinition.uniswapV3MintCallback
   FunctionDefinition.uniswapV3SwapCallback
   FunctionDefinition.burnTokenizedPosition
   FunctionDefinition.mintTokenizedPosition
   FunctionDefinition.safeTransferFrom
   FunctionDefinition.safeBatchTransferFrom
   FunctionDefinition.registerTokenTransfer
   FunctionDefinition._validateAndForwardToAMM
   FunctionDefinition.swapInAMM
   FunctionDefinition._createPositionInAMM
   FunctionDefinition._createLegInAMM
   FunctionDefinition._updateStoredPremia
   FunctionDefinition._getFeesBase
   FunctionDefinition._mintLiquidity
   FunctionDefinition._burnLiquidity
   FunctionDefinition._collectAndWritePositionData
   FunctionDefinition._getPremiaDeltas
   FunctionDefinition.getAccountLiquidity
   FunctionDefinition.getAccountPremium
   FunctionDefinition.getAccountFeesBase
   FunctionDefinition.getUniswapV3PoolFromId
   FunctionDefinition.getPoolId
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StructDefinition.PoolAddressAndLock
   EventDefinition.PoolInitialized
   EventDefinition.TokenizedPositionBurnt
   EventDefinition.TokenizedPositionMinted
   ModifierDefinition.ReentrancyLock
   FunctionDefinition.beginReentrancyLock
   FunctionDefinition.endReentrancyLock
   FunctionDefinition.undefined
   FunctionDefinition.initializeAMMPool
   FunctionDefinition.uniswapV3MintCallback
   FunctionDefinition.uniswapV3SwapCallback
   FunctionDefinition.burnTokenizedPosition
   FunctionDefinition.mintTokenizedPosition
   FunctionDefinition.safeTransferFrom
   FunctionDefinition.safeBatchTransferFrom
   FunctionDefinition.registerTokenTransfer
   FunctionDefinition._validateAndForwardToAMM
   FunctionDefinition.swapInAMM
   FunctionDefinition._createPositionInAMM
   FunctionDefinition._createLegInAMM
   FunctionDefinition._updateStoredPremia
   FunctionDefinition._getFeesBase
   FunctionDefinition._mintLiquidity
   FunctionDefinition._burnLiquidity
   FunctionDefinition._collectAndWritePositionData
   FunctionDefinition._getPremiaDeltas
   FunctionDefinition.getAccountLiquidity
   FunctionDefinition.getAccountPremium
   FunctionDefinition.getAccountFeesBase
   FunctionDefinition.getUniswapV3PoolFromId
   FunctionDefinition.getPoolId

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1-L88))
```solidity
File: contracts/libraries/PanopticMath.sol

1: 
   Current order:
   UsingForDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.getPoolId
   FunctionDefinition.incrementPoolPattern
   FunctionDefinition.numberOfLeadingHexZeros
   FunctionDefinition.updatePositionsHash
   FunctionDefinition.computeMedianObservedPrice
   FunctionDefinition.computeInternalMedian
   FunctionDefinition.twapFilter
   FunctionDefinition.getLiquidityChunk
   FunctionDefinition.getTicks
   FunctionDefinition.getRangesFromStrike
   FunctionDefinition.computeExercisedAmounts
   FunctionDefinition.convertCollateralData
   FunctionDefinition.convertCollateralData
   FunctionDefinition.convertNotional
   FunctionDefinition.convert0to1
   FunctionDefinition.convert1to0
   FunctionDefinition.convert0to1
   FunctionDefinition.convert1to0
   FunctionDefinition.getAmountsMoved
   FunctionDefinition._calculateIOAmounts
   FunctionDefinition.getLiquidationBonus
   FunctionDefinition.haircutPremia
   FunctionDefinition.getRefundAmounts
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.getPoolId
   FunctionDefinition.incrementPoolPattern
   FunctionDefinition.numberOfLeadingHexZeros
   FunctionDefinition.updatePositionsHash
   FunctionDefinition.computeMedianObservedPrice
   FunctionDefinition.computeInternalMedian
   FunctionDefinition.twapFilter
   FunctionDefinition.getLiquidityChunk
   FunctionDefinition.getTicks
   FunctionDefinition.getRangesFromStrike
   FunctionDefinition.computeExercisedAmounts
   FunctionDefinition.convertCollateralData
   FunctionDefinition.convertCollateralData
   FunctionDefinition.convertNotional
   FunctionDefinition.convert0to1
   FunctionDefinition.convert1to0
   FunctionDefinition.convert0to1
   FunctionDefinition.convert1to0
   FunctionDefinition.getAmountsMoved
   FunctionDefinition._calculateIOAmounts
   FunctionDefinition.getLiquidationBonus
   FunctionDefinition.haircutPremia
   FunctionDefinition.getRefundAmounts

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L1-L55))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

1: 
   Current order:
   EventDefinition.TransferSingle
   EventDefinition.TransferBatch
   EventDefinition.ApprovalForAll
   CustomErrorDefinition.NotAuthorized
   CustomErrorDefinition.UnsafeRecipient
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.setApprovalForAll
   FunctionDefinition.safeTransferFrom
   FunctionDefinition.safeBatchTransferFrom
   FunctionDefinition.balanceOfBatch
   FunctionDefinition.supportsInterface
   FunctionDefinition._mint
   FunctionDefinition._burn
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   CustomErrorDefinition.NotAuthorized
   CustomErrorDefinition.UnsafeRecipient
   EventDefinition.TransferSingle
   EventDefinition.TransferBatch
   EventDefinition.ApprovalForAll
   FunctionDefinition.setApprovalForAll
   FunctionDefinition.safeTransferFrom
   FunctionDefinition.safeBatchTransferFrom
   FunctionDefinition.balanceOfBatch
   FunctionDefinition.supportsInterface
   FunctionDefinition._mint
   FunctionDefinition._burn

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L1-L32))
```solidity
File: contracts/tokens/ERC20Minimal.sol

1: 
   Current order:
   EventDefinition.Transfer
   EventDefinition.Approval
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.approve
   FunctionDefinition.transfer
   FunctionDefinition.transferFrom
   FunctionDefinition._transferFrom
   FunctionDefinition._mint
   FunctionDefinition._burn
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   EventDefinition.Transfer
   EventDefinition.Approval
   FunctionDefinition.approve
   FunctionDefinition.transfer
   FunctionDefinition.transferFrom
   FunctionDefinition._transferFrom
   FunctionDefinition._mint
   FunctionDefinition._burn

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L1-L26))
```solidity
File: contracts/types/LeftRight.sol

1: 
   Current order:
   UsingForDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.rightSlot
   FunctionDefinition.rightSlot
   FunctionDefinition.toRightSlot
   FunctionDefinition.toRightSlot
   FunctionDefinition.leftSlot
   FunctionDefinition.leftSlot
   FunctionDefinition.toLeftSlot
   FunctionDefinition.toLeftSlot
   FunctionDefinition.add
   FunctionDefinition.sub
   FunctionDefinition.add
   FunctionDefinition.add
   FunctionDefinition.sub
   FunctionDefinition.subRect
   FunctionDefinition.addCapped
   
   Suggested order:
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   StateVariableDeclaration.undefined
   FunctionDefinition.rightSlot
   FunctionDefinition.rightSlot
   FunctionDefinition.toRightSlot
   FunctionDefinition.toRightSlot
   FunctionDefinition.leftSlot
   FunctionDefinition.leftSlot
   FunctionDefinition.toLeftSlot
   FunctionDefinition.toLeftSlot
   FunctionDefinition.add
   FunctionDefinition.sub
   FunctionDefinition.add
   FunctionDefinition.add
   FunctionDefinition.sub
   FunctionDefinition.subRect
   FunctionDefinition.addCapped

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L1-L41))
### <a name="NC-96"></a>[NC-96] Set time variables to `uint32`
Time variables that are unlikely to ever reach the maximum `uint256` can be set as `uint32` because the maximum value of `uint32` is equal to the year 2016, which is more than enough.

*There are 7 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

136:     uint256 internal constant MEDIAN_PERIOD = 60;

145:     uint256 internal constant FAST_ORACLE_PERIOD = 1;

152:     uint256 internal constant SLOW_ORACLE_PERIOD = 5;

```
([136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L136-L136),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L145-L145),[152](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L152-L152))
```solidity
File: contracts/libraries/PanopticMath.sol

130:         uint256 period

171:         uint256 period,

186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(

192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool

```
([130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L130-L130),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L171-L171),[186](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L186-L186),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L192-L192))
### <a name="NC-97"></a>[NC-97] Addition/multiplication in `unchecked` block is unsafe
The additions/multiplications may silently overflow because they're in `unchecked` blocks with no preceding value checks, which may lead to unexpected results

*There are 213 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

202:                 2230 +
                         (12500 * ratioTick) /
                         10_000 +
                         (7812 * ratioTick ** 2) /
                         10_000 ** 2 +
                         (6510 * ratioTick ** 3) /
                         10_000 ** 3

203:                     (12500 * ratioTick) /

205:                     (7812 * ratioTick ** 2) /

207:                     (6510 * ratioTick ** 3) /

262:             s_ITMSpreadFee = uint128((ITM_SPREAD_MULTIPLIER * _poolFee) / DECIMALS);

372:             return s_poolAssets + s_inAMM;

403:                 assets * (DECIMALS - COMMISSION_FEE),

405:                 totalAssets() * DECIMALS

436:             s_poolAssets += uint128(assets);

446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);

463:                 shares * DECIMALS,

465:                 totalSupply * (DECIMALS - COMMISSION_FEE)

496:             s_poolAssets += uint128(assets);

670:                                 uint24(positionId.width(leg) * positionId.tickSpacing()),

731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))

732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

743:             return int256((s_inAMM * DECIMALS) / totalAssets());

796:                 min_sell_ratio +
                     ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /
                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL);

797:                 ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /

849:                 (BUYER_COLLATERAL_RATIO +
                         (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
                         (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1064:                 tokenToPay += intrinsicValue;

1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));

1110:                     s_ITMSpreadFee * uint256(Math.abs(intrinsicValue)),

1115:                 exchangedAmount = intrinsicValue + int256(swapCommission);

1119:             exchangedAmount += int256(
                      Math.unsafeDivRoundingUp(
                          uint256(uint128(shortAmount + longAmount)) * COMMISSION_FEE,
                          DECIMALS
                      )
                  );

1121:                     uint256(uint128(shortAmount + longAmount)) * COMMISSION_FEE,

1175:                     tokenRequired += uint128(-premiumAllPositions);

1184:                 netBalance += uint256(uint128(premiumAllPositions));

1228:                 tokenRequired += _tokenRequired;

1259:                 tokenRequired += _getRequiredCollateralSingleLeg(
                          tokenId,
                          index,
                          positionSize,
                          atTick,
                          poolUtilization
                      );

1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)

1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)

1401:                         required += Math.mulDiv96RoundingUp(amountMoved, c2);

1409:                             (tickUpper - strike) + (strike - tickLower)

1414:                             scaleFactor + Constants.FP96

1417:                         required += c3;

1486:                 required = Math.unsafeDivRoundingUp(amount * sellCollateral, DECIMALS);

1496:                 required = Math.unsafeDivRoundingUp(amount * buyCollateral, DECIMALS);

1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)

1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);

1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
                      (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

```
([202](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L202-L208),[203](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L203-L203),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L205-L205),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L207-L207),[262](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L262-L262),[372](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L372-L372),[403](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L403-L403),[405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L405-L405),[436](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L436-L436),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L446-L446),[463](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L463-L463),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L465-L465),[496](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L496-L496),[670](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L670-L670),[731](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L731-L731),[732](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L732-L732),[743](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L743-L743),[796](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L796-L798),[797](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L797-L797),[849](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L849-L851),[850](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L850-L850),[1029](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1029-L1029),[1064](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1064-L1064),[1084](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1084-L1084),[1110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1110-L1110),[1115](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1115-L1115),[1119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1119-L1124),[1121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1121-L1121),[1175](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1175-L1175),[1184](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1184-L1184),[1228](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1228-L1228),[1259](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1259-L1265),[1364](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1364-L1364),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1367-L1367),[1401](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1401-L1401),[1409](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1409-L1409),[1414](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1414-L1414),[1417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1417-L1417),[1486](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1486-L1486),[1496](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1496-L1496),[1571](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1571-L1571),[1572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1572-L1572),[1637](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1637-L1638))
```solidity
File: contracts/PanopticFactory.sol

300:             maxSalt = uint256(salt) + loops;

323:                 salt = bytes32(uint256(salt) + 1);

392:             tickLower = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

```
([300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L300-L300),[323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L323-L323),[392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L392-L392))
```solidity
File: contracts/PanopticPool.sol

309:                 (uint256(block.timestamp) << 216) +
                     // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
                     // see comment on s_miniMedian initialization for format of this magic number
                     (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
                     (uint256(uint24(currentTick)) << 24) + // add to slot 4
                     (uint256(uint24(currentTick))); // add to slot 3

730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

1134:                 liquidationBonus0 += deltaBonus0;

1135:                 liquidationBonus1 += deltaBonus1;

1329:             return balanceCross >= Math.unsafeDivRoundingUp(thresholdCross * buffer, 10_000);

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +
                      Math.mulDiv96(tokenData0.rightSlot(), sqrtPriceX96);

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +
                      Math.mulDiv96RoundingUp(tokenData0.leftSlot(), sqrtPriceX96);

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64

1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *
                                              (liquidityChunk.liquidity())) / 2 ** 64

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1729:                                 (grossCurrent[0] *
                                          positionLiquidity +
                                          grossPremiumLast.rightSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)

1731:                                     grossPremiumLast.rightSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)

1737:                                 (grossCurrent[1] *
                                          positionLiquidity +
                                          grossPremiumLast.leftSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)

1739:                                     grossPremiumLast.leftSlot() *
                                          totalLiquidityBefore) / (totalLiquidity)

1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *
                      totalLiquidity) / 2 ** 64;

1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *
                      totalLiquidity) / 2 ** 64;

1779:                                 (uint256(premiumOwed.rightSlot()) * settledTokens.rightSlot()) /

1788:                                 (uint256(premiumOwed.leftSlot()) * settledTokens.leftSlot()) /

1820:             totalLiquidity = accountLiquidities.rightSlot() + accountLiquidities.leftSlot();

1935:                                                 (int256(
                                                          grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.rightSlot() * 2 ** 64),

1936:                                                     grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore

1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity

1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

1952:                                                 (int256(
                                                          grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.leftSlot()) * 2 ** 64,

1953:                                                     grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore

1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity

1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

```
([309](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L309-L314),[730](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L730-L730),[1134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1134-L1134),[1135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1135-L1135),[1329](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1329-L1329),[1348](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1348-L1349),[1353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1353-L1354),[1487](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1487-L1487),[1550](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1550-L1552),[1559](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1559-L1561),[1635](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1635-L1635),[1636](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1636-L1636),[1729](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1729-L1732),[1731](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1731-L1732),[1737](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1737-L1740),[1739](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1739-L1740),[1768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1768-L1769),[1770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1770-L1771),[1779](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1779-L1779),[1788](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1788-L1788),[1820](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1820-L1820),[1935](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1935-L1942),[1936](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1936-L1937),[1940](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1940-L1941),[1942](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1942-L1942),[1952](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1952-L1959),[1953](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1953-L1954),[1957](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1957-L1958),[1959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1959-L1959))
```solidity
File: contracts/SemiFungiblePositionManager.sol

388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

842:                     ? Constants.MIN_V3POOL_SQRT_RATIO + 1

922:                     amount0 += Math.getAmount0ForLiquidity(liquidityChunk);

924:                     amount1 += Math.getAmount1ForLiquidity(liquidityChunk);

1032:                         removedLiquidity += chunkLiquidity;

1340:             uint256 totalLiquidity = netLiquidity + removedLiquidity;

1352:                     totalLiquidity * 2 ** 64,

1357:                     totalLiquidity * 2 ** 64,

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1388:                     uint256 numerator = totalLiquidity ** 2 -
                              totalLiquidity *
                              removedLiquidity +
                              ((removedLiquidity ** 2) / 2 ** (VEGOID));

1389:                         totalLiquidity *
                              removedLiquidity +

```
([388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L388-L388),[842](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L842-L842),[922](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L922-L922),[924](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L924-L924),[1032](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1032-L1032),[1340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1340-L1340),[1352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1352-L1352),[1357](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1357-L1357),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1367-L1367),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1388-L1391),[1389](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1389-L1390))
```solidity
File: contracts/libraries/FeesCalc.sol

69:                         value0 += int256(amount0);

70:                         value1 += int256(amount1);

```
([69](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L69-L69),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L70-L70))
```solidity
File: contracts/libraries/Math.sol

95:                 r += 32;

99:                 r += 16;

103:                 r += 8;

107:                 r += 4;

111:                 r += 2;

114:                 r += 1;

137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));

407:             prod0 |= prod1 * twos;

414:             uint256 inv = (3 * denominator) ^ 2;

418:             inv *= 2 - denominator * inv; // inverse mod 2**8

419:             inv *= 2 - denominator * inv; // inverse mod 2**16

420:             inv *= 2 - denominator * inv; // inverse mod 2**32

421:             inv *= 2 - denominator * inv; // inverse mod 2**64

422:             inv *= 2 - denominator * inv; // inverse mod 2**128

423:             inv *= 2 - denominator * inv; // inverse mod 2**256

431:             result = prod0 * inv;

511:             prod0 |= prod1 * 2 ** 192;

574:             prod0 |= prod1 * 2 ** 160;

651:             prod0 |= prod1 * 2 ** 128;

728:             prod0 |= prod1 * 2 ** 64;

758:             int256 pivot = arr[uint256(left + (right - left) / 2)];

```
([95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L95-L95),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L99-L99),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L103-L103),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L107-L107),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L111-L111),[114](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L114-L114),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L137-L137),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L139-L139),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L143-L143),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L145-L145),[147](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L147-L147),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L149-L149),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L151-L151),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L153-L153),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L155-L155),[157](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L157-L157),[159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L159-L159),[161](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L161-L161),[163](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L163-L163),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L165-L165),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L167-L167),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L169-L169),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L173-L173),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L179-L179),[407](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L407-L407),[414](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L414-L414),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L418-L418),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L419-L419),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L420-L420),[421](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L421-L421),[422](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L422-L422),[423](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L423-L423),[431](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L431-L431),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L511-L511),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L574-L574),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L651-L651),[728](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L728-L728),[758](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L758-L758))
```solidity
File: contracts/libraries/PanopticMath.sol

51:             poolId += uint64(uint24(tickSpacing)) << 48;

62:             return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);

107:                     ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)

108:                     : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);

133:             int256[] memory tickCumulatives = new int256[](cardinality + 1);

135:             uint256[] memory timestamps = new uint256[](cardinality + 1);

137:             for (uint256 i = 0; i < cardinality + 1; ++i) {

140:                         (int256(observationIndex) - int256(i * period)) +
                                 int256(observationCardinality)

150:                     (tickCumulatives[i] - tickCumulatives[i + 1]) /

151:                     int256(timestamps[i] - timestamps[i + 1]);

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +
                         int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)

209:                     rank = (orderMap >> (3 * i)) % 8;

217:                     entry = int24(uint24(medianData >> (rank * 24)));

219:                         shift += 1;

223:                     newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));

227:                     (block.timestamp << 216) +
                         (uint256(newOrderMap) << 192) +
                         uint256(uint192(medianData << 24)) +
                         uint256(uint24(lastObservedTick));

249:                 secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

346:             int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

347:             int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;

351:             (tickLower, tickUpper) = (strike - rangeDown, strike + rangeUp);

476:                 ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))

477:                 : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));

669:                 uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);

698:             int256 paid0 = bonus0 + int256(netExchanged.rightSlot());

699:             int256 paid1 = bonus1 + int256(netExchanged.leftSlot());

715:                     bonus1 += Math.min(
                             balance1 - paid1,
                             PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)
                         );

733:                     bonus0 += Math.min(
                             balance0 - paid0,
                             PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)
                         );

744:             paid0 = bonus0 + int256(netExchanged.rightSlot());

745:             paid1 = bonus1 + int256(netExchanged.leftSlot());

820:                 haircut1 = protocolLoss1 + collateralDelta1;

843:                 haircut0 = collateralDelta0 + protocolLoss0;

870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),

874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),

938:                                 int256(
                                         PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)
                                     ) + refundValues.leftSlot()

956:                                 int256(
                                         PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)
                                     ) + refundValues.rightSlot()

```
([51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L51-L51),[62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L62-L62),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L107-L107),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L108-L108),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L133-L133),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L135-L135),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L137-L137),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L140-L141),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L150-L150),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L151-L151),[178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L178-L179),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L179-L179),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L183-L183),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L188-L188),[209](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L209-L209),[217](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L217-L217),[219](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L219-L219),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L223-L223),[227](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L227-L230),[249](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L249-L249),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L258-L258),[346](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L346-L346),[347](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L347-L347),[351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L351-L351),[476](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L476-L476),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L477-L477),[669](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L669-L669),[698](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L698-L698),[699](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L699-L699),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L715-L718),[733](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L733-L736),[744](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L744-L744),[745](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L745-L745),[820](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L820-L820),[843](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L843-L843),[870](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L870-L870),[874](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L874-L874),[938](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L938-L940),[956](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L956-L958))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

107:             balanceOf[to][id] += amount;

151:                 balanceOf[to][id] += amount;

217:             balanceOf[to][id] += amount;

```
([107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L107-L107),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L151-L151),[217](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L217-L217))
```solidity
File: contracts/tokens/ERC20Minimal.sol

67:             balanceOf[to] += amount;

91:             balanceOf[to] += amount;

109:             balanceOf[to] += amount;

126:             balanceOf[to] += amount;

```
([67](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L67-L67),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L91-L91),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L109-L109),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L126-L126))
```solidity
File: contracts/types/LeftRight.sol

68:                     (LeftRightUnsigned.unwrap(self) & LEFT_HALF_BIT_MASK) +
                            uint256(uint128(LeftRightUnsigned.unwrap(self)) + right)

69:                         uint256(uint128(LeftRightUnsigned.unwrap(self)) + right)

88:                     (LeftRightSigned.unwrap(self) & LEFT_HALF_BIT_MASK_INT) +
                            (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)

89:                         (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)

126:             return LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(self) + (uint256(left) << 128));

136:             return LeftRightSigned.wrap(LeftRightSigned.unwrap(self) + (int256(left) << 128));

155:             z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) + LeftRightUnsigned.unwrap(y));

196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();

201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();

216:             int256 left256 = int256(x.leftSlot()) + y.leftSlot();

219:             int256 right256 = int256(x.rightSlot()) + y.rightSlot();

```
([68](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L68-L69),[69](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L69-L69),[88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L88-L89),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L89-L89),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L126-L126),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L136-L136),[155](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L155-L155),[196](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L196-L196),[201](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L201-L201),[216](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L216-L216),[219](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L219-L219))
```solidity
File: contracts/types/LiquidityChunk.sol

78:                     (uint256(uint24(_tickLower)) << 232) +
                            (uint256(uint24(_tickUpper)) << 208) +
                            uint256(amount)

94:             return LiquidityChunk.wrap(LiquidityChunk.unwrap(self) + amount);

109:                     LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)

126:                     LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)

```
([78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L78-L80),[94](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L94-L94),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L109-L109),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L126-L126))
```solidity
File: contracts/types/TokenId.sol

110:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48)) % 2);

120:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 1)) % 128);

130:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);

140:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);

150:             return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);

160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

185:             return TokenId.wrap(TokenId.unwrap(self) + _poolId);

195:             return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));

212:                 TokenId.wrap(TokenId.unwrap(self) + (uint256(_asset % 2) << (64 + legIndex * 48)));

229:                     TokenId.unwrap(self) + (uint256(_optionRatio % 128) << (64 + legIndex * 48 + 1))

246:             return TokenId.wrap(TokenId.unwrap(self) + ((_isLong % 2) << (64 + legIndex * 48 + 8)));

263:                     TokenId.unwrap(self) + (uint256(_tokenType % 2) << (64 + legIndex * 48 + 9))

281:                     TokenId.unwrap(self) + (uint256(_riskPartner % 4) << (64 + legIndex * 48 + 10))

299:                     TokenId.unwrap(self) +
                             uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

319:                     TokenId.unwrap(self) +
                             (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

395:                         ((LONG_MASK >> (48 * (4 - optionRatios))) & CLEAR_POOLID_MASK)

406:             return self.isLong(0) + self.isLong(1) + self.isLong(2) + self.isLong(3);

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)

520:                 for (uint256 j = i + 1; j < numLegs; ++j) {

521:                     if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {

589:                 if ((currentTick >= _strike + rangeUp) || (currentTick < _strike - rangeDown)) {

```
([110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L110-L110),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L120-L120),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L130-L130),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L140-L140),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L150-L150),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L160-L160),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[185](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L185-L185),[195](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L195-L195),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L212-L212),[229](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L229-L229),[246](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L246-L246),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L263-L263),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L281-L281),[299](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L299-L300),[300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L300-L300),[319](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L319-L320),[320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L320-L320),[395](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L395-L395),[406](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L406-L406),[512](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L512-L512),[520](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L520-L520),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L521-L521),[589](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L589-L589))
### <a name="NC-98"></a>[NC-98] `unchecked` blocks with subtractions may underflow
There aren't any checks to avoid an underflow which can happen inside an `unchecked` block, so the following subtractions may underflow silently.

*There are 119 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

403:                 assets * (DECIMALS - COMMISSION_FEE),

465:                 totalSupply * (DECIMALS - COMMISSION_FEE)

552:             s_poolAssets -= uint128(assets);

612:             s_poolAssets -= uint128(assets);

677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)

715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

727:             int256 fee = (FORCE_EXERCISE_COST >> (maxNumRangesFromStrike - 1)); // exponential decay of fee based on number of half ranges away from the price

797:                 ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /

798:                 (SATURATED_POOL_UTIL - TARGET_POOL_UTIL);

850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /

851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

1003:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1058:             int256 intrinsicValue = swappedAmount - (longAmount - shortAmount);

1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

1105:             int256 intrinsicValue = swappedAmount - (shortAmount - longAmount);

1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)

1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)

1397:                         uint256 c2 = Constants.FP96 - ratio;

1409:                             (tickUpper - strike) + (strike - tickLower)

1413:                             scaleFactor - ratio,

1546:                         ? movedPartnerRight - movedRight

1547:                         : movedRight - movedPartnerRight;

1550:                         ? movedPartnerLeft - movedLeft

1551:                         : movedLeft - movedPartnerLeft;

1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)

1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);

```
([200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L200-L200),[403](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L403-L403),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L465-L465),[552](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L552-L552),[612](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L612-L612),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L677-L677),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L715-L715),[718](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L718-L718),[727](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L727-L727),[797](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L797-L797),[798](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L798-L798),[850](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L850-L850),[851](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L851-L851),[1003](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1003-L1003),[1029](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1029-L1029),[1052](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1052-L1052),[1058](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1058-L1058),[1085](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1085-L1085),[1105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1105-L1105),[1364](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1364-L1364),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1367-L1367),[1397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1397-L1397),[1409](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1409-L1409),[1413](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1413-L1413),[1546](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1546-L1546),[1547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1547-L1547),[1550](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1550-L1550),[1551](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1551-L1551),[1571](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1571-L1571),[1572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1572-L1572))
```solidity
File: contracts/PanopticPool.sol

624:             tokenId = positionIdList[positionIdList.length - 1];

1255:                 refundAmounts.rightSlot() - delegatedAmounts.rightSlot()

1260:                 refundAmounts.leftSlot() - delegatedAmounts.leftSlot()

1376:             pLength = positionIdList.length - offset;

1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
                                              premiumAccumulatorLast.rightSlot()) *

1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
                                              premiumAccumulatorLast.leftSlot()) *

1723:                     uint256 totalLiquidityBefore = totalLiquidity - positionLiquidity;

1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *

1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *

1935:                                                 (int256(
                                                          grossPremiumLast.rightSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][0] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.rightSlot() * 2 ** 64),

1952:                                                 (int256(
                                                          grossPremiumLast.leftSlot() *
                                                              totalLiquidityBefore
                                                      ) -
                                                          int256(
                                                              _premiumAccumulatorsByLeg[_leg][1] *
                                                                  positionLiquidity
                                                          )) + int256(legPremia.leftSlot()) * 2 ** 64,

```
([624](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L624-L624),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1255-L1255),[1260](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1260-L1260),[1376](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1376-L1376),[1550](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1550-L1551),[1559](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1559-L1560),[1723](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1723-L1723),[1768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1768-L1768),[1770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1770-L1770),[1935](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1935-L1942),[1952](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1952-L1959))
```solidity
File: contracts/SemiFungiblePositionManager.sol

817:                 int256 net0 = itm0 - PanopticMath.convert1to0(itm1, sqrtPriceX96);

843:                     : Constants.MAX_V3POOL_SQRT_RATIO - 1,

899:                     _leg = _isBurn ? numLegs - leg - 1 : leg;

1023:                         updatedLiquidity = startingLiquidity - chunkLiquidity;

1297:                     ? receivedAmount0 - uint128(-movedInLeg.rightSlot())

1300:                     ? receivedAmount1 - uint128(-movedInLeg.leftSlot())

1388:                     uint256 numerator = totalLiquidity ** 2 -
                              totalLiquidity *
                              removedLiquidity +

```
([817](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L817-L817),[843](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L843-L843),[899](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L899-L899),[1023](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1023-L1023),[1297](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1297-L1297),[1300](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1300-L1300),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1388-L1390))
```solidity
File: contracts/libraries/FeesCalc.sol

74:                         value0 -= int256(amount0);

75:                         value1 -= int256(amount1);

166:                 feeGrowthInside0X128 = lowerOut0 - upperOut0; // fee growth inside the chunk

167:                 feeGrowthInside1X128 = lowerOut1 - upperOut1;

183:                 feeGrowthInside0X128 = upperOut0 - lowerOut0;

184:                 feeGrowthInside1X128 = upperOut1 - lowerOut1;

204:                 feeGrowthInside0X128 = univ3pool.feeGrowthGlobal0X128() - lowerOut0 - upperOut0;

205:                 feeGrowthInside1X128 = univ3pool.feeGrowthGlobal1X128() - lowerOut1 - upperOut1;

```
([74](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L74-L74),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L75-L75),[166](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L166-L166),[167](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L167-L167),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L183-L183),[184](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L184-L184),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L204-L204),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L205-L205))
```solidity
File: contracts/libraries/Math.sol

198:                     highPriceX96 - lowPriceX96,

212:             return mulDiv96(liquidityChunk.liquidity(), highPriceX96 - lowPriceX96);

258:                             highPriceX96 - lowPriceX96

284:                     toUint128(mulDiv(amount1, Constants.FP96, highPriceX96 - lowPriceX96))

391:             uint256 twos = (0 - denominator) & denominator;

418:             inv *= 2 - denominator * inv; // inverse mod 2**8

419:             inv *= 2 - denominator * inv; // inverse mod 2**16

420:             inv *= 2 - denominator * inv; // inverse mod 2**32

421:             inv *= 2 - denominator * inv; // inverse mod 2**64

422:             inv *= 2 - denominator * inv; // inverse mod 2**128

423:             inv *= 2 - denominator * inv; // inverse mod 2**256

758:             int256 pivot = arr[uint256(left + (right - left) / 2)];

778:             quickSort(data, int256(0), int256(data.length - 1));

```
([198](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L198-L198),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L212-L212),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L258-L258),[284](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L284-L284),[391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L391-L391),[418](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L418-L418),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L419-L419),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L420-L420),[421](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L421-L421),[422](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L422-L422),[423](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L423-L423),[758](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L758-L758),[778](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L778-L778))
```solidity
File: contracts/libraries/PanopticMath.sol

77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

108:                     : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);

140:                         (int256(observationIndex) - int256(i * period)) +

150:                     (tickCumulatives[i] - tickCumulatives[i + 1]) /

151:                     int256(timestamps[i] - timestamps[i + 1]);

188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)

195:                         (tickCumulative_last - tickCumulative_old) /

196:                             int256(timestamp_last - timestamp_old)

212:                         shift -= 1;

223:                     newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

351:             (tickLower, tickUpper) = (strike - rangeDown, strike + rangeUp);

678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

693:             int256 balance0 = int256(uint256(tokenData0.rightSlot())) -
                     Math.max(premia.rightSlot(), 0);

695:             int256 balance1 = int256(uint256(tokenData1.rightSlot())) -
                     Math.max(premia.leftSlot(), 0);

716:                         balance1 - paid1,

717:                         PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)

719:                     bonus0 -= Math.min(
                             PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),
                             paid0 - balance0
                         );

720:                         PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),

721:                         paid0 - balance0

734:                         balance0 - paid0,

735:                         PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)

737:                     bonus1 -= Math.min(
                             PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),
                             paid1 - balance1
                         );

738:                         PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),

739:                         paid1 - balance1

749:                 LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(

750:                     int128(balance1 - paid1)

804:                         collateralDelta0 - longPremium.rightSlot(),

806:                             longPremium.leftSlot() - collateralDelta1,

811:                         longPremium.leftSlot() - collateralDelta1,

813:                             collateralDelta0 - longPremium.rightSlot(),

828:                         longPremium.rightSlot() - collateralDelta0,

830:                             collateralDelta1 - longPremium.leftSlot(),

835:                         collateralDelta1 - longPremium.leftSlot(),

837:                             longPremium.rightSlot() - collateralDelta0,

890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0

894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1

928:             int256 balanceShortage = refundValues.rightSlot() -
                     int256(collateral0.convertToAssets(collateral0.balanceOf(refunder)));

935:                         .toRightSlot(int128(refundValues.rightSlot() - balanceShortage))

946:                 refundValues.leftSlot() -
                     int256(collateral1.convertToAssets(collateral1.balanceOf(refunder)));

953:                         .toLeftSlot(int128(refundValues.leftSlot() - balanceShortage))

```
([77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L77-L77),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L108-L108),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L140-L140),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L150-L150),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L151-L151),[188](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L188-L188),[195](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L195-L195),[196](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L196-L196),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L212-L212),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L223-L223),[258](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L258-L258),[351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L351-L351),[678](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L678-L678),[685](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L685-L685),[693](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L693-L694),[695](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L695-L696),[716](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L716-L716),[717](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L717-L717),[719](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L719-L722),[720](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L720-L720),[721](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L721-L721),[734](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L734-L734),[735](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L735-L735),[737](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L737-L740),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L738-L738),[739](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L739-L739),[749](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L749-L749),[750](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L750-L750),[804](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L804-L804),[806](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L806-L806),[811](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L811-L811),[813](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L813-L813),[828](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L828-L828),[830](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L830-L830),[835](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L835-L835),[837](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L837-L837),[890](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L890-L890),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L894-L894),[928](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L928-L929),[935](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L935-L935),[946](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L946-L947),[953](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L953-L953))
```solidity
File: contracts/tokens/ERC20Minimal.sol

142:             totalSupply -= amount;

```
([142](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L142-L142))
```solidity
File: contracts/types/LeftRight.sol

178:             z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) - LeftRightUnsigned.unwrap(y));

234:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();

237:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();

256:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();

259:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();

```
([178](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L178-L178),[234](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L234-L234),[237](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L237-L237),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L256-L256),[259](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L259-L259))
```solidity
File: contracts/types/TokenId.sol

395:                         ((LONG_MASK >> (48 * (4 - optionRatios))) & CLEAR_POOLID_MASK)

589:                 if ((currentTick >= _strike + rangeUp) || (currentTick < _strike - rangeDown)) {

```
([395](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L395-L395),[589](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L589-L589))
### <a name="NC-99"></a>[NC-99] Use Underscores for Number Literals (add an underscore every 3 digits)

*There are 10 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

202:                 2230 +

```
([200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L200-L200),[202](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L202-L202))
```solidity
File: contracts/PanopticPool.sol

160:     int256 internal constant MAX_SLOW_FAST_DELTA = 1800;

```
([160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L160-L160))
```solidity
File: contracts/libraries/Constants.sol

15:     int24 internal constant MAX_V3POOL_TICK = 887272;

18:     uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;

22:         1461446703485210103287273052203988822378723970342;

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L15-L15),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L18-L18),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L22-L22))
```solidity
File: contracts/types/TokenId.sol

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

172:         } // "% 4096" = take last (2 ** 12 = 4096) 12 bits

172:         } // "% 4096" = take last (2 ** 12 = 4096) 12 bits

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))

```
([171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L171-L171),[172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L172-L172),[172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L172-L172),[320](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L320-L320))
### <a name="NC-100"></a>[NC-100] Contracts with only unimplemented functions can be labeled as abstract
In Solidity, a contract that's not meant to be deployed on its own but is intended to be inherited by other contracts should be marked `abstract`. This ensures that developers recognize the contract's incomplete or intended-to-be-extended nature. If a contract has unimplemented functions or is designed with the intention that another contract should extend its functionality, it should be explicitly labeled as `abstract`. This helps prevent inadvertent deployments and clearly communicates the contract's purpose to other developers. Resolution: Review the contract, and if it's not supposed to function standalone, mark it as `abstract` to make the intention clear.

*There are 13 Instances of this issue* :
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L12))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L7))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

39: library FeesCalc {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L39))
```solidity
File: contracts/libraries/InteractionHelper.sol

17: library InteractionHelper {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L17))
```solidity
File: contracts/libraries/Math.sol

13: library Math {

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L13))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L11))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L17))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L52))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L60))
### <a name="NC-101"></a>[NC-101] Event is missing `indexed` fields
Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

*There are 12 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

49:     event Deposit(address indexed sender, address indexed owner, uint256 assets, uint256 shares);

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L49-L49))
```solidity
File: contracts/PanopticFactory.sol

43:     event PoolDeployed(
            PanopticPool indexed poolAddress,
            IUniswapV3Pool indexed uniswapPool,
            CollateralTracker collateralTracker0,
            CollateralTracker collateralTracker1,
            uint256 amount0,
            uint256 amount1
        );

```
([43](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L43-L50))
```solidity
File: contracts/PanopticPool.sol

38:     event AccountLiquidated(
            address indexed liquidator,
            address indexed liquidatee,
            LeftRightSigned bonusAmounts
        );

62:     event PremiumSettled(
            address indexed user,
            TokenId indexed tokenId,
            LeftRightSigned settledAmounts
        );

75:     event OptionBurnt(
            address indexed recipient,
            uint128 positionSize,
            TokenId indexed tokenId,
            LeftRightSigned premia
        );

90:     event OptionMinted(
            address indexed recipient,
            uint128 positionSize,
            TokenId indexed tokenId,
            uint128 poolUtilizations
        );

```
([38](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L38-L42),[62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L62-L66),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L75-L80),[90](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L90-L95))
```solidity
File: contracts/SemiFungiblePositionManager.sol

80:     event PoolInitialized(address indexed uniswapPool, uint64 poolId);

87:     event TokenizedPositionBurnt(
            address indexed recipient,
            TokenId indexed tokenId,
            uint128 positionSize
        );

98:     event TokenizedPositionMinted(
            address indexed caller,
            TokenId indexed tokenId,
            uint128 positionSize
        );

```
([80](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L80-L80),[87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L87-L91),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L98-L102))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

48:     event ApprovalForAll(address indexed owner, address indexed operator, bool approved);

```
([48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L48-L48))
```solidity
File: contracts/tokens/ERC20Minimal.sol

18:     event Transfer(address indexed from, address indexed to, uint256 amount);

24:     event Approval(address indexed owner, address indexed spender, uint256 amount);

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L18-L18),[24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L24-L24))
### <a name="NC-102"></a>[NC-102] Unused function parameter
Comment out the variable name to suppress compiler warnings

*There are 14 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit 
392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

// @audit 
444:     function maxMint(address) external view returns (uint256 maxShares) {

```
([392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444))
```solidity
File: contracts/libraries/Math.sol

// @audit a, b
340:     function mulDiv(
             uint256 a,
             uint256 b,
             uint256 denominator
         ) internal pure returns (uint256 result) {

// @audit a, b
458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

// @audit a, b
521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

// @audit a, b
598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

// @audit a, b
675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

// @audit a, b
738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

```
([340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L340-L344),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L738))
```solidity
File: contracts/libraries/SafeTransferLib.sol

// @audit token, from, to, amount
21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

// @audit token, to, amount
52:     function safeTransfer(address token, address to, uint256 amount) internal {

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L52))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

// @audit deployer, newPoolContract, token0, token1, fee
13:     function issueNFT(
            address deployer,
            PanopticPool newPoolContract,
            address token0,
            address token1,
            uint24 fee
        ) external;

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L13-L19))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

// @audit account
16:     function balanceOf(address account) external view returns (uint256);

// @audit spender, amount
22:     function approve(address spender, uint256 amount) external;

// @audit to, amount
27:     function transfer(address to, uint256 amount) external;

```
([16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L16-L16),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L22-L22),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L27-L27))
### <a name="NC-103"></a>[NC-103] Use the Modern Upgradeable Contract Paradigm
Modern smart contract development often employs upgradeable contract structures, utilizing proxy patterns like OpenZeppelin’s Upgradeable Contracts. This paradigm separates logic and state, allowing developers to amend and enhance the contract's functionality without altering its state or the deployed contract address. Transitioning to this approach enhances long-term maintainability.

Resolution: Adopt a well-established proxy pattern for upgradeability, ensuring proper initialization and employing transparent proxies to mitigate potential risks. Embrace comprehensive testing and audit practices, particularly when updating contract logic, to ensure state consistency and security are preserved across upgrades. This ensures your contract remains robust and adaptable to future requirements.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {

```
([36](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L36-L36))
```solidity
File: contracts/PanopticFactory.sol

26: contract PanopticFactory is Multicall {

```
([26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L26-L26))
```solidity
File: contracts/PanopticPool.sol

27: contract PanopticPool is ERC1155Holder, Multicall {

```
([27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L27-L27))
```solidity
File: contracts/SemiFungiblePositionManager.sol

72: contract SemiFungiblePositionManager is ERC1155, Multicall {

```
([72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L72-L72))
```solidity
File: contracts/libraries/CallbackLib.sol

12: library CallbackLib {

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L12-L12))
```solidity
File: contracts/libraries/Constants.sol

7: library Constants {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L7-L7))
```solidity
File: contracts/libraries/Errors.sol

7: library Errors {

```
([7](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L7-L7))
```solidity
File: contracts/libraries/FeesCalc.sol

39: library FeesCalc {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L39-L39))
```solidity
File: contracts/libraries/InteractionHelper.sol

17: library InteractionHelper {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L17-L17))
```solidity
File: contracts/libraries/Math.sol

13: library Math {

```
([13](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L13-L13))
```solidity
File: contracts/libraries/PanopticMath.sol

18: library PanopticMath {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L18-L18))
```solidity
File: contracts/libraries/SafeTransferLib.sol

11: library SafeTransferLib {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L11-L11))
```solidity
File: contracts/multicall/Multicall.sol

8: abstract contract Multicall {

```
([8](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L8-L8))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

11: abstract contract ERC1155 {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L11-L11))
```solidity
File: contracts/tokens/ERC20Minimal.sol

9: abstract contract ERC20Minimal {

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L9-L9))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L6-L6))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

11: interface IERC20Partial {

```
([11](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L11-L11))
```solidity
File: contracts/types/LeftRight.sol

17: library LeftRightLibrary {

```
([17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L17-L17))
```solidity
File: contracts/types/LiquidityChunk.sol

52: library LiquidityChunkLibrary {

```
([52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L52-L52))
```solidity
File: contracts/types/TokenId.sol

60: library TokenIdLibrary {

```
([60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L60-L60))
### <a name="NC-104"></a>[NC-104] Upgrade openzeppelin to the Latest Version - 5.0.0

*There are 5 Instances of this issue* :
```solidity
File: contracts/PanopticFactory.sol

14: import {Clones} from "@openzeppelin/contracts/proxy/Clones.sol";

```
([14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L14-L14))
```solidity
File: contracts/PanopticPool.sol

9: import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L9-L9))
```solidity
File: contracts/libraries/InteractionHelper.sol

6: import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";

10: import {Strings} from "@openzeppelin/contracts/utils/Strings.sol";

```
([6](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L6-L6),[10](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L10-L10))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

5: import {ERC1155Holder} from "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";

```
([5](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L5-L5))
### <a name="NC-105"></a>[NC-105] `internal` functions not called by the contract should be removed

*There are 82 Instances of this issue* :
```solidity
File: contracts/libraries/CallbackLib.sol

30:     function validateCallback(
            address sender,
            IUniswapV3Factory factory,
            PoolFeatures memory features
        ) internal view {
            // Call getPool on the factory to verify that the sender corresponds to the canonical pool with the claimed features
            if (factory.getPool(features.token0, features.token1, features.fee) != sender)
                revert Errors.InvalidUniswapCallback();
        }

```
([30](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L30-L38))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {
            return a < b ? a : b;
        }

33:     function max24(int24 a, int24 b) internal pure returns (int24) {
            return a > b ? a : b;
        }

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {
            return a < b ? a : b;
        }

49:     function min(int256 a, int256 b) internal pure returns (int256) {
            return a < b ? a : b;
        }

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {
            return a > b ? a : b;
        }

65:     function max(int256 a, int256 b) internal pure returns (int256) {
            return a > b ? a : b;
        }

73:     function abs(int256 x) internal pure returns (int256) {
            return x > 0 ? x : -x;
        }

81:     function absUint(int256 x) internal pure returns (uint256) {
            unchecked {
                return x > 0 ? uint256(x) : uint256(-x);
            }
        }

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {
            unchecked {
                if (x >= 0x100000000000000000000000000000000) {
                    x >>= 128;
                    r += 32;
                }
                if (x >= 0x10000000000000000) {
                    x >>= 64;
                    r += 16;
                }
                if (x >= 0x100000000) {
                    x >>= 32;
                    r += 8;
                }
                if (x >= 0x10000) {
                    x >>= 16;
                    r += 4;
                }
                if (x >= 0x100) {
                    x >>= 8;
                    r += 2;
                }
                if (x >= 0x10) {
                    r += 1;
                }
            }
        }

221:     function getAmountsForLiquidity(
             int24 currentTick,
             LiquidityChunk liquidityChunk
         ) internal pure returns (uint256 amount0, uint256 amount1) {
             if (currentTick <= liquidityChunk.tickLower()) {
                 amount0 = getAmount0ForLiquidity(liquidityChunk);
             } else if (currentTick >= liquidityChunk.tickUpper()) {
                 amount1 = getAmount1ForLiquidity(liquidityChunk);
             } else {
                 amount0 = getAmount0ForLiquidity(liquidityChunk.updateTickLower(currentTick));
                 amount1 = getAmount1ForLiquidity(liquidityChunk.updateTickUpper(currentTick));
             }
         }

241:     function getLiquidityForAmount0(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount0
         ) internal pure returns (LiquidityChunk) {
             uint160 lowPriceX96 = getSqrtRatioAtTick(tickLower);
             uint160 highPriceX96 = getSqrtRatioAtTick(tickUpper);
     
             unchecked {
                 return
                     LiquidityChunkLibrary.createChunk(
                         tickLower,
                         tickUpper,
                         toUint128(
                             mulDiv(
                                 amount0,
                                 mulDiv96(highPriceX96, lowPriceX96),
                                 highPriceX96 - lowPriceX96
                             )
                         )
                     );
             }
         }

271:     function getLiquidityForAmount1(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount1
         ) internal pure returns (LiquidityChunk) {
             uint160 lowPriceX96 = getSqrtRatioAtTick(tickLower);
             uint160 highPriceX96 = getSqrtRatioAtTick(tickUpper);
     
             unchecked {
                 return
                     LiquidityChunkLibrary.createChunk(
                         tickLower,
                         tickUpper,
                         toUint128(mulDiv(amount1, Constants.FP96, highPriceX96 - lowPriceX96))
                     );
             }
         }

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {
             if ((downcastedInt = uint128(toDowncast)) != toDowncast) {
                 downcastedInt = type(uint128).max;
             }
         }

311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {
             if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();
         }

318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {
             if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();
         }

325:     function toInt256(uint256 toCast) internal pure returns (int256) {
             if (toCast > uint256(type(int256).max)) revert Errors.CastingError();
             return int256(toCast);
         }

440:     function mulDivRoundingUp(
             uint256 a,
             uint256 b,
             uint256 denominator
         ) internal pure returns (uint256 result) {
             unchecked {
                 result = mulDiv(a, b, denominator);
                 if (mulmod(a, b, denominator) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }
             }
         }

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {
             unchecked {
                 // 512-bit multiply [prod1 prod0] = a * b
                 // Compute the product mod 2**256 and mod 2**256 - 1
                 // then use the Chinese Remainder Theorem to reconstruct
                 // the 512 bit result. The result is stored in two 256
                 // variables such that product = prod1 * 2**256 + prod0
                 uint256 prod0; // Least significant 256 bits of the product
                 uint256 prod1; // Most significant 256 bits of the product
                 assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }
     
                 // Handle non-overflow cases, 256 by 256 division
                 if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(64, prod0)
                     }
                     return res;
                 }
     
                 // Make sure the result is less than 2**256.
                 require(2 ** 64 > prod1);
     
                 ///////////////////////////////////////////////
                 // 512 by 256 division.
                 ///////////////////////////////////////////////
     
                 // Make division exact by subtracting the remainder from [prod1 prod0]
                 // Compute remainder using mulmod
                 uint256 remainder;
                 assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x10000000000000000)
                 }
                 // Subtract 256 bit number from 512 bit number
                 assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }
     
                 // Divide [prod1 prod0] by the factors of two (note that this is just 2**96 since the denominator is a power of 2 itself)
                 assembly ("memory-safe") {
                     // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                     prod0 := shr(64, prod0)
                 }
                 // Shift in bits from prod1 into prod0. For this we need
                 // to flip `twos` such that it is 2**256 / twos.
                 // If twos is zero, then it becomes one
                 // Note that this is just 2**192 since 2**256 over the fixed denominator (2**64) equals 2**192
                 prod0 |= prod1 * 2 ** 192;
     
                 return prod0;
             }
         }

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
             unchecked {
                 result = mulDiv96(a, b);
                 if (mulmod(a, b, 2 ** 96) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }
             }
         }

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
             unchecked {
                 result = mulDiv128(a, b);
                 if (mulmod(a, b, 2 ** 128) > 0) {
                     require(result < type(uint256).max);
                     result++;
                 }
             }
         }

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {
             unchecked {
                 // 512-bit multiply [prod1 prod0] = a * b
                 // Compute the product mod 2**256 and mod 2**256 - 1
                 // then use the Chinese Remainder Theorem to reconstruct
                 // the 512 bit result. The result is stored in two 256
                 // variables such that product = prod1 * 2**256 + prod0
                 uint256 prod0; // Least significant 256 bits of the product
                 uint256 prod1; // Most significant 256 bits of the product
                 assembly ("memory-safe") {
                     let mm := mulmod(a, b, not(0))
                     prod0 := mul(a, b)
                     prod1 := sub(sub(mm, prod0), lt(mm, prod0))
                 }
     
                 // Handle non-overflow cases, 256 by 256 division
                 if (prod1 == 0) {
                     uint256 res;
                     assembly ("memory-safe") {
                         // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                         res := shr(192, prod0)
                     }
                     return res;
                 }
     
                 // Make sure the result is less than 2**256.
                 require(2 ** 192 > prod1);
     
                 ///////////////////////////////////////////////
                 // 512 by 256 division.
                 ///////////////////////////////////////////////
     
                 // Make division exact by subtracting the remainder from [prod1 prod0]
                 // Compute remainder using mulmod
                 uint256 remainder;
                 assembly ("memory-safe") {
                     remainder := mulmod(a, b, 0x1000000000000000000000000000000000000000000000000)
                 }
                 // Subtract 256 bit number from 512 bit number
                 assembly ("memory-safe") {
                     prod1 := sub(prod1, gt(remainder, prod0))
                     prod0 := sub(prod0, remainder)
                 }
     
                 // Divide [prod1 prod0] by the factors of two (note that this is just 2**96 since the denominator is a power of 2 itself)
                 assembly ("memory-safe") {
                     // Right shift by n is equivalent and 2 gas cheaper than division by 2^n
                     prod0 := shr(192, prod0)
                 }
                 // Shift in bits from prod1 into prod0. For this we need
                 // to flip `twos` such that it is 2**256 / twos.
                 // If twos is zero, then it becomes one
                 // Note that this is just 2**64 since 2**256 over the fixed denominator (2**192) equals 2**64
                 prod0 |= prod1 * 2 ** 64;
     
                 return prod0;
             }
         }

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {
             assembly ("memory-safe") {
                 result := add(div(a, b), gt(mod(a, b), 0))
             }
         }

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {
             unchecked {
                 quickSort(data, int256(0), int256(data.length - 1));
             }
             return data;
         }

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L27),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L35),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L43),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L51),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L59),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L67),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L75),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L81-L85),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L91-L117),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L221-L233),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L241-L263),[271](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L271-L287),[302](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L302-L306),[311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L311-L313),[318](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L318-L320),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L325-L328),[440](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L440-L452),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L515),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L584-L592),[661](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L661-L669),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L732),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L742),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L781))
```solidity
File: contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {
            unchecked {
                int24 tickSpacing = IUniswapV3Pool(univ3pool).tickSpacing();
                uint64 poolId = uint64(uint160(univ3pool) >> 112);
                poolId += uint64(uint24(tickSpacing)) << 48;
                return poolId;
            }
        }

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {
            unchecked {
                // increment
                return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);
            }
        }

92:     function updatePositionsHash(
            uint256 existingHash,
            TokenId tokenId,
            bool addFlag
        ) internal pure returns (uint256) {
            // add the XOR`ed hash of the single option position `tokenId` to the `existingHash`
            // @dev 0 ^ x = x
    
            unchecked {
                // update hash by taking the XOR of the new tokenId
                uint248 updatedHash = uint248(existingHash) ^
                    (uint248(uint256(keccak256(abi.encode(tokenId)))));
                // increment the top 8 bit if addflag=true, decrement otherwise
                return
                    addFlag
                        ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)
                        : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);
            }
        }

289:     function getLiquidityChunk(
             TokenId tokenId,
             uint256 legIndex,
             uint128 positionSize
         ) internal pure returns (LiquidityChunk) {
             // get the tick range for this leg
             (int24 tickLower, int24 tickUpper) = tokenId.asTicks(legIndex);
     
             // Get the amount of liquidity owned by this leg in the univ3 pool in the above tick range
             // Background:
             //
             //  In Uniswap v3, the amount of liquidity received for a given amount of token0 when the price is
             //  not in range is given by:
             //     Liquidity = amount0 * (sqrt(upper) * sqrt(lower)) / (sqrt(upper) - sqrt(lower))
             //  For token1, it is given by:
             //     Liquidity = amount1 / (sqrt(upper) - sqrt(lower))
             //
             //  However, in Panoptic, each position has a asset parameter. The asset is the "basis" of the position.
             //  In TradFi, the asset is always cash and selling a $1000 put requires the user to lock $1000, and selling
             //  a call requires the user to lock 1 unit of asset.
             //
             //  Because Uni v3 chooses token0 and token1 from the alphanumeric order, there is no consistency as to whether token0 is
             //  stablecoin, ETH, or an ERC20. Some pools may want ETH to be the asset (e.g. ETH-DAI) and some may wish the stablecoin to
             //  be the asset (e.g. DAI-ETH) so that K asset is moved for puts and 1 asset is moved for calls.
             //  But since the convention is to force the order always we have no say in this.
             //
             //  To solve this, we encode the asset value in tokenId. This parameter specifies which of token0 or token1 is the
             //  asset, such that:
             //     when asset=0, then amount0 moved at strike K =1.0001**currentTick is 1, amount1 moved to strike K is 1/K
             //     when asset=1, then amount1 moved at strike K =1.0001**currentTick is K, amount0 moved to strike K is 1
             //
             //  The following function takes this into account when computing the liquidity of the leg and switches between
             //  the definition for getLiquidityForAmount0 or getLiquidityForAmount1 when relevant.
             //
             //
             uint256 amount = uint256(positionSize) * tokenId.optionRatio(legIndex);
             if (tokenId.asset(legIndex) == 0) {
                 return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);
             } else {
                 return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);
             }
         }

338:     function getTicks(
             int24 strike,
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24 tickLower, int24 tickUpper) {
             unchecked {
                 // The max/min ticks that can be initialized are the closest multiple of tickSpacing to the actual max/min tick abs()=887272
                 // Dividing and multiplying by tickSpacing rounds down and forces the tick to be a multiple of tickSpacing
                 int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;
                 int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;
     
                 (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(width, tickSpacing);
     
                 (tickLower, tickUpper) = (strike - rangeDown, strike + rangeUp);
     
                 // Revert if the upper/lower ticks are not multiples of tickSpacing
                 // Revert if the tick range extends from the strike outside of the valid tick range
                 // These are invalid states, and would revert silently later in `univ3Pool.mint`
                 if (
                     tickLower % tickSpacing != 0 ||
                     tickUpper % tickSpacing != 0 ||
                     tickLower < minTick ||
                     tickUpper > maxTick
                 ) revert Errors.TicksNotInitializable();
             }
         }

371:     function getRangesFromStrike(
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24, int24) {
             return (
                 (width * tickSpacing) / 2,
                 int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))
             );
         }

390:     function computeExercisedAmounts(
             TokenId tokenId,
             uint128 positionSize
         ) internal pure returns (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) {
             uint256 numLegs = tokenId.countLegs();
             for (uint256 leg = 0; leg < numLegs; ) {
                 // Compute the amount of funds that have been removed from the Panoptic Pool
                 (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(
                     tokenId,
                     positionSize,
                     leg
                 );
     
                 longAmounts = longAmounts.add(longs);
                 shortAmounts = shortAmounts.add(shorts);
     
                 unchecked {
                     ++leg;
                 }
             }
         }

468:     function convertNotional(
             uint128 contractSize,
             int24 tickLower,
             int24 tickUpper,
             uint256 asset
         ) internal pure returns (uint128) {
             unchecked {
                 uint256 notional = asset == 0
                     ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))
                     : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));
     
                 if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();
     
                 return uint128(notional);
             }
         }

```
([47](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L47-L54),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L59-L64),[92](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L92-L110),[289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L289-L330),[338](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L338-L363),[371](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L371-L379),[390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L390-L410),[468](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L468-L483))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {
            bool success;
    
            assembly ("memory-safe") {
                // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
                let p := mload(0x40)
    
                // Write the abi-encoded calldata into memory, beginning with the function selector.
                mstore(p, 0x23b872dd00000000000000000000000000000000000000000000000000000000)
                mstore(add(4, p), from) // Append the "from" argument.
                mstore(add(36, p), to) // Append the "to" argument.
                mstore(add(68, p), amount) // Append the "amount" argument.
    
                success := and(
                    // Set success to whether the call reverted, if not we check it either
                    // returned exactly 1 (can't just be non-zero data), or had no return data.
                    or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
                    // We use 100 because that's the total length of our calldata (4 + 32 * 3)
                    // Counterintuitively, this call() must be positioned after the or() in the
                    // surrounding and() because and() evaluates its arguments from right to left.
                    call(gas(), token, 0, p, 100, 0, 32)
                )
            }
    
            if (!success) revert Errors.TransferFailed();
        }

52:     function safeTransfer(address token, address to, uint256 amount) internal {
            bool success;
    
            assembly ("memory-safe") {
                // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
                let p := mload(0x40)
    
                // Write the abi-encoded calldata into memory, beginning with the function selector.
                mstore(p, 0xa9059cbb00000000000000000000000000000000000000000000000000000000)
                mstore(add(4, p), to) // Append the "to" argument.
                mstore(add(36, p), amount) // Append the "amount" argument.
    
                success := and(
                    // Set success to whether the call reverted, if not we check it either
                    // returned exactly 1 (can't just be non-zero data), or had no return data.
                    or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
                    // We use 68 because that's the total length of our calldata (4 + 32 * 2)
                    // Counterintuitively, this call() must be positioned after the or() in the
                    // surrounding and() because and() evaluates its arguments from right to left.
                    call(gas(), token, 0, p, 68, 0, 32)
                )
            }
    
            if (!success) revert Errors.TransferFailed();
        }

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L46),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L76))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

214:     function _mint(address to, uint256 id, uint256 amount) internal {
             // balance will never overflow
             unchecked {
                 balanceOf[to][id] += amount;
             }
     
             emit TransferSingle(msg.sender, address(0), to, id, amount);
     
             if (to.code.length != 0) {
                 if (
                     ERC1155Holder(to).onERC1155Received(msg.sender, address(0), id, amount, "") !=
                     ERC1155Holder.onERC1155Received.selector
                 ) {
                     revert UnsafeRecipient();
                 }
             }
         }

236:     function _burn(address from, uint256 id, uint256 amount) internal {
             balanceOf[from][id] -= amount;
     
             emit TransferSingle(msg.sender, from, address(0), id, amount);
         }

```
([214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L230),[236](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L236-L240))
```solidity
File: contracts/tokens/ERC20Minimal.sol

103:     function _transferFrom(address from, address to, uint256 amount) internal {
             balanceOf[from] -= amount;
     
             // Cannot overflow because the sum of all user
             // balances can't exceed the max uint256 value.
             unchecked {
                 balanceOf[to] += amount;
             }
     
             emit Transfer(from, to, amount);
         }

122:     function _mint(address to, uint256 amount) internal {
             // Cannot overflow because the sum of all user
             // balances can't exceed the max uint256 value.
             unchecked {
                 balanceOf[to] += amount;
             }
             totalSupply += amount;
     
             emit Transfer(address(0), to, amount);
         }

136:     function _burn(address from, uint256 amount) internal {
             balanceOf[from] -= amount;
     
             // Cannot underflow because a user's balance
             // will never be larger than the total supply.
             unchecked {
                 totalSupply -= amount;
             }
     
             emit Transfer(from, address(0), amount);
         }

```
([103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L113),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L131),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L136-L146))
```solidity
File: contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {
            return uint128(LeftRightUnsigned.unwrap(self));
        }

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {
            return int128(LeftRightSigned.unwrap(self));
        }

59:     function toRightSlot(
            LeftRightUnsigned self,
            uint128 right
        ) internal pure returns (LeftRightUnsigned) {
            unchecked {
                // prevent the right slot from leaking into the left one in the case of an overflow
                // ff + 1 = (1)00, but we want just ff + 1 = 00
                return
                    LeftRightUnsigned.wrap(
                        (LeftRightUnsigned.unwrap(self) & LEFT_HALF_BIT_MASK) +
                            uint256(uint128(LeftRightUnsigned.unwrap(self)) + right)
                    );
            }
        }

78:     function toRightSlot(
            LeftRightSigned self,
            int128 right
        ) internal pure returns (LeftRightSigned) {
            // bit mask needed in case rightHalfBitPattern < 0 due to 2's complement
            unchecked {
                // prevent the right slot from leaking into the left one in the case of a positive sign change
                // ff + 1 = (1)00, but we want just ff + 1 = 00
                return
                    LeftRightSigned.wrap(
                        (LeftRightSigned.unwrap(self) & LEFT_HALF_BIT_MASK_INT) +
                            (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)
                    );
            }
        }

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {
             return uint128(LeftRightUnsigned.unwrap(self) >> 128);
         }

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {
             return int128(LeftRightSigned.unwrap(self) >> 128);
         }

121:     function toLeftSlot(
             LeftRightUnsigned self,
             uint128 left
         ) internal pure returns (LeftRightUnsigned) {
             unchecked {
                 return LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(self) + (uint256(left) << 128));
             }
         }

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {
             unchecked {
                 return LeftRightSigned.wrap(LeftRightSigned.unwrap(self) + (int256(left) << 128));
             }
         }

148:     function add(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {
             unchecked {
                 // adding leftRight packed uint128's is same as just adding the values explictily
                 // given that we check for overflows of the left and right values
                 z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) + LeftRightUnsigned.unwrap(y));
     
                 // on overflow z will be less than either x or y
                 // type cast z to uint128 to isolate the right slot and if it's lower than a value it's comprised of (x)
                 // then an overflow has occured
                 if (
                     LeftRightUnsigned.unwrap(z) < LeftRightUnsigned.unwrap(x) ||
                     (uint128(LeftRightUnsigned.unwrap(z)) < uint128(LeftRightUnsigned.unwrap(x)))
                 ) revert Errors.UnderOverFlow();
             }
         }

171:     function sub(
             LeftRightUnsigned x,
             LeftRightUnsigned y
         ) internal pure returns (LeftRightUnsigned z) {
             unchecked {
                 // subtracting leftRight packed uint128's is same as just subtracting the values explictily
                 // given that we check for underflows of the left and right values
                 z = LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(x) - LeftRightUnsigned.unwrap(y));
     
                 // on underflow z will be greater than either x or y
                 // type cast z to uint128 to isolate the right slot and if it's higher than a value that was subtracted from (x)
                 // then an underflow has occured
                 if (
                     LeftRightUnsigned.unwrap(z) > LeftRightUnsigned.unwrap(x) ||
                     (uint128(LeftRightUnsigned.unwrap(z)) > uint128(LeftRightUnsigned.unwrap(x)))
                 ) revert Errors.UnderOverFlow();
             }
         }

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
             unchecked {
                 int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();
                 int128 left128 = int128(left);
     
                 if (left128 != left) revert Errors.UnderOverFlow();
     
                 int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();
                 int128 right128 = int128(right);
     
                 if (right128 != right) revert Errors.UnderOverFlow();
     
                 return z.toRightSlot(right128).toLeftSlot(left128);
             }
         }

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
             unchecked {
                 int256 left256 = int256(x.leftSlot()) + y.leftSlot();
                 int128 left128 = int128(left256);
     
                 int256 right256 = int256(x.rightSlot()) + y.rightSlot();
                 int128 right128 = int128(right256);
     
                 if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
     
                 return z.toRightSlot(right128).toLeftSlot(left128);
             }
         }

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
             unchecked {
                 int256 left256 = int256(x.leftSlot()) - y.leftSlot();
                 int128 left128 = int128(left256);
     
                 int256 right256 = int256(x.rightSlot()) - y.rightSlot();
                 int128 right128 = int128(right256);
     
                 if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
     
                 return z.toRightSlot(right128).toLeftSlot(left128);
             }
         }

251:     function subRect(
             LeftRightSigned x,
             LeftRightSigned y
         ) internal pure returns (LeftRightSigned z) {
             unchecked {
                 int256 left256 = int256(x.leftSlot()) - y.leftSlot();
                 int128 left128 = int128(left256);
     
                 int256 right256 = int256(x.rightSlot()) - y.rightSlot();
                 int128 right128 = int128(right256);
     
                 if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
     
                 return
                     z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(
                         int128(Math.max(left128, 0))
                     );
             }
         }

279:     function addCapped(
             LeftRightUnsigned x,
             LeftRightUnsigned dx,
             LeftRightUnsigned y,
             LeftRightUnsigned dy
         ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {
             uint128 z_xR = (uint256(x.rightSlot()) + dx.rightSlot()).toUint128Capped();
             uint128 z_xL = (uint256(x.leftSlot()) + dx.leftSlot()).toUint128Capped();
             uint128 z_yR = (uint256(y.rightSlot()) + dy.rightSlot()).toUint128Capped();
             uint128 z_yL = (uint256(y.leftSlot()) + dy.leftSlot()).toUint128Capped();
     
             bool r_Enabled = !(z_xR == type(uint128).max || z_yR == type(uint128).max);
             bool l_Enabled = !(z_xL == type(uint128).max || z_yL == type(uint128).max);
     
             return (
                 LeftRightUnsigned.wrap(0).toRightSlot(r_Enabled ? z_xR : x.rightSlot()).toLeftSlot(
                     l_Enabled ? z_xL : x.leftSlot()
                 ),
                 LeftRightUnsigned.wrap(0).toRightSlot(r_Enabled ? z_yR : y.rightSlot()).toLeftSlot(
                     l_Enabled ? z_yL : y.leftSlot()
                 )
             );
         }

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L41),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L48),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L59-L72),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L78-L92),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L103),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L110),[121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L121-L128),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L148-L165),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L171-L188),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L208),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L226),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L244),[251](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L251-L269),[279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L279-L301))
```solidity
File: contracts/types/LiquidityChunk.sol

70:     function createChunk(
            int24 _tickLower,
            int24 _tickUpper,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return
                    LiquidityChunk.wrap(
                        (uint256(uint24(_tickLower)) << 232) +
                            (uint256(uint24(_tickUpper)) << 208) +
                            uint256(amount)
                    );
            }
        }

89:     function addLiquidity(
            LiquidityChunk self,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {
            unchecked {
                return LiquidityChunk.wrap(LiquidityChunk.unwrap(self) + amount);
            }
        }

102:     function addTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {
             unchecked {
                 return
                     LiquidityChunk.wrap(
                         LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)
                     );
             }
         }

118:     function addTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {
             unchecked {
                 // convert tick upper to uint24 as explicit conversion from int24 to uint256 is not allowed
                 return
                     LiquidityChunk.wrap(
                         LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)
                     );
             }
         }

135:     function updateTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {
             unchecked {
                 return
                     LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TL_MASK).addTickLower(
                         _tickLower
                     );
             }
         }

151:     function updateTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {
             unchecked {
                 // convert tick upper to uint24 as explicit conversion from int24 to uint256 is not allowed
                 return
                     LiquidityChunk.wrap(LiquidityChunk.unwrap(self) & CLEAR_TU_MASK).addTickUpper(
                         _tickUpper
                     );
             }
         }

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {
             unchecked {
                 return int24(int256(LiquidityChunk.unwrap(self) >> 232));
             }
         }

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {
             unchecked {
                 return int24(int256(LiquidityChunk.unwrap(self) >> 208));
             }
         }

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {
             unchecked {
                 return uint128(LiquidityChunk.unwrap(self));
             }
         }

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L70-L83),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L89-L96),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L102-L112),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L118-L129),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L135-L145),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L151-L162),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L175),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L184),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L193))
```solidity
File: contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {
            unchecked {
                return uint64(TokenId.unwrap(self));
            }
        }

96:     function tickSpacing(TokenId self) internal pure returns (int24) {
            unchecked {
                return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));
            }
        }

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {
             unchecked {
                 return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48)) % 2);
             }
         }

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {
             unchecked {
                 return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 1)) % 128);
             }
         }

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {
             unchecked {
                 return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 8)) % 2);
             }
         }

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {
             unchecked {
                 return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 9)) % 2);
             }
         }

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {
             unchecked {
                 return uint256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 10)) % 4);
             }
         }

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {
             unchecked {
                 return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));
             }
         }

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {
             unchecked {
                 return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));
             } // "% 4096" = take last (2 ** 12 = 4096) 12 bits
         }

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {
             unchecked {
                 return TokenId.wrap(TokenId.unwrap(self) + _poolId);
             }
         }

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {
             unchecked {
                 return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));
             }
         }

336:     function addLeg(
             TokenId self,
             uint256 legIndex,
             uint256 _optionRatio,
             uint256 _asset,
             uint256 _isLong,
             uint256 _tokenType,
             uint256 _riskPartner,
             int24 _strike,
             int24 _width
         ) internal pure returns (TokenId tokenId) {
             tokenId = addOptionRatio(self, _optionRatio, legIndex);
             tokenId = addAsset(tokenId, _asset, legIndex);
             tokenId = addIsLong(tokenId, _isLong, legIndex);
             tokenId = addTokenType(tokenId, _tokenType, legIndex);
             tokenId = addRiskPartner(tokenId, _riskPartner, legIndex);
             tokenId = addStrike(tokenId, _strike, legIndex);
             tokenId = addWidth(tokenId, _width, legIndex);
         }

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {
             unchecked {
                 // NOTE: This is a hack to avoid blowing up the contract size.
                 // We copy the logic from the countLegs function, using it here adds 5K to the contract size with IR for some reason
                 // Strip all bits except for the option ratios
                 uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;
     
                 // The legs are filled in from least to most significant
                 // Each comparison here is to the start of the next leg's option ratio
                 // Since only the option ratios remain, we can be sure that no bits above the start of the inactive legs will be 1
                 if (optionRatios < 2 ** 64) {
                     optionRatios = 0;
                 } else if (optionRatios < 2 ** 112) {
                     optionRatios = 1;
                 } else if (optionRatios < 2 ** 160) {
                     optionRatios = 2;
                 } else if (optionRatios < 2 ** 208) {
                     optionRatios = 3;
                 } else {
                     optionRatios = 4;
                 }
     
                 // We need to ensure that only active legs are flipped
                 // In order to achieve this, we shift our long bit mask to the right by (4-# active legs)
                 // i.e the whole mask is used to flip all legs with 4 legs, but only the first leg is flipped with 1 leg so we shift by 3 legs
                 // We also clear the poolId area of the mask to ensure the bits that are shifted right into the area don't flip and cause issues
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) ^
                             ((LONG_MASK >> (48 * (4 - optionRatios))) & CLEAR_POOLID_MASK)
                     );
             }
         }

404:     function countLongs(TokenId self) internal pure returns (uint256) {
             unchecked {
                 return self.isLong(0) + self.isLong(1) + self.isLong(2) + self.isLong(3);
             }
         }

416:     function asTicks(
             TokenId self,
             uint256 legIndex
         ) internal pure returns (int24 legLowerTick, int24 legUpperTick) {
             (legLowerTick, legUpperTick) = PanopticMath.getTicks(
                 self.strike(legIndex),
                 self.width(legIndex),
                 self.tickSpacing()
             );
         }

432:     function countLegs(TokenId self) internal pure returns (uint256) {
             // Strip all bits except for the option ratios
             uint256 optionRatios = TokenId.unwrap(self) & OPTION_RATIO_MASK;
     
             // The legs are filled in from least to most significant
             // Each comparison here is to the start of the next leg's option ratio section
             // Since only the option ratios remain, we can be sure that no bits above the start of the inactive legs will be 1
             if (optionRatios < 2 ** 64) {
                 return 0;
             } else if (optionRatios < 2 ** 112) {
                 return 1;
             } else if (optionRatios < 2 ** 160) {
                 return 2;
             } else if (optionRatios < 2 ** 208) {
                 return 3;
             }
             return 4;
         }

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {
             if (i == 0)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFFFFFF
                     );
             if (i == 1)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_FFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );
             if (i == 2)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0xFFFFFFFFFFFF_000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );
             if (i == 3)
                 return
                     TokenId.wrap(
                         TokenId.unwrap(self) &
                             0x000000000000_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFF_FFFFFFFFFFFFFFFF
                     );
     
             return self;
         }

500:     function validate(TokenId self) internal pure {
             if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);
     
             // loop through the 4 (possible) legs in the tokenId `self`
             unchecked {
                 // extract strike, width, and tokenType
                 uint256 chunkData = (TokenId.unwrap(self) & CHUNK_MASK) >> 64;
                 for (uint256 i = 0; i < 4; ++i) {
                     if (self.optionRatio(i) == 0) {
                         // final leg in this position identified;
                         // make sure any leg above this are zero as well
                         // (we don't allow gaps eg having legs 1 and 4 active without 2 and 3 is not allowed)
                         if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)
                             revert Errors.InvalidTokenIdParameter(1);
     
                         break; // we are done iterating over potential legs
                     }
     
                     // prevent legs touching the same chunks - all chunks in the position must be discrete
                     uint256 numLegs = self.countLegs();
                     for (uint256 j = i + 1; j < numLegs; ++j) {
                         if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {
                             revert Errors.InvalidTokenIdParameter(6);
                         }
                     }
                     // now validate this ith leg in the position:
     
                     // The width cannot be 0; the minimum is 1
                     if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);
                     // Strike cannot be MIN_TICK or MAX_TICK
                     if (
                         (self.strike(i) == Constants.MIN_V3POOL_TICK) ||
                         (self.strike(i) == Constants.MAX_V3POOL_TICK)
                     ) revert Errors.InvalidTokenIdParameter(4);
     
                     // In the following, we check whether the risk partner of this leg is itself
                     // or another leg in this position.
                     // Handles case where riskPartner(i) != i ==> leg i has a risk partner that is another leg
                     uint256 riskPartnerIndex = self.riskPartner(i);
                     if (riskPartnerIndex != i) {
                         // Ensures that risk partners are mutual
                         if (self.riskPartner(riskPartnerIndex) != i)
                             revert Errors.InvalidTokenIdParameter(3);
     
                         // Ensures that risk partners have 1) the same asset, and 2) the same ratio
                         if (
                             (self.asset(riskPartnerIndex) != self.asset(i)) ||
                             (self.optionRatio(riskPartnerIndex) != self.optionRatio(i))
                         ) revert Errors.InvalidTokenIdParameter(3);
     
                         // long/short status of associated legs
                         uint256 _isLong = self.isLong(i);
                         uint256 isLongP = self.isLong(riskPartnerIndex);
     
                         // token type status of associated legs (call/put)
                         uint256 _tokenType = self.tokenType(i);
                         uint256 tokenTypeP = self.tokenType(riskPartnerIndex);
     
                         // if the position is the same i.e both long calls, short put's etc.
                         // then this is a regular position, not a defined risk position
                         if ((_isLong == isLongP) && (_tokenType == tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(4);
     
                         // if the two token long-types and the tokenTypes are both different (one is a short call, the other a long put, e.g.), this is a synthetic position
                         // A synthetic long or short is more capital efficient than each leg separated because the long+short premia accumulate proportionally
                         // unlike short stranlges, long strangles also cannot be partnered, because there is no reduction in risk (both legs can earn premia simultaneously)
                         if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))
                             revert Errors.InvalidTokenIdParameter(5);
                     }
                 } // end for loop over legs
             }
         }

578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {
             unchecked {
                 uint256 numLegs = self.countLegs();
                 for (uint256 i = 0; i < numLegs; ++i) {
                     (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(
                         self.width(i),
                         self.tickSpacing()
                     );
     
                     int24 _strike = self.strike(i);
                     // check if the price is outside this chunk
                     if ((currentTick >= _strike + rangeUp) || (currentTick < _strike - rangeDown)) {
                         // if this leg is long and the price beyond the leg's range:
                         // this exercised ID, `self`, appears valid
                         if (self.isLong(i) == 1) return; // validated
                     }
                 }
             }
     
             // Fail if position has no legs that is far-out-of-the-money
             revert Errors.NoLegsExercisable();
         }

```
([87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L91),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L100),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L112),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L122),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L132),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L142),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L152),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L162),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L173),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L187),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L197),[336](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L336-L354),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L366-L398),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L408),[416](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L416-L425),[432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L432-L449),[464](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L464-L491),[500](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L500-L571),[578](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L578-L599))
### <a name="NC-106"></a>[NC-106] Consider using named returns
Using named returns makes the code more self-documenting, makes it easier to fill out NatSpec, and in some cases can save gas. The cases below are where there currently is at most one return statement, which is ideal for named returns.

*There are 113 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

289:     function name() external view returns (string memory) {

303:     function symbol() external view returns (string memory) {

310:     function decimals() external view returns (uint8) {

323:     function transfer(
             address recipient,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
             address from,
             address to,
             uint256 amount
         ) public override(ERC20Minimal) returns (bool) {

1043:     function exercise(
              address optionOwner,
              int128 longAmount,
              int128 shortAmount,
              int128 swappedAmount,
              int128 realizedPremium
          ) external onlyPanopticPool returns (int128) {

```
([289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L289-L289),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L303-L303),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L310-L310),[323](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L323-L326),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L341-L345),[1043](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1043-L1049))
```solidity
File: contracts/PanopticFactory.sol

159:     function owner() external view returns (address) {

335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

335:     function _mintFullRange(
             IUniswapV3Pool v3Pool,
             address token0,
             address token1,
             uint24 fee
         ) internal returns (uint256, uint256) {

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L159-L159),[335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340),[335](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L335-L340),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

381:     function calculateAccumulatedFeesBatch(
             address user,
             bool includePendingPremium,
             TokenId[] calldata positionIdList
         ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

499:     function _getSlippageLimits(
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal pure returns (int24, int24) {

499:     function _getSlippageLimits(
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal pure returns (int24, int24) {

677:     function _mintInSFPMAndUpdateCollateral(
             TokenId tokenId,
             uint128 positionSize,
             int24 tickLimitLow,
             int24 tickLimitHigh
         ) internal returns (uint128) {

706:     function _payCommissionAndWriteData(
             TokenId tokenId,
             uint128 positionSize,
             LeftRightSigned totalSwapped
         ) internal returns (uint128) {

1290:     function _checkSolvencyAtTick(
              address account,
              TokenId[] calldata positionIdList,
              int24 currentTick,
              int24 atTick,
              uint256 buffer
          ) internal view returns (bool) {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1437:     function collateralToken1() external view returns (CollateralTracker) {

1757:     function _getAvailablePremium(
              uint256 totalLiquidity,
              LeftRightUnsigned settledTokens,
              LeftRightUnsigned grossPremiumLast,
              LeftRightUnsigned premiumOwed,
              uint256[2] memory premiumAccumulators
          ) internal pure returns (LeftRightUnsigned) {

```
([381](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L381-L385),[499](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L499-L502),[499](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L499-L502),[677](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L677-L682),[706](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L706-L710),[1290](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1290-L1296),[1425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1425-L1425),[1437](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1437-L1437),[1757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1757-L1763))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1449:     function getAccountPremium(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper,
              int24 atTick,
              uint256 isLong
          ) external view returns (uint128, uint128) {

1449:     function getAccountPremium(
              address univ3pool,
              address owner,
              uint256 tokenType,
              int24 tickLower,
              int24 tickUpper,
              int24 atTick,
              uint256 isLong
          ) external view returns (uint128, uint128) {

```
([1449](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1449-L1457),[1449](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1449-L1457))
```solidity
File: contracts/libraries/FeesCalc.sol

97:     function calculateAMMSwapFees(
            IUniswapV3Pool univ3pool,
            int24 currentTick,
            int24 tickLower,
            int24 tickUpper,
            uint128 liquidity
        ) public view returns (LeftRightSigned) {

```
([97](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L97-L103))
```solidity
File: contracts/libraries/InteractionHelper.sol

48:     function computeName(
            address token0,
            address token1,
            bool isToken0,
            uint24 fee,
            string memory prefix
        ) external view returns (string memory) {

91:     function computeSymbol(
            address token,
            string memory prefix
        ) external view returns (string memory) {

107:     function computeDecimals(address token) external view returns (uint8) {

```
([48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L48-L54),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L91-L94),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L107-L107))
```solidity
File: contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

241:     function getLiquidityForAmount0(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount0
         ) internal pure returns (LiquidityChunk) {

271:     function getLiquidityForAmount1(
             int24 tickLower,
             int24 tickUpper,
             uint256 amount1
         ) internal pure returns (LiquidityChunk) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L73),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L81-L81),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L128-L128),[191](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L191-L191),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L207-L207),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L241-L245),[271](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L271-L275),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L325-L325),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

75:     function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {

92:     function updatePositionsHash(
            uint256 existingHash,
            TokenId tokenId,
            bool addFlag
        ) internal pure returns (uint256) {

125:     function computeMedianObservedPrice(
             IUniswapV3Pool univ3pool,
             uint256 observationIndex,
             uint256 observationCardinality,
             uint256 cardinality,
             uint256 period
         ) external view returns (int24) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

289:     function getLiquidityChunk(
             TokenId tokenId,
             uint256 legIndex,
             uint128 positionSize
         ) internal pure returns (LiquidityChunk) {

371:     function getRangesFromStrike(
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24, int24) {

371:     function getRangesFromStrike(
             int24 width,
             int24 tickSpacing
         ) internal pure returns (int24, int24) {

419:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             uint160 sqrtPriceX96
         ) internal pure returns (uint256, uint256) {

419:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             uint160 sqrtPriceX96
         ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             int24 tick
         ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint256 tokenType,
             int24 tick
         ) internal pure returns (uint256, uint256) {

468:     function convertNotional(
             uint128 contractSize,
             int24 tickLower,
             int24 tickUpper,
             uint256 asset
         ) internal pure returns (uint128) {

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

574:     function getAmountsMoved(
             TokenId tokenId,
             uint128 positionSize,
             uint256 legIndex
         ) internal pure returns (LeftRightUnsigned) {

651:     function getLiquidationBonus(
             LeftRightUnsigned tokenData0,
             LeftRightUnsigned tokenData1,
             uint160 sqrtPriceX96Twap,
             uint160 sqrtPriceX96Final,
             LeftRightSigned netExchanged,
             LeftRightSigned premia
         ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

768:     function haircutPremia(
             address liquidatee,
             TokenId[] memory positionIdList,
             LeftRightSigned[4][] memory premiasByLeg,
             LeftRightSigned collateralRemaining,
             CollateralTracker collateral0,
             CollateralTracker collateral1,
             uint160 sqrtPriceX96Final,
             mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
         ) external returns (int256, int256) {

917:     function getRefundAmounts(
             address refunder,
             LeftRightSigned refundValues,
             int24 atTick,
             CollateralTracker collateral0,
             CollateralTracker collateral1
         ) external view returns (LeftRightSigned) {

```
([47](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L47-L47),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L59-L59),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L75-L75),[92](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L92-L96),[125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L125-L131),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L241-L241),[289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L289-L293),[371](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L371-L374),[371](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L371-L374),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L419-L424),[419](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L419-L424),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L445-L450),[445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L445-L450),[468](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L468-L473),[490](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L490-L490),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L507-L507),[524](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L524-L524),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L547-L547),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L574-L578),[651](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L651-L658),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777),[768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L768-L777),[917](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L917-L923))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {

```
([200](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L200-L200))
```solidity
File: contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L81-L81))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

16:     function balanceOf(address account) external view returns (uint256);

```
([16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L16-L16))
```solidity
File: contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

59:     function toRightSlot(
            LeftRightUnsigned self,
            uint128 right
        ) internal pure returns (LeftRightUnsigned) {

78:     function toRightSlot(
            LeftRightSigned self,
            int128 right
        ) internal pure returns (LeftRightSigned) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

121:     function toLeftSlot(
             LeftRightUnsigned self,
             uint128 left
         ) internal pure returns (LeftRightUnsigned) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

279:     function addCapped(
             LeftRightUnsigned x,
             LeftRightUnsigned dx,
             LeftRightUnsigned y,
             LeftRightUnsigned dy
         ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {

279:     function addCapped(
             LeftRightUnsigned x,
             LeftRightUnsigned dx,
             LeftRightUnsigned y,
             LeftRightUnsigned dy
         ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L39),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L46),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L59-L62),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L78-L81),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L101),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L108),[121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L121-L124),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L134),[279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L279-L284),[279](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L279-L284))
```solidity
File: contracts/types/LiquidityChunk.sol

70:     function createChunk(
            int24 _tickLower,
            int24 _tickUpper,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

89:     function addLiquidity(
            LiquidityChunk self,
            uint128 amount
        ) internal pure returns (LiquidityChunk) {

102:     function addTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

118:     function addTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

135:     function updateTickLower(
             LiquidityChunk self,
             int24 _tickLower
         ) internal pure returns (LiquidityChunk) {

151:     function updateTickUpper(
             LiquidityChunk self,
             int24 _tickUpper
         ) internal pure returns (LiquidityChunk) {

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L70-L74),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L89-L92),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L102-L105),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L118-L121),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L135-L138),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L151-L154),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L171),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L180),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

205:     function addAsset(
             TokenId self,
             uint256 _asset,
             uint256 legIndex
         ) internal pure returns (TokenId) {

221:     function addOptionRatio(
             TokenId self,
             uint256 _optionRatio,
             uint256 legIndex
         ) internal pure returns (TokenId) {

240:     function addIsLong(
             TokenId self,
             uint256 _isLong,
             uint256 legIndex
         ) internal pure returns (TokenId) {

255:     function addTokenType(
             TokenId self,
             uint256 _tokenType,
             uint256 legIndex
         ) internal pure returns (TokenId) {

273:     function addRiskPartner(
             TokenId self,
             uint256 _riskPartner,
             uint256 legIndex
         ) internal pure returns (TokenId) {

291:     function addStrike(
             TokenId self,
             int24 _strike,
             uint256 legIndex
         ) internal pure returns (TokenId) {

310:     function addWidth(
             TokenId self,
             int24 _width,
             uint256 legIndex
         ) internal pure returns (TokenId) {

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

```
([87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L87),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L96),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L108),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L118),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L128),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L148),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L169),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L183),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L193),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L205-L209),[221](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L221-L225),[240](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L240-L244),[255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L255-L259),[273](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L273-L277),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L291-L295),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L310-L314),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L366-L366),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L404),[432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L432-L432),[464](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L464-L464))
### <a name="NC-107"></a>[NC-107] Consider using a format prettier or forge fmt
Some comments use // X and others //X Amend comments to use only use // X or //X consistently such style inconsistencies can be resolved by running the project through a format prettier or by using forge fmt.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1-L1))
```solidity
File: contracts/PanopticFactory.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L1-L1))
```solidity
File: contracts/PanopticPool.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1-L1))
```solidity
File: contracts/SemiFungiblePositionManager.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1-L1))
```solidity
File: contracts/libraries/CallbackLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L1-L1))
```solidity
File: contracts/libraries/Constants.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L1-L1))
```solidity
File: contracts/libraries/Errors.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Errors.sol#L1-L1))
```solidity
File: contracts/libraries/FeesCalc.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L1-L1))
```solidity
File: contracts/libraries/InteractionHelper.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L1-L1))
```solidity
File: contracts/libraries/Math.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L1-L1))
```solidity
File: contracts/libraries/PanopticMath.sol

1: // SPDX-License-Identifier: BUSL-1.1

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L1-L1))
```solidity
File: contracts/libraries/SafeTransferLib.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L1-L1))
```solidity
File: contracts/multicall/Multicall.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L1-L1))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/ERC20Minimal.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L1-L1))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L1-L1))
```solidity
File: contracts/types/LeftRight.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L1-L1))
```solidity
File: contracts/types/LiquidityChunk.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L1-L1))
```solidity
File: contracts/types/TokenId.sol

1: // SPDX-License-Identifier: GPL-2.0-or-later

```
([1](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L1-L1))
### <a name="NC-108"></a>[NC-108] Variable initialization with default value
It's not necessary to initialize a variable with its default value, and it's actually worse in gas terms as it adds an overhead.

*There are 5 Instances of this issue* :
```solidity
File: contracts/PanopticPool.sol

111:     bool internal constant COMPUTE_LONG_PREMIA = false;

114:     bool internal constant ONLY_AVAILABLE_PREMIUM = false;

120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

```
([111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L111-L111),[114](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L114-L114),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L120-L120),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L133-L133))
```solidity
File: contracts/SemiFungiblePositionManager.sol

125:     bool internal constant MINT = false;

```
([125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L125-L125))
### <a name="NC-109"></a>[NC-109] Avoid declaring variables/parameters with the names of defined functions within the project
Having such variables can create confusion in both developers and in users of the project. Consider renaming these variables to improve code clarity.

*There are 20 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

// @audit null
289:     function name() external view returns (string memory) {

// @audit null
303:     function symbol() external view returns (string memory) {

// @audit null
310:     function decimals() external view returns (uint8) {

// @audit null
326:     ) public override(ERC20Minimal) returns (bool) {

// @audit null
345:     ) public override(ERC20Minimal) returns (bool) {

// @audit null
392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

// @audit null
444:     function maxMint(address) external view returns (uint256 maxShares) {

// @audit null
1049:     ) external onlyPanopticPool returns (int128) {

```
([289](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L289-L289),[303](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L303-L303),[310](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L310-L310),[326](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L326-L326),[345](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L345-L345),[392](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L392-L392),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L444-L444),[1049](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1049-L1049))
```solidity
File: contracts/PanopticFactory.sol

// @audit null
159:     function owner() external view returns (address) {

// @audit null
340:     ) internal returns (uint256, uint256) {

// @audit null
420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([159](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L159-L159),[340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L340-L340),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

// @audit null
385:     ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

// @audit null
502:     ) internal pure returns (int24, int24) {

// @audit null
682:     ) internal returns (uint128) {

// @audit null
710:     ) internal returns (uint128) {

// @audit null
1296:     ) internal view returns (bool) {

// @audit null
1425:     function univ3pool() external view returns (IUniswapV3Pool) {

// @audit null
1437:     function collateralToken1() external view returns (CollateralTracker) {

// @audit null
1763:     ) internal pure returns (LeftRightUnsigned) {

```
([385](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L385-L385),[502](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L502-L502),[682](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L682-L682),[710](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L710-L710),[1296](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1296-L1296),[1425](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1425-L1425),[1437](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1437-L1437),[1763](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1763-L1763))
```solidity
File: contracts/SemiFungiblePositionManager.sol

// @audit null
1457:     ) external view returns (uint128, uint128) {

```
([1457](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1457-L1457))
### <a name="NC-110"></a>[NC-110] Variable/Parameters names don't follow the Solidity naming convention
Use `mixedCase` for local and state variables that are not constants, and add a trailing underscore for non-external variables. [Documentation](https://docs.soliditylang.org/en/latest/style-guide.html#local-and-state-variable-names)

*There are 633 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

49:     event Deposit(address indexed sender, address indexed owner, uint256 assets, uint256 shares);

58:         address indexed sender,

59:         address indexed receiver,

60:         address indexed owner,

61:         uint256 assets,

62:         uint256 shares

70:     string internal constant TICKER_PREFIX = "po";

73:     string internal constant NAME_PREFIX = "POPT-V1";

77:     uint256 internal constant DECIMALS = 10_000;

81:     int128 internal constant DECIMALS_128 = 10_000;

93:     bool internal s_initialized;

96:     address internal s_univ3token0;

99:     address internal s_univ3token1;

131:     uint256 immutable TICK_DEVIATION;

136:     uint256 immutable COMMISSION_FEE;

141:     uint256 immutable SELLER_COLLATERAL_RATIO;

145:     uint256 immutable BUYER_COLLATERAL_RATIO;

149:     int256 immutable FORCE_EXERCISE_COST;

154:     uint256 immutable TARGET_POOL_UTIL;

158:     uint256 immutable SATURATED_POOL_UTIL;

162:     uint256 immutable ITM_SPREAD_MULTIPLIER;

179:         uint256 _commissionFee,

180:         uint256 _sellerCollateralRatio,

181:         uint256 _buyerCollateralRatio,

182:         int256 _forceExerciseCost,

183:         uint256 _targetPoolUtilization,

184:         uint256 _saturatedPoolUtilization,

185:         uint256 _ITMSpreadMultiplier

223:         address token0,

224:         address token1,

225:         uint24 fee,

247:         uint24 _poolFee;

324:         address recipient,

325:         uint256 amount

342:         address from,

343:         address to,

344:         uint256 amount

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {

399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {

417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

453:     function previewMint(uint256 shares) public view returns (uint256 assets) {

477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

510:         uint256 available = s_poolAssets;

511:         uint256 balance = convertToAssets(balanceOf[owner]);

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

519:         uint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.

532:         uint256 assets,

533:         address receiver,

534:         address owner

535:     ) external returns (uint256 shares) {

542:             uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

573:         uint256 available = convertToShares(s_poolAssets);

574:         uint256 balance = balanceOf[owner];

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {

592:         uint256 shares,

593:         address receiver,

594:         address owner

595:     ) external returns (uint256 assets) {

600:             uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.

662:             for (uint256 leg = 0; leg < positionId.countLegs(); ++leg) {

667:                     int24 range = int24(

727:             int256 fee = (FORCE_EXERCISE_COST >> (maxNumRangesFromStrike - 1)); // exponential decay of fee based on number of half ranges away from the price

752:         int256 utilization

773:         uint256 min_sell_ratio = SELLER_COLLATERAL_RATIO;

807:         uint256 utilization

865:         address delegator,

866:         address delegatee,

867:         uint256 assets

883:         uint256 shares = convertToShares(assets);

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

912:         address delegator,

913:         address delegatee,

914:         uint256 assets

930:         uint256 shares = convertToShares(assets);

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

1000:     ) external onlyPanopticPool returns (int256 utilization) {

1142:         address user,

1160:         address user,

1208:         for (uint256 i = 0; i < totalIterations; ) {

1219:             uint256 _tokenRequired = _getRequiredCollateralAtTickSinglePosition(

1255:             for (uint256 index = 0; index < numLegs; ++index) {

1280:         uint256 index,

1284:     ) internal view returns (uint256 required) {

1313:         uint256 index,

1317:     ) internal view returns (uint256 required) {

1328:         int64 utilization = tokenType == 0

1352:                     int24 strike = tokenId.strike(index);

1362:                     uint160 ratio = tokenType == 1 // tokenType

1397:                         uint256 c2 = Constants.FP96 - ratio;

1411:                         uint256 c3 = Math.mulDivRoundingUp(

1441:         uint256 index,

1445:     ) internal view returns (uint256 required) {

1474:         uint128 amount,

1476:         int256 utilization

1477:     ) internal view returns (uint256 required) {

1513:         uint256 index,

1556:                 uint256 notional;

1558:                 uint128 contracts;

1602:         uint256 index,

```
([49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L49-L49),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L58-L58),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L59-L59),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L60-L60),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L61-L61),[62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L62-L62),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L70-L70),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L73-L73),[77](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L77-L77),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L81-L81),[93](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L93-L93),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L96-L96),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L99-L99),[131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L131-L131),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L136-L136),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L141-L141),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L145-L145),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L149-L149),[154](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L154-L154),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L158-L158),[162](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L162-L162),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L179-L179),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L180-L180),[181](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L181-L181),[182](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L182-L182),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L183-L183),[184](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L184-L184),[185](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L185-L185),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L223-L223),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L224-L224),[225](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L225-L225),[247](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L247-L247),[324](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L324-L324),[325](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L325-L325),[342](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L342-L342),[343](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L343-L343),[344](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L344-L344),[379](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L379-L379),[386](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L386-L386),[399](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L399-L399),[417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L417-L417),[453](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L453-L453),[477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L477-L477),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L507-L507),[510](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L510-L510),[511](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L511-L511),[518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L518-L518),[519](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L519-L519),[532](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L532-L532),[533](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L533-L533),[534](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L534-L534),[535](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L535-L535),[542](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L542-L542),[572](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L572-L572),[573](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L573-L573),[574](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L574-L574),[581](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L581-L581),[592](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L592-L592),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L593-L593),[594](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L594-L594),[595](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L595-L595),[600](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L600-L600),[662](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L662-L662),[667](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L667-L667),[727](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L727-L727),[752](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L752-L752),[773](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L773-L773),[807](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L807-L807),[865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L865-L865),[866](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L866-L866),[867](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L867-L867),[883](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L883-L883),[894](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L894-L894),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L903-L903),[912](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L912-L912),[913](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L913-L913),[914](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L914-L914),[930](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L930-L930),[975](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L975-L975),[1000](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1000-L1000),[1142](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1142-L1142),[1160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1160-L1160),[1208](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1208-L1208),[1219](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1219-L1219),[1255](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1255-L1255),[1280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1280-L1280),[1284](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1284-L1284),[1313](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1313-L1313),[1317](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1317-L1317),[1328](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1328-L1328),[1352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1352-L1352),[1362](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1362-L1362),[1397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1397-L1397),[1411](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1411-L1411),[1441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1441-L1441),[1445](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1445-L1445),[1474](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1474-L1474),[1476](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1476-L1476),[1477](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1477-L1477),[1513](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1513-L1513),[1556](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1556-L1556),[1558](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1558-L1558),[1602](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L1602-L1602))
```solidity
File: contracts/PanopticFactory.sol

48:         uint256 amount0,

49:         uint256 amount1

63:     IUniswapV3Factory internal immutable UNIV3_FACTORY;

66:     SemiFungiblePositionManager internal immutable SFPM;

69:     IDonorNFT internal immutable DONOR_NFT;

72:     address internal immutable POOL_REFERENCE;

75:     address internal immutable COLLATERAL_REFERENCE;

78:     address internal immutable WETH;

82:     uint256 internal constant FULL_RANGE_LIQUIDITY_AMOUNT_WETH = 0.1 ether;

86:     uint256 internal constant FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN = 1e6;

89:     uint16 internal constant CARDINALITY_INCREASE = 100;

96:     address internal s_owner;

99:     bool internal s_initialized;

116:         address _WETH9,

117:         SemiFungiblePositionManager _SFPM,

118:         IUniswapV3Factory _univ3Factory,

119:         IDonorNFT _donorNFT,

120:         address _poolReference,

121:         address _collateralReference

134:     function initialize(address _owner) public {

175:         bytes calldata data

177:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

211:         address token0,

212:         address token1,

213:         uint24 fee,

214:         bytes32 salt

223:         address _owner = s_owner;

263:         (uint256 amount0, uint256 amount1) = _mintFullRange(v3Pool, token0, token1, fee);

291:         bytes32 salt,

292:         uint256 loops,

304:             uint256 rarity = PanopticMath.numberOfLeadingHexZeros(

337:         address token0,

338:         address token1,

339:         uint24 fee

365:                 uint128 liquidity0 = uint128(

368:                 uint128 liquidity1 = uint128(

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {

```
([48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L48-L48),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L49-L49),[63](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L63-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L66-L66),[69](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L69-L69),[72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L72-L72),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L75-L75),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L78-L78),[82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L82-L82),[86](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L86-L86),[89](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L89-L89),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L96-L96),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L99-L99),[116](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L116-L116),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L117-L117),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L118-L118),[119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L119-L119),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L120-L120),[121](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L121-L121),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L134-L134),[175](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L175-L175),[177](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L177-L177),[211](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L211-L211),[212](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L212-L212),[213](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L213-L213),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L214-L214),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L223-L223),[263](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L263-L263),[291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L291-L291),[292](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L292-L292),[304](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L304-L304),[337](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L337-L337),[338](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L338-L338),[339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L339-L339),[365](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L365-L365),[368](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L368-L368),[420](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticFactory.sol#L420-L420))
```solidity
File: contracts/PanopticPool.sol

39:         address indexed liquidator,

40:         address indexed liquidatee,

52:         address indexed exercisor,

53:         address indexed user,

63:         address indexed user,

76:         address indexed recipient,

79:         LeftRightSigned premia

91:         address indexed recipient,

103:     int24 internal constant MIN_SWAP_TICK = Constants.MIN_V3POOL_TICK + 1;

105:     int24 internal constant MAX_SWAP_TICK = Constants.MAX_V3POOL_TICK - 1;

109:     bool internal constant COMPUTE_ALL_PREMIA = true;

111:     bool internal constant COMPUTE_LONG_PREMIA = false;

114:     bool internal constant ONLY_AVAILABLE_PREMIUM = false;

119:     bool internal constant COMMIT_LONG_SETTLED = true;

120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

123:     bool internal constant ADD = true;

128:     uint32 internal constant TWAP_WINDOW = 600;

133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

136:     uint256 internal constant MEDIAN_PERIOD = 60;

139:     uint256 internal constant FAST_ORACLE_CARDINALITY = 3;

145:     uint256 internal constant FAST_ORACLE_PERIOD = 1;

148:     uint256 internal constant SLOW_ORACLE_CARDINALITY = 7;

152:     uint256 internal constant SLOW_ORACLE_PERIOD = 5;

156:     int256 internal constant MAX_TWAP_DELTA_LIQUIDATION = 513;

160:     int256 internal constant MAX_SLOW_FAST_DELTA = 1800;

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

168:     uint64 internal constant MAX_POSITIONS = 32;

171:     uint256 internal constant BP_DECREASE_BUFFER = 13_333;

174:     uint256 internal constant NO_BUFFER = 10_000;

179:     SemiFungiblePositionManager internal immutable SFPM;

186:     IUniswapV3Pool internal s_univ3pool;

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))
             internal s_options;

280:     constructor(SemiFungiblePositionManager _sfpm) {

292:         IUniswapV3Pool _univ3pool,

293:         address token0,

294:         address token1,

353:         address user,

355:     ) external view returns (uint128 balance, uint64 poolUtilization0, uint64 poolUtilization1) {

382:         address user,

385:     ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

390:         (LeftRightSigned premia, uint256[2][] memory balances) = _calculateAccumulatedPremia(

411:         address user,

414:     ) external view returns (int256 value0, int256 value1) {

430:         address user,

435:     ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

439:         address c_user = user;

441:         for (uint256 k = 0; k < pLength; ) {

459:             for (uint256 leg = 0; leg < numLegs; ) {

715:         int256 utilization0 = s_collateralToken0.takeCommissionAddData(

721:         int256 utilization1 = s_collateralToken1.takeCommissionAddData(

745:         for (uint256 leg = 0; leg < numLegs; ) {

795:         address owner,

802:         for (uint256 i = 0; i < positionIdList.length; ) {

829:         address owner,

859:     function _updatePositionDataBurn(address owner, TokenId tokenId) internal {

864:         for (uint256 leg = 0; leg < numLegs; ) {

888:         address user,

890:         uint256 buffer

895:         IUniswapV3Pool _univ3pool = s_univ3pool;

961:         address owner

985:             int128 paid0 = s_collateralToken0.exercise(

996:             int128 paid1 = s_collateralToken1.exercise(

1019:         address liquidatee,

1020:         LeftRightUnsigned delegations,

1030:         LeftRightSigned premia;

1117:             address _liquidatee = liquidatee;

1118:             TokenId[] memory _positionIdList = positionIdList;

1119:             int24 _finalTick = finalTick;

1139:         LeftRightUnsigned _delegations = delegations;

1180:         address account,

1291:         address account,

1295:         uint256 buffer

1368:         address account,

1370:         uint256 offset

1382:         for (uint256 i = 0; i < pLength; ) {

1405:     function _updatePositionsHash(address account, TokenId tokenId, bool addFlag) internal {

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {

1467:         uint256 leg,

1506:         address owner,

1518:         for (uint256 leg = 0; leg < numLegs; ) {

1589:         address owner,

1627:         uint256 liquidity = PanopticMath

1672:         for (uint256 leg = 0; leg < numLegs; ++leg) {

1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *

1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *

1804:         uint256 leg

1834:         address owner,

1852:         for (uint256 leg = 0; leg < numLegs; ) {

1923:                         uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;

1924:                         uint256 _leg = leg;

```
([39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L39-L39),[40](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L40-L40),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L52-L52),[53](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L53-L53),[63](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L63-L63),[76](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L76-L76),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L79-L79),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L91-L91),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L103-L103),[105](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L105-L105),[109](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L109-L109),[111](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L111-L111),[114](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L114-L114),[119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L119-L119),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L120-L120),[123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L123-L123),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L128-L128),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L133-L133),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L136-L136),[139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L139-L139),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L145-L145),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L148-L148),[152](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L152-L152),[156](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L156-L156),[160](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L160-L160),[165](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L165-L165),[168](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L168-L168),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L171-L171),[174](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L174-L174),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L179-L179),[186](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L186-L186),[238](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L238-L239),[280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L280-L280),[292](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L292-L292),[293](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L293-L293),[294](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L294-L294),[353](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L353-L353),[355](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L355-L355),[382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L382-L382),[385](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L385-L385),[390](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L390-L390),[411](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L411-L411),[414](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L414-L414),[430](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L430-L430),[435](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L435-L435),[439](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L439-L439),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L441-L441),[459](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L459-L459),[715](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L715-L715),[721](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L721-L721),[745](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L745-L745),[795](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L795-L795),[802](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L802-L802),[829](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L829-L829),[859](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L859-L859),[864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L864-L864),[888](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L888-L888),[890](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L890-L890),[895](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L895-L895),[961](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L961-L961),[985](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L985-L985),[996](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L996-L996),[1019](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1019-L1019),[1020](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1020-L1020),[1030](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1030-L1030),[1117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1117-L1117),[1118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1118-L1118),[1119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1119-L1119),[1139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1139-L1139),[1180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1180-L1180),[1291](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1291-L1291),[1295](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1295-L1295),[1368](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1368-L1368),[1370](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1370-L1370),[1382](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1382-L1382),[1405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1405-L1405),[1444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1444-L1444),[1467](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1467-L1467),[1506](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1506-L1506),[1518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1518-L1518),[1589](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1589-L1589),[1627](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1627-L1627),[1672](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1672-L1672),[1768](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1768-L1768),[1770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1770-L1770),[1804](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1804-L1804),[1834](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1834-L1834),[1852](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1852-L1852),[1923](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1923-L1923),[1924](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/PanopticPool.sol#L1924-L1924))
```solidity
File: contracts/SemiFungiblePositionManager.sol

88:         address indexed recipient,

99:         address indexed caller,

116:         IUniswapV3Pool pool;

117:         bool locked;

125:     bool internal constant MINT = false;

126:     bool internal constant BURN = true;

133:     uint128 private constant VEGOID = 2;

137:     IUniswapV3Factory internal immutable FACTORY;

341:     constructor(IUniswapV3Factory _factory) {

350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {

352:         address univ3pool = FACTORY.getPool(token0, token1, fee);

405:         bytes calldata data

408:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

438:         bytes calldata data

441:         CallbackLib.CallbackData memory decoded = abi.decode(data, (CallbackLib.CallbackData));

446:         address token = amount0Delta > 0

541:         address from,

542:         address to,

543:         uint256 id,

544:         uint256 amount,

545:         bytes calldata data

567:         address from,

568:         address to,

569:         uint256[] calldata ids,

570:         uint256[] calldata amounts,

571:         bytes calldata data

575:         for (uint256 i = 0; i < ids.length; ) {

593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

598:         IUniswapV3Pool univ3pool = s_poolContext[id.poolId()].pool;

601:         for (uint256 leg = 0; leg < numLegs; ) {

699:         IUniswapV3Pool univ3pool = s_poolContext[tokenId.poolId()].pool;

757:         IUniswapV3Pool univ3pool,

763:         bytes memory data;

765:         IUniswapV3Pool _univ3pool = univ3pool;

769:             int128 itm0 = itmAmounts.rightSlot();

770:             int128 itm1 = itmAmounts.leftSlot();

817:                 int256 net0 = itm0 - PanopticMath.convert1to0(itm1, sqrtPriceX96);

837:             (int256 swap0, int256 swap1) = _univ3pool.swap(

864:         IUniswapV3Pool univ3pool,

877:         uint256 amount0;

878:         uint256 amount1;

882:         for (uint256 leg = 0; leg < numLegs; ) {

883:             LeftRightSigned _moved;

884:             LeftRightSigned _itmAmounts;

885:             LeftRightUnsigned _collectedSingleLeg;

889:                 IUniswapV3Pool _univ3pool = univ3pool;

890:                 TokenId _tokenId = tokenId;

891:                 bool _isBurn = isBurn;

892:                 uint128 _positionSize = positionSize;

893:                 uint256 _leg;

959:         IUniswapV3Pool univ3pool,

961:         uint256 leg,

967:             LeftRightSigned moved,

1139:         IUniswapV3Pool univ3pool,

1140:         uint128 liquidity,

1187:         IUniswapV3Pool univ3pool

1190:         bytes memory mintdata = abi.encode(

1203:         (uint256 amount0, uint256 amount1) = univ3pool.mint(

1226:         IUniswapV3Pool univ3pool

1230:         (uint256 amount0, uint256 amount1) = univ3pool.burn(

1257:         IUniswapV3Pool univ3pool,

1293:             uint128 collected0;

1294:             uint128 collected1;

1346:                 uint128 collected0 = collectedAmounts.rightSlot();

1347:                 uint128 collected1 = collectedAmounts.leftSlot();

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1388:                     uint256 numerator = totalLiquidity ** 2 -

1422:         address univ3pool,

1423:         address owner,

1450:         address univ3pool,

1451:         address owner,

1472:                     IUniswapV3Pool _univ3pool = IUniswapV3Pool(univ3pool);

1473:                     int24 _tickLower = tickLower;

1474:                     int24 _tickUpper = tickUpper;

1536:         address univ3pool,

1537:         address owner,

1557:     ) external view returns (IUniswapV3Pool UniswapV3Pool) {

1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {

```
([88](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L88-L88),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L99-L99),[116](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L116-L116),[117](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L117-L117),[125](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L125-L125),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L126-L126),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L133-L133),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L137-L137),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L341-L341),[350](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L350-L350),[352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L352-L352),[405](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L405-L405),[408](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L408-L408),[438](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L438-L438),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L441-L441),[446](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L446-L446),[541](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L541-L541),[542](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L542-L542),[543](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L543-L543),[544](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L544-L544),[545](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L545-L545),[567](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L567-L567),[568](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L568-L568),[569](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L569-L569),[570](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L570-L570),[571](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L571-L571),[575](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L575-L575),[593](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L593-L593),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L598-L598),[601](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L601-L601),[699](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L699-L699),[757](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L757-L757),[763](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L763-L763),[765](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L765-L765),[769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L769-L769),[770](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L770-L770),[817](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L817-L817),[837](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L837-L837),[864](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L864-L864),[877](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L877-L877),[878](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L878-L878),[882](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L882-L882),[883](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L883-L883),[884](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L884-L884),[885](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L885-L885),[889](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L889-L889),[890](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L890-L890),[891](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L891-L891),[892](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L892-L892),[893](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L893-L893),[959](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L959-L959),[961](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L961-L961),[967](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L967-L967),[1139](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1139-L1139),[1140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1140-L1140),[1187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1187-L1187),[1190](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1190-L1190),[1203](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1203-L1203),[1226](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1226-L1226),[1230](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1230-L1230),[1257](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1257-L1257),[1293](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1293-L1293),[1294](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1294-L1294),[1346](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1346-L1346),[1347](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1347-L1347),[1367](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1367-L1367),[1388](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1388-L1388),[1422](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1422-L1422),[1423](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1423-L1423),[1450](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1450-L1450),[1451](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1451-L1451),[1472](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1472-L1472),[1473](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1473-L1473),[1474](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1474-L1474),[1536](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1536-L1536),[1537](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1537-L1537),[1557](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1557-L1557),[1566](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L1566-L1566))
```solidity
File: contracts/libraries/CallbackLib.sol

15:         address token0;

16:         address token1;

17:         uint24 fee;

23:         address payer;

31:         address sender,

32:         IUniswapV3Factory factory,

33:         PoolFeatures memory features

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L15-L15),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L16-L16),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L17-L17),[23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L23-L23),[31](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L31-L31),[32](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L32-L32),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/CallbackLib.sol#L33-L33))
```solidity
File: contracts/libraries/Constants.sol

9:     uint256 internal constant FP96 = 0x1000000000000000000000000;

12:     int24 internal constant MIN_V3POOL_TICK = -887272;

15:     int24 internal constant MAX_V3POOL_TICK = 887272;

18:     uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;

21:     uint160 internal constant MAX_V3POOL_SQRT_RATIO =
            1461446703485210103287273052203988822378723970342;

```
([9](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L9-L9),[12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L12-L12),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L15-L15),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L18-L18),[21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Constants.sol#L21-L22))
```solidity
File: contracts/libraries/FeesCalc.sol

50:     ) external view returns (int256 value0, int256 value1) {

51:         for (uint256 k = 0; k < positionIdList.length; ) {

55:             for (uint256 leg = 0; leg < numLegs; ) {

62:                 (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(

98:         IUniswapV3Pool univ3pool,

102:         uint128 liquidity

131:         IUniswapV3Pool univ3pool,

```
([50](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L50-L50),[51](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L51-L51),[55](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L55-L55),[62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L62-L62),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L98-L98),[102](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L102-L102),[131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/FeesCalc.sol#L131-L131))
```solidity
File: contracts/libraries/InteractionHelper.sol

25:         SemiFungiblePositionManager sfpm,

26:         CollateralTracker ct0,

27:         CollateralTracker ct1,

28:         address token0,

29:         address token1

49:         address token0,

50:         address token1,

52:         uint24 fee,

53:         string memory prefix

58:         string memory symbol0;

59:         string memory symbol1;

60:         try IERC20Metadata(token0).symbol() returns (string memory _symbol) {

65:         try IERC20Metadata(token1).symbol() returns (string memory _symbol) {

92:         address token,

93:         string memory prefix

107:     function computeDecimals(address token) external view returns (uint8) {

110:         try IERC20Metadata(token).decimals() returns (uint8 _decimals) {

```
([25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L25-L25),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L26-L26),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L27-L27),[28](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L28-L28),[29](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L29-L29),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L49-L49),[50](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L50-L50),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L52-L52),[53](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L53-L53),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L58-L58),[59](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L59-L59),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L60-L60),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L65-L65),[92](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L92-L92),[93](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L93-L93),[107](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L107-L107),[110](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/InteractionHelper.sol#L110-L110))
```solidity
File: contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

224:     ) internal pure returns (uint256 amount0, uint256 amount1) {

244:         uint256 amount0

274:         uint256 amount1

341:         uint256 a,

342:         uint256 b,

343:         uint256 denominator

344:     ) internal pure returns (uint256 result) {

351:             uint256 prod0; // Least significant 256 bits of the product

352:             uint256 prod1; // Most significant 256 bits of the product

378:             uint256 remainder;

391:             uint256 twos = (0 - denominator) & denominator;

414:             uint256 inv = (3 * denominator) ^ 2;

441:         uint256 a,

442:         uint256 b,

443:         uint256 denominator

444:     ) internal pure returns (uint256 result) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

465:             uint256 prod0; // Least significant 256 bits of the product

466:             uint256 prod1; // Most significant 256 bits of the product

475:                 uint256 res;

492:             uint256 remainder;

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

528:             uint256 prod0; // Least significant 256 bits of the product

529:             uint256 prod1; // Most significant 256 bits of the product

538:                 uint256 res;

555:             uint256 remainder;

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

605:             uint256 prod0; // Least significant 256 bits of the product

606:             uint256 prod1; // Most significant 256 bits of the product

615:                 uint256 res;

632:             uint256 remainder;

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

682:             uint256 prod0; // Least significant 256 bits of the product

683:             uint256 prod1; // Most significant 256 bits of the product

692:                 uint256 res;

709:             uint256 remainder;

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

755:             int256 i = left;

756:             int256 j = right;

758:             int256 pivot = arr[uint256(left + (right - left) / 2)];

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {

```
([15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L15-L15),[25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L25-L25),[33](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L33-L33),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L41-L41),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L49-L49),[57](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L57-L57),[65](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L65-L65),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L73-L73),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L81-L81),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L91-L91),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L128-L128),[224](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L224-L224),[244](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L244-L244),[274](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L274-L274),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L341-L341),[342](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L342-L342),[343](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L343-L343),[344](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L344-L344),[351](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L351-L351),[352](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L352-L352),[378](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L378-L378),[391](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L391-L391),[414](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L414-L414),[441](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L441-L441),[442](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L442-L442),[443](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L443-L443),[444](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L444-L444),[458](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L458-L458),[465](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L465-L465),[466](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L466-L466),[475](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L475-L475),[492](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L492-L492),[521](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L521-L521),[528](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L528-L528),[529](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L529-L529),[538](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L538-L538),[555](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L555-L555),[584](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L584-L584),[598](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L598-L598),[605](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L605-L605),[606](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L606-L606),[615](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L615-L615),[632](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L632-L632),[661](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L661-L661),[675](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L675-L675),[682](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L682-L682),[683](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L683-L683),[692](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L692-L692),[709](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L709-L709),[738](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L738-L738),[753](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L753-L753),[755](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L755-L755),[756](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L756-L756),[758](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L758-L758),[776](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/Math.sol#L776-L776))
```solidity
File: contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

26:     uint64 internal constant TICKSPACING_MASK = 0xFFFF000000000000;

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

75:     function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {

126:         IUniswapV3Pool univ3pool,

129:         uint256 cardinality,

130:         uint256 period

135:             uint256[] memory timestamps = new uint256[](cardinality + 1);

137:             for (uint256 i = 0; i < cardinality + 1; ++i) {

146:             int256[] memory ticks = new int256[](cardinality);

148:             for (uint256 i = 0; i < cardinality; ++i) {

171:         uint256 period,

173:         IUniswapV3Pool univ3pool

186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(

192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool

203:                 uint24 shift = 1;

204:                 bool below = true;

205:                 uint24 rank;

206:                 int24 entry;

207:                 for (uint8 i; i < 8; ++i) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

248:             for (uint256 i = 0; i < 20; ++i) {

256:             for (uint256 i = 0; i < 19; ++i) {

324:         uint256 amount = uint256(positionSize) * tokenId.optionRatio(legIndex);

339:         int24 strike,

340:         int24 width,

372:         int24 width,

395:         for (uint256 leg = 0; leg < numLegs; ) {

397:             (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(

449:         int24 tick

472:         uint256 asset

475:             uint256 notional = asset == 0

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

582:         uint128 amount0;

583:         uint128 amount1;

611:     ) internal pure returns (LeftRightSigned longs, LeftRightSigned shorts) {

657:         LeftRightSigned premia

658:     ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

664:                 uint256 required0 = PanopticMath.convert0to1(

668:                 uint256 required1 = tokenData1.leftSlot();

693:             int256 balance0 = int256(uint256(tokenData0.rightSlot())) -

695:             int256 balance1 = int256(uint256(tokenData1.rightSlot())) -

698:             int256 paid0 = bonus0 + int256(netExchanged.rightSlot());

699:             int256 paid1 = bonus1 + int256(netExchanged.leftSlot());

769:         address liquidatee,

773:         CollateralTracker collateral0,

774:         CollateralTracker collateral1,

781:             for (uint256 i = 0; i < positionIdList.length; ++i) {

784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {

793:             int256 haircut0;

794:             int256 haircut1;

855:                 address _liquidatee = liquidatee;

860:             for (uint256 i = 0; i < positionIdList.length; i++) {

862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;

863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {

865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
                                 storage _settledTokens = settledTokens;

869:                         uint256 settled0 = Math.unsafeDivRoundingUp(

873:                         uint256 settled1 = Math.unsafeDivRoundingUp(

918:         address refunder,

921:         CollateralTracker collateral0,

922:         CollateralTracker collateral1

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L23-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L26-L26),[47](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L47-L47),[75](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L75-L75),[126](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L126-L126),[129](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L129-L129),[130](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L130-L130),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L135-L135),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L137-L137),[146](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L146-L146),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L148-L148),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L171-L171),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L173-L173),[186](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L186-L186),[192](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L192-L192),[203](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L203-L203),[204](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L204-L204),[205](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L205-L205),[206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L206-L206),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L207-L207),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L241-L241),[248](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L248-L248),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L256-L256),[324](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L324-L324),[339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L339-L339),[340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L340-L340),[372](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L372-L372),[395](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L395-L395),[397](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L397-L397),[449](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L449-L449),[472](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L472-L472),[475](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L475-L475),[490](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L490-L490),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L507-L507),[524](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L524-L524),[547](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L547-L547),[582](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L582-L582),[583](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L583-L583),[611](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L611-L611),[657](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L657-L657),[658](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L658-L658),[664](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L664-L664),[668](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L668-L668),[693](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L693-L693),[695](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L695-L695),[698](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L698-L698),[699](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L699-L699),[769](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L769-L769),[773](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L773-L773),[774](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L774-L774),[781](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L781-L781),[784](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L784-L784),[793](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L793-L793),[794](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L794-L794),[855](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L855-L855),[860](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L860-L860),[862](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L862-L862),[863](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L863-L863),[865](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L865-L866),[869](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L869-L869),[873](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L873-L873),[918](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L918-L918),[921](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L921-L921),[922](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L922-L922))
```solidity
File: contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

22:         bool success;

52:     function safeTransfer(address token, address to, uint256 amount) internal {

53:         bool success;

```
([21](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L21-L21),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L22-L22),[52](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L52-L52),[53](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/SafeTransferLib.sol#L53-L53))
```solidity
File: contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {

14:         for (uint256 i = 0; i < data.length; ) {

15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);

```
([12](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L12-L12),[14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L14-L14),[15](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/multicall/Multicall.sol#L15-L15))
```solidity
File: contracts/tokens/ERC1155Minimal.sol

23:         address indexed operator,

24:         address indexed from,

25:         address indexed to,

26:         uint256 id,

27:         uint256 amount

37:         address indexed operator,

38:         address indexed from,

39:         address indexed to,

40:         uint256[] ids,

41:         uint256[] amounts

48:     event ApprovalForAll(address indexed owner, address indexed operator, bool approved);

81:     function setApprovalForAll(address operator, bool approved) public {

95:         address from,

96:         address to,

97:         uint256 id,

98:         uint256 amount,

99:         bytes calldata data

131:         address from,

132:         address to,

133:         uint256[] calldata ids,

134:         uint256[] calldata amounts,

135:         bytes calldata data

140:         uint256 id;

141:         uint256 amount;

143:         for (uint256 i = 0; i < ids.length; ) {

179:         address[] calldata owners,

180:         uint256[] calldata ids

181:     ) public view returns (uint256[] memory balances) {

187:             for (uint256 i = 0; i < owners.length; ++i) {

214:     function _mint(address to, uint256 id, uint256 amount) internal {

236:     function _burn(address from, uint256 id, uint256 amount) internal {

```
([23](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L23-L23),[24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L24-L24),[25](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L25-L25),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L26-L26),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L27-L27),[37](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L37-L37),[38](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L38-L38),[39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L39-L39),[40](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L40-L40),[41](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L41-L41),[48](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L48-L48),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L81-L81),[95](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L95-L95),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L96-L96),[97](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L97-L97),[98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L98-L98),[99](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L99-L99),[131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L131-L131),[132](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L132-L132),[133](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L133-L133),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L134-L134),[135](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L135-L135),[140](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L140-L140),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L141-L141),[143](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L143-L143),[179](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L179-L179),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L180-L180),[181](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L181-L181),[187](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L187-L187),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L214-L214),[236](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC1155Minimal.sol#L236-L236))
```solidity
File: contracts/tokens/ERC20Minimal.sol

18:     event Transfer(address indexed from, address indexed to, uint256 amount);

24:     event Approval(address indexed owner, address indexed spender, uint256 amount);

39:     mapping(address owner => mapping(address spender => uint256 allowance)) public allowance;

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

82:         uint256 allowed = allowance[from][msg.sender]; // Saves gas for limited approvals.

103:     function _transferFrom(address from, address to, uint256 amount) internal {

122:     function _mint(address to, uint256 amount) internal {

136:     function _burn(address from, uint256 amount) internal {

```
([18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L18-L18),[24](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L24-L24),[39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L39-L39),[49](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L49-L49),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L61-L61),[81](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L81-L81),[82](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L82-L82),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L103-L103),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L122-L122),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/ERC20Minimal.sol#L136-L136))
```solidity
File: contracts/tokens/interfaces/IDonorNFT.sol

14:         address deployer,

16:         address token0,

17:         address token1,

18:         uint24 fee

```
([14](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L14-L14),[16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L16-L16),[17](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L17-L17),[18](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IDonorNFT.sol#L18-L18))
```solidity
File: contracts/tokens/interfaces/IERC20Partial.sol

16:     function balanceOf(address account) external view returns (uint256);

22:     function approve(address spender, uint256 amount) external;

27:     function transfer(address to, uint256 amount) external;

```
([16](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L16-L16),[22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L22-L22),[27](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/tokens/interfaces/IERC20Partial.sol#L27-L27))
```solidity
File: contracts/types/LeftRight.sol

22:     uint256 internal constant LEFT_HALF_BIT_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000;

26:     int256 internal constant LEFT_HALF_BIT_MASK_INT =
            int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

30:     int256 internal constant RIGHT_HALF_BIT_MASK = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

60:         LeftRightUnsigned self,

61:         uint128 right

79:         LeftRightSigned self,

80:         int128 right

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

122:         LeftRightUnsigned self,

123:         uint128 left

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

149:         LeftRightUnsigned x,

150:         LeftRightUnsigned y

151:     ) internal pure returns (LeftRightUnsigned z) {

172:         LeftRightUnsigned x,

173:         LeftRightUnsigned y

174:     ) internal pure returns (LeftRightUnsigned z) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();

197:             int128 left128 = int128(left);

201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();

202:             int128 right128 = int128(right);

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

216:             int256 left256 = int256(x.leftSlot()) + y.leftSlot();

217:             int128 left128 = int128(left256);

219:             int256 right256 = int256(x.rightSlot()) + y.rightSlot();

220:             int128 right128 = int128(right256);

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

234:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();

235:             int128 left128 = int128(left256);

237:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();

238:             int128 right128 = int128(right256);

252:         LeftRightSigned x,

253:         LeftRightSigned y

254:     ) internal pure returns (LeftRightSigned z) {

256:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();

257:             int128 left128 = int128(left256);

259:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();

260:             int128 right128 = int128(right256);

280:         LeftRightUnsigned x,

281:         LeftRightUnsigned dx,

282:         LeftRightUnsigned y,

283:         LeftRightUnsigned dy

```
([22](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L22-L23),[26](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L26-L27),[30](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L30-L30),[39](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L39-L39),[46](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L46-L46),[60](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L60-L60),[61](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L61-L61),[79](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L79-L79),[80](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L80-L80),[101](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L101-L101),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L108-L108),[122](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L122-L122),[123](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L123-L123),[134](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L134-L134),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L149-L149),[150](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L150-L150),[151](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L151-L151),[172](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L172-L172),[173](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L173-L173),[174](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L174-L174),[194](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L194-L194),[196](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L196-L196),[197](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L197-L197),[201](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L201-L201),[202](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L202-L202),[214](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L214-L214),[216](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L216-L216),[217](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L217-L217),[219](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L219-L219),[220](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L220-L220),[232](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L232-L232),[234](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L234-L234),[235](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L235-L235),[237](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L237-L237),[238](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L238-L238),[252](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L252-L252),[253](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L253-L253),[254](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L254-L254),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L256-L256),[257](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L257-L257),[259](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L259-L259),[260](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L260-L260),[280](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L280-L280),[281](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L281-L281),[282](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L282-L282),[283](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LeftRight.sol#L283-L283))
```solidity
File: contracts/types/LiquidityChunk.sol

54:     uint256 internal constant CLEAR_TL_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

58:     uint256 internal constant CLEAR_TU_MASK =
            0xFFFFFF000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

71:         int24 _tickLower,

72:         int24 _tickUpper,

73:         uint128 amount

90:         LiquidityChunk self,

91:         uint128 amount

103:         LiquidityChunk self,

104:         int24 _tickLower

119:         LiquidityChunk self,

120:         int24 _tickUpper

136:         LiquidityChunk self,

137:         int24 _tickLower

152:         LiquidityChunk self,

153:         int24 _tickUpper

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {

```
([54](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L54-L55),[58](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L58-L59),[71](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L71-L71),[72](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L72-L72),[73](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L73-L73),[90](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L90-L90),[91](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L91-L91),[103](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L103-L103),[104](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L104-L104),[119](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L119-L119),[120](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L120-L120),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L136-L136),[137](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L137-L137),[152](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L152-L152),[153](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L153-L153),[171](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L171-L171),[180](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L180-L180),[189](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/LiquidityChunk.sol#L189-L189))
```solidity
File: contracts/types/TokenId.sol

62:     uint256 internal constant LONG_MASK =
            0x100_000000000100_000000000100_000000000100_0000000000000000;

66:     uint256 internal constant CLEAR_POOLID_MASK =
            0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF_0000000000000000;

70:     uint256 internal constant OPTION_RATIO_MASK =
            0x0000000000FE_0000000000FE_0000000000FE_0000000000FE_0000000000000000;

74:     uint256 internal constant CHUNK_MASK =
            0xFFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_FFFFFFFFF200_0000000000000000;

78:     int256 internal constant BITMASK_INT24 = 0xFFFFFF;

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

206:         TokenId self,

207:         uint256 _asset,

222:         TokenId self,

223:         uint256 _optionRatio,

241:         TokenId self,

242:         uint256 _isLong,

256:         TokenId self,

257:         uint256 _tokenType,

274:         TokenId self,

275:         uint256 _riskPartner,

292:         TokenId self,

293:         int24 _strike,

311:         TokenId self,

312:         int24 _width,

337:         TokenId self,

339:         uint256 _optionRatio,

340:         uint256 _asset,

341:         uint256 _isLong,

342:         uint256 _tokenType,

343:         uint256 _riskPartner,

344:         int24 _strike,

345:         int24 _width

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

417:         TokenId self,

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

500:     function validate(TokenId self) internal pure {

507:             for (uint256 i = 0; i < 4; ++i) {

520:                 for (uint256 j = i + 1; j < numLegs; ++j) {

551:                     uint256 _isLong = self.isLong(i);

555:                     uint256 _tokenType = self.tokenType(i);

578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {

581:             for (uint256 i = 0; i < numLegs; ++i) {

587:                 int24 _strike = self.strike(i);

```
([62](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L62-L63),[66](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L66-L67),[70](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L70-L71),[74](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L74-L75),[78](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L78-L78),[87](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L87-L87),[96](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L96-L96),[108](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L108-L108),[118](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L118-L118),[128](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L128-L128),[138](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L138-L138),[148](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L148-L148),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L158-L158),[169](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L169-L169),[183](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L183-L183),[193](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L193-L193),[206](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L206-L206),[207](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L207-L207),[222](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L222-L222),[223](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L223-L223),[241](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L241-L241),[242](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L242-L242),[256](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L256-L256),[257](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L257-L257),[274](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L274-L274),[275](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L275-L275),[292](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L292-L292),[293](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L293-L293),[311](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L311-L311),[312](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L312-L312),[337](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L337-L337),[339](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L339-L339),[340](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L340-L340),[341](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L341-L341),[342](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L342-L342),[343](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L343-L343),[344](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L344-L344),[345](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L345-L345),[366](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L366-L366),[404](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L404-L404),[417](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L417-L417),[432](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L432-L432),[464](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L464-L464),[500](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L500-L500),[507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L507-L507),[520](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L520-L520),[551](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L551-L551),[555](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L555-L555),[578](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L578-L578),[581](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L581-L581),[587](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/types/TokenId.sol#L587-L587))
### <a name="NC-111"></a>[NC-111] Visibility should be set explicitly rather than defaulting to `internal`

*There are 8 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

131:     uint256 immutable TICK_DEVIATION;

136:     uint256 immutable COMMISSION_FEE;

141:     uint256 immutable SELLER_COLLATERAL_RATIO;

145:     uint256 immutable BUYER_COLLATERAL_RATIO;

149:     int256 immutable FORCE_EXERCISE_COST;

154:     uint256 immutable TARGET_POOL_UTIL;

158:     uint256 immutable SATURATED_POOL_UTIL;

162:     uint256 immutable ITM_SPREAD_MULTIPLIER;

```
([131](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L131-L131),[136](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L136-L136),[141](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L141-L141),[145](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L145-L145),[149](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L149-L149),[154](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L154-L154),[158](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L158-L158),[162](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L162-L162))
### <a name="NC-112"></a>[NC-112] Incorrect withdraw declaration
In Solidity, it's essential for clarity and interoperability to correctly specify return types in function declarations. If the `withdraw` function is expected to return a `bool` to indicate success or failure, its omission could lead to ambiguity or unexpected behavior when interacting with or calling this function from other contracts or off-chain systems. Missing return values can mislead developers and potentially lead to contract integrations built on incorrect assumptions. To resolve this, the function declaration for `withdraw` should be modified to explicitly include the `bool` return type, ensuring clarity and correctness in contract interactions.

*There are 3 Instances of this issue* :
```solidity
File: contracts/CollateralTracker.sol

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

531:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) external returns (uint256 shares) {

```
([507](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L507-L507),[518](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L518-L518),[531](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/CollateralTracker.sol#L531-L535))
### <a name="NC-113"></a>[NC-113] Invalid NatSpec comment style
NatSpec [must](https://docs.soliditylang.org/en/latest/natspec-format.html#documentation-example) begin with `///`, or use the `/* ... */` syntax.

*There are 6 Instances of this issue* :
```solidity
File: contracts/SemiFungiblePositionManager.sol

358:         // @dev pools can be initialized from a Panoptic pool or by calling initializeAMMPool directly, reverting

360:         // @dev some pools may not be deployable if the poolId has a collision (since we take only 8 bytes)

603:             // @dev see `contracts/types/LiquidityChunk.sol`

836:             // @dev note this triggers our swap callback function

903:                 // @dev see `contracts/types/LiquidityChunk.sol`

```
([358](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L358-L358),[360](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L360-L360),[603](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L603-L603),[836](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L836-L836),[903](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/SemiFungiblePositionManager.sol#L903-L903))
```solidity
File: contracts/libraries/PanopticMath.sol

98:         // @dev 0 ^ x = x

```
([98](https://github.com/code-423n4/2024-04-panoptic/blob/833312ebd600665b577fbd9c03ffa0daf250ed24/contracts/libraries/PanopticMath.sol#L98-L98))



