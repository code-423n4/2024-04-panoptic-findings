## Summary

### Low Risk Issues

| |Issue|Instances|
|-|:-|:-:|
| [[L&#x2011;1](#l1-vulnerable-versions-of-packages-are-being-used)] | Vulnerable versions of packages are being used | 1 | 
| [[L&#x2011;2](#l2-approve-type-uint256-max-not-work-with-some-tokens)] | Approve `type(uint256).max` not work with some tokens | 4 | 
| [[L&#x2011;3](#l3-approve-can-revert-if-the-current-approval-is-not-zero)] | `approve` can revert if the current approval is not zero | 4 | 
| [[L&#x2011;4](#l4-array-lengths-not-checked)] | Array lengths not checked | 3 | 
| [[L&#x2011;5](#l5-for-loops-in-public-or-external-functions-should-be-avoided-due-to-high-gas-costs-and-possible-dos)] | For loops in public or external functions should be avoided due to high gas costs and possible DOS | 17 | 
| [[L&#x2011;6](#l6-missing-checks-in-constructor)] | Missing checks in constructor | 1 | 
| [[L&#x2011;7](#l7-decimals-is-not-a-part-of-the-erc-20-standard)] | `decimals()` is not a part of the ERC-20 standard | 1 | 
| [[L&#x2011;8](#l8-utilizing-delegatecall-within-a-loop)] | Utilizing delegatecall within a loop | 1 | 
| [[L&#x2011;9](#l9-division-before-multiplication-can-lead-to-precision-errors)] | Division before multiplication can lead to precision errors | 3 | 
| [[L&#x2011;10](#l10-double-type-casts-create-complexity-within-the-code)] | Double type casts create complexity within the code | 66 | 
| [[L&#x2011;11](#l11-external-calls-in-an-un-bounded-loop-may-result-in-a-dos)] | `external` calls in an un-bounded loop may result in a DOS | 58 | 
| [[L&#x2011;12](#l12-increase-decrease-or-forceapprove-allowance-should-be-used-instead-of-approve)] | increase/decrease or forceApprove allowance should be used instead of approve | 4 | 
| [[L&#x2011;13](#l13-initialization-can-be-front-run)] | Initialization can be front-run | 1 | 
| [[L&#x2011;14](#l14-internal-function-calls-within-for-loops)] | `internal` Function calls within for loops | 16 | 
| [[L&#x2011;15](#l15-loss-of-precision)] | Loss of precision | 23 | 
| [[L&#x2011;16](#l16-governance-operations-should-be-behind-a-timelock)] | Governance operations should be behind a timelock | 7 | 
| [[L&#x2011;17](#l17-consider-using-openzeppelin-s-safecast-library-to-prevent-unexpected-overflows-when-casting-from-various-type-int-uint-values)] | Consider using OpenZeppelinâ€™s SafeCast library to prevent unexpected overflows when casting from various type int/uint values | 108 | 
| [[L&#x2011;18](#l18-symbol-is-not-a-part-of-the-erc-20-standard)] | `symbol()` is not a part of the ERC-20 standard | 3 | 
| [[L&#x2011;19](#l19-int-casting-block-timestamp-can-reduce-the-lifespan-of-a-contract)] | Int casting `block.timestamp` can reduce the lifespan of a contract | 1 | 
| [[L&#x2011;20](#l20-large-transfers-may-not-work-with-some-erc20-tokens)] | Large transfers may not work with some `ERC20` tokens | 1 | 
| [[L&#x2011;21](#l21-unsafe-downcast)] | Unsafe downcast | 99 | 
| [[L&#x2011;22](#l22-unsafe-erc20-operation-approve)] | Unsafe ERC20 operation `approve()` | 4 | 
| [[L&#x2011;23](#l23-unsafe-conversion-from-unsigned-to-signed-values)] | Unsafe conversion from unsigned to signed values | 16 | 
| [[L&#x2011;24](#l24-consider-using-descriptive-constant-s-when-passing-zero-as-a-function-argument)] | Consider using descriptive `constant`s when passing zero as a function argument | 2 | 
| [[L&#x2011;25](#l25-check-of-division-by-zero)] | Check of division by zero | 9 | 
| [[L&#x2011;26](#l26-unchecked-blocks-with-additions-multiplications-may-overflow)] | unchecked blocks with additions/multiplications may overflow | 7 | 
| [[L&#x2011;27](#l27-code-does-not-follow-the-best-practice-of-check-effects-interaction)] | Code does not follow the best practice of check-effects-interaction | 8 | 
| [[L&#x2011;28](#l28-prevent-re-setting-a-state-variable-with-the-same-value)] | prevent re-setting a state variable with the same value | 1 | 
| [[L&#x2011;29](#l29-some-tokens-may-not-consider-type-uint256-max-as-an-infinite-approval)] | Some tokens may not consider `type(uint256).max` as an infinite approval | 4 | 
| [[L&#x2011;30](#l30-function-can-return-unassigned-variable)] | Function can return unassigned variable | 6 | 
| [[L&#x2011;31](#l31-solidity-bug-in-legacy-code-generation-when-accessing-the-selector-member-on-expressions-with-side-effects)] | [Solidity]: Bug in Legacy Code Generation When Accessing the .selector Member on Expressions with Side Effects | 1 | 

Total: 480 instances over 31 issues

### Non-critical Issues

| |Issue|Instances|
|-|:-|:-:|
| [[NC&#x2011;1](#nc1-assembly-blocks-should-have-extensive-comments)] | Assembly blocks should have extensive comments | 31 | 
| [[NC&#x2011;2](#nc2-natspec-natspec-author-is-missing-from-contract)] | [NatSpec] Natspec `@author` is missing from `contract` | 3 | 
| [[NC&#x2011;3](#nc3-use-bit-shifts-in-an-imutable-variable-rather-than-long-bit-masks-of-a-single-bit-for-readability)] | Use bit shifts in an imutable variable rather than long bit masks of a single bit, for readability | 1 | 
| [[NC&#x2011;4](#nc4-variable-names-that-consist-of-all-capital-letters-should-be-reserved-for-constant-immutable-variables)] | Variable names that consist of all capital letters should be reserved for `constant`/`immutable` variables | 2 | 
| [[NC&#x2011;5](#nc5-constant-redefined-elsewhere)] | Constant redefined elsewhere | 2 | 
| [[NC&#x2011;6](#nc6-constants-in-comparisons-should-appear-on-the-left-side)] | Constants in comparisons should appear on the left side | 170 | 
| [[NC&#x2011;7](#nc7-natspec-natspec-description-is-missing-from-contract)] | [NatSpec] Natspec description is missing from `contract` | 11 | 
| [[NC&#x2011;8](#nc8-custom-error-has-no-error-details)] | Custom error has no error details | 34 | 
| [[NC&#x2011;9](#nc9-default-address-0-can-be-returned)] | Default address(0) can be returned | 2 | 
| [[NC&#x2011;10](#nc10-consider-using-delete-rather-than-assigning-zero-to-clear-values)] | Consider using `delete` rather than assigning `zero` to clear values | 3 | 
| [[NC&#x2011;11](#nc11-dependence-on-external-protocols)] | Dependence on external protocols | 8 | 
| [[NC&#x2011;12](#nc12-else-block-not-required)] | `else`-block not required | 9 | 
| [[NC&#x2011;13](#nc13-empty-bytes-check-is-missing)] | Empty bytes check is missing | 8 | 
| [[NC&#x2011;14](#nc14-events-are-missing-sender-information)] | Events are missing sender information | 9 | 
| [[NC&#x2011;15](#nc15-events-may-be-emitted-out-of-order-due-to-reentrancy)] | Events may be emitted out of order due to reentrancy | 11 | 
| [[NC&#x2011;16](#nc16-explicitly-define-visibility-of-state-variables-to-prevent-misconceptions-on-what-can-access-the-variable)] | Explicitly define visibility of state variables to prevent misconceptions on what can access the variable | 12 | 
| [[NC&#x2011;17](#nc17-defining-all-external-public-functions-in-contract-interfaces)] | Defining All External/Public Functions in Contract Interfaces | 62 | 
| [[NC&#x2011;18](#nc18-fixed-compiler-version-required-for-non-library-interface-files)] | Fixed Compiler Version Required for Non-Library/Interface Files | 7 | 
| [[NC&#x2011;19](#nc19-floating-pragma-should-be-avoided)] | Floating pragma should be avoided | 7 | 
| [[NC&#x2011;20](#nc20-function-definition-do-not-follow-solidity-style-guide)] | Function definition do not follow Solidity style guide | 4 | 
| [[NC&#x2011;21](#nc21-duplicated-require-checks-should-be-refactored-to-a-modifier-or-function)] | Duplicated `require()` checks should be refactored to a modifier or function | 1 | 
| [[NC&#x2011;22](#nc22-some-if-statement-can-be-converted-to-a-ternary)] | Some if-statement can be converted to a ternary | 9 | 
| [[NC&#x2011;23](#nc23-imports-could-be-organized-more-systematically)] | Imports could be organized more systematically | 4 | 
| [[NC&#x2011;24](#nc24-inconsistent-spacing-in-comments)] | Inconsistent spacing in comments | 5 | 
| [[NC&#x2011;25](#nc25-inconsistent-usage-of-require-error)] | Inconsistent usage of `require`/`error` | 9 | 
| [[NC&#x2011;26](#nc26-incorrect-natspec-syntax)] | Incorrect NatSpec Syntax | 6 | 
| [[NC&#x2011;27](#nc27-internal-functions-not-called-by-the-contract-should-be-removed)] | `internal` functions not called by the contract should be removed | 9 | 
| [[NC&#x2011;28](#nc28-large-numeric-literals-should-use-underscores-for-readability)] | Large numeric literals should use underscores for readability | 12 | 
| [[NC&#x2011;29](#nc29-consider-using-later-versions-of-solidity-for-more-cappabilities)] | Consider using later versions of solidity for more cappabilities | 15 | 
| [[NC&#x2011;30](#nc30-functions-which-are-either-private-or-internal-should-have-a-preceding-in-their-name)] | Functions which are either private or internal should have a preceding _ in their name | 104 | 
| [[NC&#x2011;31](#nc31-public-functions-not-called-by-the-contract-should-be-declared-external-instead)] | `public` functions not called by the contract should be declared `external` instead | 13 | 
| [[NC&#x2011;32](#nc32-polymorphic-functions-make-security-audits-more-time-consuming-and-error-prone)] | Polymorphic functions make security audits more time-consuming and error-prone | 3 | 
| [[NC&#x2011;33](#nc33-state-variables-should-have-natspec-comments)] | State variables should have `Natspec` comments | 9 | 
| [[NC&#x2011;34](#nc34-contracts-should-have-full-test-coverage)] | Contracts should have full test coverage | 1 | 
| [[NC&#x2011;35](#nc35-natspec-natspec-title-is-missing-from-contract)] | [NatSpec] Natspec `@title` is missing from `contract` | 5 | 
| [[NC&#x2011;36](#nc36-open-todos)] | Open TODOs | 5 | 
| [[NC&#x2011;37](#nc37-top-level-pragma-declarations-should-be-separated-by-two-blank-lines)] | Top level pragma declarations should be separated by two blank lines | 2 | 
| [[NC&#x2011;38](#nc38-critical-functions-should-be-a-two-step-procedure)] | Critical functions should be a two step procedure | 1 | 
| [[NC&#x2011;39](#nc39-typos)] | Typos | 2 | 
| [[NC&#x2011;40](#nc40-2-n-1-should-be-re-written-as-type-uint-n-max)] | `2**<n> - 1` should be re-written as `type(uint<n>).max` | 50 | 
| [[NC&#x2011;41](#nc41-uncommented-fields-in-a-struct)] | Uncommented fields in a struct | 2 | 
| [[NC&#x2011;42](#nc42-unused-import)] | Unused Import | 1 | 
| [[NC&#x2011;43](#nc43-unused-internal-private-contract-variable)] | Unused `internal`/`private` contract variable | 2 | 
| [[NC&#x2011;44](#nc44-missing-upgradability-functionality)] | Missing upgradability functionality | 1 | 
| [[NC&#x2011;45](#nc45-use-inheritdoc-rather-than-using-a-non-standard-annotation)] | Use `@inheritdoc` rather than using a non-standard annotation | 2 | 
| [[NC&#x2011;46](#nc46-use-the-latest-solidity-prior-to-0-8-20-if-on-l2s-for-deployment)] | Use the latest solidity (prior to 0.8.20 if on L2s) for deployment | 20 | 
| [[NC&#x2011;47](#nc47-use-a-single-file-for-system-wide-constants)] | Use a single file for system wide constants | 10 | 
| [[NC&#x2011;48](#nc48-consider-using-smtchecker)] | Consider using SMTChecker | 20 | 
| [[NC&#x2011;49](#nc49-variable-name-must-be-in-mixedcase)] | Variable name must be in mixedCase | 48 | 
| [[NC&#x2011;50](#nc50-whitespace-in-expressions)] | Whitespace in Expressions | 105 | 
| [[NC&#x2011;51](#nc51-complex-function-controle-flow)] | Complex function controle flow | 8 | 
| [[NC&#x2011;52](#nc52-consider-bounding-input-array-length)] | Consider bounding input array length | 10 | 
| [[NC&#x2011;53](#nc53-a-function-which-defines-named-returns-in-it-s-declaration-doesn-t-need-to-use-return)] | A function which defines named returns in it's declaration doesn't need to use return | 25 | 
| [[NC&#x2011;54](#nc54-natspec-natspec-dev-is-missing-from-contract)] | [NatSpec] Natspec `@dev` is missing from `contract` | 207 | 
| [[NC&#x2011;55](#nc55-contract-should-expose-an-interface)] | Contract should expose an `interface` | 62 | 
| [[NC&#x2011;56](#nc56-natspec-natspec-notice-is-missing-from-contract)] | [NatSpec] Natspec `@notice` is missing from `contract` | 13 | 
| [[NC&#x2011;57](#nc57-expressions-for-constant-values-should-use-immutable-rather-than-constant)] | Expressions for constant values should use `immutable` rather than `constant` | 6 | 
| [[NC&#x2011;58](#nc58-consider-splitting-long-calculations)] | Consider splitting long calculations | 12 | 
| [[NC&#x2011;59](#nc59-contract-uses-both-require-revert-as-well-as-custom-errors)] | Contract uses both `require()`/`revert()` as well as custom errors | 5 | 
| [[NC&#x2011;60](#nc60-private-public-function-name-should-start-with-underscore)] | `private`/`public` function name should start with underscore | 104 | 
| [[NC&#x2011;61](#nc61-assembly-block-creates-dirty-bits)] | Assembly block creates dirty bits | 2 | 
| [[NC&#x2011;62](#nc62-add-inline-comments-for-unnamed-parameters)] | Add inline comments for unnamed parameters | 2 | 
| [[NC&#x2011;63](#nc63-use-the-latest-solidity-version-for-better-security)] | Use the latest Solidity version for better security | 20 | 
| [[NC&#x2011;64](#nc64-consider-adding-formal-verification-proofs)] | Consider adding formal verification proofs | 1 | 
| [[NC&#x2011;65](#nc65-missing-zero-address-check-in-functions-with-address-parameters)] | Missing zero address check in functions with address parameters | 11 | 
| [[NC&#x2011;66](#nc66-use-a-struct-to-encapsulate-multiple-function-parameters)] | Use a struct to encapsulate multiple function parameters | 42 | 
| [[NC&#x2011;67](#nc67-use-inheritdoc-for-overridden-functions)] | Use `@inheritdoc` for overridden functions | 4 | 
| [[NC&#x2011;68](#nc68-multiple-mappings-with-same-keys-can-be-combined-into-a-single-struct-mapping-for-readability)] | Multiple mappings with same keys can be combined into a single struct mapping for readability | 7 | 
| [[NC&#x2011;69](#nc69-constructor-should-emit-an-event)] | constructor should emit an event | 4 | 
| [[NC&#x2011;70](#nc70-complex-functions-should-include-comments)] | Complex functions should include comments | 8 | 
| [[NC&#x2011;71](#nc71-make-use-of-solidiy-s-using-keyword)] | Make use of Solidiy's `using` keyword | 315 | 
| [[NC&#x2011;72](#nc72-solidity-all-verbatim-blocks-are-considered-identical-by-deduplicator-and-can-incorrectly-be-unified)] | [Solidity]: All `verbatim` blocks are considered identical by deduplicator and can incorrectly be unified | 5 | 
| [[NC&#x2011;73](#nc73-natspec-natspec-comment-is-missing-from-scope-block)] | [NatSpec] Natspec comment is missing from scope `block` | 21 | 
| [[NC&#x2011;74](#nc74-not-using-the-latest-version-of-prb-math-from-dependencies)] | Not using the latest version of `prb-math` from dependencies | 1 | 
| [[NC&#x2011;75](#nc75-non-constant-immutable-state-variables-are-missing-a-setter-post-deployment)] | Non constant/immutable state variables are missing a setter post deployment | 3 | 
| [[NC&#x2011;76](#nc76-consider-making-private-state-variables-internal-to-increase-flexibility)] | Consider making private state variables internal to increase flexibility | 3 | 
| [[NC&#x2011;77](#nc77-off-by-one-timestamp-error)] | Off-by-one timestamp error | 1 | 
| [[NC&#x2011;78](#nc78-lack-of-space-near-the-operator)] | Lack of space near the operator | 80 | 
| [[NC&#x2011;79](#nc79-incorrect-withdraw-declaration)] | Incorrect withdraw declaration | 1 | 
| [[NC&#x2011;80](#nc80-avoid-mutating-function-parameters)] | Avoid mutating function parameters | 5 | 
| [[NC&#x2011;81](#nc81-a-event-should-be-emitted-if-a-non-immutable-state-variable-is-set-in-a-constructor)] | A event should be emitted if a non immutable state variable is set in a constructor | 16 | 
| [[NC&#x2011;82](#nc82-contracts-use-both-1-and-and-1)] | Contracts use both += 1 and ++ (-- and -= 1) | 3 | 
| [[NC&#x2011;83](#nc83-solidity-order-of-argument-evaluation-disrupted-in-non-expression-split-code-by-optimizer-sequences-with-fullinliner)] | [Solidity]: Order of Argument Evaluation Disrupted in Non-Expression-Split Code by Optimizer Sequences with FullInliner | 20 | 
| [[NC&#x2011;84](#nc84-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing)] | Not using the named return variables anywhere in the function is confusing | 17 | 
| [[NC&#x2011;85](#nc85-use-named-return-values)] | Use named return values | 104 | 
| [[NC&#x2011;86](#nc86-consider-moving-duplicated-strings-to-constants)] | Consider moving duplicated strings to constants | 7 | 
| [[NC&#x2011;87](#nc87-missing-checks-for-uint-state-variable-assignments)] | Missing checks for uint state variable assignments | 7 | 
| [[NC&#x2011;88](#nc88-consider-adding-validation-of-user-inputs)] | Consider adding validation of user inputs | 78 | 
| [[NC&#x2011;89](#nc89-consider-disallowing-transfers-to-address-this)] | Consider disallowing transfers to `address(this)` | 6 | 
| [[NC&#x2011;90](#nc90-unusual-loop-variable)] | Unusual loop variable | 13 | 
| [[NC&#x2011;91](#nc91-consider-using-named-function-calls)] | Consider using named function calls | 119 | 

Total: 2250 instances over 91 issues

## Low Risk Issues

### [L&#x2011;1] Vulnerable versions of packages are being used 
This project's specific package versions are vulnerable to the specific CVEs listed below. Consider switching to more recent versions of these packages that don't have these vulnerabilities


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: package.json


<details><summary>Vulnerabilities related to `@openzeppelin/contracts`:</summary>


- [CVE-2022-31170](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-qh9x-gcfh-pcrw) :ERC165Checker.supportsInterface is designed to always successfully return a boolean, and under no circumstance revert. However, an incorrect assumption about Solidity 0.8's abi.decode allows some cases to revert, given a target contract that doesn't implement EIP-165 as expected, specifically if it returns a value other than 0 or 1.

The contracts that may be affected are those that use ERC165Checker to check for support for an interface and then handle the lack of support in a way other than reverting.


- [CVE-2022-31172](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-4g63-c64m-25w9) :SignatureChecker.isValidSignatureNow is not expected to revert. However, an incorrect assumption about Solidity 0.8's abi.decode allows some cases to revert, given a target contract that doesn't implement EIP-1271 as expected.

The contracts that may be affected are those that use SignatureChecker to check the validity of a signature and handle invalid signatures in a way other than reverting. We believe this to be unlikely.


- [CVE-2022-31198](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-xrc4-737v-9q75) :This issue concerns instances of Governor that use the module GovernorVotesQuorumFraction, a mechanism that determines quorum requirements as a percentage of the voting token's total supply. In affected instances, when a proposal is passed to lower the quorum requirement, past proposals may become executable if they had been defeated only due to lack of quorum, and the number of votes it received meets the new quorum requirement.

Analysis of instances on chain found only one proposal that met this condition, and we are actively monitoring for new occurrences of this particular issue.


- [CVE-2022-35915](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-7grf-83vw-6f5x) :This issue concerns instances of Governor that use the module GovernorVotesQuorumFraction, a mechanism that determines quorum requirements as a percentage of the voting token's total supply. In affected instances, when a proposal is passed to lower the quorum requirement, past proposals may become executable if they had been defeated only due to lack of quorum, and the number of votes it received meets the new quorum requirement.

Analysis of instances on chain found only one proposal that met this condition, and we are actively monitoring for new occurrences of this particular issue.


- [CVE-2022-35961](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-4h98-2769-gh6h) :The functions ECDSA.recover and ECDSA.tryRecover are vulnerable to a kind of signature malleability due to accepting EIP-2098 compact signatures in addition to the traditional 65 byte signature format. This is only an issue for the functions that take a single bytes argument, and not the functions that take r, v, s or r, vs as separate arguments.

The potentially affected contracts are those that implement signature reuse or replay protection by marking the signature itself as used rather than the signed message or a nonce included in it. A user may take a signature that has already been submitted, submit it again in a different form, and bypass this protection.


- [CVE-2023-34234](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-5h3x-9wvq-w4m2) :By frontrunning the creation of a proposal, an attacker can become the proposer and gain the ability to cancel it. The attacker can do this repeatedly to try to prevent a proposal from being proposed at all.
This impacts the Governor contract in v4.9.0 only, and the GovernorCompatibilityBravo contract since v4.3.0.


- [CVE-2023-30541](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-mx2q-35m2-x2rh) :A function in the implementation contract may be inaccessible if its selector clashes with one of the proxy's own selectors. Specifically, if the clashing function has a different signature with incompatible ABI encoding, the proxy could revert while attempting to decode the arguments from calldata.
The probability of an accidental clash is negligible, but one could be caused deliberately.


- [CVE-2023-30542](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-93hq-5wgc-jc82) :The proposal creation entrypoint (propose) in GovernorCompatibilityBravo allows the creation of proposals with a signatures array shorter than the calldatas array. This causes the additional elements of the latter to be ignored, and if the proposal succeeds the corresponding actions would eventually execute without any calldata. The ProposalCreated event correctly represents what will eventually execute, but the proposal parameters as queried through getActions appear to respect the original intended calldata.


- [CVE-2022-35916](https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-9j3m-g383-29qr) :Contracts using the cross chain utilies for Arbitrum L2, CrossChainEnabledArbitrumL2 or LibArbitrumL2, will classify direct interactions of externally owned accounts (EOAs) as cross chain calls, even though they are not started on L1. This is assessed as low severity because any action taken by an EOA on the contract could also be taken by the EOA through the bridge if the issue was not present.
</details>
1: 


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//package.json#L1-L1) 


</details>


### [L&#x2011;2] Approve `type(uint256).max` not work with some tokens 
Source: https://github.com/d-xo/weird-erc20#revert-on-large-approvals--transfers


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L32-L32) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L36-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L37-L37)


</details>


### [L&#x2011;3] `approve` can revert if the current approval is not zero 
Some tokens like USDT check for the current approval, and they revert if it's not zero. While Tether is known to do this, it applies to other tokens as well, which are trying to protect against [this](https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit) attack vector.
Consider always calling `token.safeApprove(addr, 0)` before changing the approval, or better yet, use `safeIncreaseAllowance`/`safeDecreaseAllowance`.


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L32-L32) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L36-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L37-L37)


</details>


### [L&#x2011;4] Array lengths not checked 
If the length of the arrays are not required to be of the same length, user operations may not be fully executed due to a mismatch in the number of items iterated over, versus the number of items provided in the second array


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

//@audit , positionIdList, newPositionIdList length are not checked
586:     function burnOptions(
587:         TokenId[] calldata positionIdList,
588:         TokenId[] calldata newPositionIdList,
589:         int24 tickLimitLow,
590:         int24 tickLimitHigh
591:     ) external {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L586-L591) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit , positionIdList, premiasByLeg length are not checked
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L777) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit , ids length are not checked
178:     function balanceOfBatch(
179:         address[] calldata owners,
180:         uint256[] calldata ids
181:     ) public view returns (uint256[] memory balances) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L181) 


</details>


### [L&#x2011;5] For loops in public or external functions should be avoided due to high gas costs and possible DOS 
In Solidity, for loops can potentially cause Denial of Service (DoS) attacks if not handled carefully. DoS attacks can occur when an attacker intentionally exploits the gas cost of a function, causing it to run out of gas or making it too expensive for other users to call. Below are some scenarios where for loops can lead to DoS attacks: Nested for loops can become exceptionally gas expensive and should be used sparingly


*There are 17 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

650:     function exerciseCost(
651:         int24 currentTick,
652:         int24 oracleTick,
653:         TokenId positionId,
654:         uint128 positionBalance,
655:         LeftRightSigned longAmounts
656:     ) external view returns (LeftRightSigned exerciseFees) {
657:         // find the leg furthest to the strike price 'currentTick'; this will have the lowest exercise cost
658:         // we don't need the leg information itself, really just "the number of half ranges" from the strike price:
659:         uint256 maxNumRangesFromStrike = 1; // technically "maxNum(Half)RangesFromStrike" but the name is long
660: 
661:         unchecked {
662:             for (uint256 leg = 0; leg < positionId.countLegs(); ++leg) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L650-L662) 


```solidity

File: ./contracts/PanopticFactory.sol

290:     function minePoolAddress(
291:         bytes32 salt,
292:         uint256 loops,
293:         uint256 minTargetRarity
294:     ) external view returns (bytes32 bestSalt, uint256 highestRarity) {
295:         // Start at the given 'salt' value (a checkpoint used to continue mining across multiple calls)
296: 
297:         // Runs until 'bestSalt' reaches 'minTargetRarity' or for 'loops', whichever comes first
298:         uint256 maxSalt;
299:         unchecked {
300:             maxSalt = uint256(salt) + loops;
301:         }
302: 
303:         for (; uint256(salt) < maxSalt; ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L290-L303) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data
572:     ) public override {
573:         // we don't need to reentrancy lock on transfers, but we can't allow transfers for a pool during mint/burn with a reentrant call
574:         // so just check if there is an active reentrancy lock for the relevant pool on each token
575:         for (uint256 i = 0; i < ids.length; ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L575) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

46:     function getPortfolioValue(
47:         int24 atTick,
48:         mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
49:         TokenId[] calldata positionIdList
50:     ) external view returns (int256 value0, int256 value1) {
51:         for (uint256 k = 0; k < positionIdList.length; ) {

46:     function getPortfolioValue(
47:         int24 atTick,
48:         mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
49:         TokenId[] calldata positionIdList
50:     ) external view returns (int256 value0, int256 value1) {
51:         for (uint256 k = 0; k < positionIdList.length; ) {
52:             TokenId tokenId = positionIdList[k];
53:             uint128 positionSize = userBalance[tokenId].rightSlot();
54:             uint256 numLegs = tokenId.countLegs();
55:             for (uint256 leg = 0; leg < numLegs; ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L46-L51) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L46-L55)


```solidity

File: ./contracts/libraries/PanopticMath.sol

125:     function computeMedianObservedPrice(
126:         IUniswapV3Pool univ3pool,
127:         uint256 observationIndex,
128:         uint256 observationCardinality,
129:         uint256 cardinality,
130:         uint256 period
131:     ) external view returns (int24) {
132:         unchecked {
133:             int256[] memory tickCumulatives = new int256[](cardinality + 1);
134: 
135:             uint256[] memory timestamps = new uint256[](cardinality + 1);
136:             // get the last 4 timestamps/tickCumulatives (if observationIndex < cardinality, the index will wrap back from observationCardinality)
137:             for (uint256 i = 0; i < cardinality + 1; ++i) {

125:     function computeMedianObservedPrice(
126:         IUniswapV3Pool univ3pool,
127:         uint256 observationIndex,
128:         uint256 observationCardinality,
129:         uint256 cardinality,
130:         uint256 period
131:     ) external view returns (int24) {
132:         unchecked {
133:             int256[] memory tickCumulatives = new int256[](cardinality + 1);
134: 
135:             uint256[] memory timestamps = new uint256[](cardinality + 1);
136:             // get the last 4 timestamps/tickCumulatives (if observationIndex < cardinality, the index will wrap back from observationCardinality)
137:             for (uint256 i = 0; i < cardinality + 1; ++i) {
138:                 (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
139:                     uint256(
140:                         (int256(observationIndex) - int256(i * period)) +
141:                             int256(observationCardinality)
142:                     ) % observationCardinality
143:                 );
144:             }
145: 
146:             int256[] memory ticks = new int256[](cardinality);
147:             // use cardinality periods given by cardinality + 1 accumulator observations to compute the last cardinality observed ticks spaced by period
148:             for (uint256 i = 0; i < cardinality; ++i) {

168:     function computeInternalMedian(
169:         uint256 observationIndex,
170:         uint256 observationCardinality,
171:         uint256 period,
172:         uint256 medianData,
173:         IUniswapV3Pool univ3pool
174:     ) external view returns (int24 medianTick, uint256 updatedMedianData) {
175:         unchecked {
176:             // return the average of the rank 3 and 4 values
177:             medianTick =
178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +
179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /
180:                 2;
181: 
182:             // only proceed if last entry is at least MEDIAN_PERIOD seconds old
183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {
184:                 int24 lastObservedTick;
185:                 {
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
187:                         uint256(
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)
189:                         ) % observationCardinality
190:                     );
191: 
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
193:                         .observations(observationIndex);
194:                     lastObservedTick = int24(
195:                         (tickCumulative_last - tickCumulative_old) /
196:                             int256(timestamp_last - timestamp_old)
197:                     );
198:                 }
199: 
200:                 uint24 orderMap = uint24(medianData >> 192);
201: 
202:                 uint24 newOrderMap;
203:                 uint24 shift = 1;
204:                 bool below = true;
205:                 uint24 rank;
206:                 int24 entry;
207:                 for (uint8 i; i < 8; ++i) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {
242:         uint32[] memory secondsAgos = new uint32[](20);
243: 
244:         int256[] memory twapMeasurement = new int256[](19);
245: 
246:         unchecked {
247:             // construct the time stots
248:             for (uint256 i = 0; i < 20; ++i) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {
242:         uint32[] memory secondsAgos = new uint32[](20);
243: 
244:         int256[] memory twapMeasurement = new int256[](19);
245: 
246:         unchecked {
247:             // construct the time stots
248:             for (uint256 i = 0; i < 20; ++i) {
249:                 secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);
250:             }
251: 
252:             // observe the tickCumulative at the 20 pre-defined time slots
253:             (int56[] memory tickCumulatives, ) = univ3pool.observe(secondsAgos);
254: 
255:             // compute the average tick per 30s window
256:             for (uint256 i = 0; i < 19; ++i) {

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {
861:                 TokenId tokenId = positionIdList[i];
862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L125-L137) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L125-L148), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L168-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L241-L248), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L241-L256), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L781), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L860), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L784), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L863)


```solidity

File: ./contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {
13:         results = new bytes[](data.length);
14:         for (uint256 i = 0; i < data.length; ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L12-L14) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

130:     function safeBatchTransferFrom(
131:         address from,
132:         address to,
133:         uint256[] calldata ids,
134:         uint256[] calldata amounts,
135:         bytes calldata data
136:     ) public virtual {
137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
138: 
139:         // Storing these outside the loop saves ~15 gas per iteration.
140:         uint256 id;
141:         uint256 amount;
142: 
143:         for (uint256 i = 0; i < ids.length; ) {

178:     function balanceOfBatch(
179:         address[] calldata owners,
180:         uint256[] calldata ids
181:     ) public view returns (uint256[] memory balances) {
182:         balances = new uint256[](owners.length);
183: 
184:         // Unchecked because the only math done is incrementing
185:         // the array index counter which cannot possibly overflow.
186:         unchecked {
187:             for (uint256 i = 0; i < owners.length; ++i) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L143) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L187)


</details>


### [L&#x2011;6] Missing checks in constructor 
There are some missing checks in these functions, and this could lead to unexpected scenarios. Consider always adding a sanity check for state variables.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit _commissionFee, _buyerCollateralRatio, _forceExerciseCost, _targetPoolUtilization, _saturatedPoolUtilization, _ITMSpreadMultiplier,  are not checked
178:     constructor(
179:         uint256 _commissionFee,
180:         uint256 _sellerCollateralRatio,
181:         uint256 _buyerCollateralRatio,
182:         int256 _forceExerciseCost,
183:         uint256 _targetPoolUtilization,
184:         uint256 _saturatedPoolUtilization,
185:         uint256 _ITMSpreadMultiplier
186:     ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L186) 


</details>


### [L&#x2011;7] `decimals()` is not a part of the ERC-20 standard 
The `decimals()` function is not a part of the [ERC-20 standard](https://eips.ethereum.org/EIPS/eip-20), and was added later as an [optional extension](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/IERC20Metadata.sol). As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

110:         try IERC20Metadata(token).decimals() returns (uint8 _decimals) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L110-L110) 


</details>


### [L&#x2011;8] Utilizing delegatecall within a loop 
Using `delegatecall` in a `for` loop can lead to high gas costs, as `delegatecall` is an expensive operation and its costs compound when used in a loop. Additionally, it can pose security risks including reentrancy attacks, as it executes code in the calling contract's context.The function selector collisions can also lead to unpredictable behaviour.To mitigate these risks, control the loop's iterations, apply a reentrancy guard, strictly audit contracts called via `delegatecall`, and consider alternatives like `call` or proxy patterns if the use case allows. Always thoroughly vet contracts involved in `delegatecall` operations.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/multicall/Multicall.sol

14:         for (uint256 i = 0; i < data.length; ) {
15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L14-L15) 


</details>


### [L&#x2011;9] Division before multiplication can lead to precision errors 
Because Solidity integer division may truncate, it is often preferable to do multiplication before division to prevent precision loss.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

392:             tickLower = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L392-L392) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

346:             int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

347:             int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L346-L346) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L347-L347)


</details>


### [L&#x2011;10] Double type casts create complexity within the code 
Double type casting should be avoided in Solidity contracts to prevent unintended consequences and ensure accurate data representation. Performing multiple type casts in succession can lead to unexpected truncation, rounding errors, or loss of precision, potentially compromising the contract's functionality and reliability. Furthermore, double type casting can make the code less readable and harder to maintain, increasing the likelihood of errors and misunderstandings during development and debugging. To ensure precise and consistent data handling, developers should use appropriate data types and avoid unnecessary or excessive type casting, promoting a more robust and dependable contract execution. 


*There are 66 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1330:             : int64(uint64(poolUtilization >> 64));

1329:             ? int64(uint64(poolUtilization))

1003:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1028:             s_poolAssets = uint128(uint256(updatedAssets));

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));

1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +

667:                     int24 range = int24(

1184:                 netBalance += uint256(uint128(premiumAllPositions));

1586:                     : int64(uint64(poolUtilization >> 64))

1585:                     ? int64(uint64(poolUtilization))

1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

1121:                     uint256(uint128(shortAmount + longAmount)) * COMMISSION_FEE,

1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1330-L1330) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1329-L1329), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1003-L1003), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1028-L1028), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1029-L1029), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1052-L1052), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1084-L1084), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1085-L1085), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1637-L1637), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L667-L667), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1184-L1184), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1586-L1586), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1585-L1585), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1029-L1029), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1085-L1085), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1121-L1121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1638-L1638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L718-L718), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L718-L718), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L715-L715), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L715-L715)


```solidity

File: ./contracts/PanopticPool.sol

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1144:             uint256(int256(uint256(_delegations.rightSlot())) + liquidationBonus0)

1149:             uint256(int256(uint256(_delegations.leftSlot())) + liquidationBonus1)

314:                 (uint256(uint24(currentTick))); // add to slot 3

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

1557:                             int128(

1548:                             int128(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1144-L1144), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1149-L1149), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L314-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L313-L313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1557-L1557), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1548-L1548)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

1215:             int128(int256(amount1))

1177:                 .toLeftSlot(int128(int256(Math.mulDiv128(feeGrowthInside1LastX128, liquidity))));

1172:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside1LastX128, liquidity)))

1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

1242:                 -int128(int256(amount1))

1176:                 .toRightSlot(int128(int256(Math.mulDiv128(feeGrowthInside0LastX128, liquidity))))

1169:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside0LastX128, liquidity)))

1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1215-L1215) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1177-L1177), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1172-L1172), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1214-L1214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1242-L1242), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1176-L1176), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1169-L1169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1241-L1241)


```solidity

File: ./contracts/libraries/FeesCalc.sol

118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));

117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L118-L118) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L117-L117)


```solidity

File: ./contracts/libraries/Math.sol

130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L130-L130) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L131-L131)


```solidity

File: ./contracts/libraries/PanopticMath.sol

377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

693:             int256 balance0 = int256(uint256(tokenData0.rightSlot())) -

695:             int256 balance1 = int256(uint256(tokenData1.rightSlot())) -

51:             poolId += uint64(uint24(tickSpacing)) << 48;

103:                 (uint248(uint256(keccak256(abi.encode(tokenId)))));

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

230:                     uint256(uint24(lastObservedTick));

217:                     entry = int24(uint24(medianData >> (rank * 24)));

229:                     uint256(uint192(medianData << 24)) +

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L377-L377) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L693-L693), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L695-L695), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L51-L51), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L103-L103), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L183-L183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L178-L178), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L179-L179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L230-L230), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L217-L217), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L229-L229), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L258-L258)


```solidity

File: ./contracts/types/LeftRight.sol

27:         int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));

196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();

201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L27-L27) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L196-L196), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L201-L201)


```solidity

File: ./contracts/types/LiquidityChunk.sol

173:             return int24(int256(LiquidityChunk.unwrap(self) >> 232));

182:             return int24(int256(LiquidityChunk.unwrap(self) >> 208));

109:                     LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)

78:                     (uint256(uint24(_tickLower)) << 232) +

79:                         (uint256(uint24(_tickUpper)) << 208) +

126:                     LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L173-L173) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L182-L182), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L109-L109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L78-L78), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L79-L79), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L126-L126)


```solidity

File: ./contracts/types/TokenId.sol

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

195:             return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L98-L98) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L160-L160), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L195-L195)


</details>


### [L&#x2011;11] `external` calls in an un-bounded loop may result in a DOS 
Consider limiting the number of iterations in loops that make external calls


*There are 58 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1210:             TokenId tokenId = TokenId.wrap(positionBalanceArray[i][0]);

1213:             uint128 positionSize = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).rightSlot();

1216:             uint128 poolUtilization = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).leftSlot();

712:                         LeftRightSigned


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1210-L1210) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1213-L1213), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1216-L1216), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L712-L712)


```solidity

File: ./contracts/PanopticPool.sol

444:             balances[k][0] = TokenId.unwrap(tokenId);

445:             balances[k][1] = LeftRightUnsigned.unwrap(s_positionBalance[c_user][tokenId]);

452:                     LeftRightUnsigned.wrap(balances[k][1]).rightSlot(),

462:                         abi.encodePacked(

473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),

477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),

477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

751:                 (uint128 premiumAccumulator0, uint128 premiumAccumulator1) = SFPM.getAccountPremium(

762:                 s_options[msg.sender][tokenId][leg] = LeftRightUnsigned

870:             s_options[owner][tokenId][leg] = LeftRightUnsigned.wrap(0);

1528:                 (premiumAccumulatorsByLeg[leg][0], premiumAccumulatorsByLeg[leg][1]) = SFPM

1545:                     premiaByLeg[leg] = LeftRightSigned

1567:                         premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);

1674:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))

1707:                 (grossCurrent[0], grossCurrent[1]) = SFPM.getAccountPremium(

1725:                     s_grossPremiumLast[chunkKey] = LeftRightUnsigned

1856:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))

1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {

1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),

1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

1866:                         settledTokens = LeftRightUnsigned.wrap(

1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),

1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

1868:                                 LeftRightSigned.unwrap(

1965:                             : LeftRightUnsigned

1929:                             ? LeftRightUnsigned

1869:                                     LeftRightSigned

1870:                                         .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L444-L444) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L445-L445), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L452-L452), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L462-L462), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L473-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L473-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L751-L751), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L762-L762), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L870-L870), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1528-L1528), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1545-L1545), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1567-L1567), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1674-L1674), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1707-L1707), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1725-L1725), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1856-L1856), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1862-L1862), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1892-L1892), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1901-L1901), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1866-L1866), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1892-L1892), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1901-L1901), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1868-L1868), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1965-L1965), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1929-L1929), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1869-L1869), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1870-L1870)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

612:                 abi.encodePacked(

621:                 abi.encodePacked(

634:             ) revert Errors.TransferFailed();

638:             if (LeftRightUnsigned.unwrap(fromLiq) != liquidityChunk.liquidity())

639:                 revert Errors.TransferFailed();

645:             s_accountLiquidity[positionKey_from] = LeftRightUnsigned.wrap(0);

648:             s_accountFeesBase[positionKey_from] = LeftRightSigned.wrap(0);

632:                 (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||

633:                 (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L576-L576) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L577-L577), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L576-L576), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L612-L612), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L621-L621), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L634-L634), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L638-L638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L639-L639), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L645-L645), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L648-L648), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L632-L632), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L633-L633)


```solidity

File: ./contracts/libraries/PanopticMath.sol

138:                 (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(

879:                             abi.encodePacked(

898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L138-L138) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L879-L879), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L898-L898)


```solidity

File: ./contracts/multicall/Multicall.sol

15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L15-L15) 


```solidity

File: ./contracts/types/TokenId.sol

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

533:                 ) revert Errors.InvalidTokenIdParameter(4);

513:                         revert Errors.InvalidTokenIdParameter(1);

542:                         revert Errors.InvalidTokenIdParameter(3);

548:                     ) revert Errors.InvalidTokenIdParameter(3);

561:                         revert Errors.InvalidTokenIdParameter(4);

567:                         revert Errors.InvalidTokenIdParameter(5);

522:                         revert Errors.InvalidTokenIdParameter(6);

512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L528-L528) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L533-L533), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L513-L513), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L542-L542), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L548-L548), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L561-L561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L567-L567), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L522-L522), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L512-L512)


</details>


### [L&#x2011;12] increase/decrease or forceApprove allowance should be used instead of approve 
In order to prevent front running, increase/decrease or forceApprove allowance should be used in place of approve where possible 


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L32-L32) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L36-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L37-L37)


</details>


### [L&#x2011;13] Initialization can be front-run 
The `initialize()` functions are not protected by a modifier, which allow attackers to call this function once the contract is deployed through the proxy. Consider adding modifiers to protect this function or create a contract that both deploy the project and initialize it on the same transaction.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

134:     function initialize(address _owner) public {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L134-L134) 


</details>


### [L&#x2011;14] `internal` Function calls within for loops 
Making function calls or external calls within loops in Solidity can lead to inefficient gas usage, potential bottlenecks, and increased vulnerability to attacks. Each function call or external call consumes gas, and when executed within a loop, the gas cost multiplies, potentially causing the transaction to run out of gas or exceed block gas limits. This can result in transaction failure or unpredictable behavior.


*There are 16 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1219:             uint256 _tokenRequired = _getRequiredCollateralAtTickSinglePosition(

1259:                 tokenRequired += _getRequiredCollateralSingleLeg(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1219-L1219) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1259-L1259)


```solidity

File: ./contracts/PanopticPool.sol

450:             ) = _getPremia(

469:                     LeftRightUnsigned availablePremium = _getAvailablePremium(

470:                         _getTotalLiquidity(tokenId, leg),

770:                 _checkLiquiditySpread(

804:             (paidAmounts, premiasByLeg[i]) = _burnOptions(

868:                 _checkLiquiditySpread(tokenId, leg, tickLower, tickUpper, MAX_SPREAD);

1687:                 uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);

1882:                     uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);

1888:                     LeftRightUnsigned availablePremium = _getAvailablePremium(

469:                     LeftRightUnsigned availablePremium = _getAvailablePremium(

470:                         _getTotalLiquidity(tokenId, leg),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L450-L450) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L469-L469), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L470-L470), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L770-L770), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L804-L804), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L868-L868), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1687-L1687), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1882-L1882), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1888-L1888), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L469-L469), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L470-L470)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

910:                 (_moved, _itmAmounts, _collectedSingleLeg) = _createLegInAMM(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L577-L577) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L910-L910)


```solidity

File: ./contracts/libraries/PanopticMath.sol

397:             (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L397-L397) 


</details>


### [L&#x2011;15] Loss of precision 
Division by large numbers may result in the result being zero, due to solidity not supporting fractions. Consider requiring a minimum amount for the numerator to ensure that it is always larger than the denominator


*There are 23 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

207:                     (6510 * ratioTick ** 3) /

205:                     (7812 * ratioTick ** 2) /

262:             s_ITMSpreadFee = uint128((ITM_SPREAD_MULTIPLIER * _poolFee) / DECIMALS);

732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))

677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)

743:             return int256((s_inAMM * DECIMALS) / totalAssets());


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L207-L207) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L205-L205), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L262-L262), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L732-L732), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L731-L731), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L677-L677), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L743-L743)


```solidity

File: ./contracts/PanopticFactory.sol

392:             tickLower = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L392-L392) 


```solidity

File: ./contracts/PanopticPool.sol

1559:                                     ((premiumAccumulatorsByLeg[leg][1] -

1550:                                     ((premiumAccumulatorsByLeg[leg][0] -

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *

1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1559-L1559) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1550-L1550), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1768-L1768), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1770-L1770)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1367-L1367) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1391-L1391)


```solidity

File: ./contracts/libraries/Math.sol

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

196:                 mulDiv(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L176-L176) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L196-L196)


```solidity

File: ./contracts/libraries/PanopticMath.sol

150:                     (tickCumulatives[i] - tickCumulatives[i + 1]) /

195:                         (tickCumulative_last - tickCumulative_old) /

258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))

346:             int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

347:             int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L150-L150) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L195-L195), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L258-L258), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L346-L346), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L347-L347)


</details>


### [L&#x2011;16] Governance operations should be behind a timelock 
All critical and governance operations should be protected by a timelock. For example from the point of view of a user, the changing of the owner of a contract is a high risk operation that may have outcomes ranging from an attacker gaining control over the protocol, to the function no longer functioning due to a typo in the destination address. To give users plenty of warning so that they can validate any ownership changes, changes of ownership should be behind a timelock.


*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

864:     function delegate(
865:         address delegator,
866:         address delegatee,
867:         uint256 assets
868:     ) external onlyPanopticPool {
869:         /*
870:                 babaabaabaabaabaabaabaabaaba
871:                 baPanopticba
872:                 baPool    ba
873:                 baabaabaabaabaaba,baabaabaaba
874:                      ba(1) convert 'assets' to shares (this ERC20 contract)
875:         babaabaabaabaabaabaabaabaabaaba  ba  babaabaabaabaabaabaabaabaabaaba
876:         badelegatorbabaabaab<baabaab:delegateeba
877:         baabaabaabaabaabaabaabaabaabaaba(2)  baabaabaabaabaabaabaabaabaabaaba
878:                 move shares
879:                 from delegator
880:                 to delegatee
881:         */
882: 
883:         uint256 shares = convertToShares(assets);
884: 
885:         // transfer shares from the delegator to the delegatee
886:         _transferFrom(delegator, delegatee, shares);
887:     }

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {
895:         balanceOf[delegatee] += convertToShares(assets);
896:     }

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {
904:         balanceOf[delegatee] -= convertToShares(assets);
905:     }

911:     function revoke(
912:         address delegator,
913:         address delegatee,
914:         uint256 assets
915:     ) external onlyPanopticPool {
916:         /**
917:                 babaabaabaabaabaabaabaabaaba
918:                 baPanopticba
919:                 baPool    ba
920:                 baabaabaabaabaaba,baabaabaaba
921:                      ba(1) convert 'assets' to shares (this ERC20 contract)
922:         babaabaabaabaabaabaabaabaabaaba  ba babaabaabaabaabaabaabaabaabaaba
923:         badelegatorbbaabaab<baaba$delegateeba
924:         baabaabaabaabaabaabaabaabaabaaba(2) baabaabaabaabaabaabaabaabaabaaba
925:             moves shares
926:             from delegatee
927:             back to delegator
928:         */
929: 
930:         uint256 shares = convertToShares(assets);
931: 
932:         // get the delegateeBalance and compare later against requestedAmount
933:         uint256 delegateeBalance = balanceOf[delegatee];
934: 
935:         // if requested amount is larger than user balance, transfer shares back,
936:         // then issue new shares
937:         if (shares > delegateeBalance) {
938:             // transfer delegatee balance to delegator
939:             _transferFrom(delegatee, delegator, delegateeBalance);
940: 
941:             // this is paying out protocol loss, so correct for that in the amount of shares to be minted
942:             // X: total assets in vault
943:             // Y: total supply of shares
944:             // Z: desired value (assets) of shares to be minted
945:             // N: total shares corresponding to Z
946:             // T: transferred shares from liquidatee which are a component of N but do not contribute toward protocol loss
947:             // Z = N * X / (Y + N - T)
948:             // Z * (Y + N - T) = N * X
949:             // ZY + ZN - ZT = NX
950:             // ZY - ZT = N(X - Z)
951:             // N = (ZY - ZT) / (X - Z)
952:             // N = Z(Y - T) / (X - Z)
953:             // subtract delegatee balance from N since it was already transferred to the delegator
954:             _mint(
955:                 delegator,
956:                 Math.mulDiv(
957:                     assets,
958:                     totalSupply - delegateeBalance,
959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))
960:                 ) - delegateeBalance
961:             );
962:         }
963:         // if requested amount < delegatee balance, then just transfer shares back
964:         else {
965:             _transferFrom(delegatee, delegator, shares);
966:         }
967:     }

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {
976:         if (assets > 0) {
977:             _transferFrom(refunder, refundee, convertToShares(uint256(assets)));
978:         } else {
979:             unchecked {
980:                 _transferFrom(refundee, refunder, convertToShares(uint256(-assets)));
981:             }
982:         }
983:     }

0995:     function takeCommissionAddData(
0996:         address optionOwner,
0997:         int128 longAmount,
0998:         int128 shortAmount,
0999:         int128 swappedAmount
1000:     ) external onlyPanopticPool returns (int256 utilization) {
1001:         unchecked {
1002:             // current available assets belonging to PLPs (updated after settlement) excluding any premium paid
1003:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;
1004: 
1005:             // constrict premium to only assets not belonging to PLPs (i.e premium paid by sellers or collected from the pool earlier)
1006:             int256 tokenToPay = _getExchangedAmount(longAmount, shortAmount, swappedAmount);
1007: 
1008:             // compute tokens to be paid due to swap
1009:             // mint or burn tokens due to minting in-the-money
1010:             if (tokenToPay > 0) {
1011:                 // if user must pay tokens, burn them from user balance
1012:                 uint256 sharesToBurn = Math.mulDivRoundingUp(
1013:                     uint256(tokenToPay),
1014:                     totalSupply,
1015:                     totalAssets()
1016:                 );
1017:                 _burn(optionOwner, sharesToBurn);
1018:             } else if (tokenToPay < 0) {
1019:                 // if user must receive tokens, mint them
1020:                 uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
1021:                 _mint(optionOwner, sharesToMint);
1022:             }
1023: 
1024:             // update stored asset balances with net moved amounts
1025:             // the inflow or outflow of pool assets is defined by the swappedAmount: it includes both the ITM swap amounts and the short/long amounts used to create the position
1026:             // however, any intrinsic value is paid for by the users, so we only add the portion that comes from PLPs: the short/long amounts
1027:             // premia is not included in the balance since it is the property of options buyers and sellers, not PLPs
1028:             s_poolAssets = uint128(uint256(updatedAssets));
1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));
1030: 
1031:             utilization = _poolUtilization();
1032:         }
1033:     }

1043:     function exercise(
1044:         address optionOwner,
1045:         int128 longAmount,
1046:         int128 shortAmount,
1047:         int128 swappedAmount,
1048:         int128 realizedPremium
1049:     ) external onlyPanopticPool returns (int128) {
1050:         unchecked {
1051:             // current available assets belonging to PLPs (updated after settlement) excluding any premium paid
1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;
1053: 
1054:             // add premium to be paid/collected on position close
1055:             int256 tokenToPay = -realizedPremium;
1056: 
1057:             // if burning ITM and swap occurred, compute tokens to be paid through exercise and add swap fees
1058:             int256 intrinsicValue = swappedAmount - (longAmount - shortAmount);
1059: 
1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {
1061:                 // intrinsic value is the amount that need to be exchanged due to burning in-the-money
1062: 
1063:                 // add the intrinsic value to the tokenToPay
1064:                 tokenToPay += intrinsicValue;
1065:             }
1066: 
1067:             if (tokenToPay > 0) {
1068:                 // if user must pay tokens, burn them from user balance (revert if balance too small)
1069:                 uint256 sharesToBurn = Math.mulDivRoundingUp(
1070:                     uint256(tokenToPay),
1071:                     totalSupply,
1072:                     totalAssets()
1073:                 );
1074:                 _burn(optionOwner, sharesToBurn);
1075:             } else if (tokenToPay < 0) {
1076:                 // if user must receive tokens, mint them
1077:                 uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
1078:                 _mint(optionOwner, sharesToMint);
1079:             }
1080: 
1081:             // update stored asset balances with net moved amounts
1082:             // any intrinsic value is paid for by the users, so we do not add it to s_inAMM
1083:             // premia is not included in the balance since it is the property of options buyers and sellers, not PLPs
1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));
1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));
1086: 
1087:             return (int128(tokenToPay));
1088:         }
1089:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L864-L887) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L896), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L903-L905), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L911-L967), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L975-L983), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L995-L1033), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1089)


</details>


### [L&#x2011;17] Consider using OpenZeppelinâ€™s SafeCast library to prevent unexpected overflows when casting from various type int/uint values 



*There are 108 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `_sellerCollateralRatio` is getting converted from `uint256` to `int256`
200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

//@audit `assets` is getting converted from `uint256` to `uint128`
436:             s_poolAssets += uint128(assets);

//@audit `assets` is getting converted from `uint256` to `uint128`
496:             s_poolAssets += uint128(assets);

//@audit `assets` is getting converted from `uint256` to `uint128`
552:             s_poolAssets -= uint128(assets);

//@audit `assets` is getting converted from `uint256` to `uint128`
612:             s_poolAssets -= uint128(assets);

//@audit `oracleValue1` is getting converted from `uint256` to `uint128`
718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

//@audit `currentValue1` is getting converted from `uint256` to `uint128`
718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))

//@audit `oracleValue0` is getting converted from `uint256` to `uint128`
715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

//@audit `currentValue0` is getting converted from `uint256` to `uint128`
715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))

//@audit `utilization` is getting converted from `int256` to `uint256`
784:         if (uint256(utilization) < TARGET_POOL_UTIL) {

//@audit `utilization` is getting converted from `int256` to `uint256`
790:         if (uint256(utilization) > SATURATED_POOL_UTIL) {

//@audit `utilization` is getting converted from `int256` to `uint256`
797:                 ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /

//@audit `assets` is getting converted from `uint256` to `int256`
959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))

//@audit `assets` is getting converted from `int256` to `uint256`
977:             _transferFrom(refunder, refundee, convertToShares(uint256(assets)));

//@audit `s_poolAssets` is getting converted from `uint128` to `uint256`
1003:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

//@audit `updatedAssets` is getting converted from `int256` to `uint256`
1028:             s_poolAssets = uint128(uint256(updatedAssets));

//@audit `tokenToPay` is getting converted from `int256` to `uint256`
1013:                     uint256(tokenToPay),

//@audit `s_inAMM` is getting converted from `uint128` to `uint256`
1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

//@audit `tokenToPay` is getting converted from `int256` to `int128`
1087:             return (int128(tokenToPay));

//@audit `s_poolAssets` is getting converted from `uint128` to `uint256`
1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;

//@audit `tokenToPay` is getting converted from `int256` to `uint256`
1070:                     uint256(tokenToPay),

//@audit `s_inAMM` is getting converted from `uint128` to `uint256`
1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

//@audit `swapCommission` is getting converted from `uint256` to `int256`
1115:                 exchangedAmount = intrinsicValue + int256(swapCommission);

//@audit `premiumAllPositions` is getting converted from `int128` to `uint128`
1184:                 netBalance += uint256(uint128(premiumAllPositions));

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1329:             ? int64(uint64(poolUtilization))

//@audit `utilization` is getting converted from `int256` to `uint256`
1491:             uint256 buyCollateral = _buyCollateralRatio(uint256(utilization));

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1585:                     ? int64(uint64(poolUtilization))

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1631:             uint64 poolUtilization0 = uint64(poolUtilization);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L200-L200) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L436-L436), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L496-L496), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L552-L552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L612-L612), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L718-L718), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L718-L718), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L715-L715), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L715-L715), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L784-L784), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L790-L790), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L797-L797), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L959-L959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L977-L977), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1003-L1003), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1028-L1028), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1013-L1013), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1029-L1029), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1087-L1087), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1052-L1052), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1070-L1070), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1085-L1085), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1115-L1115), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1184-L1184), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1329-L1329), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1491-L1491), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1585-L1585), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1631-L1631)


```solidity

File: ./contracts/PanopticPool.sol

//@audit `currentTick` is getting converted from `int24` to `uint24`
314:                 (uint256(uint24(currentTick))); // add to slot 3

//@audit `currentTick` is getting converted from `int24` to `uint24`
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

//@audit `utilization0` is getting converted from `int256` to `uint256`
730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

//@audit `utilization1` is getting converted from `int256` to `uint256`
730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

//@audit `fastOracleTick` is getting converted from `int24` to `int256`
943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

//@audit `liquidationBonus1` is getting converted from `int256` to `int128`
1168:             .toLeftSlot(int128(liquidationBonus1));

//@audit `liquidationBonus0` is getting converted from `int256` to `int128`
1167:             .toRightSlot(int128(liquidationBonus0))

//@audit `effectiveLiquidityLimitX32` is getting converted from `uint64` to `uint256`
1492:         if (effectiveLiquidityFactorX32 > uint256(effectiveLiquidityLimitX32))

//@audit `totalLiquidity` is getting converted from `uint128` to `uint256`
1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L314-L314) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L313-L313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L730-L730), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L730-L730), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L943-L943), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1168-L1168), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1167-L1167), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1492-L1492), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1487-L1487)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `poolId` is getting converted from `uint64` to `uint256`
388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

//@audit `amount1Delta` is getting converted from `int256` to `uint256`
453:         uint256 amountToPay = amount0Delta > 0 ? uint256(amount0Delta) : uint256(amount1Delta);

//@audit `amount0Delta` is getting converted from `int256` to `uint256`
453:         uint256 amountToPay = amount0Delta > 0 ? uint256(amount0Delta) : uint256(amount1Delta);

//@audit `amount` is getting converted from `uint256` to `uint128`
607:                 uint128(amount)

//@audit `amount1` is getting converted from `uint256` to `int256`
1215:             int128(int256(amount1))

//@audit `amount0` is getting converted from `uint256` to `int256`
1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

//@audit `amount1` is getting converted from `uint256` to `int256`
1242:                 -int128(int256(amount1))

//@audit `amount0` is getting converted from `uint256` to `int256`
1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L388-L388) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L453-L453), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L453-L453), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L607-L607), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1215-L1215), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1214-L1214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1242-L1242), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1241-L1241)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit `amount0` is getting converted from `uint256` to `int256`
74:                         value0 -= int256(amount0);

//@audit `amount1` is getting converted from `uint256` to `int256`
75:                         value1 -= int256(amount1);

//@audit `amount0` is getting converted from `uint256` to `int256`
69:                         value0 += int256(amount0);

//@audit `amount1` is getting converted from `uint256` to `int256`
70:                         value1 += int256(amount1);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L74-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L75-L75), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L69-L69), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L70-L70)


```solidity

File: ./contracts/libraries/Math.sol

//@audit `x` is getting converted from `int256` to `uint256`
83:             return x > 0 ? uint256(x) : uint256(-x);

//@audit `tick` is getting converted from `int24` to `int256`
130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

//@audit `tick` is getting converted from `int24` to `int256`
130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

//@audit `toDowncast` is getting converted from `uint256` to `uint128`
297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

//@audit `toDowncast` is getting converted from `uint256` to `uint128`
303:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) {

//@audit `toCast` is getting converted from `uint128` to `int128`
312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

//@audit `toCast` is getting converted from `int256` to `int128`
319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

//@audit `toCast` is getting converted from `uint256` to `int256`
327:         return int256(toCast);

//@audit `i` is getting converted from `int256` to `uint256`
760:                 while (arr[uint256(i)] < pivot) i++;

//@audit `j` is getting converted from `int256` to `uint256`
761:                 while (pivot < arr[uint256(j)]) j--;

//@audit `i` is getting converted from `int256` to `uint256`
763:                     (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);

//@audit `j` is getting converted from `int256` to `uint256`
763:                     (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);

//@audit `j` is getting converted from `int256` to `uint256`
763:                     (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);

//@audit `i` is getting converted from `int256` to `uint256`
763:                     (arr[uint256(i)], arr[uint256(j)]) = (arr[uint256(j)], arr[uint256(i)]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L83-L83) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L297-L297), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L303-L303), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L312-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L319-L319), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L327-L327), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L760-L760), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L761-L761), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L763-L763), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L763-L763), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L763-L763), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L763-L763)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit `tickSpacing` is getting converted from `int24` to `uint24`
51:             poolId += uint64(uint24(tickSpacing)) << 48;

//@audit `poolId` is getting converted from `uint64` to `uint48`
62:             return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);

//@audit `existingHash` is getting converted from `uint256` to `uint248`
102:             uint248 updatedHash = uint248(existingHash) ^

//@audit `updatedHash` is getting converted from `uint248` to `uint256`
108:                     : uint256(updatedHash) + (((existingHash >> 248) - 1) << 248);

//@audit `updatedHash` is getting converted from `uint248` to `uint256`
107:                     ? uint256(updatedHash) + (((existingHash >> 248) + 1) << 248)

//@audit `observationCardinality` is getting converted from `uint256` to `int256`
141:                             int256(observationCardinality)

//@audit `observationIndex` is getting converted from `uint256` to `int256`
140:                         (int256(observationIndex) - int256(i * period)) +

//@audit `lastObservedTick` is getting converted from `int24` to `uint24`
230:                     uint256(uint24(lastObservedTick));

//@audit `observationCardinality` is getting converted from `uint256` to `int256`
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)

//@audit `observationIndex` is getting converted from `uint256` to `int256`
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)

//@audit `newOrderMap` is getting converted from `uint24` to `uint256`
228:                     (uint256(newOrderMap) << 192) +

//@audit `positionSize` is getting converted from `uint128` to `uint256`
324:         uint256 amount = uint256(positionSize) * tokenId.optionRatio(legIndex);

//@audit `width` is getting converted from `int24` to `uint24`
377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

//@audit `tickSpacing` is getting converted from `int24` to `uint24`
377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

//@audit `notional` is getting converted from `uint256` to `uint128`
481:             return uint128(notional);

//@audit `sqrtPriceX96` is getting converted from `uint160` to `uint256`
495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);

//@audit `sqrtPriceX96` is getting converted from `uint160` to `uint256`
512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

//@audit `sqrtPriceX96` is getting converted from `uint160` to `uint256`
530:                     .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

//@audit `sqrtPriceX96` is getting converted from `uint160` to `uint256`
553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

//@audit `haircut0` is getting converted from `int256` to `int128`
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));

//@audit `haircut1` is getting converted from `int256` to `int128`
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));

//@audit `haircut0` is getting converted from `int256` to `uint256`
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),

//@audit `haircut1` is getting converted from `int256` to `uint256`
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),

//@audit `settled1` is getting converted from `uint256` to `uint128`
899:                                 uint128(settled1)

//@audit `settled0` is getting converted from `uint256` to `uint128`
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(

//@audit `balanceShortage` is getting converted from `int256` to `uint256`
939:                                     PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)

//@audit `balanceShortage` is getting converted from `int256` to `uint256`
957:                                     PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L51-L51) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L62-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L102-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L107-L107), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L141-L141), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L140-L140), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L230-L230), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L188-L188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L188-L188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L228-L228), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L324-L324), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L377-L377), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L377-L377), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L481-L481), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L495-L495), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L530-L530), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L553-L553), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L856-L856), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L857-L857), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L870-L870), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L874-L874), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L899-L899), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L898-L898), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L939-L939), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L957-L957)


```solidity

File: ./contracts/types/LeftRight.sol

//@audit `left` is getting converted from `uint128` to `uint256`
126:             return LeftRightUnsigned.wrap(LeftRightUnsigned.unwrap(self) + (uint256(left) << 128));

//@audit `left` is getting converted from `int128` to `int256`
136:             return LeftRightSigned.wrap(LeftRightSigned.unwrap(self) + (int256(left) << 128));

//@audit `left` is getting converted from `int256` to `int128`
197:             int128 left128 = int128(left);

//@audit `right` is getting converted from `int256` to `int128`
202:             int128 right128 = int128(right);

//@audit `left256` is getting converted from `int256` to `int128`
217:             int128 left128 = int128(left256);

//@audit `right256` is getting converted from `int256` to `int128`
220:             int128 right128 = int128(right256);

//@audit `left256` is getting converted from `int256` to `int128`
235:             int128 left128 = int128(left256);

//@audit `right256` is getting converted from `int256` to `int128`
238:             int128 right128 = int128(right256);

//@audit `left256` is getting converted from `int256` to `int128`
257:             int128 left128 = int128(left256);

//@audit `right256` is getting converted from `int256` to `int128`
260:             int128 right128 = int128(right256);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L126-L126) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L136-L136), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L197-L197), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L202-L202), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L217-L217), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L220-L220), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L235-L235), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L238-L238), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L257-L257), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L260-L260)


```solidity

File: ./contracts/types/LiquidityChunk.sol

//@audit `amount` is getting converted from `uint128` to `uint256`
80:                         uint256(amount)

//@audit `_tickLower` is getting converted from `int24` to `uint24`
78:                     (uint256(uint24(_tickLower)) << 232) +

//@audit `_tickUpper` is getting converted from `int24` to `uint24`
79:                         (uint256(uint24(_tickUpper)) << 208) +

//@audit `_tickLower` is getting converted from `int24` to `uint24`
109:                     LiquidityChunk.unwrap(self) + (uint256(uint24(_tickLower)) << 232)

//@audit `_tickUpper` is getting converted from `int24` to `uint24`
126:                     LiquidityChunk.unwrap(self) + ((uint256(uint24(_tickUpper))) << 208)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L80-L80) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L78-L78), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L79-L79), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L109-L109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L126-L126)


```solidity

File: ./contracts/types/TokenId.sol

//@audit `_tickSpacing` is getting converted from `int24` to `uint24`
195:             return TokenId.wrap(TokenId.unwrap(self) + (uint256(uint24(_tickSpacing)) << 48));

//@audit `_strike` is getting converted from `int24` to `int256`
300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))

//@audit `_width` is getting converted from `int24` to `uint24`
320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L195-L195) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L300-L300), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L320-L320)


</details>


### [L&#x2011;18] `symbol()` is not a part of the ERC-20 standard 
The `symbol()` function is not a part of the [ERC-20 standard](https://eips.ethereum.org/EIPS/eip-20), and was added later as an [optional extension](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/IERC20Metadata.sol). As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

60:         try IERC20Metadata(token0).symbol() returns (string memory _symbol) {

65:         try IERC20Metadata(token1).symbol() returns (string memory _symbol) {

97:         try IERC20Metadata(token).symbol() returns (string memory tokenSymbol) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L60-L60) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L65-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L97-L97)


</details>


### [L&#x2011;19] Int casting `block.timestamp` can reduce the lifespan of a contract 
Consider removing casting to ensure future functionality.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

309:                 (uint256(block.timestamp) << 216) +


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L309) 


</details>


### [L&#x2011;20] Large transfers may not work with some `ERC20` tokens 
Some `IERC20` implementations (e.g `UNI`, `COMP`) may fail if the valued transferred is larger than `uint96`. [Source](https://github.com/d-xo/weird-erc20#revert-on-large-approvals--transfers)


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

333:         return ERC20Minimal.transfer(recipient, amount);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L333-L333) 


</details>


### [L&#x2011;21] Unsafe downcast 
When a type is downcast to a smaller type, the higher order bits are truncated, effectively applying a modulo to the original value. Without any other checks, this wrapping will lead to unexpected behavior and bugs


*There are 99 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit converting from `uint256` to `uint128`
262:             s_ITMSpreadFee = uint128((ITM_SPREAD_MULTIPLIER * _poolFee) / DECIMALS);

//@audit `assets` is getting converted from `uint256` to `uint128`
612:             s_poolAssets -= uint128(assets);

//@audit converting from `int256` to `int128`
732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

//@audit converting from `int256` to `int24`
667:                     int24 range = int24(

//@audit converting from `int256` to `int128`
731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))

//@audit converting from `uint256` to `uint128`
1028:             s_poolAssets = uint128(uint256(updatedAssets));

//@audit converting from `uint256` to `uint128`
1029:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) + (shortAmount - longAmount)));

//@audit converting from `uint256` to `uint128`
1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));

//@audit converting from `uint256` to `uint128`
1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));

//@audit converting from `uint128` to `uint64`
1330:             : int64(uint64(poolUtilization >> 64));

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1329:             ? int64(uint64(poolUtilization))

//@audit converting from `uint128` to `uint64`
1586:                     : int64(uint64(poolUtilization >> 64))

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1585:                     ? int64(uint64(poolUtilization))

//@audit `poolUtilization` is getting converted from `uint128` to `uint64`
1631:             uint64 poolUtilization0 = uint64(poolUtilization);

//@audit converting from `uint128` to `uint64`
1632:             uint64 poolUtilization1 = uint64(poolUtilization >> 64);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L262-L262) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L612-L612), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L732-L732), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L667-L667), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L731-L731), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1028-L1028), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1029-L1029), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1084-L1084), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1085-L1085), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1330-L1330), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1329-L1329), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1586-L1586), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1585-L1585), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1631-L1631), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1632-L1632)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit converting from `uint256` to `uint128`
365:                 uint128 liquidity0 = uint128(

//@audit converting from `uint256` to `uint128`
368:                 uint128 liquidity1 = uint128(

//@audit converting from `uint256` to `uint128`
352:                 fullRangeLiquidity = uint128(

//@audit converting from `uint256` to `uint128`
356:                 fullRangeLiquidity = uint128(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L365-L365) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L368-L368), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L352-L352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L356-L356)


```solidity

File: ./contracts/PanopticPool.sol

//@audit converting from `uint128` to `uint64`
366:         poolUtilization0 = uint64(balanceData.leftSlot());

//@audit converting from `uint128` to `uint64`
370:         poolUtilization1 = uint64(balanceData.leftSlot() >> 64);

//@audit converting from `uint256` to `uint128`
730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

//@audit converting from `uint256` to `uint128`
730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));

//@audit converting from `uint256` to `uint64`
775:                     uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))

//@audit `liquidationBonus1` is getting converted from `int256` to `int128`
1168:             .toLeftSlot(int128(liquidationBonus1));

//@audit `liquidationBonus0` is getting converted from `int256` to `int128`
1167:             .toRightSlot(int128(liquidationBonus0))

//@audit converting from `int256` to `int128`
1557:                             int128(

//@audit converting from `int256` to `int128`
1548:                             int128(

//@audit converting from `int256` to `int128`
1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

//@audit converting from `int256` to `int128`
1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

//@audit converting from `uint256` to `uint128`
1736:                             uint128(

//@audit converting from `uint256` to `uint128`
1728:                             uint128(

//@audit converting from `uint256` to `uint128`
1786:                         uint128(

//@audit converting from `uint256` to `uint128`
1777:                         uint128(

//@audit converting from `uint256` to `uint128`
1968:                                 .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));

//@audit converting from `uint256` to `uint128`
1949:                                     uint128(

//@audit converting from `uint256` to `uint128`
1967:                                 .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))

//@audit converting from `uint256` to `uint128`
1932:                                     uint128(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L366-L366) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L370-L370), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L730-L730), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L730-L730), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L775-L775), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1168-L1168), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1167-L1167), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1557-L1557), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1548-L1548), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1736-L1736), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1728-L1728), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1786-L1786), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1777-L1777), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1968-L1968), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1949-L1949), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1967-L1967), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1932-L1932)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `amount` is getting converted from `uint256` to `uint128`
607:                 uint128(amount)

//@audit converting from `int256` to `int128`
1177:                 .toLeftSlot(int128(int256(Math.mulDiv128(feeGrowthInside1LastX128, liquidity))));

//@audit converting from `int256` to `int128`
1172:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside1LastX128, liquidity)))

//@audit converting from `int256` to `int128`
1176:                 .toRightSlot(int128(int256(Math.mulDiv128(feeGrowthInside0LastX128, liquidity))))

//@audit converting from `int256` to `int128`
1169:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside0LastX128, liquidity)))

//@audit converting from `int256` to `int128`
1215:             int128(int256(amount1))

//@audit converting from `int256` to `int128`
1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

//@audit converting from `int256` to `int128`
1242:                 -int128(int256(amount1))

//@audit converting from `int256` to `int128`
1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(

//@audit converting from `uint256` to `uint64`
1567:         poolId = uint64(s_AddrToPoolIdData[univ3pool]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L607-L607) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1177-L1177), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1172-L1172), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1176-L1176), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1169-L1169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1215-L1215), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1214-L1214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1242-L1242), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1241-L1241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1567-L1567)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit converting from `int256` to `int128`
118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));

//@audit converting from `int256` to `int128`
117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L118-L118) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L117-L117)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit converting from `uint160` to `uint64`
50:             uint64 poolId = uint64(uint160(univ3pool) >> 112);

//@audit `poolId` is getting converted from `uint64` to `uint48`
62:             return (poolId & TICKSPACING_MASK) + (uint48(poolId) + 1);

//@audit `existingHash` is getting converted from `uint256` to `uint248`
102:             uint248 updatedHash = uint248(existingHash) ^

//@audit converting from `uint256` to `uint248`
103:                 (uint248(uint256(keccak256(abi.encode(tokenId)))));

//@audit converting from `int256` to `int24`
155:             return int24(Math.sort(ticks)[cardinality / 2]);

//@audit converting from `uint256` to `uint24`
200:                 uint24 orderMap = uint24(medianData >> 192);

//@audit converting from `uint256` to `uint40`
183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {

//@audit converting from `int256` to `int24`
194:                     lastObservedTick = int24(

//@audit converting from `uint256` to `uint24`
178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

//@audit converting from `uint256` to `uint24`
179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

//@audit converting from `uint256` to `uint24`
217:                     entry = int24(uint24(medianData >> (rank * 24)));

//@audit converting from `uint256` to `uint192`
229:                     uint256(uint192(medianData << 24)) +

//@audit converting from `uint256` to `uint24`
178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +

//@audit converting from `uint256` to `uint24`
179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /

//@audit converting from `int256` to `int24`
266:             return int24(sortedTicks[10]);

//@audit converting from `uint256` to `uint32`
249:                 secondsAgos[i] = uint32(((i + 1) * twapWindow) / 20);

//@audit converting from `int56` to `int24`
257:                 twapMeasurement[i] = int24(

//@audit converting from `int256` to `int24`
377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

//@audit converting from `uint256` to `uint128`
591:             amount1 = positionSize * uint128(tokenId.optionRatio(legIndex));

//@audit converting from `uint256` to `uint128`
585:             amount0 = positionSize * uint128(tokenId.optionRatio(legIndex));

//@audit converting from `int256` to `int128`
750:                     int128(balance1 - paid1)

//@audit converting from `int256` to `int128`
749:                 LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(

//@audit `settled1` is getting converted from `uint256` to `uint128`
899:                                 uint128(settled1)

//@audit `settled0` is getting converted from `uint256` to `uint128`
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(

//@audit converting from `int256` to `int128`
937:                             int128(

//@audit converting from `int256` to `int128`
955:                             int128(

//@audit converting from `int256` to `int128`
935:                         .toRightSlot(int128(refundValues.rightSlot() - balanceShortage))

//@audit converting from `int256` to `int128`
953:                         .toLeftSlot(int128(refundValues.leftSlot() - balanceShortage))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L50-L50) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L62-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L102-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L103-L103), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L155-L155), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L200-L200), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L183-L183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L194-L194), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L178-L178), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L179-L179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L217-L217), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L229-L229), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L178-L178), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L179-L179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L266-L266), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L249-L249), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L257-L257), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L377-L377), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L591-L591), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L585-L585), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L750-L750), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L749-L749), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L899-L899), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L898-L898), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L937-L937), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L955-L955), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L935-L935), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L953-L953)


```solidity

File: ./contracts/types/LeftRight.sol

//@audit converting from `uint256` to `uint128`
40:         return uint128(LeftRightUnsigned.unwrap(self));

//@audit converting from `int256` to `int128`
47:         return int128(LeftRightSigned.unwrap(self));

//@audit converting from `uint256` to `uint128`
69:                         uint256(uint128(LeftRightUnsigned.unwrap(self)) + right)

//@audit converting from `int256` to `int128`
89:                         (int256(int128(LeftRightSigned.unwrap(self)) + right) & RIGHT_HALF_BIT_MASK)

//@audit converting from `uint256` to `uint128`
102:         return uint128(LeftRightUnsigned.unwrap(self) >> 128);

//@audit converting from `int256` to `int128`
109:         return int128(LeftRightSigned.unwrap(self) >> 128);

//@audit converting from `uint256` to `uint128`
162:                 (uint128(LeftRightUnsigned.unwrap(z)) < uint128(LeftRightUnsigned.unwrap(x)))

//@audit converting from `uint256` to `uint128`
162:                 (uint128(LeftRightUnsigned.unwrap(z)) < uint128(LeftRightUnsigned.unwrap(x)))

//@audit converting from `uint256` to `uint128`
185:                 (uint128(LeftRightUnsigned.unwrap(z)) > uint128(LeftRightUnsigned.unwrap(x)))

//@audit converting from `uint256` to `uint128`
185:                 (uint128(LeftRightUnsigned.unwrap(z)) > uint128(LeftRightUnsigned.unwrap(x)))

//@audit converting from `int256` to `int128`
266:                     int128(Math.max(left128, 0))

//@audit converting from `int256` to `int128`
265:                 z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L40-L40) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L47-L47), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L69-L69), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L89-L89), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L102-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L109-L109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L162-L162), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L162-L162), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L185-L185), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L185-L185), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L266-L266), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L265-L265)


```solidity

File: ./contracts/types/LiquidityChunk.sol

//@audit converting from `int256` to `int24`
173:             return int24(int256(LiquidityChunk.unwrap(self) >> 232));

//@audit converting from `int256` to `int24`
182:             return int24(int256(LiquidityChunk.unwrap(self) >> 208));

//@audit converting from `uint256` to `uint128`
191:             return uint128(LiquidityChunk.unwrap(self));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L173-L173) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L182-L182), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L191-L191)


```solidity

File: ./contracts/types/TokenId.sol

//@audit converting from `uint256` to `uint64`
89:             return uint64(TokenId.unwrap(self));

//@audit converting from `uint256` to `uint24`
98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

//@audit converting from `int256` to `int24`
160:             return int24(int256(TokenId.unwrap(self) >> (64 + legIndex * 48 + 12)));

//@audit converting from `int256` to `int24`
171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

//@audit converting from `uint256` to `uint48`
521:                     if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {

//@audit converting from `uint256` to `uint48`
521:                     if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L89-L89) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L98-L98), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L160-L160), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L521-L521)


</details>


### [L&#x2011;22] Unsafe ERC20 operation `approve()` 
Approve call do not handle non-standard erc20 behavior.
- Some token contracts do not return any value.
- Some token contracts revert the transaction when the allowance is not zero.
Use `safeApprove` instead of `approve`


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L32-L32) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L36-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L37-L37)


</details>


### [L&#x2011;23] Unsafe conversion from unsigned to signed values 
Solidity follows [two's complement](https://en.wikipedia.org/wiki/Two%27s_complement) rules for its integers, meaning that the most significant bit for signed integers is used to denote the sign, and converting between the two requires inverting all of the bits and adding one. Because of this, casting an unsigned integer to a signed one may result in a change of the sign and or magnitude of the value. For example, `int8(type(uint8).max)` is not equal to `type(int8).max`, but is equal to `-1`. `type(uint8).max` in binary is `11111111`, which if cast to a signed value, means the first binary `1` indicates a negative value, and the binary `1`s, invert to all zeroes, and when one is added, it becomes one, but negative, and therefore the decimal value of binary `11111111` is `-1`.


*There are 16 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `_sellerCollateralRatio` is getting converted from `uint256` to `int256`
200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

//@audit `assets` is getting converted from `uint256` to `int256`
959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))

//@audit `swapCommission` is getting converted from `uint256` to `int256`
1115:                 exchangedAmount = intrinsicValue + int256(swapCommission);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L200-L200) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L959-L959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1115-L1115)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `amount1` is getting converted from `uint256` to `int256`
1215:             int128(int256(amount1))

//@audit `amount0` is getting converted from `uint256` to `int256`
1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

//@audit `amount1` is getting converted from `uint256` to `int256`
1242:                 -int128(int256(amount1))

//@audit `amount0` is getting converted from `uint256` to `int256`
1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1215-L1215) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1214-L1214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1242-L1242), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1241-L1241)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit `amount0` is getting converted from `uint256` to `int256`
74:                         value0 -= int256(amount0);

//@audit `amount1` is getting converted from `uint256` to `int256`
75:                         value1 -= int256(amount1);

//@audit `amount0` is getting converted from `uint256` to `int256`
69:                         value0 += int256(amount0);

//@audit `amount1` is getting converted from `uint256` to `int256`
70:                         value1 += int256(amount1);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L74-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L75-L75), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L69-L69), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L70-L70)


```solidity

File: ./contracts/libraries/Math.sol

//@audit `toCast` is getting converted from `uint128` to `int128`
312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L312-L312) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit `observationCardinality` is getting converted from `uint256` to `int256`
141:                             int256(observationCardinality)

//@audit `observationIndex` is getting converted from `uint256` to `int256`
140:                         (int256(observationIndex) - int256(i * period)) +

//@audit `observationCardinality` is getting converted from `uint256` to `int256`
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)

//@audit `observationIndex` is getting converted from `uint256` to `int256`
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L141-L141) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L140-L140), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L188-L188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L188-L188)


</details>


### [L&#x2011;24] Consider using descriptive `constant`s when passing zero as a function argument 
Passing zero as a function argument can sometimes result in a security issue (e.g. passing zero as the slippage parameter). Consider using a `constant` variable with a descriptive name, so it's clear that the argument is intentionally being used, and for the right reasons.


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

//@audit parameter number 2 starting from left
1227:         _burnAllOptionsFrom(account, 0, 0, COMMIT_LONG_SETTLED, touchedId);

//@audit parameter number 3 starting from left
1227:         _burnAllOptionsFrom(account, 0, 0, COMMIT_LONG_SETTLED, touchedId);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1227-L1227) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1227-L1227)


</details>


### [L&#x2011;25] Check of division by zero 



*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L677-L677) 


```solidity

File: ./contracts/PanopticFactory.sol

392:             tickLower = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L392-L392) 


```solidity

File: ./contracts/PanopticPool.sol

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1950:                                         uint256(

1933:                                         uint256(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1487-L1487) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1950-L1950), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1933-L1933)


```solidity

File: ./contracts/libraries/Math.sol

176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

196:                 mulDiv(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L176-L176) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L196-L196)


```solidity

File: ./contracts/libraries/PanopticMath.sol

346:             int24 minTick = (Constants.MIN_V3POOL_TICK / tickSpacing) * tickSpacing;

347:             int24 maxTick = (Constants.MAX_V3POOL_TICK / tickSpacing) * tickSpacing;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L346-L346) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L347-L347)


</details>


### [L&#x2011;26] unchecked blocks with additions/multiplications may overflow 
There aren't any checks to avoid an underflow which can happen inside an unchecked block, so the following additions/multiplications may underflow silently.


*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

729:         unchecked {
730:             return uint128(uint256(utilization0) + uint128(uint256(utilization1) << 64));
731:         }

1344:         unchecked {
1345:             // the cross-collateral balance, computed in terms of liquidity X*bP + Y/bP
1346:             // We use mulDiv to compute Y/bP + X*bP while correctly handling overflows, round down
1347:             balanceCross =
1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +
1349:                 Math.mulDiv96(tokenData0.rightSlot(), sqrtPriceX96);
1350:             // the amount of cross-collateral balance needed for the account to be solvent, computed in terms of liquidity
1351:             // overstimate by rounding up
1352:             thresholdCross =
1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +
1354:                 Math.mulDiv96RoundingUp(tokenData0.leftSlot(), sqrtPriceX96);
1355:         }

1806:         unchecked {
1807:             // totalLiquidity (total sold) = removedLiquidity + netLiquidity
1808: 
1809:             (int24 tickLower, int24 tickUpper) = tokenId.asTicks(leg);
1810:             uint256 tokenType = tokenId.tokenType(leg);
1811:             LeftRightUnsigned accountLiquidities = SFPM.getAccountLiquidity(
1812:                 address(s_univ3pool),
1813:                 address(this),
1814:                 tokenType,
1815:                 tickLower,
1816:                 tickUpper
1817:             );
1818: 
1819:             // removed + net
1820:             totalLiquidity = accountLiquidities.rightSlot() + accountLiquidities.leftSlot();
1821:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L729-L731) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1344-L1355), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1806-L1821)


```solidity

File: ./contracts/types/LeftRight.sol

195:         unchecked {
196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();
197:             int128 left128 = int128(left);
198: 
199:             if (left128 != left) revert Errors.UnderOverFlow();
200: 
201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();
202:             int128 right128 = int128(right);
203: 
204:             if (right128 != right) revert Errors.UnderOverFlow();
205: 
206:             return z.toRightSlot(right128).toLeftSlot(left128);
207:         }

215:         unchecked {
216:             int256 left256 = int256(x.leftSlot()) + y.leftSlot();
217:             int128 left128 = int128(left256);
218: 
219:             int256 right256 = int256(x.rightSlot()) + y.rightSlot();
220:             int128 right128 = int128(right256);
221: 
222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
223: 
224:             return z.toRightSlot(right128).toLeftSlot(left128);
225:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L195-L207) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L215-L225)


```solidity

File: ./contracts/types/TokenId.sol

296:         unchecked {
297:             return
298:                 TokenId.wrap(
299:                     TokenId.unwrap(self) +
300:                         uint256((int256(_strike) & BITMASK_INT24) << (64 + legIndex * 48 + 12))
301:                 );
302:         }

405:         unchecked {
406:             return self.isLong(0) + self.isLong(1) + self.isLong(2) + self.isLong(3);
407:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L296-L302) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L405-L407)


</details>


### [L&#x2011;27] Code does not follow the best practice of check-effects-interaction 
Code should follow the best-practice of [check-effects-interaction](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/), where state variables are updated before any external calls are made. Doing so prevents a large class of reentrancy bugs.


*There are 8 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit the function `safeTransferFrom()` is called before the following assignment
436:             s_poolAssets += uint128(assets);

//@audit the function `safeTransferFrom()` is called before the following assignment
496:             s_poolAssets += uint128(assets);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L436-L436) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L496-L496)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit the function `startPool()` is called before the following assignment
253:         s_getPanopticPool[v3Pool] = newPoolContract;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L253-L253) 


```solidity

File: ./contracts/PanopticPool.sol

//@audit the function `exercise()` is called before the following assignment
1650:             s_settledTokens[chunkKey] = s_settledTokens[chunkKey].add(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1650-L1650) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit the function `validate()` is called before the following assignment
644:             s_accountLiquidity[positionKey_to] = fromLiq;

//@audit the function `validate()` is called before the following assignment
645:             s_accountLiquidity[positionKey_from] = LeftRightUnsigned.wrap(0);

//@audit the function `validate()` is called before the following assignment
647:             s_accountFeesBase[positionKey_to] = fromBase;

//@audit the function `validate()` is called before the following assignment
648:             s_accountFeesBase[positionKey_from] = LeftRightSigned.wrap(0);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L644-L644) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L645-L645), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L647-L647), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L648-L648)


</details>


### [L&#x2011;28] prevent re-setting a state variable with the same value 
Not only is wasteful in terms of gas, but this is especially problematic when an event is emitted and the old and new values set are the same, as listeners might not expect this kind of scenario.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L81-L81) 


</details>


### [L&#x2011;29] Some tokens may not consider `type(uint256).max` as an infinite approval 
Some tokens such as [COMP](https://github.com/compound-finance/compound-protocol/blob/a3214f67b73310d547e00fc578e8355911c9d376/contracts/Governance/Comp.sol#L89-L91) downcast such approvals to `uint96` and use that as a raw value rather than interpreting it as an infinite approval. Eventually these approvals will reach zero, at which point the calling contract will no longer function properly.


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/InteractionHelper.sol

32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);

33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);

36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);

37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L32-L32) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L36-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L37-L37)


</details>


### [L&#x2011;30] Function can return unassigned variable 
Make sure that functions with a return value always return a valid and assigned value. Even if the default value is as expected, it should be assigned with the default value for code clarity and to reduce confusion.


*There are 6 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

695:         return poolUtilizations;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L695-L695) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

111:             return _decimals;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L111-L111) 


```solidity

File: ./contracts/libraries/Math.sol

480:                 return res;

543:                 return res;

620:                 return res;

697:                 return res;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L480-L480) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L543-L543), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L620-L620), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L697-L697)


</details>


### [L&#x2011;31] [Solidity]: Bug in Legacy Code Generation When Accessing the .selector Member on Expressions with Side Effects 
This version of solidity is vulnerable to a bug in the legacy code generation pipeline of the Solidity compiler that was found during investigation of a security report On June 26, 2023. For more details check the following [link](https://soliditylang.org/blog/2023/07/19/missing-side-effects-on-selector-access-bug/)


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


</details>


## Non-critical Issues

### [NC&#x2011;1] Assembly blocks should have extensive comments 
Assembly blocks are taking a lot more time to audit than normal Solidity code, and often have gotchas and side-effects that the Solidity versions of the same code do not. Consider adding more comments explaining what is being done in every step of the assembly code


*There are 31 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

739:         assembly ("memory-safe") {

353:             assembly ("memory-safe") {

379:             assembly ("memory-safe") {

383:             assembly ("memory-safe") {

393:             assembly ("memory-safe") {

398:             assembly ("memory-safe") {

404:             assembly ("memory-safe") {

467:             assembly ("memory-safe") {

493:             assembly ("memory-safe") {

497:             assembly ("memory-safe") {

503:             assembly ("memory-safe") {

530:             assembly ("memory-safe") {

556:             assembly ("memory-safe") {

560:             assembly ("memory-safe") {

566:             assembly ("memory-safe") {

607:             assembly ("memory-safe") {

633:             assembly ("memory-safe") {

637:             assembly ("memory-safe") {

643:             assembly ("memory-safe") {

684:             assembly ("memory-safe") {

710:             assembly ("memory-safe") {

714:             assembly ("memory-safe") {

720:             assembly ("memory-safe") {

362:                 assembly ("memory-safe") {

476:                 assembly ("memory-safe") {

539:                 assembly ("memory-safe") {

616:                 assembly ("memory-safe") {

693:                 assembly ("memory-safe") {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L739-L739) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L353-L353), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L379-L379), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L383-L383), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L393-L393), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L398-L398), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L404-L404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L467-L467), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L493-L493), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L497-L497), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L503-L503), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L530-L530), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L556-L556), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L560-L560), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L566-L566), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L607-L607), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L633-L633), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L637-L637), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L643-L643), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L684-L684), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L710-L710), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L714-L714), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L720-L720), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L362-L362), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L476-L476), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L539-L539), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L616-L616), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L693-L693)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

24:         assembly ("memory-safe") {

55:         assembly ("memory-safe") {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L24-L24) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L55-L55)


```solidity

File: ./contracts/multicall/Multicall.sol

25:                 assembly ("memory-safe") {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L25-L25) 


</details>


### [NC&#x2011;2] [NatSpec] Natspec `@author` is missing from `contract` 



*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

35: /// @notice 2) get any gain in capital that results from buying an option that becomes in-the-money.
36: contract CollateralTracker is ERC20Minimal, Multicall {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L35-L36) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L6-L6) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

30: /// @notice Track Tick Range Information. Lower and Upper ticks including the liquidity deployed within that range.
31: /// @notice This is used to track information about a leg in the Option Position identified by `TokenId.sol`.
32: /// @notice We pack this tick range info into a uint256.
33: //


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L30-L33) 


</details>


### [NC&#x2011;3] Use bit shifts in an imutable variable rather than long bit masks of a single bit, for readability 



*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Constants.sol

9:     uint256 internal constant FP96 = 0x1000000000000000000000000;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L9-L9) 


</details>


### [NC&#x2011;4] Variable names that consist of all capital letters should be reserved for `constant`/`immutable` variables 



*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

116:         address _WETH9,

117:         SemiFungiblePositionManager _SFPM,


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L116-L116) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L117-L117)


</details>


### [NC&#x2011;5] Constant redefined elsewhere 
Consider defining in only one contract so that values cannot become out of sync when only one location is updated. A [cheap way](https://medium.com/coinmonks/gas-cost-of-solidity-library-functions-dbe0cedd4678) to store constants in a single location is to create an `internal constant` in a `library`. If the variable is a local cache of another contract's value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don't get out of sync.


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

//@audit The same constant is already defined on file : ./contracts/PanopticFactory.sol
179:     SemiFungiblePositionManager internal immutable SFPM;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L179-L179) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit The same constant is already defined on file : ./contracts/libraries/Math.sol
23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) 


</details>


### [NC&#x2011;6] Constants in comparisons should appear on the left side 



*There are 170 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `0`
331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

//@audit `0`
350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

//@audit `0`
512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

//@audit `0`
575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

//@audit `0`
664:                 if (positionId.isLong(leg) == 0) continue;

//@audit `0`
708:                     (tokenType == 0 && currentValue1 < oracleValue1) ||

//@audit `1`
709:                     (tokenType == 1 && currentValue0 < oracleValue0)

//@audit `0`
776:         if (utilization < 0) {

//@audit `0`
976:         if (assets > 0) {

//@audit `0`
1010:             if (tokenToPay > 0) {

//@audit `0`
1018:             } else if (tokenToPay < 0) {

//@audit `0`
1067:             if (tokenToPay > 0) {

//@audit `0`
1075:             } else if (tokenToPay < 0) {

//@audit `0`
1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

//@audit `0`
1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

//@audit `0`
1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {

//@audit `0`
1107:             if (intrinsicValue != 0) {

//@audit `0`
1168:         if (positionBalanceArray.length > 0) {

//@audit `0`
1182:         if (premiumAllPositions > 0) {

//@audit `0`
1173:             if (premiumAllPositions < 0) {

//@audit `0`
1325:         uint128 amountMoved = tokenType == 0 ? amountsMoved.rightSlot() : amountsMoved.leftSlot();

//@audit `0`
1328:         int64 utilization = tokenType == 0

//@audit `0`
1339:             if (isLong == 0) {

//@audit `1`
1362:                     uint160 ratio = tokenType == 1 // tokenType

//@audit `1`
1346:                     ((atTick >= tickUpper) && (tokenType == 1)) || // strike OTM when price >= upperTick for tokenType=1

//@audit `0`
1347:                     ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0

//@audit `1`
1374:                         ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1

//@audit `0`
1375:                         ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0

//@audit `1`
1451:             if (isLong == 1) {

//@audit `0`
1479:         if (isLong == 0) {

//@audit `1`
1488:         } else if (isLong == 1) {

//@audit `1`
1559:                 if (tokenType == 1) {

//@audit `0`
1544:                 if (tokenType == 0) {

//@audit `0`
1582:                 tokenType == 0 ? movedRight : movedLeft,

//@audit `0`
1584:                 tokenType == 0

//@audit `0`
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +

//@audit `0`
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L331-L331) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L350-L350), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L575-L575), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L664-L664), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L708-L708), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L709-L709), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L776-L776), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L976-L976), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1010-L1010), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1018-L1018), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1067-L1067), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1075-L1075), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1060-L1060), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1060-L1060), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1060-L1060), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1107-L1107), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1168-L1168), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1182-L1182), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1173-L1173), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1325-L1325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1328-L1328), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1339-L1339), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1362-L1362), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1346-L1346), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1347-L1347), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1374-L1374), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1375-L1375), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1451-L1451), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1479-L1479), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1488-L1488), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1559-L1559), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1544-L1544), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1582-L1582), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1584-L1584), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1637-L1637), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1638-L1638)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit `0`
181:         if (amount0Owed > 0)

//@audit `0`
188:         if (amount1Owed > 0)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L181-L181) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L188-L188)


```solidity

File: ./contracts/PanopticPool.sol

//@audit `0`
460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {

//@audit `0`
533:         if (medianData != 0) s_miniMedian = medianData;

//@audit `0`
638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)

//@audit `0`
664:         if (medianData != 0) s_miniMedian = medianData;

//@audit `1`
768:             if (isLong == 1) {

//@audit `0`
865:             if (tokenId.isLong(leg) == 0) {

//@audit `MAX_SLOW_FAST_DELTA`
943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

//@audit `MAX_TWAP_DELTA_LIQUIDATION`
1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)

//@audit `1`
1188:         if (touchedId.length != 1) revert Errors.InputListFail();

//@audit `0`
1274:         if (positionIdListExercisor.length > 0)

//@audit `MAX_POSITIONS`
1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

//@audit `0`
1483:         if (netLiquidity == 0) return;

//@audit `1`
1520:             if ((isLong == 1) || computeAllPremia) {

//@audit `1`
1566:                     if (isLong == 1) {

//@audit `0`
1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

//@audit `3`
1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

//@audit `0`
1679:             if (tokenId.isLong(leg) == 0) {

//@audit `0`
1789:                                     (accumulated1 == 0 ? type(uint256).max : accumulated1),

//@audit `0`
1780:                                     (accumulated0 == 0 ? type(uint256).max : accumulated0),

//@audit `0`
1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {

//@audit `1`
1864:                 if (tokenId.isLong(leg) == 1) {

//@audit `0`
1928:                         s_grossPremiumLast[chunkKey] = totalLiquidity != 0


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L460-L460) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L533-L533), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L638-L638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L664-L664), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L768-L768), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L865-L865), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L943-L943), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1035-L1035), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1188-L1188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1274-L1274), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1415-L1415), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1483-L1483), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1520-L1520), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1566-L1566), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1596-L1596), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1596-L1596), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1679-L1679), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1789-L1789), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1780-L1780), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1862-L1862), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1864-L1864), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1928-L1928)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `0`
362:         if (s_AddrToPoolIdData[univ3pool] != 0) return;

//@audit `0`
412:         if (amount0Owed > 0)

//@audit `0`
419:         if (amount1Owed > 0)

//@audit `0`
446:         address token = amount0Delta > 0

//@audit `0`
453:         uint256 amountToPay = amount0Delta > 0 ? uint256(amount0Delta) : uint256(amount1Delta);

//@audit `0`
632:                 (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||

//@audit `0`
633:                 (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)

//@audit `0`
688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

//@audit `0`
717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {

//@audit `0`
833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

//@audit `0`
823:             } else if (itm0 != 0) {

//@audit `0`
787:             if ((itm0 != 0) && (itm1 != 0)) {

//@audit `0`
787:             if ((itm0 != 0) && (itm1 != 0)) {

//@audit `0`
819:                 zeroForOne = net0 < 0;

//@audit `0`
827:                 zeroForOne = itm1 > 0;

//@audit `0`
824:                 zeroForOne = itm0 < 0;

//@audit `0`
1085:         if (currentLiquidity.rightSlot() > 0) {

//@audit `0`
999:             if (isLong == 0) {

//@audit `1`
1073:             if (tokenType == 1) {

//@audit `0`
1078:             if (tokenType == 0) {

//@audit `0`
1066:             moved = isLong == 0

//@audit `1`
1275:         if (isLong == 1) {

//@audit `0`
1279:         if (LeftRightSigned.unwrap(amountToCollect) != 0) {

//@audit `0`
1296:                 collected0 = movedInLeg.rightSlot() < 0

//@audit `0`
1299:                 collected1 = movedInLeg.leftSlot() < 0

//@audit `0`
1469:             if (netLiquidity != 0) {

//@audit `1`
1518:             acctPremia = isLong == 1

//@audit `1`
1514:                 acctPremia = isLong == 1 ? premiumOwed : premiumGross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L362-L362) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L412-L412), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L419-L419), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L446-L446), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L453-L453), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L632-L632), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L633-L633), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L688-L688), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L717-L717), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L833-L833), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L823-L823), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L787-L787), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L787-L787), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L819-L819), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L827-L827), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L824-L824), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1085-L1085), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L999-L999), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1073-L1073), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1078-L1078), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1066-L1066), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1275-L1275), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1279-L1279), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1296-L1296), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1299-L1299), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1469-L1469), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1518-L1518), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1514-L1514)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit `0`
67:                 if (tokenId.isLong(leg) == 0) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L67-L67) 


```solidity

File: ./contracts/libraries/Math.sol

//@audit `0`
74:         return x > 0 ? x : -x;

//@audit `0`
83:             return x > 0 ? uint256(x) : uint256(-x);

//@audit `0x100000000000000000000000000000000`
93:             if (x >= 0x100000000000000000000000000000000) {

//@audit `0x10000000000000000`
97:             if (x >= 0x10000000000000000) {

//@audit `0x100000000`
101:             if (x >= 0x100000000) {

//@audit `0x10000`
105:             if (x >= 0x10000) {

//@audit `0x100`
109:             if (x >= 0x100) {

//@audit `0x10`
113:             if (x >= 0x10) {

//@audit `0`
137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;

//@audit `0`
139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;

//@audit `0`
141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;

//@audit `0`
143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;

//@audit `0`
145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;

//@audit `0`
147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;

//@audit `0`
149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;

//@audit `0`
151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;

//@audit `0`
153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;

//@audit `0`
155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;

//@audit `0`
157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;

//@audit `0`
159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;

//@audit `0`
161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;

//@audit `0`
163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;

//@audit `0`
165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;

//@audit `0`
167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;

//@audit `0`
169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;

//@audit `0`
171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;

//@audit `0`
173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;

//@audit `0`
176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;

//@audit `0`
130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));

//@audit `0`
133:             uint256 sqrtR = absTick & 0x1 != 0

//@audit `0`
179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));

//@audit `0`
312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

//@audit `0`
360:             if (prod1 == 0) {

//@audit `0`
361:                 require(denominator > 0);

//@audit `0`
447:             if (mulmod(a, b, denominator) > 0) {

//@audit `0`
474:             if (prod1 == 0) {

//@audit `0`
537:             if (prod1 == 0) {

//@audit `0`
587:             if (mulmod(a, b, 2 ** 96) > 0) {

//@audit `0`
614:             if (prod1 == 0) {

//@audit `0`
664:             if (mulmod(a, b, 2 ** 128) > 0) {

//@audit `0`
691:             if (prod1 == 0) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L74-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L83-L83), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L93-L93), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L97-L97), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L101-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L105-L105), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L109-L109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L113-L113), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L137-L137), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L139-L139), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L141-L141), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L143-L143), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L145-L145), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L147-L147), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L149-L149), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L151-L151), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L153-L153), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L155-L155), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L157-L157), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L159-L159), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L161-L161), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L163-L163), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L165-L165), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L167-L167), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L169-L169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L173-L173), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L176-L176), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L133-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L179-L179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L312-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L360-L360), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L361-L361), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L447-L447), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L474-L474), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L537-L537), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L587-L587), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L614-L614), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L664-L664), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L691-L691)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit `8`
207:                 for (uint8 i; i < 8; ++i) {

//@audit `7`
211:                     if (rank == 7) {

//@audit `20`
248:             for (uint256 i = 0; i < 20; ++i) {

//@audit `19`
256:             for (uint256 i = 0; i < 19; ++i) {

//@audit `0`
325:         if (tokenId.asset(legIndex) == 0) {

//@audit `0`
357:                 tickLower % tickSpacing != 0 ||

//@audit `0`
358:                 tickUpper % tickSpacing != 0 ||

//@audit `0`
425:         if (tokenType == 0) {

//@audit `0`
475:             uint256 notional = asset == 0

//@audit `0`
479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

//@audit `0`
537:                 return amount < 0 ? -absResult : absResult;

//@audit `0`
532:                 return amount < 0 ? -absResult : absResult;

//@audit `0`
564:                 return amount < 0 ? -absResult : absResult;

//@audit `0`
555:                 return amount < 0 ? -absResult : absResult;

//@audit `0`
584:         if (tokenId.asset(legIndex) == 0) {

//@audit `0`
615:         bool isShort = tokenId.isLong(legIndex) == 0;

//@audit `0`
618:         if (tokenId.tokenType(legIndex) == 0) {

//@audit `0`
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));

//@audit `0`
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));

//@audit `1`
785:                     if (tokenId.isLong(leg) == 1) {

//@audit `1`
864:                     if (tokenId.isLong(leg) == 1) {

//@audit `0`
931:             if (balanceShortage > 0) {

//@audit `0`
949:             if (balanceShortage > 0) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L207-L207) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L211-L211), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L248-L248), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L256-L256), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L325-L325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L357-L357), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L358-L358), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L425-L425), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L475-L475), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L479-L479), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L537-L537), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L532-L532), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L564-L564), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L555-L555), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L584-L584), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L615-L615), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L618-L618), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L856-L856), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L857-L857), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L785-L785), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L864-L864), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L931-L931), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L949-L949)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit `0`
112:         if (to.code.length != 0) {

//@audit `0`
163:         if (to.code.length != 0) {

//@audit `0x01ffc9a7`
202:             interfaceId == 0x01ffc9a7 || // ERC165 Interface ID for ERC165

//@audit `0xd9b67a26`
203:             interfaceId == 0xd9b67a26; // ERC165 Interface ID for ERC1155

//@audit `0`
222:         if (to.code.length != 0) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L112-L112) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L163-L163), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L202-L202), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L203-L203), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L222-L222)


```solidity

File: ./contracts/types/TokenId.sol

//@audit `0`
465:         if (i == 0)

//@audit `1`
471:         if (i == 1)

//@audit `2`
477:         if (i == 2)

//@audit `3`
483:         if (i == 3)

//@audit `0`
501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);

//@audit `4`
507:             for (uint256 i = 0; i < 4; ++i) {

//@audit `0`
508:                 if (self.optionRatio(i) == 0) {

//@audit `0`
528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

//@audit `0`
512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)

//@audit `1`
566:                     if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))

//@audit `1`
592:                     if (self.isLong(i) == 1) return; // validated


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L465-L465) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L471-L471), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L483-L483), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L501-L501), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L508-L508), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L528-L528), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L566-L566), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L592-L592)


</details>


### [NC&#x2011;7] [NatSpec] Natspec description is missing from `contract` 
It is recommended that Solidity contracts are fully annotated using NatSpec for all public interfaces (everything in the ABI). It is clearly stated in the Solidity official documentation. In complex projects such as Defi, the interpretation of all functions and their arguments and returns is important for code readability and auditability.[source](https://docs.soliditylang.org/en/v0.8.15/natspec-format.html)


*There are 11 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

178:     constructor(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L178) 


```solidity

File: ./contracts/PanopticPool.sol

120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

136:     uint256 internal constant MEDIAN_PERIOD = 60;

156:     int256 internal constant MAX_TWAP_DELTA_LIQUIDATION = 513;

171:     uint256 internal constant BP_DECREASE_BUFFER = 13_333;

174:     uint256 internal constant NO_BUFFER = 10_000;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L120-L120) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L133-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L136-L136), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L156-L156), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L174-L174)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

126:     bool internal constant BURN = true;

133:     uint128 private constant VEGOID = 2;

289:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumGross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L126-L126) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L133-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L289-L289)


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L6-L6) 


</details>


### [NC&#x2011;8] Custom error has no error details 
Consider adding parameters to the error to indicate which user or values caused the failure


*There are 34 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Errors.sol

10:     error CastingError();

13:     error CollateralTokenAlreadyInitialized();

16:     error DepositTooLarge();

20:     error EffectiveLiquidityAboveThreshold();

23:     error ExceedsMaximumRedemption();

26:     error ExerciseeNotSolvent();

29:     error InputListFail();

32:     error InvalidSalt();

35:     error InvalidTick();

38:     error InvalidNotionalValue();

45:     error InvalidUniswapCallback();

48:     error LeftRightInputError();

51:     error NoLegsExercisable();

54:     error NotEnoughCollateral();

57:     error PositionTooLarge();

60:     error NotALongLeg();

63:     error NotEnoughLiquidity();

66:     error NotMarginCalled();

70:     error NotOwner();

73:     error NotPanopticPool();

76:     error OptionsBalanceZero();

79:     error PoolAlreadyInitialized();

82:     error PositionAlreadyMinted();

85:     error PositionCountNotZero();

88:     error PriceBoundFail();

91:     error ReentrantCall();

95:     error StaleTWAP();

98:     error TooManyPositionsOpen();

101:     error TransferFailed();

105:     error TicksNotInitializable();

108:     error UnderOverFlow();

111:     error UniswapPoolNotInitialized();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L10-L10) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L13-L13), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L16-L16), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L20-L20), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L23-L23), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L26-L26), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L29-L29), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L32-L32), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L35-L35), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L38-L38), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L45-L45), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L48-L48), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L51-L51), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L54-L54), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L57-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L60-L60), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L63-L63), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L66-L66), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L70-L70), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L73-L73), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L76-L76), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L79-L79), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L82-L82), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L85-L85), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L88-L88), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L91-L91), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L95-L95), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L98-L98), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L101-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L105-L105), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L111-L111)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

55:     error NotAuthorized();

58:     error UnsafeRecipient();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L55-L55) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L58-L58)


</details>


### [NC&#x2011;9] Default address(0) can be returned 
Allowing a function in Solidity to return the default address (address(0)) can be problematic as it can represent uninitialized or invalid addresses. If such an address is utilized in transfer operations or other sensitive actions, it could lead to loss of funds or unpredicted behavior. It's prudent to include checks in your functions to prevent the return of the zero address, enhancing contract security.


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

362:         return s_underlyingToken;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L362-L362) 


```solidity

File: ./contracts/PanopticFactory.sol

160:         return s_owner;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L160-L160) 


</details>


### [NC&#x2011;10] Consider using `delete` rather than assigning `zero` to clear values 
The `delete` keyword more closely matches the semantics of what is being done, and draws more attention to the changing of state, which may lead to a more thorough audit of its associated logic


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/PanopticMath.sol

850:                 collateralDelta0 = 0;

851:                 collateralDelta1 = 0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L850-L850) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L851-L851)


```solidity

File: ./contracts/types/TokenId.sol

377:                 optionRatios = 0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L377-L377) 


</details>


### [NC&#x2011;11] Dependence on external protocols 
External protocols should be monitored as such dependencies may introduce vulnerabilities if a vulnerability is found /introduced in the external protocol


*There are 8 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

9: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";

10: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L9-L9) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L10-L10)


```solidity

File: ./contracts/PanopticPool.sol

7: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L7-L7) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";

6: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L5-L5) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L6-L6)


```solidity

File: ./contracts/libraries/CallbackLib.sol

5: import {IUniswapV3Factory} from "univ3-core/interfaces/IUniswapV3Factory.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L5-L5) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

5: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L5-L5) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

6: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L6-L6) 


</details>


### [NC&#x2011;12] `else`-block not required 
One level of nesting can be removed by not having an `else` block when the `if`-block returns:


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/PanopticMath.sol

325:         if (tokenId.asset(legIndex) == 0) {

425:         if (tokenType == 0) {

494:             if (sqrtPriceX96 < type(uint128).max) {

511:             if (sqrtPriceX96 < type(uint128).max) {

528:             if (sqrtPriceX96 < type(uint128).max) {

551:             if (sqrtPriceX96 < type(uint128).max) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L325-L325) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L425-L425), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L494-L494), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L511-L511), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L528-L528), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L551-L551)


```solidity

File: ./contracts/types/TokenId.sol

439:         if (optionRatios < 2 ** 64) {

441:         } else if (optionRatios < 2 ** 112) {

443:         } else if (optionRatios < 2 ** 160) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L439-L439) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L441-L441), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L443-L443)


</details>


### [NC&#x2011;13] Empty bytes check is missing 
When developing smart contracts in Solidity, it's crucial to validate the inputs of your functions. This includes ensuring that the bytes parameters are not empty, especially when they represent crucial data such as addresses, identifiers, or raw data that the contract needs to process.
Missing empty bytes checks can lead to unexpected behaviour in your contract.For instance, certain operations might fail, produce incorrect results, or consume unnecessary gas when performed with empty bytes.Moreover, missing input validation can potentially expose your contract to malicious activity, including exploitation of unhandled edge cases.
To mitigate these issues, always validate that bytes parameters are not empty when the logic of your contract requires it.


*There are 8 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

//@audit  ,data are not checked
172:     function uniswapV3MintCallback(
173:         uint256 amount0Owed,
174:         uint256 amount1Owed,
175:         bytes calldata data
176:     ) external {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L172-L176) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit  ,data are not checked
402:     function uniswapV3MintCallback(
403:         uint256 amount0Owed,
404:         uint256 amount1Owed,
405:         bytes calldata data
406:     ) external {

//@audit  ,data are not checked
435:     function uniswapV3SwapCallback(
436:         int256 amount0Delta,
437:         int256 amount1Delta,
438:         bytes calldata data
439:     ) external {

//@audit  ,data are not checked
540:     function safeTransferFrom(
541:         address from,
542:         address to,
543:         uint256 id,
544:         uint256 amount,
545:         bytes calldata data
546:     ) public override {

//@audit  ,data are not checked
566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data
572:     ) public override {

//@audit  ,positionKey are not checked
1110:     function _updateStoredPremia(
1111:         bytes32 positionKey,
1112:         LeftRightUnsigned currentLiquidity,
1113:         LeftRightUnsigned collectedAmounts
1114:     ) private {

//@audit  ,positionKey are not checked
1255:     function _collectAndWritePositionData(
1256:         LiquidityChunk liquidityChunk,
1257:         IUniswapV3Pool univ3pool,
1258:         LeftRightUnsigned currentLiquidity,
1259:         bytes32 positionKey,
1260:         LeftRightSigned movedInLeg,
1261:         uint256 isLong
1262:     ) internal returns (LeftRightUnsigned collectedChunk) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L402-L406) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L435-L439), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L540-L546), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L572), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1110-L1114), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1255-L1262)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit  ,settledTokens are not checked
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L777) 


</details>


### [NC&#x2011;14] Events are missing sender information 
When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the `msg.sender` the events of these types of action will make events much more useful to end users, especially when `msg.sender` is not `tx.origin`.


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

154:         emit OwnershipTransferred(currentOwner, newOwner);

268:         emit PoolDeployed(
269:             newPoolContract,
270:             v3Pool,
271:             collateralTracker0,
272:             collateralTracker1,
273:             amount0,
274:             amount1
275:         );


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L154-L154) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L268-L275)


```solidity

File: ./contracts/PanopticPool.sol

853:         emit OptionBurnt(owner, positionSize, tokenId, premiaOwed);

1654:             emit PremiumSettled(owner, tokenId, realizedPremia);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L853-L853) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1654-L1654)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

390:         emit PoolInitialized(univ3pool, poolId);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L390-L390) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

94:         emit Transfer(from, to, amount);

112:         emit Transfer(from, to, amount);

130:         emit Transfer(address(0), to, amount);

145:         emit Transfer(from, address(0), amount);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L94-L94) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L112-L112), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L145-L145)


</details>


### [NC&#x2011;15] Events may be emitted out of order due to reentrancy 
Ensure that events follow the best practice of check-effects-interaction, and are emitted before external calls


*There are 11 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

439:         emit Deposit(msg.sender, receiver, assets, shares);

499:         emit Deposit(msg.sender, receiver, assets, shares);

563:         emit Withdraw(msg.sender, receiver, owner, assets, shares);

623:         emit Withdraw(msg.sender, receiver, owner, assets, shares);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L439-L439) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L499-L499), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L563-L563), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L623-L623)


```solidity

File: ./contracts/PanopticFactory.sol

268:         emit PoolDeployed(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L268-L268) 


```solidity

File: ./contracts/PanopticPool.sol

666:         emit OptionMinted(msg.sender, positionSize, tokenId, poolUtilizations);

1170:         emit AccountLiquidated(msg.sender, liquidatee, bonusAmounts);

1277:         emit ForcedExercised(msg.sender, account, touchedId[0], exerciseFees);

1654:             emit PremiumSettled(owner, tokenId, realizedPremia);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L666-L666) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1170-L1170), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1277-L1277), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1654-L1654)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

485:         emit TokenizedPositionBurnt(msg.sender, tokenId, positionSize);

517:         emit TokenizedPositionMinted(msg.sender, tokenId, positionSize);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L485-L485) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L517-L517)


</details>


### [NC&#x2011;16] Explicitly define visibility of state variables to prevent misconceptions on what can access the variable 
Such state variables should be marked as private as this is the default visibility


*There are 12 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

131:     uint256 immutable TICK_DEVIATION;

136:     uint256 immutable COMMISSION_FEE;

141:     uint256 immutable SELLER_COLLATERAL_RATIO;

145:     uint256 immutable BUYER_COLLATERAL_RATIO;

149:     int256 immutable FORCE_EXERCISE_COST;

154:     uint256 immutable TARGET_POOL_UTIL;

158:     uint256 immutable SATURATED_POOL_UTIL;

162:     uint256 immutable ITM_SPREAD_MULTIPLIER;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L131-L131) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L136-L136), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L141-L141), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L145-L145), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L149-L149), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L154-L154), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L158-L158), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L162-L162)


```solidity

File: ./contracts/PanopticPool.sol

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))

258:     mapping(address account => mapping(TokenId tokenId => LeftRightUnsigned balanceAndUtilizations))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L238-L238) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L258-L258)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

177:     mapping(bytes32 positionKey => LeftRightUnsigned removedAndNetLiquidity)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L177-L177) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

71:     mapping(address owner => mapping(address operator => bool approvedForAll))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L71-L71) 


</details>


### [NC&#x2011;17] Defining All External/Public Functions in Contract Interfaces 
It is preferable to have all the external and public function in an interface to make using them easier by developers. This helps ensure the whole API is extracted in a interface.


*There are 62 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

221:     function startToken(
222:         bool underlyingIsToken0,
223:         address token0,
224:         address token1,
225:         uint24 fee,
226:         PanopticPool panopticPool
227:     ) external {

277:     function getPoolData()
278:         external
279:         view
280:         returns (uint256 poolAssets, uint256 insideAMM, int256 currentPoolUtilization)
281:     {

361:     function asset() external view returns (address assetTokenAddress) {
362:         return s_underlyingToken;

370:     function totalAssets() public view returns (uint256 totalManagedAssets) {
371:         unchecked {

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {
380:         return Math.mulDiv(assets, totalSupply, totalAssets());

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {
387:         return Math.mulDiv(shares, totalAssets(), totalSupply);

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {
393:         return type(uint104).max;

399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {
400:         // compute the MEV tax, which is equal to a single payment of the commissionRate on the FINAL (post mev-tax) assets paid

417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {
418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

444:     function maxMint(address) external view returns (uint256 maxShares) {
445:         unchecked {

453:     function previewMint(uint256 shares) public view returns (uint256 assets) {
454:         // round up depositing assets to avoid protocol loss

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {
508:         // We can only use the standard 4626 withdraw function if the user has no open positions

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {
519:         uint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.

531:     function withdraw(
532:         uint256 assets,
533:         address receiver,
534:         address owner
535:     ) external returns (uint256 shares) {

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {
573:         uint256 available = convertToShares(s_poolAssets);

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {
582:         return convertToAssets(shares);

591:     function redeem(
592:         uint256 shares,
593:         address receiver,
594:         address owner
595:     ) external returns (uint256 assets) {

650:     function exerciseCost(
651:         int24 currentTick,
652:         int24 oracleTick,
653:         TokenId positionId,
654:         uint128 positionBalance,
655:         LeftRightSigned longAmounts
656:     ) external view returns (LeftRightSigned exerciseFees) {

864:     function delegate(
865:         address delegator,
866:         address delegatee,
867:         uint256 assets
868:     ) external onlyPanopticPool {

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {
895:         balanceOf[delegatee] += convertToShares(assets);

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {
904:         balanceOf[delegatee] -= convertToShares(assets);

911:     function revoke(
912:         address delegator,
913:         address delegatee,
914:         uint256 assets
915:     ) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {
976:         if (assets > 0) {

0995:     function takeCommissionAddData(
0996:         address optionOwner,
0997:         int128 longAmount,
0998:         int128 shortAmount,
0999:         int128 swappedAmount
1000:     ) external onlyPanopticPool returns (int256 utilization) {

1043:     function exercise(
1044:         address optionOwner,
1045:         int128 longAmount,
1046:         int128 shortAmount,
1047:         int128 swappedAmount,
1048:         int128 realizedPremium
1049:     ) external onlyPanopticPool returns (int128) {

1141:     function getAccountMarginDetails(
1142:         address user,
1143:         int24 currentTick,
1144:         uint256[2][] memory positionBalanceArray,
1145:         int128 premiumAllPositions
1146:     ) public view returns (LeftRightUnsigned tokenData) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L221-L227) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L277-L281), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L361-L362), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L370-L371), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L379-L380), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L386-L387), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L393), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L399-L400), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L417-L418), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L445), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L453-L454), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L507-L508), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L518-L519), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L531-L535), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L572-L573), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L581-L582), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L591-L595), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L650-L656), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L864-L868), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L895), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L903-L904), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L911-L915), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L975-L976), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L995-L1000), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1049), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1141-L1146)


```solidity

File: ./contracts/PanopticFactory.sol

147:     function transferOwnership(address newOwner) external {
148:         address currentOwner = s_owner;

172:     function uniswapV3MintCallback(
173:         uint256 amount0Owed,
174:         uint256 amount1Owed,
175:         bytes calldata data
176:     ) external {

210:     function deployNewPool(
211:         address token0,
212:         address token1,
213:         uint24 fee,
214:         bytes32 salt
215:     ) external returns (PanopticPool newPoolContract) {

290:     function minePoolAddress(
291:         bytes32 salt,
292:         uint256 loops,
293:         uint256 minTargetRarity
294:     ) external view returns (bytes32 bestSalt, uint256 highestRarity) {

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {
421:         return s_getPanopticPool[univ3pool];


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L147-L148) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L172-L176), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L210-L215), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L290-L294), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L420-L421)


```solidity

File: ./contracts/PanopticPool.sol

291:     function startPool(
292:         IUniswapV3Pool _univ3pool,
293:         address token0,
294:         address token1,
295:         CollateralTracker collateralTracker0,
296:         CollateralTracker collateralTracker1
297:     ) external {

338:     function assertPriceWithinBounds(uint160 sqrtLowerBound, uint160 sqrtUpperBound) external view {
339:         (uint160 currentSqrtPriceX96, , , , , , ) = s_univ3pool.slot0();

352:     function optionPositionBalance(
353:         address user,
354:         TokenId tokenId
355:     ) external view returns (uint128 balance, uint64 poolUtilization0, uint64 poolUtilization1) {

381:     function calculateAccumulatedFeesBatch(
382:         address user,
383:         bool includePendingPremium,
384:         TokenId[] calldata positionIdList
385:     ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

410:     function calculatePortfolioValue(
411:         address user,
412:         int24 atTick,
413:         TokenId[] calldata positionIdList
414:     ) external view returns (int256 value0, int256 value1) {

522:     function pokeMedian() external {
523:         (, , uint16 observationIndex, uint16 observationCardinality, , , ) = s_univ3pool.slot0();

547:     function mintOptions(
548:         TokenId[] calldata positionIdList,
549:         uint128 positionSize,
550:         uint64 effectiveLiquidityLimitX32,
551:         int24 tickLimitLow,
552:         int24 tickLimitHigh
553:     ) external {

569:     function burnOptions(
570:         TokenId tokenId,
571:         TokenId[] calldata newPositionIdList,
572:         int24 tickLimitLow,
573:         int24 tickLimitHigh
574:     ) external {

586:     function burnOptions(
587:         TokenId[] calldata positionIdList,
588:         TokenId[] calldata newPositionIdList,
589:         int24 tickLimitLow,
590:         int24 tickLimitHigh
591:     ) external {

1017:     function liquidate(
1018:         TokenId[] calldata positionIdListLiquidator,
1019:         address liquidatee,
1020:         LeftRightUnsigned delegations,
1021:         TokenId[] calldata positionIdList
1022:     ) external {

1179:     function forceExercise(
1180:         address account,
1181:         TokenId[] calldata touchedId,
1182:         TokenId[] calldata positionIdListExercisee,
1183:         TokenId[] calldata positionIdListExercisor
1184:     ) external {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {
1426:         return s_univ3pool;

1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {
1432:         return s_collateralToken0;

1437:     function collateralToken1() external view returns (CollateralTracker) {
1438:         return s_collateralToken1;

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {
1445:         _numberOfPositions = (s_positionsHash[user] >> 248);

1587:     function settleLongPremium(
1588:         TokenId[] calldata positionIdList,
1589:         address owner,
1590:         uint256 legIndex
1591:     ) external {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L291-L297) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L338-L339), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L352-L355), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L381-L385), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L410-L414), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L522-L523), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L547-L553), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L569-L574), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L586-L591), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1017-L1022), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1179-L1184), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1425-L1426), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1431-L1432), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1437-L1438), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1444-L1445), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1587-L1591)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {
351:         // compute the address of the Uniswap v3 pool for the given token0, token1, and fee tier

402:     function uniswapV3MintCallback(
403:         uint256 amount0Owed,
404:         uint256 amount1Owed,
405:         bytes calldata data
406:     ) external {

435:     function uniswapV3SwapCallback(
436:         int256 amount0Delta,
437:         int256 amount1Delta,
438:         bytes calldata data
439:     ) external {

471:     function burnTokenizedPosition(
472:         TokenId tokenId,
473:         uint128 positionSize,
474:         int24 slippageTickLimitLow,
475:         int24 slippageTickLimitHigh
476:     )
477:         external
478:         ReentrancyLock(tokenId.poolId())
479:         returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
480:     {

504:     function mintTokenizedPosition(
505:         TokenId tokenId,
506:         uint128 positionSize,
507:         int24 slippageTickLimitLow,
508:         int24 slippageTickLimitHigh
509:     )
510:         external
511:         ReentrancyLock(tokenId.poolId())
512:         returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped)
513:     {

1421:     function getAccountLiquidity(
1422:         address univ3pool,
1423:         address owner,
1424:         uint256 tokenType,
1425:         int24 tickLower,
1426:         int24 tickUpper
1427:     ) external view returns (LeftRightUnsigned accountLiquidities) {

1449:     function getAccountPremium(
1450:         address univ3pool,
1451:         address owner,
1452:         uint256 tokenType,
1453:         int24 tickLower,
1454:         int24 tickUpper,
1455:         int24 atTick,
1456:         uint256 isLong
1457:     ) external view returns (uint128, uint128) {

1535:     function getAccountFeesBase(
1536:         address univ3pool,
1537:         address owner,
1538:         uint256 tokenType,
1539:         int24 tickLower,
1540:         int24 tickUpper
1541:     ) external view returns (int128 feesBase0, int128 feesBase1) {

1555:     function getUniswapV3PoolFromId(
1556:         uint64 poolId
1557:     ) external view returns (IUniswapV3Pool UniswapV3Pool) {

1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {
1567:         poolId = uint64(s_AddrToPoolIdData[univ3pool]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L350-L351) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L402-L406), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L435-L439), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L471-L480), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L504-L513), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1421-L1427), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1449-L1457), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1535-L1541), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1555-L1557), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1566-L1567)


```solidity

File: ./contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {
13:         results = new bytes[](data.length);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L12-L13) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {
82:         isApprovedForAll[msg.sender][operator] = approved;

094:     function safeTransferFrom(
095:         address from,
096:         address to,
097:         uint256 id,
098:         uint256 amount,
099:         bytes calldata data
100:     ) public virtual {

130:     function safeBatchTransferFrom(
131:         address from,
132:         address to,
133:         uint256[] calldata ids,
134:         uint256[] calldata amounts,
135:         bytes calldata data
136:     ) public virtual {

178:     function balanceOfBatch(
179:         address[] calldata owners,
180:         uint256[] calldata ids
181:     ) public view returns (uint256[] memory balances) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L81-L82) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L94-L100), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L136), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L181)


</details>


### [NC&#x2011;18] Fixed Compiler Version Required for Non-Library/Interface Files 



*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `CollateralTracker` 
2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

//@audit `PanopticFactory` 
2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

//@audit `PanopticPool` 
2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `SemiFungiblePositionManager` 
2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

//@audit `Multicall` 
2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit `ERC1155` 
2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

//@audit `ERC20Minimal` 
2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


</details>


### [NC&#x2011;19] Floating pragma should be avoided 
If you leave a floating pragma in your code (pragma solidity 0.4>=0.6. 0. ), you won't know which version was deployed to compile your code, leading to unexpected behavior


*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


</details>


### [NC&#x2011;20] Function definition do not follow Solidity style guide 
See [this](https://docs.soliditylang.org/en/v0.8.19/style-guide.html#function-declaration) link for an explanation of the correct ordering


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit the function visibility is misplaced
399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {

//@audit the function visibility is misplaced
453:     function previewMint(uint256 shares) public view returns (uint256 assets) {

//@audit the function visibility is misplaced
518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

//@audit the function visibility is misplaced
581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L399-L399) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L453-L453), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L518-L518), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L581-L581)


</details>


### [NC&#x2011;21] Duplicated `require()` checks should be refactored to a modifier or function 
The compiler will inline the function, which will avoid `JUMP` instructions usually associated with functions


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

448:                 require(result < type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L448-L448) 


</details>


### [NC&#x2011;22] Some if-statement can be converted to a ternary 
Improving code readability and compactness is an integral part of optimal programming practices. The use of ternary operators in place of if-else conditions is one such measure. Ternary operators allow us to write conditional statements in a more concise manner, thereby enhancing readability and simplicity. They follow the syntax `condition ? exprIfTrue : exprIfFalse`, which interprets as "if the condition is true, evaluate to `exprIfTrue`, else evaluate to `exprIfFalse`". By adopting this approach, we make our code more streamlined and intuitive, which could potentially aid in better understanding and maintenance of the codebase.


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1544:                 if (tokenType == 0) {
1545:                     spreadRequirement = movedRight < movedPartnerRight
1546:                         ? movedPartnerRight - movedRight
1547:                         : movedRight - movedPartnerRight;
1548:                 } else {
1549:                     spreadRequirement = movedLeft < movedPartnerLeft
1550:                         ? movedPartnerLeft - movedLeft
1551:                         : movedLeft - movedPartnerLeft;
1552:                 }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1544-L1552) 


```solidity

File: ./contracts/PanopticPool.sol

914:         if (SLOW_ORACLE_UNISWAP_MODE) {
915:             slowOracleTick = PanopticMath.computeMedianObservedPrice(
916:                 _univ3pool,
917:                 observationIndex,
918:                 observationCardinality,
919:                 SLOW_ORACLE_CARDINALITY,
920:                 SLOW_ORACLE_PERIOD
921:             );
922:         } else {
923:             (slowOracleTick, medianData) = PanopticMath.computeInternalMedian(
924:                 observationIndex,
925:                 observationCardinality,
926:                 MEDIAN_PERIOD,
927:                 s_miniMedian,
928:                 _univ3pool
929:             );
930:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L914-L930) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

325:         if (tokenId.asset(legIndex) == 0) {
326:             return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);
327:         } else {
328:             return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);
329:         }

425:         if (tokenType == 0) {
426:             return (
427:                 tokenData0.rightSlot() + convert1to0(tokenData1.rightSlot(), sqrtPriceX96),
428:                 tokenData0.leftSlot() + convert1to0(tokenData1.leftSlot(), sqrtPriceX96)
429:             );
430:         } else {
431:             return (
432:                 tokenData1.rightSlot() + convert0to1(tokenData0.rightSlot(), sqrtPriceX96),
433:                 tokenData1.leftSlot() + convert0to1(tokenData0.leftSlot(), sqrtPriceX96)
434:             );
435:         }

494:             if (sqrtPriceX96 < type(uint128).max) {
495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);
496:             } else {
497:                 return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
498:             }

511:             if (sqrtPriceX96 < type(uint128).max) {
512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);
513:             } else {
514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));
515:             }

627:             if (isShort) {
628:                 // if option is short, increment shorts by notional
629:                 shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
630:             } else {
631:                 // if option is long, increment longs by notional
632:                 longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));
633:             }

619:             if (isShort) {
620:                 // if option is short, increment shorts by contracts
621:                 shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
622:             } else {
623:                 // is option is long, increment longs by contracts
624:                 longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));
625:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L325-L329) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L425-L435), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L494-L498), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L511-L515), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L627-L633), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L619-L625)


```solidity

File: ./contracts/types/TokenId.sol

382:             } else if (optionRatios < 2 ** 208) {
383:                 optionRatios = 3;
384:             } else {
385:                 optionRatios = 4;
386:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L382-L386) 


</details>


### [NC&#x2011;23] Imports could be organized more systematically 
The contract used interfaces should be imported first, followed by all other files. The examples below do not follow this layout.


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

8: import {IDonorNFT} from "@contracts/tokens/interfaces/IDonorNFT.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L8-L8) 


```solidity

File: ./contracts/PanopticPool.sol

7: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L7-L7) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

6: import {IERC20Metadata} from "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L6-L6) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

6: import {IUniswapV3Pool} from "univ3-core/interfaces/IUniswapV3Pool.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L6-L6) 


</details>


### [NC&#x2011;24] Inconsistent spacing in comments 
Some lines use `// x` and some use `//x`. The instances below point out the usages that don't follow the majority, within each file


*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1118:             //compute total commission amount = commission rate + spread fee


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1118-L1118) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

610:             //construct the positionKey for the from and to addresses

643:             //update+store liquidity and fee values between accounts

821:                 //compute the swap amount, set as positive (exact input)

988:         LeftRightUnsigned currentLiquidity = s_accountLiquidity[positionKey]; //cache


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L610-L610) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L643-L643), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L821-L821), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L988-L988)


</details>


### [NC&#x2011;25] Inconsistent usage of `require`/`error` 
Some parts of the codebase use `require` statements, while others use custom `error`s. Consider refactoring the code to use the same approach: the following findings represent the minority of `require` vs `error`, and they show the first occurance in each file, for brevity.


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

370:             require(denominator > prod1);

484:             require(2 ** 64 > prod1);

547:             require(2 ** 96 > prod1);

624:             require(2 ** 128 > prod1);

701:             require(2 ** 192 > prod1);

361:                 require(denominator > 0);

448:                 require(result < type(uint256).max);

588:                 require(result < type(uint256).max);

665:                 require(result < type(uint256).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L370-L370) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L484-L484), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L624-L624), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L701-L701), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L361-L361), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L448-L448), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L588-L588), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L665-L665)


</details>


### [NC&#x2011;26] Incorrect NatSpec Syntax 
In Solidity, just like in most other programming languages, regular comments serve to make code more understandable for developers. These are usually denoted by `//` for single line comments, or `/* ... */` for multi-line comments, and are ignored by the compiler.
On the other hand, NatSpec comments in Solidity, denoted by `///` for single - line comments, or`/** ... */` for multi - line comments, serve a different purpose.Besides aiding developer comprehension, they also form a part of the contract's interface, as they can be parsed and used by tools such as automated documentation generators or IDEs to provide users with details about the contract's functions, parameters and behavior.NatSpec comments can also be retrieved via JSON interfaces, and as such, they're included in the contract's ABI.
Thus, using`///` and `/** ... */` appropriately ensures not only proper documentation for developers, but also helps create a richer and more informative interface for users and external tools interacting with your contract.


*There are 6 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/SemiFungiblePositionManager.sol

358:         // @dev pools can be initialized from a Panoptic pool or by calling initializeAMMPool directly, reverting

360:         // @dev some pools may not be deployable if the poolId has a collision (since we take only 8 bytes)

603:             // @dev see `contracts/types/LiquidityChunk.sol`

836:             // @dev note this triggers our swap callback function

903:                 // @dev see `contracts/types/LiquidityChunk.sol`


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L358-L358) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L360-L360), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L603-L603), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L836-L836), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L903-L903)


```solidity

File: ./contracts/libraries/PanopticMath.sol

98:         // @dev 0 ^ x = x


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L98-L98) 


</details>


### [NC&#x2011;27] `internal` functions not called by the contract should be removed 
If the functions are required by an interface, the contract should inherit from that interface and use the `override` keyword


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L25-L25) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

468:     function convertNotional(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L468-L468) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

52:     function safeTransfer(address token, address to, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L52-L52) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

89:     function addLiquidity(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L89-L89) 


```solidity

File: ./contracts/types/TokenId.sol

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

336:     function addLeg(

404:     function countLongs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L183-L183) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L336-L336), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L404-L404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L464-L464)


</details>


### [NC&#x2011;28] Large numeric literals should use underscores for readability 



*There are 12 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);

202:                 2230 +

207:                     (6510 * ratioTick ** 3) /

205:                     (7812 * ratioTick ** 2) /

203:                     (12500 * ratioTick) /


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L200-L200) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L202), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L207-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L205-L205), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L203-L203)


```solidity

File: ./contracts/PanopticPool.sol

160:     int256 internal constant MAX_SLOW_FAST_DELTA = 1800;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L160-L160) 


```solidity

File: ./contracts/libraries/Constants.sol

15:     int24 internal constant MAX_V3POOL_TICK = 887272;

18:     uint160 internal constant MIN_V3POOL_SQRT_RATIO = 4295128739;

22:         1461446703485210103287273052203988822378723970342;

12:     int24 internal constant MIN_V3POOL_TICK = -887272;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L15-L15) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L18-L18), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L22-L22), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L12-L12)


```solidity

File: ./contracts/types/TokenId.sol

171:             return int24(int256((TokenId.unwrap(self) >> (64 + legIndex * 48 + 36)) % 4096));

320:                         (uint256(uint24(_width) % 4096) << (64 + legIndex * 48 + 36))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L171-L171) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L320-L320)


</details>


### [NC&#x2011;29] Consider using later versions of solidity for more cappabilities 
Consider using solidity 0.8.18 or later to benefit from multiple things including the named mappings [named mappings](https://ethereum.stackexchange.com/a/145555) to make it easier to understand the purpose of each mapping


*There are 15 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L2-L2) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L2-L2) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L2-L2) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L2-L2) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L2-L2) 


```solidity

File: ./contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L2-L2) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L2-L2) 


```solidity

File: ./contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L2-L2) 


</details>


### [NC&#x2011;30] Functions which are either private or internal should have a preceding _ in their name 
Add a preceding underscore to the function name, take care to refactor where there functions are called 


*There are 104 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

1450:     function getUniV3TWAP() internal view returns (int24 twapTick) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1450-L1450) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

320:     function beginReentrancyLock(uint64 poolId) internal {

330:     function endReentrancyLock(uint64 poolId) internal {

593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

756:     function swapInAMM(
757:         IUniswapV3Pool univ3pool,
758:         LeftRightSigned itmAmounts
759:     ) internal returns (LeftRightSigned totalSwapped) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L320-L320) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L330-L330), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L593-L593), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L756-L759)


```solidity

File: ./contracts/libraries/CallbackLib.sol

30:     function validateCallback(
31:         address sender,
32:         IUniswapV3Factory factory,
33:         PoolFeatures memory features
34:     ) internal view {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L30-L34) 


```solidity

File: ./contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

221:     function getAmountsForLiquidity(
222:         int24 currentTick,
223:         LiquidityChunk liquidityChunk
224:     ) internal pure returns (uint256 amount0, uint256 amount1) {

241:     function getLiquidityForAmount0(
242:         int24 tickLower,
243:         int24 tickUpper,
244:         uint256 amount0
245:     ) internal pure returns (LiquidityChunk) {

271:     function getLiquidityForAmount1(
272:         int24 tickLower,
273:         int24 tickUpper,
274:         uint256 amount1
275:     ) internal pure returns (LiquidityChunk) {

296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {

318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

340:     function mulDiv(
341:         uint256 a,
342:         uint256 b,
343:         uint256 denominator
344:     ) internal pure returns (uint256 result) {

440:     function mulDivRoundingUp(
441:         uint256 a,
442:         uint256 b,
443:         uint256 denominator
444:     ) internal pure returns (uint256 result) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L25-L25) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L41-L41), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L49-L49), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L57-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L65-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L73-L73), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L81-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L91-L91), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L191-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L207-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L221-L224), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L241-L245), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L271-L275), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L296-L296), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L302-L302), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L311-L311), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L318-L318), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L325-L325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L340-L344), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L440-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L458-L458), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L584-L584), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L598-L598), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L661-L661), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L675-L675), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L738-L738), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L753-L753), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L776-L776)


```solidity

File: ./contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

92:     function updatePositionsHash(
93:         uint256 existingHash,
94:         TokenId tokenId,
95:         bool addFlag
96:     ) internal pure returns (uint256) {

289:     function getLiquidityChunk(
290:         TokenId tokenId,
291:         uint256 legIndex,
292:         uint128 positionSize
293:     ) internal pure returns (LiquidityChunk) {

338:     function getTicks(
339:         int24 strike,
340:         int24 width,
341:         int24 tickSpacing
342:     ) internal pure returns (int24 tickLower, int24 tickUpper) {

371:     function getRangesFromStrike(
372:         int24 width,
373:         int24 tickSpacing
374:     ) internal pure returns (int24, int24) {

390:     function computeExercisedAmounts(
391:         TokenId tokenId,
392:         uint128 positionSize
393:     ) internal pure returns (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) {

419:     function convertCollateralData(
420:         LeftRightUnsigned tokenData0,
421:         LeftRightUnsigned tokenData1,
422:         uint256 tokenType,
423:         uint160 sqrtPriceX96
424:     ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
446:         LeftRightUnsigned tokenData0,
447:         LeftRightUnsigned tokenData1,
448:         uint256 tokenType,
449:         int24 tick
450:     ) internal pure returns (uint256, uint256) {

468:     function convertNotional(
469:         uint128 contractSize,
470:         int24 tickLower,
471:         int24 tickUpper,
472:         uint256 asset
473:     ) internal pure returns (uint128) {

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

574:     function getAmountsMoved(
575:         TokenId tokenId,
576:         uint128 positionSize,
577:         uint256 legIndex
578:     ) internal pure returns (LeftRightUnsigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L47-L47) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L59-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L92-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L289-L293), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L338-L342), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L371-L374), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L390-L393), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L419-L424), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L445-L450), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L468-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L490-L490), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L524-L524), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L574-L578)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

52:     function safeTransfer(address token, address to, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L21-L21) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L52-L52)


```solidity

File: ./contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

59:     function toRightSlot(
60:         LeftRightUnsigned self,
61:         uint128 right
62:     ) internal pure returns (LeftRightUnsigned) {

78:     function toRightSlot(
79:         LeftRightSigned self,
80:         int128 right
81:     ) internal pure returns (LeftRightSigned) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

121:     function toLeftSlot(
122:         LeftRightUnsigned self,
123:         uint128 left
124:     ) internal pure returns (LeftRightUnsigned) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

148:     function add(
149:         LeftRightUnsigned x,
150:         LeftRightUnsigned y
151:     ) internal pure returns (LeftRightUnsigned z) {

171:     function sub(
172:         LeftRightUnsigned x,
173:         LeftRightUnsigned y
174:     ) internal pure returns (LeftRightUnsigned z) {

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

251:     function subRect(
252:         LeftRightSigned x,
253:         LeftRightSigned y
254:     ) internal pure returns (LeftRightSigned z) {

279:     function addCapped(
280:         LeftRightUnsigned x,
281:         LeftRightUnsigned dx,
282:         LeftRightUnsigned y,
283:         LeftRightUnsigned dy
284:     ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L39-L39) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L46-L46), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L59-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L78-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L101-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L121-L124), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L134-L134), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L148-L151), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L171-L174), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L194-L194), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L214-L214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L232-L232), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L251-L254), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L279-L284)


```solidity

File: ./contracts/types/LiquidityChunk.sol

70:     function createChunk(
71:         int24 _tickLower,
72:         int24 _tickUpper,
73:         uint128 amount
74:     ) internal pure returns (LiquidityChunk) {

89:     function addLiquidity(
90:         LiquidityChunk self,
91:         uint128 amount
92:     ) internal pure returns (LiquidityChunk) {

102:     function addTickLower(
103:         LiquidityChunk self,
104:         int24 _tickLower
105:     ) internal pure returns (LiquidityChunk) {

118:     function addTickUpper(
119:         LiquidityChunk self,
120:         int24 _tickUpper
121:     ) internal pure returns (LiquidityChunk) {

135:     function updateTickLower(
136:         LiquidityChunk self,
137:         int24 _tickLower
138:     ) internal pure returns (LiquidityChunk) {

151:     function updateTickUpper(
152:         LiquidityChunk self,
153:         int24 _tickUpper
154:     ) internal pure returns (LiquidityChunk) {

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L70-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L89-L92), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L102-L105), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L118-L121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L135-L138), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L151-L154), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L180-L180), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L189-L189)


```solidity

File: ./contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

205:     function addAsset(
206:         TokenId self,
207:         uint256 _asset,
208:         uint256 legIndex
209:     ) internal pure returns (TokenId) {

221:     function addOptionRatio(
222:         TokenId self,
223:         uint256 _optionRatio,
224:         uint256 legIndex
225:     ) internal pure returns (TokenId) {

240:     function addIsLong(
241:         TokenId self,
242:         uint256 _isLong,
243:         uint256 legIndex
244:     ) internal pure returns (TokenId) {

255:     function addTokenType(
256:         TokenId self,
257:         uint256 _tokenType,
258:         uint256 legIndex
259:     ) internal pure returns (TokenId) {

273:     function addRiskPartner(
274:         TokenId self,
275:         uint256 _riskPartner,
276:         uint256 legIndex
277:     ) internal pure returns (TokenId) {

291:     function addStrike(
292:         TokenId self,
293:         int24 _strike,
294:         uint256 legIndex
295:     ) internal pure returns (TokenId) {

310:     function addWidth(
311:         TokenId self,
312:         int24 _width,
313:         uint256 legIndex
314:     ) internal pure returns (TokenId) {

336:     function addLeg(
337:         TokenId self,
338:         uint256 legIndex,
339:         uint256 _optionRatio,
340:         uint256 _asset,
341:         uint256 _isLong,
342:         uint256 _tokenType,
343:         uint256 _riskPartner,
344:         int24 _strike,
345:         int24 _width
346:     ) internal pure returns (TokenId tokenId) {

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

416:     function asTicks(
417:         TokenId self,
418:         uint256 legIndex
419:     ) internal pure returns (int24 legLowerTick, int24 legUpperTick) {

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

500:     function validate(TokenId self) internal pure {

578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L87-L87) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L96-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L118-L118), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L138-L138), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L148-L148), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L158-L158), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L169-L169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L183-L183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L205-L209), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L221-L225), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L240-L244), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L255-L259), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L273-L277), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L291-L295), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L310-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L336-L346), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L366-L366), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L404-L404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L416-L419), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L432-L432), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L464-L464), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L500-L500), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L578-L578)


</details>


### [NC&#x2011;31] `public` functions not called by the contract should be declared `external` instead 
Contracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public`.


*There are 13 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1141:     function getAccountMarginDetails(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1141-L1141) 


```solidity

File: ./contracts/PanopticFactory.sol

134:     function initialize(address _owner) public {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L134-L134) 


```solidity

File: ./contracts/PanopticPool.sol

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1444-L1444) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

97:     function calculateAMMSwapFees(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L97-L97) 


```solidity

File: ./contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L12-L12) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

94:     function safeTransferFrom(

130:     function safeBatchTransferFrom(

178:     function balanceOfBatch(

200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L81-L81) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L94-L94), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L178), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L200-L200)


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L49-L49) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L61-L61), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L81-L81)


</details>


### [NC&#x2011;32] Polymorphic functions make security audits more time-consuming and error-prone 
The instances below point to one of two functions with the same name. Consider naming each function differently, in order to make code navigation and analysis easier.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L894) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L975-L975)


```solidity

File: ./contracts/PanopticPool.sol

586:     function burnOptions(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L586-L586) 


</details>


### [NC&#x2011;33] State variables should have `Natspec` comments 
Consider adding some `Natspec` comments on critical state variables to explain what they are supposed to do: this will help for future code reviews.


*There are 9 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

//@audit DONOT_COMMIT_LONG_SETTLED need comments
120:     bool internal constant DONOT_COMMIT_LONG_SETTLED = false;

//@audit SLOW_ORACLE_UNISWAP_MODE need comments
133:     bool internal constant SLOW_ORACLE_UNISWAP_MODE = false;

//@audit MEDIAN_PERIOD need comments
136:     uint256 internal constant MEDIAN_PERIOD = 60;

//@audit MAX_TWAP_DELTA_LIQUIDATION need comments
156:     int256 internal constant MAX_TWAP_DELTA_LIQUIDATION = 513;

//@audit BP_DECREASE_BUFFER need comments
171:     uint256 internal constant BP_DECREASE_BUFFER = 13_333;

//@audit NO_BUFFER need comments
174:     uint256 internal constant NO_BUFFER = 10_000;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L120-L120) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L133-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L136-L136), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L156-L156), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L174-L174)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit BURN need comments
126:     bool internal constant BURN = true;

//@audit VEGOID need comments
133:     uint128 private constant VEGOID = 2;

//@audit s_accountPremiumGross need comments
289:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumGross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L126-L126) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L133-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L289-L289)


</details>


### [NC&#x2011;34] Contracts should have full test coverage 
While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

@audit Multiple files
1: 


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1-L1) 


</details>


### [NC&#x2011;35] [NatSpec] Natspec `@title` is missing from `contract` 



*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

35: /// @notice 2) get any gain in capital that results from buying an option that becomes in-the-money.
36: contract CollateralTracker is ERC20Minimal, Multicall {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L35-L36) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

16: /// @author Axicon Labs Limited
17: library InteractionHelper {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L16-L17) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

07: /// @notice Safe ERC20 transfer library that gracefully handles missing return values.
08: /// @author Axicon Labs Limited
09: /// @author Modified from Solmate (https://github.com/Rari-Capital/solmate/blob/main/src/utils/SafeTransferLib.sol)
10: /// @dev Caution! This library won't check that a token has code, responsibility is delegated to the caller.
11: library SafeTransferLib {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L7-L11) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L6-L6) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

30: /// @notice Track Tick Range Information. Lower and Upper ticks including the liquidity deployed within that range.
31: /// @notice This is used to track information about a leg in the Option Position identified by `TokenId.sol`.
32: /// @notice We pack this tick range info into a uint256.
33: //


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L30-L33) 


</details>


### [NC&#x2011;36] Open TODOs 
TODOs may signal that a feature is missing or not ready for audit, consider resolving the issue and removing the TODO comment


*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

294:     /// @param toDowncast The uint256 to be downcasted

296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

303:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L294-L294) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L296-L296), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L297-L297), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L302-L302), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L303-L303)


</details>


### [NC&#x2011;37] Top level pragma declarations should be separated by two blank lines 



*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;
3: 
4: import {PanopticPool} from "@contracts/PanopticPool.sol";

4: import {PanopticPool} from "@contracts/PanopticPool.sol";
5: 
6: interface IDonorNFT {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L4) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L4-L6)


</details>


### [NC&#x2011;38] Critical functions should be a two step procedure 
Critical functions in Solidity contracts should follow a two-step procedure to enhance security, minimize human error, and ensure proper access control. By dividing sensitive operations into distinct phases, such as initiation and confirmation, developers can introduce a safeguard against unintended actions or unauthorized access.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

995:     function takeCommissionAddData(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L995-L995) 


</details>


### [NC&#x2011;39] Typos 
Modifiers in Solidity can improve code readability and modularity by encapsulating repetitive checks, such as address validity checks, into a reusable construct. For example, an `onlyOwner` modifier can be used to replace repetitive `require(msg.sender == owner)` checks across several functions, reducing code redundancy and enhancing maintainability. To implement, define a modifier with the check, then apply the modifier to relevant functions.


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `initalized` is misspelled
91:     /// @notice Boolean which tracks whether this CollateralTracker has been initialized.
92:     /// @dev As each instance is deployed via proxy clone, initial parameters must only be initalized once via startToken().


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L91-L92) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `ower` is misspelled
180:     /**
181:         Any liquidity that has been deposited in the AMM using the SFPM will collect fees over 
182:         time, we call this the gross premia. If that liquidity has been removed, we also need to
183:         keep track of the amount of fees that *would have been collected*, we call this the owed
184:         premia. The gross and owed premia are tracked per unit of liquidity by the 
185:         s_accountPremiumGross and s_accountPremiumOwed accumulators.
186:         
187:         Here is how we can use the accumulators to compute the Gross, Net, and Owed fees collected
188:         by any position.
189: 
190:         Let`s say Charlie the smart contract deposited T into the AMM and later removed R from that
191:         same tick using a tokenId with a isLong=1 parameter. Because the netLiquidity is only (T-R),
192:         the AMM will collect fees equal to:
193: 
194:               net_feesCollectedX128 = feeGrowthX128 * (T - R)
195:                                     = feeGrowthX128 * N                                     
196:         
197:         where N = netLiquidity = T-R. Had that liquidity never been removed, we want the gross
198:         premia to be given by:
199: 
200:               gross_feesCollectedX128 = feeGrowthX128 * T
201: 
202:         So we must keep track of fees for the removed liquidity R so that the long premia exactly
203:         compensates for the fees that would have been collected from the initial liquidity.
204: 
205:         In addition to tracking, we also want to track those fees plus a small spread. Specifically,
206:         we want:
207: 
208:               gross_feesCollectedX128 = net_feesCollectedX128 + owed_feesCollectedX128
209: 
210:        where 
211: 
212:               owed_feesCollectedX128 = feeGrowthX128 * R * (1 + spread)                      (Eqn 1)
213: 
214:         A very opinionated definition for the spread is: 
215:               
216:               spread = N=*(liquidity removed from that strike)/(netLiquidity remaining at that strike)
217:                      = N=*R/N
218: 
219:         For an arbitrary parameter 0 <= N= <= 1 (N= = 1/2^VEGOID). This way, the gross_feesCollectedX128 will be given by: 
220: 
221:               gross_feesCollectedX128 = feeGrowthX128 * N + feeGrowthX128*R*(1 + N=*R/N) 
222:                                       = feeGrowthX128 * T + feesGrowthX128*N=*R^2/N         
223:                                       = feeGrowthX128 * T * (1 + N=*R^2/(N*T))                (Eqn 2)
224:         
225:         The s_accountPremiumOwed accumulator tracks the feeGrowthX128 * R * (1 + spread) term
226:         per unit of removed liquidity R every time the position touched:
227: 
228:               s_accountPremiumOwed += feeGrowthX128 * R * (1 + N=*R/N) / R
229:                                    += feeGrowthX128 * (T - R + N=*R)/N
230:                                    += feeGrowthX128 * T/N * (1 - R/T + N=*R/T)
231:          
232:         Note that the value of feeGrowthX128 can be extracted from the amount of fees collected by
233:         the smart contract since the amount of feesCollected is related to feeGrowthX128 according
234:         to:
235: 
236:              feesCollected = feesGrowthX128 * (T-R)
237: 
238:         So that we get:
239:              
240:              feesGrowthX128 = feesCollected/N
241: 
242:         And the accumulator is computed from the amount of collected fees according to:
243:              
244:              s_accountPremiumOwed += feesCollected * T/N^2 * (1 - R/T + N=*R/T)          (Eqn 3)     
245: 
246:         So, the amount of owed premia for a position of size r minted at time t1 and burnt at 
247:         time t2 is:
248: 
249:              owedPremia(t1, t2) = (s_accountPremiumOwed_t2-s_accountPremiumOwed_t1) * r
250:                                 = bfeesGrowthX128 * r * T/N * (1 - R/T + N=*R/T)
251:                                 = bfeesGrowthX128 * r * (T - R + N=*R)/N
252:                                 = bfeesGrowthX128 * r * (N + N=*R)/N
253:                                 = bfeesGrowthX128 * r * (1 + N=*R/N)             (same as Eqn 1)
254: 
255:         This way, the amount of premia owed for a position will match Eqn 1 exactly.
256: 
257:         Similarly, the amount of gross fees for the total liquidity is tracked in a similar manner
258:         by the s_accountPremiumGross accumulator. 
259: 
260:         However, since we require that Eqn 2 holds up-- ie. the gross fees collected should be equal
261:         to the net fees collected plus the ower fees plus the small spread, the expression for the
262:         s_accountPremiumGross accumulator has to be given by (you`ll see why in a minute): 
263: 
264:             s_accountPremiumGross += feesCollected * T/N^2 * (1 - R/T + N=*R^2/T^2)       (Eqn 4) 
265: 
266:         This expression can be used to calculate the fees collected by a position of size t between times
267:         t1 and t2 according to:
268:              
269:             grossPremia(t1, t2) = b(s_accountPremiumGross) * t
270:                                 = bfeeGrowthX128 * t * T/N * (1 - R/T + N=*R^2/T^2) 
271:                                 = bfeeGrowthX128 * t * (T - R + N=*R^2/T) / N 
272:                                 = bfeeGrowthX128 * t * (N + N=*R^2/T) / N
273:                                 = bfeeGrowthX128 * t * (1  + N=*R^2/(N*T))   (same as Eqn 2)
274:             
275:         where the last expression matches Eqn 2 exactly.
276: 
277:         In summary, the s_accountPremium accumulators allow smart contracts that need to handle 
278:         long+short liquidity to guarantee that liquidity deposited always receives the correct
279:         premia, whether that liquidity has been removed from the AMM or not.
280: 
281:         Note that the expression for the spread is extremely opinionated, and may not fit the
282:         specific risk management profile of every smart contract. And simply setting the N= parameter
283:         to zero would get rid of the "spread logic".
284:     */


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L180-L284) 


</details>


### [NC&#x2011;40] `2**<n> - 1` should be re-written as `type(uint<n>).max` 
Earlier versions of solidity can use `uint<n>(-1)` instead. Expressions not including the `- 1` can often be re-written to accomodate the change (e.g. by using a `>` rather than a `>=`, which will also save some gas)


*There are 50 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

1769:                 totalLiquidity) / 2 ** 64;

1771:                 totalLiquidity) / 2 ** 64;

1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L165-L165) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1348-L1348), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1353-L1353), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1487-L1487), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1552-L1552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1561-L1561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1769-L1769), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1771-L1771), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1942-L1942), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1959-L1959)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

1352:                     totalLiquidity * 2 ** 64,

1357:                     totalLiquidity * 2 ** 64,

1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L388-L388) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1352-L1352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1357-L1357), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1367-L1367), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1391-L1391)


```solidity

File: ./contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

418:             inv *= 2 - denominator * inv; // inverse mod 2**8

419:             inv *= 2 - denominator * inv; // inverse mod 2**16

420:             inv *= 2 - denominator * inv; // inverse mod 2**32

421:             inv *= 2 - denominator * inv; // inverse mod 2**64

422:             inv *= 2 - denominator * inv; // inverse mod 2**128

423:             inv *= 2 - denominator * inv; // inverse mod 2**256

484:             require(2 ** 64 > prod1);

511:             prod0 |= prod1 * 2 ** 192;

547:             require(2 ** 96 > prod1);

574:             prod0 |= prod1 * 2 ** 160;

587:             if (mulmod(a, b, 2 ** 96) > 0) {

624:             require(2 ** 128 > prod1);

651:             prod0 |= prod1 * 2 ** 128;

664:             if (mulmod(a, b, 2 ** 128) > 0) {

701:             require(2 ** 192 > prod1);

728:             prod0 |= prod1 * 2 ** 64;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L15-L15) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L418-L418), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L419-L419), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L420-L420), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L421-L421), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L422-L422), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L423-L423), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L484-L484), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L511-L511), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L574-L574), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L587-L587), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L624-L624), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L651-L651), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L664-L664), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L701-L701), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L728-L728)


```solidity

File: ./contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

560:                         2 ** 128,

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L514-L514), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L553-L553), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L560-L560), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L685-L685)


```solidity

File: ./contracts/types/TokenId.sol

98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

172:         } // "% 4096" = take last (2 ** 12 = 4096) 12 bits

376:             if (optionRatios < 2 ** 64) {

378:             } else if (optionRatios < 2 ** 112) {

380:             } else if (optionRatios < 2 ** 160) {

382:             } else if (optionRatios < 2 ** 208) {

439:         if (optionRatios < 2 ** 64) {

441:         } else if (optionRatios < 2 ** 112) {

443:         } else if (optionRatios < 2 ** 160) {

445:         } else if (optionRatios < 2 ** 208) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L98-L98) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L172-L172), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L376-L376), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L378-L378), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L380-L380), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L382-L382), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L439-L439), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L441-L441), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L443-L443), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L445-L445)


</details>


### [NC&#x2011;41] Uncommented fields in a struct 
Consider adding comments for all the fields in a struct to improve the readability of the codebase.


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/CallbackLib.sol

//@audit Add explanational comments to the following items `token0`, `token1`, 
14:     struct PoolFeatures {
15:         address token0;
16:         address token1;
17:         uint24 fee;
18:     }

//@audit Add explanational comments to the following items `poolFeatures`, `payer`, 
21:     struct CallbackData {
22:         PoolFeatures poolFeatures;
23:         address payer;
24:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L14-L18) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L21-L24)


</details>


### [NC&#x2011;42] Unused Import 
Some files/Items are imported but never used


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/types/LiquidityChunk.sol

//@audit `TokenId` is not used
5: import {TokenId} from "@types/TokenId.sol";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L5-L5) 


</details>


### [NC&#x2011;43] Unused `internal`/`private` contract variable 
If these serve no purpose, they should be safely removed


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

//@audit the variable `MAX_UINT256` is declared but never used
15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L15-L15) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit the variable `MAX_UINT256` is declared but never used
23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) 


</details>


### [NC&#x2011;44] Missing upgradability functionality 
At the begining of a project, there is always the need to modify of add something to the source code especialy if any vulnerability is discovered. Therefore, having such system is crusial at least at the first stages of the project


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

36: contract CollateralTracker is ERC20Minimal, Multicall {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L36-L36) 


</details>


### [NC&#x2011;45] Use `@inheritdoc` rather than using a non-standard annotation 



*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

319:     /// @dev See {IERC20-transfer}.

336:     /// @dev See {IERC20-transferFrom}.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L319-L319) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L336-L336)


</details>


### [NC&#x2011;46] Use the latest solidity (prior to 0.8.20 if on L2s) for deployment 
```
When deploying contracts, you should use the latest released version of Solidity.Apart from exceptional cases, only the latest version receives security fixes.
```
https://docs.soliditylang.org/en/v0.8.20/


*There are 20 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L2-L2) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L2-L2) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L2-L2) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L2-L2) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L2-L2) 


```solidity

File: ./contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L2-L2) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L2-L2) 


```solidity

File: ./contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L2-L2) 


</details>


### [NC&#x2011;47] Use a single file for system wide constants 
Consider grouping all the system constants under a single file. This finding shows only the first constant for each file.


*There are 10 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

70:     string internal constant TICKER_PREFIX = "po";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L70-L70) 


```solidity

File: ./contracts/PanopticFactory.sol

82:     uint256 internal constant FULL_RANGE_LIQUIDITY_AMOUNT_WETH = 0.1 ether;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L82-L82) 


```solidity

File: ./contracts/PanopticPool.sol

103:     int24 internal constant MIN_SWAP_TICK = Constants.MIN_V3POOL_TICK + 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L103-L103) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

125:     bool internal constant MINT = false;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L125-L125) 


```solidity

File: ./contracts/libraries/Constants.sol

9:     uint256 internal constant FP96 = 0x1000000000000000000000000;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L9-L9) 


```solidity

File: ./contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L15-L15) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) 


```solidity

File: ./contracts/types/LeftRight.sol

22:     uint256 internal constant LEFT_HALF_BIT_MASK =


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L22-L22) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

54:     uint256 internal constant CLEAR_TL_MASK =


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L54-L54) 


```solidity

File: ./contracts/types/TokenId.sol

62:     uint256 internal constant LONG_MASK =


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L62-L62) 


</details>


### [NC&#x2011;48] Consider using SMTChecker 
The SMTChecker is a valuable tool for Solidity developers as it helps detect potential vulnerabilities and logical errors in the contract's code. By utilizing Satisfiability Modulo Theories (SMT) solvers, it can reason about the potential states a contract can be in, and therefore, identify conditions that could lead to undesirable behavior. This automatic formal verification can catch issues that might otherwise be missed in manual code reviews or standard testing, enhancing the overall contract's security and reliability.


*There are 20 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L2-L2) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L2-L2) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L2-L2) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L2-L2) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L2-L2) 


```solidity

File: ./contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L2-L2) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L2-L2) 


```solidity

File: ./contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L2-L2) 


</details>


### [NC&#x2011;49] Variable name must be in mixedCase 
Avoid using underscore for variable Names or parameters


*There are 48 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

// @audit s_underlyingToken
89:     address internal s_underlyingToken;

// @audit s_initialized
93:     bool internal s_initialized;

// @audit s_univ3token0
96:     address internal s_univ3token0;

// @audit s_univ3token1
99:     address internal s_univ3token1;

// @audit s_underlyingIsToken0
102:     bool internal s_underlyingIsToken0;

// @audit s_panopticPool
109:     PanopticPool internal s_panopticPool;

// @audit s_poolAssets
112:     uint128 internal s_poolAssets;

// @audit s_inAMM
115:     uint128 internal s_inAMM;

// @audit s_ITMSpreadFee
121:     uint128 internal s_ITMSpreadFee;

// @audit s_poolFee
124:     uint24 internal s_poolFee;

// @audit min_sell_ratio
773:         uint256 min_sell_ratio = SELLER_COLLATERAL_RATIO;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L89-L89) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L93-L93), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L96-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L99-L99), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L102-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L109-L109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L112-L112), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L115-L115), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L121-L121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L124-L124), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L773-L773)


```solidity

File: ./contracts/PanopticFactory.sol

// @audit s_owner
96:     address internal s_owner;

// @audit s_initialized
99:     bool internal s_initialized;

// @audit s_getPanopticPool
102:     mapping(IUniswapV3Pool univ3pool => PanopticPool panopticPool) internal s_getPanopticPool;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L96-L96) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L99-L99), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L102-L102)


```solidity

File: ./contracts/PanopticPool.sol

// @audit s_univ3pool
186:     IUniswapV3Pool internal s_univ3pool;

// @audit s_miniMedian
225:     uint256 internal s_miniMedian;

// @audit s_collateralToken0
231:     CollateralTracker internal s_collateralToken0;

// @audit s_collateralToken1
233:     CollateralTracker internal s_collateralToken1;

// @audit s_options
238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))

// @audit s_grossPremiumLast
245:     mapping(bytes32 chunkKey => LeftRightUnsigned lastGrossPremium) internal s_grossPremiumLast;

// @audit s_settledTokens
251:     mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) internal s_settledTokens;

// @audit s_positionBalance
258:     mapping(address account => mapping(TokenId tokenId => LeftRightUnsigned balanceAndUtilizations))

// @audit s_positionsHash
272:     mapping(address account => uint256 positionsHash) internal s_positionsHash;

// @audit c_user
439:         address c_user = user;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L186-L186) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L225-L225), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L231-L231), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L233-L233), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L238-L238), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L245-L245), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L251-L251), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L258-L258), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L272-L272), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L439-L439)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

// @audit s_AddrToPoolIdData
145:     mapping(address univ3pool => uint256 poolIdData) internal s_AddrToPoolIdData;

// @audit s_poolContext
150:     mapping(uint64 poolId => PoolAddressAndLock contextData) internal s_poolContext;

// @audit s_accountLiquidity
177:     mapping(bytes32 positionKey => LeftRightUnsigned removedAndNetLiquidity)

// @audit s_accountPremiumOwed
287:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumOwed;

// @audit s_accountPremiumGross
289:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumGross;

// @audit s_accountFeesBase
295:     mapping(bytes32 positionKey => LeftRightSigned baseFees0And1) internal s_accountFeesBase;

// @audit premium0X64_base
1342:             uint256 premium0X64_base;

// @audit premium1X64_base
1343:             uint256 premium1X64_base;

// @audit positionKey_from
611:             bytes32 positionKey_from = keccak256(

// @audit positionKey_to
620:             bytes32 positionKey_to = keccak256(

// @audit premium0X64_owed
1363:                 uint128 premium0X64_owed;

// @audit premium1X64_owed
1364:                 uint128 premium1X64_owed;

// @audit premium0X64_gross
1384:                 uint128 premium0X64_gross;

// @audit premium1X64_gross
1385:                 uint128 premium1X64_gross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L145-L145) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L150-L150), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L177-L177), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L287-L287), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L289-L289), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L295-L295), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1342-L1342), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1343-L1343), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L611-L611), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L620-L620), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1363-L1363), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1364-L1364), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1384-L1384), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1385-L1385)


```solidity

File: ./contracts/libraries/PanopticMath.sol

// @audit timestamp_old
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(

// @audit tickCumulative_old
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(

// @audit timestamp_last
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool

// @audit tickCumulative_last
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L186-L186) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L186-L186), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L192-L192), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L192-L192)


```solidity

File: ./contracts/types/LeftRight.sol

// @audit z_xR
285:         uint128 z_xR = (uint256(x.rightSlot()) + dx.rightSlot()).toUint128Capped();

// @audit z_xL
286:         uint128 z_xL = (uint256(x.leftSlot()) + dx.leftSlot()).toUint128Capped();

// @audit z_yR
287:         uint128 z_yR = (uint256(y.rightSlot()) + dy.rightSlot()).toUint128Capped();

// @audit z_yL
288:         uint128 z_yL = (uint256(y.leftSlot()) + dy.leftSlot()).toUint128Capped();

// @audit r_Enabled
290:         bool r_Enabled = !(z_xR == type(uint128).max || z_yR == type(uint128).max);

// @audit l_Enabled
291:         bool l_Enabled = !(z_xL == type(uint128).max || z_yL == type(uint128).max);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L285-L285) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L286-L286), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L287-L287), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L288-L288), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L290-L290), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L291-L291)


</details>


### [NC&#x2011;50] Whitespace in Expressions 
See the [Whitespace in Expressions](https://docs.soliditylang.org/en/latest/style-guide.html#whitespace-in-expressions) section of the Solidity Style Guide


*There are 105 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit remove the whiteSpace before the ')' char
1208:         for (uint256 i = 0; i < totalIterations; ) {
1209:             // read the ith tokenId from the account


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1208-L1209) 


```solidity

File: ./contracts/PanopticFactory.sol

//@audit remove the whiteSpace before the ')' char
303:         for (; uint256(salt) < maxSalt; ) {
304:             uint256 rarity = PanopticMath.numberOfLeadingHexZeros(

//@audit remove the whiteSpace before the ')' char
341:         (uint160 currentSqrtPriceX96, , , , , , ) = v3Pool.slot0();
342: 

//@audit remove the whiteSpace before the ',' char
341:         (uint160 currentSqrtPriceX96, , , , , , ) = v3Pool.slot0();
342: 


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L303-L304) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L341-L342), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L341-L342)


```solidity

File: ./contracts/PanopticPool.sol

//@audit remove the whiteSpace before the ')' char
304:         (, int24 currentTick, , , , , ) = IUniswapV3Pool(_univ3pool).slot0();
305: 

//@audit remove the whiteSpace before the ',' char
304:         (, int24 currentTick, , , , , ) = IUniswapV3Pool(_univ3pool).slot0();
305: 

//@audit remove the whiteSpace before the ')' char
339:         (uint160 currentSqrtPriceX96, , , , , , ) = s_univ3pool.slot0();
340: 

//@audit remove the whiteSpace before the ',' char
339:         (uint160 currentSqrtPriceX96, , , , , , ) = s_univ3pool.slot0();
340: 

//@audit remove the whiteSpace before the ')' char
387:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
388: 

//@audit remove the whiteSpace before the ',' char
387:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
388: 

//@audit remove the whiteSpace before the ')' char
441:         for (uint256 k = 0; k < pLength; ) {
442:             TokenId tokenId = positionIdList[k];

//@audit remove the whiteSpace before the ')' char
459:             for (uint256 leg = 0; leg < numLegs; ) {
460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {

//@audit remove the whiteSpace before the ')' char
523:         (, , uint16 observationIndex, uint16 observationCardinality, , , ) = s_univ3pool.slot0();
524: 

//@audit remove the whiteSpace before the ',' char
523:         (, , uint16 observationIndex, uint16 observationCardinality, , , ) = s_univ3pool.slot0();
524: 

//@audit remove the whiteSpace before the ')' char
745:         for (uint256 leg = 0; leg < numLegs; ) {
746:             // Extract base fee (AMM swap/trading fees) for the position and add it to s_options

//@audit remove the whiteSpace before the ')' char
802:         for (uint256 i = 0; i < positionIdList.length; ) {
803:             LeftRightSigned paidAmounts;

//@audit remove the whiteSpace before the ')' char
864:         for (uint256 leg = 0; leg < numLegs; ) {
865:             if (tokenId.isLong(leg) == 0) {

//@audit remove the whiteSpace before the ')' char
1032:             (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1033: 

//@audit remove the whiteSpace before the ',' char
1032:             (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1033: 

//@audit remove the whiteSpace before the ')' char
1094:             (, finalTick, , , , , ) = s_univ3pool.slot0();
1095: 

//@audit remove the whiteSpace before the ',' char
1094:             (, finalTick, , , , , ) = s_univ3pool.slot0();
1095: 

//@audit remove the whiteSpace before the ')' char
1202:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1203: 

//@audit remove the whiteSpace before the ',' char
1202:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1203: 

//@audit remove the whiteSpace before the ')' char
1206:             (LeftRightSigned positionPremia, ) = _calculateAccumulatedPremia(
1207:                 account,

//@audit remove the whiteSpace before the ')' char
1382:         for (uint256 i = 0; i < pLength; ) {
1383:             fingerprintIncomingList = PanopticMath.updatePositionsHash(

//@audit remove the whiteSpace before the ')' char
1518:         for (uint256 leg = 0; leg < numLegs; ) {
1519:             uint256 isLong = tokenId.isLong(leg);

//@audit remove the whiteSpace before the ')' char
1598:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1599: 

//@audit remove the whiteSpace before the ',' char
1598:         (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1599: 

//@audit remove the whiteSpace before the ')' char
1852:         for (uint256 leg = 0; leg < numLegs; ) {
1853:             LeftRightSigned legPremia = premiaByLeg[leg];


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L304-L305) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L304-L305), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L339-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L339-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L387-L388), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L387-L388), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L441-L442), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L459-L460), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L523-L524), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L523-L524), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L745-L746), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L802-L803), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L864-L865), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1032-L1033), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1032-L1033), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1094-L1095), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1094-L1095), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1202-L1203), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1202-L1203), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1206-L1207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1382-L1383), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1518-L1519), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1598-L1599), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1598-L1599), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1852-L1853)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit remove the whiteSpace before the ',' char
24: //                       ,.                                   .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.                                    ,,
25: //                    ,,,,,,,                           ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                            ,,,,,,

//@audit remove the whiteSpace before the ',' char
25: //                    ,,,,,,,                           ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                            ,,,,,,
26: //                  .,,,,,,,,,,.                   ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                     ,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
26: //                  .,,,,,,,,,,.                   ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                     ,,,,,,,,,,,
27: //                .,,,,,,,,,,,,,,,             ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.              ,,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
27: //                .,,,,,,,,,,,,,,,             ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.              ,,,,,,,,,,,,,,,
28: //               ,,,,,,,,,,,,,,.            ,,,,,,,,,,,,,,,,,,,,,,,,,,,                ,,,,,,,,,,,,,,,,,,,,,,,,,,.             ,,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
28: //               ,,,,,,,,,,,,,,.            ,,,,,,,,,,,,,,,,,,,,,,,,,,,                ,,,,,,,,,,,,,,,,,,,,,,,,,,.             ,,,,,,,,,,,,,,,
29: //             ,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,,,,,,                                ,,,,,,,,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
29: //             ,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,,,,,,                                ,,,,,,,,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,,
30: //            ,,,,,,,,,,,,,.           ,,,,,,,,,,,,,,,,,,                                           .,,,,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
30: //            ,,,,,,,,,,,,,.           ,,,,,,,,,,,,,,,,,,                                           .,,,,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,
31: //          ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,,,.                                                  ,,,,,,,,,,,,,,,,,           .,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
31: //          ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,,,.                                                  ,,,,,,,,,,,,,,,,,           .,,,,,,,,,,,,,
32: //         ,,,,,,,,,,,,,.         .,,,,,,,,,,,,,,,.                                                        ,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
32: //         ,,,,,,,,,,,,,.         .,,,,,,,,,,,,,,,.                                                        ,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,.
33: //        ,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,                                                              ,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
33: //        ,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,                                                              ,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,
34: //       ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,.                                                                  ,,,,,,,,,,,,,,           ,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
34: //       ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,.                                                                  ,,,,,,,,,,,,,,           ,,,,,,,,,,,,,
35: //      ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,                                                                      ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
35: //      ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,                                                                      ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,
36: //     ,,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                         ,,,,,,,,,,,,,,          ,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
36: //     ,,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                         ,,,,,,,,,,,,,,          ,,,,,,,,,,,,.
37: //    .,,,,,,,,,,,,        .,,,,,,,,,,,,,                                                                            ,,,,,,,,,,,,,          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
37: //    .,,,,,,,,,,,,        .,,,,,,,,,,,,,                                                                            ,,,,,,,,,,,,,          ,,,,,,,,,,,,
38: //    ,,,,,,,,,,,,         ,,,,,,,,,,,,                                                                               ,,,,,,,,,,,,,         .,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
38: //    ,,,,,,,,,,,,         ,,,,,,,,,,,,                                                                               ,,,,,,,,,,,,,         .,,,,,,,,,,,,
39: //   ,,,,,,,,,,,,         ,,,,,,,,,,,,                                                                                 ,,,,,,,,,,,,.         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
39: //   ,,,,,,,,,,,,         ,,,,,,,,,,,,                                                                                 ,,,,,,,,,,,,.         ,,,,,,,,,,,,
40: //   ,,,,,,,,,,,,        ,,,,,,,,,,,,.                bababababababababa  bababababababababababa bababababababababababa  babababababa   babababababa               ,,,,,,,,,,,,          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
40: //   ,,,,,,,,,,,,        ,,,,,,,,,,,,.                bababababababababa  bababababababababababa bababababababababababa  babababababa   babababababa               ,,,,,,,,,,,,          ,,,,,,,,,,,,
41: //  .,,,,,,,,,,,,        ,,,,,,,,,,,,                babababababababababababababababababababababababababababababababababababababababababababa babababababa                .,,,,,,,,,,,,         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
41: //  .,,,,,,,,,,,,        ,,,,,,,,,,,,                babababababababababababababababababababababababababababababababababababababababababababa babababababa                .,,,,,,,,,,,,         ,,,,,,,,,,,,
42: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                babababa    bababa  babababa   ba ba  babababa    babababa babababababababababababababa                 ,,,,,,,,,,,,         ,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
42: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                babababa    bababa  babababa   ba ba  babababa    babababa babababababababababababababa                 ,,,,,,,,,,,,         ,,,,,,,,,,,,.
43: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                bababababababababababa  babababababababa    bababababababababababa  bababababababababa babababa                 .,,,,,,,,,,,          ,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
43: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                bababababababababababa  babababababababa    bababababababababababa  bababababababababa babababa                 .,,,,,,,,,,,          ,,,,,,,,,,,.
44: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababababababababababa babababababababa    babababababababababa   babababa bababa  babababa                  ,,,,,,,,,,,.         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
44: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababababababababababa babababababababa    babababababababababa   babababa bababa  babababa                  ,,,,,,,,,,,.         ,,,,,,,,,,,,
45: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababa    babababa babababa  ba     babababa         babababa      babababa                  ,,,,,,,,,,,,         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
45: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababa    babababa babababa  ba     babababa         babababa      babababa                  ,,,,,,,,,,,,         ,,,,,,,,,,,,
46: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                bababababababababababa  bababababa       bababababa        bababababa     bababababa                 ,,,,,,,,,,,          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
46: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                bababababababababababa  bababababa       bababababa        bababababa     bababababa                 ,,,,,,,,,,,          ,,,,,,,,,,,,
47: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababababababababa  bababababa       bababababa        bababababa     bababababa                 ,,,,,,,,,,,,          ,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
47: //  ,,,,,,,,,,,,        ,,,,,,,,,,,,                 bababababababababa  bababababa       bababababa        bababababa     bababababa                 ,,,,,,,,,,,,          ,,,,,,,,,,,.
48: //  ,,,,,,,,,,,,        .,,,,,,,,,,,.                                                                                    ,,,,,,,,,,,,         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
48: //  ,,,,,,,,,,,,        .,,,,,,,,,,,.                                                                                    ,,,,,,,,,,,,         ,,,,,,,,,,,,
49: //  .,,,,,,,,,,,,        ,,,,,,,,,,,,                                                                                   .,,,,,,,,,,,,         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
49: //  .,,,,,,,,,,,,        ,,,,,,,,,,,,                                                                                   .,,,,,,,,,,,,         ,,,,,,,,,,,,
50: //   ,,,,,,,,,,,,        ,,,,,,,,,,,,,                                                                                  ,,,,,,,,,,,,          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
50: //   ,,,,,,,,,,,,        ,,,,,,,,,,,,,                                                                                  ,,,,,,,,,,,,          ,,,,,,,,,,,,
51: //   ,,,,,,,,,,,,.        ,,,,,,,,,,,,.                                                                                ,,,,,,,,,,,,.         ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
51: //   ,,,,,,,,,,,,.        ,,,,,,,,,,,,.                                                                                ,,,,,,,,,,,,.         ,,,,,,,,,,,,
52: //    ,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                              ,,,,,,,,,,,,,         .,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
52: //    ,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                              ,,,,,,,,,,,,,         .,,,,,,,,,,,,
53: //     ,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                            ,,,,,,,,,,,,,         .,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
53: //     ,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                            ,,,,,,,,,,,,,         .,,,,,,,,,,,,
54: //     .,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                         ,,,,,,,,,,,,,.          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
54: //     .,,,,,,,,,,,,         ,,,,,,,,,,,,,                                                                         ,,,,,,,,,,,,,.          ,,,,,,,,,,,,
55: //      ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,                                                                     .,,,,,,,,,,,,,.          ,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
55: //      ,,,,,,,,,,,,,         ,,,,,,,,,,,,,,                                                                     .,,,,,,,,,,,,,.          ,,,,,,,,,,,,
56: //       ,,,,,,,,,,,,,         .,,,,,,,,,,,,,,                                                                 .,,,,,,,,,,,,,,          .,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
56: //       ,,,,,,,,,,,,,         .,,,,,,,,,,,,,,                                                                 .,,,,,,,,,,,,,,          .,,,,,,,,,,,,
57: //        ,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,                                                             ,,,,,,,,,,,,,,,.          ,,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
57: //        ,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,                                                             ,,,,,,,,,,,,,,,.          ,,,,,,,,,,,,,.
58: //         ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,,                                                       .,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
58: //         ,,,,,,,,,,,,,,          ,,,,,,,,,,,,,,,,                                                       .,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,
59: //          .,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,                                                 .,,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
59: //          .,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,                                                 .,,,,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,
60: //            ,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,,,.                                        ,,,,,,,,,,,,,,,,,,,.            ,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
60: //            ,,,,,,,,,,,,,,           ,,,,,,,,,,,,,,,,,,,.                                        ,,,,,,,,,,,,,,,,,,,.            ,,,,,,,,,,,,,,
61: //             ,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,,,,,,,,,                             .,,,,,,,,,,,,,,,,,,,,,,             ,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
61: //             ,,,,,,,,,,,,,,,            ,,,,,,,,,,,,,,,,,,,,,,                             .,,,,,,,,,,,,,,,,,,,,,,             ,,,,,,,,,,,,,,
62: //               ,,,,,,,,,,,,,,,            .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,             .,,,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
62: //               ,,,,,,,,,,,,,,,            .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.        ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,             .,,,,,,,,,,,,,,.
63: //                 ,,,,,,,,,,,,,,.              ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,               ,,,,,,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
63: //                 ,,,,,,,,,,,,,,.              ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,               ,,,,,,,,,,,,,,,
64: //                   ,,,,,,,,,,                     ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                     .,,,,,,,,,,

//@audit remove the whiteSpace before the ',' char
64: //                   ,,,,,,,,,,                     ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                     .,,,,,,,,,,
65: //                     ,,,,,.                            ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                             ,,,,,,

//@audit remove the whiteSpace before the ',' char
65: //                     ,,,,,.                            ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                             ,,,,,,
66: //                       ,                                     ..,,,,,,,,,,,,,,,,,,,,,,,,,,,,.

//@audit remove the whiteSpace before the ',' char
66: //                       ,                                     ..,,,,,,,,,,,,,,,,,,,,,,,,,,,,.
67: 

//@audit remove the whiteSpace before the ')' char
575:         for (uint256 i = 0; i < ids.length; ) {
576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

//@audit remove the whiteSpace before the ')' char
601:         for (uint256 leg = 0; leg < numLegs; ) {
602:             // for this leg index: extract the liquidity chunk: a 256bit word containing the liquidity amount and upper/lower tick

//@audit remove the whiteSpace before the ')' char
725:         (, int24 currentTick, , , , , ) = univ3pool.slot0();
726: 

//@audit remove the whiteSpace before the ',' char
725:         (, int24 currentTick, , , , , ) = univ3pool.slot0();
726: 

//@audit remove the whiteSpace before the ')' char
788:                 (uint160 sqrtPriceX96, , , , , , ) = _univ3pool.slot0();
789: 

//@audit remove the whiteSpace before the ',' char
788:                 (uint160 sqrtPriceX96, , , , , , ) = _univ3pool.slot0();
789: 

//@audit remove the whiteSpace before the ')' char
882:         for (uint256 leg = 0; leg < numLegs; ) {
883:             LeftRightSigned _moved;

//@audit remove the whiteSpace before the ')' char
1148:         (, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, , ) = univ3pool
1149:             .positions(

//@audit remove the whiteSpace before the ',' char
1148:         (, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, , ) = univ3pool
1149:             .positions(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L24-L25) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L25-L26), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L26-L27), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L27-L28), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L28-L29), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L29-L30), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L30-L31), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L31-L32), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L32-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L33-L34), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L34-L35), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L35-L36), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L36-L37), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L37-L38), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L38-L39), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L39-L40), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L40-L41), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L41-L42), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L42-L43), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L43-L44), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L44-L45), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L45-L46), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L46-L47), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L47-L48), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L48-L49), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L49-L50), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L50-L51), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L51-L52), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L52-L53), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L53-L54), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L54-L55), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L55-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L56-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L57-L58), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L58-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L59-L60), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L60-L61), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L61-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L62-L63), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L63-L64), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L64-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L65-L66), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L66-L67), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L575-L576), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L601-L602), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L725-L726), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L725-L726), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L788-L789), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L788-L789), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L882-L883), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1148-L1149), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1148-L1149)


```solidity

File: ./contracts/libraries/Errors.sol

//@audit remove the whiteSpace before the ',' char
41:     /// @param parameterType poolId=0, ratio=1, tokenType=2, risk_partner=3 , strike=4, width=5, two identical strike/width/tokenType chunks=6
42:     error InvalidTokenIdParameter(uint256 parameterType);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L41-L42) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit remove the whiteSpace before the ')' char
51:         for (uint256 k = 0; k < positionIdList.length; ) {
52:             TokenId tokenId = positionIdList[k];

//@audit remove the whiteSpace before the ')' char
55:             for (uint256 leg = 0; leg < numLegs; ) {
56:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

//@audit remove the whiteSpace before the ')' char
142:         (, , uint256 lowerOut0, uint256 lowerOut1, , , , ) = univ3pool.ticks(tickLower);
143:         (, , uint256 upperOut0, uint256 upperOut1, , , , ) = univ3pool.ticks(tickUpper);

//@audit remove the whiteSpace before the ',' char
142:         (, , uint256 lowerOut0, uint256 lowerOut1, , , , ) = univ3pool.ticks(tickLower);
143:         (, , uint256 upperOut0, uint256 upperOut1, , , , ) = univ3pool.ticks(tickUpper);

//@audit remove the whiteSpace before the ')' char
143:         (, , uint256 upperOut0, uint256 upperOut1, , , , ) = univ3pool.ticks(tickUpper);
144: 

//@audit remove the whiteSpace before the ',' char
143:         (, , uint256 upperOut0, uint256 upperOut1, , , , ) = univ3pool.ticks(tickUpper);
144: 

//@audit reduce the number of whiteSpace before the '=' char
191:                         baa                             = (all fees collected for the entire price range for token 0)
192:                         baa


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L51-L52) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L55-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L142-L143), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L142-L143), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L143-L144), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L143-L144), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L191-L192)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit reduce the number of whiteSpace before the '=' char
37:     ///        univ3pool   = 0x8ad599c3A0ff1De082011EFDDc58f1908eb6e6D8
38:     ///        tickSpacing = 60

//@audit reduce the number of whiteSpace before the '=' char
43:     ///        poolId      = 0x003c8ad599c3A0ff
44:     ///

//@audit remove the whiteSpace before the ')' char
138:                 (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
139:                     uint256(

//@audit remove the whiteSpace before the ',' char
138:                 (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
139:                     uint256(

//@audit remove the whiteSpace before the ')' char
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
187:                         uint256(

//@audit remove the whiteSpace before the ',' char
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
187:                         uint256(

//@audit remove the whiteSpace before the ')' char
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
193:                         .observations(observationIndex);

//@audit remove the whiteSpace before the ',' char
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
193:                         .observations(observationIndex);

//@audit remove the whiteSpace before the ')' char
253:             (int56[] memory tickCumulatives, ) = univ3pool.observe(secondsAgos);
254: 

//@audit remove the whiteSpace before the ')' char
395:         for (uint256 leg = 0; leg < numLegs; ) {
396:             // Compute the amount of funds that have been removed from the Panoptic Pool


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L37-L38) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L43-L44), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L138-L139), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L138-L139), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L186-L187), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L186-L187), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L192-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L192-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L253-L254), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L395-L396)


```solidity

File: ./contracts/multicall/Multicall.sol

//@audit remove the whiteSpace before the ')' char
14:         for (uint256 i = 0; i < data.length; ) {
15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L14-L15) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit remove the whiteSpace before the ')' char
143:         for (uint256 i = 0; i < ids.length; ) {
144:             id = ids[i];


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L143-L144) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

//@audit remove the whiteSpace after the '(' char
37: // (1) Liquidity        128bits  : The liquidity within the chunk (uint128).
38: // ( ) (Zero-bits)       80bits  : Zero-bits to match a total uint256.
39: // (2) tick Upper        24bits  : The upper tick of the chunk (int24).

//@audit remove the whiteSpace before the ')' char
38: // ( ) (Zero-bits)       80bits  : Zero-bits to match a total uint256.
39: // (2) tick Upper        24bits  : The upper tick of the chunk (int24).

//@audit remove the whiteSpace after the '(' char
45: //
46: //           (3)             (2)             ( )                (1)
47: //    <-- 24 bits -->  <-- 24 bits -->  <-- 80 bits -->   <-- 128 bits -->

//@audit remove the whiteSpace before the ')' char
46: //           (3)             (2)             ( )                (1)
47: //    <-- 24 bits -->  <-- 24 bits -->  <-- 80 bits -->   <-- 128 bits -->


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L37-L39) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L38-L39), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L45-L47), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L46-L47)


</details>


### [NC&#x2011;51] Complex function controle flow 
Due to multiple if, loop and conditions the following functions has a very complex controle flow that could make auditing very difficult to cover all possible path\nTherefore, consider breaking down these blocks into more manageable units, by splitting things into utility functions, by reducing nesting, and by using early returns


*There are 8 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

1311:     function _getRequiredCollateralSingleLegNoPartner(
1312:         TokenId tokenId,
1313:         uint256 index,
1314:         uint128 positionSize,
1315:         int24 atTick,
1316:         uint128 poolUtilization
1317:     ) internal view returns (uint256 required) {
1318:         // extract the tokenType (token0 or token1)
1319:         uint256 tokenType = tokenId.tokenType(index);
1320: 
1321:         // compute the total amount of funds moved for that position
1322:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);
1323: 
1324:         // amount moved is right slot if tokenType=0, left slot otherwise
1325:         uint128 amountMoved = tokenType == 0 ? amountsMoved.rightSlot() : amountsMoved.leftSlot();
1326: 
1327:         // match tokenType with the correct pool utilization
1328:         int64 utilization = tokenType == 0
1329:             ? int64(uint64(poolUtilization))
1330:             : int64(uint64(poolUtilization >> 64));
1331: 
1332:         uint256 isLong = tokenId.isLong(index);
1333: 
1334:         // start with base requirement, which is based on isLong value
1335:         required = _getRequiredCollateralAtUtilization(amountMoved, isLong, utilization);
1336: 
1337:         // if the position is long, required tokens does not depend on price
1338:         unchecked {
1339:             if (isLong == 0) {
1340:                 // if position is short, check whether the position is out-the-money
1341: 
1342:                 (int24 tickLower, int24 tickUpper) = tokenId.asTicks(index);
1343: 
1344:                 // compute the collateral requirement as a fixed amount that doesn't depend on price
1345:                 if (
1346:                     ((atTick >= tickUpper) && (tokenType == 1)) || // strike OTM when price >= upperTick for tokenType=1
1347:                     ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0
1348:                 ) {
1349:                     // position is out-the-money, collateral requirement = SCR * amountMoved
1350:                     required;
1351:                 } else {
1352:                     int24 strike = tokenId.strike(index);
1353:                     // if position is ITM or ATM, then the collateral requirement depends on price:
1354: 
1355:                     // compute the ratio of strike to price for calls (or price to strike for puts)
1356:                     // (- and * 2 in tick space are / and ^ 2 in price space so sqrtRatioAtTick(2 *(a - b)) = a/b (*2^96)
1357:                     // both of these ratios decrease as the position becomes deeper ITM, and it is possible
1358:                     // for the ratio of the prices to go under the minimum price
1359:                     // (which is the limit of what getSqrtRatioAtTick supports)
1360:                     // so instead we cap it at the minimum price, which is acceptable because
1361:                     // a higher ratio will result in an increased slope for the collateral requirement
1362:                     uint160 ratio = tokenType == 1 // tokenType
1363:                         ? Math.getSqrtRatioAtTick(
1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)
1365:                         ) // puts ->  price/strike
1366:                         : Math.getSqrtRatioAtTick(
1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)
1368:                         ); // calls -> strike/price
1369: 
1370:                     // compute the collateral requirement depending on whether the position is ITM & out-of-range or ITM and in-range:
1371: 
1372:                     /// ITM and out-of-range
1373:                     if (
1374:                         ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
1375:                         ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
1376:                     ) {
1377:                         /**
1378:                                     Short put BPR = 100% - (price/strike) + SCR
1379: 
1380:                            BUYING
1381:                            POWER
1382:                            REQUIREMENT
1383:                          
1384:                                          ^               .         .
1385:                                          |        <- ITM . <-ATM-> . OTM ->
1386:                            100% + SCR% - |--__           .    .    .
1387:                                   100% - | . .B/B/--__     .    .    .
1388:                                          |    .     B/B/--__    .    .
1389:                                    SCR - |    .          .B/B/--__________
1390:                                          |    .          .    .    .
1391:                                          +----+----------+----+----+--->   current
1392:                                          0   Liqui-     Pa  strike Pb       price
1393:                                              dation
1394:                                              price = SCR*strike                                         
1395:                          */
1396: 
1397:                         uint256 c2 = Constants.FP96 - ratio;
1398: 
1399:                         // compute the tokens required
1400:                         // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
1401:                         required += Math.mulDiv96RoundingUp(amountMoved, c2);
1402:                     } else {
1403:                         // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
1404:                         // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
1405:                         // the collateral requirement when in-range, which always over-estimates the amount of token required
1406:                         // Specifically:
1407:                         //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
1408:                         uint160 scaleFactor = Math.getSqrtRatioAtTick(
1409:                             (tickUpper - strike) + (strike - tickLower)
1410:                         );
1411:                         uint256 c3 = Math.mulDivRoundingUp(
1412:                             amountMoved,
1413:                             scaleFactor - ratio,
1414:                             scaleFactor + Constants.FP96
1415:                         );
1416:                         // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
1417:                         required += c3;
1418:                     }
1419:                 }
1420:             }
1421:         }
1422:     }

1510:     function _computeSpread(
1511:         TokenId tokenId,
1512:         uint128 positionSize,
1513:         uint256 index,
1514:         uint256 partnerIndex,
1515:         uint128 poolUtilization
1516:     ) internal view returns (uint256 spreadRequirement) {
1517:         // compute the total amount of funds moved for the position's current leg
1518:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);
1519: 
1520:         // compute the total amount of funds moved for the position's partner leg
1521:         LeftRightUnsigned amountsMovedPartner = PanopticMath.getAmountsMoved(
1522:             tokenId,
1523:             positionSize,
1524:             partnerIndex
1525:         );
1526: 
1527:         // amount moved is right slot if tokenType=0, left slot otherwise
1528:         uint128 movedRight = amountsMoved.rightSlot();
1529:         uint128 movedLeft = amountsMoved.leftSlot();
1530: 
1531:         // amounts moved for partner
1532:         uint128 movedPartnerRight = amountsMovedPartner.rightSlot();
1533:         uint128 movedPartnerLeft = amountsMovedPartner.leftSlot();
1534: 
1535:         uint256 tokenType = tokenId.tokenType(index);
1536: 
1537:         // compute the max loss of the spread
1538: 
1539:         // if asset is NOT the same as the tokenType, the required amount is simply the difference in notional values
1540:         // ie. asset = 1, tokenType = 0:
1541:         if (tokenId.asset(index) != tokenType) {
1542:             unchecked {
1543:                 // always take the absolute values of the difference of amounts moved
1544:                 if (tokenType == 0) {
1545:                     spreadRequirement = movedRight < movedPartnerRight
1546:                         ? movedPartnerRight - movedRight
1547:                         : movedRight - movedPartnerRight;
1548:                 } else {
1549:                     spreadRequirement = movedLeft < movedPartnerLeft
1550:                         ? movedPartnerLeft - movedLeft
1551:                         : movedLeft - movedPartnerLeft;
1552:                 }
1553:             }
1554:         } else {
1555:             unchecked {
1556:                 uint256 notional;
1557:                 uint256 notionalP;
1558:                 uint128 contracts;
1559:                 if (tokenType == 1) {
1560:                     notional = movedRight;
1561:                     notionalP = movedPartnerRight;
1562:                     contracts = movedLeft;
1563:                 } else {
1564:                     notional = movedLeft;
1565:                     notionalP = movedPartnerLeft;
1566:                     contracts = movedRight;
1567:                 }
1568:                 // the required amount is the amount of contracts multiplied by (notional1 - notional2)/min(notional1, notional2)
1569:                 // can use unsafe because denominator is always nonzero
1570:                 spreadRequirement = (notional < notionalP)
1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)
1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);
1573:             }
1574:         }
1575: 
1576:         // calculate the spread requirement as max(max_loss, long_leg_col_req)
1577:         // narrower spreads will be very capital efficient (1/3 of non-partnered CR!), but
1578:         // wider spreads (an uncommon position w/ high max loss) may not benefit from risk partnering
1579:         spreadRequirement = Math.max(
1580:             spreadRequirement,
1581:             _getRequiredCollateralAtUtilization(
1582:                 tokenType == 0 ? movedRight : movedLeft,
1583:                 1,
1584:                 tokenType == 0
1585:                     ? int64(uint64(poolUtilization))
1586:                     : int64(uint64(poolUtilization >> 64))
1587:             )
1588:         );
1589:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1311-L1422) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1510-L1589)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

680:     function _validateAndForwardToAMM(
681:         TokenId tokenId,
682:         uint128 positionSize,
683:         int24 tickLimitLow,
684:         int24 tickLimitHigh,
685:         bool isBurn
686:     ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {
687:         // Reverts if positionSize is 0 and user did not own the position before minting/burning
688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();
689: 
690:         /// @dev the flipToBurnToken() function flips the isLong bits
691:         if (isBurn) {
692:             tokenId = tokenId.flipToBurnToken();
693:         }
694: 
695:         // Validate tokenId
696:         tokenId.validate();
697: 
698:         // Extract univ3pool from the poolId map to Uniswap Pool
699:         IUniswapV3Pool univ3pool = s_poolContext[tokenId.poolId()].pool;
700: 
701:         // Revert if the pool not been previously initialized
702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();
703: 
704:         // initialize some variables returned by the _createPositionInAMM function
705:         LeftRightSigned itmAmounts;
706: 
707:         // calls a function that loops through each leg of tokenId and mints/burns liquidity in Uni v3 pool
708:         (totalMoved, collectedByLeg, itmAmounts) = _createPositionInAMM(
709:             univ3pool,
710:             tokenId,
711:             positionSize,
712:             isBurn
713:         );
714: 
715:         if (tickLimitLow > tickLimitHigh) {
716:             // if the in-the-money amount is not zero (i.e. positions were minted ITM) and the user did provide tick limits LOW > HIGH, then swap necessary amounts
717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {
718:                 totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);
719:             }
720: 
721:             (tickLimitLow, tickLimitHigh) = (tickLimitHigh, tickLimitLow);
722:         }
723: 
724:         // Get the current tick of the Uniswap pool, check slippage
725:         (, int24 currentTick, , , , , ) = univ3pool.slot0();
726: 
727:         if ((currentTick >= tickLimitHigh) || (currentTick <= tickLimitLow))
728:             revert Errors.PriceBoundFail();
729:     }

0958:     function _createLegInAMM(
0959:         IUniswapV3Pool univ3pool,
0960:         TokenId tokenId,
0961:         uint256 leg,
0962:         LiquidityChunk liquidityChunk,
0963:         bool isBurn
0964:     )
0965:         internal
0966:         returns (
0967:             LeftRightSigned moved,
0968:             LeftRightSigned itmAmounts,
0969:             LeftRightUnsigned collectedSingleLeg
0970:         )
0971:     {
0972:         uint256 tokenType = tokenId.tokenType(leg);
0973:         // unique key to identify the liquidity chunk in this uniswap pool
0974:         bytes32 positionKey = keccak256(
0975:             abi.encodePacked(
0976:                 address(univ3pool),
0977:                 msg.sender,
0978:                 tokenType,
0979:                 liquidityChunk.tickLower(),
0980:                 liquidityChunk.tickUpper()
0981:             )
0982:         );
0983: 
0984:         // update our internal bookkeeping of how much liquidity we have deployed in the AMM
0985:         // for example: if this _leg is short, we add liquidity to the amm, make sure to add that to our tracking
0986:         uint128 updatedLiquidity;
0987:         uint256 isLong = tokenId.isLong(leg);
0988:         LeftRightUnsigned currentLiquidity = s_accountLiquidity[positionKey]; //cache
0989:         {
0990:             // did we have liquidity already deployed in Uniswap for this chunk range from some past mint?
0991: 
0992:             // s_accountLiquidity is a LeftRight. The right slot represents the liquidity currently sold (added) in the AMM owned by the user
0993:             // the left slot represents the amount of liquidity currently bought (removed) that has been removed from the AMM - the user owes it to a seller
0994:             // the reason why it is called "removedLiquidity" is because long options are created by removing -ie.short selling LP positions
0995:             uint128 startingLiquidity = currentLiquidity.rightSlot();
0996:             uint128 removedLiquidity = currentLiquidity.leftSlot();
0997:             uint128 chunkLiquidity = liquidityChunk.liquidity();
0998: 
0999:             if (isLong == 0) {
1000:                 // selling/short: so move from msg.sender *to* uniswap
1001:                 // we're minting more liquidity in uniswap: so add the incoming liquidity chunk to the existing liquidity chunk
1002:                 updatedLiquidity = startingLiquidity + chunkLiquidity;
1003: 
1004:                 /// @dev If the isLong flag is 0=short but the position was burnt, then this is closing a long position
1005:                 /// @dev so the amount of removed liquidity should decrease.
1006:                 if (isBurn) {
1007:                     removedLiquidity -= chunkLiquidity;
1008:                 }
1009:             } else {
1010:                 // the _leg is long (buying: moving *from* uniswap to msg.sender)
1011:                 // so we seek to move the incoming liquidity chunk *out* of uniswap - but was there sufficient liquidity sitting in uniswap
1012:                 // in the first place?
1013:                 if (startingLiquidity < chunkLiquidity) {
1014:                     // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
1015:                     // what the account that owns the liquidity in uniswap has (startingLiquidity)
1016:                     // we must ensure that an account can only move its own liquidity out of uniswap
1017:                     // so we revert in this case
1018:                     revert Errors.NotEnoughLiquidity();
1019:                 } else {
1020:                     // startingLiquidity is >= chunkLiquidity, so no possible underflow
1021:                     unchecked {
1022:                         // we want to move less than what already sits in uniswap, no problem:
1023:                         updatedLiquidity = startingLiquidity - chunkLiquidity;
1024:                     }
1025:                 }
1026: 
1027:                 /// @dev If the isLong flag is 1=long and the position is minted, then this is opening a long position
1028:                 /// @dev so the amount of removed liquidity should increase.
1029:                 if (!isBurn) {
1030:                     // we can't remove more liquidity than we add in the first place, so this can't overflow
1031:                     unchecked {
1032:                         removedLiquidity += chunkLiquidity;
1033:                     }
1034:                 }
1035:             }
1036: 
1037:             // update the starting liquidity for this position for next time around
1038:             s_accountLiquidity[positionKey] = LeftRightUnsigned
1039:                 .wrap(0)
1040:                 .toLeftSlot(removedLiquidity)
1041:                 .toRightSlot(updatedLiquidity);
1042:         }
1043: 
1044:         // track how much liquidity we need to collect from uniswap
1045:         // add the fees that accumulated in uniswap within the liquidityChunk:
1046:         {
1047:             /** if the position is NOT long (selling a put or a call), then _mintLiquidity to move liquidity
1048:                 from the msg.sender to the uniswap v3 pool:
1049:                 Selling(isLong=0): Mint chunk of liquidity in Uniswap (defined by upper tick, lower tick, and amount)
1050:                        bbabababababababababababababababababababababababababababababababababa
1051:                 ba2     bba<ba liquidityChunk                 ba
1052:                 ba  bbabab4bab4bababa                         bbababab4bababa
1053:                 ba  ba       ba                         ba      ba
1054:                 bbabab4bababababababab4bababa:                      bbababababababa
1055:                    Uniswap v3                      msg.sender
1056:             
1057:              else: the position is long (buying a put or a call), then _burnLiquidity to remove liquidity from univ3
1058:                 Buying(isLong=1): Burn in Uniswap
1059:                        bbabababababababababababababababababa
1060:                 ba2     bb<ba                ba
1061:                 ba  bbabab4bab4bababa         bbabababa<bababa
1062:                 ba  ba       ba         ba      ba
1063:                 bbabab4bababababababab4bababa:      bbababababababa
1064:                     Uniswap v3      msg.sender 
1065:             */
1066:             moved = isLong == 0
1067:                 ? _mintLiquidity(liquidityChunk, univ3pool)
1068:                 : _burnLiquidity(liquidityChunk, univ3pool); // from msg.sender to Uniswap
1069:             // add the moved liquidity chunk to amount we need to collect from uniswap:
1070: 
1071:             // Is this _leg ITM?
1072:             // if tokenType is 1, and we transacted some token0: then this leg is ITM!
1073:             if (tokenType == 1) {
1074:                 // extract amount moved out of UniswapV3 pool
1075:                 itmAmounts = itmAmounts.toRightSlot(moved.rightSlot());
1076:             }
1077:             // if tokenType is 0, and we transacted some token1: then this leg is ITM
1078:             if (tokenType == 0) {
1079:                 // Add this in-the-money amount transacted.
1080:                 itmAmounts = itmAmounts.toLeftSlot(moved.leftSlot());
1081:             }
1082:         }
1083: 
1084:         // if there was liquidity at that tick before the transaction, collect any accumulated fees
1085:         if (currentLiquidity.rightSlot() > 0) {
1086:             collectedSingleLeg = _collectAndWritePositionData(
1087:                 liquidityChunk,
1088:                 univ3pool,
1089:                 currentLiquidity,
1090:                 positionKey,
1091:                 moved,
1092:                 isLong
1093:             );
1094:         }
1095: 
1096:         // position has been touched, update s_accountFeesBase with the latest values from the pool.positions
1097:         // round up the stored feesbase to minimize Nfeesbase when we next calculate it
1098:         s_accountFeesBase[positionKey] = _getFeesBase(
1099:             univ3pool,
1100:             updatedLiquidity,
1101:             liquidityChunk,
1102:             true
1103:         );
1104:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L680-L729) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L958-L1104)


```solidity

File: ./contracts/libraries/Math.sol

091:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {
092:         unchecked {
093:             if (x >= 0x100000000000000000000000000000000) {
094:                 x >>= 128;
095:                 r += 32;
096:             }
097:             if (x >= 0x10000000000000000) {
098:                 x >>= 64;
099:                 r += 16;
100:             }
101:             if (x >= 0x100000000) {
102:                 x >>= 32;
103:                 r += 8;
104:             }
105:             if (x >= 0x10000) {
106:                 x >>= 16;
107:                 r += 4;
108:             }
109:             if (x >= 0x100) {
110:                 x >>= 8;
111:                 r += 2;
112:             }
113:             if (x >= 0x10) {
114:                 r += 1;
115:             }
116:         }
117:     }

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {
129:         unchecked {
130:             uint256 absTick = tick < 0 ? uint256(-int256(tick)) : uint256(int256(tick));
131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();
132: 
133:             uint256 sqrtR = absTick & 0x1 != 0
134:                 ? 0xfffcb933bd6fad37aa2d162d1a594001
135:                 : 0x100000000000000000000000000000000;
136:             // RealV: 0xfffcb933bd6fad37aa2d162d1a594001
137:             if (absTick & 0x2 != 0) sqrtR = (sqrtR * 0xfff97272373d413259a46990580e213a) >> 128;
138:             // RealV: 0xfff97272373d413259a46990580e2139
139:             if (absTick & 0x4 != 0) sqrtR = (sqrtR * 0xfff2e50f5f656932ef12357cf3c7fdcc) >> 128;
140:             // RealV: 0xfff2e50f5f656932ef12357cf3c7fdca
141:             if (absTick & 0x8 != 0) sqrtR = (sqrtR * 0xffe5caca7e10e4e61c3624eaa0941cd0) >> 128;
142:             // RealV: 0xffe5caca7e10e4e61c3624eaa0941ccd
143:             if (absTick & 0x10 != 0) sqrtR = (sqrtR * 0xffcb9843d60f6159c9db58835c926644) >> 128;
144:             // RealV: 0xffcb9843d60f6159c9db58835c92663e
145:             if (absTick & 0x20 != 0) sqrtR = (sqrtR * 0xff973b41fa98c081472e6896dfb254c0) >> 128;
146:             // RealV: 0xff973b41fa98c081472e6896dfb254b6
147:             if (absTick & 0x40 != 0) sqrtR = (sqrtR * 0xff2ea16466c96a3843ec78b326b52861) >> 128;
148:             // RealV: 0xff2ea16466c96a3843ec78b326b5284f
149:             if (absTick & 0x80 != 0) sqrtR = (sqrtR * 0xfe5dee046a99a2a811c461f1969c3053) >> 128;
150:             // RealV: 0xfe5dee046a99a2a811c461f1969c3032
151:             if (absTick & 0x100 != 0) sqrtR = (sqrtR * 0xfcbe86c7900a88aedcffc83b479aa3a4) >> 128;
152:             // RealV: 0xfcbe86c7900a88aedcffc83b479aa363
153:             if (absTick & 0x200 != 0) sqrtR = (sqrtR * 0xf987a7253ac413176f2b074cf7815e54) >> 128;
154:             // RealV: 0xf987a7253ac413176f2b074cf7815dd0
155:             if (absTick & 0x400 != 0) sqrtR = (sqrtR * 0xf3392b0822b70005940c7a398e4b70f3) >> 128;
156:             // RealV: 0xf3392b0822b70005940c7a398e4b6ff1
157:             if (absTick & 0x800 != 0) sqrtR = (sqrtR * 0xe7159475a2c29b7443b29c7fa6e889d9) >> 128;
158:             // RealV: 0xe7159475a2c29b7443b29c7fa6e887f2
159:             if (absTick & 0x1000 != 0) sqrtR = (sqrtR * 0xd097f3bdfd2022b8845ad8f792aa5825) >> 128;
160:             // RealV: 0xd097f3bdfd2022b8845ad8f792aa548c
161:             if (absTick & 0x2000 != 0) sqrtR = (sqrtR * 0xa9f746462d870fdf8a65dc1f90e061e5) >> 128;
162:             // RealV: 0xa9f746462d870fdf8a65dc1f90e05b52
163:             if (absTick & 0x4000 != 0) sqrtR = (sqrtR * 0x70d869a156d2a1b890bb3df62baf32f7) >> 128;
164:             // RealV: 0x70d869a156d2a1b890bb3df62baf27ff
165:             if (absTick & 0x8000 != 0) sqrtR = (sqrtR * 0x31be135f97d08fd981231505542fcfa6) >> 128;
166:             // RealV: 0x31be135f97d08fd981231505542fbfe8
167:             if (absTick & 0x10000 != 0) sqrtR = (sqrtR * 0x9aa508b5b7a84e1c677de54f3e99bc9) >> 128;
168:             // RealV: 0x9aa508b5b7a84e1c677de54f3e988fe
169:             if (absTick & 0x20000 != 0) sqrtR = (sqrtR * 0x5d6af8dedb81196699c329225ee604) >> 128;
170:             // RealV: 0x5d6af8dedb81196699c329225ed28d
171:             if (absTick & 0x40000 != 0) sqrtR = (sqrtR * 0x2216e584f5fa1ea926041bedfe98) >> 128;
172:             // RealV: 0x2216e584f5fa1ea926041bedeaf4
173:             if (absTick & 0x80000 != 0) sqrtR = (sqrtR * 0x48a170391f7dc42444e8fa2) >> 128;
174:             // RealV: 0x48a170391f7dc42444e7be7
175: 
176:             if (tick > 0) sqrtR = type(uint256).max / sqrtR;
177: 
178:             // Downcast + rounding up to keep is consistent with Uniswap's
179:             return uint160((sqrtR >> 32) + (sqrtR % (1 << 32) == 0 ? 0 : 1));
180:         }
181:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L91-L117) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L128-L181)


```solidity

File: ./contracts/libraries/PanopticMath.sol

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {
861:                 TokenId tokenId = positionIdList[i];
862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
864:                     if (tokenId.isLong(leg) == 1) {
865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
866:                             storage _settledTokens = settledTokens;
867: 
868:                         // calculate amounts to revoke from settled and subtract from haircut req
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
871:                             uint128(longPremium.rightSlot())
872:                         );
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
875:                             uint128(longPremium.leftSlot())
876:                         );
877: 
878:                         bytes32 chunkKey = keccak256(
879:                             abi.encodePacked(
880:                                 tokenId.strike(0),
881:                                 tokenId.width(0),
882:                                 tokenId.tokenType(0)
883:                             )
884:                         );
885: 
886:                         // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
887:                         // for the haircut directly to the accumulator
888:                         settled0 = Math.max(
889:                             0,
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
891:                         );
892:                         settled1 = Math.max(
893:                             0,
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
895:                         );
896: 
897:                         _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
899:                                 uint128(settled1)
900:                             )
901:                         );
902:                     }
903:                 }
904:             }
905: 
906:             return (collateralDelta0, collateralDelta1);
907:         }
908:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L908) 


```solidity

File: ./contracts/types/TokenId.sol

500:     function validate(TokenId self) internal pure {
501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);
502: 
503:         // loop through the 4 (possible) legs in the tokenId `self`
504:         unchecked {
505:             // extract strike, width, and tokenType
506:             uint256 chunkData = (TokenId.unwrap(self) & CHUNK_MASK) >> 64;
507:             for (uint256 i = 0; i < 4; ++i) {
508:                 if (self.optionRatio(i) == 0) {
509:                     // final leg in this position identified;
510:                     // make sure any leg above this are zero as well
511:                     // (we don't allow gaps eg having legs 1 and 4 active without 2 and 3 is not allowed)
512:                     if ((TokenId.unwrap(self) >> (64 + 48 * i)) != 0)
513:                         revert Errors.InvalidTokenIdParameter(1);
514: 
515:                     break; // we are done iterating over potential legs
516:                 }
517: 
518:                 // prevent legs touching the same chunks - all chunks in the position must be discrete
519:                 uint256 numLegs = self.countLegs();
520:                 for (uint256 j = i + 1; j < numLegs; ++j) {
521:                     if (uint48(chunkData >> (48 * i)) == uint48(chunkData >> (48 * j))) {
522:                         revert Errors.InvalidTokenIdParameter(6);
523:                     }
524:                 }
525:                 // now validate this ith leg in the position:
526: 
527:                 // The width cannot be 0; the minimum is 1
528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);
529:                 // Strike cannot be MIN_TICK or MAX_TICK
530:                 if (
531:                     (self.strike(i) == Constants.MIN_V3POOL_TICK) ||
532:                     (self.strike(i) == Constants.MAX_V3POOL_TICK)
533:                 ) revert Errors.InvalidTokenIdParameter(4);
534: 
535:                 // In the following, we check whether the risk partner of this leg is itself
536:                 // or another leg in this position.
537:                 // Handles case where riskPartner(i) != i ==> leg i has a risk partner that is another leg
538:                 uint256 riskPartnerIndex = self.riskPartner(i);
539:                 if (riskPartnerIndex != i) {
540:                     // Ensures that risk partners are mutual
541:                     if (self.riskPartner(riskPartnerIndex) != i)
542:                         revert Errors.InvalidTokenIdParameter(3);
543: 
544:                     // Ensures that risk partners have 1) the same asset, and 2) the same ratio
545:                     if (
546:                         (self.asset(riskPartnerIndex) != self.asset(i)) ||
547:                         (self.optionRatio(riskPartnerIndex) != self.optionRatio(i))
548:                     ) revert Errors.InvalidTokenIdParameter(3);
549: 
550:                     // long/short status of associated legs
551:                     uint256 _isLong = self.isLong(i);
552:                     uint256 isLongP = self.isLong(riskPartnerIndex);
553: 
554:                     // token type status of associated legs (call/put)
555:                     uint256 _tokenType = self.tokenType(i);
556:                     uint256 tokenTypeP = self.tokenType(riskPartnerIndex);
557: 
558:                     // if the position is the same i.e both long calls, short put's etc.
559:                     // then this is a regular position, not a defined risk position
560:                     if ((_isLong == isLongP) && (_tokenType == tokenTypeP))
561:                         revert Errors.InvalidTokenIdParameter(4);
562: 
563:                     // if the two token long-types and the tokenTypes are both different (one is a short call, the other a long put, e.g.), this is a synthetic position
564:                     // A synthetic long or short is more capital efficient than each leg separated because the long+short premia accumulate proportionally
565:                     // unlike short stranlges, long strangles also cannot be partnered, because there is no reduction in risk (both legs can earn premia simultaneously)
566:                     if (((_isLong != isLongP) || _isLong == 1) && (_tokenType != tokenTypeP))
567:                         revert Errors.InvalidTokenIdParameter(5);
568:                 }
569:             } // end for loop over legs
570:         }
571:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L500-L571) 


</details>


### [NC&#x2011;52] Consider bounding input array length 
The functions below take in an unbounded array, and make function calls for entries in the array. While the function will revert if it eventually runs out of gas, it may be a nicer user experience to `require()` that the length of the array is below some reasonable maximum, so that the user doesn't have to use up a full transaction's gas only to see that the transaction reverts.


*There are 10 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/SemiFungiblePositionManager.sol

//@audit array name ids
566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data
572:     ) public override {
573:         // we don't need to reentrancy lock on transfers, but we can't allow transfers for a pool during mint/burn with a reentrant call
574:         // so just check if there is an active reentrancy lock for the relevant pool on each token
575:         for (uint256 i = 0; i < ids.length; ) {
576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();
577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);
578:             unchecked {
579:                 ++i;
580:             }
581:         }
582: 
583:         // transfer the token (note that all state updates are completed before reentrancy is possible)
584:         super.safeBatchTransferFrom(from, to, ids, amounts, data);
585:     }

//@audit array name amounts
566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data
572:     ) public override {
573:         // we don't need to reentrancy lock on transfers, but we can't allow transfers for a pool during mint/burn with a reentrant call
574:         // so just check if there is an active reentrancy lock for the relevant pool on each token
575:         for (uint256 i = 0; i < ids.length; ) {
576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();
577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);
578:             unchecked {
579:                 ++i;
580:             }
581:         }
582: 
583:         // transfer the token (note that all state updates are completed before reentrancy is possible)
584:         super.safeBatchTransferFrom(from, to, ids, amounts, data);
585:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L585) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L585)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit array name positionIdList
46:     function getPortfolioValue(
47:         int24 atTick,
48:         mapping(TokenId tokenId => LeftRightUnsigned balance) storage userBalance,
49:         TokenId[] calldata positionIdList
50:     ) external view returns (int256 value0, int256 value1) {
51:         for (uint256 k = 0; k < positionIdList.length; ) {
52:             TokenId tokenId = positionIdList[k];
53:             uint128 positionSize = userBalance[tokenId].rightSlot();
54:             uint256 numLegs = tokenId.countLegs();
55:             for (uint256 leg = 0; leg < numLegs; ) {
56:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
57:                     tokenId,
58:                     leg,
59:                     positionSize
60:                 );
61: 
62:                 (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(
63:                     atTick,
64:                     liquidityChunk
65:                 );
66: 
67:                 if (tokenId.isLong(leg) == 0) {
68:                     unchecked {
69:                         value0 += int256(amount0);
70:                         value1 += int256(amount1);
71:                     }
72:                 } else {
73:                     unchecked {
74:                         value0 -= int256(amount0);
75:                         value1 -= int256(amount1);
76:                     }
77:                 }
78: 
79:                 unchecked {
80:                     ++leg;
81:                 }
82:             }
83:             unchecked {
84:                 ++k;
85:             }
86:         }
87:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L46-L87) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit array name positionIdList
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {
861:                 TokenId tokenId = positionIdList[i];
862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
864:                     if (tokenId.isLong(leg) == 1) {
865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
866:                             storage _settledTokens = settledTokens;
867: 
868:                         // calculate amounts to revoke from settled and subtract from haircut req
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
871:                             uint128(longPremium.rightSlot())
872:                         );
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
875:                             uint128(longPremium.leftSlot())
876:                         );
877: 
878:                         bytes32 chunkKey = keccak256(
879:                             abi.encodePacked(
880:                                 tokenId.strike(0),
881:                                 tokenId.width(0),
882:                                 tokenId.tokenType(0)
883:                             )
884:                         );
885: 
886:                         // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
887:                         // for the haircut directly to the accumulator
888:                         settled0 = Math.max(
889:                             0,
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
891:                         );
892:                         settled1 = Math.max(
893:                             0,
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
895:                         );
896: 
897:                         _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
899:                                 uint128(settled1)
900:                             )
901:                         );
902:                     }
903:                 }
904:             }
905: 
906:             return (collateralDelta0, collateralDelta1);
907:         }
908:     }

//@audit array name premiasByLeg
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {
861:                 TokenId tokenId = positionIdList[i];
862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
864:                     if (tokenId.isLong(leg) == 1) {
865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
866:                             storage _settledTokens = settledTokens;
867: 
868:                         // calculate amounts to revoke from settled and subtract from haircut req
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
871:                             uint128(longPremium.rightSlot())
872:                         );
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
875:                             uint128(longPremium.leftSlot())
876:                         );
877: 
878:                         bytes32 chunkKey = keccak256(
879:                             abi.encodePacked(
880:                                 tokenId.strike(0),
881:                                 tokenId.width(0),
882:                                 tokenId.tokenType(0)
883:                             )
884:                         );
885: 
886:                         // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
887:                         // for the haircut directly to the accumulator
888:                         settled0 = Math.max(
889:                             0,
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
891:                         );
892:                         settled1 = Math.max(
893:                             0,
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
895:                         );
896: 
897:                         _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
899:                                 uint128(settled1)
900:                             )
901:                         );
902:                     }
903:                 }
904:             }
905: 
906:             return (collateralDelta0, collateralDelta1);
907:         }
908:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L908) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L908)


```solidity

File: ./contracts/multicall/Multicall.sol

//@audit array name data
12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {
13:         results = new bytes[](data.length);
14:         for (uint256 i = 0; i < data.length; ) {
15:             (bool success, bytes memory result) = address(this).delegatecall(data[i]);
16: 
17:             if (!success) {
18:                 // Bubble up the revert reason
19:                 // The bytes type is ABI encoded as a length-prefixed byte array
20:                 // So we simply need to add 32 to the pointer to get the start of the data
21:                 // And then revert with the size loaded from the first 32 bytes
22:                 // Other solutions will do work to differentiate the revert reasons and provide paranthetical information
23:                 // However, we have chosen to simply replicate the the normal behavior of the call
24:                 // NOTE: memory-safe because it reads from memory already allocated by solidity (the bytes memory result)
25:                 assembly ("memory-safe") {
26:                     revert(add(result, 32), mload(result))
27:                 }
28:             }
29: 
30:             results[i] = result;
31: 
32:             unchecked {
33:                 ++i;
34:             }
35:         }
36:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L12-L36) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit array name ids
130:     function safeBatchTransferFrom(
131:         address from,
132:         address to,
133:         uint256[] calldata ids,
134:         uint256[] calldata amounts,
135:         bytes calldata data
136:     ) public virtual {
137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
138: 
139:         // Storing these outside the loop saves ~15 gas per iteration.
140:         uint256 id;
141:         uint256 amount;
142: 
143:         for (uint256 i = 0; i < ids.length; ) {
144:             id = ids[i];
145:             amount = amounts[i];
146: 
147:             balanceOf[from][id] -= amount;
148: 
149:             // balance will never overflow
150:             unchecked {
151:                 balanceOf[to][id] += amount;
152:             }
153: 
154:             // An array can't have a total length
155:             // larger than the max uint256 value.
156:             unchecked {
157:                 ++i;
158:             }
159:         }
160: 
161:         emit TransferBatch(msg.sender, from, to, ids, amounts);
162: 
163:         if (to.code.length != 0) {
164:             if (
165:                 ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
166:                 ERC1155Holder.onERC1155BatchReceived.selector
167:             ) {
168:                 revert UnsafeRecipient();
169:             }
170:         }
171:     }

//@audit array name amounts
130:     function safeBatchTransferFrom(
131:         address from,
132:         address to,
133:         uint256[] calldata ids,
134:         uint256[] calldata amounts,
135:         bytes calldata data
136:     ) public virtual {
137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
138: 
139:         // Storing these outside the loop saves ~15 gas per iteration.
140:         uint256 id;
141:         uint256 amount;
142: 
143:         for (uint256 i = 0; i < ids.length; ) {
144:             id = ids[i];
145:             amount = amounts[i];
146: 
147:             balanceOf[from][id] -= amount;
148: 
149:             // balance will never overflow
150:             unchecked {
151:                 balanceOf[to][id] += amount;
152:             }
153: 
154:             // An array can't have a total length
155:             // larger than the max uint256 value.
156:             unchecked {
157:                 ++i;
158:             }
159:         }
160: 
161:         emit TransferBatch(msg.sender, from, to, ids, amounts);
162: 
163:         if (to.code.length != 0) {
164:             if (
165:                 ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
166:                 ERC1155Holder.onERC1155BatchReceived.selector
167:             ) {
168:                 revert UnsafeRecipient();
169:             }
170:         }
171:     }

//@audit array name owners
178:     function balanceOfBatch(
179:         address[] calldata owners,
180:         uint256[] calldata ids
181:     ) public view returns (uint256[] memory balances) {
182:         balances = new uint256[](owners.length);
183: 
184:         // Unchecked because the only math done is incrementing
185:         // the array index counter which cannot possibly overflow.
186:         unchecked {
187:             for (uint256 i = 0; i < owners.length; ++i) {
188:                 balances[i] = balanceOf[owners[i]][ids[i]];
189:             }
190:         }
191:     }

//@audit array name ids
178:     function balanceOfBatch(
179:         address[] calldata owners,
180:         uint256[] calldata ids
181:     ) public view returns (uint256[] memory balances) {
182:         balances = new uint256[](owners.length);
183: 
184:         // Unchecked because the only math done is incrementing
185:         // the array index counter which cannot possibly overflow.
186:         unchecked {
187:             for (uint256 i = 0; i < owners.length; ++i) {
188:                 balances[i] = balanceOf[owners[i]][ids[i]];
189:             }
190:         }
191:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L171) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L191)


</details>


### [NC&#x2011;53] A function which defines named returns in it's declaration doesn't need to use return 
Remove the return statement once ensuring it is safe to do so


*There are 25 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

361:     function asset() external view returns (address assetTokenAddress) {
362:         return s_underlyingToken;
363:     }

370:     function totalAssets() public view returns (uint256 totalManagedAssets) {
371:         unchecked {
372:             return s_poolAssets + s_inAMM;
373:         }
374:     }

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {
380:         return Math.mulDiv(assets, totalSupply, totalAssets());
381:     }

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {
387:         return Math.mulDiv(shares, totalAssets(), totalSupply);
388:     }

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {
393:         return type(uint104).max;
394:     }

444:     function maxMint(address) external view returns (uint256 maxShares) {
445:         unchecked {
446:             return (convertToShares(type(uint104).max) * DECIMALS) / (DECIMALS + COMMISSION_FEE);
447:         }
448:     }

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {
508:         // We can only use the standard 4626 withdraw function if the user has no open positions
509:         // For the sake of simplicity assets can only be withdrawn through the redeem function
510:         uint256 available = s_poolAssets;
511:         uint256 balance = convertToAssets(balanceOf[owner]);
512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;
513:     }

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {
519:         uint256 supply = totalSupply; // Saves an extra SLOAD if totalSupply is non-zero.
520: 
521:         return Math.mulDivRoundingUp(assets, supply, totalAssets());
522:     }

531:     function withdraw(
532:         uint256 assets,
533:         address receiver,
534:         address owner
535:     ) external returns (uint256 shares) {
536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();
537: 
538:         shares = previewWithdraw(assets);
539: 
540:         // check/update allowance for approved withdraw
541:         if (msg.sender != owner) {
542:             uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.
543: 
544:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;
545:         }
546: 
547:         // burn collateral shares of the Panoptic Pool funds (this ERC20 token)
548:         _burn(owner, shares);
549: 
550:         // update tracked asset balance
551:         unchecked {
552:             s_poolAssets -= uint128(assets);
553:         }
554: 
555:         // transfer assets (underlying token funds) from the PanopticPool to the LP
556:         SafeTransferLib.safeTransferFrom(
557:             s_underlyingToken,
558:             address(s_panopticPool),
559:             receiver,
560:             assets
561:         );
562: 
563:         emit Withdraw(msg.sender, receiver, owner, assets, shares);
564: 
565:         return shares;
566:     }

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {
573:         uint256 available = convertToShares(s_poolAssets);
574:         uint256 balance = balanceOf[owner];
575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;
576:     }

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {
582:         return convertToAssets(shares);
583:     }

591:     function redeem(
592:         uint256 shares,
593:         address receiver,
594:         address owner
595:     ) external returns (uint256 assets) {
596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();
597: 
598:         // check/update allowance for approved redeem
599:         if (msg.sender != owner) {
600:             uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.
601: 
602:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;
603:         }
604: 
605:         assets = previewRedeem(shares);
606: 
607:         // burn collateral shares of the Panoptic Pool funds (this ERC20 token)
608:         _burn(owner, shares);
609: 
610:         // update tracked asset balance
611:         unchecked {
612:             s_poolAssets -= uint128(assets);
613:         }
614: 
615:         // transfer assets (underlying token funds) from the PanopticPool to the LP
616:         SafeTransferLib.safeTransferFrom(
617:             s_underlyingToken,
618:             address(s_panopticPool),
619:             receiver,
620:             assets
621:         );
622: 
623:         emit Withdraw(msg.sender, receiver, owner, assets, shares);
624: 
625:         return assets;
626:     }

741:     function _poolUtilization() internal view returns (int256 poolUtilization) {
742:         unchecked {
743:             return int256((s_inAMM * DECIMALS) / totalAssets());
744:         }
745:     }

751:     function _sellCollateralRatio(
752:         int256 utilization
753:     ) internal view returns (uint256 sellCollateralRatio) {
754:         // the sell ratio is on a straight line defined between two points (x0,y0) and (x1,y1):
755:         //   (x0,y0) = (targetPoolUtilization,min_sell_ratio) and
756:         //   (x1,y1) = (saturatedPoolUtilization,max_sell_ratio)
757:         // the line's formula: y = a * (x - x0) + y0, where a = (y1 - y0) / (x1 - x0)
758:         /**
759:             SELL
760:             COLLATERAL
761:             RATIO
762:                           ^
763:                           |                  max ratio = 100%
764:                    100% - |                _------
765:                           |             _-B/
766:                           |          _-B/
767:                     20% - |---------B/
768:                           |         .       . .
769:                           +---------+-------+-+--->   POOL_
770:                                    50%    90% 100%     UTILIZATION
771:         */
772: 
773:         uint256 min_sell_ratio = SELLER_COLLATERAL_RATIO;
774:         /// if utilization is less than zero, this is the calculation for a strangle, which gets 2x the capital efficiency at low pool utilization
775:         /// at 0% utilization, strangle legs do not compound efficiency
776:         if (utilization < 0) {
777:             unchecked {
778:                 min_sell_ratio /= 2;
779:                 utilization = -utilization;
780:             }
781:         }
782: 
783:         // return the basal sell ratio if pool utilization is lower than target
784:         if (uint256(utilization) < TARGET_POOL_UTIL) {
785:             return min_sell_ratio;
786:         }
787: 
788:         // return 100% collateral ratio if utilization is above saturated pool utilization
789:         // this means all new positions are fully collateralized, which reduces risks of insolvency at high pool utilization
790:         if (uint256(utilization) > SATURATED_POOL_UTIL) {
791:             return DECIMALS;
792:         }
793: 
794:         unchecked {
795:             return
796:                 min_sell_ratio +
797:                 ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /
798:                 (SATURATED_POOL_UTIL - TARGET_POOL_UTIL);
799:         }
800:     }

806:     function _buyCollateralRatio(
807:         uint256 utilization
808:     ) internal view returns (uint256 buyCollateralRatio) {
809:         // linear from BUY to BUY/2 between 50% and 90%
810:         // the buy ratio is on a straight line defined between two points (x0,y0) and (x1,y1):
811:         //   (x0,y0) = (targetPoolUtilization,buyCollateralRatio) and
812:         //   (x1,y1) = (saturatedPoolUtilization,buyCollateralRatio / 2)
813:         // note that y1<y0 so the slope is negative:
814:         // aka the buy ratio starts high and drops to a lower value with increased utilization; the sell ratio does the opposite (slope is positive)
815:         // the line's formula: y = a * (x - x0) + y0, where a = (y1 - y0) / (x1 - x0)
816:         // but since a<0, we rewrite as:
817:         // y = a' * (x0 - x) + y0, where a' = (y0 - y1) / (x1 - x0)
818: 
819:         // HOWEVER, if the utilization is larger than 10_000, then default to 100% buying power requirement.
820:         // this denotes a situation where the median is too far away from the current price, so we need to require fully collateralized positions for safety
821:         /**
822:           BUY
823:           COLLATERAL
824:           RATIO
825:                  ^
826:                  |   buy_ratio = 10%
827:            10% - |----------__       min_ratio = 5%
828:            5%  - | . . . . .  B/B/B/--______
829:                  |         .       . .
830:                  +---------+-------+-+--->   POOL_
831:                           50%    90% 100%      UTILIZATION
832:          */
833: 
834:         // return the basal buy ratio if pool utilization is lower than target
835:         if (utilization < TARGET_POOL_UTIL) {
836:             return BUYER_COLLATERAL_RATIO;
837:         }
838: 
839:         // return the basal ratio divided by 2 if pool utilization is above saturated pool utilization
840:         /// this is incentivized buying, which returns funds to the panoptic pool
841:         if (utilization > SATURATED_POOL_UTIL) {
842:             unchecked {
843:                 return BUYER_COLLATERAL_RATIO / 2;
844:             }
845:         }
846: 
847:         unchecked {
848:             return
849:                 (BUYER_COLLATERAL_RATIO +
850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2
852:         }
853:     }

1159:     function _getAccountMargin(
1160:         address user,
1161:         int24 atTick,
1162:         uint256[2][] memory positionBalanceArray,
1163:         int128 premiumAllPositions
1164:     ) internal view returns (LeftRightUnsigned tokenData) {
1165:         uint256 tokenRequired;
1166: 
1167:         // if the account has active options, compute the required collateral to keep account in good health
1168:         if (positionBalanceArray.length > 0) {
1169:             // get all collateral required for the incoming list of positions
1170:             tokenRequired = _getTotalRequiredCollateral(atTick, positionBalanceArray);
1171: 
1172:             // If premium is negative (ie. user has to pay for their purchased options), add this long premium to the token requirement
1173:             if (premiumAllPositions < 0) {
1174:                 unchecked {
1175:                     tokenRequired += uint128(-premiumAllPositions);
1176:                 }
1177:             }
1178:         }
1179: 
1180:         // if premium is positive (ie. user will receive funds due to selling options), add this premum to the user's balance
1181:         uint256 netBalance = convertToAssets(balanceOf[user]);
1182:         if (premiumAllPositions > 0) {
1183:             unchecked {
1184:                 netBalance += uint256(uint128(premiumAllPositions));
1185:             }
1186:         }
1187: 
1188:         // store assetBalance and tokens required in tokenData variable
1189:         tokenData = tokenData.toRightSlot(netBalance.toUint128()).toLeftSlot(
1190:             tokenRequired.toUint128()
1191:         );
1192:         return tokenData;
1193:     }

1200:     function _getTotalRequiredCollateral(
1201:         int24 atTick,
1202:         uint256[2][] memory positionBalanceArray
1203:     ) internal view returns (uint256 tokenRequired) {
1204:         // loop through each active position.
1205:         // Offset determined whether to consider the last tokenId from the list
1206:         // (a potentially newly minted position)
1207:         uint256 totalIterations = positionBalanceArray.length;
1208:         for (uint256 i = 0; i < totalIterations; ) {
1209:             // read the ith tokenId from the account
1210:             TokenId tokenId = TokenId.wrap(positionBalanceArray[i][0]);
1211: 
1212:             // read the position size and the pool utilization at mint
1213:             uint128 positionSize = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).rightSlot();
1214: 
1215:             // read the pool utilization at mint
1216:             uint128 poolUtilization = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).leftSlot();
1217: 
1218:             // Get tokens required for the current tokenId (a single active position)
1219:             uint256 _tokenRequired = _getRequiredCollateralAtTickSinglePosition(
1220:                 tokenId,
1221:                 positionSize,
1222:                 atTick,
1223:                 poolUtilization
1224:             );
1225: 
1226:             // add to the tokenRequired accumulator
1227:             unchecked {
1228:                 tokenRequired += _tokenRequired;
1229:             }
1230:             unchecked {
1231:                 ++i;
1232:             }
1233:         }
1234: 
1235:         return tokenRequired;
1236:     }

1278:     function _getRequiredCollateralSingleLeg(
1279:         TokenId tokenId,
1280:         uint256 index,
1281:         uint128 positionSize,
1282:         int24 atTick,
1283:         uint128 poolUtilization
1284:     ) internal view returns (uint256 required) {
1285:         return
1286:             tokenId.riskPartner(index) == index // does this leg have a risk partner? Affects required collateral
1287:                 ? _getRequiredCollateralSingleLegNoPartner(
1288:                     tokenId,
1289:                     index,
1290:                     positionSize,
1291:                     atTick,
1292:                     poolUtilization
1293:                 )
1294:                 : _getRequiredCollateralSingleLegPartner(
1295:                     tokenId,
1296:                     index,
1297:                     positionSize,
1298:                     atTick,
1299:                     poolUtilization
1300:                 );
1301:     }

1600:     function _computeStrangle(
1601:         TokenId tokenId,
1602:         uint256 index,
1603:         uint128 positionSize,
1604:         int24 atTick,
1605:         uint128 poolUtilization
1606:     ) internal view returns (uint256 strangleRequired) {
1607:         // If both tokenTypes are the same, then this is a long or short strangle.
1608:         // A strangle is an options strategy in which the investor holds a position
1609:         // in both a call and a put option with different strike prices,
1610:         // but with the same expiration date and underlying asset.
1611: 
1612:         /// collateral requirement is for short strangles depicted:
1613:         /**
1614:                     Put side of a short strangle, BPR = 100% - (100% - SCR/2)*(price/strike)
1615:            BUYING
1616:            POWER
1617:            REQUIREMENT
1618:                          ^                    .
1619:                          |           <- ITM   .  OTM ->
1620:                   100% - |--__                .
1621:                          |    B/B/--__          .
1622:                          |          B/B/--__    .
1623:                  SCR/2 - |                B/B/--______ <------ base collateral is half that of a single-leg
1624:                          +--------------------+--->   current
1625:                          0                  strike     price
1626:          */
1627:         unchecked {
1628:             // A negative pool utilization is used to denote a position which is a strangle
1629:             // at low pool utilization's strangle legs are evaluated at 2x capital efficiency
1630: 
1631:             uint64 poolUtilization0 = uint64(poolUtilization);
1632:             uint64 poolUtilization1 = uint64(poolUtilization >> 64);
1633: 
1634:             // add 1 to handle poolUtilization = 0
1635: 
1636:             poolUtilization =
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);
1639: 
1640:             return
1641:                 strangleRequired = _getRequiredCollateralSingleLegNoPartner(
1642:                     tokenId,
1643:                     index,
1644:                     positionSize,
1645:                     atTick,
1646:                     poolUtilization
1647:                 );
1648:         }
1649:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L361-L363) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L370-L374), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L379-L381), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L386-L388), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L394), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L448), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L507-L513), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L518-L522), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L531-L566), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L572-L576), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L581-L583), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L591-L626), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L741-L745), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L751-L800), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L806-L853), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1159-L1193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1200-L1236), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1278-L1301), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1600-L1649)


```solidity

File: ./contracts/PanopticPool.sol

1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {
1432:         return s_collateralToken0;
1433:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1431-L1433) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

1555:     function getUniswapV3PoolFromId(
1556:         uint64 poolId
1557:     ) external view returns (IUniswapV3Pool UniswapV3Pool) {
1558:         return s_poolContext[poolId].pool;
1559:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1555-L1559) 


```solidity

File: ./contracts/types/LeftRight.sol

194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
195:         unchecked {
196:             int256 left = int256(uint256(x.leftSlot())) + y.leftSlot();
197:             int128 left128 = int128(left);
198: 
199:             if (left128 != left) revert Errors.UnderOverFlow();
200: 
201:             int256 right = int256(uint256(x.rightSlot())) + y.rightSlot();
202:             int128 right128 = int128(right);
203: 
204:             if (right128 != right) revert Errors.UnderOverFlow();
205: 
206:             return z.toRightSlot(right128).toLeftSlot(left128);
207:         }
208:     }

214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
215:         unchecked {
216:             int256 left256 = int256(x.leftSlot()) + y.leftSlot();
217:             int128 left128 = int128(left256);
218: 
219:             int256 right256 = int256(x.rightSlot()) + y.rightSlot();
220:             int128 right128 = int128(right256);
221: 
222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
223: 
224:             return z.toRightSlot(right128).toLeftSlot(left128);
225:         }
226:     }

232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {
233:         unchecked {
234:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();
235:             int128 left128 = int128(left256);
236: 
237:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();
238:             int128 right128 = int128(right256);
239: 
240:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
241: 
242:             return z.toRightSlot(right128).toLeftSlot(left128);
243:         }
244:     }

251:     function subRect(
252:         LeftRightSigned x,
253:         LeftRightSigned y
254:     ) internal pure returns (LeftRightSigned z) {
255:         unchecked {
256:             int256 left256 = int256(x.leftSlot()) - y.leftSlot();
257:             int128 left128 = int128(left256);
258: 
259:             int256 right256 = int256(x.rightSlot()) - y.rightSlot();
260:             int128 right128 = int128(right256);
261: 
262:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();
263: 
264:             return
265:                 z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(
266:                     int128(Math.max(left128, 0))
267:                 );
268:         }
269:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L194-L208) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L214-L226), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L232-L244), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L251-L269)


</details>


### [NC&#x2011;54] [NatSpec] Natspec `@dev` is missing from `contract` 



*There are 207 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

35: /// @notice 2) get any gain in capital that results from buying an option that becomes in-the-money.
36: contract CollateralTracker is ERC20Minimal, Multicall {

44:     /// @notice Emitted when assets are deposited into the Collateral Tracker.
45:     /// @param sender The address of the caller (and depositor)
46:     /// @param owner The address of the recipient of the newly minted shares
47:     /// @param assets The amount of assets deposited by 'sender' in exchange for 'shares'
48:     /// @param shares The amount of shares minted to 'owner'

51:     /// @notice Emitted when assets are withdrawn from the Collateral Tracker.
52:     /// @param sender The address of the caller
53:     /// @param receiver The address of the recipient of the withdrawn assets
54:     /// @param owner The address of the owner of the shares being burned
55:     /// @param assets The amount of assets withdrawn to 'receiver'
56:     /// @param shares The amount of shares burned by 'owner' in exchange for 'assets'

168:     /// @notice Ensure that the associated Panoptic pool is the caller. Revert if not.

178:     constructor(

287:     /// @notice Returns name of token composed of underlying token symbol and pool data.
288:     /// @return name The name of the token.

301:     /// @notice Returns symbol as prefixed symbol of underlying token.
302:     /// @return symbol The symbol of the token.

308:     /// @notice Returns decimals of underlying token (0 if not present)
309:     /// @return decimals The decimals of the token.

359:     /// @notice Get the token contract address of the underlying asset being managed.
360:     /// @return assetTokenAddress The address of the underlying asset.

376:     /// @notice Returns the amount of shares that can be minted for the given amount of assets.
377:     /// @param assets The amount of assets to be deposited.
378:     /// @return shares The amount of shares that can be minted.

383:     /// @notice Returns the amount of assets that can be redeemed for the given amount of shares.
384:     /// @param shares The amount of shares to be redeemed.
385:     /// @return assets The amount of assets that can be redeemed.

390:     /// @notice returns The maximum deposit amount.
391:     /// @return maxAssets The maximum amount of assets that can be deposited.

396:     /// @notice Returns shares received for depositing given amount of assets.
397:     /// @param assets The amount of assets to be deposited.
398:     /// @return shares The amount of shares that can be minted.

442:     /// @notice Returns the maximum shares received for a deposit.
443:     /// @return maxShares The maximum amount of shares that can be minted.

450:     /// @notice Returns the amount of assets that would be deposited to mint a given amount of shares.
451:     /// @param shares The amount of shares to be minted.
452:     /// @return assets The amount of assets that would be deposited.

515:     /// @notice Returns the amount of shares that would be burned to withdraw a given amount of assets.
516:     /// @param assets The amount of assets to be withdrawn.
517:     /// @return shares The amount of shares that would be burned.

568:     /// @notice Returns the maximum amount of shares that can be redeemed for a given user.
569:     /// If the user has any open positions, the max redeemable balance is zero.
570:     /// @param owner The redeeming address.
571:     /// @return maxShares The maximum amount of shares that can be redeemed.

578:     /// @notice returns the amount of assets resulting from a given amount of shares being redeemed
579:     /// @param shares the amount of shares to be redeemed
580:     /// @return assets the amount of assets resulting from the redemption

585:     /// @notice Redeem exact shares for underlying assets
586:     /// We can only use this standard 4626 redeem function if the user has no open positions.
587:     /// @param shares Amount of shares to be redeemed
588:     /// @param receiver User to receive the assets
589:     /// @param owner User to burn the shares from
590:     /// @return assets the amount of assets resulting from the redemption

907:     /// @notice Revoke previously delegated shares. The opposite of 'delegate'.
908:     /// @param delegator The delegator to send shares *to* (because we are revoking - opposite when we delegate).
909:     /// @param delegatee The delegatee to send shares *from* (because we are revoking - opposite when we delegate).
910:     /// @param assets The assets to which the shares revoked correspond.

989:     /// @notice Take commission on option creation/opening (commissions will not be taken on closing).
990:     /// @param optionOwner The user minting the option.
991:     /// @param longAmount The amount of longs.
992:     /// @param shortAmount The amount of shorts.
993:     /// @param swappedAmount The amount of tokens swapped during creation of the option position (non-zero for options minted ITM).
994:     /// @return utilization The utilization of the Panoptic Pool.

1091:     /// @notice Get the amount exchanged to mint an option.
1092:     /// @param longAmount The amount of long options held.
1093:     /// @param shortAmount The amount of short options held.
1094:     /// @param swappedAmount The (potential) amount swapped during any ITM option creations.
1095:     /// @return exchangedAmount The amount of funds to be exchanged for minting an option (includes commission, swapFee, and intrinsic value).

1238:     /// @notice Get the required amount of collateral tokens corresponding to a specific single position 'tokenId' at a price 'tick'.
1239:     /// The required collateral of an account depends on the price ('tick') in the AMM pool: if in the position's favor less collateral needed, etc.
1240:     /// @param tokenId The option position.
1241:     /// @param positionSize The size of the option position.
1242:     /// @param atTick Tick to convert values at. This can be the current tick or the Uniswap pool TWAP tick.
1243:     /// @param poolUtilization The utilization of the Panoptic pool (balance of buying and selling).
1244:     /// @return tokenRequired total required tokens for all legs of the specified tokenId.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L35-L36) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L44-L48), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L51-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L168-L168), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L178), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L287-L288), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L301-L302), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L308-L309), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L359-L360), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L376-L378), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L383-L385), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L390-L391), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L396-L398), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L442-L443), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L450-L452), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L515-L517), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L568-L571), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L578-L580), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L585-L590), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L907-L910), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L989-L994), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1091-L1095), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1238-L1244)


```solidity

File: ./contracts/PanopticFactory.sol

23: /// @title Panoptic Factory which creates and registers Panoptic Pools.
24: /// @author Axicon Labs Limited
25: /// @notice Facilitates deployment of Panoptic pools.
26: contract PanopticFactory is Multicall {

31:     /// @notice Emitted when the ownership of the factory is transferred.
32:     /// @param oldOwner The previous owner of the factory
33:     /// @param newOwner The new owner of the factory

36:     /// @notice Emitted when a Panoptic Pool is created.
37:     /// @param poolAddress Address of the deployed Panoptic pool
38:     /// @param uniswapPool Address of the underlying Uniswap V3 pool
39:     /// @param collateralTracker0 Address of the collateral tracker contract for token0
40:     /// @param collateralTracker1 Address of the collateral tracker contract for token1
41:     /// @param amount0 The amount of token0 deployed at full range
42:     /// @param amount1 The amount of token1 deployed at full range

108:     /// @notice Set immutable variables.
109:     /// @param _WETH9 Address of the Wrapped Ether (or other numeraire token) contract
110:     /// @param _SFPM The canonical `SemiFungiblePositionManager` deployment
111:     /// @param _univ3Factory The canonical Uniswap V3 Factory deployment
112:     /// @param _donorNFT The contract called to issue NFT rewards for deploying pools
113:     /// @param _poolReference The reference implementation of the `PanopticPool` to clone
114:     /// @param _collateralReference The reference implementation of the `CollateralTracker` to clone

132:     /// @notice Initialize state.
133:     /// @param _owner The first owner of `PanopticFactory`

145:     /// @notice Set the owner of the Panoptic Factory.
146:     /// @param newOwner The new owner of the Panoptic Factory

157:     /// @notice Get the address of the owner of this Panoptic Factory.
158:     /// @return The address which owns this Panoptic Factory

328:     /// @notice Seeds Uniswap V3 pool with a full-tick-range liquidity deployment using funds from caller.
329:     /// @param v3Pool The address of the Uniswap V3 pool to deploy liquidity in
330:     /// @param token0 The address of the first token in the Uniswap V3 pool
331:     /// @param token1 The address of the second token in the Uniswap V3 pool
332:     /// @param fee The fee level of the of the underlying Uniswap v3 pool, denominated in hundredths of bips
333:     /// @return The amount of token0 deployed at full range
334:     /// @return The amount of token1 deployed at full range

417:     /// @notice Return the address of the Panoptic Pool associated with 'univ3pool'.
418:     /// @param univ3pool The Uniswap V3 pool address to query
419:     /// @return Address of the Panoptic Pool associated with 'univ3pool'.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L23-L26) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L31-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L36-L42), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L108-L114), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L132-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L145-L146), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L157-L158), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L328-L334), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L417-L419)


```solidity

File: ./contracts/PanopticPool.sol

58:     /// @notice Emitted when premium is settled independent of a mint/burn (e.g. during `settleLongPremium`)
59:     /// @param user Address of the owner of the settled position.
60:     /// @param tokenId TokenId of the settled position.
61:     /// @param settledAmounts LeftRight encoding for the amount of premium settled for token0 (right slot) and token1 (left slot).

278:     /// @notice During construction: sets the address of the panoptic factory smart contract and the SemiFungiblePositionMananger (SFPM).
279:     /// @param _sfpm The address of the SemiFungiblePositionManager (SFPM) contract.

346:     /// @notice Returns the total number of contracts owned by user for a specified position.
347:     /// @param user Address of the account to be checked.
348:     /// @param tokenId TokenId of the option position to be checked.
349:     /// @return balance Number of contracts of tokenId owned by the user.
350:     /// @return poolUtilization0 The utilization of token0 in the Panoptic pool at mint.
351:     /// @return poolUtilization1 The utilization of token1 in the Panoptic pool at mint.

422:     /// @notice Calculate the accumulated premia owed from the option buyer to the option seller.
423:     /// @param user The holder of options.
424:     /// @param positionIdList The list of all option positions held by user.
425:     /// @param computeAllPremia Whether to compute accumulated premia for all legs held by the user (true), or just owed premia for long legs (false).
426:     /// @param includePendingPremium true = include premium that is owed to the user but has not yet settled, false = only include premium that is available to collect.
427:     /// @return portfolioPremium The computed premia of the user's positions, where premia contains the accumulated premia for token0 in the right slot and for token1 in the left slot.
428:     /// @return balances A list of balances and pool utilization for each position, of the form [[tokenId0, balances0], [tokenId1, balances1], ...].

494:     /// @notice Disable slippage checks if tickLimitLow == tickLimitHigh and reverses ticks if given in correct order to enable ITM swaps
495:     /// @param tickLimitLow The lower slippage limit on the tick.
496:     /// @param tickLimitHigh The upper slippage limit on the tick.
497:     /// @return tickLimitLow Adjusted value for the lower tick limit.
498:     /// @return tickLimitHigh Adjusted value for the upper tick limit.

521:     /// @notice Updates the internal median with the last Uniswap observation if the MEDIAN_PERIOD has elapsed.

540:     /// @notice Validates the current options of the user, and mints a new position.
541:     /// @param positionIdList the list of currently held positions by the user, where the newly minted position(token) will be the last element in 'positionIdList'.
542:     /// @param positionSize The size of the position to be minted, expressed in terms of the asset.
543:     /// @param effectiveLiquidityLimitX32 Maximum amount of "spread" defined as totalLiquidity/netLiquidity for a new position.
544:     /// denominated as X32 = (ratioLimit * 2**32). Set to 0 for no limit / only short options.
545:     /// @param tickLimitLow The lower tick slippagelimit.
546:     /// @param tickLimitHigh The upper tick slippagelimit.

607:     /// @notice Validates the current options of the user, and mints a new position.
608:     /// @param positionIdList the list of currently held positions by the user, where the newly minted position(token) will be the last element in 'positionIdList'.
609:     /// @param positionSize The size of the position to be minted, expressed in terms of the asset.
610:     /// @param effectiveLiquidityLimitX32 Maximum amount of "spread" defined as totalLiquidity/netLiquidity for a new position.
611:     /// denominated as X32 = (ratioLimit * 2**32). Set to 0 for no limit / only short options.
612:     /// @param tickLimitLow The lower tick slippagelimit.
613:     /// @param tickLimitHigh The upper tick slippagelimit.

788:     /// @notice Helper to burn option during a liquidation from an account _owner.
789:     /// @param owner the owner of the option position to be liquidated.
790:     /// @param tickLimitLow Price slippage limit when burning an ITM option
791:     /// @param tickLimitHigh Price slippage limit when burning an ITM option
792:     /// @param commitLongSettled Whether to commit the long premium that will be settled to storage
793:     /// @param positionIdList the option position to liquidate.

818:     /// @notice Helper to burn an option position held by '_owner'.
819:     /// @param tokenId the option position to burn.
820:     /// @param owner the owner of the option position to be burned.
821:     /// @param tickLimitLow Price slippage limit when burning an ITM option
822:     /// @param tickLimitHigh Price slippage limit when burning an ITM option
823:     /// @param commitLongSettled Whether to commit the long premium that will be settled to storage
824:     /// @return paidAmounts The amount of tokens paid when closing the option
825:     /// @return premiaByLeg The amount of premia owed to the user for each leg of the position

856:     /// @notice Update the internal tracking of the owner's position data upon burning a position.
857:     /// @param owner The owner of the option position.
858:     /// @param tokenId The option position to burn.

948:     /// @notice Burns and handles the exercise of options.
949:     /// @param commitLongSettled Whether to commit the long premium that will be settled to storage
950:     /// @param tickLimitLow The lower slippage limit on the tick.
951:     /// @param tickLimitHigh The upper slippage limit on the tick.
952:     /// @param tokenId The option position to burn.
953:     /// @param positionSize The size of the option position, expressed in terms of the asset.
954:     /// @param owner The owner of the option position.

1284:     /// @notice check whether an account is solvent at a given `atTick` with a collateral requirement of `buffer`/10_000 multiplied by the requirement of `positionIdList`.
1285:     /// @param account The account to check solvency for.
1286:     /// @param positionIdList The list of positions to check solvency for.
1287:     /// @param currentTick The current tick of the Uniswap pool (needed for fee calculations).
1288:     /// @param atTick The tick to check solvency at.
1289:     /// @param buffer The buffer to apply to the collateral requirement.

1333:     /// @notice Get parameters related to the solvency state of the account associated with the incoming tokenData.
1334:     /// @param tokenData0 Leftright encoded word with balance of token0 in the right slot, and required balance in left slot.
1335:     /// @param tokenData1 Leftright encoded word with balance of token1 in the right slot, and required balance in left slot.
1336:     /// @param sqrtPriceX96 The current sqrt(price) of the AMM.
1337:     /// @return balanceCross The current cross-collateral balance of the option positions.
1338:     /// @return thresholdCross The cross-collateral threshold balance under which the account is insolvent.

1423:     /// @notice Get the address of the AMM pool connected to this Panoptic pool.
1424:     /// @return univ3pool AMM pool corresponding to this Panoptic pool.

1429:     /// @notice Get the collateral token corresponding to token0 of the AMM pool.
1430:     /// @return collateralToken Collateral token corresponding to token0 in the AMM.

1435:     /// @notice Get the collateral token corresponding to token1 of the AMM pool.
1436:     /// @return collateralToken collateral token corresponding to token1 in the AMM.

1441:     /// @notice get the number of positions for an account
1442:     /// @param user the account to get the positions hash of
1443:     /// @return _numberOfPositions number of positions in the account

1448:     /// @notice Compute the TWAP price from the last 600s = 10mins.
1449:     /// @return twapTick The TWAP price in ticks.

1458:     /// @notice Ensure the effective liquidity in a given chunk is above a certain threshold.
1459:     /// @param tokenId The id of the option position.
1460:     /// @param leg The leg of the option position (used to check if long or short).
1461:     /// @param tickLower The lower tick of the chunk.
1462:     /// @param tickUpper The upper tick of the chunk.
1463:     /// @param effectiveLiquidityLimitX32 Maximum amount of "spread" defined as totalLiquidity/netLiquidity for a new position
1464:     /// denominated as X32 = (ratioLimit * 2**32). Set to 0 for no limit / only short options.

1496:     /// @notice Compute the premia collected for a single option position 'tokenId'.
1497:     /// @param tokenId The option position.
1498:     /// @param positionSize The number of contracts (size) of the option position.
1499:     /// @param owner The holder of the tokenId option.
1500:     /// @param computeAllPremia Whether to compute accumulated premia for all legs held by the user (true), or just owed premia for long legs (false).
1501:     /// @param atTick The tick at which the premia is calculated -> use (atTick < type(int24).max) to compute it
1502:     /// up to current block. atTick = type(int24).max will only consider fees as of the last on-chain transaction.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L58-L61) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L278-L279), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L346-L351), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L422-L428), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L494-L498), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L540-L546), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L607-L613), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L788-L793), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L818-L825), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L856-L858), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L948-L954), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1284-L1289), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1333-L1338), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1423-L1424), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1429-L1430), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1435-L1436), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1441-L1443), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1448-L1449), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1458-L1464), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1496-L1502)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

77:     /// @notice Emitted when a UniswapV3Pool is initialized.
78:     /// @param uniswapPool Address of the underlying Uniswap v3 pool
79:     /// @param poolId The SFPM's pool identifier for the pool, including the 16-bit tick spacing and 48-bit pool pattern

115:     struct PoolAddressAndLock {

328:     /// @notice Remove reentrancy lock on pool
329:     /// @param poolId The poolId of the pool to remove the reentrancy lock from

339:     /// @notice Construct the Semi-Fungible Position Manager (SFPM)
340:     /// @param _factory the Uniswap v3 Factory used to retrieve registered Uniswap pools

497:     /// @notice Create a new position `tokenId` containing up to 4 legs.
498:     /// @param tokenId The tokenId of the minted position, which encodes information for up to 4 legs
499:     /// @param positionSize The number of contracts minted, expressed in terms of the asset
500:     /// @param slippageTickLimitLow The lower price slippage limit when minting an ITM position (set to larger than slippageTickLimitHigh for swapping when minting)
501:     /// @param slippageTickLimitHigh The higher slippage limit when minting an ITM position (set to lower than slippageTickLimitLow for swapping when minting)
502:     /// @return collectedByLeg An array of LeftRight encoded words containing the amount of token0 and token1 collected as fees for each leg
503:     /// @return totalSwapped A LeftRight encoded word containing the total amount of token0 and token1 swapped if minting ITM

673:     /// @param tokenId the option position
674:     /// @param positionSize the size of the position to create
675:     /// @param tickLimitLow lower limits on potential slippage
676:     /// @param tickLimitHigh upper limits on potential slippage
677:     /// @param isBurn is equal to false for mints and true for burns
678:     /// @return collectedByLeg An array of LeftRight encoded words containing the amount of token0 and token1 collected as fees for each leg
679:     /// @return totalMoved the total amount of funds swapped in Uniswap as part of building potential ITM positions

731:     /// @notice When a position is minted or burnt in-the-money (ITM) we are *not* 100% token0 or 100% token1: we have a mix of both tokens.
732:     /// @notice The swapping for ITM options is needed because only one of the tokens are "borrowed" by a user to create the position.
733:     /// @notice This is an ITM situation below (price within the range of the chunk):
734:     ///
735:     ///        AMM       strike
736:     ///     liquidity   price tick
737:     ///        ba2           ba
738:     ///        ba       bbabababa<babababa
739:     ///        ba       ba       baliquidity chunk
740:     ///        ba bbababababab4baba2bababababab4babababababa
741:     ///        ba ba       ba           ba
742:     ///        ba ba       :           ba
743:     ///        ba ba       :           ba
744:     ///        ba ba       :           ba
745:     ///        bbab4babababababababa2bababababababababababab4baba: price
746:     ///                  ba
747:     ///             current price
748:     ///             in-the-money: mix of tokens 0 and 1 within the chunk
749:     ///
750:     ///   If we take token0 as an example, we deploy it to the AMM pool and *then* swap to get the right mix of token0 and token1
751:     ///   to be correctly in the money at that strike.
752:     ///   It that position is burnt, then we remove a mix of the two tokens and swap one of them so that the user receives only one.
753:     /// @param univ3pool the uniswap pool in which to swap.
754:     /// @param itmAmounts how much to swap - how much is ITM
755:     /// @return totalSwapped the amount swapped in the AMM

1106:     /// @notice caches/stores the accumulated premia values for the specified postion.
1107:     /// @param positionKey the hashed data which represents the underlying position in the Uniswap pool
1108:     /// @param currentLiquidity the total amount of liquidity in the AMM for the specific position
1109:     /// @param collectedAmounts amount of tokens (token0 and token1) collected from Uniswap

1247:     /// @notice Helper to collect amounts between msg.sender and Uniswap and also to update the Uniswap fees collected to date from the AMM.
1248:     /// @param liquidityChunk the liquidity chunk representing the option position/leg
1249:     /// @param univ3pool the Uniswap pool where the position is deployed
1250:     /// @param currentLiquidity the existing liquidity msg.sender owns in the AMM for this chunk before the SFPM was called
1251:     /// @param positionKey the unique key to identify the liquidity chunk/tokenType pairing in this uniswap pool
1252:     /// @param movedInLeg how much liquidity has been moved between msg.sender and Uniswap before this function call
1253:     /// @param isLong whether the leg in question is long (=1) or short (=0)
1254:     /// @return collectedChunk the incoming amount collected with potentially whatever is collected in this function added to it


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L77-L79) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L115-L115), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L328-L329), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L339-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L497-L503), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L673-L679), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L731-L755), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1106-L1109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1247-L1254)


```solidity

File: ./contracts/libraries/CallbackLib.sol

09: /// @title Library for verifying and decoding Uniswap callbacks.
10: /// @author Axicon Labs Limited
11: /// @notice This library provides functions to verify that a callback came from a canonical Uniswap V3 pool with a claimed set of features.
12: library CallbackLib {

13:     /// @notice Defining characteristics of a Uni V3 pool

20:     /// @notice Data sent by pool in mint/swap callbacks used to validate the pool and send back requisite tokens

26:     /// @notice Verifies that a callback came from the canonical Uniswap pool with a claimed set of features.
27:     /// @param sender The address initiating the callback and claiming to be a Uniswap pool
28:     /// @param factory The address of the canonical Uniswap V3 factory
29:     /// @param features The features `sender` claims to contain (tokens and fee)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L9-L12) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L13-L13), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L20-L20), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L26-L29)


```solidity

File: ./contracts/libraries/Constants.sol

4: /// @title Library of Constants used in Panoptic.
5: /// @author Axicon Labs Limited
6: /// @notice This library provides constants used in Panoptic.
7: library Constants {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L4-L7) 


```solidity

File: ./contracts/libraries/Errors.sol

4: /// @title Custom Errors library.
5: /// @author Axicon Labs Limited
6: /// @notice Contains all custom error messages used in Panoptic.
7: library Errors {

12:     /// @notice CollateralTracker: collateral token has already been initialized

15:     /// @notice CollateralTracker: the amount of shares (or assets) deposited is larger than the maximum permitted

18:     /// @notice PanopticPool: the effective liquidity (X32) is greater than min(`MAX_SPREAD`, `USER_PROVIDED_THRESHOLD`) during a long mint or short burn
19:     /// Effective liquidity measures how much new liquidity is minted relative to how much is already in the pool

22:     /// @notice CollateralTracker: attempted to withdraw/redeem more than available liquidity, owned shares, or open positions would allow for

25:     /// @notice PanopticPool: force exercisee is insolvent - liquidatable accounts are not permitted to open or close positions outside of a liquidation

28:     /// @notice PanopticPool: the provided list of option positions is incorrect or invalid

31:     /// @notice PanopticFactory: irst 20 bytes of provided salt does not match caller address

34:     /// @notice Tick is not between `MIN_TICK` and `MAX_TICK`

37:     /// @notice The result of a notional value conversion is too small (=0) or too large (>2^128-1)

40:     /// @notice Invalid TokenId parameter detected
41:     /// @param parameterType poolId=0, ratio=1, tokenType=2, risk_partner=3 , strike=4, width=5, two identical strike/width/tokenType chunks=6

44:     /// @notice A mint or swap callback was attempted from an address that did not match the canonical Uniswap V3 pool with the claimed features

47:     /// @notice Invalid input in LeftRight library.

50:     /// @notice PanopticPool: one of the legs in a position are force-exercisable (they are all either short or ITM long)

53:     /// @notice PanopticPool: the account is not solvent enough to perform the desired action

56:     /// @notice SFPM: maximum token amounts for a position exceed 128 bits

59:     /// @notice PanopticPool: the leg is not long, so the premium cannot be settled through `settleLongPremium`

62:     /// @notice PanopticPool: there is not enough avaiable liquidity to buy an option

65:     /// @notice PanopticPool: position is still solvent and cannot be liquidated

72:     /// @notice CollateralTracker: the caller for a permissioned function is not the Panoptic Pool

75:     /// @notice Minting and burning in the SFPM must operate on >0 contracts

78:     /// @notice Uniswap pool has already been initialized in the SFPM or created in the factory

81:     /// @notice PanopticPool: Option position already minted

84:     /// @notice CollateralTracker: The user has open/active option positions, so they cannot transfer collateral shares

87:     /// @notice The current tick in the pool falls outside a user-defined open interval slippage range

90:     /// @notice SFPM: function has been called while reentrancy lock is active

93:     /// @notice An oracle price is too far away from another oracle price or the current tick
94:     /// This is a safeguard against price manipulation during option mints, burns, and liquidations

97:     /// @notice PanopticPool: too many positions open (above limit per account)

100:     /// @notice ERC20 or SFPM token transfer did not complete successfully

103:     /// @notice The tick range given by the strike price and width is invalid
104:     /// because the upper and lower ticks are not multiples of `tickSpacing`

107:     /// @notice An operation in a library has failed due to an underflow or overflow

110:     /// @notice The Uniswap Pool has not been created, so it cannot be used in the SFPM or factory


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L4-L7) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L12-L12), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L15-L15), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L18-L19), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L22-L22), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L25-L25), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L28-L28), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L31-L31), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L34-L34), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L37-L37), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L40-L41), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L44-L44), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L47-L47), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L50-L50), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L53-L53), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L56-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L59-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L62-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L65-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L72-L72), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L75-L75), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L78-L78), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L81-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L84-L84), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L87-L87), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L90-L90), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L93-L94), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L97-L97), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L100-L100), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L103-L104), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L107-L107), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L110-L110)


```solidity

File: ./contracts/libraries/FeesCalc.sol

40:     /// @notice Calculate NAV of user's option portfolio at a given tick.
41:     /// @param atTick The tick to calculate the value at
42:     /// @param userBalance The position balance array for the user (left=tokenId, right=positionSize)
43:     /// @param positionIdList A list of all positions the user holds on that pool
44:     /// @return value0 The amount of token0 owned by portfolio
45:     /// @return value1 The amount of token1 owned by portfolio


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L40-L45) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

16: /// @author Axicon Labs Limited
17: library InteractionHelper {

18:     /// @notice Function that performs approvals on behalf of the PanopticPool for CollateralTracker and SemiFungiblePositionManager.
19:     /// @param sfpm The SemiFungiblePositionManager being approved for both token0 and token1
20:     /// @param ct0 The CollateralTracker (token0) being approved for token0
21:     /// @param ct1 The CollateralTracker (token1) being approved for token1
22:     /// @param token0 The token0 (in Uniswap) being approved for
23:     /// @param token1 The token1 (in Uniswap) being approved for

87:     /// @notice Returns symbol as prefixed symbol of underlying token.
88:     /// @param token The address of the underlying token used to compute the symbol
89:     /// @param prefix A constant string appended to the symbol of the underlying token to create the final symbol
90:     /// @return The symbol of the token

104:     /// @notice Returns decimals of underlying token (0 if not present).
105:     /// @param token The address of the underlying token used to compute the decimals
106:     /// @return The decimals of the token


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L16-L17) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L18-L23), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L87-L90), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L104-L106)


```solidity

File: ./contracts/libraries/Math.sol

10: /// @title Core math library.
11: /// @author Axicon Labs Limited
12: /// @notice Contains general math helpers and functions
13: library Math {

21:     /// @notice Compute the min of the incoming int24s `a` and `b`.
22:     /// @param a The first number
23:     /// @param b The second number
24:     /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1

29:     /// @notice Compute the max of the incoming int24s `a` and `b`.
30:     /// @param a The first number
31:     /// @param b The second number
32:     /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4

37:     /// @notice Compute the min of the incoming `a` and `b`.
38:     /// @param a The first number
39:     /// @param b The second number
40:     /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1

45:     /// @notice Compute the min of the incoming `a` and `b`.
46:     /// @param a The first number
47:     /// @param b The second number
48:     /// @return The min of `a` and `b`: min(a, b), e.g.: min(4, 1) = 1

53:     /// @notice Compute the max of the incoming `a` and `b`.
54:     /// @param a The first number
55:     /// @param b The second number
56:     /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4

61:     /// @notice Compute the max of the incoming `a` and `b`.
62:     /// @param a The first number
63:     /// @param b The second number
64:     /// @return The max of `a` and `b`: max(a, b), e.g.: max(4, 1) = 4

87:     /// @notice Returns the index of the most significant nibble of the 160-bit number,
88:     /// where the least significant nibble is at index 0 and the most significant nibble is at index 40.
89:     /// @param x The value for which to compute the most significant nibble
90:     /// @return r The index of the most significant nibble (default: 0)

204:     /// @notice Calculates the amount of token1 received for a given LiquidityChunk.
205:     /// @param liquidityChunk Variable that efficiently packs the liquidity, tickLower, and tickUpper
206:     /// @return The amount of token1

216:     /// @notice Calculates the amount of token0 and token1 received for a given LiquidityChunk at the provided currentTick.
217:     /// @param currentTick The current tick to be evaluated
218:     /// @param liquidityChunk Variable that efficiently packs the liquidity, tickLower, and tickUpper
219:     /// @return amount0 The amount of token0
220:     /// @return amount1 The amount of token1

293:     /// @notice Downcast uint256 to uint128. Revert on overflow or underflow.
294:     /// @param toDowncast The uint256 to be downcasted
295:     /// @return downcastedInt The downcasted uint (uint128 now)

300:     /// @notice Downcast uint256 to uint128, but cap at type(uint128).max on overflow.
301:     /// @return downcastedInt The downcasted uint (uint128 now)

308:     /// @notice Recast uint128 to int128.
309:     /// @param toCast The uint256 to be downcasted
310:     /// @return downcastedInt The downcasted int (int128 now)

315:     /// @notice Cast an int256 to an int128, revert on overflow or underflow.
316:     /// @param toCast the int256 to be downcasted to int128
317:     /// @return downcastedInt the downcasted integer, now of type int128

322:     /// @notice Cast a uint256 to an int256, revert on overflow.
323:     /// @param toCast The value to be downcasted to uint128
324:     /// @return The incoming uint256 but now of type int256

435:     /// @notice Calculates ceil(aCbC7denominator) with full precision. Throws if result overflows a uint256 or denominator == 0.
436:     /// @param a The multiplicand
437:     /// @param b The multiplier
438:     /// @param denominator The divisor
439:     /// @return result The 256-bit result

454:     /// @notice Calculates floor(aCbC72^64) with full precision. Throws if result overflows a uint256.
455:     /// @param a The multiplicand
456:     /// @param b The multiplier
457:     /// @return The 256-bit result

517:     /// @notice Calculates floor(aCbC72^96) with full precision. Throws if result overflows a uint256.
518:     /// @param a The multiplicand
519:     /// @param b The multiplier
520:     /// @return The 256-bit result

580:     /// @notice Calculates ceil(aCbC72^96) with full precision. Throws if result overflows a uint256.
581:     /// @param a The multiplicand
582:     /// @param b The multiplier
583:     /// @return result The 256-bit result

594:     /// @notice Calculates floor(aCbC72^128) with full precision. Throws if result overflows a uint256.
595:     /// @param a The multiplicand
596:     /// @param b The multiplier
597:     /// @return The 256-bit result

657:     /// @notice Calculates ceil(aCbC72^128) with full precision. Throws if result overflows a uint256.
658:     /// @param a The multiplicand
659:     /// @param b The multiplier
660:     /// @return result The 256-bit result

671:     /// @notice Calculates floor(aCbC72^192) with full precision. Throws if result overflows a uint256.
672:     /// @param a The multiplicand
673:     /// @param b The multiplier
674:     /// @return The 256-bit result

734:     /// @notice Calculates ceil(aC7b), returning 0 if b == 0.
735:     /// @param a The numerator
736:     /// @param b The denominator
737:     /// @return result The 256-bit result

748:     /// @notice QuickSort is a sorting algorithm that employs the Divide and Conquer strategy. It selects a pivot element and arranges the given array around
749:     /// this pivot by correctly positioning it within the sorted array.
750:     /// @param arr The elements that must be sorted
751:     /// @param left The starting index
752:     /// @param right The ending index

773:     /// @notice Calls `quickSort` with default starting index of 0 and ending index of the last element in the array.
774:     /// @param data The elements that must be sorted
775:     /// @return The sorted array


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L10-L13) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L21-L24), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L29-L32), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L37-L40), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L45-L48), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L53-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L61-L64), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L87-L90), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L204-L206), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L216-L220), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L293-L295), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L300-L301), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L308-L310), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L315-L317), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L322-L324), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L435-L439), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L454-L457), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L517-L520), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L580-L583), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L594-L597), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L657-L660), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L671-L674), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L734-L737), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L748-L752), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L773-L775)


```solidity

File: ./contracts/libraries/PanopticMath.sol

16: /// @title Compute general math quantities relevant to Panoptic and AMM pool management.
17: /// @author Axicon Labs Limited
18: library PanopticMath {

56:     /// @notice Increments the pool pattern (first 48 bits) of a poolId by 1.
57:     /// @param poolId The 64-bit pool ID
58:     /// @return The provided `poolId` with its pool pattern slot incremented by 1

66:     /// @notice Get the number of leading hex characters in an address.
67:     ///     0x0000bababaab...     0xababababab...
68:     ///          ba2                 ba2
69:     ///          baa                 baa
70:     ///     4 leading hex      0 leading hex
71:     ///    character zeros    character zeros
72:     ///
73:     /// @param addr The address to get the number of leading zero hex characters for
74:     /// @return The number of leading zero hex characters in the address

274:     /// @notice For a given option position (`tokenId`), leg index within that position (`legIndex`), and `positionSize` get the tick range spanned and its
275:     /// liquidity (share ownership) in the Univ3 pool; this is a liquidity chunk.
276:     ///          Liquidity chunk  (defined by tick upper, tick lower, and its size/amount: the liquidity)
277:     ///   liquidity    baa
278:     ///         ba2      baa
279:     ///         baa     baaba<baa
280:     ///         baa  baabaabaaba4baaba4baabaabaa
281:     ///         baa  baa       baa
282:     ///         baa  baa       baa
283:     ///         baabaabaaba4baabaabaabaabaabaabaaba4baabaabaabaaba: price
284:     ///         Uniswap v3 Pool
285:     /// @param tokenId The option position id
286:     /// @param legIndex The leg index of the option position, can be {0,1,2,3}
287:     /// @param positionSize The number of contracts held by this leg
288:     /// @return A LiquidityChunk with `tickLower`, `tickUpper`, and `liquidity`

332:     /// @notice Extract the tick range specified by `strike` and `width` for the given `tickSpacing`, if valid.
333:     /// @param strike The strike price of the option
334:     /// @param width The width of the option
335:     /// @param tickSpacing The tick spacing of the underlying Uniswap v3 pool
336:     /// @return tickLower The lower tick of the liquidity chunk
337:     /// @return tickUpper The upper tick of the liquidity chunk

385:     /// @notice Compute the amount of funds that are underlying this option position. This is useful when exercising a position.
386:     /// @param tokenId The option position id
387:     /// @param positionSize The number of contracts of this option
388:     /// @return longAmounts Left-right packed word where the right contains the total contract size and the left total notional
389:     /// @return shortAmounts Left-right packed word where the right contains the total contract size and the left total notional

412:     /// @notice Adds required collateral and collateral balance from collateralTracker0 and collateralTracker1 and converts to single values in terms of `tokenType`.
413:     /// @param tokenData0 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token0)
414:     /// @param tokenData1 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token1)
415:     /// @param tokenType The type of token (token0 or token1) to express collateralBalance and requiredCollateral in
416:     /// @param sqrtPriceX96 The sqrt price at which to convert between token0/token1
417:     /// @return The total combined balance of token0 and token1 for a user in terms of tokenType
418:     /// @return The combined collateral requirement for a user in terms of tokenType

438:     /// @notice Adds required collateral and collateral balance from collateralTracker0 and collateralTracker1 and converts to single values in terms of `tokenType`.
439:     /// @param tokenData0 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token0)
440:     /// @param tokenData1 LeftRight type container holding the collateralBalance (right slot) and requiredCollateral (left slot) for a user in CollateralTracker0 (expressed in terms of token1)
441:     /// @param tokenType The type of token (token0 or token1) to express collateralBalance and requiredCollateral in
442:     /// @param tick The tick at which to convert between token0/token1
443:     /// @return The total combined balance of token0 and token1 for a user in terms of tokenType
444:     /// @return The combined collateral requirement for a user in terms of tokenType

569:     /// @notice Compute the amount of token0 and token1 moved. Given an option position `tokenId`, leg index `legIndex`, and how many contracts are in the leg `positionSize`.
570:     /// @param tokenId The option position identifier
571:     /// @param positionSize The number of option contracts held in this position (each contract can control multiple tokens)
572:     /// @param legIndex The leg index of the option contract, can be {0,1,2,3}
573:     /// @return A LeftRight encoded variable containing the amount0 and the amount1 value controlled by this option position's leg

601:     /// @notice Compute the amount of funds that are moved to and removed from the Panoptic Pool.
602:     /// @param tokenId The option position identifier
603:     /// @param positionSize The number of positions minted
604:     /// @param legIndex The leg index minted in this position, can be {0,1,2,3}
605:     /// @return longs A LeftRight-packed word containing the total amount of long positions
606:     /// @return shorts A LeftRight-packed word containing the amount of short positions

641:     /// @notice Check that the account is liquidatable, get the split of bonus0 and bonus1 amounts.
642:     /// @param tokenData0 Leftright encoded word with balance of token0 in the right slot, and required balance in left slot
643:     /// @param tokenData1 Leftright encoded word with balance of token1 in the right slot, and required balance in left slot
644:     /// @param sqrtPriceX96Twap The sqrt(price) of the TWAP tick before liquidation used to evaluate solvency
645:     /// @param sqrtPriceX96Final The current sqrt(price) of the AMM after liquidating a user
646:     /// @param netExchanged The net exchanged value of the closed portfolio
647:     /// @param premia Premium across all positions being liquidated present in tokenData
648:     /// @return bonus0 Bonus amount for token0
649:     /// @return bonus1 Bonus amount for token1
650:     /// @return The LeftRight-packed protocol loss for both tokens, i.e., the delta between the user's balance and expended tokens

910:     /// @notice Returns the original delegated value to a user at a certain tick based on the available collateral from the exercised user.
911:     /// @param refunder Address of the user the refund is coming from (the force exercisee)
912:     /// @param refundValues Token values to refund at the given tick(atTick) rightSlot = token0 left = token1
913:     /// @param atTick Tick to convert values at. This can be the current tick or some TWAP/median tick
914:     /// @param collateral0 CollateralTracker for token0
915:     /// @param collateral1 CollateralTracker for token1
916:     /// @return The LeftRight-packed amount of token0/token1 to refund to the user.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L16-L18) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L56-L58), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L66-L74), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L274-L288), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L332-L337), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L385-L389), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L412-L418), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L438-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L569-L573), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L601-L606), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L641-L650), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L910-L916)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

16:     /// @notice Safely transfers ERC20 tokens from one address to another.
17:     /// @param token The address of the ERC20 token
18:     /// @param from The address to transfer tokens from
19:     /// @param to The address to transfer tokens to
20:     /// @param amount The amount of tokens to transfer

48:     /// @notice Safely transfers ERC20 tokens to a specified address.
49:     /// @param token The address of the ERC20 token
50:     /// @param to The address to transfer tokens to
51:     /// @param amount The amount of tokens to transfer


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L16-L20) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L48-L51)


```solidity

File: ./contracts/multicall/Multicall.sol

09:     /// @notice Performs multiple calls on the inheritor in a single transaction, and returns the data from each call.
10:     /// @param data The calldata for each call
11:     /// @return results The data returned by each call


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L9-L11) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

16:     /// @notice Emitted when only a single token is transferred.
17:     /// @param operator The user who initiated the transfer
18:     /// @param from The user who sent the tokens
19:     /// @param to The user who received the tokens
20:     /// @param id The ERC1155 token id
21:     /// @param amount The amount of tokens transferred

30:     /// @notice Emitted when multiple tokens are transferred from one user to another.
31:     /// @param operator The user who initiated the transfer
32:     /// @param from The user who sent the tokens
33:     /// @param to The user who received the tokens
34:     /// @param ids The ERC1155 token ids
35:     /// @param amounts The amounts of tokens transferred

44:     /// @notice Emitted when the approval status of an operator to transfer all tokens on behalf of a user is modified.
45:     /// @param owner The user who approved or disapproved `operator` to transfer their tokens
46:     /// @param operator The user who was approved or disapproved to transfer all tokens on behalf of `owner`
47:     /// @param approved Whether `operator` is approved or disapproved to transfer all tokens on behalf of `owner`

54:     /// @notice Emitted when a user attempts to transfer tokens they do not own nor are approved to transfer.

57:     /// @notice Emitted when an attempt is made to initiate a transfer to a contract recipient that fails to signal support for ERC1155.

78:     /// @notice Approve or revoke approval for `operator` to transfer all tokens on behalf of the caller.
79:     /// @param operator The address to approve or revoke approval for
80:     /// @param approved True to approve, false to revoke approval

197:     /// @notice Signal support for ERC165 and ERC1155.
198:     /// @param interfaceId The interface to check for support
199:     /// @return Whether the interface is supported

210:     /// @notice Internal utility to mint tokens to a user's account.
211:     /// @param to The user to mint tokens to
212:     /// @param id The ERC1155 token id to mint
213:     /// @param amount The amount of tokens to mint

232:     /// @notice Internal utility to burn tokens from a user's account.
233:     /// @param from The user to burn tokens from
234:     /// @param id The ERC1155 token id to mint
235:     /// @param amount The amount of tokens to burn


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L16-L21) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L30-L35), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L44-L47), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L54-L54), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L57-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L78-L80), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L197-L199), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L210-L213), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L232-L235)


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

14:     /// @notice Emitted when tokens are transferred
15:     /// @param from The sender of the tokens
16:     /// @param to The recipient of the tokens
17:     /// @param amount The amount of tokens transferred

20:     /// @notice Emitted when a user approves another user to spend tokens on their behalf
21:     /// @param owner The user who approved the spender
22:     /// @param spender The user who was approved to spend tokens
23:     /// @param amount The amount of tokens approved to spend

45:     /// @notice Approves a user to spend tokens on the caller's behalf.
46:     /// @param spender The user to approve
47:     /// @param amount The amount of tokens to approve
48:     /// @return Whether the approval succeeded

57:     /// @notice Transfers tokens from the caller to another user.
58:     /// @param to The user to transfer tokens to
59:     /// @param amount The amount of tokens to transfer
60:     /// @return Whether the transfer succeeded

099:     /// @notice Internal utility to transfer tokens from one user to another.
100:     /// @param from The user to transfer tokens from
101:     /// @param to The user to transfer tokens to
102:     /// @param amount The amount of tokens to transfer

119:     /// @notice Internal utility to mint tokens to a user's account.
120:     /// @param to The user to mint tokens to
121:     /// @param amount The amount of tokens to mint

133:     /// @notice Internal utility to burn tokens from a user's account.
134:     /// @param from The user to burn tokens from
135:     /// @param amount The amount of tokens to burn


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L14-L17) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L20-L23), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L45-L48), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L57-L60), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L99-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L119-L121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L133-L135)


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {

07:     /// @notice Called to issue reward NFT to the deployer of a new `PanopticPool` through `PanopticFactory`.
08:     /// @param deployer The address that deployed `newPoolContract` and donated funds for full-range liquidity
09:     /// @param newPoolContract The address of the `PanopticPool` that was deployed
10:     /// @param token0 Token0 of the Uniswap pool `newPoolContract` was deployed on
11:     /// @param token1 Token1 of the Uniswap pool `newPoolContract` was deployed on
12:     /// @param fee The fee tier, in hundredths of bips, of the Uniswap pool `newPoolContract` was deployed on


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L6-L6) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L7-L12)


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

24:     /// @notice Transfers tokens from the caller to another user.
25:     /// @param to The user to transfer tokens to
26:     /// @param amount The amount of tokens to transfer


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L24-L26) 


```solidity

File: ./contracts/types/LeftRight.sol

14: /// @title Pack two separate data (each of 128bit) into a single 256-bit slot; 256bit-to-128bit packing methods.
15: /// @author Axicon Labs Limited
16: /// @notice Simple data type that divides a 256-bit word into two 128-bit slots.
17: library LeftRightLibrary {

36:     /// @notice Get the "right" slot from a bit pattern.
37:     /// @param self The 256 bit value to extract the right half from
38:     /// @return The right half of `self`

43:     /// @notice Get the "right" slot from a bit pattern.
44:     /// @param self The 256 bit value to extract the right half from
45:     /// @return The right half of `self`

55:     /// @notice Add to the "right" slot in a 256-bit pattern.
56:     /// @param self The 256-bit pattern to be written to
57:     /// @param right The value to be added to the right slot
58:     /// @return `self` with `right` added (not overwritten, but added) to the value in its right 128 bits

74:     /// @notice Add to the "right" slot in a 256-bit pattern.
75:     /// @param self The 256-bit pattern to be written to
76:     /// @param right The value to be added to the right slot
77:     /// @return `self` with `right` added (not overwritten, but added) to the value in its right 128 bits

098:     /// @notice Get the "left" slot from a bit pattern.
099:     /// @param self The 256 bit value to extract the left half from
100:     /// @return The left half of `self`

105:     /// @notice Get the "left" slot from a bit pattern.
106:     /// @param self The 256 bit value to extract the left half from
107:     /// @return The left half of `self`

117:     /// @notice Add to the "left" slot in a 256-bit pattern.
118:     /// @param self The 256-bit pattern to be written to
119:     /// @param left The value to be added to the left slot
120:     /// @return `self` with `left` added (not overwritten, but added) to the value in its left 128 bits

130:     /// @notice Add to the "left" slot in a 256-bit pattern.
131:     /// @param self The 256-bit pattern to be written to
132:     /// @param left The value to be added to the left slot
133:     /// @return `self` with `left` added (not overwritten, but added) to the value in its left 128 bits

144:     /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
145:     /// @param x The augend
146:     /// @param y The addend
147:     /// @return z The sum `x + y`

167:     /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
168:     /// @param x The minuend
169:     /// @param y The subtrahend
170:     /// @return z The difference `x - y`

190:     /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
191:     /// @param x The augend
192:     /// @param y The addend
193:     /// @return z The sum `x + y`

210:     /// @notice Add two LeftRight-encoded words; revert on overflow or underflow.
211:     /// @param x The augend
212:     /// @param y The addend
213:     /// @return z The sum `x + y`

228:     /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
229:     /// @param x The minuend
230:     /// @param y The subtrahend
231:     /// @return z The difference `x - y`

246:     /// @notice Subtract two LeftRight-encoded words; revert on overflow or underflow.
247:     /// @notice FOr each slot, rectify difference `x - y` to 0 if negative.
248:     /// @param x The minuend
249:     /// @param y The subtrahend
250:     /// @return z The difference `x - y`


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L14-L17) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L36-L38), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L43-L45), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L55-L58), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L74-L77), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L98-L100), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L105-L107), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L117-L120), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L130-L133), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L144-L147), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L167-L170), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L190-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L210-L213), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L228-L231), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L246-L250)


```solidity

File: ./contracts/types/LiquidityChunk.sol

30: /// @notice Track Tick Range Information. Lower and Upper ticks including the liquidity deployed within that range.
31: /// @notice This is used to track information about a leg in the Option Position identified by `TokenId.sol`.
32: /// @notice We pack this tick range info into a uint256.
33: //

65:     /// @notice Create a new `LiquidityChunk` given by its bounding ticks and its liquidity.
66:     /// @param _tickLower The lower tick of the chunk
67:     /// @param _tickUpper The upper tick of the chunk
68:     /// @param amount The amount of liquidity to add to the chunk
69:     /// @return The new chunk with the given liquidity and tick range

85:     /// @notice Add liquidity to `self`.
86:     /// @param self The LiquidityChunk to add liquidity to
87:     /// @param amount The amount of liquidity to add to `self`
88:     /// @return `self` with added liquidity `amount`

098:     /// @notice Add the lower tick to `self`.
099:     /// @param self The LiquidityChunk to add the lower tick to
100:     /// @param _tickLower The lower tick to add to `self`
101:     /// @return `self` with added lower tick `_tickLower`

114:     /// @notice Add the upper tick to `self`.
115:     /// @param self The LiquidityChunk to add the upper tick to
116:     /// @param _tickUpper The upper tick to add to `self`
117:     /// @return `self` with added upper tick `_tickUpper`

131:     /// @notice Overwrites the lower tick on `self`.
132:     /// @param self The LiquidityChunk to overwrite the lower tick on
133:     /// @param _tickLower The lower tick to overwrite `self` with
134:     /// @return `self` with `_tickLower` as the new lower tick

147:     /// @notice Overwrites the upper tick on `self`.
148:     /// @param self The LiquidityChunk to overwrite the upper tick on
149:     /// @param _tickUpper The upper tick to overwrite `self` with
150:     /// @return `self` with `_tickUpper` as the new upper tick

168:     /// @notice Get the lower tick of `self`.
169:     /// @param self The LiquidityChunk to get the lower tick from
170:     /// @return The lower tick of `self`

177:     /// @notice Get the upper tick of `self`.
178:     /// @param self The LiquidityChunk to get the upper tick from
179:     /// @return The upper tick of `self`

186:     /// @notice Get the amount of liquidity/size of `self`.
187:     /// @param self The LiquidityChunk to get the liquidity from
188:     /// @return The liquidity of `self`


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L30-L33) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L65-L69), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L85-L88), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L98-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L114-L117), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L131-L134), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L147-L150), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L168-L170), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L177-L179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L186-L188)


```solidity

File: ./contracts/types/TokenId.sol

12: /// @title Panoptic's tokenId: the fundamental options position.
13: /// @author Axicon Labs Limited
14: /// @notice This is the token ID used in the ERC1155 representation of the option position in the SFPM.
15: /// @notice The SFPM "overloads" the ERC1155 `id` by storing all option information in said `id`.
16: /// @notice Contains methods for packing and unpacking a Panoptic options position into a uint256 bit pattern.
17: // PACKING RULES FOR A TOKENID:

84:     /// @notice The full poolId (Uniswap pool identifier + pool pattern) of this option position.
85:     /// @param self The TokenId to extract `poolId` from
86:     /// @return The `poolId` (Panoptic's pool fingerprint, contains the whole 64 bit sequence with the tickSpacing) of the Uniswap V3 pool

93:     /// @notice The tickSpacing of this option position.
94:     /// @param self The TokenId to extract `tickSpacing` from
95:     /// @return The `tickSpacing` of the Uniswap v3 pool

114:     /// @notice Get the number of contracts multiplier for leg `legIndex`.
115:     /// @param self The TokenId to extract `optionRatio` at `legIndex` from
116:     /// @param legIndex The leg index of this position (in {0,1,2,3})
117:     /// @return The number of contracts multiplier for leg `legIndex`

124:     /// @notice Return 1 if the nth leg (leg index `legIndex`) is a long position.
125:     /// @param self The TokenId to extract `isLong` at `legIndex` from
126:     /// @param legIndex The leg index of this position (in {0,1,2,3})
127:     /// @return 1 if long; 0 if not long

134:     /// @notice Get the type of token moved for a given leg (implies a call or put). Either Token0 or Token1.
135:     /// @param self The TokenId to extract `tokenType` at `legIndex` from
136:     /// @param legIndex The leg index of this position (in {0,1,2,3})
137:     /// @return 1 if the token moved is token1 or 0 if the token moved is token0

144:     /// @notice Get the associated risk partner of the leg index (generally another leg index in the position if enabled or the same leg index if no partner).
145:     /// @param self The TokenId to extract `riskPartner` at `legIndex` from
146:     /// @param legIndex The leg index of this position (in {0,1,2,3})
147:     /// @return The leg index of `legIndex`'s risk partner

154:     /// @notice Get the strike price tick of the nth leg (with index `legIndex`).
155:     /// @param self The TokenId to extract `strike` at `legIndex` from
156:     /// @param legIndex the leg index of this position (in {0,1,2,3})
157:     /// @return The strike price (the underlying price of the leg)

179:     /// @notice Add the Uniswap V3 Pool pointed to by this option position (contains the entropy and tickSpacing).
180:     /// @param self The TokenId to add `_poolId` to
181:     /// @param _poolId The PoolID to add to `self`
182:     /// @return `self` with `_poolId` added to the PoolID slot

189:     /// @notice Add the `tickSpacing` to the PoolID for `self`.
190:     /// @param self The TokenId to add `_tickSpacing` to
191:     /// @param _tickSpacing The tickSpacing to add to `self`
192:     /// @return `self` with `_tickSpacing` added to the TickSpacing slot in the PoolID.

216:     /// @notice Add the number of contracts multiplier to leg index `legIndex`.
217:     /// @param self The TokenId to add `_optionRatio` to
218:     /// @param _optionRatio The number of contracts multiplier to add to the OptionRatio slot in `self` for LegIndex
219:     /// @param legIndex The leg index of the position (in {0,1,2,3})
220:     /// @return `self` with `_optionRatio` added to the OptionRatio slot for `legIndex`

234:     /// @notice Add "isLong" parameter indicating whether a leg is long (isLong=1) or short (isLong=0).
235:     /// @notice returns 1 if the nth leg (leg index n-1) is a long position.
236:     /// @param self The TokenId to add `_isLong` to
237:     /// @param _isLong The isLong parameter to add to the IsLong slot in `self` for `legIndex`
238:     /// @param legIndex the leg index of this position (in {0,1,2,3})
239:     /// @return `self` with `_isLong` added to the IsLong slot for `legIndex`

250:     /// @notice Add the type of token moved for a given leg (implies a call or put). Either Token0 or Token1.
251:     /// @param self The TokenId to add `_tokenType` to
252:     /// @param _tokenType The tokenType to add to the TokenType slot in `self` for `legIndex`
253:     /// @param legIndex the leg index of this position (in {0,1,2,3})
254:     /// @return `self` with `_tokenType` added to the TokenType slot for `legIndex`

268:     /// @notice Add the associated risk partner of the leg index (generally another leg in the overall position).
269:     /// @param self The TokenId to add `_riskPartner` to
270:     /// @param _riskPartner The riskPartner to add to the RiskPartner slot in `self` for `legIndex`
271:     /// @param legIndex the leg index of this position (in {0,1,2,3})
272:     /// @return `self` with `_riskPartner` added to the RiskPartner slot for `legIndex`

286:     /// @notice Add the strike price tick of the nth leg (index `legIndex`).
287:     /// @param self The TokenId to add `_strike` to
288:     /// @param _strike The strike price tick to add to the Strike slot in `self` for `legIndex`
289:     /// @param legIndex the leg index of this position (in {0,1,2,3})
290:     /// @return `self` with `_strike` added to the Strike slot for `legIndex`

305:     /// @notice Add the width of the nth leg (index `legIndex`).
306:     /// @param self The TokenId to add `_width` to
307:     /// @param _width The width to add to the Width slot in `self` for `legIndex`
308:     /// @param legIndex the leg index of this position (in {0,1,2,3})
309:     /// @return `self` with `_width` added to the Width slot for `legIndex`

325:     /// @notice Add a leg to a TokenId.
326:     /// @param self The tokenId in the SFPM representing an option position.
327:     /// @param legIndex The leg index of this position (in {0,1,2,3}) to add
328:     /// @param _optionRatio The relative size of the leg
329:     /// @param _asset The asset of the leg
330:     /// @param _isLong Whether the leg is long
331:     /// @param _tokenType The type of token moved for the leg
332:     /// @param _riskPartner The associated risk partner of the leg
333:     /// @param _strike The strike price tick of the leg
334:     /// @param _width The width of the leg
335:     /// @return tokenId The tokenId with the leg added

400:     /// @notice Get the number of longs in this option position.
401:     /// @notice Count the number of legs (out of a maximum of 4) that are long positions.
402:     /// @param self The TokenId to count longs for
403:     /// @return The number of long positions in `self` (in the range {0,...,4}).

461:     /// @param self The TokenId to clear the leg from
462:     /// @param i The leg index to reset, in {0,1,2,3}
463:     /// @return `self` with the `i`th leg zeroed including optionRatio and asset


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L12-L17) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L84-L86), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L93-L95), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L114-L117), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L124-L127), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L134-L137), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L144-L147), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L154-L157), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L179-L182), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L189-L192), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L216-L220), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L234-L239), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L250-L254), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L268-L272), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L286-L290), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L305-L309), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L325-L335), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L400-L403), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L461-L463)


</details>


### [NC&#x2011;55] Contract should expose an `interface` 
The `contract`s should expose an `interface` so that other projects can more easily integrate with it, without having to develop their own non-standard variants.


*There are 62 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

221:     function startToken(

277:     function getPoolData()

361:     function asset() external view returns (address assetTokenAddress) {

370:     function totalAssets() public view returns (uint256 totalManagedAssets) {

379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {

386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {

392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

399:     function previewDeposit(uint256 assets) public view returns (uint256 shares) {

417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

444:     function maxMint(address) external view returns (uint256 maxShares) {

453:     function previewMint(uint256 shares) public view returns (uint256 assets) {

507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

531:     function withdraw(

572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {

591:     function redeem(

650:     function exerciseCost(

864:     function delegate(

894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

911:     function revoke(

975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

995:     function takeCommissionAddData(

1043:     function exercise(

1141:     function getAccountMarginDetails(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L221-L221) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L277-L277), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L361-L361), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L370-L370), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L379-L379), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L386-L386), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L392), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L399-L399), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L417-L417), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L453-L453), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L518-L518), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L531-L531), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L572-L572), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L581-L581), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L591-L591), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L650-L650), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L864-L864), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L894), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L903-L903), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L911-L911), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L975-L975), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L995-L995), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1043), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1141-L1141)


```solidity

File: ./contracts/PanopticFactory.sol

147:     function transferOwnership(address newOwner) external {

172:     function uniswapV3MintCallback(

210:     function deployNewPool(

290:     function minePoolAddress(

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L147-L147) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L172-L172), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L210-L210), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L290-L290), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L420-L420)


```solidity

File: ./contracts/PanopticPool.sol

291:     function startPool(

338:     function assertPriceWithinBounds(uint160 sqrtLowerBound, uint160 sqrtUpperBound) external view {

352:     function optionPositionBalance(

381:     function calculateAccumulatedFeesBatch(

410:     function calculatePortfolioValue(

522:     function pokeMedian() external {

547:     function mintOptions(

569:     function burnOptions(

586:     function burnOptions(

1017:     function liquidate(

1179:     function forceExercise(

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {

1437:     function collateralToken1() external view returns (CollateralTracker) {

1444:     function numberOfPositions(address user) public view returns (uint256 _numberOfPositions) {

1587:     function settleLongPremium(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L291-L291) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L338-L338), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L352-L352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L381-L381), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L410-L410), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L522-L522), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L569-L569), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L586-L586), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1017-L1017), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1179-L1179), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1425-L1425), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1431-L1431), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1437-L1437), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1444-L1444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1587-L1587)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {

402:     function uniswapV3MintCallback(

435:     function uniswapV3SwapCallback(

471:     function burnTokenizedPosition(

504:     function mintTokenizedPosition(

1421:     function getAccountLiquidity(

1449:     function getAccountPremium(

1535:     function getAccountFeesBase(

1555:     function getUniswapV3PoolFromId(

1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L350-L350) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L402-L402), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L435-L435), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L471-L471), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L504-L504), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1421-L1421), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1449-L1449), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1535-L1535), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1555-L1555), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1566-L1566)


```solidity

File: ./contracts/multicall/Multicall.sol

12:     function multicall(bytes[] calldata data) public payable returns (bytes[] memory results) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L12-L12) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

81:     function setApprovalForAll(address operator, bool approved) public {

94:     function safeTransferFrom(

130:     function safeBatchTransferFrom(

178:     function balanceOfBatch(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L81-L81) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L94-L94), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L130), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L178-L178)


</details>


### [NC&#x2011;56] [NatSpec] Natspec `@notice` is missing from `contract` 



*There are 13 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

178:     constructor(

319:     /// @dev See {IERC20-transfer}.
320:     /// Requirements:
321:     /// - the caller must have a balance of at least 'amount'.
322:     /// - the msg.sender must not have any position on the panoptic pool

336:     /// @dev See {IERC20-transferFrom}.
337:     /// Requirements:
338:     /// - the 'from' must have a balance of at least 'amount'.
339:     /// - the caller must have allowance for 'from' of at least 'amount' tokens.
340:     /// - 'from' must not have any open positions on the panoptic pool.

738:     /// @dev compute: inAMM/totalAssets().
739:     /// @dev 1bps precision controlled by DECIMALS.
740:     /// @return poolUtilization the pool utilization as a fraction.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L178) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L319-L322), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L336-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L738-L740)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

115:     struct PoolAddressAndLock {

673:     /// @param tokenId the option position
674:     /// @param positionSize the size of the position to create
675:     /// @param tickLimitLow lower limits on potential slippage
676:     /// @param tickLimitHigh upper limits on potential slippage
677:     /// @param isBurn is equal to false for mints and true for burns
678:     /// @return collectedByLeg An array of LeftRight encoded words containing the amount of token0 and token1 collected as fees for each leg
679:     /// @return totalMoved the total amount of funds swapped in Uniswap as part of building potential ITM positions


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L115-L115) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L673-L679)


```solidity

File: ./contracts/libraries/InteractionHelper.sol

16: /// @author Axicon Labs Limited
17: library InteractionHelper {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L16-L17) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

16: /// @title Compute general math quantities relevant to Panoptic and AMM pool management.
17: /// @author Axicon Labs Limited
18: library PanopticMath {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L16-L18) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

07: /// @title Minimalist ERC1155 implementation without metadata.
08: /// @author Axicon Labs Limited
09: /// @author Modified from Solmate (https://github.com/transmissions11/solmate/blob/v7/src/tokens/ERC1155.sol)
10: /// @dev Not compliant to the letter, does not include any metadata functionality.
11: abstract contract ERC1155 {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L7-L11) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

4: /// @title Minimal efficient ERC20 implementation without metadata
5: /// @author Axicon Labs Limited
6: /// @author Modified from Solmate (https://github.com/transmissions11/solmate/blob/v7/src/tokens/ERC20.sol)
7: /// @dev The metadata must be set in the inheriting contract.
8: /// @dev Do not manually set balances without updating totalSupply, as the sum of all user balances must not exceed it.
9: abstract contract ERC20Minimal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L4-L9) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

6: interface IDonorNFT {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L6-L6) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

04: /// @title Partial definition of the ERC20 interface as defined in the EIP
05: /// @dev Does not include return values as certain tokens such as USDT fail to implement them.
06: /// @dev Since the return value is not expected, this interface works with both compliant and non-compliant tokens.
07: /// @dev Clients are recommended to consume and handle the return of negative success values.
08: /// @dev However, we cannot productively handle a failed approval and such a situation would surely cause a revert later in execution.
09: /// @dev In addition, no notable instances exist of tokens that both i) contain a failure case for `approve` and ii) return `false` instead of reverting.
10: /// @author Axicon Labs Limited
11: interface IERC20Partial {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L4-L11) 


```solidity

File: ./contracts/types/TokenId.sol

461:     /// @param self The TokenId to clear the leg from
462:     /// @param i The leg index to reset, in {0,1,2,3}
463:     /// @return `self` with the `i`th leg zeroed including optionRatio and asset


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L461-L463) 


</details>


### [NC&#x2011;57] Expressions for constant values should use `immutable` rather than `constant` 
While it does not save gas for some simple binary expressions because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constants` should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.


*There are 6 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

103:     int24 internal constant MIN_SWAP_TICK = Constants.MIN_V3POOL_TICK + 1;

105:     int24 internal constant MAX_SWAP_TICK = Constants.MAX_V3POOL_TICK - 1;

165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L103-L103) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L105-L105), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L165-L165)


```solidity

File: ./contracts/libraries/Math.sol

15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L15-L15) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) 


```solidity

File: ./contracts/types/LeftRight.sol

26:     int256 internal constant LEFT_HALF_BIT_MASK_INT =
27:         int256(uint256(0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L26-L27) 


</details>


### [NC&#x2011;58] Consider splitting long calculations 
The longer a string of operations is, the harder it is to understand it. Consider splitting the full calculation into more steps, with more descriptive temporary variable names, and add extensive comments.


*There are 12 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

201:             TICK_DEVIATION = uint256(
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3
209:             );

730:             exerciseFees = exerciseFees
731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))
732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));

1570:                 spreadRequirement = (notional < notionalP)
1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)
1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L201-L209) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L730-L732), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1570-L1572)


```solidity

File: ./contracts/PanopticPool.sol

1545:                     premiaByLeg[leg] = LeftRightSigned
1546:                         .wrap(0)
1547:                         .toRightSlot(
1548:                             int128(
1549:                                 int256(
1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
1551:                                         premiumAccumulatorLast.rightSlot()) *
1552:                                         (liquidityChunk.liquidity())) / 2 ** 64
1553:                                 )
1554:                             )
1555:                         )
1556:                         .toLeftSlot(
1557:                             int128(
1558:                                 int256(
1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
1560:                                         premiumAccumulatorLast.leftSlot()) *
1561:                                         (liquidityChunk.liquidity())) / 2 ** 64
1562:                                 )
1563:                             )
1564:                         );

1725:                     s_grossPremiumLast[chunkKey] = LeftRightUnsigned
1726:                         .wrap(0)
1727:                         .toRightSlot(
1728:                             uint128(
1729:                                 (grossCurrent[0] *
1730:                                     positionLiquidity +
1731:                                     grossPremiumLast.rightSlot() *
1732:                                     totalLiquidityBefore) / (totalLiquidity)
1733:                             )
1734:                         )
1735:                         .toLeftSlot(
1736:                             uint128(
1737:                                 (grossCurrent[1] *
1738:                                     positionLiquidity +
1739:                                     grossPremiumLast.leftSlot() *
1740:                                     totalLiquidityBefore) / (totalLiquidity)
1741:                             )
1742:                         );

1928:                         s_grossPremiumLast[chunkKey] = totalLiquidity != 0
1929:                             ? LeftRightUnsigned
1930:                                 .wrap(0)
1931:                                 .toRightSlot(
1932:                                     uint128(
1933:                                         uint256(
1934:                                             Math.max(
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),
1943:                                                 0
1944:                                             )
1945:                                         ) / totalLiquidity
1946:                                     )
1947:                                 )
1948:                                 .toLeftSlot(
1949:                                     uint128(
1950:                                         uint256(
1951:                                             Math.max(
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,
1960:                                                 0
1961:                                             )
1962:                                         ) / totalLiquidity
1963:                                     )
1964:                                 )
1965:                             : LeftRightUnsigned
1966:                                 .wrap(0)
1967:                                 .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
1968:                                 .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1545-L1564) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1725-L1742), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1928-L1968)


```solidity

File: ./contracts/libraries/PanopticMath.sol

177:             medianTick =
178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +
179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /
180:                 2;

149:                 ticks[i] =
150:                     (tickCumulatives[i] - tickCumulatives[i + 1]) /
151:                     int256(timestamps[i] - timestamps[i + 1]);

257:                 twapMeasurement[i] = int24(
258:                     (tickCumulatives[i] - tickCumulatives[i + 1]) / int56(uint56(twapWindow / 20))
259:                 );

802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );

826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );

223:                     newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L177-L180) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L149-L151), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L257-L259), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L802-L817), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L826-L841), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L223-L223)


</details>


### [NC&#x2011;59] Contract uses both `require()`/`revert()` as well as custom errors 
Consider using just one method in a single file. The below instances represents the less used technique


*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L297-L297) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L312-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L319-L319), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L326-L326), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L131-L131)


</details>


### [NC&#x2011;60] `private`/`public` function name should start with underscore 
According to solidity style guide, Private or Public function name should start with underscore.


*There are 104 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

//@audit `getUniV3TWAP` is not in CamelCase
1450:     function getUniV3TWAP() internal view returns (int24 twapTick) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1450-L1450) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `beginReentrancyLock` is not in CamelCase
320:     function beginReentrancyLock(uint64 poolId) internal {

//@audit `endReentrancyLock` is not in CamelCase
330:     function endReentrancyLock(uint64 poolId) internal {

//@audit `registerTokenTransfer` is not in CamelCase
593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

//@audit `swapInAMM` is not in CamelCase
756:     function swapInAMM(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L320-L320) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L330-L330), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L593-L593), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L756-L756)


```solidity

File: ./contracts/libraries/CallbackLib.sol

//@audit `validateCallback` is not in CamelCase
30:     function validateCallback(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L30-L30) 


```solidity

File: ./contracts/libraries/Math.sol

//@audit `min24` is not in CamelCase
25:     function min24(int24 a, int24 b) internal pure returns (int24) {

//@audit `max24` is not in CamelCase
33:     function max24(int24 a, int24 b) internal pure returns (int24) {

//@audit `min` is not in CamelCase
41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `min` is not in CamelCase
49:     function min(int256 a, int256 b) internal pure returns (int256) {

//@audit `max` is not in CamelCase
57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `max` is not in CamelCase
65:     function max(int256 a, int256 b) internal pure returns (int256) {

//@audit `abs` is not in CamelCase
73:     function abs(int256 x) internal pure returns (int256) {

//@audit `absUint` is not in CamelCase
81:     function absUint(int256 x) internal pure returns (uint256) {

//@audit `mostSignificantNibble` is not in CamelCase
91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

//@audit `getSqrtRatioAtTick` is not in CamelCase
128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

//@audit `getAmount0ForLiquidity` is not in CamelCase
191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

//@audit `getAmount1ForLiquidity` is not in CamelCase
207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

//@audit `getAmountsForLiquidity` is not in CamelCase
221:     function getAmountsForLiquidity(

//@audit `getLiquidityForAmount0` is not in CamelCase
241:     function getLiquidityForAmount0(

//@audit `getLiquidityForAmount1` is not in CamelCase
271:     function getLiquidityForAmount1(

//@audit `toUint128` is not in CamelCase
296:     function toUint128(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

//@audit `toUint128Capped` is not in CamelCase
302:     function toUint128Capped(uint256 toDowncast) internal pure returns (uint128 downcastedInt) {

//@audit `toInt128` is not in CamelCase
311:     function toInt128(uint128 toCast) internal pure returns (int128 downcastedInt) {

//@audit `toInt128` is not in CamelCase
318:     function toInt128(int256 toCast) internal pure returns (int128 downcastedInt) {

//@audit `toInt256` is not in CamelCase
325:     function toInt256(uint256 toCast) internal pure returns (int256) {

//@audit `mulDiv` is not in CamelCase
340:     function mulDiv(

//@audit `mulDivRoundingUp` is not in CamelCase
440:     function mulDivRoundingUp(

//@audit `mulDiv64` is not in CamelCase
458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `mulDiv96` is not in CamelCase
521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `mulDiv96RoundingUp` is not in CamelCase
584:     function mulDiv96RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

//@audit `mulDiv128` is not in CamelCase
598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `mulDiv128RoundingUp` is not in CamelCase
661:     function mulDiv128RoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

//@audit `mulDiv192` is not in CamelCase
675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

//@audit `unsafeDivRoundingUp` is not in CamelCase
738:     function unsafeDivRoundingUp(uint256 a, uint256 b) internal pure returns (uint256 result) {

//@audit `quickSort` is not in CamelCase
753:     function quickSort(int256[] memory arr, int256 left, int256 right) internal pure {

//@audit `sort` is not in CamelCase
776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L25-L25) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L41-L41), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L49-L49), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L57-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L65-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L73-L73), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L81-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L91-L91), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L191-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L207-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L221-L221), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L241-L241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L271-L271), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L296-L296), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L302-L302), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L311-L311), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L318-L318), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L325-L325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L340-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L440-L440), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L458-L458), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L584-L584), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L598-L598), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L661-L661), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L675-L675), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L738-L738), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L753-L753), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L776-L776)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit `getPoolId` is not in CamelCase
47:     function getPoolId(address univ3pool) internal view returns (uint64) {

//@audit `incrementPoolPattern` is not in CamelCase
59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

//@audit `updatePositionsHash` is not in CamelCase
92:     function updatePositionsHash(

//@audit `getLiquidityChunk` is not in CamelCase
289:     function getLiquidityChunk(

//@audit `getTicks` is not in CamelCase
338:     function getTicks(

//@audit `getRangesFromStrike` is not in CamelCase
371:     function getRangesFromStrike(

//@audit `computeExercisedAmounts` is not in CamelCase
390:     function computeExercisedAmounts(

//@audit `convertCollateralData` is not in CamelCase
419:     function convertCollateralData(

//@audit `convertCollateralData` is not in CamelCase
445:     function convertCollateralData(

//@audit `convertNotional` is not in CamelCase
468:     function convertNotional(

//@audit `convert0to1` is not in CamelCase
490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

//@audit `convert1to0` is not in CamelCase
507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

//@audit `convert0to1` is not in CamelCase
524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

//@audit `convert1to0` is not in CamelCase
547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

//@audit `getAmountsMoved` is not in CamelCase
574:     function getAmountsMoved(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L47-L47) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L59-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L92-L92), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L289-L289), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L338-L338), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L371-L371), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L390-L390), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L419-L419), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L445-L445), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L468-L468), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L490-L490), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L524-L524), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L574-L574)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

//@audit `safeTransferFrom` is not in CamelCase
21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

//@audit `safeTransfer` is not in CamelCase
52:     function safeTransfer(address token, address to, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L21-L21) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L52-L52)


```solidity

File: ./contracts/types/LeftRight.sol

//@audit `rightSlot` is not in CamelCase
39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

//@audit `rightSlot` is not in CamelCase
46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

//@audit `toRightSlot` is not in CamelCase
59:     function toRightSlot(

//@audit `toRightSlot` is not in CamelCase
78:     function toRightSlot(

//@audit `leftSlot` is not in CamelCase
101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

//@audit `leftSlot` is not in CamelCase
108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

//@audit `toLeftSlot` is not in CamelCase
121:     function toLeftSlot(

//@audit `toLeftSlot` is not in CamelCase
134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

//@audit `add` is not in CamelCase
148:     function add(

//@audit `sub` is not in CamelCase
171:     function sub(

//@audit `add` is not in CamelCase
194:     function add(LeftRightUnsigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

//@audit `add` is not in CamelCase
214:     function add(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

//@audit `sub` is not in CamelCase
232:     function sub(LeftRightSigned x, LeftRightSigned y) internal pure returns (LeftRightSigned z) {

//@audit `subRect` is not in CamelCase
251:     function subRect(

//@audit `addCapped` is not in CamelCase
279:     function addCapped(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L39-L39) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L46-L46), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L59-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L78-L78), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L101-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L121-L121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L134-L134), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L148-L148), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L194-L194), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L214-L214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L232-L232), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L251-L251), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L279-L279)


```solidity

File: ./contracts/types/LiquidityChunk.sol

//@audit `createChunk` is not in CamelCase
70:     function createChunk(

//@audit `addLiquidity` is not in CamelCase
89:     function addLiquidity(

//@audit `addTickLower` is not in CamelCase
102:     function addTickLower(

//@audit `addTickUpper` is not in CamelCase
118:     function addTickUpper(

//@audit `updateTickLower` is not in CamelCase
135:     function updateTickLower(

//@audit `updateTickUpper` is not in CamelCase
151:     function updateTickUpper(

//@audit `tickLower` is not in CamelCase
171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

//@audit `tickUpper` is not in CamelCase
180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

//@audit `liquidity` is not in CamelCase
189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L70-L70) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L89-L89), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L102-L102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L118-L118), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L135-L135), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L151-L151), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L180-L180), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L189-L189)


```solidity

File: ./contracts/types/TokenId.sol

//@audit `poolId` is not in CamelCase
87:     function poolId(TokenId self) internal pure returns (uint64) {

//@audit `tickSpacing` is not in CamelCase
96:     function tickSpacing(TokenId self) internal pure returns (int24) {

//@audit `asset` is not in CamelCase
108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

//@audit `optionRatio` is not in CamelCase
118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

//@audit `isLong` is not in CamelCase
128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

//@audit `tokenType` is not in CamelCase
138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

//@audit `riskPartner` is not in CamelCase
148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

//@audit `strike` is not in CamelCase
158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

//@audit `width` is not in CamelCase
169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

//@audit `addPoolId` is not in CamelCase
183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

//@audit `addTickSpacing` is not in CamelCase
193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

//@audit `addAsset` is not in CamelCase
205:     function addAsset(

//@audit `addOptionRatio` is not in CamelCase
221:     function addOptionRatio(

//@audit `addIsLong` is not in CamelCase
240:     function addIsLong(

//@audit `addTokenType` is not in CamelCase
255:     function addTokenType(

//@audit `addRiskPartner` is not in CamelCase
273:     function addRiskPartner(

//@audit `addStrike` is not in CamelCase
291:     function addStrike(

//@audit `addWidth` is not in CamelCase
310:     function addWidth(

//@audit `addLeg` is not in CamelCase
336:     function addLeg(

//@audit `flipToBurnToken` is not in CamelCase
366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

//@audit `countLongs` is not in CamelCase
404:     function countLongs(TokenId self) internal pure returns (uint256) {

//@audit `asTicks` is not in CamelCase
416:     function asTicks(

//@audit `countLegs` is not in CamelCase
432:     function countLegs(TokenId self) internal pure returns (uint256) {

//@audit `clearLeg` is not in CamelCase
464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {

//@audit `validate` is not in CamelCase
500:     function validate(TokenId self) internal pure {

//@audit `validateIsExercisable` is not in CamelCase
578:     function validateIsExercisable(TokenId self, int24 currentTick) internal pure {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L87-L87) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L96-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L118-L118), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L138-L138), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L148-L148), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L158-L158), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L169-L169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L183-L183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L205-L205), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L221-L221), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L240-L240), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L255-L255), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L273-L273), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L291-L291), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L310-L310), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L336-L336), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L366-L366), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L404-L404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L416-L416), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L432-L432), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L464-L464), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L500-L500), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L578-L578)


</details>


### [NC&#x2011;61] Assembly block creates dirty bits 
Writing data to the free memory pointer without later updating the free memory pointer will cause there to be dirty bits at that memory location. Not updating the free memory pointer will make it [harder](https://docs.soliditylang.org/en/latest/ir-breaking-changes.html#cleanup) for the optimizer to reason about whether the memory needs to be cleaned, which may lead to worse optimizations. Annotate the block with `assembly ("memory-safe") { ... }` if the memory's value can be discarded. If the memory needs to be saved, update the free memory pointer in addtion to using the annotation. See [this](https://docs.soliditylang.org/en/latest/assembly.html#memory-safety) link for other cases where the annotation can be used


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/SafeTransferLib.sol

24:         assembly ("memory-safe") {
25:             // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
26:             let p := mload(0x40)
27: 
28:             // Write the abi-encoded calldata into memory, beginning with the function selector.
29:             mstore(p, 0x23b872dd00000000000000000000000000000000000000000000000000000000)
30:             mstore(add(4, p), from) // Append the "from" argument.
31:             mstore(add(36, p), to) // Append the "to" argument.
32:             mstore(add(68, p), amount) // Append the "amount" argument.
33: 
34:             success := and(
35:                 // Set success to whether the call reverted, if not we check it either
36:                 // returned exactly 1 (can't just be non-zero data), or had no return data.
37:                 or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
38:                 // We use 100 because that's the total length of our calldata (4 + 32 * 3)
39:                 // Counterintuitively, this call() must be positioned after the or() in the
40:                 // surrounding and() because and() evaluates its arguments from right to left.
41:                 call(gas(), token, 0, p, 100, 0, 32)
42:             )
43:         }

55:         assembly ("memory-safe") {
56:             // Get free memory pointer - we will store our calldata in scratch space starting at the offset specified here.
57:             let p := mload(0x40)
58: 
59:             // Write the abi-encoded calldata into memory, beginning with the function selector.
60:             mstore(p, 0xa9059cbb00000000000000000000000000000000000000000000000000000000)
61:             mstore(add(4, p), to) // Append the "to" argument.
62:             mstore(add(36, p), amount) // Append the "amount" argument.
63: 
64:             success := and(
65:                 // Set success to whether the call reverted, if not we check it either
66:                 // returned exactly 1 (can't just be non-zero data), or had no return data.
67:                 or(and(eq(mload(0), 1), gt(returndatasize(), 31)), iszero(returndatasize())),
68:                 // We use 68 because that's the total length of our calldata (4 + 32 * 2)
69:                 // Counterintuitively, this call() must be positioned after the or() in the
70:                 // surrounding and() because and() evaluates its arguments from right to left.
71:                 call(gas(), token, 0, p, 68, 0, 32)
72:             )
73:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L24-L43) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L55-L73)


</details>


### [NC&#x2011;62] Add inline comments for unnamed parameters 
`function func(address a, address)` -> `function func(address a, address /* b */)`


*There are 2 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit parameter number 0 starting from left need inline comment
392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

//@audit parameter number 0 starting from left need inline comment
444:     function maxMint(address) external view returns (uint256 maxShares) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L392) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L444)


</details>


### [NC&#x2011;63] Use the latest Solidity version for better security 
Using the latest solidity version will help avoid old compiler related vulnerabilities


*There are 20 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L2-L2) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L2-L2) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L2-L2) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L2-L2) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L2-L2) 


```solidity

File: ./contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L2-L2) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L2-L2) 


```solidity

File: ./contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L2-L2) 


</details>


### [NC&#x2011;64] Consider adding formal verification proofs 
Consider using formal verification to mathematically prove that your code does what is intended, and does not have any edge cases with unexpected behavior. The solidity compiler itself has this functionality [built in](https://docs.soliditylang.org/en/latest/smtchecker.html#smtchecker-and-formal-verification)


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

@audit Should implement invariant tests
1: 


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1-L1) 


</details>


### [NC&#x2011;65] Missing zero address check in functions with address parameters 
Adding a zero address check for each address type parameter can prevent errors.


*There are 11 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit token0, token1,  are not checked
221:     function startToken(
222:         bool underlyingIsToken0,
223:         address token0,
224:         address token1,
225:         uint24 fee,
226:         PanopticPool panopticPool
227:     ) external {

//@audit delegatee,  are not checked
894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

//@audit delegatee,  are not checked
903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L221-L227) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L894), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L903-L903)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit _WETH9, _poolReference, _collateralReference,  are not checked
115:     constructor(
116:         address _WETH9,
117:         SemiFungiblePositionManager _SFPM,
118:         IUniswapV3Factory _univ3Factory,
119:         IDonorNFT _donorNFT,
120:         address _poolReference,
121:         address _collateralReference
122:     ) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L115-L122) 


```solidity

File: ./contracts/PanopticPool.sol

//@audit user,  are not checked
352:     function optionPositionBalance(
353:         address user,
354:         TokenId tokenId
355:     ) external view returns (uint128 balance, uint64 poolUtilization0, uint64 poolUtilization1) {

//@audit user,  are not checked
429:     function _calculateAccumulatedPremia(
430:         address user,
431:         TokenId[] calldata positionIdList,
432:         bool computeAllPremia,
433:         bool includePendingPremium,
434:         int24 atTick
435:     ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {

//@audit account,  are not checked
1367:     function _validatePositionList(
1368:         address account,
1369:         TokenId[] calldata positionIdList,
1370:         uint256 offset
1371:     ) internal view {

//@audit owner,  are not checked
1503:     function _getPremia(
1504:         TokenId tokenId,
1505:         uint128 positionSize,
1506:         address owner,
1507:         bool computeAllPremia,
1508:         int24 atTick
1509:     )


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L352-L355) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L429-L435), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1367-L1371), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1503-L1509)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit liquidatee,  are not checked
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L777) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

//@audit token, from, to,  are not checked
21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

//@audit token, to,  are not checked
52:     function safeTransfer(address token, address to, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L21-L21) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L52-L52)


</details>


### [NC&#x2011;66] Use a struct to encapsulate multiple function parameters 
If a function has too many parameters, replacing them with a struct can improve code readability and maintainability, increase reusability, and reduce the likelihood of errors when passing the parameters.


*There are 42 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

178:     constructor(
179:         uint256 _commissionFee,
180:         uint256 _sellerCollateralRatio,
181:         uint256 _buyerCollateralRatio,
182:         int256 _forceExerciseCost,
183:         uint256 _targetPoolUtilization,
184:         uint256 _saturatedPoolUtilization,
185:         uint256 _ITMSpreadMultiplier
186:     ) {
187:         COMMISSION_FEE = _commissionFee;
188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;
189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;
190:         FORCE_EXERCISE_COST = _forceExerciseCost;
191:         TARGET_POOL_UTIL = _targetPoolUtilization;
192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;
193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;
194: 
195:         // calculate amount of ticks required for upwards and downwards moves, used to check if current and mini-median tick
196:         // are out of sync (then apply a 100% collateral requirement)
197:         unchecked {
198:             // taylor expand log(1-sellCollateralRatio)/log(1.0001) around sellCollateralRatio=2000 up to 3rd order
199:             /// since we're dropping the higher order terms, which are all negative, this will underestimate the number of ticks for a 20% move
200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);
201:             TICK_DEVIATION = uint256(
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3
209:             );
210:         }
211:     }

221:     function startToken(
222:         bool underlyingIsToken0,
223:         address token0,
224:         address token1,
225:         uint24 fee,
226:         PanopticPool panopticPool
227:     ) external {
228:         // fails if already initialized
229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();
230:         s_initialized = true;
231: 
232:         // these virtual shares function as a multiplier for the capital requirement to manipulate the pool price
233:         // e.g if the virtual shares are 10**6, then the capital requirement to manipulate the price to 10**12 is 10**18
234:         totalSupply = 10 ** 6;
235: 
236:         // set total assets to 1
237:         // the initial share price is defined by 1/virtualShares
238:         s_poolAssets = 1;
239: 
240:         // store the address of the underlying ERC20 token
241:         s_underlyingToken = underlyingIsToken0 ? token0 : token1;
242: 
243:         // store the Panoptic pool for this collateral token
244:         s_panopticPool = panopticPool;
245: 
246:         // cache the pool fee in basis points
247:         uint24 _poolFee;
248:         unchecked {
249:             _poolFee = fee / 100;
250:         }
251:         s_poolFee = _poolFee;
252: 
253:         // Stores the addresses of the underlying tracked tokens.
254:         s_univ3token0 = token0;
255:         s_univ3token1 = token1;
256: 
257:         // store whether the current collateral token is token0 (true) or token1 (false; since there's always exactly two tokens it could be)
258:         s_underlyingIsToken0 = underlyingIsToken0;
259: 
260:         // Additional risk premium charged on intrinsic value of ITM positions
261:         unchecked {
262:             s_ITMSpreadFee = uint128((ITM_SPREAD_MULTIPLIER * _poolFee) / DECIMALS);
263:         }
264:     }

650:     function exerciseCost(
651:         int24 currentTick,
652:         int24 oracleTick,
653:         TokenId positionId,
654:         uint128 positionBalance,
655:         LeftRightSigned longAmounts
656:     ) external view returns (LeftRightSigned exerciseFees) {
657:         // find the leg furthest to the strike price 'currentTick'; this will have the lowest exercise cost
658:         // we don't need the leg information itself, really just "the number of half ranges" from the strike price:
659:         uint256 maxNumRangesFromStrike = 1; // technically "maxNum(Half)RangesFromStrike" but the name is long
660: 
661:         unchecked {
662:             for (uint256 leg = 0; leg < positionId.countLegs(); ++leg) {
663:                 // short legs are not counted - exercise is intended to be based on long legs
664:                 if (positionId.isLong(leg) == 0) continue;
665: 
666:                 {
667:                     int24 range = int24(
668:                         int256(
669:                             Math.unsafeDivRoundingUp(
670:                                 uint24(positionId.width(leg) * positionId.tickSpacing()),
671:                                 2
672:                             )
673:                         )
674:                     );
675:                     maxNumRangesFromStrike = Math.max(
676:                         maxNumRangesFromStrike,
677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)
678:                     );
679:                 }
680: 
681:                 uint256 currentValue0;
682:                 uint256 currentValue1;
683:                 uint256 oracleValue0;
684:                 uint256 oracleValue1;
685: 
686:                 {
687:                     LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
688:                         positionId,
689:                         leg,
690:                         positionBalance
691:                     );
692: 
693:                     (currentValue0, currentValue1) = Math.getAmountsForLiquidity(
694:                         currentTick,
695:                         liquidityChunk
696:                     );
697: 
698:                     (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(
699:                         oracleTick,
700:                         liquidityChunk
701:                     );
702:                 }
703: 
704:                 uint256 tokenType = positionId.tokenType(leg);
705:                 // compensate user for loss in value if chunk has lost money between current and median tick
706:                 // note: the delta for one token will be positive and the other will be negative. This cancels out any moves in their positions
707:                 if (
708:                     (tokenType == 0 && currentValue1 < oracleValue1) ||
709:                     (tokenType == 1 && currentValue0 < oracleValue0)
710:                 )
711:                     exerciseFees = exerciseFees.sub(
712:                         LeftRightSigned
713:                             .wrap(0)
714:                             .toRightSlot(
715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))
716:                             )
717:                             .toLeftSlot(
718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))
719:                             )
720:                     );
721:             }
722: 
723:             // note: we HAVE to start with a negative number as the base exercise cost because when shifting a negative number right by n bits,
724:             // the result is rounded DOWN and NOT toward zero
725:             // this divergence is observed when n (the number of half ranges) is > 10 (ensuring the floor is not zero, but -1 = 1bps at that point)
726:             // subtract 1 from max half ranges from strike so fee starts at FORCE_EXERCISE_COST when moving OTM
727:             int256 fee = (FORCE_EXERCISE_COST >> (maxNumRangesFromStrike - 1)); // exponential decay of fee based on number of half ranges away from the price
728: 
729:             // store the exercise fees in the exerciseFees variable
730:             exerciseFees = exerciseFees
731:                 .toRightSlot(int128((longAmounts.rightSlot() * fee) / DECIMALS_128))
732:                 .toLeftSlot(int128((longAmounts.leftSlot() * fee) / DECIMALS_128));
733:         }
734:     }

1043:     function exercise(
1044:         address optionOwner,
1045:         int128 longAmount,
1046:         int128 shortAmount,
1047:         int128 swappedAmount,
1048:         int128 realizedPremium
1049:     ) external onlyPanopticPool returns (int128) {
1050:         unchecked {
1051:             // current available assets belonging to PLPs (updated after settlement) excluding any premium paid
1052:             int256 updatedAssets = int256(uint256(s_poolAssets)) - swappedAmount;
1053: 
1054:             // add premium to be paid/collected on position close
1055:             int256 tokenToPay = -realizedPremium;
1056: 
1057:             // if burning ITM and swap occurred, compute tokens to be paid through exercise and add swap fees
1058:             int256 intrinsicValue = swappedAmount - (longAmount - shortAmount);
1059: 
1060:             if ((intrinsicValue != 0) && ((shortAmount != 0) || (longAmount != 0))) {
1061:                 // intrinsic value is the amount that need to be exchanged due to burning in-the-money
1062: 
1063:                 // add the intrinsic value to the tokenToPay
1064:                 tokenToPay += intrinsicValue;
1065:             }
1066: 
1067:             if (tokenToPay > 0) {
1068:                 // if user must pay tokens, burn them from user balance (revert if balance too small)
1069:                 uint256 sharesToBurn = Math.mulDivRoundingUp(
1070:                     uint256(tokenToPay),
1071:                     totalSupply,
1072:                     totalAssets()
1073:                 );
1074:                 _burn(optionOwner, sharesToBurn);
1075:             } else if (tokenToPay < 0) {
1076:                 // if user must receive tokens, mint them
1077:                 uint256 sharesToMint = convertToShares(uint256(-tokenToPay));
1078:                 _mint(optionOwner, sharesToMint);
1079:             }
1080: 
1081:             // update stored asset balances with net moved amounts
1082:             // any intrinsic value is paid for by the users, so we do not add it to s_inAMM
1083:             // premia is not included in the balance since it is the property of options buyers and sellers, not PLPs
1084:             s_poolAssets = uint128(uint256(updatedAssets + realizedPremium));
1085:             s_inAMM = uint128(uint256(int256(uint256(s_inAMM)) - (shortAmount - longAmount)));
1086: 
1087:             return (int128(tokenToPay));
1088:         }
1089:     }

1278:     function _getRequiredCollateralSingleLeg(
1279:         TokenId tokenId,
1280:         uint256 index,
1281:         uint128 positionSize,
1282:         int24 atTick,
1283:         uint128 poolUtilization
1284:     ) internal view returns (uint256 required) {
1285:         return
1286:             tokenId.riskPartner(index) == index // does this leg have a risk partner? Affects required collateral
1287:                 ? _getRequiredCollateralSingleLegNoPartner(
1288:                     tokenId,
1289:                     index,
1290:                     positionSize,
1291:                     atTick,
1292:                     poolUtilization
1293:                 )
1294:                 : _getRequiredCollateralSingleLegPartner(
1295:                     tokenId,
1296:                     index,
1297:                     positionSize,
1298:                     atTick,
1299:                     poolUtilization
1300:                 );
1301:     }

1311:     function _getRequiredCollateralSingleLegNoPartner(
1312:         TokenId tokenId,
1313:         uint256 index,
1314:         uint128 positionSize,
1315:         int24 atTick,
1316:         uint128 poolUtilization
1317:     ) internal view returns (uint256 required) {
1318:         // extract the tokenType (token0 or token1)
1319:         uint256 tokenType = tokenId.tokenType(index);
1320: 
1321:         // compute the total amount of funds moved for that position
1322:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);
1323: 
1324:         // amount moved is right slot if tokenType=0, left slot otherwise
1325:         uint128 amountMoved = tokenType == 0 ? amountsMoved.rightSlot() : amountsMoved.leftSlot();
1326: 
1327:         // match tokenType with the correct pool utilization
1328:         int64 utilization = tokenType == 0
1329:             ? int64(uint64(poolUtilization))
1330:             : int64(uint64(poolUtilization >> 64));
1331: 
1332:         uint256 isLong = tokenId.isLong(index);
1333: 
1334:         // start with base requirement, which is based on isLong value
1335:         required = _getRequiredCollateralAtUtilization(amountMoved, isLong, utilization);
1336: 
1337:         // if the position is long, required tokens does not depend on price
1338:         unchecked {
1339:             if (isLong == 0) {
1340:                 // if position is short, check whether the position is out-the-money
1341: 
1342:                 (int24 tickLower, int24 tickUpper) = tokenId.asTicks(index);
1343: 
1344:                 // compute the collateral requirement as a fixed amount that doesn't depend on price
1345:                 if (
1346:                     ((atTick >= tickUpper) && (tokenType == 1)) || // strike OTM when price >= upperTick for tokenType=1
1347:                     ((atTick < tickLower) && (tokenType == 0)) // strike OTM when price < lowerTick for tokenType=0
1348:                 ) {
1349:                     // position is out-the-money, collateral requirement = SCR * amountMoved
1350:                     required;
1351:                 } else {
1352:                     int24 strike = tokenId.strike(index);
1353:                     // if position is ITM or ATM, then the collateral requirement depends on price:
1354: 
1355:                     // compute the ratio of strike to price for calls (or price to strike for puts)
1356:                     // (- and * 2 in tick space are / and ^ 2 in price space so sqrtRatioAtTick(2 *(a - b)) = a/b (*2^96)
1357:                     // both of these ratios decrease as the position becomes deeper ITM, and it is possible
1358:                     // for the ratio of the prices to go under the minimum price
1359:                     // (which is the limit of what getSqrtRatioAtTick supports)
1360:                     // so instead we cap it at the minimum price, which is acceptable because
1361:                     // a higher ratio will result in an increased slope for the collateral requirement
1362:                     uint160 ratio = tokenType == 1 // tokenType
1363:                         ? Math.getSqrtRatioAtTick(
1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)
1365:                         ) // puts ->  price/strike
1366:                         : Math.getSqrtRatioAtTick(
1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)
1368:                         ); // calls -> strike/price
1369: 
1370:                     // compute the collateral requirement depending on whether the position is ITM & out-of-range or ITM and in-range:
1371: 
1372:                     /// ITM and out-of-range
1373:                     if (
1374:                         ((atTick < tickLower) && (tokenType == 1)) || // strike ITM but out of range price < lowerTick for tokenType=1
1375:                         ((atTick >= tickUpper) && (tokenType == 0)) // strike ITM but out of range when price >= upperTick for tokenType=0
1376:                     ) {
1377:                         /**
1378:                                     Short put BPR = 100% - (price/strike) + SCR
1379: 
1380:                            BUYING
1381:                            POWER
1382:                            REQUIREMENT
1383:                          
1384:                                          ^               .         .
1385:                                          |        <- ITM . <-ATM-> . OTM ->
1386:                            100% + SCR% - |--__           .    .    .
1387:                                   100% - | . .B/B/--__     .    .    .
1388:                                          |    .     B/B/--__    .    .
1389:                                    SCR - |    .          .B/B/--__________
1390:                                          |    .          .    .    .
1391:                                          +----+----------+----+----+--->   current
1392:                                          0   Liqui-     Pa  strike Pb       price
1393:                                              dation
1394:                                              price = SCR*strike                                         
1395:                          */
1396: 
1397:                         uint256 c2 = Constants.FP96 - ratio;
1398: 
1399:                         // compute the tokens required
1400:                         // position is in-the-money, collateral requirement = amountMoved*(1-ratio) + SCR*amountMoved
1401:                         required += Math.mulDiv96RoundingUp(amountMoved, c2);
1402:                     } else {
1403:                         // position is in-range (ie. current tick is between upper+lower tick): we draw a line between the
1404:                         // collateral requirement at the lowerTick and the one at the upperTick. We use that interpolation as
1405:                         // the collateral requirement when in-range, which always over-estimates the amount of token required
1406:                         // Specifically:
1407:                         //  required = amountMoved * (scaleFactor - ratio) / (scaleFactor + 1) + sellCollateralRatio*amountMoved
1408:                         uint160 scaleFactor = Math.getSqrtRatioAtTick(
1409:                             (tickUpper - strike) + (strike - tickLower)
1410:                         );
1411:                         uint256 c3 = Math.mulDivRoundingUp(
1412:                             amountMoved,
1413:                             scaleFactor - ratio,
1414:                             scaleFactor + Constants.FP96
1415:                         );
1416:                         // position is in-the-money, collateral requirement = amountMoved*(1-SRC)*(scaleFactor-ratio)/(scaleFactor+1) + SCR*amountMoved
1417:                         required += c3;
1418:                     }
1419:                 }
1420:             }
1421:         }
1422:     }

1439:     function _getRequiredCollateralSingleLegPartner(
1440:         TokenId tokenId,
1441:         uint256 index,
1442:         uint128 positionSize,
1443:         int24 atTick,
1444:         uint128 poolUtilization
1445:     ) internal view returns (uint256 required) {
1446:         // extract partner index (associated with another liquidity chunk)
1447:         uint256 partnerIndex = tokenId.riskPartner(index);
1448: 
1449:         uint256 isLong = tokenId.isLong(index);
1450:         if (isLong != tokenId.isLong(partnerIndex)) {
1451:             if (isLong == 1) {
1452:                 // compute the total amount of funds moved for that position
1453:                 required = _computeSpread(
1454:                     tokenId,
1455:                     positionSize,
1456:                     index,
1457:                     partnerIndex,
1458:                     poolUtilization
1459:                 );
1460:             }
1461:         } else {
1462:             required = _computeStrangle(tokenId, index, positionSize, atTick, poolUtilization);
1463:         }
1464:     }

1510:     function _computeSpread(
1511:         TokenId tokenId,
1512:         uint128 positionSize,
1513:         uint256 index,
1514:         uint256 partnerIndex,
1515:         uint128 poolUtilization
1516:     ) internal view returns (uint256 spreadRequirement) {
1517:         // compute the total amount of funds moved for the position's current leg
1518:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);
1519: 
1520:         // compute the total amount of funds moved for the position's partner leg
1521:         LeftRightUnsigned amountsMovedPartner = PanopticMath.getAmountsMoved(
1522:             tokenId,
1523:             positionSize,
1524:             partnerIndex
1525:         );
1526: 
1527:         // amount moved is right slot if tokenType=0, left slot otherwise
1528:         uint128 movedRight = amountsMoved.rightSlot();
1529:         uint128 movedLeft = amountsMoved.leftSlot();
1530: 
1531:         // amounts moved for partner
1532:         uint128 movedPartnerRight = amountsMovedPartner.rightSlot();
1533:         uint128 movedPartnerLeft = amountsMovedPartner.leftSlot();
1534: 
1535:         uint256 tokenType = tokenId.tokenType(index);
1536: 
1537:         // compute the max loss of the spread
1538: 
1539:         // if asset is NOT the same as the tokenType, the required amount is simply the difference in notional values
1540:         // ie. asset = 1, tokenType = 0:
1541:         if (tokenId.asset(index) != tokenType) {
1542:             unchecked {
1543:                 // always take the absolute values of the difference of amounts moved
1544:                 if (tokenType == 0) {
1545:                     spreadRequirement = movedRight < movedPartnerRight
1546:                         ? movedPartnerRight - movedRight
1547:                         : movedRight - movedPartnerRight;
1548:                 } else {
1549:                     spreadRequirement = movedLeft < movedPartnerLeft
1550:                         ? movedPartnerLeft - movedLeft
1551:                         : movedLeft - movedPartnerLeft;
1552:                 }
1553:             }
1554:         } else {
1555:             unchecked {
1556:                 uint256 notional;
1557:                 uint256 notionalP;
1558:                 uint128 contracts;
1559:                 if (tokenType == 1) {
1560:                     notional = movedRight;
1561:                     notionalP = movedPartnerRight;
1562:                     contracts = movedLeft;
1563:                 } else {
1564:                     notional = movedLeft;
1565:                     notionalP = movedPartnerLeft;
1566:                     contracts = movedRight;
1567:                 }
1568:                 // the required amount is the amount of contracts multiplied by (notional1 - notional2)/min(notional1, notional2)
1569:                 // can use unsafe because denominator is always nonzero
1570:                 spreadRequirement = (notional < notionalP)
1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)
1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);
1573:             }
1574:         }
1575: 
1576:         // calculate the spread requirement as max(max_loss, long_leg_col_req)
1577:         // narrower spreads will be very capital efficient (1/3 of non-partnered CR!), but
1578:         // wider spreads (an uncommon position w/ high max loss) may not benefit from risk partnering
1579:         spreadRequirement = Math.max(
1580:             spreadRequirement,
1581:             _getRequiredCollateralAtUtilization(
1582:                 tokenType == 0 ? movedRight : movedLeft,
1583:                 1,
1584:                 tokenType == 0
1585:                     ? int64(uint64(poolUtilization))
1586:                     : int64(uint64(poolUtilization >> 64))
1587:             )
1588:         );
1589:     }

1600:     function _computeStrangle(
1601:         TokenId tokenId,
1602:         uint256 index,
1603:         uint128 positionSize,
1604:         int24 atTick,
1605:         uint128 poolUtilization
1606:     ) internal view returns (uint256 strangleRequired) {
1607:         // If both tokenTypes are the same, then this is a long or short strangle.
1608:         // A strangle is an options strategy in which the investor holds a position
1609:         // in both a call and a put option with different strike prices,
1610:         // but with the same expiration date and underlying asset.
1611: 
1612:         /// collateral requirement is for short strangles depicted:
1613:         /**
1614:                     Put side of a short strangle, BPR = 100% - (100% - SCR/2)*(price/strike)
1615:            BUYING
1616:            POWER
1617:            REQUIREMENT
1618:                          ^                    .
1619:                          |           <- ITM   .  OTM ->
1620:                   100% - |--__                .
1621:                          |    B/B/--__          .
1622:                          |          B/B/--__    .
1623:                  SCR/2 - |                B/B/--______ <------ base collateral is half that of a single-leg
1624:                          +--------------------+--->   current
1625:                          0                  strike     price
1626:          */
1627:         unchecked {
1628:             // A negative pool utilization is used to denote a position which is a strangle
1629:             // at low pool utilization's strangle legs are evaluated at 2x capital efficiency
1630: 
1631:             uint64 poolUtilization0 = uint64(poolUtilization);
1632:             uint64 poolUtilization1 = uint64(poolUtilization >> 64);
1633: 
1634:             // add 1 to handle poolUtilization = 0
1635: 
1636:             poolUtilization =
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);
1639: 
1640:             return
1641:                 strangleRequired = _getRequiredCollateralSingleLegNoPartner(
1642:                     tokenId,
1643:                     index,
1644:                     positionSize,
1645:                     atTick,
1646:                     poolUtilization
1647:                 );
1648:         }
1649:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L211) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L221-L264), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L650-L734), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1089), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1278-L1301), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1311-L1422), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1439-L1464), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1510-L1589), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1600-L1649)


```solidity

File: ./contracts/PanopticFactory.sol

115:     constructor(
116:         address _WETH9,
117:         SemiFungiblePositionManager _SFPM,
118:         IUniswapV3Factory _univ3Factory,
119:         IDonorNFT _donorNFT,
120:         address _poolReference,
121:         address _collateralReference
122:     ) {
123:         WETH = _WETH9;
124:         SFPM = _SFPM;
125:         DONOR_NFT = _donorNFT;
126:         // We store the Uniswap Factory contract - later we can use this to verify uniswap pools
127:         UNIV3_FACTORY = _univ3Factory;
128:         POOL_REFERENCE = _poolReference;
129:         COLLATERAL_REFERENCE = _collateralReference;
130:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L115-L130) 


```solidity

File: ./contracts/PanopticPool.sol

291:     function startPool(
292:         IUniswapV3Pool _univ3pool,
293:         address token0,
294:         address token1,
295:         CollateralTracker collateralTracker0,
296:         CollateralTracker collateralTracker1
297:     ) external {
298:         // reverts if the Uniswap pool has already been initialized
299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();
300: 
301:         // Store the univ3Pool variable
302:         s_univ3pool = IUniswapV3Pool(_univ3pool);
303: 
304:         (, int24 currentTick, , , , , ) = IUniswapV3Pool(_univ3pool).slot0();
305: 
306:         // Store the median data
307:         unchecked {
308:             s_miniMedian =
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4
314:                 (uint256(uint24(currentTick))); // add to slot 3
315:         }
316: 
317:         // Store the collateral token0
318:         s_collateralToken0 = collateralTracker0;
319:         s_collateralToken1 = collateralTracker1;
320: 
321:         // consolidate all 4 approval calls to one library delegatecall in order to reduce bytecode size
322:         // approves:
323:         // SFPM: token0, token1
324:         // CollateralTracker0 - token0
325:         // CollateralTracker1 - token1
326:         InteractionHelper.doApprovals(SFPM, collateralTracker0, collateralTracker1, token0, token1);
327:     }

429:     function _calculateAccumulatedPremia(
430:         address user,
431:         TokenId[] calldata positionIdList,
432:         bool computeAllPremia,
433:         bool includePendingPremium,
434:         int24 atTick
435:     ) internal view returns (LeftRightSigned portfolioPremium, uint256[2][] memory balances) {
436:         uint256 pLength = positionIdList.length;
437:         balances = new uint256[2][](pLength);
438: 
439:         address c_user = user;
440:         // loop through each option position/tokenId
441:         for (uint256 k = 0; k < pLength; ) {
442:             TokenId tokenId = positionIdList[k];
443: 
444:             balances[k][0] = TokenId.unwrap(tokenId);
445:             balances[k][1] = LeftRightUnsigned.unwrap(s_positionBalance[c_user][tokenId]);
446: 
447:             (
448:                 LeftRightSigned[4] memory premiaByLeg,
449:                 uint256[2][4] memory premiumAccumulatorsByLeg
450:             ) = _getPremia(
451:                     tokenId,
452:                     LeftRightUnsigned.wrap(balances[k][1]).rightSlot(),
453:                     c_user,
454:                     computeAllPremia,
455:                     atTick
456:                 );
457: 
458:             uint256 numLegs = tokenId.countLegs();
459:             for (uint256 leg = 0; leg < numLegs; ) {
460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {
461:                     bytes32 chunkKey = keccak256(
462:                         abi.encodePacked(
463:                             tokenId.strike(leg),
464:                             tokenId.width(leg),
465:                             tokenId.tokenType(leg)
466:                         )
467:                     );
468: 
469:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
470:                         _getTotalLiquidity(tokenId, leg),
471:                         s_settledTokens[chunkKey],
472:                         s_grossPremiumLast[chunkKey],
473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),
474:                         premiumAccumulatorsByLeg[leg]
475:                     );
476:                     portfolioPremium = portfolioPremium.add(
477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
478:                     );
479:                 } else {
480:                     portfolioPremium = portfolioPremium.add(premiaByLeg[leg]);
481:                 }
482:                 unchecked {
483:                     ++leg;
484:                 }
485:             }
486: 
487:             unchecked {
488:                 ++k;
489:             }
490:         }
491:         return (portfolioPremium, balances);
492:     }

547:     function mintOptions(
548:         TokenId[] calldata positionIdList,
549:         uint128 positionSize,
550:         uint64 effectiveLiquidityLimitX32,
551:         int24 tickLimitLow,
552:         int24 tickLimitHigh
553:     ) external {
554:         _mintOptions(
555:             positionIdList,
556:             positionSize,
557:             effectiveLiquidityLimitX32,
558:             tickLimitLow,
559:             tickLimitHigh
560:         );
561:     }

614:     function _mintOptions(
615:         TokenId[] calldata positionIdList,
616:         uint128 positionSize,
617:         uint64 effectiveLiquidityLimitX32,
618:         int24 tickLimitLow,
619:         int24 tickLimitHigh
620:     ) internal {
621:         // the new tokenId will be the last element in 'positionIdList'
622:         TokenId tokenId;
623:         unchecked {
624:             tokenId = positionIdList[positionIdList.length - 1];
625:         }
626: 
627:         // do duplicate checks and the checks related to minting and positions
628:         _validatePositionList(msg.sender, positionIdList, 1);
629: 
630:         (tickLimitLow, tickLimitHigh) = _getSlippageLimits(tickLimitLow, tickLimitHigh);
631: 
632:         // make sure the tokenId is for this Panoptic pool
633:         if (tokenId.poolId() != SFPM.getPoolId(address(s_univ3pool)))
634:             revert Errors.InvalidTokenIdParameter(0);
635: 
636:         // disallow user to mint exact same position
637:         // in order to do it, user should burn it first and then mint
638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)
639:             revert Errors.PositionAlreadyMinted();
640: 
641:         // Mint in the SFPM and update state of collateral
642:         uint128 poolUtilizations = _mintInSFPMAndUpdateCollateral(
643:             tokenId,
644:             positionSize,
645:             tickLimitLow,
646:             tickLimitHigh
647:         );
648: 
649:         // calculate and write position data
650:         _addUserOption(tokenId, effectiveLiquidityLimitX32);
651: 
652:         // update the users options balance of position 'tokenId'
653:         // note: user can't mint same position multiple times, so set the positionSize instead of adding
654:         s_positionBalance[msg.sender][tokenId] = LeftRightUnsigned
655:             .wrap(0)
656:             .toLeftSlot(poolUtilizations)
657:             .toRightSlot(positionSize);
658: 
659:         // Perform solvency check on user's account to ensure they had enough buying power to mint the option
660:         // Add an initial buffer to the collateral requirement to prevent users from minting their account close to insolvency
661:         uint256 medianData = _validateSolvency(msg.sender, positionIdList, BP_DECREASE_BUFFER);
662: 
663:         // Update `s_miniMedian` with a new observation if the last observation is old enough (returned medianData is nonzero)
664:         if (medianData != 0) s_miniMedian = medianData;
665: 
666:         emit OptionMinted(msg.sender, positionSize, tokenId, poolUtilizations);
667:     }

794:     function _burnAllOptionsFrom(
795:         address owner,
796:         int24 tickLimitLow,
797:         int24 tickLimitHigh,
798:         bool commitLongSettled,
799:         TokenId[] calldata positionIdList
800:     ) internal returns (LeftRightSigned netPaid, LeftRightSigned[4][] memory premiasByLeg) {
801:         premiasByLeg = new LeftRightSigned[4][](positionIdList.length);
802:         for (uint256 i = 0; i < positionIdList.length; ) {
803:             LeftRightSigned paidAmounts;
804:             (paidAmounts, premiasByLeg[i]) = _burnOptions(
805:                 commitLongSettled,
806:                 positionIdList[i],
807:                 owner,
808:                 tickLimitLow,
809:                 tickLimitHigh
810:             );
811:             netPaid = netPaid.add(paidAmounts);
812:             unchecked {
813:                 ++i;
814:             }
815:         }
816:     }

826:     function _burnOptions(
827:         bool commitLongSettled,
828:         TokenId tokenId,
829:         address owner,
830:         int24 tickLimitLow,
831:         int24 tickLimitHigh
832:     ) internal returns (LeftRightSigned paidAmounts, LeftRightSigned[4] memory premiaByLeg) {
833:         // Ensure that the current price is within the tick limits
834:         (tickLimitLow, tickLimitHigh) = _getSlippageLimits(tickLimitLow, tickLimitHigh);
835: 
836:         uint128 positionSize = s_positionBalance[owner][tokenId].rightSlot();
837: 
838:         LeftRightSigned premiaOwed;
839:         // burn position and do exercise checks
840:         (premiaOwed, premiaByLeg, paidAmounts) = _burnAndHandleExercise(
841:             commitLongSettled,
842:             tickLimitLow,
843:             tickLimitHigh,
844:             tokenId,
845:             positionSize,
846:             owner
847:         );
848: 
849:         // erase position data
850:         _updatePositionDataBurn(owner, tokenId);
851: 
852:         // emit event
853:         emit OptionBurnt(owner, positionSize, tokenId, premiaOwed);
854:     }

0955:     function _burnAndHandleExercise(
0956:         bool commitLongSettled,
0957:         int24 tickLimitLow,
0958:         int24 tickLimitHigh,
0959:         TokenId tokenId,
0960:         uint128 positionSize,
0961:         address owner
0962:     )
0963:         internal
0964:         returns (
0965:             LeftRightSigned realizedPremia,
0966:             LeftRightSigned[4] memory premiaByLeg,
0967:             LeftRightSigned paidAmounts
0968:         )
0969:     {
0970:         (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalSwapped) = SFPM
0971:             .burnTokenizedPosition(tokenId, positionSize, tickLimitLow, tickLimitHigh);
0972: 
0973:         (realizedPremia, premiaByLeg) = _updateSettlementPostBurn(
0974:             owner,
0975:             tokenId,
0976:             collectedByLeg,
0977:             positionSize,
0978:             commitLongSettled
0979:         );
0980: 
0981:         (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) = PanopticMath
0982:             .computeExercisedAmounts(tokenId, positionSize);
0983: 
0984:         {
0985:             int128 paid0 = s_collateralToken0.exercise(
0986:                 owner,
0987:                 longAmounts.rightSlot(),
0988:                 shortAmounts.rightSlot(),
0989:                 totalSwapped.rightSlot(),
0990:                 realizedPremia.rightSlot()
0991:             );
0992:             paidAmounts = paidAmounts.toRightSlot(paid0);
0993:         }
0994: 
0995:         {
0996:             int128 paid1 = s_collateralToken1.exercise(
0997:                 owner,
0998:                 longAmounts.leftSlot(),
0999:                 shortAmounts.leftSlot(),
1000:                 totalSwapped.leftSlot(),
1001:                 realizedPremia.leftSlot()
1002:             );
1003:             paidAmounts = paidAmounts.toLeftSlot(paid1);
1004:         }
1005:     }

1290:     function _checkSolvencyAtTick(
1291:         address account,
1292:         TokenId[] calldata positionIdList,
1293:         int24 currentTick,
1294:         int24 atTick,
1295:         uint256 buffer
1296:     ) internal view returns (bool) {
1297:         (
1298:             LeftRightSigned portfolioPremium,
1299:             uint256[2][] memory positionBalanceArray
1300:         ) = _calculateAccumulatedPremia(
1301:                 account,
1302:                 positionIdList,
1303:                 COMPUTE_ALL_PREMIA,
1304:                 ONLY_AVAILABLE_PREMIUM,
1305:                 currentTick
1306:             );
1307: 
1308:         LeftRightUnsigned tokenData0 = s_collateralToken0.getAccountMarginDetails(
1309:             account,
1310:             atTick,
1311:             positionBalanceArray,
1312:             portfolioPremium.rightSlot()
1313:         );
1314:         LeftRightUnsigned tokenData1 = s_collateralToken1.getAccountMarginDetails(
1315:             account,
1316:             atTick,
1317:             positionBalanceArray,
1318:             portfolioPremium.leftSlot()
1319:         );
1320: 
1321:         (uint256 balanceCross, uint256 thresholdCross) = _getSolvencyBalances(
1322:             tokenData0,
1323:             tokenData1,
1324:             Math.getSqrtRatioAtTick(atTick)
1325:         );
1326: 
1327:         // compare balance and required tokens, can use unsafe div because denominator is always nonzero
1328:         unchecked {
1329:             return balanceCross >= Math.unsafeDivRoundingUp(thresholdCross * buffer, 10_000);
1330:         }
1331:     }

1465:     function _checkLiquiditySpread(
1466:         TokenId tokenId,
1467:         uint256 leg,
1468:         int24 tickLower,
1469:         int24 tickUpper,
1470:         uint64 effectiveLiquidityLimitX32
1471:     ) internal view {
1472:         LeftRightUnsigned accountLiquidities = SFPM.getAccountLiquidity(
1473:             address(s_univ3pool),
1474:             address(this),
1475:             tokenId.tokenType(leg),
1476:             tickLower,
1477:             tickUpper
1478:         );
1479: 
1480:         uint128 netLiquidity = accountLiquidities.rightSlot();
1481:         uint128 totalLiquidity = accountLiquidities.leftSlot();
1482:         // compute and return effective liquidity. Return if short=net=0, which is closing short position
1483:         if (netLiquidity == 0) return;
1484: 
1485:         uint256 effectiveLiquidityFactorX32;
1486:         unchecked {
1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;
1488:         }
1489: 
1490:         // put a limit on how much new liquidity in one transaction can be deployed into this leg
1491:         // the effective liquidity measures how many times more the newly added liquidity is compared to the existing/base liquidity
1492:         if (effectiveLiquidityFactorX32 > uint256(effectiveLiquidityLimitX32))
1493:             revert Errors.EffectiveLiquidityAboveThreshold();
1494:     }

1503:     function _getPremia(
1504:         TokenId tokenId,
1505:         uint128 positionSize,
1506:         address owner,
1507:         bool computeAllPremia,
1508:         int24 atTick
1509:     )
1510:         internal
1511:         view
1512:         returns (
1513:             LeftRightSigned[4] memory premiaByLeg,
1514:             uint256[2][4] memory premiumAccumulatorsByLeg
1515:         )
1516:     {
1517:         uint256 numLegs = tokenId.countLegs();
1518:         for (uint256 leg = 0; leg < numLegs; ) {
1519:             uint256 isLong = tokenId.isLong(leg);
1520:             if ((isLong == 1) || computeAllPremia) {
1521:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
1522:                     tokenId,
1523:                     leg,
1524:                     positionSize
1525:                 );
1526:                 uint256 tokenType = tokenId.tokenType(leg);
1527: 
1528:                 (premiumAccumulatorsByLeg[leg][0], premiumAccumulatorsByLeg[leg][1]) = SFPM
1529:                     .getAccountPremium(
1530:                         address(s_univ3pool),
1531:                         address(this),
1532:                         tokenType,
1533:                         liquidityChunk.tickLower(),
1534:                         liquidityChunk.tickUpper(),
1535:                         atTick,
1536:                         isLong
1537:                     );
1538: 
1539:                 unchecked {
1540:                     LeftRightUnsigned premiumAccumulatorLast = s_options[owner][tokenId][leg];
1541: 
1542:                     // if the premium accumulatorLast is higher than current, it means the premium accumulator has overflowed and rolled over at least once
1543:                     // we can account for one rollover by doing (acc_cur + (acc_max - acc_last))
1544:                     // if there are multiple rollovers or the rollover goes past the last accumulator, rolled over fees will just remain unclaimed
1545:                     premiaByLeg[leg] = LeftRightSigned
1546:                         .wrap(0)
1547:                         .toRightSlot(
1548:                             int128(
1549:                                 int256(
1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
1551:                                         premiumAccumulatorLast.rightSlot()) *
1552:                                         (liquidityChunk.liquidity())) / 2 ** 64
1553:                                 )
1554:                             )
1555:                         )
1556:                         .toLeftSlot(
1557:                             int128(
1558:                                 int256(
1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
1560:                                         premiumAccumulatorLast.leftSlot()) *
1561:                                         (liquidityChunk.liquidity())) / 2 ** 64
1562:                                 )
1563:                             )
1564:                         );
1565: 
1566:                     if (isLong == 1) {
1567:                         premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
1568:                     }
1569:                 }
1570:             }
1571:             unchecked {
1572:                 ++leg;
1573:             }
1574:         }
1575:     }

1757:     function _getAvailablePremium(
1758:         uint256 totalLiquidity,
1759:         LeftRightUnsigned settledTokens,
1760:         LeftRightUnsigned grossPremiumLast,
1761:         LeftRightUnsigned premiumOwed,
1762:         uint256[2] memory premiumAccumulators
1763:     ) internal pure returns (LeftRightUnsigned) {
1764:         unchecked {
1765:             // long premium only accumulates as it is settled, so compute the ratio
1766:             // of total settled tokens in a chunk to total premium owed to sellers and multiply
1767:             // cap the ratio at 1 (it can be greater than one if some seller forfeits enough premium)
1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *
1769:                 totalLiquidity) / 2 ** 64;
1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *
1771:                 totalLiquidity) / 2 ** 64;
1772: 
1773:             return (
1774:                 LeftRightUnsigned
1775:                     .wrap(0)
1776:                     .toRightSlot(
1777:                         uint128(
1778:                             Math.min(
1779:                                 (uint256(premiumOwed.rightSlot()) * settledTokens.rightSlot()) /
1780:                                     (accumulated0 == 0 ? type(uint256).max : accumulated0),
1781:                                 premiumOwed.rightSlot()
1782:                             )
1783:                         )
1784:                     )
1785:                     .toLeftSlot(
1786:                         uint128(
1787:                             Math.min(
1788:                                 (uint256(premiumOwed.leftSlot()) * settledTokens.leftSlot()) /
1789:                                     (accumulated1 == 0 ? type(uint256).max : accumulated1),
1790:                                 premiumOwed.leftSlot()
1791:                             )
1792:                         )
1793:                     )
1794:             );
1795:         }
1796:     }

1833:     function _updateSettlementPostBurn(
1834:         address owner,
1835:         TokenId tokenId,
1836:         LeftRightUnsigned[4] memory collectedByLeg,
1837:         uint128 positionSize,
1838:         bool commitLongSettled
1839:     ) internal returns (LeftRightSigned realizedPremia, LeftRightSigned[4] memory premiaByLeg) {
1840:         uint256 numLegs = tokenId.countLegs();
1841:         uint256[2][4] memory premiumAccumulatorsByLeg;
1842: 
1843:         // compute accumulated fees
1844:         (premiaByLeg, premiumAccumulatorsByLeg) = _getPremia(
1845:             tokenId,
1846:             positionSize,
1847:             owner,
1848:             COMPUTE_ALL_PREMIA,
1849:             type(int24).max
1850:         );
1851: 
1852:         for (uint256 leg = 0; leg < numLegs; ) {
1853:             LeftRightSigned legPremia = premiaByLeg[leg];
1854: 
1855:             bytes32 chunkKey = keccak256(
1856:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))
1857:             );
1858: 
1859:             // collected from Uniswap
1860:             LeftRightUnsigned settledTokens = s_settledTokens[chunkKey].add(collectedByLeg[leg]);
1861: 
1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {
1863:                 // (will be) paid by long legs
1864:                 if (tokenId.isLong(leg) == 1) {
1865:                     if (commitLongSettled)
1866:                         settledTokens = LeftRightUnsigned.wrap(
1867:                             uint256(
1868:                                 LeftRightSigned.unwrap(
1869:                                     LeftRightSigned
1870:                                         .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))
1871:                                         .sub(legPremia)
1872:                                 )
1873:                             )
1874:                         );
1875:                     realizedPremia = realizedPremia.add(legPremia);
1876:                 } else {
1877:                     uint256 positionLiquidity = PanopticMath
1878:                         .getLiquidityChunk(tokenId, leg, positionSize)
1879:                         .liquidity();
1880: 
1881:                     // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (T - R)
1882:                     uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
1883:                     // T (totalLiquidity is (T - R) after burning)
1884:                     uint256 totalLiquidityBefore = totalLiquidity + positionLiquidity;
1885: 
1886:                     LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
1887: 
1888:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
1889:                         totalLiquidity + positionLiquidity,
1890:                         settledTokens,
1891:                         grossPremiumLast,
1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
1893:                         premiumAccumulatorsByLeg[leg]
1894:                     );
1895: 
1896:                     // subtract settled tokens sent to seller
1897:                     settledTokens = settledTokens.sub(availablePremium);
1898: 
1899:                     // add available premium to amount that should be settled
1900:                     realizedPremia = realizedPremia.add(
1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
1902:                     );
1903: 
1904:                     // We need to adjust the grossPremiumLast value such that the result of
1905:                     // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostBurn/2**64 is equal to
1906:                     // (grossPremium - grossPremiumLast)*totalLiquidityBeforeBurn/2**64 - premiumOwedToPosition
1907:                     // G: total gross premium (- premiumOwedToPosition)
1908:                     // T: totalLiquidityBeforeMint
1909:                     // R: positionLiquidity
1910:                     // C: current grossPremium value
1911:                     // L: current grossPremiumLast value
1912:                     // Ln: updated grossPremiumLast value
1913:                     // T * (C - L) = G
1914:                     // (T - R) * (C - Ln) = G - P
1915:                     //
1916:                     // T * (C - L) = (T - R) * (C - Ln) + P
1917:                     // (TC - TL - P) / (T - R) = C - Ln
1918:                     // Ln = C - (TC - TL - P) / (T - R)
1919:                     // Ln = (TC - CR - TC + LT + P) / (T-R)
1920:                     // Ln = (LT - CR + P) / (T-R)
1921: 
1922:                     unchecked {
1923:                         uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;
1924:                         uint256 _leg = leg;
1925: 
1926:                         // if there's still liquidity, compute the new grossPremiumLast
1927:                         // otherwise, we just reset grossPremiumLast to the current grossPremium
1928:                         s_grossPremiumLast[chunkKey] = totalLiquidity != 0
1929:                             ? LeftRightUnsigned
1930:                                 .wrap(0)
1931:                                 .toRightSlot(
1932:                                     uint128(
1933:                                         uint256(
1934:                                             Math.max(
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),
1943:                                                 0
1944:                                             )
1945:                                         ) / totalLiquidity
1946:                                     )
1947:                                 )
1948:                                 .toLeftSlot(
1949:                                     uint128(
1950:                                         uint256(
1951:                                             Math.max(
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,
1960:                                                 0
1961:                                             )
1962:                                         ) / totalLiquidity
1963:                                     )
1964:                                 )
1965:                             : LeftRightUnsigned
1966:                                 .wrap(0)
1967:                                 .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
1968:                                 .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));
1969:                     }
1970:                 }
1971:             }
1972: 
1973:             // update settled tokens in storage with all local deltas
1974:             s_settledTokens[chunkKey] = settledTokens;
1975: 
1976:             unchecked {
1977:                 ++leg;
1978:             }
1979:         }
1980:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L291-L327) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L429-L492), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L547-L561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L614-L667), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L794-L816), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L826-L854), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L955-L1005), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1290-L1331), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1465-L1494), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1503-L1575), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1757-L1796), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1833-L1980)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

540:     function safeTransferFrom(
541:         address from,
542:         address to,
543:         uint256 id,
544:         uint256 amount,
545:         bytes calldata data
546:     ) public override {
547:         // we don't need to reentrancy lock on transfers, but we can't allow transfers for a pool during mint/burn with a reentrant call
548:         // so just check if there is an active reentrancy lock for the relevant pool on the token we're transferring
549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();
550: 
551:         // update the position data
552:         registerTokenTransfer(from, to, TokenId.wrap(id), amount);
553: 
554:         // transfer the token (note that all state updates are completed before reentrancy is possible through onReceived callbacks)
555:         super.safeTransferFrom(from, to, id, amount, data);
556:     }

566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data
572:     ) public override {
573:         // we don't need to reentrancy lock on transfers, but we can't allow transfers for a pool during mint/burn with a reentrant call
574:         // so just check if there is an active reentrancy lock for the relevant pool on each token
575:         for (uint256 i = 0; i < ids.length; ) {
576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();
577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);
578:             unchecked {
579:                 ++i;
580:             }
581:         }
582: 
583:         // transfer the token (note that all state updates are completed before reentrancy is possible)
584:         super.safeBatchTransferFrom(from, to, ids, amounts, data);
585:     }

680:     function _validateAndForwardToAMM(
681:         TokenId tokenId,
682:         uint128 positionSize,
683:         int24 tickLimitLow,
684:         int24 tickLimitHigh,
685:         bool isBurn
686:     ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {
687:         // Reverts if positionSize is 0 and user did not own the position before minting/burning
688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();
689: 
690:         /// @dev the flipToBurnToken() function flips the isLong bits
691:         if (isBurn) {
692:             tokenId = tokenId.flipToBurnToken();
693:         }
694: 
695:         // Validate tokenId
696:         tokenId.validate();
697: 
698:         // Extract univ3pool from the poolId map to Uniswap Pool
699:         IUniswapV3Pool univ3pool = s_poolContext[tokenId.poolId()].pool;
700: 
701:         // Revert if the pool not been previously initialized
702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();
703: 
704:         // initialize some variables returned by the _createPositionInAMM function
705:         LeftRightSigned itmAmounts;
706: 
707:         // calls a function that loops through each leg of tokenId and mints/burns liquidity in Uni v3 pool
708:         (totalMoved, collectedByLeg, itmAmounts) = _createPositionInAMM(
709:             univ3pool,
710:             tokenId,
711:             positionSize,
712:             isBurn
713:         );
714: 
715:         if (tickLimitLow > tickLimitHigh) {
716:             // if the in-the-money amount is not zero (i.e. positions were minted ITM) and the user did provide tick limits LOW > HIGH, then swap necessary amounts
717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {
718:                 totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);
719:             }
720: 
721:             (tickLimitLow, tickLimitHigh) = (tickLimitHigh, tickLimitLow);
722:         }
723: 
724:         // Get the current tick of the Uniswap pool, check slippage
725:         (, int24 currentTick, , , , , ) = univ3pool.slot0();
726: 
727:         if ((currentTick >= tickLimitHigh) || (currentTick <= tickLimitLow))
728:             revert Errors.PriceBoundFail();
729:     }

0958:     function _createLegInAMM(
0959:         IUniswapV3Pool univ3pool,
0960:         TokenId tokenId,
0961:         uint256 leg,
0962:         LiquidityChunk liquidityChunk,
0963:         bool isBurn
0964:     )
0965:         internal
0966:         returns (
0967:             LeftRightSigned moved,
0968:             LeftRightSigned itmAmounts,
0969:             LeftRightUnsigned collectedSingleLeg
0970:         )
0971:     {
0972:         uint256 tokenType = tokenId.tokenType(leg);
0973:         // unique key to identify the liquidity chunk in this uniswap pool
0974:         bytes32 positionKey = keccak256(
0975:             abi.encodePacked(
0976:                 address(univ3pool),
0977:                 msg.sender,
0978:                 tokenType,
0979:                 liquidityChunk.tickLower(),
0980:                 liquidityChunk.tickUpper()
0981:             )
0982:         );
0983: 
0984:         // update our internal bookkeeping of how much liquidity we have deployed in the AMM
0985:         // for example: if this _leg is short, we add liquidity to the amm, make sure to add that to our tracking
0986:         uint128 updatedLiquidity;
0987:         uint256 isLong = tokenId.isLong(leg);
0988:         LeftRightUnsigned currentLiquidity = s_accountLiquidity[positionKey]; //cache
0989:         {
0990:             // did we have liquidity already deployed in Uniswap for this chunk range from some past mint?
0991: 
0992:             // s_accountLiquidity is a LeftRight. The right slot represents the liquidity currently sold (added) in the AMM owned by the user
0993:             // the left slot represents the amount of liquidity currently bought (removed) that has been removed from the AMM - the user owes it to a seller
0994:             // the reason why it is called "removedLiquidity" is because long options are created by removing -ie.short selling LP positions
0995:             uint128 startingLiquidity = currentLiquidity.rightSlot();
0996:             uint128 removedLiquidity = currentLiquidity.leftSlot();
0997:             uint128 chunkLiquidity = liquidityChunk.liquidity();
0998: 
0999:             if (isLong == 0) {
1000:                 // selling/short: so move from msg.sender *to* uniswap
1001:                 // we're minting more liquidity in uniswap: so add the incoming liquidity chunk to the existing liquidity chunk
1002:                 updatedLiquidity = startingLiquidity + chunkLiquidity;
1003: 
1004:                 /// @dev If the isLong flag is 0=short but the position was burnt, then this is closing a long position
1005:                 /// @dev so the amount of removed liquidity should decrease.
1006:                 if (isBurn) {
1007:                     removedLiquidity -= chunkLiquidity;
1008:                 }
1009:             } else {
1010:                 // the _leg is long (buying: moving *from* uniswap to msg.sender)
1011:                 // so we seek to move the incoming liquidity chunk *out* of uniswap - but was there sufficient liquidity sitting in uniswap
1012:                 // in the first place?
1013:                 if (startingLiquidity < chunkLiquidity) {
1014:                     // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
1015:                     // what the account that owns the liquidity in uniswap has (startingLiquidity)
1016:                     // we must ensure that an account can only move its own liquidity out of uniswap
1017:                     // so we revert in this case
1018:                     revert Errors.NotEnoughLiquidity();
1019:                 } else {
1020:                     // startingLiquidity is >= chunkLiquidity, so no possible underflow
1021:                     unchecked {
1022:                         // we want to move less than what already sits in uniswap, no problem:
1023:                         updatedLiquidity = startingLiquidity - chunkLiquidity;
1024:                     }
1025:                 }
1026: 
1027:                 /// @dev If the isLong flag is 1=long and the position is minted, then this is opening a long position
1028:                 /// @dev so the amount of removed liquidity should increase.
1029:                 if (!isBurn) {
1030:                     // we can't remove more liquidity than we add in the first place, so this can't overflow
1031:                     unchecked {
1032:                         removedLiquidity += chunkLiquidity;
1033:                     }
1034:                 }
1035:             }
1036: 
1037:             // update the starting liquidity for this position for next time around
1038:             s_accountLiquidity[positionKey] = LeftRightUnsigned
1039:                 .wrap(0)
1040:                 .toLeftSlot(removedLiquidity)
1041:                 .toRightSlot(updatedLiquidity);
1042:         }
1043: 
1044:         // track how much liquidity we need to collect from uniswap
1045:         // add the fees that accumulated in uniswap within the liquidityChunk:
1046:         {
1047:             /** if the position is NOT long (selling a put or a call), then _mintLiquidity to move liquidity
1048:                 from the msg.sender to the uniswap v3 pool:
1049:                 Selling(isLong=0): Mint chunk of liquidity in Uniswap (defined by upper tick, lower tick, and amount)
1050:                        bbabababababababababababababababababababababababababababababababababa
1051:                 ba2     bba<ba liquidityChunk                 ba
1052:                 ba  bbabab4bab4bababa                         bbababab4bababa
1053:                 ba  ba       ba                         ba      ba
1054:                 bbabab4bababababababab4bababa:                      bbababababababa
1055:                    Uniswap v3                      msg.sender
1056:             
1057:              else: the position is long (buying a put or a call), then _burnLiquidity to remove liquidity from univ3
1058:                 Buying(isLong=1): Burn in Uniswap
1059:                        bbabababababababababababababababababa
1060:                 ba2     bb<ba                ba
1061:                 ba  bbabab4bab4bababa         bbabababa<bababa
1062:                 ba  ba       ba         ba      ba
1063:                 bbabab4bababababababab4bababa:      bbababababababa
1064:                     Uniswap v3      msg.sender 
1065:             */
1066:             moved = isLong == 0
1067:                 ? _mintLiquidity(liquidityChunk, univ3pool)
1068:                 : _burnLiquidity(liquidityChunk, univ3pool); // from msg.sender to Uniswap
1069:             // add the moved liquidity chunk to amount we need to collect from uniswap:
1070: 
1071:             // Is this _leg ITM?
1072:             // if tokenType is 1, and we transacted some token0: then this leg is ITM!
1073:             if (tokenType == 1) {
1074:                 // extract amount moved out of UniswapV3 pool
1075:                 itmAmounts = itmAmounts.toRightSlot(moved.rightSlot());
1076:             }
1077:             // if tokenType is 0, and we transacted some token1: then this leg is ITM
1078:             if (tokenType == 0) {
1079:                 // Add this in-the-money amount transacted.
1080:                 itmAmounts = itmAmounts.toLeftSlot(moved.leftSlot());
1081:             }
1082:         }
1083: 
1084:         // if there was liquidity at that tick before the transaction, collect any accumulated fees
1085:         if (currentLiquidity.rightSlot() > 0) {
1086:             collectedSingleLeg = _collectAndWritePositionData(
1087:                 liquidityChunk,
1088:                 univ3pool,
1089:                 currentLiquidity,
1090:                 positionKey,
1091:                 moved,
1092:                 isLong
1093:             );
1094:         }
1095: 
1096:         // position has been touched, update s_accountFeesBase with the latest values from the pool.positions
1097:         // round up the stored feesbase to minimize Nfeesbase when we next calculate it
1098:         s_accountFeesBase[positionKey] = _getFeesBase(
1099:             univ3pool,
1100:             updatedLiquidity,
1101:             liquidityChunk,
1102:             true
1103:         );
1104:     }

1255:     function _collectAndWritePositionData(
1256:         LiquidityChunk liquidityChunk,
1257:         IUniswapV3Pool univ3pool,
1258:         LeftRightUnsigned currentLiquidity,
1259:         bytes32 positionKey,
1260:         LeftRightSigned movedInLeg,
1261:         uint256 isLong
1262:     ) internal returns (LeftRightUnsigned collectedChunk) {
1263:         uint128 startingLiquidity = currentLiquidity.rightSlot();
1264:         // round down current fees base to minimize Nfeesbase
1265:         // If the current feesBase is close or identical to the stored one, the amountToCollect can be negative.
1266:         // This is because the stored feesBase is rounded up, and the current feesBase is rounded down.
1267:         // When this is the case, we want to behave as if there are 0 fees, so we just rectify the values.
1268:         LeftRightSigned amountToCollect = _getFeesBase(
1269:             univ3pool,
1270:             startingLiquidity,
1271:             liquidityChunk,
1272:             false
1273:         ).subRect(s_accountFeesBase[positionKey]);
1274: 
1275:         if (isLong == 1) {
1276:             amountToCollect = amountToCollect.sub(movedInLeg);
1277:         }
1278: 
1279:         if (LeftRightSigned.unwrap(amountToCollect) != 0) {
1280:             // first collect amounts from Uniswap corresponding to this position
1281:             // Collect only if there was existing startingLiquidity=liquidities.rightSlot() at that position: collect all fees
1282: 
1283:             // Collects tokens owed to a liquidity chunk
1284:             (uint128 receivedAmount0, uint128 receivedAmount1) = univ3pool.collect(
1285:                 msg.sender,
1286:                 liquidityChunk.tickLower(),
1287:                 liquidityChunk.tickUpper(),
1288:                 uint128(amountToCollect.rightSlot()),
1289:                 uint128(amountToCollect.leftSlot())
1290:             );
1291: 
1292:             // moved will be negative if the leg was long (funds left the caller, don't count it in collected fees)
1293:             uint128 collected0;
1294:             uint128 collected1;
1295:             unchecked {
1296:                 collected0 = movedInLeg.rightSlot() < 0
1297:                     ? receivedAmount0 - uint128(-movedInLeg.rightSlot())
1298:                     : receivedAmount0;
1299:                 collected1 = movedInLeg.leftSlot() < 0
1300:                     ? receivedAmount1 - uint128(-movedInLeg.leftSlot())
1301:                     : receivedAmount1;
1302:             }
1303: 
1304:             // CollectedOut is the amount of fees accumulated+collected (received - burnt)
1305:             // That's because receivedAmount contains the burnt tokens and whatever amount of fees collected
1306:             collectedChunk = LeftRightUnsigned.wrap(0).toRightSlot(collected0).toLeftSlot(
1307:                 collected1
1308:             );
1309: 
1310:             // record the collected amounts in the s_accountPremiumOwed and s_accountPremiumGross accumulators
1311:             _updateStoredPremia(positionKey, currentLiquidity, collectedChunk);
1312:         }
1313:     }

1421:     function getAccountLiquidity(
1422:         address univ3pool,
1423:         address owner,
1424:         uint256 tokenType,
1425:         int24 tickLower,
1426:         int24 tickUpper
1427:     ) external view returns (LeftRightUnsigned accountLiquidities) {
1428:         /// Extract the account liquidity for a given uniswap pool, owner, token type, and ticks
1429:         /// @dev tokenType input here is the asset of the positions minted, this avoids put liquidity to be used for call, and vice-versa
1430:         accountLiquidities = s_accountLiquidity[
1431:             keccak256(abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper))
1432:         ];
1433:     }

1449:     function getAccountPremium(
1450:         address univ3pool,
1451:         address owner,
1452:         uint256 tokenType,
1453:         int24 tickLower,
1454:         int24 tickUpper,
1455:         int24 atTick,
1456:         uint256 isLong
1457:     ) external view returns (uint128, uint128) {
1458:         bytes32 positionKey = keccak256(
1459:             abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper)
1460:         );
1461: 
1462:         LeftRightUnsigned acctPremia;
1463: 
1464:         // Compute the premium up to the current block (ie. after last touch until now). Do not proceed if atTick == type(int24).max = 8388608
1465:         if (atTick < type(int24).max) {
1466:             // unique key to identify the liquidity chunk in this uniswap pool
1467:             LeftRightUnsigned accountLiquidities = s_accountLiquidity[positionKey];
1468:             uint128 netLiquidity = accountLiquidities.rightSlot();
1469:             if (netLiquidity != 0) {
1470:                 LeftRightUnsigned amountToCollect;
1471:                 {
1472:                     IUniswapV3Pool _univ3pool = IUniswapV3Pool(univ3pool);
1473:                     int24 _tickLower = tickLower;
1474:                     int24 _tickUpper = tickUpper;
1475: 
1476:                     // how much fees have been accumulated within the liquidity chunk since last time we updated this chunk?
1477:                     // Compute (currentFeesGrowth - oldFeesGrowth), the amount to collect
1478:                     // currentFeesGrowth (calculated from FeesCalc.calculateAMMSwapFeesLiquidityChunk) is (ammFeesCollectedPerLiquidity * liquidityChunk.liquidity())
1479:                     // oldFeesGrowth is the last stored update of fee growth within the position range in the past (feeGrowthRange*liquidityChunk.liquidity()) (s_accountFeesBase[positionKey])
1480:                     LeftRightSigned feesBase = FeesCalc.calculateAMMSwapFees(
1481:                         _univ3pool,
1482:                         atTick,
1483:                         _tickLower,
1484:                         _tickUpper,
1485:                         netLiquidity
1486:                     );
1487: 
1488:                     // If the current feesBase is close or identical to the stored one, the amountToCollect can be negative.
1489:                     // This is because the stored feesBase is rounded up, and the current feesBase is rounded down.
1490:                     // When this is the case, we want to behave as if there are 0 fees, so we just rectify the values.
1491:                     // Guaranteed to be positive, so swap to unsigned type
1492:                     amountToCollect = LeftRightUnsigned.wrap(
1493:                         uint256(
1494:                             LeftRightSigned.unwrap(feesBase.subRect(s_accountFeesBase[positionKey]))
1495:                         )
1496:                     );
1497:                 }
1498: 
1499:                 (LeftRightUnsigned premiumOwed, LeftRightUnsigned premiumGross) = _getPremiaDeltas(
1500:                     accountLiquidities,
1501:                     amountToCollect
1502:                 );
1503: 
1504:                 // add deltas to accumulators and freeze both accumulators (for a token) if one of them overflows
1505:                 // (i.e if only token0 (right slot) of the owed premium overflows, then stop accumulating  both token0 owed premium and token0 gross premium for the chunk)
1506:                 // this prevents situations where the owed premium gets out of sync with the gross premium due to one of them overflowing
1507:                 (premiumOwed, premiumGross) = LeftRightLibrary.addCapped(
1508:                     s_accountPremiumOwed[positionKey],
1509:                     premiumOwed,
1510:                     s_accountPremiumGross[positionKey],
1511:                     premiumGross
1512:                 );
1513: 
1514:                 acctPremia = isLong == 1 ? premiumOwed : premiumGross;
1515:             }
1516:         } else {
1517:             // Extract the account liquidity for a given uniswap pool, owner, token type, and ticks
1518:             acctPremia = isLong == 1
1519:                 ? s_accountPremiumOwed[positionKey]
1520:                 : s_accountPremiumGross[positionKey];
1521:         }
1522:         return (acctPremia.rightSlot(), acctPremia.leftSlot());
1523:     }

1535:     function getAccountFeesBase(
1536:         address univ3pool,
1537:         address owner,
1538:         uint256 tokenType,
1539:         int24 tickLower,
1540:         int24 tickUpper
1541:     ) external view returns (int128 feesBase0, int128 feesBase1) {
1542:         // Get accumulated fees for token0 (rightSlot) and token1 (leftSlot)
1543:         LeftRightSigned feesBase = s_accountFeesBase[
1544:             keccak256(abi.encodePacked(univ3pool, owner, tokenType, tickLower, tickUpper))
1545:         ];
1546:         feesBase0 = feesBase.rightSlot();
1547:         feesBase1 = feesBase.leftSlot();
1548:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L540-L556) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L585), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L680-L729), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L958-L1104), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1255-L1313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1421-L1433), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1449-L1523), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1535-L1548)


```solidity

File: ./contracts/libraries/FeesCalc.sol

097:     function calculateAMMSwapFees(
098:         IUniswapV3Pool univ3pool,
099:         int24 currentTick,
100:         int24 tickLower,
101:         int24 tickUpper,
102:         uint128 liquidity
103:     ) public view returns (LeftRightSigned) {
104:         // extract the amount of AMM fees collected within the liquidity chunk`
105:         // note: the fee variables are *per unit of liquidity*; so more "rate" variables
106:         (
107:             uint256 ammFeesPerLiqToken0X128,
108:             uint256 ammFeesPerLiqToken1X128
109:         ) = _getAMMSwapFeesPerLiquidityCollected(univ3pool, currentTick, tickLower, tickUpper);
110: 
111:         // Use the fee growth (rate) variable to compute the absolute fees accumulated within the chunk:
112:         //   ammFeesToken0X128 * liquidity / (2**128)
113:         // to store the (absolute) fees as int128:
114:         return
115:             LeftRightSigned
116:                 .wrap(0)
117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))
118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));
119:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L97-L119) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

24:     function doApprovals(
25:         SemiFungiblePositionManager sfpm,
26:         CollateralTracker ct0,
27:         CollateralTracker ct1,
28:         address token0,
29:         address token1
30:     ) external {
31:         // Approve transfers of Panoptic Pool funds by SFPM
32:         IERC20Partial(token0).approve(address(sfpm), type(uint256).max);
33:         IERC20Partial(token1).approve(address(sfpm), type(uint256).max);
34: 
35:         // Approve transfers of Panoptic Pool funds by Collateral token
36:         IERC20Partial(token0).approve(address(ct0), type(uint256).max);
37:         IERC20Partial(token1).approve(address(ct1), type(uint256).max);
38:     }

48:     function computeName(
49:         address token0,
50:         address token1,
51:         bool isToken0,
52:         uint24 fee,
53:         string memory prefix
54:     ) external view returns (string memory) {
55:         // get the underlying token symbols
56:         // it's not guaranteed that they support the metadata extension
57:         // so we need to let them fail and return placeholder if not
58:         string memory symbol0;
59:         string memory symbol1;
60:         try IERC20Metadata(token0).symbol() returns (string memory _symbol) {
61:             symbol0 = _symbol;
62:         } catch {
63:             symbol0 = "???";
64:         }
65:         try IERC20Metadata(token1).symbol() returns (string memory _symbol) {
66:             symbol1 = _symbol;
67:         } catch {
68:             symbol1 = "???";
69:         }
70:         unchecked {
71:             return
72:                 string.concat(
73:                     prefix,
74:                     " ",
75:                     isToken0 ? symbol0 : symbol1,
76:                     " LP on ",
77:                     symbol0,
78:                     "/",
79:                     symbol1,
80:                     " ",
81:                     Strings.toString(fee),
82:                     "bps"
83:                 );
84:         }
85:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L24-L38) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L48-L85)


```solidity

File: ./contracts/libraries/PanopticMath.sol

125:     function computeMedianObservedPrice(
126:         IUniswapV3Pool univ3pool,
127:         uint256 observationIndex,
128:         uint256 observationCardinality,
129:         uint256 cardinality,
130:         uint256 period
131:     ) external view returns (int24) {
132:         unchecked {
133:             int256[] memory tickCumulatives = new int256[](cardinality + 1);
134: 
135:             uint256[] memory timestamps = new uint256[](cardinality + 1);
136:             // get the last 4 timestamps/tickCumulatives (if observationIndex < cardinality, the index will wrap back from observationCardinality)
137:             for (uint256 i = 0; i < cardinality + 1; ++i) {
138:                 (timestamps[i], tickCumulatives[i], , ) = univ3pool.observations(
139:                     uint256(
140:                         (int256(observationIndex) - int256(i * period)) +
141:                             int256(observationCardinality)
142:                     ) % observationCardinality
143:                 );
144:             }
145: 
146:             int256[] memory ticks = new int256[](cardinality);
147:             // use cardinality periods given by cardinality + 1 accumulator observations to compute the last cardinality observed ticks spaced by period
148:             for (uint256 i = 0; i < cardinality; ++i) {
149:                 ticks[i] =
150:                     (tickCumulatives[i] - tickCumulatives[i + 1]) /
151:                     int256(timestamps[i] - timestamps[i + 1]);
152:             }
153: 
154:             // get the median of the 3 calculated ticks
155:             return int24(Math.sort(ticks)[cardinality / 2]);
156:         }
157:     }

168:     function computeInternalMedian(
169:         uint256 observationIndex,
170:         uint256 observationCardinality,
171:         uint256 period,
172:         uint256 medianData,
173:         IUniswapV3Pool univ3pool
174:     ) external view returns (int24 medianTick, uint256 updatedMedianData) {
175:         unchecked {
176:             // return the average of the rank 3 and 4 values
177:             medianTick =
178:                 (int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 3)) % 8) * 24))) +
179:                     int24(uint24(medianData >> ((uint24(medianData >> (192 + 3 * 4)) % 8) * 24)))) /
180:                 2;
181: 
182:             // only proceed if last entry is at least MEDIAN_PERIOD seconds old
183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {
184:                 int24 lastObservedTick;
185:                 {
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
187:                         uint256(
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)
189:                         ) % observationCardinality
190:                     );
191: 
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
193:                         .observations(observationIndex);
194:                     lastObservedTick = int24(
195:                         (tickCumulative_last - tickCumulative_old) /
196:                             int256(timestamp_last - timestamp_old)
197:                     );
198:                 }
199: 
200:                 uint24 orderMap = uint24(medianData >> 192);
201: 
202:                 uint24 newOrderMap;
203:                 uint24 shift = 1;
204:                 bool below = true;
205:                 uint24 rank;
206:                 int24 entry;
207:                 for (uint8 i; i < 8; ++i) {
208:                     // read the rank from the existing ordering
209:                     rank = (orderMap >> (3 * i)) % 8;
210: 
211:                     if (rank == 7) {
212:                         shift -= 1;
213:                         continue;
214:                     }
215: 
216:                     // read the corresponding entry
217:                     entry = int24(uint24(medianData >> (rank * 24)));
218:                     if ((below) && (lastObservedTick > entry)) {
219:                         shift += 1;
220:                         below = false;
221:                     }
222: 
223:                     newOrderMap = newOrderMap + ((rank + 1) << (3 * (i + shift - 1)));
224:                 }
225: 
226:                 updatedMedianData =
227:                     (block.timestamp << 216) +
228:                     (uint256(newOrderMap) << 192) +
229:                     uint256(uint192(medianData << 24)) +
230:                     uint256(uint24(lastObservedTick));
231:             }
232:         }
233:     }

651:     function getLiquidationBonus(
652:         LeftRightUnsigned tokenData0,
653:         LeftRightUnsigned tokenData1,
654:         uint160 sqrtPriceX96Twap,
655:         uint160 sqrtPriceX96Final,
656:         LeftRightSigned netExchanged,
657:         LeftRightSigned premia
658:     ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {
659:         unchecked {
660:             // compute bonus as min(collateralBalance/2, required-collateralBalance)
661:             {
662:                 // compute the ratio of token0 to total collateral requirements
663:                 // evaluate at TWAP price to keep consistentcy with solvency calculations
664:                 uint256 required0 = PanopticMath.convert0to1(
665:                     tokenData0.leftSlot(),
666:                     sqrtPriceX96Twap
667:                 );
668:                 uint256 required1 = tokenData1.leftSlot();
669:                 uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);
670: 
671:                 (uint256 balanceCross, uint256 thresholdCross) = PanopticMath.convertCollateralData(
672:                     tokenData0,
673:                     tokenData1,
674:                     0,
675:                     sqrtPriceX96Twap
676:                 );
677: 
678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);
679: 
680:                 // convert that bonus to tokens 0 and 1
681:                 bonus0 = int256(Math.mulDiv128(bonusCross, requiredRatioX128));
682: 
683:                 bonus1 = int256(
684:                     PanopticMath.convert0to1(
685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),
686:                         sqrtPriceX96Final
687:                     )
688:                 );
689:             }
690: 
691:             // negative premium (owed to the liquidatee) is credited to the collateral balance
692:             // this is already present in the netExchanged amount, so to avoid double-counting we remove it from the balance
693:             int256 balance0 = int256(uint256(tokenData0.rightSlot())) -
694:                 Math.max(premia.rightSlot(), 0);
695:             int256 balance1 = int256(uint256(tokenData1.rightSlot())) -
696:                 Math.max(premia.leftSlot(), 0);
697: 
698:             int256 paid0 = bonus0 + int256(netExchanged.rightSlot());
699:             int256 paid1 = bonus1 + int256(netExchanged.leftSlot());
700: 
701:             // note that "balance0" and "balance1" are the liquidatee's original balances before token delegation by a liquidator
702:             // their actual balances at the time of computation may be higher, but these are a buffer representing the amount of tokens we
703:             // have to work with before cutting into the liquidator's funds
704:             if (!(paid0 > balance0 && paid1 > balance1)) {
705:                 // liquidatee cannot pay back the liquidator fully in either token, so no protocol loss can be avoided
706:                 if ((paid0 > balance0)) {
707:                     // liquidatee has insufficient token0 but some token1 left over, so we use what they have left to mitigate token0 losses
708:                     // we do this by substituting an equivalent value of token1 in our refund to the liquidator, plus a bonus, for the token0 we convert
709:                     // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
710:                     // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token1 balance: balance1 - paid1
711:                     // and paid0 - balance0 is the amount of token0 that the liquidatee is missing, i.e the protocol loss
712:                     // if the protocol loss is lower than the excess token1 balance, then we can fully mitigate the loss and we should only convert the loss amount
713:                     // if the protocol loss is higher than the excess token1 balance, we can only mitigate part of the loss, so we should convert only the excess token1 balance
714:                     // thus, the value converted should be min(balance1 - paid1, paid0 - balance0)
715:                     bonus1 += Math.min(
716:                         balance1 - paid1,
717:                         PanopticMath.convert0to1(paid0 - balance0, sqrtPriceX96Final)
718:                     );
719:                     bonus0 -= Math.min(
720:                         PanopticMath.convert1to0(balance1 - paid1, sqrtPriceX96Final),
721:                         paid0 - balance0
722:                     );
723:                 }
724:                 if ((paid1 > balance1)) {
725:                     // liquidatee has insufficient token1 but some token0 left over, so we use what they have left to mitigate token1 losses
726:                     // we do this by substituting an equivalent value of token0 in our refund to the liquidator, plus a bonus, for the token1 we convert
727:                     // we want to convert the minimum amount of tokens required to achieve the lowest possible protocol loss (to avoid overpaying on the conversion bonus)
728:                     // the maximum level of protocol loss mitigation that can be achieved is the liquidatee's excess token0 balance: balance0 - paid0
729:                     // and paid1 - balance1 is the amount of token1 that the liquidatee is missing, i.e the protocol loss
730:                     // if the protocol loss is lower than the excess token0 balance, then we can fully mitigate the loss and we should only convert the loss amount
731:                     // if the protocol loss is higher than the excess token0 balance, we can only mitigate part of the loss, so we should convert only the excess token0 balance
732:                     // thus, the value converted should be min(balance0 - paid0, paid1 - balance1)
733:                     bonus0 += Math.min(
734:                         balance0 - paid0,
735:                         PanopticMath.convert1to0(paid1 - balance1, sqrtPriceX96Final)
736:                     );
737:                     bonus1 -= Math.min(
738:                         PanopticMath.convert0to1(balance0 - paid0, sqrtPriceX96Final),
739:                         paid1 - balance1
740:                     );
741:                 }
742:             }
743: 
744:             paid0 = bonus0 + int256(netExchanged.rightSlot());
745:             paid1 = bonus1 + int256(netExchanged.leftSlot());
746:             return (
747:                 bonus0,
748:                 bonus1,
749:                 LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(
750:                     int128(balance1 - paid1)
751:                 )
752:             );
753:         }
754:     }

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {
778:         unchecked {
779:             // get the amount of premium paid by the liquidatee
780:             LeftRightSigned longPremium;
781:             for (uint256 i = 0; i < positionIdList.length; ++i) {
782:                 TokenId tokenId = positionIdList[i];
783:                 uint256 numLegs = tokenId.countLegs();
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }
789:             }
790:             // Ignore any surplus collateral - the liquidatee is either solvent or it converts to <1 unit of the other token
791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);
792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);
793:             int256 haircut0;
794:             int256 haircut1;
795:             // if the premium in the same token is not enough to cover the loss and there is a surplus of the other token,
796:             // the liquidator will provide the tokens (reflected in the bonus amount) & receive compensation in the other token
797:             if (
798:                 longPremium.rightSlot() < collateralDelta0 &&
799:                 longPremium.leftSlot() > collateralDelta1
800:             ) {
801:                 int256 protocolLoss1 = collateralDelta1;
802:                 (collateralDelta0, collateralDelta1) = (
803:                     -Math.min(
804:                         collateralDelta0 - longPremium.rightSlot(),
805:                         PanopticMath.convert1to0(
806:                             longPremium.leftSlot() - collateralDelta1,
807:                             sqrtPriceX96Final
808:                         )
809:                     ),
810:                     Math.min(
811:                         longPremium.leftSlot() - collateralDelta1,
812:                         PanopticMath.convert0to1(
813:                             collateralDelta0 - longPremium.rightSlot(),
814:                             sqrtPriceX96Final
815:                         )
816:                     )
817:                 );
818: 
819:                 haircut0 = longPremium.rightSlot();
820:                 haircut1 = protocolLoss1 + collateralDelta1;
821:             } else if (
822:                 longPremium.leftSlot() < collateralDelta1 &&
823:                 longPremium.rightSlot() > collateralDelta0
824:             ) {
825:                 int256 protocolLoss0 = collateralDelta0;
826:                 (collateralDelta0, collateralDelta1) = (
827:                     Math.min(
828:                         longPremium.rightSlot() - collateralDelta0,
829:                         PanopticMath.convert1to0(
830:                             collateralDelta1 - longPremium.leftSlot(),
831:                             sqrtPriceX96Final
832:                         )
833:                     ),
834:                     -Math.min(
835:                         collateralDelta1 - longPremium.leftSlot(),
836:                         PanopticMath.convert0to1(
837:                             longPremium.rightSlot() - collateralDelta0,
838:                             sqrtPriceX96Final
839:                         )
840:                     )
841:                 );
842: 
843:                 haircut0 = collateralDelta0 + protocolLoss0;
844:                 haircut1 = longPremium.leftSlot();
845:             } else {
846:                 // for each token, haircut until the protocol loss is mitigated or the premium paid is exhausted
847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());
848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());
849: 
850:                 collateralDelta0 = 0;
851:                 collateralDelta1 = 0;
852:             }
853: 
854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }
859: 
860:             for (uint256 i = 0; i < positionIdList.length; i++) {
861:                 TokenId tokenId = positionIdList[i];
862:                 LeftRightSigned[4][] memory _premiasByLeg = premiasByLeg;
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
864:                     if (tokenId.isLong(leg) == 1) {
865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
866:                             storage _settledTokens = settledTokens;
867: 
868:                         // calculate amounts to revoke from settled and subtract from haircut req
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
871:                             uint128(longPremium.rightSlot())
872:                         );
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
875:                             uint128(longPremium.leftSlot())
876:                         );
877: 
878:                         bytes32 chunkKey = keccak256(
879:                             abi.encodePacked(
880:                                 tokenId.strike(0),
881:                                 tokenId.width(0),
882:                                 tokenId.tokenType(0)
883:                             )
884:                         );
885: 
886:                         // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
887:                         // for the haircut directly to the accumulator
888:                         settled0 = Math.max(
889:                             0,
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
891:                         );
892:                         settled1 = Math.max(
893:                             0,
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
895:                         );
896: 
897:                         _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
899:                                 uint128(settled1)
900:                             )
901:                         );
902:                     }
903:                 }
904:             }
905: 
906:             return (collateralDelta0, collateralDelta1);
907:         }
908:     }

917:     function getRefundAmounts(
918:         address refunder,
919:         LeftRightSigned refundValues,
920:         int24 atTick,
921:         CollateralTracker collateral0,
922:         CollateralTracker collateral1
923:     ) external view returns (LeftRightSigned) {
924:         uint160 sqrtPriceX96 = Math.getSqrtRatioAtTick(atTick);
925:         unchecked {
926:             // if the refunder lacks sufficient token0 to pay back the refundee, have them pay back the equivalent value in token1
927:             // note: it is possible for refunds to be negative when the exercise fee is higher than the delegated amounts. This is expected behavior
928:             int256 balanceShortage = refundValues.rightSlot() -
929:                 int256(collateral0.convertToAssets(collateral0.balanceOf(refunder)));
930: 
931:             if (balanceShortage > 0) {
932:                 return
933:                     LeftRightSigned
934:                         .wrap(0)
935:                         .toRightSlot(int128(refundValues.rightSlot() - balanceShortage))
936:                         .toLeftSlot(
937:                             int128(
938:                                 int256(
939:                                     PanopticMath.convert0to1(uint256(balanceShortage), sqrtPriceX96)
940:                                 ) + refundValues.leftSlot()
941:                             )
942:                         );
943:             }
944: 
945:             balanceShortage =
946:                 refundValues.leftSlot() -
947:                 int256(collateral1.convertToAssets(collateral1.balanceOf(refunder)));
948: 
949:             if (balanceShortage > 0) {
950:                 return
951:                     LeftRightSigned
952:                         .wrap(0)
953:                         .toLeftSlot(int128(refundValues.leftSlot() - balanceShortage))
954:                         .toRightSlot(
955:                             int128(
956:                                 int256(
957:                                     PanopticMath.convert1to0(uint256(balanceShortage), sqrtPriceX96)
958:                                 ) + refundValues.rightSlot()
959:                             )
960:                         );
961:             }
962:         }
963: 
964:         // otherwise, we can just refund the original amounts requested with no problems
965:         return refundValues;
966:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L125-L157) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L168-L233), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L651-L754), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L908), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L917-L966)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

094:     function safeTransferFrom(
095:         address from,
096:         address to,
097:         uint256 id,
098:         uint256 amount,
099:         bytes calldata data
100:     ) public virtual {
101:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
102: 
103:         balanceOf[from][id] -= amount;
104: 
105:         // balance will never overflow
106:         unchecked {
107:             balanceOf[to][id] += amount;
108:         }
109: 
110:         emit TransferSingle(msg.sender, from, to, id, amount);
111: 
112:         if (to.code.length != 0) {
113:             if (
114:                 ERC1155Holder(to).onERC1155Received(msg.sender, from, id, amount, data) !=
115:                 ERC1155Holder.onERC1155Received.selector
116:             ) {
117:                 revert UnsafeRecipient();
118:             }
119:         }
120:     }

130:     function safeBatchTransferFrom(
131:         address from,
132:         address to,
133:         uint256[] calldata ids,
134:         uint256[] calldata amounts,
135:         bytes calldata data
136:     ) public virtual {
137:         if (!(msg.sender == from || isApprovedForAll[from][msg.sender])) revert NotAuthorized();
138: 
139:         // Storing these outside the loop saves ~15 gas per iteration.
140:         uint256 id;
141:         uint256 amount;
142: 
143:         for (uint256 i = 0; i < ids.length; ) {
144:             id = ids[i];
145:             amount = amounts[i];
146: 
147:             balanceOf[from][id] -= amount;
148: 
149:             // balance will never overflow
150:             unchecked {
151:                 balanceOf[to][id] += amount;
152:             }
153: 
154:             // An array can't have a total length
155:             // larger than the max uint256 value.
156:             unchecked {
157:                 ++i;
158:             }
159:         }
160: 
161:         emit TransferBatch(msg.sender, from, to, ids, amounts);
162: 
163:         if (to.code.length != 0) {
164:             if (
165:                 ERC1155Holder(to).onERC1155BatchReceived(msg.sender, from, ids, amounts, data) !=
166:                 ERC1155Holder.onERC1155BatchReceived.selector
167:             ) {
168:                 revert UnsafeRecipient();
169:             }
170:         }
171:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L94-L120) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L130-L171)


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

13:     function issueNFT(
14:         address deployer,
15:         PanopticPool newPoolContract,
16:         address token0,
17:         address token1,
18:         uint24 fee
19:     ) external;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L13-L19) 


```solidity

File: ./contracts/types/TokenId.sol

336:     function addLeg(
337:         TokenId self,
338:         uint256 legIndex,
339:         uint256 _optionRatio,
340:         uint256 _asset,
341:         uint256 _isLong,
342:         uint256 _tokenType,
343:         uint256 _riskPartner,
344:         int24 _strike,
345:         int24 _width
346:     ) internal pure returns (TokenId tokenId) {
347:         tokenId = addOptionRatio(self, _optionRatio, legIndex);
348:         tokenId = addAsset(tokenId, _asset, legIndex);
349:         tokenId = addIsLong(tokenId, _isLong, legIndex);
350:         tokenId = addTokenType(tokenId, _tokenType, legIndex);
351:         tokenId = addRiskPartner(tokenId, _riskPartner, legIndex);
352:         tokenId = addStrike(tokenId, _strike, legIndex);
353:         tokenId = addWidth(tokenId, _width, legIndex);
354:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L336-L354) 


</details>


### [NC&#x2011;67] Use `@inheritdoc` for overridden functions 



*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

319:     /// @dev See {IERC20-transfer}.
320:     /// Requirements:
321:     /// - the caller must have a balance of at least 'amount'.
322:     /// - the msg.sender must not have any position on the panoptic pool

336:     /// @dev See {IERC20-transferFrom}.
337:     /// Requirements:
338:     /// - the 'from' must have a balance of at least 'amount'.
339:     /// - the caller must have allowance for 'from' of at least 'amount' tokens.
340:     /// - 'from' must not have any open positions on the panoptic pool.


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L319-L322) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L336-L340)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

533:     /// @notice Transfer a single token from one user to another
534:     /// @dev supports token approvals
535:     /// @param from the user to transfer tokens from
536:     /// @param to the user to transfer tokens to
537:     /// @param id the ERC1155 token id to transfer
538:     /// @param amount the amount of tokens to transfer
539:     /// @param data optional data to include in the receive hook

558:     /// @notice Transfer multiple tokens from one user to another
559:     /// @dev supports token approvals
560:     /// @dev ids and amounts must be of equal length
561:     /// @param from the user to transfer tokens from
562:     /// @param to the user to transfer tokens to
563:     /// @param ids the ERC1155 token ids to transfer
564:     /// @param amounts the amounts of tokens to transfer
565:     /// @param data optional data to include in the receive hook


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L533-L539) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L558-L565)


</details>


### [NC&#x2011;68] Multiple mappings with same keys can be combined into a single struct mapping for readability 
Well-organized data structures make code reviews easier, which may lead to fewer bugs. Consider combining related mappings into mappings to structs, so it's clear what data is related.


*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))

258:     mapping(address account => mapping(TokenId tokenId => LeftRightUnsigned balanceAndUtilizations))

272:     mapping(address account => uint256 positionsHash) internal s_positionsHash;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L238-L238) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L258-L258), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L272-L272)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

66:     mapping(address account => mapping(uint256 tokenId => uint256 balance)) public balanceOf;

71:     mapping(address owner => mapping(address operator => bool approvedForAll))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L66-L66) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L71-L71)


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

35:     mapping(address account => uint256 balance) public balanceOf;

39:     mapping(address owner => mapping(address spender => uint256 allowance)) public allowance;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L35-L35) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L39-L39)


</details>


### [NC&#x2011;69] constructor should emit an event 
Use events to signal significant changes to off-chain monitoring tools.


*There are 4 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

178:     constructor(
179:         uint256 _commissionFee,
180:         uint256 _sellerCollateralRatio,
181:         uint256 _buyerCollateralRatio,
182:         int256 _forceExerciseCost,
183:         uint256 _targetPoolUtilization,
184:         uint256 _saturatedPoolUtilization,
185:         uint256 _ITMSpreadMultiplier
186:     ) {
187:         COMMISSION_FEE = _commissionFee;
188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;
189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;
190:         FORCE_EXERCISE_COST = _forceExerciseCost;
191:         TARGET_POOL_UTIL = _targetPoolUtilization;
192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;
193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;
194: 
195:         // calculate amount of ticks required for upwards and downwards moves, used to check if current and mini-median tick
196:         // are out of sync (then apply a 100% collateral requirement)
197:         unchecked {
198:             // taylor expand log(1-sellCollateralRatio)/log(1.0001) around sellCollateralRatio=2000 up to 3rd order
199:             /// since we're dropping the higher order terms, which are all negative, this will underestimate the number of ticks for a 20% move
200:             int256 ratioTick = (int256(_sellerCollateralRatio) - 2000);
201:             TICK_DEVIATION = uint256(
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3
209:             );
210:         }
211:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L178-L211) 


```solidity

File: ./contracts/PanopticFactory.sol

115:     constructor(
116:         address _WETH9,
117:         SemiFungiblePositionManager _SFPM,
118:         IUniswapV3Factory _univ3Factory,
119:         IDonorNFT _donorNFT,
120:         address _poolReference,
121:         address _collateralReference
122:     ) {
123:         WETH = _WETH9;
124:         SFPM = _SFPM;
125:         DONOR_NFT = _donorNFT;
126:         // We store the Uniswap Factory contract - later we can use this to verify uniswap pools
127:         UNIV3_FACTORY = _univ3Factory;
128:         POOL_REFERENCE = _poolReference;
129:         COLLATERAL_REFERENCE = _collateralReference;
130:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L115-L130) 


```solidity

File: ./contracts/PanopticPool.sol

280:     constructor(SemiFungiblePositionManager _sfpm) {
281:         SFPM = _sfpm;
282:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L280-L282) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

341:     constructor(IUniswapV3Factory _factory) {
342:         FACTORY = _factory;
343:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L341-L343) 


</details>


### [NC&#x2011;70] Complex functions should include comments 
Large and/or complex functions should include comments to make them easier to understand and reduce margin for error.


*There are 8 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticFactory.sol

172:     function uniswapV3MintCallback(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L172-L172) 


```solidity

File: ./contracts/PanopticPool.sol

794:     function _burnAllOptionsFrom(

955:     function _burnAndHandleExercise(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L794-L794) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L955-L955)


```solidity

File: ./contracts/libraries/FeesCalc.sol

46:     function getPortfolioValue(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L46-L46) 


```solidity

File: ./contracts/libraries/Math.sol

91:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {

241:     function getLiquidityForAmount0(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L91-L91) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L241-L241)


```solidity

File: ./contracts/types/LeftRight.sol

279:     function addCapped(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L279-L279) 


```solidity

File: ./contracts/types/TokenId.sol

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L464-L464) 


</details>


### [NC&#x2011;71] Make use of Solidiy's `using` keyword 
The directive `using A for B` can be used to attach functions (`A`) as operators to user-defined value types or as member functions to any type (`B`). The member functions receive the object they are called on as their first parameter (like the `self` variable in Python). The operator functions receive operands as parameters.  Doing so improves readability, makes debugging easier, and promotes modularity and reusability in the code.


*There are 315 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

333:         return ERC20Minimal.transfer(recipient, amount);

352:         return ERC20Minimal.transferFrom(from, to, amount);

380:         return Math.mulDiv(assets, totalSupply, totalAssets());

387:         return Math.mulDiv(shares, totalAssets(), totalSupply);

424:         SafeTransferLib.safeTransferFrom(

484:         SafeTransferLib.safeTransferFrom(

521:         return Math.mulDivRoundingUp(assets, supply, totalAssets());

556:         SafeTransferLib.safeTransferFrom(

616:         SafeTransferLib.safeTransferFrom(

1322:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);

1518:         LeftRightUnsigned amountsMoved = PanopticMath.getAmountsMoved(tokenId, positionSize, index);

1521:         LeftRightUnsigned amountsMovedPartner = PanopticMath.getAmountsMoved(

170:         if (msg.sender != address(s_panopticPool)) revert Errors.NotPanopticPool();

229:         if (s_initialized) revert Errors.CollateralTokenAlreadyInitialized();

331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();

350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();

418:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();

512:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();

575:         return s_panopticPool.numberOfPositions(owner) == 0 ? Math.min(available, balance) : 0;

596:         if (shares > maxRedeem(owner)) revert Errors.ExceedsMaximumRedemption();

1579:         spreadRequirement = Math.max(

402:             shares = Math.mulDiv(

462:             assets = Math.mulDivRoundingUp(

1210:             TokenId tokenId = TokenId.wrap(positionBalanceArray[i][0]);

1012:                 uint256 sharesToBurn = Math.mulDivRoundingUp(

1069:                 uint256 sharesToBurn = Math.mulDivRoundingUp(

1109:                 uint256 swapCommission = Math.unsafeDivRoundingUp(

1120:                 Math.unsafeDivRoundingUp(

687:                     LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

956:                 Math.mulDiv(

1213:             uint128 positionSize = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).rightSlot();

1216:             uint128 poolUtilization = LeftRightUnsigned.wrap(positionBalanceArray[i][1]).leftSlot();

1486:                 required = Math.unsafeDivRoundingUp(amount * sellCollateral, DECIMALS);

675:                     maxNumRangesFromStrike = Math.max(

693:                     (currentValue0, currentValue1) = Math.getAmountsForLiquidity(

698:                     (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(

1496:                 required = Math.unsafeDivRoundingUp(amount * buyCollateral, DECIMALS);

1572:                     : Math.unsafeDivRoundingUp((notional - notionalP) * contracts, notionalP);

1571:                     ? Math.unsafeDivRoundingUp((notionalP - notional) * contracts, notional)

669:                             Math.unsafeDivRoundingUp(

959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))

1110:                     s_ITMSpreadFee * uint256(Math.abs(intrinsicValue)),

1366:                         : Math.getSqrtRatioAtTick(

1363:                         ? Math.getSqrtRatioAtTick(

1367:                             Math.max24(2 * (strike - atTick), Constants.MIN_V3POOL_TICK)

1364:                             Math.max24(2 * (atTick - strike), Constants.MIN_V3POOL_TICK)

1408:                         uint160 scaleFactor = Math.getSqrtRatioAtTick(

1411:                         uint256 c3 = Math.mulDivRoundingUp(

677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)

1401:                         required += Math.mulDiv96RoundingUp(amountMoved, c2);

712:                         LeftRightSigned


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L333-L333) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L352-L352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L380-L380), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L387-L387), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L424-L424), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L484-L484), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L556-L556), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L616-L616), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1322-L1322), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1518-L1518), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1521-L1521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L170-L170), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L229-L229), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L331-L331), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L350-L350), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L418-L418), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L480-L480), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L536-L536), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L575-L575), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L596-L596), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1579-L1579), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L402-L402), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L462-L462), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1210-L1210), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1012-L1012), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1069-L1069), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1109-L1109), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1120-L1120), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L687-L687), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L956-L956), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1213-L1213), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1216-L1216), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1486-L1486), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L675-L675), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L693-L693), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L698-L698), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1496-L1496), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1572-L1572), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1571-L1571), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L669-L669), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L959-L959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1110-L1110), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1366-L1366), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1363-L1363), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1367-L1367), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1364-L1364), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1408-L1408), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1411-L1411), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L677-L677), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1401-L1401), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L712-L712)


```solidity

File: ./contracts/PanopticFactory.sol

179:         CallbackLib.validateCallback(msg.sender, UNIV3_FACTORY, decoded.poolFeatures);

150:         if (msg.sender != currentOwner) revert Errors.NotOwner();

182:             SafeTransferLib.safeTransferFrom(

189:             SafeTransferLib.safeTransferFrom(

220:         if (address(bytes20(salt)) != msg.sender) revert Errors.InvalidSalt();

224:         if (_owner != address(0) && _owner != msg.sender) revert Errors.NotOwner();

227:         if (address(v3Pool) == address(0)) revert Errors.UniswapPoolNotInitialized();

230:             revert Errors.PoolAlreadyInitialized();

241:             Clones.clone(COLLATERAL_REFERENCE)

244:             Clones.clone(COLLATERAL_REFERENCE)

397:             CallbackLib.CallbackData({

304:             uint256 rarity = PanopticMath.numberOfLeadingHexZeros(

398:                 poolFeatures: CallbackLib.PoolFeatures({token0: token0, token1: token1, fee: fee}),

366:                     Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_TOKEN, currentSqrtPriceX96)

369:                     Math.mulDivRoundingUp(

353:                     Math.mulDiv96RoundingUp(FULL_RANGE_LIQUIDITY_AMOUNT_WETH, currentSqrtPriceX96)

357:                     Math.mulDivRoundingUp(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L179-L179) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L150-L150), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L182-L182), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L189-L189), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L220-L220), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L224-L224), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L227-L227), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L230-L230), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L241-L241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L244-L244), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L397-L397), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L304-L304), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L398-L398), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L366-L366), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L369-L369), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L353-L353), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L357-L357)


```solidity

File: ./contracts/PanopticPool.sol

525:         (, uint256 medianData) = PanopticMath.computeInternalMedian(

712:         (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) = PanopticMath

905:         int24 fastOracleTick = PanopticMath.computeMedianObservedPrice(

981:         (LeftRightSigned longAmounts, LeftRightSigned shortAmounts) = PanopticMath

1197:         (LeftRightSigned longAmounts, LeftRightSigned delegatedAmounts) = PanopticMath

1410:         uint256 newHash = PanopticMath.updatePositionsHash(

299:         if (address(s_univ3pool) != address(0)) revert Errors.PoolAlreadyInitialized();

415:         (value0, value1) = FeesCalc.getPortfolioValue(

634:             revert Errors.InvalidTokenIdParameter(0);

638:         if (LeftRightUnsigned.unwrap(s_positionBalance[msg.sender][tokenId]) != 0)

639:             revert Errors.PositionAlreadyMinted();

861:         s_positionBalance[owner][tokenId] = LeftRightUnsigned.wrap(0);

940:         if (!solventAtFast) revert Errors.NotEnoughCollateral();

943:         if (Math.abs(int256(fastOracleTick) - slowOracleTick) > MAX_SLOW_FAST_DELTA)

1163:         ) revert Errors.NotEnoughCollateral();

1188:         if (touchedId.length != 1) revert Errors.InputListFail();

1242:         refundAmounts = PanopticMath.getRefundAmounts(

1324:             Math.getSqrtRatioAtTick(atTick)

1394:         if (fingerprintIncomingList != currentHash) revert Errors.InputListFail();

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

1451:         twapTick = PanopticMath.twapFilter(s_univ3pool, TWAP_WINDOW);

1493:             revert Errors.EffectiveLiquidityAboveThreshold();

1596:         if (tokenId.isLong(legIndex) == 0 || legIndex > 3) revert Errors.NotALongLeg();

342:             revert Errors.PriceBoundFail();

945:                 revert Errors.NotEnoughCollateral();

1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)

1036:                 revert Errors.StaleTWAP();

1063:                 Math.getSqrtRatioAtTick(twapTick)

1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();

1098:             (liquidationBonus0, liquidationBonus1, collateralRemaining) = PanopticMath

1122:             (deltaBonus0, deltaBonus1) = PanopticMath.haircutPremia(

1329:             return balanceCross >= Math.unsafeDivRoundingUp(thresholdCross * buffer, 10_000);

1627:         uint256 liquidity = PanopticMath

444:             balances[k][0] = TokenId.unwrap(tokenId);

445:             balances[k][1] = LeftRightUnsigned.unwrap(s_positionBalance[c_user][tokenId]);

870:             s_options[owner][tokenId][leg] = LeftRightUnsigned.wrap(0);

923:             (slowOracleTick, medianData) = PanopticMath.computeInternalMedian(

915:             slowOracleTick = PanopticMath.computeMedianObservedPrice(

1102:                     Math.getSqrtRatioAtTick(twapTick),

1103:                     Math.getSqrtRatioAtTick(finalTick),

1129:                 Math.getSqrtRatioAtTick(_finalTick),

1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +

1349:                 Math.mulDiv96(tokenData0.rightSlot(), sqrtPriceX96);

1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +

1354:                 Math.mulDiv96RoundingUp(tokenData0.leftSlot(), sqrtPriceX96);

1383:             fingerprintIncomingList = PanopticMath.updatePositionsHash(

1651:                 LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(realizedPremia)))

1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {

1165:         LeftRightSigned bonusAmounts = LeftRightSigned

1521:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

1680:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

1787:                             Math.min(

452:                     LeftRightUnsigned.wrap(balances[k][1]).rightSlot(),

654:         s_positionBalance[msg.sender][tokenId] = LeftRightUnsigned

1633:             LeftRightSigned realizedPremia = LeftRightSigned

1651:                 LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(realizedPremia)))

775:                     uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))

1614:             accumulatedPremium = LeftRightUnsigned

1778:                             Math.min(

1774:                 LeftRightUnsigned

473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),

1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),

477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

762:                 s_options[msg.sender][tokenId][leg] = LeftRightUnsigned

1877:                     uint256 positionLiquidity = PanopticMath

1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

1866:                         settledTokens = LeftRightUnsigned.wrap(

473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),

1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),

477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

1545:                     premiaByLeg[leg] = LeftRightSigned

1567:                         premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);

1725:                     s_grossPremiumLast[chunkKey] = LeftRightUnsigned

1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))

1868:                                 LeftRightSigned.unwrap(

1965:                             : LeftRightUnsigned

1951:                                             Math.max(

1929:                             ? LeftRightUnsigned

1869:                                     LeftRightSigned

1934:                                             Math.max(

1870:                                         .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L525-L525) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L712-L712), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L905-L905), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L981-L981), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1197-L1197), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1410-L1410), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L299-L299), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L415-L415), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L634-L634), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L638-L638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L639-L639), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L861-L861), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L940-L940), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L943-L943), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1163-L1163), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1188-L1188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1242-L1242), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1324-L1324), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1394-L1394), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1415-L1415), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1451-L1451), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1493-L1493), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1596-L1596), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L342-L342), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L945-L945), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1035-L1035), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1036-L1036), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1063-L1063), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1066-L1066), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1098-L1098), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1122-L1122), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1329-L1329), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1627-L1627), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L444-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L445-L445), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L870-L870), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L923-L923), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L915-L915), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1102-L1102), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1103-L1103), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1129-L1129), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1348-L1348), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1349-L1349), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1353-L1353), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1354-L1354), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1383-L1383), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1651-L1651), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1862-L1862), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1165-L1165), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1521-L1521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1680-L1680), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1787-L1787), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L452-L452), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L654-L654), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1633-L1633), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1651-L1651), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L775-L775), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1614-L1614), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1778-L1778), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1774-L1774), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L473-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1892-L1892), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L762-L762), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1877-L1877), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1901-L1901), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1866-L1866), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L473-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1892-L1892), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1545-L1545), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1567-L1567), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1725-L1725), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1901-L1901), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1868-L1868), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1965-L1965), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1951-L1951), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1929-L1929), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1869-L1869), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1934-L1934), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1870-L1870)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

367:         uint64 poolId = PanopticMath.getPoolId(univ3pool);

410:         CallbackLib.validateCallback(msg.sender, FACTORY, decoded.poolFeatures);

443:         CallbackLib.validateCallback(msg.sender, FACTORY, decoded.poolFeatures);

456:         SafeTransferLib.safeTransferFrom(token, decoded.payer, msg.sender, amountToPay);

322:         if (s_poolContext[poolId].locked) revert Errors.ReentrantCall();

355:         if (univ3pool == address(0)) revert Errors.UniswapPoolNotInitialized();

413:             SafeTransferLib.safeTransferFrom(

420:             SafeTransferLib.safeTransferFrom(

482:         _burn(msg.sender, TokenId.unwrap(tokenId), positionSize);

515:         _mint(msg.sender, TokenId.unwrap(tokenId), positionSize);

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

552:         registerTokenTransfer(from, to, TokenId.wrap(id), amount);

688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();

702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();

728:             revert Errors.PriceBoundFail();

940:             revert Errors.PositionTooLarge();

1123:         (s_accountPremiumOwed[positionKey], s_accountPremiumGross[positionKey]) = LeftRightLibrary

1191:             CallbackLib.CallbackData({ // compute by reading values from univ3pool every time

1279:         if (LeftRightSigned.unwrap(amountToCollect) != 0) {

604:             LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

833:             if (swapAmount == 0) return LeftRightSigned.wrap(0);

1192:                     poolFeatures: CallbackLib.PoolFeatures({

373:             poolId = PanopticMath.incrementPoolPattern(poolId);

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

634:             ) revert Errors.TransferFailed();

638:             if (LeftRightUnsigned.unwrap(fromLiq) != liquidityChunk.liquidity())

639:                 revert Errors.TransferFailed();

645:             s_accountLiquidity[positionKey_from] = LeftRightUnsigned.wrap(0);

648:             s_accountFeesBase[positionKey_from] = LeftRightSigned.wrap(0);

774:                 CallbackLib.CallbackData({

904:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

1350:                 premium0X64_base = Math.mulDiv(

1355:                 premium1X64_base = Math.mulDiv(

549:         if (s_poolContext[TokenId.wrap(id).poolId()].locked) revert Errors.ReentrantCall();

717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {

775:                     poolFeatures: CallbackLib.PoolFeatures({

817:                 int256 net0 = itm0 - PanopticMath.convert1to0(itm1, sqrtPriceX96);

632:                 (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||

633:                 (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)

922:                     amount0 += Math.getAmount0ForLiquidity(liquidityChunk);

924:                     amount1 += Math.getAmount1ForLiquidity(liquidityChunk);

1018:                     revert Errors.NotEnoughLiquidity();

1177:                 .toLeftSlot(int128(int256(Math.mulDiv128(feeGrowthInside1LastX128, liquidity))));

1172:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside1LastX128, liquidity)))

1214:         movedAmounts = LeftRightSigned.wrap(0).toRightSlot(int128(int256(amount0))).toLeftSlot(

1480:                     LeftRightSigned feesBase = FeesCalc.calculateAMMSwapFees(

1507:                 (premiumOwed, premiumGross) = LeftRightLibrary.addCapped(

576:             if (s_poolContext[TokenId.wrap(ids[i]).poolId()].locked) revert Errors.ReentrantCall();

848:             totalSwapped = LeftRightSigned.wrap(0).toRightSlot(swap0.toInt128()).toLeftSlot(

1038:             s_accountLiquidity[positionKey] = LeftRightUnsigned

1174:             : LeftRightSigned

1166:             ? LeftRightSigned

1241:             movedAmounts = LeftRightSigned.wrap(0).toRightSlot(-int128(int256(amount0))).toLeftSlot(

1369:                     premium0X64_owed = Math

1372:                     premium1X64_owed = Math

1393:                     premium0X64_gross = Math

1396:                     premium1X64_gross = Math

1492:                     amountToCollect = LeftRightUnsigned.wrap(

1176:                 .toRightSlot(int128(int256(Math.mulDiv128(feeGrowthInside0LastX128, liquidity))))

1169:                     int128(int256(Math.mulDiv128RoundingUp(feeGrowthInside0LastX128, liquidity)))

1306:             collectedChunk = LeftRightUnsigned.wrap(0).toRightSlot(collected0).toLeftSlot(

1376:                     deltaPremiumOwed = LeftRightUnsigned

1400:                     deltaPremiumGross = LeftRightUnsigned

1494:                             LeftRightSigned.unwrap(feesBase.subRect(s_accountFeesBase[positionKey]))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L367-L367) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L410-L410), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L443-L443), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L456-L456), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L322-L322), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L355-L355), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L413-L413), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L420-L420), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L482-L482), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L515-L515), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L549-L549), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L552-L552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L688-L688), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L702-L702), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L728-L728), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L940-L940), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1123-L1123), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1191-L1191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1279-L1279), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L604-L604), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L833-L833), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1192-L1192), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L373-L373), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L576-L576), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L577-L577), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L634-L634), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L638-L638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L639-L639), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L645-L645), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L648-L648), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L774-L774), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L904-L904), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1350-L1350), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1355-L1355), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L549-L549), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L717-L717), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L775-L775), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L817-L817), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L632-L632), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L633-L633), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L922-L922), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L924-L924), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1018-L1018), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1177-L1177), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1172-L1172), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1214-L1214), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1480-L1480), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1507-L1507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L576-L576), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L848-L848), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1038-L1038), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1174-L1174), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1166-L1166), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1241-L1241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1369-L1369), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1372-L1372), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1393-L1393), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1396-L1396), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1492-L1492), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1176-L1176), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1169-L1169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1306-L1306), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1376-L1376), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1400-L1400), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1494-L1494)


```solidity

File: ./contracts/libraries/CallbackLib.sol

37:             revert Errors.InvalidUniswapCallback();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L37-L37) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

118:                 .toLeftSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken1X128, liquidity))));

56:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(

62:                 (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(

115:             LeftRightSigned

117:                 .toRightSlot(int128(int256(Math.mulDiv128(ammFeesPerLiqToken0X128, liquidity))))


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L118-L118) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L56-L56), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L62-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L115-L115), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L117-L117)


```solidity

File: ./contracts/libraries/InteractionHelper.sol

81:                     Strings.toString(fee),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L81-L81) 


```solidity

File: ./contracts/libraries/Math.sol

251:                 LiquidityChunkLibrary.createChunk(

281:                 LiquidityChunkLibrary.createChunk(

297:         if ((downcastedInt = uint128(toDowncast)) != toDowncast) revert Errors.CastingError();

312:         if ((downcastedInt = int128(toCast)) < 0) revert Errors.CastingError();

319:         if (!((downcastedInt = int128(toCast)) == toCast)) revert Errors.CastingError();

326:         if (toCast > uint256(type(int256).max)) revert Errors.CastingError();

131:             if (absTick > uint256(int256(Constants.MAX_V3POOL_TICK))) revert Errors.InvalidTick();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L251-L251) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L281-L281), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L297-L297), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L312-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L319-L319), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L326-L326), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L131-L131)


```solidity

File: ./contracts/libraries/PanopticMath.sol

924:         uint160 sqrtPriceX96 = Math.getSqrtRatioAtTick(atTick);

263:             int256[] memory sortedTicks = Math.sort(twapMeasurement);

452:             convertCollateralData(tokenData0, tokenData1, tokenType, Math.getSqrtRatioAtTick(tick));

328:             return Math.getLiquidityForAmount1(tickLower, tickUpper, amount);

326:             return Math.getLiquidityForAmount0(tickLower, tickUpper, amount);

361:             ) revert Errors.TicksNotInitializable();

479:             if (notional == 0 || notional > type(uint128).max) revert Errors.InvalidNotionalValue();

678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);

694:                 Math.max(premia.rightSlot(), 0);

696:                 Math.max(premia.leftSlot(), 0);

791:             int256 collateralDelta0 = -Math.min(collateralRemaining.rightSlot(), 0);

792:             int256 collateralDelta1 = -Math.min(collateralRemaining.leftSlot(), 0);

77:             return addr == address(0) ? 40 : 39 - Math.mostSignificantNibble(uint160(addr));

155:             return int24(Math.sort(ticks)[cardinality / 2]);

377:             int24(int256(Math.unsafeDivRoundingUp(uint24(width) * uint24(tickSpacing), 2)))

477:                 : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));

476:                 ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))

497:                 return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

495:                 return Math.mulDiv192(amount, uint256(sqrtPriceX96) ** 2);

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

512:                 return Math.mulDiv(amount, 2 ** 192, uint256(sqrtPriceX96) ** 2);

497:                 return Math.mulDiv128(amount, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

514:                 return Math.mulDiv(amount, 2 ** 128, Math.mulDiv64(sqrtPriceX96, sqrtPriceX96));

598:         return LeftRightUnsigned.wrap(0).toRightSlot(amount0).toLeftSlot(amount1);

681:                 bonus0 = int256(Math.mulDiv128(bonusCross, requiredRatioX128));

534:                 int256 absResult = Math

529:                 int256 absResult = Math

557:                 int256 absResult = Math

552:                 int256 absResult = Math

593:             amount0 = Math

587:             amount1 = Math

685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

847:                 haircut0 = Math.min(collateralDelta0, longPremium.rightSlot());

848:                 haircut1 = Math.min(collateralDelta1, longPremium.leftSlot());

810:                     Math.min(

535:                     .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))

535:                     .mulDiv128(Math.absUint(amount), Math.mulDiv64(sqrtPriceX96, sqrtPriceX96))

530:                     .mulDiv192(Math.absUint(amount), uint256(sqrtPriceX96) ** 2)

559:                         Math.absUint(amount),

561:                         Math.mulDiv64(sqrtPriceX96, sqrtPriceX96)

553:                     .mulDiv(Math.absUint(amount), 2 ** 192, uint256(sqrtPriceX96) ** 2)

594:                 .getAmount0ForLiquidity(Math.getLiquidityForAmount1(tickLower, tickUpper, amount1))

588:                 .getAmount1ForLiquidity(Math.getLiquidityForAmount0(tickLower, tickUpper, amount0))

632:                 longs = longs.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));

629:                 shorts = shorts.toLeftSlot(Math.toInt128(amountsMoved.leftSlot()));

624:                 longs = longs.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));

621:                 shorts = shorts.toRightSlot(Math.toInt128(amountsMoved.rightSlot()));

715:                     bonus1 += Math.min(

719:                     bonus0 -= Math.min(

733:                     bonus0 += Math.min(

737:                     bonus1 -= Math.min(

749:                 LeftRightSigned.wrap(0).toRightSlot(int128(balance0 - paid0)).toLeftSlot(

827:                     Math.min(

803:                     -Math.min(

834:                     -Math.min(

869:                         uint256 settled0 = Math.unsafeDivRoundingUp(

873:                         uint256 settled1 = Math.unsafeDivRoundingUp(

933:                     LeftRightSigned

951:                     LeftRightSigned

888:                         settled0 = Math.max(

892:                         settled1 = Math.max(

898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L924-L924) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L263-L263), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L452-L452), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L328-L328), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L326-L326), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L361-L361), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L479-L479), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L678-L678), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L694-L694), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L696-L696), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L791-L791), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L792-L792), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L77-L77), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L155-L155), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L377-L377), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L476-L476), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L497-L497), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L495-L495), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L514-L514), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L512-L512), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L497-L497), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L514-L514), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L598-L598), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L681-L681), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L534-L534), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L529-L529), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L557-L557), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L552-L552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L593-L593), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L587-L587), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L685-L685), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L847-L847), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L848-L848), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L810-L810), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L535-L535), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L535-L535), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L530-L530), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L559-L559), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L561-L561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L553-L553), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L594-L594), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L588-L588), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L632-L632), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L629-L629), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L624-L624), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L621-L621), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L715-L715), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L719-L719), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L733-L733), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L737-L737), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L749-L749), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L827-L827), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L803-L803), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L834-L834), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L869-L869), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L873-L873), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L933-L933), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L951-L951), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L888-L888), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L892-L892), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L898-L898)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

45:         if (!success) revert Errors.TransferFailed();

75:         if (!success) revert Errors.TransferFailed();


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L45-L45) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L75-L75)


```solidity

File: ./contracts/types/LeftRight.sol

163:             ) revert Errors.UnderOverFlow();

186:             ) revert Errors.UnderOverFlow();

199:             if (left128 != left) revert Errors.UnderOverFlow();

204:             if (right128 != right) revert Errors.UnderOverFlow();

222:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

240:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

262:             if (left128 != left256 || right128 != right256) revert Errors.UnderOverFlow();

266:                     int128(Math.max(left128, 0))

265:                 z.toRightSlot(int128(Math.max(right128, 0))).toLeftSlot(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L163-L163) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L186-L186), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L199-L199), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L204-L204), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L222-L222), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L240-L240), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L262-L262), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L266-L266), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L265-L265)


```solidity

File: ./contracts/types/TokenId.sol

598:         revert Errors.NoLegsExercisable();

420:         (legLowerTick, legUpperTick) = PanopticMath.getTicks(

501:         if (self.optionRatio(0) == 0) revert Errors.InvalidTokenIdParameter(1);

582:                 (int24 rangeDown, int24 rangeUp) = PanopticMath.getRangesFromStrike(

528:                 if ((self.width(i) == 0)) revert Errors.InvalidTokenIdParameter(5);

533:                 ) revert Errors.InvalidTokenIdParameter(4);

513:                         revert Errors.InvalidTokenIdParameter(1);

542:                         revert Errors.InvalidTokenIdParameter(3);

548:                     ) revert Errors.InvalidTokenIdParameter(3);

561:                         revert Errors.InvalidTokenIdParameter(4);

567:                         revert Errors.InvalidTokenIdParameter(5);

522:                         revert Errors.InvalidTokenIdParameter(6);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L598-L598) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L420-L420), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L501-L501), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L582-L582), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L528-L528), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L533-L533), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L513-L513), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L542-L542), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L548-L548), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L561-L561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L567-L567), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L522-L522)


</details>


### [NC&#x2011;72] [Solidity]: All `verbatim` blocks are considered identical by deduplicator and can incorrectly be unified 
The block deduplicator is a step of the opcode-based optimizer which identifies equivalent assembly blocks and merges them into a single one. However, when blocks contained `verbatim`, their comparison was performed incorrectly, leading to the collapse of assembly blocks which are identical except for the contents of the ``verbatim`` items. Since `verbatim` is only available in Yul, compilation of Solidity sources is not affected. For more details check the following [link](https://blog.soliditylang.org/2023/11/08/verbatim-invalid-deduplication-bug/)


*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


</details>


### [NC&#x2011;73] [NatSpec] Natspec comment is missing from scope `block` 



*There are 21 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

666:                 {
667:                     int24 range = int24(
668:                         int256(
669:                             Math.unsafeDivRoundingUp(
670:                                 uint24(positionId.width(leg) * positionId.tickSpacing()),
671:                                 2
672:                             )
673:                         )
674:                     );
675:                     maxNumRangesFromStrike = Math.max(
676:                         maxNumRangesFromStrike,
677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)
678:                     );
679:                 }

686:                 {
687:                     LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
688:                         positionId,
689:                         leg,
690:                         positionBalance
691:                     );
692: 
693:                     (currentValue0, currentValue1) = Math.getAmountsForLiquidity(
694:                         currentTick,
695:                         liquidityChunk
696:                     );
697: 
698:                     (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(
699:                         oracleTick,
700:                         liquidityChunk
701:                     );
702:                 }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L666-L679) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L686-L702)


```solidity

File: ./contracts/PanopticPool.sol

750:             {
751:                 (uint128 premiumAccumulator0, uint128 premiumAccumulator1) = SFPM.getAccountPremium(
752:                     address(s_univ3pool),
753:                     address(this),
754:                     tokenId.tokenType(leg),
755:                     tickLower,
756:                     tickUpper,
757:                     type(int24).max,
758:                     isLong
759:                 );
760: 
761:                 // update the premium accumulators
762:                 s_options[msg.sender][tokenId][leg] = LeftRightUnsigned
763:                     .wrap(0)
764:                     .toRightSlot(premiumAccumulator0)
765:                     .toLeftSlot(premiumAccumulator1);
766:             }

984:         {
985:             int128 paid0 = s_collateralToken0.exercise(
986:                 owner,
987:                 longAmounts.rightSlot(),
988:                 shortAmounts.rightSlot(),
989:                 totalSwapped.rightSlot(),
990:                 realizedPremia.rightSlot()
991:             );
992:             paidAmounts = paidAmounts.toRightSlot(paid0);
993:         }

0995:         {
0996:             int128 paid1 = s_collateralToken1.exercise(
0997:                 owner,
0998:                 longAmounts.leftSlot(),
0999:                 shortAmounts.leftSlot(),
1000:                 totalSwapped.leftSlot(),
1001:                 realizedPremia.leftSlot()
1002:             );
1003:             paidAmounts = paidAmounts.toLeftSlot(paid1);
1004:         }

1031:         {
1032:             (, int24 currentTick, , , , , ) = s_univ3pool.slot0();
1033: 
1034:             // Enforce maximum delta between TWAP and currentTick to prevent extreme price manipulation
1035:             if (Math.abs(currentTick - twapTick) > MAX_TWAP_DELTA_LIQUIDATION)
1036:                 revert Errors.StaleTWAP();
1037: 
1038:             uint256[2][] memory positionBalanceArray = new uint256[2][](positionIdList.length);
1039:             (premia, positionBalanceArray) = _calculateAccumulatedPremia(
1040:                 liquidatee,
1041:                 positionIdList,
1042:                 COMPUTE_ALL_PREMIA,
1043:                 ONLY_AVAILABLE_PREMIUM,
1044:                 currentTick
1045:             );
1046:             tokenData0 = s_collateralToken0.getAccountMarginDetails(
1047:                 liquidatee,
1048:                 twapTick,
1049:                 positionBalanceArray,
1050:                 premia.rightSlot()
1051:             );
1052: 
1053:             tokenData1 = s_collateralToken1.getAccountMarginDetails(
1054:                 liquidatee,
1055:                 twapTick,
1056:                 positionBalanceArray,
1057:                 premia.leftSlot()
1058:             );
1059: 
1060:             (uint256 balanceCross, uint256 thresholdCross) = _getSolvencyBalances(
1061:                 tokenData0,
1062:                 tokenData1,
1063:                 Math.getSqrtRatioAtTick(twapTick)
1064:             );
1065: 
1066:             if (balanceCross >= thresholdCross) revert Errors.NotMarginCalled();
1067:         }

1078:         {
1079:             LeftRightSigned netExchanged;
1080:             LeftRightSigned[4][] memory premiasByLeg;
1081:             // burn all options from the liquidatee
1082: 
1083:             // Do not commit any settled long premium to storage - we will do this after we determine if any long premium must be revoked
1084:             // This is to prevent any short positions the liquidatee has being settled with tokens that will later be revoked
1085:             // Note: tick limits are not applied here since it is not the liquidator's position being liquidated
1086:             (netExchanged, premiasByLeg) = _burnAllOptionsFrom(
1087:                 liquidatee,
1088:                 Constants.MIN_V3POOL_TICK,
1089:                 Constants.MAX_V3POOL_TICK,
1090:                 DONOT_COMMIT_LONG_SETTLED,
1091:                 positionIdList
1092:             );
1093: 
1094:             (, finalTick, , , , , ) = s_univ3pool.slot0();
1095: 
1096:             LeftRightSigned collateralRemaining;
1097:             // compute bonus amounts using latest tick data
1098:             (liquidationBonus0, liquidationBonus1, collateralRemaining) = PanopticMath
1099:                 .getLiquidationBonus(
1100:                     tokenData0,
1101:                     tokenData1,
1102:                     Math.getSqrtRatioAtTick(twapTick),
1103:                     Math.getSqrtRatioAtTick(finalTick),
1104:                     netExchanged,
1105:                     premia
1106:                 );
1107: 
1108:             // premia cannot be paid if there is protocol loss associated with the liquidatee
1109:             // otherwise, an economic exploit could occur if the liquidator and liquidatee collude to
1110:             // manipulate the fees in a liquidity area they control past the protocol loss threshold
1111:             // such that the PLPs are forced to pay out premia to the liquidator
1112:             // thus, we haircut any premium paid by the liquidatee (converting tokens as necessary) until the protocol loss is covered or the premium is exhausted
1113:             // note that the haircutPremia function also commits the settled amounts (adjusted for the haircut) to storage, so it will be called even if there is no haircut
1114: 
1115:             // if premium is haircut from a token that is not in protocol loss, some of the liquidation bonus will be converted into that token
1116:             // reusing variables to save stack space; netExchanged = deltaBonus0, premia = deltaBonus1
1117:             address _liquidatee = liquidatee;
1118:             TokenId[] memory _positionIdList = positionIdList;
1119:             int24 _finalTick = finalTick;
1120:             int256 deltaBonus0;
1121:             int256 deltaBonus1;
1122:             (deltaBonus0, deltaBonus1) = PanopticMath.haircutPremia(
1123:                 _liquidatee,
1124:                 _positionIdList,
1125:                 premiasByLeg,
1126:                 collateralRemaining,
1127:                 s_collateralToken0,
1128:                 s_collateralToken1,
1129:                 Math.getSqrtRatioAtTick(_finalTick),
1130:                 s_settledTokens
1131:             );
1132: 
1133:             unchecked {
1134:                 liquidationBonus0 += deltaBonus0;
1135:                 liquidationBonus1 += deltaBonus1;
1136:             }
1137:         }

1204:         {
1205:             // add the premia to the delegated amounts to ensure the user has enough collateral to exercise
1206:             (LeftRightSigned positionPremia, ) = _calculateAccumulatedPremia(
1207:                 account,
1208:                 touchedId,
1209:                 COMPUTE_LONG_PREMIA,
1210:                 ONLY_AVAILABLE_PREMIUM,
1211:                 currentTick
1212:             );
1213: 
1214:             // long premia is represented as negative so subtract it to increase it for the delegated amounts
1215:             delegatedAmounts = delegatedAmounts.sub(positionPremia);
1216:         }

1601:         {
1602:             (int24 tickLower, int24 tickUpper) = tokenId.asTicks(legIndex);
1603: 
1604:             uint256 tokenType = tokenId.tokenType(legIndex);
1605:             (uint128 premiumAccumulator0, uint128 premiumAccumulator1) = SFPM.getAccountPremium(
1606:                 address(s_univ3pool),
1607:                 address(this),
1608:                 tokenType,
1609:                 tickLower,
1610:                 tickUpper,
1611:                 currentTick,
1612:                 1
1613:             );
1614:             accumulatedPremium = LeftRightUnsigned
1615:                 .wrap(0)
1616:                 .toRightSlot(premiumAccumulator0)
1617:                 .toLeftSlot(premiumAccumulator1);
1618: 
1619:             // update the premium accumulator for the long position to the latest value
1620:             // (the entire premia delta will be settled)
1621:             LeftRightUnsigned premiumAccumulatorsLast = s_options[owner][tokenId][legIndex];
1622:             s_options[owner][tokenId][legIndex] = accumulatedPremium;
1623: 
1624:             accumulatedPremium = accumulatedPremium.sub(premiumAccumulatorsLast);
1625:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L750-L766) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L984-L993), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L995-L1004), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1031-L1067), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1078-L1137), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1204-L1216), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1601-L1625)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

887:             {
888:                 // cache the univ3pool, tokenId, isBurn, and _positionSize variables to get rid of stack too deep error
889:                 IUniswapV3Pool _univ3pool = univ3pool;
890:                 TokenId _tokenId = tokenId;
891:                 bool _isBurn = isBurn;
892:                 uint128 _positionSize = positionSize;
893:                 uint256 _leg;
894: 
895:                 unchecked {
896:                     // Reverse the order of the legs if this call is burning a position (LIFO)
897:                     // We loop in reverse order if burning a position so that any dependent long liquidity is returned to the pool first,
898:                     // allowing the corresponding short liquidity to be removed
899:                     _leg = _isBurn ? numLegs - leg - 1 : leg;
900:                 }
901: 
902:                 // for this _leg index: extract the liquidity chunk: a 256bit word containing the liquidity amount and upper/lower tick
903:                 // @dev see `contracts/types/LiquidityChunk.sol`
904:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
905:                     _tokenId,
906:                     _leg,
907:                     _positionSize
908:                 );
909: 
910:                 (_moved, _itmAmounts, _collectedSingleLeg) = _createLegInAMM(
911:                     _univ3pool,
912:                     _tokenId,
913:                     _leg,
914:                     liquidityChunk,
915:                     _isBurn
916:                 );
917: 
918:                 collectedByLeg[_leg] = _collectedSingleLeg;
919: 
920:                 unchecked {
921:                     // increment accumulators of the upper bound on tokens contained across all legs of the position at any given tick
922:                     amount0 += Math.getAmount0ForLiquidity(liquidityChunk);
923: 
924:                     amount1 += Math.getAmount1ForLiquidity(liquidityChunk);
925:                 }
926:             }

0989:         {
0990:             // did we have liquidity already deployed in Uniswap for this chunk range from some past mint?
0991: 
0992:             // s_accountLiquidity is a LeftRight. The right slot represents the liquidity currently sold (added) in the AMM owned by the user
0993:             // the left slot represents the amount of liquidity currently bought (removed) that has been removed from the AMM - the user owes it to a seller
0994:             // the reason why it is called "removedLiquidity" is because long options are created by removing -ie.short selling LP positions
0995:             uint128 startingLiquidity = currentLiquidity.rightSlot();
0996:             uint128 removedLiquidity = currentLiquidity.leftSlot();
0997:             uint128 chunkLiquidity = liquidityChunk.liquidity();
0998: 
0999:             if (isLong == 0) {
1000:                 // selling/short: so move from msg.sender *to* uniswap
1001:                 // we're minting more liquidity in uniswap: so add the incoming liquidity chunk to the existing liquidity chunk
1002:                 updatedLiquidity = startingLiquidity + chunkLiquidity;
1003: 
1004:                 /// @dev If the isLong flag is 0=short but the position was burnt, then this is closing a long position
1005:                 /// @dev so the amount of removed liquidity should decrease.
1006:                 if (isBurn) {
1007:                     removedLiquidity -= chunkLiquidity;
1008:                 }
1009:             } else {
1010:                 // the _leg is long (buying: moving *from* uniswap to msg.sender)
1011:                 // so we seek to move the incoming liquidity chunk *out* of uniswap - but was there sufficient liquidity sitting in uniswap
1012:                 // in the first place?
1013:                 if (startingLiquidity < chunkLiquidity) {
1014:                     // the amount we want to move (liquidityChunk.legLiquidity()) out of uniswap is greater than
1015:                     // what the account that owns the liquidity in uniswap has (startingLiquidity)
1016:                     // we must ensure that an account can only move its own liquidity out of uniswap
1017:                     // so we revert in this case
1018:                     revert Errors.NotEnoughLiquidity();
1019:                 } else {
1020:                     // startingLiquidity is >= chunkLiquidity, so no possible underflow
1021:                     unchecked {
1022:                         // we want to move less than what already sits in uniswap, no problem:
1023:                         updatedLiquidity = startingLiquidity - chunkLiquidity;
1024:                     }
1025:                 }
1026: 
1027:                 /// @dev If the isLong flag is 1=long and the position is minted, then this is opening a long position
1028:                 /// @dev so the amount of removed liquidity should increase.
1029:                 if (!isBurn) {
1030:                     // we can't remove more liquidity than we add in the first place, so this can't overflow
1031:                     unchecked {
1032:                         removedLiquidity += chunkLiquidity;
1033:                     }
1034:                 }
1035:             }
1036: 
1037:             // update the starting liquidity for this position for next time around
1038:             s_accountLiquidity[positionKey] = LeftRightUnsigned
1039:                 .wrap(0)
1040:                 .toLeftSlot(removedLiquidity)
1041:                 .toRightSlot(updatedLiquidity);
1042:         }

1046:         {
1047:             /** if the position is NOT long (selling a put or a call), then _mintLiquidity to move liquidity
1048:                 from the msg.sender to the uniswap v3 pool:
1049:                 Selling(isLong=0): Mint chunk of liquidity in Uniswap (defined by upper tick, lower tick, and amount)
1050:                        bbabababababababababababababababababababababababababababababababababa
1051:                 ba2     bba<ba liquidityChunk                 ba
1052:                 ba  bbabab4bab4bababa                         bbababab4bababa
1053:                 ba  ba       ba                         ba      ba
1054:                 bbabab4bababababababab4bababa:                      bbababababababa
1055:                    Uniswap v3                      msg.sender
1056:             
1057:              else: the position is long (buying a put or a call), then _burnLiquidity to remove liquidity from univ3
1058:                 Buying(isLong=1): Burn in Uniswap
1059:                        bbabababababababababababababababababa
1060:                 ba2     bb<ba                ba
1061:                 ba  bbabab4bab4bababa         bbabababa<bababa
1062:                 ba  ba       ba         ba      ba
1063:                 bbabab4bababababababab4bababa:      bbababababababa
1064:                     Uniswap v3      msg.sender 
1065:             */
1066:             moved = isLong == 0
1067:                 ? _mintLiquidity(liquidityChunk, univ3pool)
1068:                 : _burnLiquidity(liquidityChunk, univ3pool); // from msg.sender to Uniswap
1069:             // add the moved liquidity chunk to amount we need to collect from uniswap:
1070: 
1071:             // Is this _leg ITM?
1072:             // if tokenType is 1, and we transacted some token0: then this leg is ITM!
1073:             if (tokenType == 1) {
1074:                 // extract amount moved out of UniswapV3 pool
1075:                 itmAmounts = itmAmounts.toRightSlot(moved.rightSlot());
1076:             }
1077:             // if tokenType is 0, and we transacted some token1: then this leg is ITM
1078:             if (tokenType == 0) {
1079:                 // Add this in-the-money amount transacted.
1080:                 itmAmounts = itmAmounts.toLeftSlot(moved.leftSlot());
1081:             }
1082:         }

1345:             {
1346:                 uint128 collected0 = collectedAmounts.rightSlot();
1347:                 uint128 collected1 = collectedAmounts.leftSlot();
1348: 
1349:                 // compute the base premium as collected * total / net^2 (from Eqn 3)
1350:                 premium0X64_base = Math.mulDiv(
1351:                     collected0,
1352:                     totalLiquidity * 2 ** 64,
1353:                     netLiquidity ** 2
1354:                 );
1355:                 premium1X64_base = Math.mulDiv(
1356:                     collected1,
1357:                     totalLiquidity * 2 ** 64,
1358:                     netLiquidity ** 2
1359:                 );
1360:             }

1362:             {
1363:                 uint128 premium0X64_owed;
1364:                 uint128 premium1X64_owed;
1365:                 {
1366:                     // compute the owed premium (from Eqn 3)
1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);
1368: 
1369:                     premium0X64_owed = Math
1370:                         .mulDiv(premium0X64_base, numerator, totalLiquidity)
1371:                         .toUint128Capped();
1372:                     premium1X64_owed = Math
1373:                         .mulDiv(premium1X64_base, numerator, totalLiquidity)
1374:                         .toUint128Capped();
1375: 
1376:                     deltaPremiumOwed = LeftRightUnsigned
1377:                         .wrap(0)
1378:                         .toRightSlot(premium0X64_owed)
1379:                         .toLeftSlot(premium1X64_owed);
1380:                 }
1381:             }

1383:             {
1384:                 uint128 premium0X64_gross;
1385:                 uint128 premium1X64_gross;
1386:                 {
1387:                     // compute the gross premium (from Eqn 4)
1388:                     uint256 numerator = totalLiquidity ** 2 -
1389:                         totalLiquidity *
1390:                         removedLiquidity +
1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));
1392: 
1393:                     premium0X64_gross = Math
1394:                         .mulDiv(premium0X64_base, numerator, totalLiquidity ** 2)
1395:                         .toUint128Capped();
1396:                     premium1X64_gross = Math
1397:                         .mulDiv(premium1X64_base, numerator, totalLiquidity ** 2)
1398:                         .toUint128Capped();
1399: 
1400:                     deltaPremiumGross = LeftRightUnsigned
1401:                         .wrap(0)
1402:                         .toRightSlot(premium0X64_gross)
1403:                         .toLeftSlot(premium1X64_gross);
1404:                 }
1405:             }

1365:                 {
1366:                     // compute the owed premium (from Eqn 3)
1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);
1368: 
1369:                     premium0X64_owed = Math
1370:                         .mulDiv(premium0X64_base, numerator, totalLiquidity)
1371:                         .toUint128Capped();
1372:                     premium1X64_owed = Math
1373:                         .mulDiv(premium1X64_base, numerator, totalLiquidity)
1374:                         .toUint128Capped();
1375: 
1376:                     deltaPremiumOwed = LeftRightUnsigned
1377:                         .wrap(0)
1378:                         .toRightSlot(premium0X64_owed)
1379:                         .toLeftSlot(premium1X64_owed);
1380:                 }

1386:                 {
1387:                     // compute the gross premium (from Eqn 4)
1388:                     uint256 numerator = totalLiquidity ** 2 -
1389:                         totalLiquidity *
1390:                         removedLiquidity +
1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));
1392: 
1393:                     premium0X64_gross = Math
1394:                         .mulDiv(premium0X64_base, numerator, totalLiquidity ** 2)
1395:                         .toUint128Capped();
1396:                     premium1X64_gross = Math
1397:                         .mulDiv(premium1X64_base, numerator, totalLiquidity ** 2)
1398:                         .toUint128Capped();
1399: 
1400:                     deltaPremiumGross = LeftRightUnsigned
1401:                         .wrap(0)
1402:                         .toRightSlot(premium0X64_gross)
1403:                         .toLeftSlot(premium1X64_gross);
1404:                 }

1471:                 {
1472:                     IUniswapV3Pool _univ3pool = IUniswapV3Pool(univ3pool);
1473:                     int24 _tickLower = tickLower;
1474:                     int24 _tickUpper = tickUpper;
1475: 
1476:                     // how much fees have been accumulated within the liquidity chunk since last time we updated this chunk?
1477:                     // Compute (currentFeesGrowth - oldFeesGrowth), the amount to collect
1478:                     // currentFeesGrowth (calculated from FeesCalc.calculateAMMSwapFeesLiquidityChunk) is (ammFeesCollectedPerLiquidity * liquidityChunk.liquidity())
1479:                     // oldFeesGrowth is the last stored update of fee growth within the position range in the past (feeGrowthRange*liquidityChunk.liquidity()) (s_accountFeesBase[positionKey])
1480:                     LeftRightSigned feesBase = FeesCalc.calculateAMMSwapFees(
1481:                         _univ3pool,
1482:                         atTick,
1483:                         _tickLower,
1484:                         _tickUpper,
1485:                         netLiquidity
1486:                     );
1487: 
1488:                     // If the current feesBase is close or identical to the stored one, the amountToCollect can be negative.
1489:                     // This is because the stored feesBase is rounded up, and the current feesBase is rounded down.
1490:                     // When this is the case, we want to behave as if there are 0 fees, so we just rectify the values.
1491:                     // Guaranteed to be positive, so swap to unsigned type
1492:                     amountToCollect = LeftRightUnsigned.wrap(
1493:                         uint256(
1494:                             LeftRightSigned.unwrap(feesBase.subRect(s_accountFeesBase[positionKey]))
1495:                         )
1496:                     );
1497:                 }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L887-L926) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L989-L1042), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1046-L1082), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1345-L1360), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1362-L1381), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1383-L1405), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1365-L1380), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1386-L1404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1471-L1497)


```solidity

File: ./contracts/libraries/PanopticMath.sol

185:                 {
186:                     (uint256 timestamp_old, int56 tickCumulative_old, , ) = univ3pool.observations(
187:                         uint256(
188:                             int256(observationIndex) - int256(1) + int256(observationCardinality)
189:                         ) % observationCardinality
190:                     );
191: 
192:                     (uint256 timestamp_last, int56 tickCumulative_last, , ) = univ3pool
193:                         .observations(observationIndex);
194:                     lastObservedTick = int24(
195:                         (tickCumulative_last - tickCumulative_old) /
196:                             int256(timestamp_last - timestamp_old)
197:                     );
198:                 }

661:             {
662:                 // compute the ratio of token0 to total collateral requirements
663:                 // evaluate at TWAP price to keep consistentcy with solvency calculations
664:                 uint256 required0 = PanopticMath.convert0to1(
665:                     tokenData0.leftSlot(),
666:                     sqrtPriceX96Twap
667:                 );
668:                 uint256 required1 = tokenData1.leftSlot();
669:                 uint256 requiredRatioX128 = (required0 << 128) / (required0 + required1);
670: 
671:                 (uint256 balanceCross, uint256 thresholdCross) = PanopticMath.convertCollateralData(
672:                     tokenData0,
673:                     tokenData1,
674:                     0,
675:                     sqrtPriceX96Twap
676:                 );
677: 
678:                 uint256 bonusCross = Math.min(balanceCross / 2, thresholdCross - balanceCross);
679: 
680:                 // convert that bonus to tokens 0 and 1
681:                 bonus0 = int256(Math.mulDiv128(bonusCross, requiredRatioX128));
682: 
683:                 bonus1 = int256(
684:                     PanopticMath.convert0to1(
685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),
686:                         sqrtPriceX96Final
687:                     )
688:                 );
689:             }

854:             {
855:                 address _liquidatee = liquidatee;
856:                 if (haircut0 != 0) collateral0.exercise(_liquidatee, 0, 0, 0, int128(haircut0));
857:                 if (haircut1 != 0) collateral1.exercise(_liquidatee, 0, 0, 0, int128(haircut1));
858:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L185-L198) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L661-L689), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L854-L858)


</details>


### [NC&#x2011;74] Not using the latest version of `prb-math` from dependencies 
`prb-math` is an important mathematical library The package.json configuration file says that the project is using an old version of `prb-math`.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: package.json

//@audit `prb-math` version is 
1: 


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//package.json#L1-L1) 


</details>


### [NC&#x2011;75] Non constant/immutable state variables are missing a setter post deployment 
Non-constant or non-immutable state variables lacking a setter function can create inflexibility in contract operations. If there's no way to update these variables post-deployment, the contract might not adapt to changing conditions or requirements, which can be a significant drawback, especially in upgradable or long-lived contracts. To resolve this, implement setter functions guarded by appropriate access controls, like `onlyOwner` or similar modifiers, so that these variables can be updated as required while maintaining security. This enables smoother contract maintenance and feature upgrades.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/PanopticPool.sol

238:     mapping(address account => mapping(TokenId tokenId => mapping(uint256 leg => LeftRightUnsigned premiaGrowth)))
239:         internal s_options;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L238-L239) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

287:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumOwed;

289:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumGross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L287-L287) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L289-L289)


</details>


### [NC&#x2011;76] Consider making private state variables internal to increase flexibility 
In Solidity, `private` state variables are strictly confined to the contract they are defined in and can't be accessed or modified by its derived contracts. While this offers strong encapsulation, it can limit contract extensibility and modification in inheritance chains. On the other hand, `internal` variables can be accessed and potentially overridden by child contracts, granting more flexibility in contract development and upgrades. Therefore, it's recommended to use `private` only when you explicitly want to prevent child contract access. Otherwise, prefer `internal` to maintain a balance between encapsulation and the flexibility offered by inheritance patterns in Solidity.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/SemiFungiblePositionManager.sol

133:     uint128 private constant VEGOID = 2;

287:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumOwed;

289:     mapping(bytes32 positionKey => LeftRightUnsigned accountPremium) private s_accountPremiumGross;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L133-L133) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L287-L287), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L289-L289)


</details>


### [NC&#x2011;77] Off-by-one timestamp error 
In Solidity, using `>=` or `<=` to compare against `block.timestamp` (alias `now`) may introduce off-by-one errors due to the fact that `block.timestamp` is only updated once per block and its value remains constant throughout the block's execution. If an operation happens at the exact second when `block.timestamp` changes, it could result in unexpected behavior. To avoid this, it's safer to use strict inequality operators (`>` or `<`). For instance, if a condition should only be met after a certain time, use `block.timestamp > time` rather than `block.timestamp >= time`. This way, potential off-by-one errors due to the exact timing of block mining are mitigated, leading to safer, more predictable contract behavior.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/PanopticMath.sol

183:             if (block.timestamp >= uint256(uint40(medianData >> 216)) + period) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L183-L183) 


</details>


### [NC&#x2011;78] Lack of space near the operator 
Lack of space near operators in code can lead to reduced readability, making it more challenging to distinguish between different elements and understand the logic quickly. As a resolution, always include spaces around operators to ensure a clear visual separation, which promotes better maintainability and comprehension of the code.


*There are 80 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit operator : /
849:                 (BUYER_COLLATERAL_RATIO +
850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

//@audit operator : +
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

//@audit operator : +
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : +
849:                 (BUYER_COLLATERAL_RATIO +
850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +

//@audit operator : +
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +

//@audit operator : /
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : /
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3

//@audit operator : -
727:             int256 fee = (FORCE_EXERCISE_COST >> (maxNumRangesFromStrike - 1)); // exponential decay of fee based on number of half ranges away from the price

//@audit operator : /
850:                     (BUYER_COLLATERAL_RATIO * (SATURATED_POOL_UTIL - utilization)) /
851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

//@audit operator : /
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +

//@audit operator : /
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +

//@audit operator : *
207:                     (6510 * ratioTick ** 3) /

//@audit operator : -
851:                     (SATURATED_POOL_UTIL - TARGET_POOL_UTIL)) / 2; // do the division by 2 at the end after all addition and multiplication; b/c y1 = buyCollateralRatio / 2

//@audit operator : *
205:                     (7812 * ratioTick ** 2) /


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L849-L851) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1637-L1638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1637-L1638), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L849-L851), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L206), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L202-L206), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L207-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L207-L208), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L727-L727), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L850-L851), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L205-L206), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L205-L206), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L207-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L851-L851), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L205-L205)


```solidity

File: ./contracts/PanopticPool.sol

//@audit operator : *
165:     uint64 internal constant MAX_SPREAD = 9 * (2 ** 32);

1415:         if ((newHash >> 248) > MAX_POSITIONS) revert Errors.TooManyPositionsOpen();

//@audit operator : /
1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *
1769:                 totalLiquidity) / 2 ** 64;

//@audit operator : /
1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *
1771:                 totalLiquidity) / 2 ** 64;

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4
314:                 (uint256(uint24(currentTick))); // add to slot 3

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4
314:                 (uint256(uint24(currentTick))); // add to slot 3

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4
314:                 (uint256(uint24(currentTick))); // add to slot 3

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4
314:                 (uint256(uint24(currentTick))); // add to slot 3

//@audit operator : +
1348:                 Math.mulDiv(uint256(tokenData1.rightSlot()), 2 ** 96, sqrtPriceX96) +
1349:                 Math.mulDiv96(tokenData0.rightSlot(), sqrtPriceX96);

//@audit operator : +
1353:                 Math.mulDivRoundingUp(uint256(tokenData1.leftSlot()), 2 ** 96, sqrtPriceX96) +
1354:                 Math.mulDiv96RoundingUp(tokenData0.leftSlot(), sqrtPriceX96);

//@audit operator : /
1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +
313:                 (uint256(uint24(currentTick)) << 24) + // add to slot 4

//@audit operator : *
1768:             uint256 accumulated0 = ((premiumAccumulators[0] - grossPremiumLast.rightSlot()) *
1769:                 totalLiquidity) / 2 ** 64;

//@audit operator : *
1770:             uint256 accumulated1 = ((premiumAccumulators[1] - grossPremiumLast.leftSlot()) *
1771:                 totalLiquidity) / 2 ** 64;

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +

//@audit operator : +
309:                 (uint256(block.timestamp) << 216) +
310:                 // magic number which adds (7,5,3,1,0,2,4,6) order and minTick in positions 7, 5, 3 and maxTick in 6, 4, 2
311:                 // see comment on s_miniMedian initialization for format of this magic number
312:                 (uint256(0xF590A6F276170D89E9F276170D89E9F276170D89E9000000000000)) +

//@audit operator : *
1487:             effectiveLiquidityFactorX32 = (uint256(totalLiquidity) * 2 ** 32) / netLiquidity;

//@audit operator : /
1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

//@audit operator : *
1636:                 .toLeftSlot(int128(int256((accumulatedPremium.leftSlot() * liquidity) / 2 ** 64)));

//@audit operator : /
1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

//@audit operator : *
1635:                 .toRightSlot(int128(int256((accumulatedPremium.rightSlot() * liquidity) / 2 ** 64)))

//@audit operator : /
1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
1560:                                         premiumAccumulatorLast.leftSlot()) *
1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

//@audit operator : *
1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
1560:                                         premiumAccumulatorLast.leftSlot()) *
1561:                                         (liquidityChunk.liquidity())) / 2 ** 64

//@audit operator : /
1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
1551:                                         premiumAccumulatorLast.rightSlot()) *
1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

//@audit operator : /
1950:                                         uint256(
1951:                                             Math.max(
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,
1960:                                                 0
1961:                                             )
1962:                                         ) / totalLiquidity

//@audit operator : *
1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
1551:                                         premiumAccumulatorLast.rightSlot()) *
1552:                                         (liquidityChunk.liquidity())) / 2 ** 64

//@audit operator : /
1933:                                         uint256(
1934:                                             Math.max(
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),
1943:                                                 0
1944:                                             )
1945:                                         ) / totalLiquidity

//@audit operator : +
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

//@audit operator : *
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

//@audit operator : -
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,

//@audit operator : +
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

//@audit operator : -
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),

//@audit operator : *
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L165-L165) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1415-L1415), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1768-L1769), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1770-L1771), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1348-L1349), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1353-L1354), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1487-L1487), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L313), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1768-L1769), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1770-L1771), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L309-L312), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1487-L1487), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1636-L1636), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1635-L1635), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1559-L1561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1559-L1561), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1550-L1552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1950-L1962), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1550-L1552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1933-L1945), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1952-L1959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1959-L1959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1952-L1959), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1935-L1942), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1935-L1942), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1942-L1942)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit operator : +
388:             s_AddrToPoolIdData[univ3pool] = uint256(poolId) + 2 ** 255;

//@audit operator : +
1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

//@audit operator : +
1388:                     uint256 numerator = totalLiquidity ** 2 -
1389:                         totalLiquidity *
1390:                         removedLiquidity +
1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

//@audit operator : +
1388:                     uint256 numerator = totalLiquidity ** 2 -
1389:                         totalLiquidity *
1390:                         removedLiquidity +
1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));

//@audit operator : *
1352:                     totalLiquidity * 2 ** 64,

//@audit operator : *
1357:                     totalLiquidity * 2 ** 64,

//@audit operator : -
1388:                     uint256 numerator = totalLiquidity ** 2 -
1389:                         totalLiquidity *
1390:                         removedLiquidity +

//@audit operator : -
1297:                     ? receivedAmount0 - uint128(-movedInLeg.rightSlot())

//@audit operator : -
1300:                     ? receivedAmount1 - uint128(-movedInLeg.leftSlot())

//@audit operator : /
1367:                     uint256 numerator = netLiquidity + (removedLiquidity / 2 ** VEGOID);

//@audit operator : /
1391:                         ((removedLiquidity ** 2) / 2 ** (VEGOID));


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L388-L388) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1367-L1367), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1388-L1391), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1388-L1391), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1352-L1352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1357-L1357), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1388-L1390), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1297-L1297), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1300-L1300), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1367-L1367), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1391-L1391)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit operator : -
166:                 feeGrowthInside0X128 = lowerOut0 - upperOut0; // fee growth inside the chunk


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L166-L166) 


```solidity

File: ./contracts/libraries/Math.sol

//@audit operator : -
15:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

//@audit operator : *
511:             prod0 |= prod1 * 2 ** 192;

//@audit operator : *
574:             prod0 |= prod1 * 2 ** 160;

//@audit operator : *
651:             prod0 |= prod1 * 2 ** 128;

//@audit operator : *
728:             prod0 |= prod1 * 2 ** 64;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L15-L15) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L511-L511), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L574-L574), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L651-L651), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L728-L728)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit operator : -
23:     uint256 internal constant MAX_UINT256 = 2 ** 256 - 1;

//@audit operator : +
137:             for (uint256 i = 0; i < cardinality + 1; ++i) {

//@audit operator : -
685:                         Math.mulDiv128(bonusCross, 2 ** 128 - requiredRatioX128),

//@audit operator : *
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),

//@audit operator : *
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),

//@audit operator : -
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0

//@audit operator : -
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L23-L23) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L137-L137), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L685-L685), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L870-L870), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L874-L874), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L890-L890), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L894-L894)


```solidity

File: ./contracts/types/TokenId.sol

//@audit operator : %
98:             return int24(uint24((TokenId.unwrap(self) >> 48) % 2 ** 16));

//@audit operator : +
520:                 for (uint256 j = i + 1; j < numLegs; ++j) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L98-L98) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L520-L520)


</details>


### [NC&#x2011;79] Incorrect withdraw declaration 
In Solidity, it's essential for clarity and interoperability to correctly specify return types in function declarations. If the `withdraw` function is expected to return a `bool` to indicate success or failure, its omission could lead to ambiguity or unexpected behavior when interacting with or calling this function from other contracts or off-chain systems. Missing return values can mislead developers and potentially lead to contract integrations built on incorrect assumptions. To resolve this, the function declaration for `withdraw` should be modified to explicitly include the `bool` return type, ensuring clarity and correctness in contract interactions.


*There are 1 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

531:     function withdraw(
532:         uint256 assets,
533:         address receiver,
534:         address owner
535:     ) external returns (uint256 shares) {
536:         if (assets > maxWithdraw(owner)) revert Errors.ExceedsMaximumRedemption();
537: 
538:         shares = previewWithdraw(assets);
539: 
540:         // check/update allowance for approved withdraw
541:         if (msg.sender != owner) {
542:             uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.
543: 
544:             if (allowed != type(uint256).max) allowance[owner][msg.sender] = allowed - shares;
545:         }
546: 
547:         // burn collateral shares of the Panoptic Pool funds (this ERC20 token)
548:         _burn(owner, shares);
549: 
550:         // update tracked asset balance
551:         unchecked {
552:             s_poolAssets -= uint128(assets);
553:         }
554: 
555:         // transfer assets (underlying token funds) from the PanopticPool to the LP
556:         SafeTransferLib.safeTransferFrom(
557:             s_underlyingToken,
558:             address(s_panopticPool),
559:             receiver,
560:             assets
561:         );
562: 
563:         emit Withdraw(msg.sender, receiver, owner, assets, shares);
564: 
565:         return shares;
566:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L531-L566) 


</details>


### [NC&#x2011;80] Avoid mutating function parameters 
Function parameters in Solidity are passed by value, meaning they are essentially local copies. Mutating them can lead to confusion and errors because the changes don't persist outside the function. By keeping function parameters immutable, you ensure clarity in code behavior, preventing unintended side-effects. If you need to modify a value based on a parameter, use a local variable inside the function, leaving the original parameter unaltered. By adhering to this practice, you maintain a clear distinction between input data and the internal processing logic, improving code readability and reducing the potential for bugs.


*There are 5 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit the following parameters are mutated utilization,
751:     function _sellCollateralRatio(
752:         int256 utilization
753:     ) internal view returns (uint256 sellCollateralRatio) {
754:         // the sell ratio is on a straight line defined between two points (x0,y0) and (x1,y1):
755:         //   (x0,y0) = (targetPoolUtilization,min_sell_ratio) and
756:         //   (x1,y1) = (saturatedPoolUtilization,max_sell_ratio)
757:         // the line's formula: y = a * (x - x0) + y0, where a = (y1 - y0) / (x1 - x0)
758:         /**
759:             SELL
760:             COLLATERAL
761:             RATIO
762:                           ^
763:                           |                  max ratio = 100%
764:                    100% - |                _------
765:                           |             _-B/
766:                           |          _-B/
767:                     20% - |---------B/
768:                           |         .       . .
769:                           +---------+-------+-+--->   POOL_
770:                                    50%    90% 100%     UTILIZATION
771:         */
772: 
773:         uint256 min_sell_ratio = SELLER_COLLATERAL_RATIO;
774:         /// if utilization is less than zero, this is the calculation for a strangle, which gets 2x the capital efficiency at low pool utilization
775:         /// at 0% utilization, strangle legs do not compound efficiency
776:         if (utilization < 0) {
777:             unchecked {
778:                 min_sell_ratio /= 2;
779:                 utilization = -utilization;
780:             }
781:         }
782: 
783:         // return the basal sell ratio if pool utilization is lower than target
784:         if (uint256(utilization) < TARGET_POOL_UTIL) {
785:             return min_sell_ratio;
786:         }
787: 
788:         // return 100% collateral ratio if utilization is above saturated pool utilization
789:         // this means all new positions are fully collateralized, which reduces risks of insolvency at high pool utilization
790:         if (uint256(utilization) > SATURATED_POOL_UTIL) {
791:             return DECIMALS;
792:         }
793: 
794:         unchecked {
795:             return
796:                 min_sell_ratio +
797:                 ((DECIMALS - min_sell_ratio) * (uint256(utilization) - TARGET_POOL_UTIL)) /
798:                 (SATURATED_POOL_UTIL - TARGET_POOL_UTIL);
799:         }
800:     }

//@audit the following parameters are mutated poolUtilization,
1600:     function _computeStrangle(
1601:         TokenId tokenId,
1602:         uint256 index,
1603:         uint128 positionSize,
1604:         int24 atTick,
1605:         uint128 poolUtilization
1606:     ) internal view returns (uint256 strangleRequired) {
1607:         // If both tokenTypes are the same, then this is a long or short strangle.
1608:         // A strangle is an options strategy in which the investor holds a position
1609:         // in both a call and a put option with different strike prices,
1610:         // but with the same expiration date and underlying asset.
1611: 
1612:         /// collateral requirement is for short strangles depicted:
1613:         /**
1614:                     Put side of a short strangle, BPR = 100% - (100% - SCR/2)*(price/strike)
1615:            BUYING
1616:            POWER
1617:            REQUIREMENT
1618:                          ^                    .
1619:                          |           <- ITM   .  OTM ->
1620:                   100% - |--__                .
1621:                          |    B/B/--__          .
1622:                          |          B/B/--__    .
1623:                  SCR/2 - |                B/B/--______ <------ base collateral is half that of a single-leg
1624:                          +--------------------+--->   current
1625:                          0                  strike     price
1626:          */
1627:         unchecked {
1628:             // A negative pool utilization is used to denote a position which is a strangle
1629:             // at low pool utilization's strangle legs are evaluated at 2x capital efficiency
1630: 
1631:             uint64 poolUtilization0 = uint64(poolUtilization);
1632:             uint64 poolUtilization1 = uint64(poolUtilization >> 64);
1633: 
1634:             // add 1 to handle poolUtilization = 0
1635: 
1636:             poolUtilization =
1637:                 uint128(uint64(-int64(poolUtilization0 == 0 ? 1 : poolUtilization0))) +
1638:                 (uint128(uint64(-int64(poolUtilization1 == 0 ? 1 : poolUtilization1))) << 64);
1639: 
1640:             return
1641:                 strangleRequired = _getRequiredCollateralSingleLegNoPartner(
1642:                     tokenId,
1643:                     index,
1644:                     positionSize,
1645:                     atTick,
1646:                     poolUtilization
1647:                 );
1648:         }
1649:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L751-L800) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1600-L1649)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit the following parameters are mutated salt,
290:     function minePoolAddress(
291:         bytes32 salt,
292:         uint256 loops,
293:         uint256 minTargetRarity
294:     ) external view returns (bytes32 bestSalt, uint256 highestRarity) {
295:         // Start at the given 'salt' value (a checkpoint used to continue mining across multiple calls)
296: 
297:         // Runs until 'bestSalt' reaches 'minTargetRarity' or for 'loops', whichever comes first
298:         uint256 maxSalt;
299:         unchecked {
300:             maxSalt = uint256(salt) + loops;
301:         }
302: 
303:         for (; uint256(salt) < maxSalt; ) {
304:             uint256 rarity = PanopticMath.numberOfLeadingHexZeros(
305:                 POOL_REFERENCE.predictDeterministicAddress(salt)
306:             );
307: 
308:             if (rarity > highestRarity) {
309:                 // found a more rare address at this nonce
310:                 highestRarity = rarity;
311:                 bestSalt = salt;
312:             }
313: 
314:             if (rarity >= minTargetRarity) {
315:                 // desired target met
316:                 highestRarity = rarity;
317:                 bestSalt = salt;
318:                 break;
319:             }
320: 
321:             unchecked {
322:                 // increment the nonce of `currentSalt` (lower 96 bits)
323:                 salt = bytes32(uint256(salt) + 1);
324:             }
325:         }
326:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L290-L326) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit the following parameters are mutated tokenId,
680:     function _validateAndForwardToAMM(
681:         TokenId tokenId,
682:         uint128 positionSize,
683:         int24 tickLimitLow,
684:         int24 tickLimitHigh,
685:         bool isBurn
686:     ) internal returns (LeftRightUnsigned[4] memory collectedByLeg, LeftRightSigned totalMoved) {
687:         // Reverts if positionSize is 0 and user did not own the position before minting/burning
688:         if (positionSize == 0) revert Errors.OptionsBalanceZero();
689: 
690:         /// @dev the flipToBurnToken() function flips the isLong bits
691:         if (isBurn) {
692:             tokenId = tokenId.flipToBurnToken();
693:         }
694: 
695:         // Validate tokenId
696:         tokenId.validate();
697: 
698:         // Extract univ3pool from the poolId map to Uniswap Pool
699:         IUniswapV3Pool univ3pool = s_poolContext[tokenId.poolId()].pool;
700: 
701:         // Revert if the pool not been previously initialized
702:         if (univ3pool == IUniswapV3Pool(address(0))) revert Errors.UniswapPoolNotInitialized();
703: 
704:         // initialize some variables returned by the _createPositionInAMM function
705:         LeftRightSigned itmAmounts;
706: 
707:         // calls a function that loops through each leg of tokenId and mints/burns liquidity in Uni v3 pool
708:         (totalMoved, collectedByLeg, itmAmounts) = _createPositionInAMM(
709:             univ3pool,
710:             tokenId,
711:             positionSize,
712:             isBurn
713:         );
714: 
715:         if (tickLimitLow > tickLimitHigh) {
716:             // if the in-the-money amount is not zero (i.e. positions were minted ITM) and the user did provide tick limits LOW > HIGH, then swap necessary amounts
717:             if ((LeftRightSigned.unwrap(itmAmounts) != 0)) {
718:                 totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);
719:             }
720: 
721:             (tickLimitLow, tickLimitHigh) = (tickLimitHigh, tickLimitLow);
722:         }
723: 
724:         // Get the current tick of the Uniswap pool, check slippage
725:         (, int24 currentTick, , , , , ) = univ3pool.slot0();
726: 
727:         if ((currentTick >= tickLimitHigh) || (currentTick <= tickLimitLow))
728:             revert Errors.PriceBoundFail();
729:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L680-L729) 


```solidity

File: ./contracts/libraries/Math.sol

//@audit the following parameters are mutated x,
091:     function mostSignificantNibble(uint160 x) internal pure returns (uint256 r) {
092:         unchecked {
093:             if (x >= 0x100000000000000000000000000000000) {
094:                 x >>= 128;
095:                 r += 32;
096:             }
097:             if (x >= 0x10000000000000000) {
098:                 x >>= 64;
099:                 r += 16;
100:             }
101:             if (x >= 0x100000000) {
102:                 x >>= 32;
103:                 r += 8;
104:             }
105:             if (x >= 0x10000) {
106:                 x >>= 16;
107:                 r += 4;
108:             }
109:             if (x >= 0x100) {
110:                 x >>= 8;
111:                 r += 2;
112:             }
113:             if (x >= 0x10) {
114:                 r += 1;
115:             }
116:         }
117:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L91-L117) 


</details>


### [NC&#x2011;81] A event should be emitted if a non immutable state variable is set in a constructor 



*There are 16 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

187:         COMMISSION_FEE = _commissionFee;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

190:         FORCE_EXERCISE_COST = _forceExerciseCost;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;

201:             TICK_DEVIATION = uint256(
202:                 2230 +
203:                     (12500 * ratioTick) /
204:                     10_000 +
205:                     (7812 * ratioTick ** 2) /
206:                     10_000 ** 2 +
207:                     (6510 * ratioTick ** 3) /
208:                     10_000 ** 3
209:             );


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L187-L187) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L188-L188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L189-L189), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L190-L190), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L191-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L192-L192), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L201-L209)


```solidity

File: ./contracts/PanopticFactory.sol

123:         WETH = _WETH9;

124:         SFPM = _SFPM;

125:         DONOR_NFT = _donorNFT;

127:         UNIV3_FACTORY = _univ3Factory;

128:         POOL_REFERENCE = _poolReference;

129:         COLLATERAL_REFERENCE = _collateralReference;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L123-L123) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L124-L124), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L125-L125), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L127-L127), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L129-L129)


```solidity

File: ./contracts/PanopticPool.sol

281:         SFPM = _sfpm;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L281-L281) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

342:         FACTORY = _factory;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L342-L342) 


</details>


### [NC&#x2011;82] Contracts use both += 1 and ++ (-- and -= 1) 
For consistency consider only using one of these incrementing methods. The instances bellow represents the less used technique.


*There are 3 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/libraries/Math.sol

114:                 r += 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L114-L114) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

212:                         shift -= 1;

219:                         shift += 1;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L212-L212) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L219-L219)


</details>


### [NC&#x2011;83] [Solidity]: Order of Argument Evaluation Disrupted in Non-Expression-Split Code by Optimizer Sequences with FullInliner 
Function call arguments in Yul are evaluated right to left. This order matters when the argument expressions have side-effects, and changing it may change contract behavior. FullInliner is an optimizer step that can replace a function call with the body of that function. The transformation involves assigning argument expressions to temporary variables, which imposes an explicit evaluation order. FullInliner was written with the assumption that this order does not necessarily have to match usual argument evaluation order because the argument expressions have no side-effects. In most circumstances this assumption is true because the default optimization step sequence contains the ExpressionSplitter step. ExpressionSplitter ensures that the code is in *expression-split form*, which means that function calls cannot appear nested inside expressions, and all function call arguments have to be variables. The assumption is, however, not guaranteed to be true in general. Version 0.6.7 introduced a setting allowing users to specify an arbitrary optimization step sequence, making it possible for the FullInliner to actually encounter argument expressions with side-effects, which can result in behavior differences between optimized and unoptimized bytecode. Contracts compiled without optimization or with the default optimization sequence are not affected. To trigger the bug the user has to explicitly choose compiler settings that contain a sequence with FullInliner step not preceded by ExpressionSplitter. [Ref](https://blog.soliditylang.org/2023/07/19/full-inliner-non-expression-split-argument-evaluation-order-bug/)


*There are 20 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L2-L2) 


```solidity

File: ./contracts/PanopticFactory.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L2-L2) 


```solidity

File: ./contracts/PanopticPool.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L2-L2) 


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L2-L2) 


```solidity

File: ./contracts/libraries/CallbackLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/CallbackLib.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Constants.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Constants.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Errors.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Errors.sol#L2-L2) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L2-L2) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L2-L2) 


```solidity

File: ./contracts/libraries/Math.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L2-L2) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L2-L2) 


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L2-L2) 


```solidity

File: ./contracts/multicall/Multicall.sol

2: pragma solidity ^0.8.18;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/multicall/Multicall.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L2-L2) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L2-L2) 


```solidity

File: ./contracts/types/LeftRight.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L2-L2) 


```solidity

File: ./contracts/types/LiquidityChunk.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L2-L2) 


```solidity

File: ./contracts/types/TokenId.sol

2: pragma solidity ^0.8.0;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L2-L2) 


</details>


### [NC&#x2011;84] Not using the named return variables anywhere in the function is confusing 
Consider changing the variable to be an unnamed one, since the variable is never assigned, nor is it returned by name. If the optimizer is not turned on, leaving the code as it is will also waste gas for the stack variable.


*There are 17 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

// @audit assetTokenAddress
361:     function asset() external view returns (address assetTokenAddress) {

// @audit totalManagedAssets
370:     function totalAssets() public view returns (uint256 totalManagedAssets) {

// @audit shares
379:     function convertToShares(uint256 assets) public view returns (uint256 shares) {

// @audit assets
386:     function convertToAssets(uint256 shares) public view returns (uint256 assets) {

// @audit maxAssets
392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

// @audit maxShares
444:     function maxMint(address) external view returns (uint256 maxShares) {

// @audit maxAssets
507:     function maxWithdraw(address owner) public view returns (uint256 maxAssets) {

// @audit shares
518:     function previewWithdraw(uint256 assets) public view returns (uint256 shares) {

// @audit maxShares
572:     function maxRedeem(address owner) public view returns (uint256 maxShares) {

// @audit assets
581:     function previewRedeem(uint256 shares) public view returns (uint256 assets) {

// @audit poolUtilization
741:     function _poolUtilization() internal view returns (int256 poolUtilization) {

// @audit sellCollateralRatio
751:     function _sellCollateralRatio(

// @audit buyCollateralRatio
806:     function _buyCollateralRatio(

// @audit required
1278:     function _getRequiredCollateralSingleLeg(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L361-L361) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L370-L370), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L379-L379), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L386-L386), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L392), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L518-L518), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L572-L572), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L581-L581), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L741-L741), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L751-L751), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L806-L806), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1278-L1278)


```solidity

File: ./contracts/PanopticPool.sol

// @audit premium0
// @audit premium1
381:     function calculateAccumulatedFeesBatch(

// @audit collateralToken
1431:     function collateralToken0() external view returns (CollateralTracker collateralToken) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L381-L381) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1431-L1431)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

// @audit UniswapV3Pool
1555:     function getUniswapV3PoolFromId(


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1555-L1555) 


</details>


### [NC&#x2011;85] Use named return values 
Using named returns makes the code more self-documenting, makes it easier to fill out NatSpec, and in some cases can save gas. The cases below are where there currently is at most one return statement, which is ideal for named returns.


*There are 104 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

289:     function name() external view returns (string memory) {

303:     function symbol() external view returns (string memory) {

310:     function decimals() external view returns (uint8) {

323:     function transfer(
324:         address recipient,
325:         uint256 amount
326:     ) public override(ERC20Minimal) returns (bool) {

341:     function transferFrom(
342:         address from,
343:         address to,
344:         uint256 amount
345:     ) public override(ERC20Minimal) returns (bool) {

1043:     function exercise(
1044:         address optionOwner,
1045:         int128 longAmount,
1046:         int128 shortAmount,
1047:         int128 swappedAmount,
1048:         int128 realizedPremium
1049:     ) external onlyPanopticPool returns (int128) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L289-L289) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L303-L303), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L310-L310), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L323-L326), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L341-L345), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1049)


```solidity

File: ./contracts/PanopticFactory.sol

159:     function owner() external view returns (address) {

335:     function _mintFullRange(
336:         IUniswapV3Pool v3Pool,
337:         address token0,
338:         address token1,
339:         uint24 fee
340:     ) internal returns (uint256, uint256) {

420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L159-L159) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L335-L340), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L420-L420)


```solidity

File: ./contracts/PanopticPool.sol

381:     function calculateAccumulatedFeesBatch(
382:         address user,
383:         bool includePendingPremium,
384:         TokenId[] calldata positionIdList
385:     ) external view returns (int128 premium0, int128 premium1, uint256[2][] memory) {

499:     function _getSlippageLimits(
500:         int24 tickLimitLow,
501:         int24 tickLimitHigh
502:     ) internal pure returns (int24, int24) {

677:     function _mintInSFPMAndUpdateCollateral(
678:         TokenId tokenId,
679:         uint128 positionSize,
680:         int24 tickLimitLow,
681:         int24 tickLimitHigh
682:     ) internal returns (uint128) {

706:     function _payCommissionAndWriteData(
707:         TokenId tokenId,
708:         uint128 positionSize,
709:         LeftRightSigned totalSwapped
710:     ) internal returns (uint128) {

1290:     function _checkSolvencyAtTick(
1291:         address account,
1292:         TokenId[] calldata positionIdList,
1293:         int24 currentTick,
1294:         int24 atTick,
1295:         uint256 buffer
1296:     ) internal view returns (bool) {

1425:     function univ3pool() external view returns (IUniswapV3Pool) {

1437:     function collateralToken1() external view returns (CollateralTracker) {

1757:     function _getAvailablePremium(
1758:         uint256 totalLiquidity,
1759:         LeftRightUnsigned settledTokens,
1760:         LeftRightUnsigned grossPremiumLast,
1761:         LeftRightUnsigned premiumOwed,
1762:         uint256[2] memory premiumAccumulators
1763:     ) internal pure returns (LeftRightUnsigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L381-L385) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L499-L502), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L677-L682), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L706-L710), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1290-L1296), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1425-L1425), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1437-L1437), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1757-L1763)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

1449:     function getAccountPremium(
1450:         address univ3pool,
1451:         address owner,
1452:         uint256 tokenType,
1453:         int24 tickLower,
1454:         int24 tickUpper,
1455:         int24 atTick,
1456:         uint256 isLong
1457:     ) external view returns (uint128, uint128) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1449-L1457) 


```solidity

File: ./contracts/libraries/FeesCalc.sol

097:     function calculateAMMSwapFees(
098:         IUniswapV3Pool univ3pool,
099:         int24 currentTick,
100:         int24 tickLower,
101:         int24 tickUpper,
102:         uint128 liquidity
103:     ) public view returns (LeftRightSigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L97-L103) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

48:     function computeName(
49:         address token0,
50:         address token1,
51:         bool isToken0,
52:         uint24 fee,
53:         string memory prefix
54:     ) external view returns (string memory) {

91:     function computeSymbol(
92:         address token,
93:         string memory prefix
94:     ) external view returns (string memory) {

107:     function computeDecimals(address token) external view returns (uint8) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L48-L54) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L91-L94), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L107-L107)


```solidity

File: ./contracts/libraries/Math.sol

25:     function min24(int24 a, int24 b) internal pure returns (int24) {

33:     function max24(int24 a, int24 b) internal pure returns (int24) {

41:     function min(uint256 a, uint256 b) internal pure returns (uint256) {

49:     function min(int256 a, int256 b) internal pure returns (int256) {

57:     function max(uint256 a, uint256 b) internal pure returns (uint256) {

65:     function max(int256 a, int256 b) internal pure returns (int256) {

73:     function abs(int256 x) internal pure returns (int256) {

81:     function absUint(int256 x) internal pure returns (uint256) {

128:     function getSqrtRatioAtTick(int24 tick) internal pure returns (uint160) {

191:     function getAmount0ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

207:     function getAmount1ForLiquidity(LiquidityChunk liquidityChunk) internal pure returns (uint256) {

241:     function getLiquidityForAmount0(
242:         int24 tickLower,
243:         int24 tickUpper,
244:         uint256 amount0
245:     ) internal pure returns (LiquidityChunk) {

271:     function getLiquidityForAmount1(
272:         int24 tickLower,
273:         int24 tickUpper,
274:         uint256 amount1
275:     ) internal pure returns (LiquidityChunk) {

325:     function toInt256(uint256 toCast) internal pure returns (int256) {

458:     function mulDiv64(uint256 a, uint256 b) internal pure returns (uint256) {

521:     function mulDiv96(uint256 a, uint256 b) internal pure returns (uint256) {

598:     function mulDiv128(uint256 a, uint256 b) internal pure returns (uint256) {

675:     function mulDiv192(uint256 a, uint256 b) internal pure returns (uint256) {

776:     function sort(int256[] memory data) internal pure returns (int256[] memory) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L25-L25) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L33-L33), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L41-L41), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L49-L49), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L57-L57), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L65-L65), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L73-L73), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L81-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L191-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L207-L207), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L241-L245), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L271-L275), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L325-L325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L458-L458), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L521-L521), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L598-L598), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L675-L675), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L776-L776)


```solidity

File: ./contracts/libraries/PanopticMath.sol

47:     function getPoolId(address univ3pool) internal view returns (uint64) {

59:     function incrementPoolPattern(uint64 poolId) internal pure returns (uint64) {

75:     function numberOfLeadingHexZeros(address addr) external pure returns (uint256) {

92:     function updatePositionsHash(
93:         uint256 existingHash,
94:         TokenId tokenId,
95:         bool addFlag
96:     ) internal pure returns (uint256) {

125:     function computeMedianObservedPrice(
126:         IUniswapV3Pool univ3pool,
127:         uint256 observationIndex,
128:         uint256 observationCardinality,
129:         uint256 cardinality,
130:         uint256 period
131:     ) external view returns (int24) {

241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

289:     function getLiquidityChunk(
290:         TokenId tokenId,
291:         uint256 legIndex,
292:         uint128 positionSize
293:     ) internal pure returns (LiquidityChunk) {

371:     function getRangesFromStrike(
372:         int24 width,
373:         int24 tickSpacing
374:     ) internal pure returns (int24, int24) {

419:     function convertCollateralData(
420:         LeftRightUnsigned tokenData0,
421:         LeftRightUnsigned tokenData1,
422:         uint256 tokenType,
423:         uint160 sqrtPriceX96
424:     ) internal pure returns (uint256, uint256) {

445:     function convertCollateralData(
446:         LeftRightUnsigned tokenData0,
447:         LeftRightUnsigned tokenData1,
448:         uint256 tokenType,
449:         int24 tick
450:     ) internal pure returns (uint256, uint256) {

468:     function convertNotional(
469:         uint128 contractSize,
470:         int24 tickLower,
471:         int24 tickUpper,
472:         uint256 asset
473:     ) internal pure returns (uint128) {

490:     function convert0to1(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

507:     function convert1to0(uint256 amount, uint160 sqrtPriceX96) internal pure returns (uint256) {

524:     function convert0to1(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

547:     function convert1to0(int256 amount, uint160 sqrtPriceX96) internal pure returns (int256) {

574:     function getAmountsMoved(
575:         TokenId tokenId,
576:         uint128 positionSize,
577:         uint256 legIndex
578:     ) internal pure returns (LeftRightUnsigned) {

651:     function getLiquidationBonus(
652:         LeftRightUnsigned tokenData0,
653:         LeftRightUnsigned tokenData1,
654:         uint160 sqrtPriceX96Twap,
655:         uint160 sqrtPriceX96Final,
656:         LeftRightSigned netExchanged,
657:         LeftRightSigned premia
658:     ) external pure returns (int256 bonus0, int256 bonus1, LeftRightSigned) {

768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens
777:     ) external returns (int256, int256) {

917:     function getRefundAmounts(
918:         address refunder,
919:         LeftRightSigned refundValues,
920:         int24 atTick,
921:         CollateralTracker collateral0,
922:         CollateralTracker collateral1
923:     ) external view returns (LeftRightSigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L47-L47) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L59-L59), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L75-L75), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L92-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L125-L131), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L241-L241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L289-L293), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L371-L374), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L419-L424), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L445-L450), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L468-L473), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L490-L490), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L507-L507), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L524-L524), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L547-L547), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L574-L578), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L651-L658), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L777), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L917-L923)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

200:     function supportsInterface(bytes4 interfaceId) public pure returns (bool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L200-L200) 


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

49:     function approve(address spender, uint256 amount) public returns (bool) {

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L49-L49) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L61-L61), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L81-L81)


```solidity

File: ./contracts/types/LeftRight.sol

39:     function rightSlot(LeftRightUnsigned self) internal pure returns (uint128) {

46:     function rightSlot(LeftRightSigned self) internal pure returns (int128) {

59:     function toRightSlot(
60:         LeftRightUnsigned self,
61:         uint128 right
62:     ) internal pure returns (LeftRightUnsigned) {

78:     function toRightSlot(
79:         LeftRightSigned self,
80:         int128 right
81:     ) internal pure returns (LeftRightSigned) {

101:     function leftSlot(LeftRightUnsigned self) internal pure returns (uint128) {

108:     function leftSlot(LeftRightSigned self) internal pure returns (int128) {

121:     function toLeftSlot(
122:         LeftRightUnsigned self,
123:         uint128 left
124:     ) internal pure returns (LeftRightUnsigned) {

134:     function toLeftSlot(LeftRightSigned self, int128 left) internal pure returns (LeftRightSigned) {

279:     function addCapped(
280:         LeftRightUnsigned x,
281:         LeftRightUnsigned dx,
282:         LeftRightUnsigned y,
283:         LeftRightUnsigned dy
284:     ) internal pure returns (LeftRightUnsigned, LeftRightUnsigned) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L39-L39) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L46-L46), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L59-L62), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L78-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L101-L101), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L121-L124), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L134-L134), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LeftRight.sol#L279-L284)


```solidity

File: ./contracts/types/LiquidityChunk.sol

70:     function createChunk(
71:         int24 _tickLower,
72:         int24 _tickUpper,
73:         uint128 amount
74:     ) internal pure returns (LiquidityChunk) {

89:     function addLiquidity(
90:         LiquidityChunk self,
91:         uint128 amount
92:     ) internal pure returns (LiquidityChunk) {

102:     function addTickLower(
103:         LiquidityChunk self,
104:         int24 _tickLower
105:     ) internal pure returns (LiquidityChunk) {

118:     function addTickUpper(
119:         LiquidityChunk self,
120:         int24 _tickUpper
121:     ) internal pure returns (LiquidityChunk) {

135:     function updateTickLower(
136:         LiquidityChunk self,
137:         int24 _tickLower
138:     ) internal pure returns (LiquidityChunk) {

151:     function updateTickUpper(
152:         LiquidityChunk self,
153:         int24 _tickUpper
154:     ) internal pure returns (LiquidityChunk) {

171:     function tickLower(LiquidityChunk self) internal pure returns (int24) {

180:     function tickUpper(LiquidityChunk self) internal pure returns (int24) {

189:     function liquidity(LiquidityChunk self) internal pure returns (uint128) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L70-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L89-L92), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L102-L105), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L118-L121), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L135-L138), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L151-L154), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L171-L171), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L180-L180), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/LiquidityChunk.sol#L189-L189)


```solidity

File: ./contracts/types/TokenId.sol

87:     function poolId(TokenId self) internal pure returns (uint64) {

96:     function tickSpacing(TokenId self) internal pure returns (int24) {

108:     function asset(TokenId self, uint256 legIndex) internal pure returns (uint256) {

118:     function optionRatio(TokenId self, uint256 legIndex) internal pure returns (uint256) {

128:     function isLong(TokenId self, uint256 legIndex) internal pure returns (uint256) {

138:     function tokenType(TokenId self, uint256 legIndex) internal pure returns (uint256) {

148:     function riskPartner(TokenId self, uint256 legIndex) internal pure returns (uint256) {

158:     function strike(TokenId self, uint256 legIndex) internal pure returns (int24) {

169:     function width(TokenId self, uint256 legIndex) internal pure returns (int24) {

183:     function addPoolId(TokenId self, uint64 _poolId) internal pure returns (TokenId) {

193:     function addTickSpacing(TokenId self, int24 _tickSpacing) internal pure returns (TokenId) {

205:     function addAsset(
206:         TokenId self,
207:         uint256 _asset,
208:         uint256 legIndex
209:     ) internal pure returns (TokenId) {

221:     function addOptionRatio(
222:         TokenId self,
223:         uint256 _optionRatio,
224:         uint256 legIndex
225:     ) internal pure returns (TokenId) {

240:     function addIsLong(
241:         TokenId self,
242:         uint256 _isLong,
243:         uint256 legIndex
244:     ) internal pure returns (TokenId) {

255:     function addTokenType(
256:         TokenId self,
257:         uint256 _tokenType,
258:         uint256 legIndex
259:     ) internal pure returns (TokenId) {

273:     function addRiskPartner(
274:         TokenId self,
275:         uint256 _riskPartner,
276:         uint256 legIndex
277:     ) internal pure returns (TokenId) {

291:     function addStrike(
292:         TokenId self,
293:         int24 _strike,
294:         uint256 legIndex
295:     ) internal pure returns (TokenId) {

310:     function addWidth(
311:         TokenId self,
312:         int24 _width,
313:         uint256 legIndex
314:     ) internal pure returns (TokenId) {

366:     function flipToBurnToken(TokenId self) internal pure returns (TokenId) {

404:     function countLongs(TokenId self) internal pure returns (uint256) {

432:     function countLegs(TokenId self) internal pure returns (uint256) {

464:     function clearLeg(TokenId self, uint256 i) internal pure returns (TokenId) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L87-L87) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L96-L96), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L108-L108), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L118-L118), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L128-L128), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L138-L138), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L148-L148), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L158-L158), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L169-L169), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L183-L183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L205-L209), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L221-L225), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L240-L244), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L255-L259), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L273-L277), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L291-L295), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L310-L314), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L366-L366), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L404-L404), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L432-L432), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L464-L464)


</details>


### [NC&#x2011;86] Consider moving duplicated strings to constants 



*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

70:     string internal constant TICKER_PREFIX = "po";

73:     string internal constant NAME_PREFIX = "POPT-V1";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L70-L70) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L73-L73)


```solidity

File: ./contracts/libraries/InteractionHelper.sol

74:                     " ",

76:                     " LP on ",

78:                     "/",

82:                     "bps"

63:             symbol0 = "???";


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L74-L74) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L76-L76), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L78-L78), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L82-L82), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L63-L63)


</details>


### [NC&#x2011;87] Missing checks for uint state variable assignments 
Consider whether reasonable bounds checks for variables would be useful


*There are 7 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

187:         COMMISSION_FEE = _commissionFee;

188:         SELLER_COLLATERAL_RATIO = _sellerCollateralRatio;

189:         BUYER_COLLATERAL_RATIO = _buyerCollateralRatio;

191:         TARGET_POOL_UTIL = _targetPoolUtilization;

192:         SATURATED_POOL_UTIL = _saturatedPoolUtilization;

193:         ITM_SPREAD_MULTIPLIER = _ITMSpreadMultiplier;

251:         s_poolFee = _poolFee;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L187-L187) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L188-L188), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L189-L189), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L191-L191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L192-L192), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L193-L193), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L251-L251)


</details>


### [NC&#x2011;88] Consider adding validation of user inputs 



*There are 78 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit these parameters `token0`,`token1`,`panopticPool`, are not checked
221:     function startToken(
222:         bool underlyingIsToken0,
223:         address token0,
224:         address token1,
225:         uint24 fee,
226:         PanopticPool panopticPool

//@audit these parameters `recipient`, are not checked
323:     function transfer(
324:         address recipient,
325:         uint256 amount

//@audit these parameters `to`, are not checked
341:     function transferFrom(
342:         address from,
343:         address to,
344:         uint256 amount

//@audit these parameters ``, are not checked
392:     function maxDeposit(address) external pure returns (uint256 maxAssets) {

//@audit these parameters `receiver`, are not checked
417:     function deposit(uint256 assets, address receiver) external returns (uint256 shares) {

//@audit these parameters ``, are not checked
444:     function maxMint(address) external view returns (uint256 maxShares) {

//@audit these parameters `receiver`, are not checked
477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {

//@audit these parameters `receiver`, are not checked
531:     function withdraw(
532:         uint256 assets,
533:         address receiver,
534:         address owner

//@audit these parameters `receiver`, are not checked
591:     function redeem(
592:         uint256 shares,
593:         address receiver,
594:         address owner

//@audit these parameters `delegator`,`delegatee`, are not checked
864:     function delegate(
865:         address delegator,
866:         address delegatee,
867:         uint256 assets

//@audit these parameters `delegatee`, are not checked
894:     function delegate(address delegatee, uint256 assets) external onlyPanopticPool {

//@audit these parameters `delegatee`, are not checked
903:     function refund(address delegatee, uint256 assets) external onlyPanopticPool {

//@audit these parameters `delegator`,`delegatee`, are not checked
911:     function revoke(
912:         address delegator,
913:         address delegatee,
914:         uint256 assets

//@audit these parameters `refunder`,`refundee`, are not checked
975:     function refund(address refunder, address refundee, int256 assets) external onlyPanopticPool {

//@audit these parameters `optionOwner`, are not checked
995:     function takeCommissionAddData(
996:         address optionOwner,
997:         int128 longAmount,
998:         int128 shortAmount,
999:         int128 swappedAmount

//@audit these parameters `optionOwner`, are not checked
1043:     function exercise(
1044:         address optionOwner,
1045:         int128 longAmount,
1046:         int128 shortAmount,
1047:         int128 swappedAmount,
1048:         int128 realizedPremium

//@audit these parameters `user`, are not checked
1141:     function getAccountMarginDetails(
1142:         address user,
1143:         int24 currentTick,
1144:         uint256[2][] memory positionBalanceArray,
1145:         int128 premiumAllPositions

//@audit these parameters `user`, are not checked
1159:     function _getAccountMargin(
1160:         address user,
1161:         int24 atTick,
1162:         uint256[2][] memory positionBalanceArray,
1163:         int128 premiumAllPositions


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L221-L226) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L323-L325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L341-L344), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L392-L392), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L417-L417), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L444-L444), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L531-L534), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L591-L594), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L864-L867), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L894-L894), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L903-L903), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L911-L914), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L975-L975), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L995-L999), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1043-L1048), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1141-L1145), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1159-L1163)


```solidity

File: ./contracts/PanopticFactory.sol

//@audit these parameters `_owner`, are not checked
134:     function initialize(address _owner) public {

//@audit these parameters `newOwner`, are not checked
147:     function transferOwnership(address newOwner) external {

//@audit these parameters `v3Pool`, are not checked
335:     function _mintFullRange(
336:         IUniswapV3Pool v3Pool,
337:         address token0,
338:         address token1,
339:         uint24 fee

//@audit these parameters `univ3pool`, are not checked
420:     function getPanopticPool(IUniswapV3Pool univ3pool) external view returns (PanopticPool) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L134-L134) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L147-L147), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L335-L339), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L420-L420)


```solidity

File: ./contracts/PanopticPool.sol

//@audit these parameters `_univ3pool`,`token0`,`token1`,`collateralTracker0`,`collateralTracker1`, are not checked
291:     function startPool(
292:         IUniswapV3Pool _univ3pool,
293:         address token0,
294:         address token1,
295:         CollateralTracker collateralTracker0,
296:         CollateralTracker collateralTracker1

//@audit these parameters `user`, are not checked
352:     function optionPositionBalance(
353:         address user,
354:         TokenId tokenId

//@audit these parameters `user`, are not checked
381:     function calculateAccumulatedFeesBatch(
382:         address user,
383:         bool includePendingPremium,
384:         TokenId[] calldata positionIdList

//@audit these parameters `user`, are not checked
410:     function calculatePortfolioValue(
411:         address user,
412:         int24 atTick,
413:         TokenId[] calldata positionIdList

//@audit these parameters `user`, are not checked
429:     function _calculateAccumulatedPremia(
430:         address user,
431:         TokenId[] calldata positionIdList,
432:         bool computeAllPremia,
433:         bool includePendingPremium,
434:         int24 atTick

//@audit these parameters `owner`, are not checked
794:     function _burnAllOptionsFrom(
795:         address owner,
796:         int24 tickLimitLow,
797:         int24 tickLimitHigh,
798:         bool commitLongSettled,
799:         TokenId[] calldata positionIdList

//@audit these parameters `owner`, are not checked
826:     function _burnOptions(
827:         bool commitLongSettled,
828:         TokenId tokenId,
829:         address owner,
830:         int24 tickLimitLow,
831:         int24 tickLimitHigh

//@audit these parameters `owner`, are not checked
859:     function _updatePositionDataBurn(address owner, TokenId tokenId) internal {

//@audit these parameters `user`, are not checked
887:     function _validateSolvency(
888:         address user,
889:         TokenId[] calldata positionIdList,
890:         uint256 buffer

//@audit these parameters `owner`, are not checked
955:     function _burnAndHandleExercise(
956:         bool commitLongSettled,
957:         int24 tickLimitLow,
958:         int24 tickLimitHigh,
959:         TokenId tokenId,
960:         uint128 positionSize,
961:         address owner

//@audit these parameters `liquidatee`, are not checked
1017:     function liquidate(
1018:         TokenId[] calldata positionIdListLiquidator,
1019:         address liquidatee,
1020:         LeftRightUnsigned delegations,
1021:         TokenId[] calldata positionIdList

//@audit these parameters `account`, are not checked
1179:     function forceExercise(
1180:         address account,
1181:         TokenId[] calldata touchedId,
1182:         TokenId[] calldata positionIdListExercisee,
1183:         TokenId[] calldata positionIdListExercisor

//@audit these parameters `account`, are not checked
1290:     function _checkSolvencyAtTick(
1291:         address account,
1292:         TokenId[] calldata positionIdList,
1293:         int24 currentTick,
1294:         int24 atTick,
1295:         uint256 buffer

//@audit these parameters `account`, are not checked
1367:     function _validatePositionList(
1368:         address account,
1369:         TokenId[] calldata positionIdList,
1370:         uint256 offset

//@audit these parameters `account`, are not checked
1405:     function _updatePositionsHash(address account, TokenId tokenId, bool addFlag) internal {

//@audit these parameters `owner`, are not checked
1503:     function _getPremia(
1504:         TokenId tokenId,
1505:         uint128 positionSize,
1506:         address owner,
1507:         bool computeAllPremia,
1508:         int24 atTick

//@audit these parameters `owner`, are not checked
1587:     function settleLongPremium(
1588:         TokenId[] calldata positionIdList,
1589:         address owner,
1590:         uint256 legIndex

//@audit these parameters `owner`, are not checked
1833:     function _updateSettlementPostBurn(
1834:         address owner,
1835:         TokenId tokenId,
1836:         LeftRightUnsigned[4] memory collectedByLeg,
1837:         uint128 positionSize,
1838:         bool commitLongSettled


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L291-L296) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L352-L354), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L381-L384), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L410-L413), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L429-L434), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L794-L799), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L826-L831), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L859-L859), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L887-L890), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L955-L961), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1017-L1021), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1179-L1183), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1290-L1295), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1367-L1370), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1405-L1405), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1503-L1508), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1587-L1590), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1833-L1838)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit these parameters `token0`,`token1`, are not checked
350:     function initializeAMMPool(address token0, address token1, uint24 fee) external {

//@audit these parameters `from`,`to`, are not checked
540:     function safeTransferFrom(
541:         address from,
542:         address to,
543:         uint256 id,
544:         uint256 amount,
545:         bytes calldata data

//@audit these parameters `from`,`to`, are not checked
566:     function safeBatchTransferFrom(
567:         address from,
568:         address to,
569:         uint256[] calldata ids,
570:         uint256[] calldata amounts,
571:         bytes calldata data

//@audit these parameters `from`,`to`, are not checked
593:     function registerTokenTransfer(address from, address to, TokenId id, uint256 amount) internal {

//@audit these parameters `univ3pool`, are not checked
756:     function swapInAMM(
757:         IUniswapV3Pool univ3pool,
758:         LeftRightSigned itmAmounts

//@audit these parameters `univ3pool`, are not checked
863:     function _createPositionInAMM(
864:         IUniswapV3Pool univ3pool,
865:         TokenId tokenId,
866:         uint128 positionSize,
867:         bool isBurn

//@audit these parameters `univ3pool`, are not checked
958:     function _createLegInAMM(
959:         IUniswapV3Pool univ3pool,
960:         TokenId tokenId,
961:         uint256 leg,
962:         LiquidityChunk liquidityChunk,
963:         bool isBurn

//@audit these parameters `univ3pool`, are not checked
1138:     function _getFeesBase(
1139:         IUniswapV3Pool univ3pool,
1140:         uint128 liquidity,
1141:         LiquidityChunk liquidityChunk,
1142:         bool roundUp

//@audit these parameters `univ3pool`, are not checked
1185:     function _mintLiquidity(
1186:         LiquidityChunk liquidityChunk,
1187:         IUniswapV3Pool univ3pool

//@audit these parameters `univ3pool`, are not checked
1224:     function _burnLiquidity(
1225:         LiquidityChunk liquidityChunk,
1226:         IUniswapV3Pool univ3pool

//@audit these parameters `univ3pool`, are not checked
1255:     function _collectAndWritePositionData(
1256:         LiquidityChunk liquidityChunk,
1257:         IUniswapV3Pool univ3pool,
1258:         LeftRightUnsigned currentLiquidity,
1259:         bytes32 positionKey,
1260:         LeftRightSigned movedInLeg,
1261:         uint256 isLong

//@audit these parameters `univ3pool`,`owner`, are not checked
1421:     function getAccountLiquidity(
1422:         address univ3pool,
1423:         address owner,
1424:         uint256 tokenType,
1425:         int24 tickLower,
1426:         int24 tickUpper

//@audit these parameters `univ3pool`,`owner`, are not checked
1449:     function getAccountPremium(
1450:         address univ3pool,
1451:         address owner,
1452:         uint256 tokenType,
1453:         int24 tickLower,
1454:         int24 tickUpper,
1455:         int24 atTick,
1456:         uint256 isLong

//@audit these parameters `univ3pool`,`owner`, are not checked
1535:     function getAccountFeesBase(
1536:         address univ3pool,
1537:         address owner,
1538:         uint256 tokenType,
1539:         int24 tickLower,
1540:         int24 tickUpper

//@audit these parameters `univ3pool`, are not checked
1566:     function getPoolId(address univ3pool) external view returns (uint64 poolId) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L350-L350) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L540-L545), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L566-L571), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L593-L593), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L756-L758), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L863-L867), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L958-L963), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1138-L1142), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1185-L1187), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1224-L1226), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1255-L1261), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1421-L1426), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1449-L1456), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1535-L1540), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1566-L1566)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit these parameters `univ3pool`, are not checked
097:     function calculateAMMSwapFees(
098:         IUniswapV3Pool univ3pool,
099:         int24 currentTick,
100:         int24 tickLower,
101:         int24 tickUpper,
102:         uint128 liquidity


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L97-L102) 


```solidity

File: ./contracts/libraries/InteractionHelper.sol

//@audit these parameters `sfpm`,`ct0`,`ct1`,`token0`,`token1`, are not checked
24:     function doApprovals(
25:         SemiFungiblePositionManager sfpm,
26:         CollateralTracker ct0,
27:         CollateralTracker ct1,
28:         address token0,
29:         address token1

//@audit these parameters `token0`,`token1`, are not checked
48:     function computeName(
49:         address token0,
50:         address token1,
51:         bool isToken0,
52:         uint24 fee,
53:         string memory prefix

//@audit these parameters `token`, are not checked
91:     function computeSymbol(
92:         address token,
93:         string memory prefix

//@audit these parameters `token`, are not checked
107:     function computeDecimals(address token) external view returns (uint8) {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L24-L29) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L48-L53), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L91-L93), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/InteractionHelper.sol#L107-L107)


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit these parameters `univ3pool`, are not checked
125:     function computeMedianObservedPrice(
126:         IUniswapV3Pool univ3pool,
127:         uint256 observationIndex,
128:         uint256 observationCardinality,
129:         uint256 cardinality,
130:         uint256 period

//@audit these parameters `univ3pool`, are not checked
168:     function computeInternalMedian(
169:         uint256 observationIndex,
170:         uint256 observationCardinality,
171:         uint256 period,
172:         uint256 medianData,
173:         IUniswapV3Pool univ3pool

//@audit these parameters `univ3pool`, are not checked
241:     function twapFilter(IUniswapV3Pool univ3pool, uint32 twapWindow) external view returns (int24) {

//@audit these parameters `liquidatee`,`collateral0`,`collateral1`, are not checked
768:     function haircutPremia(
769:         address liquidatee,
770:         TokenId[] memory positionIdList,
771:         LeftRightSigned[4][] memory premiasByLeg,
772:         LeftRightSigned collateralRemaining,
773:         CollateralTracker collateral0,
774:         CollateralTracker collateral1,
775:         uint160 sqrtPriceX96Final,
776:         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens) storage settledTokens


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L125-L130) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L168-L173), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L241-L241), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L768-L776)


```solidity

File: ./contracts/libraries/SafeTransferLib.sol

//@audit these parameters `token`,`from`,`to`, are not checked
21:     function safeTransferFrom(address token, address from, address to, uint256 amount) internal {

//@audit these parameters `token`,`to`, are not checked
52:     function safeTransfer(address token, address to, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L21-L21) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/SafeTransferLib.sol#L52-L52)


```solidity

File: ./contracts/tokens/ERC1155Minimal.sol

//@audit these parameters `operator`, are not checked
81:     function setApprovalForAll(address operator, bool approved) public {

//@audit these parameters `from`, are not checked
236:     function _burn(address from, uint256 id, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L81-L81) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC1155Minimal.sol#L236-L236)


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

//@audit these parameters `spender`, are not checked
49:     function approve(address spender, uint256 amount) public returns (bool) {

//@audit these parameters `to`, are not checked
61:     function transfer(address to, uint256 amount) public virtual returns (bool) {

//@audit these parameters `from`,`to`, are not checked
81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {

//@audit these parameters `from`,`to`, are not checked
103:     function _transferFrom(address from, address to, uint256 amount) internal {

//@audit these parameters `to`, are not checked
122:     function _mint(address to, uint256 amount) internal {

//@audit these parameters `from`, are not checked
136:     function _burn(address from, uint256 amount) internal {


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L49-L49) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L61-L61), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L81-L81), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L103-L103), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L122-L122), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L136-L136)


```solidity

File: ./contracts/tokens/interfaces/IDonorNFT.sol

//@audit these parameters `deployer`,`newPoolContract`,`token0`,`token1`, are not checked
13:     function issueNFT(
14:         address deployer,
15:         PanopticPool newPoolContract,
16:         address token0,
17:         address token1,
18:         uint24 fee


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IDonorNFT.sol#L13-L18) 


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

//@audit these parameters `account`, are not checked
16:     function balanceOf(address account) external view returns (uint256);

//@audit these parameters `spender`, are not checked
22:     function approve(address spender, uint256 amount) external;

//@audit these parameters `to`, are not checked
27:     function transfer(address to, uint256 amount) external;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L16-L16) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L22-L22), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L27-L27)


</details>


### [NC&#x2011;89] Consider disallowing transfers to `address(this)` 
Consider preventing a contract's tokens from being transferred/minted to the contract itself


*There are 6 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

323:     function transfer(
324:         address recipient,
325:         uint256 amount
326:     ) public override(ERC20Minimal) returns (bool) {
327:         // make sure the caller does not have any open option positions
328:         // if they do: we don't want them sending panoptic pool shares to others
329:         // since that's like reducing collateral
330: 
331:         if (s_panopticPool.numberOfPositions(msg.sender) != 0) revert Errors.PositionCountNotZero();
332: 
333:         return ERC20Minimal.transfer(recipient, amount);
334:     }

341:     function transferFrom(
342:         address from,
343:         address to,
344:         uint256 amount
345:     ) public override(ERC20Minimal) returns (bool) {
346:         // make sure the caller does not have any open option positions
347:         // if they do: we don't want them sending panoptic pool shares to others
348:         // as this would reduce their amount of collateral against the opened positions
349: 
350:         if (s_panopticPool.numberOfPositions(from) != 0) revert Errors.PositionCountNotZero();
351: 
352:         return ERC20Minimal.transferFrom(from, to, amount);
353:     }

477:     function mint(uint256 shares, address receiver) external returns (uint256 assets) {
478:         assets = previewMint(shares);
479: 
480:         if (assets > type(uint104).max) revert Errors.DepositTooLarge();
481: 
482:         // transfer assets (underlying token funds) from the user/the LP to the PanopticPool
483:         // in return for the shares to be minted
484:         SafeTransferLib.safeTransferFrom(
485:             s_underlyingToken,
486:             msg.sender,
487:             address(s_panopticPool),
488:             assets
489:         );
490: 
491:         // mint collateral shares of the Panoptic Pool funds (this ERC20 token)
492:         _mint(receiver, shares);
493: 
494:         // update tracked asset balance
495:         unchecked {
496:             s_poolAssets += uint128(assets);
497:         }
498: 
499:         emit Deposit(msg.sender, receiver, assets, shares);
500:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L323-L334) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L341-L353), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L477-L500)


```solidity

File: ./contracts/tokens/ERC20Minimal.sol

61:     function transfer(address to, uint256 amount) public virtual returns (bool) {
62:         balanceOf[msg.sender] -= amount;
63: 
64:         // Cannot overflow because the sum of all user
65:         // balances can't exceed the max uint256 value.
66:         unchecked {
67:             balanceOf[to] += amount;
68:         }
69: 
70:         emit Transfer(msg.sender, to, amount);
71: 
72:         return true;
73:     }

81:     function transferFrom(address from, address to, uint256 amount) public virtual returns (bool) {
82:         uint256 allowed = allowance[from][msg.sender]; // Saves gas for limited approvals.
83: 
84:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;
85: 
86:         balanceOf[from] -= amount;
87: 
88:         // Cannot overflow because the sum of all user
89:         // balances can't exceed the max uint256 value.
90:         unchecked {
91:             balanceOf[to] += amount;
92:         }
93: 
94:         emit Transfer(from, to, amount);
95: 
96:         return true;
97:     }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L61-L73) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/ERC20Minimal.sol#L81-L97)


```solidity

File: ./contracts/tokens/interfaces/IERC20Partial.sol

27:     function transfer(address to, uint256 amount) external;


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/tokens/interfaces/IERC20Partial.sol#L27-L27) 


</details>


### [NC&#x2011;90] Unusual loop variable 
For better readability, try to use common loop counter names


*There are 13 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

//@audit `leg` 
662:             for (uint256 leg = 0; leg < positionId.countLegs(); ++leg) {
663:                 // short legs are not counted - exercise is intended to be based on long legs
664:                 if (positionId.isLong(leg) == 0) continue;
665: 
666:                 {
667:                     int24 range = int24(
668:                         int256(
669:                             Math.unsafeDivRoundingUp(
670:                                 uint24(positionId.width(leg) * positionId.tickSpacing()),
671:                                 2
672:                             )
673:                         )
674:                     );
675:                     maxNumRangesFromStrike = Math.max(
676:                         maxNumRangesFromStrike,
677:                         uint256(Math.abs(currentTick - positionId.strike(leg)) / range)
678:                     );
679:                 }
680: 
681:                 uint256 currentValue0;
682:                 uint256 currentValue1;
683:                 uint256 oracleValue0;
684:                 uint256 oracleValue1;
685: 
686:                 {
687:                     LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
688:                         positionId,
689:                         leg,
690:                         positionBalance
691:                     );
692: 
693:                     (currentValue0, currentValue1) = Math.getAmountsForLiquidity(
694:                         currentTick,
695:                         liquidityChunk
696:                     );
697: 
698:                     (oracleValue0, oracleValue1) = Math.getAmountsForLiquidity(
699:                         oracleTick,
700:                         liquidityChunk
701:                     );
702:                 }
703: 
704:                 uint256 tokenType = positionId.tokenType(leg);
705:                 // compensate user for loss in value if chunk has lost money between current and median tick
706:                 // note: the delta for one token will be positive and the other will be negative. This cancels out any moves in their positions
707:                 if (
708:                     (tokenType == 0 && currentValue1 < oracleValue1) ||
709:                     (tokenType == 1 && currentValue0 < oracleValue0)
710:                 )
711:                     exerciseFees = exerciseFees.sub(
712:                         LeftRightSigned
713:                             .wrap(0)
714:                             .toRightSlot(
715:                                 int128(uint128(oracleValue0)) - int128(uint128(currentValue0))
716:                             )
717:                             .toLeftSlot(
718:                                 int128(uint128(oracleValue1)) - int128(uint128(currentValue1))
719:                             )
720:                     );
721:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L662-L721) 


```solidity

File: ./contracts/PanopticPool.sol

//@audit `leg` 
745:         for (uint256 leg = 0; leg < numLegs; ) {
746:             // Extract base fee (AMM swap/trading fees) for the position and add it to s_options
747:             // (ie. the (feeGrowth * liquidity) / 2**128 for each token)
748:             (int24 tickLower, int24 tickUpper) = tokenId.asTicks(leg);
749:             uint256 isLong = tokenId.isLong(leg);
750:             {
751:                 (uint128 premiumAccumulator0, uint128 premiumAccumulator1) = SFPM.getAccountPremium(
752:                     address(s_univ3pool),
753:                     address(this),
754:                     tokenId.tokenType(leg),
755:                     tickLower,
756:                     tickUpper,
757:                     type(int24).max,
758:                     isLong
759:                 );
760: 
761:                 // update the premium accumulators
762:                 s_options[msg.sender][tokenId][leg] = LeftRightUnsigned
763:                     .wrap(0)
764:                     .toRightSlot(premiumAccumulator0)
765:                     .toLeftSlot(premiumAccumulator1);
766:             }
767:             // verify base Liquidity limit only if new position is long
768:             if (isLong == 1) {
769:                 // Move this into a new function
770:                 _checkLiquiditySpread(
771:                     tokenId,
772:                     leg,
773:                     tickLower,
774:                     tickUpper,
775:                     uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))
776:                 );
777:             }
778:             unchecked {
779:                 ++leg;
780:             }
781:         }

//@audit `leg` 
864:         for (uint256 leg = 0; leg < numLegs; ) {
865:             if (tokenId.isLong(leg) == 0) {
866:                 // Check the liquidity spread, make sure that closing the option does not exceed the MAX_SPREAD allowed
867:                 (int24 tickLower, int24 tickUpper) = tokenId.asTicks(leg);
868:                 _checkLiquiditySpread(tokenId, leg, tickLower, tickUpper, MAX_SPREAD);
869:             }
870:             s_options[owner][tokenId][leg] = LeftRightUnsigned.wrap(0);
871:             unchecked {
872:                 ++leg;
873:             }
874:         }

//@audit `leg` 
1518:         for (uint256 leg = 0; leg < numLegs; ) {
1519:             uint256 isLong = tokenId.isLong(leg);
1520:             if ((isLong == 1) || computeAllPremia) {
1521:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
1522:                     tokenId,
1523:                     leg,
1524:                     positionSize
1525:                 );
1526:                 uint256 tokenType = tokenId.tokenType(leg);
1527: 
1528:                 (premiumAccumulatorsByLeg[leg][0], premiumAccumulatorsByLeg[leg][1]) = SFPM
1529:                     .getAccountPremium(
1530:                         address(s_univ3pool),
1531:                         address(this),
1532:                         tokenType,
1533:                         liquidityChunk.tickLower(),
1534:                         liquidityChunk.tickUpper(),
1535:                         atTick,
1536:                         isLong
1537:                     );
1538: 
1539:                 unchecked {
1540:                     LeftRightUnsigned premiumAccumulatorLast = s_options[owner][tokenId][leg];
1541: 
1542:                     // if the premium accumulatorLast is higher than current, it means the premium accumulator has overflowed and rolled over at least once
1543:                     // we can account for one rollover by doing (acc_cur + (acc_max - acc_last))
1544:                     // if there are multiple rollovers or the rollover goes past the last accumulator, rolled over fees will just remain unclaimed
1545:                     premiaByLeg[leg] = LeftRightSigned
1546:                         .wrap(0)
1547:                         .toRightSlot(
1548:                             int128(
1549:                                 int256(
1550:                                     ((premiumAccumulatorsByLeg[leg][0] -
1551:                                         premiumAccumulatorLast.rightSlot()) *
1552:                                         (liquidityChunk.liquidity())) / 2 ** 64
1553:                                 )
1554:                             )
1555:                         )
1556:                         .toLeftSlot(
1557:                             int128(
1558:                                 int256(
1559:                                     ((premiumAccumulatorsByLeg[leg][1] -
1560:                                         premiumAccumulatorLast.leftSlot()) *
1561:                                         (liquidityChunk.liquidity())) / 2 ** 64
1562:                                 )
1563:                             )
1564:                         );
1565: 
1566:                     if (isLong == 1) {
1567:                         premiaByLeg[leg] = LeftRightSigned.wrap(0).sub(premiaByLeg[leg]);
1568:                     }
1569:                 }
1570:             }
1571:             unchecked {
1572:                 ++leg;
1573:             }
1574:         }

//@audit `leg` 
1672:         for (uint256 leg = 0; leg < numLegs; ++leg) {
1673:             bytes32 chunkKey = keccak256(
1674:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))
1675:             );
1676:             // add any tokens collected from Uniswap in a given chunk to the settled tokens available for withdrawal by sellers
1677:             s_settledTokens[chunkKey] = s_settledTokens[chunkKey].add(collectedByLeg[leg]);
1678: 
1679:             if (tokenId.isLong(leg) == 0) {
1680:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
1681:                     tokenId,
1682:                     leg,
1683:                     positionSize
1684:                 );
1685: 
1686:                 // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (R + N)
1687:                 uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
1688: 
1689:                 // We need to adjust the grossPremiumLast value such that the result of
1690:                 // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostMint/2**64 is equal to (grossPremium - grossPremiumLast)*totalLiquidityBeforeMint/2**64
1691:                 // G: total gross premium
1692:                 // T: totalLiquidityBeforeMint
1693:                 // R: positionLiquidity
1694:                 // C: current grossPremium value
1695:                 // L: current grossPremiumLast value
1696:                 // Ln: updated grossPremiumLast value
1697:                 // T * (C - L) = G
1698:                 // (T + R) * (C - Ln) = G
1699:                 //
1700:                 // T * (C - L) = (T + R) * (C - Ln)
1701:                 // (TC - TL) / (T + R) = C - Ln
1702:                 // Ln = C - (TC - TL)/(T + R)
1703:                 // Ln = (CT + CR - TC + TL)/(T+R)
1704:                 // Ln = (CR + TL)/(T+R)
1705: 
1706:                 uint256[2] memory grossCurrent;
1707:                 (grossCurrent[0], grossCurrent[1]) = SFPM.getAccountPremium(
1708:                     address(s_univ3pool),
1709:                     address(this),
1710:                     tokenId.tokenType(leg),
1711:                     liquidityChunk.tickLower(),
1712:                     liquidityChunk.tickUpper(),
1713:                     type(int24).max,
1714:                     0
1715:                 );
1716: 
1717:                 unchecked {
1718:                     // L
1719:                     LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
1720:                     // R
1721:                     uint256 positionLiquidity = liquidityChunk.liquidity();
1722:                     // T (totalLiquidity is (T + R) after minting)
1723:                     uint256 totalLiquidityBefore = totalLiquidity - positionLiquidity;
1724: 
1725:                     s_grossPremiumLast[chunkKey] = LeftRightUnsigned
1726:                         .wrap(0)
1727:                         .toRightSlot(
1728:                             uint128(
1729:                                 (grossCurrent[0] *
1730:                                     positionLiquidity +
1731:                                     grossPremiumLast.rightSlot() *
1732:                                     totalLiquidityBefore) / (totalLiquidity)
1733:                             )
1734:                         )
1735:                         .toLeftSlot(
1736:                             uint128(
1737:                                 (grossCurrent[1] *
1738:                                     positionLiquidity +
1739:                                     grossPremiumLast.leftSlot() *
1740:                                     totalLiquidityBefore) / (totalLiquidity)
1741:                             )
1742:                         );
1743:                 }
1744:             }
1745:         }

//@audit `leg` 
1852:         for (uint256 leg = 0; leg < numLegs; ) {
1853:             LeftRightSigned legPremia = premiaByLeg[leg];
1854: 
1855:             bytes32 chunkKey = keccak256(
1856:                 abi.encodePacked(tokenId.strike(leg), tokenId.width(leg), tokenId.tokenType(leg))
1857:             );
1858: 
1859:             // collected from Uniswap
1860:             LeftRightUnsigned settledTokens = s_settledTokens[chunkKey].add(collectedByLeg[leg]);
1861: 
1862:             if (LeftRightSigned.unwrap(legPremia) != 0) {
1863:                 // (will be) paid by long legs
1864:                 if (tokenId.isLong(leg) == 1) {
1865:                     if (commitLongSettled)
1866:                         settledTokens = LeftRightUnsigned.wrap(
1867:                             uint256(
1868:                                 LeftRightSigned.unwrap(
1869:                                     LeftRightSigned
1870:                                         .wrap(int256(LeftRightUnsigned.unwrap(settledTokens)))
1871:                                         .sub(legPremia)
1872:                                 )
1873:                             )
1874:                         );
1875:                     realizedPremia = realizedPremia.add(legPremia);
1876:                 } else {
1877:                     uint256 positionLiquidity = PanopticMath
1878:                         .getLiquidityChunk(tokenId, leg, positionSize)
1879:                         .liquidity();
1880: 
1881:                     // new totalLiquidity (total sold) = removedLiquidity + netLiquidity (T - R)
1882:                     uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);
1883:                     // T (totalLiquidity is (T - R) after burning)
1884:                     uint256 totalLiquidityBefore = totalLiquidity + positionLiquidity;
1885: 
1886:                     LeftRightUnsigned grossPremiumLast = s_grossPremiumLast[chunkKey];
1887: 
1888:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
1889:                         totalLiquidity + positionLiquidity,
1890:                         settledTokens,
1891:                         grossPremiumLast,
1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
1893:                         premiumAccumulatorsByLeg[leg]
1894:                     );
1895: 
1896:                     // subtract settled tokens sent to seller
1897:                     settledTokens = settledTokens.sub(availablePremium);
1898: 
1899:                     // add available premium to amount that should be settled
1900:                     realizedPremia = realizedPremia.add(
1901:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
1902:                     );
1903: 
1904:                     // We need to adjust the grossPremiumLast value such that the result of
1905:                     // (grossPremium - adjustedGrossPremiumLast)*updatedTotalLiquidityPostBurn/2**64 is equal to
1906:                     // (grossPremium - grossPremiumLast)*totalLiquidityBeforeBurn/2**64 - premiumOwedToPosition
1907:                     // G: total gross premium (- premiumOwedToPosition)
1908:                     // T: totalLiquidityBeforeMint
1909:                     // R: positionLiquidity
1910:                     // C: current grossPremium value
1911:                     // L: current grossPremiumLast value
1912:                     // Ln: updated grossPremiumLast value
1913:                     // T * (C - L) = G
1914:                     // (T - R) * (C - Ln) = G - P
1915:                     //
1916:                     // T * (C - L) = (T - R) * (C - Ln) + P
1917:                     // (TC - TL - P) / (T - R) = C - Ln
1918:                     // Ln = C - (TC - TL - P) / (T - R)
1919:                     // Ln = (TC - CR - TC + LT + P) / (T-R)
1920:                     // Ln = (LT - CR + P) / (T-R)
1921: 
1922:                     unchecked {
1923:                         uint256[2][4] memory _premiumAccumulatorsByLeg = premiumAccumulatorsByLeg;
1924:                         uint256 _leg = leg;
1925: 
1926:                         // if there's still liquidity, compute the new grossPremiumLast
1927:                         // otherwise, we just reset grossPremiumLast to the current grossPremium
1928:                         s_grossPremiumLast[chunkKey] = totalLiquidity != 0
1929:                             ? LeftRightUnsigned
1930:                                 .wrap(0)
1931:                                 .toRightSlot(
1932:                                     uint128(
1933:                                         uint256(
1934:                                             Math.max(
1935:                                                 (int256(
1936:                                                     grossPremiumLast.rightSlot() *
1937:                                                         totalLiquidityBefore
1938:                                                 ) -
1939:                                                     int256(
1940:                                                         _premiumAccumulatorsByLeg[_leg][0] *
1941:                                                             positionLiquidity
1942:                                                     )) + int256(legPremia.rightSlot() * 2 ** 64),
1943:                                                 0
1944:                                             )
1945:                                         ) / totalLiquidity
1946:                                     )
1947:                                 )
1948:                                 .toLeftSlot(
1949:                                     uint128(
1950:                                         uint256(
1951:                                             Math.max(
1952:                                                 (int256(
1953:                                                     grossPremiumLast.leftSlot() *
1954:                                                         totalLiquidityBefore
1955:                                                 ) -
1956:                                                     int256(
1957:                                                         _premiumAccumulatorsByLeg[_leg][1] *
1958:                                                             positionLiquidity
1959:                                                     )) + int256(legPremia.leftSlot()) * 2 ** 64,
1960:                                                 0
1961:                                             )
1962:                                         ) / totalLiquidity
1963:                                     )
1964:                                 )
1965:                             : LeftRightUnsigned
1966:                                 .wrap(0)
1967:                                 .toRightSlot(uint128(premiumAccumulatorsByLeg[_leg][0]))
1968:                                 .toLeftSlot(uint128(premiumAccumulatorsByLeg[_leg][1]));
1969:                     }
1970:                 }
1971:             }
1972: 
1973:             // update settled tokens in storage with all local deltas
1974:             s_settledTokens[chunkKey] = settledTokens;
1975: 
1976:             unchecked {
1977:                 ++leg;
1978:             }
1979:         }

//@audit `leg` 
459:             for (uint256 leg = 0; leg < numLegs; ) {
460:                 if (tokenId.isLong(leg) == 0 && !includePendingPremium) {
461:                     bytes32 chunkKey = keccak256(
462:                         abi.encodePacked(
463:                             tokenId.strike(leg),
464:                             tokenId.width(leg),
465:                             tokenId.tokenType(leg)
466:                         )
467:                     );
468: 
469:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
470:                         _getTotalLiquidity(tokenId, leg),
471:                         s_settledTokens[chunkKey],
472:                         s_grossPremiumLast[chunkKey],
473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),
474:                         premiumAccumulatorsByLeg[leg]
475:                     );
476:                     portfolioPremium = portfolioPremium.add(
477:                         LeftRightSigned.wrap(int256(LeftRightUnsigned.unwrap(availablePremium)))
478:                     );
479:                 } else {
480:                     portfolioPremium = portfolioPremium.add(premiaByLeg[leg]);
481:                 }
482:                 unchecked {
483:                     ++leg;
484:                 }
485:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L745-L781) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L864-L874), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1518-L1574), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1672-L1745), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1852-L1979), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L459-L485)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

//@audit `leg` 
601:         for (uint256 leg = 0; leg < numLegs; ) {
602:             // for this leg index: extract the liquidity chunk: a 256bit word containing the liquidity amount and upper/lower tick
603:             // @dev see `contracts/types/LiquidityChunk.sol`
604:             LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
605:                 id,
606:                 leg,
607:                 uint128(amount)
608:             );
609: 
610:             //construct the positionKey for the from and to addresses
611:             bytes32 positionKey_from = keccak256(
612:                 abi.encodePacked(
613:                     address(univ3pool),
614:                     from,
615:                     id.tokenType(leg),
616:                     liquidityChunk.tickLower(),
617:                     liquidityChunk.tickUpper()
618:                 )
619:             );
620:             bytes32 positionKey_to = keccak256(
621:                 abi.encodePacked(
622:                     address(univ3pool),
623:                     to,
624:                     id.tokenType(leg),
625:                     liquidityChunk.tickLower(),
626:                     liquidityChunk.tickUpper()
627:                 )
628:             );
629: 
630:             // Revert if recipient already has that position
631:             if (
632:                 (LeftRightUnsigned.unwrap(s_accountLiquidity[positionKey_to]) != 0) ||
633:                 (LeftRightSigned.unwrap(s_accountFeesBase[positionKey_to]) != 0)
634:             ) revert Errors.TransferFailed();
635: 
636:             // Revert if sender has long positions in that chunk or the entire liquidity is not being transferred
637:             LeftRightUnsigned fromLiq = s_accountLiquidity[positionKey_from];
638:             if (LeftRightUnsigned.unwrap(fromLiq) != liquidityChunk.liquidity())
639:                 revert Errors.TransferFailed();
640: 
641:             LeftRightSigned fromBase = s_accountFeesBase[positionKey_from];
642: 
643:             //update+store liquidity and fee values between accounts
644:             s_accountLiquidity[positionKey_to] = fromLiq;
645:             s_accountLiquidity[positionKey_from] = LeftRightUnsigned.wrap(0);
646: 
647:             s_accountFeesBase[positionKey_to] = fromBase;
648:             s_accountFeesBase[positionKey_from] = LeftRightSigned.wrap(0);
649:             unchecked {
650:                 ++leg;
651:             }
652:         }

//@audit `leg` 
882:         for (uint256 leg = 0; leg < numLegs; ) {
883:             LeftRightSigned _moved;
884:             LeftRightSigned _itmAmounts;
885:             LeftRightUnsigned _collectedSingleLeg;
886: 
887:             {
888:                 // cache the univ3pool, tokenId, isBurn, and _positionSize variables to get rid of stack too deep error
889:                 IUniswapV3Pool _univ3pool = univ3pool;
890:                 TokenId _tokenId = tokenId;
891:                 bool _isBurn = isBurn;
892:                 uint128 _positionSize = positionSize;
893:                 uint256 _leg;
894: 
895:                 unchecked {
896:                     // Reverse the order of the legs if this call is burning a position (LIFO)
897:                     // We loop in reverse order if burning a position so that any dependent long liquidity is returned to the pool first,
898:                     // allowing the corresponding short liquidity to be removed
899:                     _leg = _isBurn ? numLegs - leg - 1 : leg;
900:                 }
901: 
902:                 // for this _leg index: extract the liquidity chunk: a 256bit word containing the liquidity amount and upper/lower tick
903:                 // @dev see `contracts/types/LiquidityChunk.sol`
904:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
905:                     _tokenId,
906:                     _leg,
907:                     _positionSize
908:                 );
909: 
910:                 (_moved, _itmAmounts, _collectedSingleLeg) = _createLegInAMM(
911:                     _univ3pool,
912:                     _tokenId,
913:                     _leg,
914:                     liquidityChunk,
915:                     _isBurn
916:                 );
917: 
918:                 collectedByLeg[_leg] = _collectedSingleLeg;
919: 
920:                 unchecked {
921:                     // increment accumulators of the upper bound on tokens contained across all legs of the position at any given tick
922:                     amount0 += Math.getAmount0ForLiquidity(liquidityChunk);
923: 
924:                     amount1 += Math.getAmount1ForLiquidity(liquidityChunk);
925:                 }
926:             }
927: 
928:             totalMoved = totalMoved.add(_moved);
929:             itmAmounts = itmAmounts.add(_itmAmounts);
930: 
931:             unchecked {
932:                 ++leg;
933:             }
934:         }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L601-L652) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L882-L934)


```solidity

File: ./contracts/libraries/FeesCalc.sol

//@audit `leg` 
55:             for (uint256 leg = 0; leg < numLegs; ) {
56:                 LiquidityChunk liquidityChunk = PanopticMath.getLiquidityChunk(
57:                     tokenId,
58:                     leg,
59:                     positionSize
60:                 );
61: 
62:                 (uint256 amount0, uint256 amount1) = Math.getAmountsForLiquidity(
63:                     atTick,
64:                     liquidityChunk
65:                 );
66: 
67:                 if (tokenId.isLong(leg) == 0) {
68:                     unchecked {
69:                         value0 += int256(amount0);
70:                         value1 += int256(amount1);
71:                     }
72:                 } else {
73:                     unchecked {
74:                         value0 -= int256(amount0);
75:                         value1 -= int256(amount1);
76:                     }
77:                 }
78: 
79:                 unchecked {
80:                     ++leg;
81:                 }
82:             }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L55-L82) 


```solidity

File: ./contracts/libraries/PanopticMath.sol

//@audit `leg` 
395:         for (uint256 leg = 0; leg < numLegs; ) {
396:             // Compute the amount of funds that have been removed from the Panoptic Pool
397:             (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(
398:                 tokenId,
399:                 positionSize,
400:                 leg
401:             );
402: 
403:             longAmounts = longAmounts.add(longs);
404:             shortAmounts = shortAmounts.add(shorts);
405: 
406:             unchecked {
407:                 ++leg;
408:             }
409:         }

//@audit `leg` 
784:                 for (uint256 leg = 0; leg < numLegs; ++leg) {
785:                     if (tokenId.isLong(leg) == 1) {
786:                         longPremium = longPremium.sub(premiasByLeg[i][leg]);
787:                     }
788:                 }

//@audit `leg` 
863:                 for (uint256 leg = 0; leg < tokenId.countLegs(); ++leg) {
864:                     if (tokenId.isLong(leg) == 1) {
865:                         mapping(bytes32 chunkKey => LeftRightUnsigned settledTokens)
866:                             storage _settledTokens = settledTokens;
867: 
868:                         // calculate amounts to revoke from settled and subtract from haircut req
869:                         uint256 settled0 = Math.unsafeDivRoundingUp(
870:                             uint128(-_premiasByLeg[i][leg].rightSlot()) * uint256(haircut0),
871:                             uint128(longPremium.rightSlot())
872:                         );
873:                         uint256 settled1 = Math.unsafeDivRoundingUp(
874:                             uint128(-_premiasByLeg[i][leg].leftSlot()) * uint256(haircut1),
875:                             uint128(longPremium.leftSlot())
876:                         );
877: 
878:                         bytes32 chunkKey = keccak256(
879:                             abi.encodePacked(
880:                                 tokenId.strike(0),
881:                                 tokenId.width(0),
882:                                 tokenId.tokenType(0)
883:                             )
884:                         );
885: 
886:                         // The long premium is not commited to storage during the liquidation, so we add the entire adjusted amount
887:                         // for the haircut directly to the accumulator
888:                         settled0 = Math.max(
889:                             0,
890:                             uint128(-_premiasByLeg[i][leg].rightSlot()) - settled0
891:                         );
892:                         settled1 = Math.max(
893:                             0,
894:                             uint128(-_premiasByLeg[i][leg].leftSlot()) - settled1
895:                         );
896: 
897:                         _settledTokens[chunkKey] = _settledTokens[chunkKey].add(
898:                             LeftRightUnsigned.wrap(0).toRightSlot(uint128(settled0)).toLeftSlot(
899:                                 uint128(settled1)
900:                             )
901:                         );
902:                     }
903:                 }


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L395-L409) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L784-L788), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L863-L903)


</details>


### [NC&#x2011;91] Consider using named function calls 
Named function calls in Solidity greatly improve code readability by explicitly mapping arguments to their respective parameter names. This clarity becomes critical when dealing with functions that have numerous or complex parameters, reducing potential errors due to misordered arguments. Therefore, adopting named function calls contributes to more maintainable and less error-prone code.


*There are 119 instances of this issue:*



<details>
<summary>see instances</summary>


```solidity
File: ./contracts/CollateralTracker.sol

432:         _mint(receiver, shares);

492:         _mint(receiver, shares);

548:         _burn(owner, shares);

608:         _burn(owner, shares);

886:         _transferFrom(delegator, delegatee, shares);

1006:             int256 tokenToPay = _getExchangedAmount(longAmount, shortAmount, swappedAmount);

1147:         tokenData = _getAccountMargin(user, currentTick, positionBalanceArray, premiumAllPositions);

1294:                 : _getRequiredCollateralSingleLegPartner(
1295:                     tokenId,
1296:                     index,
1297:                     positionSize,
1298:                     atTick,
1299:                     poolUtilization
1300:                 );

1287:                 ? _getRequiredCollateralSingleLegNoPartner(
1288:                     tokenId,
1289:                     index,
1290:                     positionSize,
1291:                     atTick,
1292:                     poolUtilization
1293:                 )

1335:         required = _getRequiredCollateralAtUtilization(amountMoved, isLong, utilization);

965:             _transferFrom(delegatee, delegator, shares);

939:             _transferFrom(delegatee, delegator, delegateeBalance);

954:             _mint(
955:                 delegator,
956:                 Math.mulDiv(
957:                     assets,
958:                     totalSupply - delegateeBalance,
959:                     uint256(Math.max(1, int256(totalAssets()) - int256(assets)))
960:                 ) - delegateeBalance
961:             );

977:             _transferFrom(refunder, refundee, convertToShares(uint256(assets)));

1219:             uint256 _tokenRequired = _getRequiredCollateralAtTickSinglePosition(
1220:                 tokenId,
1221:                 positionSize,
1222:                 atTick,
1223:                 poolUtilization
1224:             );

1581:             _getRequiredCollateralAtUtilization(
1582:                 tokenType == 0 ? movedRight : movedLeft,
1583:                 1,
1584:                 tokenType == 0
1585:                     ? int64(uint64(poolUtilization))
1586:                     : int64(uint64(poolUtilization >> 64))
1587:             )

1641:                 strangleRequired = _getRequiredCollateralSingleLegNoPartner(
1642:                     tokenId,
1643:                     index,
1644:                     positionSize,
1645:                     atTick,
1646:                     poolUtilization
1647:                 );

980:                 _transferFrom(refundee, refunder, convertToShares(uint256(-assets)));

1017:                 _burn(optionOwner, sharesToBurn);

1074:                 _burn(optionOwner, sharesToBurn);

1170:             tokenRequired = _getTotalRequiredCollateral(atTick, positionBalanceArray);

1462:             required = _computeStrangle(tokenId, index, positionSize, atTick, poolUtilization);

1021:                 _mint(optionOwner, sharesToMint);

1078:                 _mint(optionOwner, sharesToMint);

1259:                 tokenRequired += _getRequiredCollateralSingleLeg(
1260:                     tokenId,
1261:                     index,
1262:                     positionSize,
1263:                     atTick,
1264:                     poolUtilization
1265:                 );

1453:                 required = _computeSpread(
1454:                     tokenId,
1455:                     positionSize,
1456:                     index,
1457:                     partnerIndex,
1458:                     poolUtilization
1459:                 );


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L432-L432) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L492-L492), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L548-L548), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L608-L608), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L886-L886), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1006-L1006), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1147-L1147), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1294-L1300), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1287-L1293), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1335-L1335), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L965-L965), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L939-L939), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L954-L961), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L977-L977), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1219-L1224), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1581-L1587), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1641-L1647), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L980-L980), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1017-L1017), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1074-L1074), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1170-L1170), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1462-L1462), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1021-L1021), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1078-L1078), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1259-L1265), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/CollateralTracker.sol#L1453-L1459)


```solidity

File: ./contracts/PanopticFactory.sol

263:         (uint256 amount0, uint256 amount1) = _mintFullRange(v3Pool, token0, token1, fee);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticFactory.sol#L263-L263) 


```solidity

File: ./contracts/PanopticPool.sol

390:         (LeftRightSigned premia, uint256[2][] memory balances) = _calculateAccumulatedPremia(
391:             user,
392:             positionIdList,
393:             COMPUTE_ALL_PREMIA,
394:             includePendingPremium,
395:             currentTick
396:         );

554:         _mintOptions(
555:             positionIdList,
556:             positionSize,
557:             effectiveLiquidityLimitX32,
558:             tickLimitLow,
559:             tickLimitHigh
560:         );

575:         _burnOptions(COMMIT_LONG_SETTLED, tokenId, msg.sender, tickLimitLow, tickLimitHigh);

577:         _validateSolvency(msg.sender, newPositionIdList, NO_BUFFER);

592:         _burnAllOptionsFrom(
593:             msg.sender,
594:             tickLimitLow,
595:             tickLimitHigh,
596:             COMMIT_LONG_SETTLED,
597:             positionIdList
598:         );

600:         _validateSolvency(msg.sender, newPositionIdList, NO_BUFFER);

628:         _validatePositionList(msg.sender, positionIdList, 1);

642:         uint128 poolUtilizations = _mintInSFPMAndUpdateCollateral(
643:             tokenId,
644:             positionSize,
645:             tickLimitLow,
646:             tickLimitHigh
647:         );

650:         _addUserOption(tokenId, effectiveLiquidityLimitX32);

661:         uint256 medianData = _validateSolvency(msg.sender, positionIdList, BP_DECREASE_BUFFER);

689:         _updateSettlementPostMint(tokenId, collectedByLeg, positionSize);

693:         uint128 poolUtilizations = _payCommissionAndWriteData(tokenId, positionSize, totalSwapped);

741:         _updatePositionsHash(msg.sender, tokenId, ADD);

850:         _updatePositionDataBurn(owner, tokenId);

877:         _updatePositionsHash(owner, tokenId, !ADD);

893:         _validatePositionList(user, positionIdList, 0);

933:         bool solventAtFast = _checkSolvencyAtTick(
934:             user,
935:             positionIdList,
936:             currentTick,
937:             fastOracleTick,
938:             buffer
939:         );

1023:         _validatePositionList(liquidatee, positionIdList, 0);

1153:         _validatePositionList(msg.sender, positionIdListLiquidator, 0);

1191:         _validatePositionList(msg.sender, positionIdListExercisor, 0);

1227:         _burnAllOptionsFrom(account, 0, 0, COMMIT_LONG_SETTLED, touchedId);

1268:         _validateSolvency(account, positionIdListExercisee, NO_BUFFER);

1300:         ) = _calculateAccumulatedPremia(
1301:                 account,
1302:                 positionIdList,
1303:                 COMPUTE_ALL_PREMIA,
1304:                 ONLY_AVAILABLE_PREMIUM,
1305:                 currentTick
1306:             );

1321:         (uint256 balanceCross, uint256 thresholdCross) = _getSolvencyBalances(
1322:             tokenData0,
1323:             tokenData1,
1324:             Math.getSqrtRatioAtTick(atTick)
1325:         );

1592:         _validatePositionList(owner, positionIdList, 0);

1658:         _validateSolvency(owner, positionIdList, NO_BUFFER);

630:         (tickLimitLow, tickLimitHigh) = _getSlippageLimits(tickLimitLow, tickLimitHigh);

834:         (tickLimitLow, tickLimitHigh) = _getSlippageLimits(tickLimitLow, tickLimitHigh);

840:         (premiaOwed, premiaByLeg, paidAmounts) = _burnAndHandleExercise(
841:             commitLongSettled,
842:             tickLimitLow,
843:             tickLimitHigh,
844:             tokenId,
845:             positionSize,
846:             owner
847:         );

973:         (realizedPremia, premiaByLeg) = _updateSettlementPostBurn(
974:             owner,
975:             tokenId,
976:             collectedByLeg,
977:             positionSize,
978:             commitLongSettled
979:         );

1060:             (uint256 balanceCross, uint256 thresholdCross) = _getSolvencyBalances(
1061:                 tokenData0,
1062:                 tokenData1,
1063:                 Math.getSqrtRatioAtTick(twapTick)
1064:             );

1156:             !_checkSolvencyAtTick(
1157:                 msg.sender,
1158:                 positionIdListLiquidator,
1159:                 finalTick,
1160:                 finalTick,
1161:                 BP_DECREASE_BUFFER
1162:             )

1206:             (LeftRightSigned positionPremia, ) = _calculateAccumulatedPremia(
1207:                 account,
1208:                 touchedId,
1209:                 COMPUTE_LONG_PREMIA,
1210:                 ONLY_AVAILABLE_PREMIUM,
1211:                 currentTick
1212:             );

1275:             _validateSolvency(msg.sender, positionIdListExercisor, BP_DECREASE_BUFFER);

1844:         (premiaByLeg, premiumAccumulatorsByLeg) = _getPremia(
1845:             tokenId,
1846:             positionSize,
1847:             owner,
1848:             COMPUTE_ALL_PREMIA,
1849:             type(int24).max
1850:         );

450:             ) = _getPremia(
451:                     tokenId,
452:                     LeftRightUnsigned.wrap(balances[k][1]).rightSlot(),
453:                     c_user,
454:                     computeAllPremia,
455:                     atTick
456:                 );

944:             if (!_checkSolvencyAtTick(user, positionIdList, currentTick, slowOracleTick, buffer))

1039:             (premia, positionBalanceArray) = _calculateAccumulatedPremia(
1040:                 liquidatee,
1041:                 positionIdList,
1042:                 COMPUTE_ALL_PREMIA,
1043:                 ONLY_AVAILABLE_PREMIUM,
1044:                 currentTick
1045:             );

1086:             (netExchanged, premiasByLeg) = _burnAllOptionsFrom(
1087:                 liquidatee,
1088:                 Constants.MIN_V3POOL_TICK,
1089:                 Constants.MAX_V3POOL_TICK,
1090:                 DONOT_COMMIT_LONG_SETTLED,
1091:                 positionIdList
1092:             );

804:             (paidAmounts, premiasByLeg[i]) = _burnOptions(
805:                 commitLongSettled,
806:                 positionIdList[i],
807:                 owner,
808:                 tickLimitLow,
809:                 tickLimitHigh
810:             );

770:                 _checkLiquiditySpread(
771:                     tokenId,
772:                     leg,
773:                     tickLower,
774:                     tickUpper,
775:                     uint64(Math.min(effectiveLiquidityLimitX32, MAX_SPREAD))
776:                 );

868:                 _checkLiquiditySpread(tokenId, leg, tickLower, tickUpper, MAX_SPREAD);

1687:                 uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);

469:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
470:                         _getTotalLiquidity(tokenId, leg),
471:                         s_settledTokens[chunkKey],
472:                         s_grossPremiumLast[chunkKey],
473:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(premiaByLeg[leg]))),
474:                         premiumAccumulatorsByLeg[leg]
475:                     );

1882:                     uint256 totalLiquidity = _getTotalLiquidity(tokenId, leg);

1888:                     LeftRightUnsigned availablePremium = _getAvailablePremium(
1889:                         totalLiquidity + positionLiquidity,
1890:                         settledTokens,
1891:                         grossPremiumLast,
1892:                         LeftRightUnsigned.wrap(uint256(LeftRightSigned.unwrap(legPremia))),
1893:                         premiumAccumulatorsByLeg[leg]
1894:                     );

470:                         _getTotalLiquidity(tokenId, leg),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L390-L396) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L554-L560), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L575-L575), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L577-L577), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L592-L598), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L600-L600), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L628-L628), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L642-L647), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L650-L650), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L661-L661), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L689-L689), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L693-L693), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L741-L741), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L850-L850), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L877-L877), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L893-L893), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L933-L939), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1023-L1023), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1153-L1153), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1191-L1191), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1227-L1227), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1268-L1268), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1300-L1306), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1321-L1325), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1592-L1592), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1658-L1658), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L630-L630), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L834-L834), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L840-L847), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L973-L979), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1060-L1064), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1156-L1162), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1206-L1212), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1275-L1275), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1844-L1850), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L450-L456), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L944-L944), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1039-L1045), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1086-L1092), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L804-L810), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L770-L776), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L868-L868), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1687-L1687), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L469-L475), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1882-L1882), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L1888-L1894), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/PanopticPool.sol#L470-L470)


```solidity

File: ./contracts/SemiFungiblePositionManager.sol

482:         _burn(msg.sender, TokenId.unwrap(tokenId), positionSize);

515:         _mint(msg.sender, TokenId.unwrap(tokenId), positionSize);

552:         registerTokenTransfer(from, to, TokenId.wrap(id), amount);

1118:         ) = _getPremiaDeltas(currentLiquidity, collectedAmounts);

488:         (collectedByLeg, totalSwapped) = _validateAndForwardToAMM(
489:             tokenId,
490:             positionSize,
491:             slippageTickLimitLow,
492:             slippageTickLimitHigh,
493:             BURN
494:         );

520:         (collectedByLeg, totalSwapped) = _validateAndForwardToAMM(
521:             tokenId,
522:             positionSize,
523:             slippageTickLimitLow,
524:             slippageTickLimitHigh,
525:             MINT
526:         );

708:         (totalMoved, collectedByLeg, itmAmounts) = _createPositionInAMM(
709:             univ3pool,
710:             tokenId,
711:             positionSize,
712:             isBurn
713:         );

1098:         s_accountFeesBase[positionKey] = _getFeesBase(
1099:             univ3pool,
1100:             updatedLiquidity,
1101:             liquidityChunk,
1102:             true
1103:         );

577:             registerTokenTransfer(from, to, TokenId.wrap(ids[i]), amounts[i]);

1268:         LeftRightSigned amountToCollect = _getFeesBase(
1269:             univ3pool,
1270:             startingLiquidity,
1271:             liquidityChunk,
1272:             false
1273:         ).subRect(s_accountFeesBase[positionKey]);

1311:             _updateStoredPremia(positionKey, currentLiquidity, collectedChunk);

1068:                 : _burnLiquidity(liquidityChunk, univ3pool); // from msg.sender to Uniswap

1067:                 ? _mintLiquidity(liquidityChunk, univ3pool)

1086:             collectedSingleLeg = _collectAndWritePositionData(
1087:                 liquidityChunk,
1088:                 univ3pool,
1089:                 currentLiquidity,
1090:                 positionKey,
1091:                 moved,
1092:                 isLong
1093:             );

910:                 (_moved, _itmAmounts, _collectedSingleLeg) = _createLegInAMM(
911:                     _univ3pool,
912:                     _tokenId,
913:                     _leg,
914:                     liquidityChunk,
915:                     _isBurn
916:                 );

1499:                 (LeftRightUnsigned premiumOwed, LeftRightUnsigned premiumGross) = _getPremiaDeltas(
1500:                     accountLiquidities,
1501:                     amountToCollect
1502:                 );

718:                 totalMoved = swapInAMM(univ3pool, itmAmounts).add(totalMoved);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L482-L482) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L515-L515), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L552-L552), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1118-L1118), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L488-L494), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L520-L526), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L708-L713), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1098-L1103), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L577-L577), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1268-L1273), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1311-L1311), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1068-L1068), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1067-L1067), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1086-L1093), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L910-L916), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L1499-L1502), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/SemiFungiblePositionManager.sol#L718-L718)


```solidity

File: ./contracts/libraries/FeesCalc.sol

109:         ) = _getAMMSwapFeesPerLiquidityCollected(univ3pool, currentTick, tickLower, tickUpper);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/FeesCalc.sol#L109-L109) 


```solidity

File: ./contracts/libraries/Math.sol

212:             return mulDiv96(liquidityChunk.liquidity(), highPriceX96 - lowPriceX96);

778:             quickSort(data, int256(0), int256(data.length - 1));

196:                 mulDiv(
197:                     uint256(liquidityChunk.liquidity()) << 96,
198:                     highPriceX96 - lowPriceX96,
199:                     highPriceX96
200:                 ) / lowPriceX96;

446:             result = mulDiv(a, b, denominator);

586:             result = mulDiv96(a, b);

663:             result = mulDiv128(a, b);

768:             if (left < j) quickSort(arr, left, j);

769:             if (i < right) quickSort(arr, i, right);

255:                         mulDiv(
256:                             amount0,
257:                             mulDiv96(highPriceX96, lowPriceX96),
258:                             highPriceX96 - lowPriceX96
259:                         )

284:                     toUint128(mulDiv(amount1, Constants.FP96, highPriceX96 - lowPriceX96))

257:                             mulDiv96(highPriceX96, lowPriceX96),


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L212-L212) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L778-L778), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L196-L200), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L446-L446), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L586-L586), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L663-L663), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L768-L768), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L769-L769), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L255-L259), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L284-L284), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/Math.sol#L257-L257)


```solidity

File: ./contracts/libraries/PanopticMath.sol

452:             convertCollateralData(tokenData0, tokenData1, tokenType, Math.getSqrtRatioAtTick(tick));

613:         LeftRightUnsigned amountsMoved = getAmountsMoved(tokenId, positionSize, legIndex);

397:             (LeftRightSigned longs, LeftRightSigned shorts) = _calculateIOAmounts(
398:                 tokenId,
399:                 positionSize,
400:                 leg
401:             );

477:                 : convert1to0(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2));

476:                 ? convert0to1(contractSize, Math.getSqrtRatioAtTick((tickUpper + tickLower) / 2))

432:                 tokenData1.rightSlot() + convert0to1(tokenData0.rightSlot(), sqrtPriceX96),

433:                 tokenData1.leftSlot() + convert0to1(tokenData0.leftSlot(), sqrtPriceX96)

427:                 tokenData0.rightSlot() + convert1to0(tokenData1.rightSlot(), sqrtPriceX96),

428:                 tokenData0.leftSlot() + convert1to0(tokenData1.leftSlot(), sqrtPriceX96)


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L452-L452) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L613-L613), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L397-L401), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L477-L477), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L476-L476), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L432-L432), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L433-L433), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L427-L427), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/libraries/PanopticMath.sol#L428-L428)


```solidity

File: ./contracts/types/TokenId.sol

347:         tokenId = addOptionRatio(self, _optionRatio, legIndex);

348:         tokenId = addAsset(tokenId, _asset, legIndex);

349:         tokenId = addIsLong(tokenId, _isLong, legIndex);

350:         tokenId = addTokenType(tokenId, _tokenType, legIndex);

351:         tokenId = addRiskPartner(tokenId, _riskPartner, legIndex);

352:         tokenId = addStrike(tokenId, _strike, legIndex);

353:         tokenId = addWidth(tokenId, _width, legIndex);


```

[link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L347-L347) , [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L348-L348), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L349-L349), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L350-L350), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L351-L351), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L352-L352), [link](https://github.com/code-423n4/2024-04-panoptic/tree/main//./contracts/types/TokenId.sol#L353-L353)


</details>
